<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="ppub"/></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS190232</article-id><article-id pub-id-type="doi">10.1101/2023.10.26.564064</article-id><article-id pub-id-type="archive">PPR748061</article-id><article-version-alternatives><article-version article-version-type="status">preprint</article-version><article-version article-version-type="number">1</article-version></article-version-alternatives><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>Universal inverse modelling of point spread functions for SMLM localization and microscope characterization</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Liu</surname><given-names>Sheng</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="fn" rid="FN1">*</xref></contrib><contrib contrib-type="author"><name><surname>Chen</surname><given-names>Jianwei</given-names></name><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A11">11</xref><xref ref-type="fn" rid="FN1">*</xref></contrib><contrib contrib-type="author"><name><surname>Hellgoth</surname><given-names>Jonas</given-names></name><xref ref-type="aff" rid="A3">3</xref></contrib><contrib contrib-type="author"><name><surname>Müller</surname><given-names>Lucas-Raphael</given-names></name><xref ref-type="aff" rid="A3">3</xref></contrib><contrib contrib-type="author"><name><surname>Ferdman</surname><given-names>Boris</given-names></name><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author"><name><surname>Karras</surname><given-names>Christian</given-names></name><xref ref-type="aff" rid="A6">6</xref><xref ref-type="aff" rid="A12">12</xref></contrib><contrib contrib-type="author"><name><surname>Xiao</surname><given-names>Dafei</given-names></name><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author"><name><surname>Lidke</surname><given-names>Keith A.</given-names></name><xref ref-type="aff" rid="A1">1</xref></contrib><contrib contrib-type="author"><name><surname>Heintzmann</surname><given-names>Rainer</given-names></name><xref ref-type="aff" rid="A5">5</xref><xref ref-type="aff" rid="A6">6</xref></contrib><contrib contrib-type="author"><name><surname>Shechtman</surname><given-names>Yoav</given-names></name><xref ref-type="aff" rid="A4">4</xref><xref ref-type="aff" rid="A10">10</xref></contrib><contrib contrib-type="author"><name><surname>Li</surname><given-names>Yiming</given-names></name><xref ref-type="aff" rid="A2">2</xref><xref ref-type="corresp" rid="CR1">§</xref></contrib><contrib contrib-type="author"><name><surname>Ries</surname><given-names>Jonas</given-names></name><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A7">7</xref><xref ref-type="aff" rid="A8">8</xref><xref ref-type="aff" rid="A9">9</xref><xref ref-type="corresp" rid="CR1">§</xref></contrib><aff id="A1"><label>1</label>Department of Physics and Astronomy, University of New Mexico, Albuquerque, NM, USA</aff><aff id="A2"><label>2</label>Department of Biomedical Engineering, Guangdong Provincial Key Laboratory of Advanced Biomaterials, Southern University of Science and Technology, Shenzhen, China</aff><aff id="A3"><label>3</label>European Molecular Biology Laboratory, Cell Biology and Biophysics, Heidelberg, Germany</aff><aff id="A4"><label>4</label>Department of Biomedical Engineering, Technion–Israel Institute of Technology, Haifa, Israel</aff><aff id="A5"><label>5</label>Institute of Physical Chemistry and Abbe Center of Photonics, Friedrich-Schiller-University Jena, Jena, Germany</aff><aff id="A6"><label>6</label>Leibniz Institute of Photonic Technology, Albert-Einstein-Straße 9, 07745, Jena, Germany</aff><aff id="A7"><label>7</label>Max Perutz Labs, Vienna Biocenter Campus (VBC), Dr.-Bohr-Gasse 9, 1030, Vienna, Austria</aff><aff id="A8"><label>8</label>University of Vienna, Center for Molecular Biology, Department of Structural and Computational Biology, Dr.- Bohr-Gasse 9, 1030, Vienna, Austria</aff><aff id="A9"><label>9</label>University of Vienna, Faculty of Physics, Boltzmanngasse 5, 1090 Vienna, Austria</aff><aff id="A10"><label>10</label>Department of Mechanical Engineering, The University of Texas at Austin, Austin, TX, USA</aff><aff id="A11"><label>11</label>Collaboration for joint PhD degree between Southern University of Science and Technology and Harbin Institute of Technology, Harbin, 150001, China</aff><aff id="A12"><label>12</label>Currently at JENOPTIK Optical Systems GmbH, Jena, Germany</aff></contrib-group><author-notes><fn id="FN1" fn-type="equal"><label>*</label><p id="P1">Equal contribution</p></fn><corresp id="CR1"><label>§</label>Correspondence: Yiming Li (<email>liym2019@sustech.edu.cn</email>), Jonas Ries (<email>jonas.ries@univie.ac.at</email>)</corresp></author-notes><pub-date pub-type="nihms-submitted"><day>28</day><month>10</month><year>2023</year></pub-date><pub-date pub-type="preprint"><day>26</day><month>10</month><year>2023</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P2">The point spread function (PSF) of a microscope describes the image of a point emitter. Knowing the accurate PSF model is essential for various imaging tasks, including single molecule localization, aberration correction and deconvolution. Here we present uiPSF (universal inverse modelling of Point Spread Functions), a toolbox to infer accurate PSF models from microscopy data, using either image stacks of fluorescent beads or directly images of blinking fluorophores, the raw data in single molecule localization microscopy (SMLM). The resulting PSF model enables accurate 3D super-resolution imaging using SMLM. Additionally, uiPSF can be used to characterize and optimize a microscope system by quantifying the aberrations, including field-dependent aberrations, and resolutions. Our modular framework is applicable to a variety of microscope modalities and the PSF model incorporates system or sample specific characteristics, e.g., the bead size, depth dependent aberrations and transformations among channels. We demonstrate its application in single or multiple channels or large field-of-view SMLM systems, 4Pi-SMLM, and lattice light-sheet microscopes using either bead data or single molecule blinking data.</p></abstract></article-meta></front><body><sec id="S1" sec-type="intro"><title>Introduction</title><p id="P3">A microscope image is formed by the convolution of the fluorescent light emitted by the sample structure with the point spread function (PSF). Precise knowledge of the PSF is of fundamental importance for many applications: quantification and optimization of microscope performance<sup><xref ref-type="bibr" rid="R1">1</xref>–<xref ref-type="bibr" rid="R3">3</xref></sup>, deconvolution of microscopy images to increase contrast and resolution<sup><xref ref-type="bibr" rid="R4">4</xref>,<xref ref-type="bibr" rid="R5">5</xref></sup>, estimation and correction of system and sample induced aberrations<sup><xref ref-type="bibr" rid="R6">6</xref></sup>, and evaluation of single molecule properties (e.g., 3D localization, dipole orientation and color)<sup><xref ref-type="bibr" rid="R7">7</xref>–<xref ref-type="bibr" rid="R10">10</xref></sup>.</p><p id="P4">PSF modelling is especially important for single-molecule localization microscopy (SMLM), a super-resolution method that relies on sparse activation of switchable fluorophores over many camera frames, followed by precise localization of the emitter positions<sup><xref ref-type="bibr" rid="R11">11</xref></sup>. In 3D SMLM, the z coordinate of the emitter can be inferred from the shape of the PSF after introducing suitable aberrations (PSF engineering)<sup><xref ref-type="bibr" rid="R12">12</xref>–<xref ref-type="bibr" rid="R14">14</xref></sup>, when measured at two or more different focal planes (bi-plane<sup><xref ref-type="bibr" rid="R15">15</xref>,<xref ref-type="bibr" rid="R16">16</xref></sup>, LLS-PAINT<sup><xref ref-type="bibr" rid="R17">17</xref></sup>) or from relative intensities in 3 or 4 channels after interference of the fluorescence detected with two opposing objectives (iPALM or 4Pi-SMS)<sup><xref ref-type="bibr" rid="R18">18</xref>,<xref ref-type="bibr" rid="R19">19</xref></sup>. All these approaches rely on knowing the precise shape of the PSF, as any inaccuracy of the PSF model (‘model mismatch’) will result in a z-dependent bias in the position estimation and reduced accuracy.</p><p id="P5">A microscope PSF can be calculated in either the spatial domain or the Fourier domain. In spatial domain modelling, PSFs are described by their intensity values on a 3D grid. The Gaussian PSF model is extensively used in 3D SMLM because of its ease of calibration and fitting. However, it can result in large localization bias (<xref rid="F1" ref-type="fig">Fig.1</xref>)<sup><xref ref-type="bibr" rid="R12">12</xref>,<xref ref-type="bibr" rid="R20">20</xref></sup>. Realistic PSF models, built directly from a z stack of images of fluorescent beads immobilized on a coverslip<sup><xref ref-type="bibr" rid="R21">21</xref></sup> or after spline interpolation<sup><xref ref-type="bibr" rid="R22">22</xref>–<xref ref-type="bibr" rid="R25">25</xref></sup>, have greatly improved the accuracy of 3D SMLM. However, spatial-domain based PSF models usually cannot describe variations of experimental conditions (e.g., depth or sample induced aberrations) and are difficult to calibrate for complex microscope modalities (e.g., 4Pi-SMLM).</p><p id="P6">Alternatively, instead of expressing PSFs in terms of a 3D volume in the spatial domain, they can be fully parametrized in the Fourier domain by a complex-valued 2D image, the pupil function. The spatial domain 3D PSF can then be calculated using the scalar or vectorial diffraction theory<sup><xref ref-type="bibr" rid="R26">26</xref>–<xref ref-type="bibr" rid="R28">28</xref></sup>. Different experimental conditions (e.g., aberrations, depths, wavelength) can be easily incorporated. Decomposing the phase of the pupil function into the orthogonal basis of Zernike polynomials reduces the number of parameters<sup><xref ref-type="bibr" rid="R29">29</xref></sup> and results in intuitive aberration modes<sup><xref ref-type="bibr" rid="R30">30</xref></sup>. Pupil functions can be determined by phase retrieval using a modified Gerchberg-Saxton (GS) algorithm<sup><xref ref-type="bibr" rid="R31">31</xref>–<xref ref-type="bibr" rid="R33">33</xref></sup> or by direct fitting to Zernike coefficients<sup><xref ref-type="bibr" rid="R28">28</xref>,<xref ref-type="bibr" rid="R34">34</xref>,<xref ref-type="bibr" rid="R35">35</xref></sup> or a 2D pupil image<sup><xref ref-type="bibr" rid="R36">36</xref>,<xref ref-type="bibr" rid="R37">37</xref></sup>, or by deep learning<sup><xref ref-type="bibr" rid="R38">38</xref>–<xref ref-type="bibr" rid="R40">40</xref></sup>. Lately, Xu <italic>et. al.</italic> applied a GS algorithm to retrieve an <italic>in situ</italic> PSF model from single blinking fluorophores by averaging single fluorophore images at similar z positions to construct a 3D PSF image stack<sup><xref ref-type="bibr" rid="R41">41</xref></sup>. We recently determined the spatially variant PSFs across a large field of view (FOV) by retrieving changes of Zernike coefficients<sup><xref ref-type="bibr" rid="R42">42</xref></sup>.</p><p id="P7">Accurate PSF modelling often requires many parameters to model the complex image formation process. However, it is often too complicated to incorporate the complete experimental conditions, e.g., the finite size of beads, field dependent aberrations, and sample induced aberrations. Therefore, current approaches are often limited to simple imaging modalities, and lack accuracy in multi-channel applications (multi-color, bi-plane or 4Pi-SMLM) that require not only knowledge of the precise PSF model in each channel, but also an accurate transformation among the channels. Additionally, existing methods usually work with experimental data of small size (e.g. 1-3 bead stacks) and simplified experimental conditions, and cannot extract the abundant information embedded in the massive microscopy data. Thus, a universal, robust and easy-to-use approach that can infer accurate PSF models from relatively large experimental data for various microscope modalities is still missing.</p><p id="P8">To accurately retrieve all parameters of a PSF model, a differentiable imaging model is required. However, such a model including derivatives is complex and lengthy in its explicit form. Thus, we took advantage of the automatic differentiation functionality of TensorFlow and developed a versatile and modular toolbox, termed uiPSF (universal inverse modelling of Point Spread Functions), that uses inverse modelling to extract accurate PSF models for most SMLM imaging modalities from bead stacks or <italic>in situ</italic> from blinking emitters. Supported modalities include astigmatic, Tetrapod, double-helix, 4Pi and multi-channel PSFs, both in the spatial domain and in the Fourier domain (<xref rid="F1" ref-type="fig">Fig. 1a-c</xref>). We account for realistic experimental conditions, such as bead size, intensity fluctuations, pixelation effects, sample drift and field-dependent aberrations.</p></sec><sec id="S2" sec-type="results"><title>Results</title><sec id="S3"><title>Inverse modelling of PSFs</title><p id="P9">Determining a microscope PSF from measurements is an inverse problem, which requires building a continuous model function through noisy and pixelated image observations under certain imaging conditions. As the image formation process in a microscope is well studied, it is relatively easy to model microscopy images given the PSF and the positions of the emitters (‘forward modelling’). The inverse problem – determining a parameterized PSF model from experimental data – is much more difficult, as the forward model cannot be inverted easily. This inverse problem can be solved by an iterative approach called inverse modelling, in which the forward models are built from initial parameters and are compared to the experimental data by means of a value (‘loss function’) measuring the current quality of agreement, and an optimization algorithm adjusts the model parameters to decrease the loss (Fig.1a). This process is repeated until convergence. Efficient optimization requires the derivatives of the forward model with respect to the model parameters. We thus implemented inverse modelling of PSFs using the TensorFlow package, where the differentiation is automatically performed, allowing us to use increasingly complex forward models without explicitly calculating derivatives.</p></sec><sec id="S4"><title>PSF modelling in the spatial domain</title><p id="P10">We now describe a simple implementation in the spatial domain, in which the PSF, parametrized by a 3D image stack (‘voxels’), is determined from bead data: In a pre-processing step, the beads are identified and regions of interest (ROIs) around the beads are cropped from the raw camera frames (<xref ref-type="supplementary-material" rid="SD1">SI Note 1</xref>). We initialize the PSF model as a 3D array with all values set to a small value close to zero and set the initial bead positions to zero (<xref rid="F1" ref-type="fig">Fig. 1a</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Note 2</xref>). The forward model then consists of shifting the 3D array to the estimated bead positions using sub-pixel interpolations, which are achieved by applying phase-ramps in Fourier space (<xref rid="F1" ref-type="fig">Fig. 1b</xref>). We used the mean square error (MSE) between the forward models and the data as the loss function. Regularization terms are added to the loss function to reduce overfitting and edge effects, and to ensure that the PSF model and all photon counts remain positive (<xref ref-type="supplementary-material" rid="SD1">SI Note 2</xref>). A suitable optimizer (L-BFGS)<sup><xref ref-type="bibr" rid="R43">43</xref></sup> then minimizes the loss to optimize the voxel values in the PSF model and the positions, photons and backgrounds of the beads (<xref ref-type="supplementary-material" rid="SD1">SI Table 1</xref>).</p></sec><sec id="S5"><title>PSF modelling in the Fourier domain</title><p id="P11">The parametrization of the PSF as a 3D array of intensity values has the advantage that it directly measures the impulse function of a microscope in the spatial domain where it forms the microscope image. No prior knowledge of the image formation process is needed. However, this comes at the expense of typically tens of thousands of fitting parameters and the difficulty to incorporate specific imaging conditions (e.g., depth dependent aberrations) into the model. An alternative representation of the PSF is the pupil function <italic>h</italic>(<italic>k<sub>x</sub>, k<sub>y</sub></italic>), which describes the electric field at the pupil plane. Scalar or vectorial diffraction theory can then be used in the forward model to calculate the PSF, <italic>U</italic><sub>PSF</sub>(<italic>x</italic> − <italic>x<sub>i</sub></italic>, <italic>y</italic> − <italic>y</italic><sub><italic>i</italic></sub>, <italic>z</italic><sub><italic>i</italic></sub>), of a emitter at location (<italic>x<sub>i</sub></italic>, <italic>y<sub>i</sub></italic>, <italic>z<sub>i</sub></italic>) from the pupil function using Fourier transforms and knowledge about the microscope such as the numerical aperture (NA) of the objective, the refractive index of the immersion oil <italic>n</italic> and the emission wavelength <italic>λ</italic> (<xref rid="F1" ref-type="fig">Fig. 1b</xref>). The scalar PSF model is given by (see <xref ref-type="supplementary-material" rid="SD1">SI Note 3</xref> for vectorial PSF model), <disp-formula id="FD1"><mml:math id="M1"><mml:msub><mml:mi>U</mml:mi><mml:mrow><mml:mtext>PSF</mml:mtext></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mi>ℱ</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi>h</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>x</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>y</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:msub><mml:mi>k</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msup><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>x</mml:mi></mml:msub><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>y</mml:mi></mml:msub><mml:msub><mml:mi>y</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>.</mml:mo></mml:math></disp-formula></p><p id="P12">Here ℱ denotes a 2D Fourier transform and <italic>k</italic><sub><italic>x</italic></sub>, <italic>k</italic><sub><italic>y</italic></sub>, <italic>k</italic><sub><italic>z</italic></sub> are the Cartesian components of the wave vector <bold><italic>k</italic></bold>, where its magnitude <italic>k</italic> = <italic>n</italic>/<italic>λ</italic>. The term <italic>e</italic><sup><italic>i</italic>2<italic>π</italic><sub><italic>z</italic></sub><italic>z</italic><sub><italic>i</italic></sub></sup> accounts for the defocus phase and <inline-formula><mml:math id="M2"><mml:msub><mml:mi>k</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:msup><mml:mi>k</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>−</mml:mo><mml:msubsup><mml:mi>k</mml:mi><mml:mi>x</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>−</mml:mo><mml:msubsup><mml:mi>k</mml:mi><mml:mi>y</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:msqrt></mml:math></inline-formula>, and the term <italic>e</italic><sup><italic>i</italic>2<italic>π</italic>(<italic>k</italic><sub><italic>x</italic></sub><italic>x</italic><sub><italic>i</italic></sub>+<italic>k</italic><sub><italic>y</italic></sub><italic>y</italic><sub><italic>i</italic></sub>)</sup> accounts for the shift phase to location (<italic>x</italic><sub><italic>i</italic></sub>, <italic>y</italic><sub><italic>i</italic></sub>). The pupil function of most imaging system has a circular boundary, and its cutoff frequency is defined by <italic>NA</italic>/<italic>λ</italic>.</p><p id="P13">The complex pupil function is typically expressed in terms of its magnitude <italic>A</italic>(<italic>k</italic><sub><italic>x</italic></sub>, <italic>k</italic><sub><italic>y</italic></sub>) and its phase Φ(<italic>k</italic><sub><italic>x</italic></sub>, <italic>k</italic><sub><italic>y</italic></sub>): <disp-formula id="FD2"><mml:math id="M3"><mml:mi>h</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>x</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>y</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>A</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>x</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>y</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>Φ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>x</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>y</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:math></disp-formula></p><p id="P14"><italic>A</italic> and Φ as 2D arrays can be directly estimated, we term this modelling method as pupil-image based modelling. To reduce the number of parameters even further and to increase the robustness in the presence of noise, we can express <italic>A</italic> and Φ in the basis of Zernike polynomials <italic>Z</italic><sub><italic>p</italic></sub>, <disp-formula id="FD3"><mml:math id="M4"><mml:mi>A</mml:mi><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mi>p</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle><mml:msub><mml:mi>Z</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:mi>Φ</mml:mi><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mi>p</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>Φ</mml:mi><mml:mo>,</mml:mo><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle><mml:msub><mml:mi>Z</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mo>,</mml:mo></mml:math></disp-formula> parametrizing the PSF in terms of the Zernike coefficients <italic>C</italic><sub><italic>p</italic></sub>. We term this modelling method as Zernike-based modelling. Both pupil-image based and Zernike-based modelling are Fourier-domain or pupil-based modelling methods. We found that including up to 8th radial order (Noll index) is sufficient, resulting in 45 Zernike coefficients for each expansion. We can further decrease the number of parameters by assuming <italic>A</italic> to be rotationally symmetric or constant, with a small sacrifice in the axial bias, but it sometimes led to larger lateral biases (<xref ref-type="supplementary-material" rid="SD1">SI Figs. 1-2</xref>).</p><p id="P15">For Fourier-domain based modelling, we use a maximum-likelihood based loss-function to account for the shot noise and to improve the precision especially for low signal-to-noise conditions (<xref ref-type="supplementary-material" rid="SD1">SI Note 3</xref>).</p></sec><sec id="S6"><title>Validation</title><p id="P16">We validated our framework extensively with simulations, in which we can directly compare the results to the ground truth (<xref ref-type="supplementary-material" rid="SD1">SI Figs. 3-7</xref>). We found that the estimated PSF model can achieve a localization precision at the information limit (the Cramér–Rao lower bound (CRLB)) (<xref ref-type="supplementary-material" rid="SD1">SI Figs. 3-4</xref>).</p><p id="P17">We then performed an extensive experimental validation of uiPSF: (a) we compared the estimated PSF model with the raw data visually and by calculating residuals (<xref ref-type="supplementary-material" rid="SD1">SI Figs. 8-9</xref>). (b) We fitted the bead stacks with the PSF model to retrieve emitter’s <italic>x</italic>, <italic>y</italic> and <italic>z</italic> positions in each frame. A frame-dependent bias in any direction denotes a model-mismatch (<xref rid="F1" ref-type="fig">Fig. 1d</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Fig. 1-2, 8-10</xref>). The localization test shows that the estimated PSF model can achieve a localization precision close to the information limit (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 8-9</xref>). (c) We used nuclear pore complexes (NPC) as 3D reference standards<sup><xref ref-type="bibr" rid="R44">44</xref></sup>. As the labeled protein Nup96 forms two rings with a separation of ∼50 nm, we can investigate distortions in <italic>z</italic> by evaluating how this separation changes with the axial position of the nuclear pores (<xref rid="F5" ref-type="fig">ED Fig. 1</xref>).</p><p id="P18">Compared to previous approach that aligned and averaged multiple beads using cross-correlation<sup><xref ref-type="bibr" rid="R23">23</xref></sup>, the voxel-based PSF model from uiPSF show less bias for both simulated and experimental data (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 11</xref>). Compared to Zola 3D<sup><xref ref-type="bibr" rid="R34">34</xref></sup>, a previous approach that estimates Zernike polynomials from bead data, uiPSF, extracting Zernike coefficients from multiple beads (typically &gt;20), shows a smaller bias by incorporating challenging experimental conditions in a vectorial PSF model (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 12</xref>).</p></sec><sec id="S7"><title>Extensions of the forward model</title><p id="P19">The forward models introduced above can be made more realistic by including additional experimental conditions.</p><sec id="S8"><title>Bead size</title><p id="P20">Large fluorescent beads (100 nm or 200 nm) are substantially brighter than smaller ones. They contain more fluorophores and thus show less intensity fluctuations and photobleaching. As the bead images can be described as a convolution of the PSF with the bead shape, they are more blurred than the PSF itself. We can include this blurring in the forward model <italic>U</italic><sub><italic>i</italic></sub> by a convolution with a uniform fluorophore distribution in the bead <italic>g</italic><sup><xref ref-type="bibr" rid="R28">28</xref></sup>: <disp-formula id="FD4"><mml:math id="M5"><mml:msub><mml:mi>U</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>U</mml:mi><mml:mrow><mml:mtext>PSF</mml:mtext></mml:mrow></mml:msub><mml:mo>⊗</mml:mo><mml:mi>g</mml:mi><mml:mo>·</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>b</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>.</mml:mo></mml:math></disp-formula></p><p id="P21">Here, <italic>s</italic><sub><italic>i</italic></sub> is the total photon count of bead <italic>i</italic> and <italic>b</italic><sub><italic>i</italic></sub> is the average background photon count per pixel in the ROI. For fitting of single molecules, <italic>U</italic><sub>PSF</sub> is then directly used without the bead convolution. Indeed, when we calibrated a PSF with 200 nm beads and validating the calibration on 40 nm beads mimicking single fluorophores, we found that considering the bead size substantially improves the accuracy of the PSF model and reduces the bias in z-localization for both astigmatic PSFs (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 8</xref>) and 4Pi PSFs (<xref rid="F1" ref-type="fig">Fig. 1e</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Fig. 9</xref>, <xref ref-type="supplementary-material" rid="SD1">SI Note 2</xref>).</p></sec><sec id="S9"><title>Apodization</title><p id="P22">Most objectives are designed to be aplanatic, where at the nominal focal plane the image is free of coma and spherical aberrations. The imaging system satisfies the Abbe Sine condition. In this case, we assume that the objective can convert a spherical wavefront coming from an emitter at the nominal focal plane to a plane wavefront at the back focal plane (BFP) of the objective. To satisfy energy conservation, an apodization term, describing the amount of the incident area at the spherical surface projected to an unit area of the BFP, is incorporated into the transmission of the rays<sup><xref ref-type="bibr" rid="R45">45</xref></sup> (<xref ref-type="supplementary-material" rid="SD1">SI Note 3</xref>). This apodization term also assumes that the refractive index is matched between the sample medium and the immersion medium. In the case of refractive index mismatch, the apodization term is modified so that the retrieved pupil magnitude is nearly uniform (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 13</xref>).</p></sec><sec id="S10"><title>Pixilation</title><p id="P23">The finite size of the pixels results in a difference between the PSF value at the pixel center compared to the intensity averaged over the pixel. Neglecting this effect can lead to localization errors<sup><xref ref-type="bibr" rid="R46">46</xref></sup>. We can decrease the impact of pixilation by oversampling the PSF followed by binning, which we implemented into uiPSF. We found that pixilated PSFs are similar to slightly blurred PSFs, allowing us to replace the computationally expensive oversampling by applying an extra Gaussian blur (<xref rid="F6" ref-type="fig">ED Fig. 2</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Note 3</xref>).</p></sec><sec id="S11"><title>Intensity fluctuations, drift, and shear</title><p id="P24">Beads can flicker intrinsically, especially when imaged under high intensities, or when using multi-mode excitation that produces speckles<sup><xref ref-type="bibr" rid="R47">47</xref></sup>. Thus, we have the option to treat the intensity of each bead in each frame as a free fitting parameter (<xref ref-type="supplementary-material" rid="SD1">SI Fig.6</xref>). For pupil-based modelling, a per-frame intensity is always assumed unless otherwise set. Similarly, we can allow for lateral drifts (frame-wise shifts) in our forward model. We found that by estimating the lateral drift, the resulting PSF model will be less affected by lateral drift from the bead data (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 14</xref>). Additionally, some microscopes, like the lattice light-sheet microscope (<xref rid="F1" ref-type="fig">Fig. 1c</xref>)<sup><xref ref-type="bibr" rid="R48">48</xref></sup> or single-objective light-sheet microscopes utilizing remote-focusing<sup><xref ref-type="bibr" rid="R49">49</xref>,<xref ref-type="bibr" rid="R50">50</xref></sup>, translate the sample not along the optical axis, leading to sheared bead stacks. We can directly take this shearing into account in our forward model, avoiding computationally expensive and imprecise interpolations (<xref rid="F7" ref-type="fig">ED Fig. 3</xref>).</p></sec><sec id="S12"><title>Extra blurring</title><p id="P25">After considering the imperfections described above, we found that even the full vectorial forward model generally results in slightly sharper images than the experimental data, as has been observed previously<sup><xref ref-type="bibr" rid="R31">31</xref>,<xref ref-type="bibr" rid="R32">32</xref>,<xref ref-type="bibr" rid="R34">34</xref>,<xref ref-type="bibr" rid="R51">51</xref></sup>. The reasons for this are not entirely clear but could stem from non-isotropic dipole radiation, or system vibrations. By adding a convolution with a 2D Gaussian kernel with user-defined or estimated standard deviations in both x and y dimensions (<xref ref-type="supplementary-material" rid="SD1">SI Note 3</xref>), we can successfully describe this extra blurring, leading to more accurate PSFs and a reduced bias (<xref rid="F6" ref-type="fig">ED Fig. 2</xref>).</p></sec><sec id="S13"><title>Refractive index mismatch and supercritical angle emission</title><p id="P26">When using an oil objective, the refractive index mismatch results in depth-dependent aberrations<sup><xref ref-type="bibr" rid="R6">6</xref></sup>. Additionally, for high-NA objectives, emitters close to the coverslip can emit into super-critical angles (an angle in the immersion medium which is beyond the critical angle), leading to PSFs that are different from those of emitters a few hundred nanometers above the coverslip. When using a forward model in the Fourier domain (pupil-image based and Zernike-based models), the supercritical-angle fluorescence and depth-induced aberrations are incorporated and a theoretical PSF model can be calculated for arbitrary imaging depths (<xref rid="F8" ref-type="fig">ED Fig. 4</xref>).</p></sec></sec><sec id="S14"><title>Multi-channel PSFs</title><p id="P27">Two or more detection channels are used in SMLM for multi-color imaging<sup><xref ref-type="bibr" rid="R52">52</xref>–<xref ref-type="bibr" rid="R55">55</xref></sup>, for bi-plane 3D localization<sup><xref ref-type="bibr" rid="R15">15</xref>,<xref ref-type="bibr" rid="R16">16</xref></sup>, for 3D dense emitter fitting<sup><xref ref-type="bibr" rid="R56">56</xref></sup> or single-molecule orientation imaging<sup><xref ref-type="bibr" rid="R57">57</xref></sup>. Individual PSFs for each channel together with a transformation among the channels define a multi-channel PSF, which can improve the accuracy in global fitting<sup><xref ref-type="bibr" rid="R58">58</xref></sup> compared to fitting channels individually. We extended our inverse modeling approach to multiple channels to determine a PSF for each channel together with an affine transformation matrix (<xref rid="F2" ref-type="fig">Fig. 2a-b</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Table 2</xref>) and validated the estimated PSF model both with bead data (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 2</xref>) and in 3D dual-color imaging of NPCs (<xref rid="F2" ref-type="fig">Fig. 2c-d</xref>).</p><p id="P28">Interferometric 4Pi-SMLM<sup><xref ref-type="bibr" rid="R18">18</xref>,<xref ref-type="bibr" rid="R19">19</xref>,<xref ref-type="bibr" rid="R59">59</xref></sup> achieves excellent axial localization precisions by interfering the emission of fluorophores detected with two opposing objectives (<xref rid="F1" ref-type="fig">Fig. 1c</xref>). Depending on the z position of the fluorophore, the fluorescence intensity is modulated by constructive or destructive interference and is detected in 3 or 4 channels at different interference phases. The PSF in each channel is described by an incoherent enveloping term plus a modulation term<sup><xref ref-type="bibr" rid="R19">19</xref></sup>. A small change in the emitter’s z position or interference phase <italic>φ</italic><sub>0</sub> will shift the modulation and affect the PSF shape. This prevents averaging of multiple beads and makes it difficult to recover the 4Pi-PSF model. Here we overcome this limitation by choosing a PSF representation (IAB-based 4Pi-PSF model) in which the interference phase term is decoupled from the emitter’s z position<sup><xref ref-type="bibr" rid="R25">25</xref></sup>. In this representation, the 4Pi PSFs in each channel are generated from a model that consists of three 3D matrices (<italic>I</italic>, <italic>A</italic>, and <italic>B</italic>, <xref rid="F2" ref-type="fig">Fig. 2e</xref>) and a phase parameter <italic>φ</italic> = 2<italic>πkz</italic> + <italic>φ</italic><sub>0</sub>, where the two coupling parameters, <italic>z</italic> and <italic>φ</italic><sub>0</sub>, are absorbed into one parameter (<xref ref-type="supplementary-material" rid="SD1">SI Table 3</xref>), <disp-formula id="FD5"><mml:math id="M6"><mml:mi>U</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>,</mml:mo><mml:mi>φ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>I</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mi>A</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>cos</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>φ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mi>B</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>sin</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>φ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:math></disp-formula></p><p id="P29">We treat <italic>z</italic> and <italic>φ</italic> as independent variables for each bead (<xref rid="F2" ref-type="fig">Fig. 2f</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Fig. 9</xref>). An affine transformation matrix for each channel is also estimated (<xref rid="F2" ref-type="fig">Fig. 2g</xref>). This model is used for estimating a voxel-based representation of the 4Pi-PSF model. For inverse modelling in the Fourier domain, we coherently add PSF models from both objectives, each described by the pupil function images or Zernike coefficients (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 10</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Note 3</xref>). The resulting 4Pi PSFs in combination with global fitting allowed us to reach high 3D resolution even on dim but live-cell compatible photoconvertible fluorescent proteins, as demonstrated on NPCs labeled with mMaple (<xref rid="F2" ref-type="fig">Fig. 2h-i</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Fig. 15</xref>).</p></sec><sec id="S15"><title><italic>In situ</italic> PSF modelling</title><p id="P30">Although PSF models estimated from fluorescence bead data can achieve excellent localization precisions, they are still different from the emission patterns of a single fluorophore <italic>in situ</italic> in the cell. First, the bead size of 40-200 nm is large compared to the size of a fluorophore<sup><xref ref-type="bibr" rid="R60">60</xref></sup>, ∼2 nm. Second, bead data is usually collected with beads at the coverslip, while fluorophores in cells can be far above the coverslip. In this case, aberrations induced by a refractive index mismatch of the imaging buffer, or the sample, cannot be captured by the bead data. The resulting model mismatch can cause a bias in the fitted position and a loss in localization accuracy (<xref rid="F9" ref-type="fig">ED Fig. 5</xref>).</p><p id="P31">Here we overcome this limitation by directly estimating an <italic>in situ</italic> PSF model from the blinking single fluorophores, the raw data in SMLM. Our <italic>in situ</italic> PSF modelling approach simultaneously determines the 3D positions of the emitters and either image-based or Zernike-based pupil functions. It consists of four major steps: 1) select candidate emitters from raw SMLM data; 2) localize emitters using an initial PSF model; 3) select several thousand of emitters spanning the entire z-range, 4) estimate the PSF model from the selected emitters. This estimated PSF model is then used as the initial PSF model and steps 2-4 are repeated. Usually, two iterations are sufficient for most tested data. For data with low signal-to-noise ratio (SNR) or complex emission patterns, 5-6 iterations are required to converge (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 16</xref>).</p><p id="P32">We initially evaluated the <italic>in situ</italic> PSF modelling of uiPSF on simulated data (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 17</xref>). Specifically, we generated a single-molecule dataset based on a vectorial PSF model (<xref ref-type="supplementary-material" rid="SD1">SI Note 4</xref>) with a set of Zernike aberrations. The estimated pupil and <italic>x</italic>, <italic>y</italic>, <italic>z</italic> positions demonstrated excellent agreement with the ground truth of the simulated data and the position estimates reached their theoretical precision limit, defined by the CRLB. We further examined how the number of single molecules and axial sampling methods affect the fitting precision. We found that the precision of Zernike coefficients improves with larger number of single molecules (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 18</xref>) and can reach values below 1 nm (the root-mean-square (RMS) error of the wavefront) with 250 single molecules (5000 photons / localization, 10 background photons per pixel, z-range -600 nm to 600 nm). Moreover, selecting a larger fraction of defocused single molecules provided additional information, resulting in a higher precision of estimating the Zernike coefficients (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 18</xref>).</p><p id="P33">We experimentally tested the <italic>in situ</italic> PSF estimation on beads embedded in agarose gel for which images were collected at stage positions from 0 to 25 µm. The per-frame z positions from each bead are treated as independent variables to mimic <italic>in situ</italic> single-molecule data and an <italic>in situ</italic> PSF model is estimated for each bead to verify uiPSF’s capability of modelling the emission patterns at different imaging depths. Compared with the PSF estimated from beads on the coverslip, the <italic>in situ</italic> PSF models can accurately model the depth of each bead and the fitted z positions using the <italic>in situ</italic> PSF model shows good linearity with the stage positions (<xref rid="F9" ref-type="fig">ED Fig. 5</xref>).</p><p id="P34">We then validated our approach on single-molecule data taken from labeled microtubules. With a deformable mirror (DM) in the detection beam path, we introduced defined aberrations corresponding to individual Zernike modes. Comparing those DM-generated aberrations to the Zernike modes estimated from the <italic>in situ</italic> PSF modelling from the single-molecule data, we found an excellent correlation (<xref rid="F3" ref-type="fig">Fig. 3a,b</xref>). Residual differences, apparent as non-zero off-diagonal terms, are likely due to remaining aberrations from the imaging system and the fact that the aberration modes generated by DM can only approximate pure Zernike modes.</p><p id="P35">INSPR<sup><xref ref-type="bibr" rid="R41">41</xref></sup> is a recent software that determines Zernike coefficients from blinking fluorophores after phase retrieval with a modified GS algorithm. In comparison to uiPSF, it resulted in larger off-diagonal terms (<xref rid="F10" ref-type="fig">ED Fig. 6a-b</xref>). As a further comparison, we imaged AF647 dye molecules on coverslip at different z positions, extracted <italic>in situ</italic> PSF models (<xref rid="F10" ref-type="fig">ED Fig. 6c-d</xref>) and used those to fit the single moleucles again. Our <italic>in situ</italic> PSF estimation method exhibited a linear relationship between the fitted z-position and the objective z-position, whereas INSPR resulted in a discontinuity, suggesting a mismatch of the PSF model from the data.</p><p id="P36">As the aberrations generated by the DM are usually smooth across the pupil plane, they can be modeled well by Zernike polynomials. However, some PSFs generated with a phase plate or a spatial light modulator (SLM) can have discontinuities, requiring an image-based pupil function (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 19</xref>). We demonstrated pupil-image based <italic>in situ</italic> PSF estimation on Tetrapod PSF patterns generated from a phase plate (<xref rid="F3" ref-type="fig">Fig.3c</xref> and <xref rid="F11" ref-type="fig">ED Fig.7</xref>). Due to discontinuities of the phase pattern (<xref rid="F3" ref-type="fig">Fig. 3c</xref>), the Zernike-based <italic>in situ</italic> PSF modelling requires more accurate initial values and the obtained PSF model is blurrier than the one from pupil-image based modelling (<xref rid="F11" ref-type="fig">ED Fig. 7</xref>).</p><p id="P37">Our <italic>in situ</italic> PSF modelling method can easily be extended to multiple channels. We demonstrated this on a 4Pi-SMLM system by imaging Nup96 in U2OS cells, using the relatively dim photo-convertible fluorescent protein mMaple as a label (<xref rid="F3" ref-type="fig">Fig. 3d-f</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Fig. 20</xref>). We used uiPSF to extract the Zernike coefficients for the upper and lower interference arm independently and included a relative piston phase between the two arms (<xref rid="F3" ref-type="fig">Fig. 3f</xref>). To reduce the effect of data noise, we linked the Zernike coefficients between the 4 channels in each arm, except the tip, tilt and defocus, which describes the relative x, y and z shifts between the two objectives in each channel. The transformations among the channels are also obtained during the inverse modelling process.</p><p id="P38">We next tested the performance of uiPSF for <italic>in situ</italic> PSF learning at the presence of large sample-induced aberrations (<xref rid="F3" ref-type="fig">Fig. 3g-i</xref>). We imaged the Nup96 labeled with AF647 at the top of the nucleus, ∼5 µm above the coverslip, using an oil immersion objective lens (NA=1.43) and standard imaging buffer (n=1.35) (<xref rid="F3" ref-type="fig">Fig. 3j</xref> and Methods). The refractive index mismatch resulted in strong aberrations and clear differences between the <italic>in situ</italic> PSF and bead-based PSF models (<xref rid="F3" ref-type="fig">Fig. 3h</xref> and <xref rid="F12" ref-type="fig">ED Fig. 8</xref>). The reconstructed NPCs show consistent ring distances for the <italic>in situ</italic> PSF, but strong squeezing in the z-direction for the bead PSF at larger depth (<xref rid="F3" ref-type="fig">Fig. 3i</xref>). To quantitively evaluate the accuracy of both the bead PSF and <italic>in situ</italic> PSF models, we measured the distance between the two rings in 3D across thousands of NPCs<sup><xref ref-type="bibr" rid="R61">61</xref></sup> (<xref rid="F5" ref-type="fig">ED Fig. 1</xref>) and found that the <italic>in situ</italic> PSF model indeed resulted in more accurate and consistent measurements of the ring distance. We confirmed the robustness of the <italic>in situ</italic> PSF model by imaging Nup96 at various depths by placing U2OS cells on the top coverslip of a sandwiched sample (∼25 µm between the two coverslips). The sample was imaged by a silicon oil objective lens (NA=1.35) and standard imaging buffer (n=1.35). Data from both the upper and lower nuclear envelopes demonstrated that the <italic>in situ</italic> PSF model resulted in consistent distances between the two rings (<xref rid="F5" ref-type="fig">ED Fig. 1</xref>).</p></sec><sec id="S16"><title>Field-dependent aberrations</title><p id="P39">Up to now, we assumed that all beads or all fluorophores have identical emission patterns. However, this assumption is not generally fulfilled, as field-dependent (FD) aberrations lead to a PSF that is different at different positions in the FOV. This can be a major limitation for SMLM with large FOVs, which are important to increase the throughput of the slow SMLM imaging<sup><xref ref-type="bibr" rid="R62">62</xref></sup>. Here, we overcome this limitation by considering an FD-PSF model in the Zernike representation. Instead of estimating one set of Zernike coefficients, we represent every Zernike aberration as a map where each pixel value represents the Zernike coefficient at the center of the subregion. In the forward model, the Zernike coefficients for each emitter are calculated from the linear interpolation of the aberration maps at the pixel coordinates of the bead or fluorophore. During the estimation, we impose a certain degree of smoothness to the aberration maps, leading to meaningful values even when no emitter was found in a subregion (<xref ref-type="supplementary-material" rid="SD1">SI Note 3</xref>).</p><p id="P40">We first validated modelling of FD-PSFs using bead images across a FOV of 180 µm × 180 µm. Since the bead images were taken at equal axial spacing, the x, y, z positions and background parameter of all images in each bead stack were linked. In contrast, the photon parameter of each bead stack was fitted individually in each frame to account for bleaching and intensity fluctuations. The aberration maps across the whole FOV were directly estimated by maximum likelihood estimation using all beads simultaneously by globally optimizing the aberration maps. The resulting aberration maps were much smoother than those obtained by FD-DeepLoc<sup><xref ref-type="bibr" rid="R42">42</xref></sup>, which fits every bead individually. Thus, uiPSF reduced artifacts introduced by abnormal bead images (e.g. aggregated beads, non-uniform beads) which often appear in the single bead fitting process (<xref rid="F4" ref-type="fig">Fig. 4a</xref>, <xref ref-type="supplementary-material" rid="SD1">SI Fig. 21a</xref>). Finally, we validated the FD-PSF model by fitting the z position of each bead and compared them to the objective positions and could show that localization biases were greatly reduced compared to fitting with the average PSF model (<xref rid="F4" ref-type="fig">Fig. 4b,c</xref> and <xref ref-type="supplementary-material" rid="SD1">SI Fig. 21b</xref>).</p><p id="P41">Next, we showed that uiPSF estimates an <italic>in situ</italic> FD-PSF model from single-molecule blinking data. From imaging NPCs in many cells across a FOV of 180 µm × 180 µm, we observed a high degree of similarity in the estimated aberration maps between bead and <italic>in situ</italic> PSF models (<xref rid="F4" ref-type="fig">Fig. 4a</xref>). We used the deep-learning based fitter, FD-DeepLoc<sup><xref ref-type="bibr" rid="R42">42</xref></sup>, to reconstruct the NPCs with <italic>in situ</italic> and bead FD-PSF models and found that both FD-PSF models lead to higher quality reconstructions compared to that of using an averaged PSF model (<xref rid="F4" ref-type="fig">Fig. 4d-l</xref>).</p></sec><sec id="S17"><title>Microscope characterization</title><p id="P42">uiPSF is a useful toolbox for characterization and optimization of a microscope system, as the estimated PSFs, Zernike coefficients and aberration maps provide useful information on the aberrations of the imaging system. uiPSF provides a demo notebook that takes a Zernike-based PSF model as an input and displays major aberrations modes, the Strehl ratio and full width of half maximum (FWHM) of the PSF model for each channel. For a 4Pi-SMLM system, it will report the modulation depth instead of the Strehl ratio. For FD-PSF modelling, the notebook will display the aberration maps of the major aberrations, as well as the Strehl ratio and FWHM maps. The user can use this information to minimize system aberrations, or, if adaptive optics (AO) systems (deformable mirror or spatial light modulator) are integrated, to directly compensate for system or sample-induced aberrations.</p><p id="P43">We demonstrated this by imaging NPCs at the upper nuclear envelope, ∼4 µm above the coverslip, <xref rid="F13" ref-type="fig">ED Fig.9a</xref>). Spherical aberrations caused by the refractive index mismatch, reduced localization precisions, making it difficult to resolve the two-layer ring structure of the NPC without aberration correction (<xref rid="F13" ref-type="fig">ED Fig.9b-c</xref>). By employing <italic>in situ</italic> PSF modelling, we determined the Zernike aberrations and directly fed them back to the DM for AO correction, resulting in a significant improvement in the quality of the reconstructed NPCs (<xref rid="F13" ref-type="fig">ED Fig.9d</xref>).</p></sec></sec><sec id="S18" sec-type="conclusions"><title>Conclusion</title><p id="P44">We developed uiPSF, a modular toolbox that reconstructs accurate PSF models for most fluorescence microscopes, including single channel, multi-channel, 4Pi and lattice light-sheet systems, and demonstrated its use for SMLM. It can parameterize the PSFs in the form of 3D matrices, Zernike-based and image-based pupil functions. It can also account for various experimental imperfections such as field-dependent aberrations, the finite size of beads or camera pixels, intensity fluctuations, drifts, and shot noise. This versatility in terms of representations and extensions on one hand allows for optimizing the approach for highest robustness and accuracy, but also might be overwhelming for non-experts. Here we give a general guideline for selecting PSF representation and extensions (<xref ref-type="supplementary-material" rid="SD1">SI Note): 1</xref>) When bead data exists and when SMLM data were collected near the coverslip, we recommend using voxel-based learning (i.e., inverse modelling) if the number of beads is sufficient or Zernike-based learning if SNR is low. 2) For SMLM data at large depths with index mismatched buffer, or when bead data is not available, <italic>in situ</italic> PSF learning is always recommended. However, as discussed above, <italic>in situ</italic> PSF learning requires single fluorophores spanning a large axial range, thus if most emitters are located at similar z positions, <italic>in situ</italic> PSF learning might fail. 3) Pupil-image based learning is recommended only when the pupil function cannot be presented by Zernike polynomials. 4) For pupil-based learning (includes both Zernike-based and pupil-image based methods), we always recommend using the vectorial PSF model if computational resources permit, otherwise the scalar PSF model can be used for faster learning. 5) Voxel-based learning only works for bead data. Frame-wise intensity and lateral drift are not required, unless bead data exhibit large intensity fluctuation or lateral shifts between frames. 6) For pupil-based learning, an extra blurring should be always learned or set. 7) Oversampling and binning is usually not required. 8) The bead size can be ignored when bead is smaller than 100 nm.</p><p id="P45">The robustness of uiPSF allows extracting PSFs not only from bead stacks, but directly from the images of single blinking fluorophores, the raw data of SMLM. This not only renders a cumbersome bead calibration obsolete, but it also improves the accuracy of the PSF model, as the PSF is extracted precisely where it is measured and can include sample-induced aberrations.</p><p id="P46">The modularity of the software allows for simple extensions of the forward model in the future to include for instance fixed dipoles for single-molecule orientation microscopy<sup><xref ref-type="bibr" rid="R57">57</xref></sup>, polarized detection (e.g. using a polarized beam splitter in the emission path), spectral SMLM<sup><xref ref-type="bibr" rid="R63">63</xref>,<xref ref-type="bibr" rid="R64">64</xref></sup>, and imaging systems using structured illuminations, such as confocal, image scanning microscopy, structured illumination microscopy, SIMFLUX methods<sup><xref ref-type="bibr" rid="R65">65</xref>–<xref ref-type="bibr" rid="R67">67</xref></sup>, and MINFLUX<sup><xref ref-type="bibr" rid="R68">68</xref></sup>.</p><p id="P47">To make uiPSF easily accessible, we developed a user-friendly, extendable, and performant software in Python/TensorFlow that can be used via simple Jupyter Notebooks and integrates readily into existing software for SMLM analysis<sup><xref ref-type="bibr" rid="R23">23</xref>,<xref ref-type="bibr" rid="R42">42</xref>,<xref ref-type="bibr" rid="R58">58</xref>,<xref ref-type="bibr" rid="R69">69</xref>,<xref ref-type="bibr" rid="R70">70</xref></sup>. Computation times depend on the number of beads or single molecules used to learn the PSF, as well as on the representation, extensions and number of detection channels, but typically lie between 40 s (single-channel voxelated PSF from 20 beads) and 35 min (4Pi <italic>in situ</italic> model from 10000 single fluorophores) on a consumer GPU (Nvidia RTX3080). uiPSF will enable many microscopists to quantify and optimize the performance of their microscopes and to perform SMLM with improved accuracy.</p></sec><sec id="S19" sec-type="methods"><title>Methods</title><sec id="S20"><title>Microscopes</title><sec id="S21"><title>4Pi-SMLM</title><p id="P48">The 4Pi-SMLM system is a custom-built microscope as described previously<sup><xref ref-type="bibr" rid="R59">59</xref>,<xref ref-type="bibr" rid="R71">71</xref></sup>. It consists of two opposingly configurated objectives (silicone oil objective, NA = 1.35, UPLSAPO100XS, Olympus), collecting fluorescence emission into both upper and lower emission arms. Four lasers 405 nm (iBEAM-SMART-405-S, 150 mW, TOPTICA Photonics), 488 nm (iBEAM-SMART-488-S-HP, 200 mW, TOPTICA Photonics), 561 nm (2RU-VFL-P-1500-560-B1R, MPB Communications) and 642 nm (2RU-VFL-2000-642-B1R, MPB Communications) were coupled into a single mode fiber for fluorescence imaging. The lasers were then filtered through a clean-up filter (ZET405/488/561/640xv2, Chroma) and reflected by a quadband dichroic (Di03-R405/488/561/635, Semrock) into the lower objective. The fluorescence emission was collected by both objectives and filtered by a quadband emission filter (FF01-432/515/595/730-25, Semrock). A band pass emission filter (FF01-600/37-25, Semrock) was also used before the camera for imaging Nup96-mMaple. The microscope is controlled through a LabView-based software. Two deformable mirrors (Multi-DM 5.5, Boston Micromachines), one in each emission arm, were used to minimize systematic aberrations and apply astigmatism aberration. The DMs were calibrated using a Python-based software to generate accurate Zernike aberrations.</p></sec><sec id="S22"><title>Dual-color ratiometric imaging systems</title><p id="P49">The dual-color SMLM system is a custom-built microscope as described previously<sup><xref ref-type="bibr" rid="R58">58</xref></sup>. We used the same microscope for both dual-color and single-color imaging of NPCs (<xref rid="F2" ref-type="fig">Fig. 2a-d</xref>, <xref rid="F3" ref-type="fig">Fig. 3g-i</xref>). It equipped with a high NA oil immersion objective (160x, 1.43-NA oil immersion, Leica, Wetzlar, Germany). A commercial laser box (LightHub®, Omicron-Laserage Laserprodukte, Dudenhofen, Germany) equipped with Luxx 405, 488 and 638, Cobolt 561 lasers and an additional 640 nm booster laser (iBeam Smart, Toptica, Munich, Germany) were combined for wide field illumination. Lasers were focused onto a speckle reducer (LSR-3005-17S-VIS, Optotune, Dietikon, Switzerland) and coupled into a multi-mode fiber (M105L02S-A, Thorlabs, Newton, NJ, USA). The lasers were triggered using an FPGA (Mojo, Embedded Micro, Denver, CO, USA) allowing microsecond pulsing control of lasers. The output of the fiber was magnified by an achromatic lens and imaged into the sample plane. A laser clean-up filter (390/482/563/640 HC Quad, AHF, Tübingen, Germany) was placed in the excitation beam path to remove the fluorescence generated by the fiber. The focus of microscope was stabilized by a 785 nm infrared laser (iBeam Smart, Toptica, Munich, Germany) that was projected through the objective and reflected by the coverslip onto a quadrant photodiode, which was used as closed-loop feedback signal to the objective piezo stage (P-726 PIFOC, Physik Instrument, Karlsruhe, Germany). The astigmatic 3D imaging was acquired using a cylindrical lens (f = 1,000 mm; LJ1516L1-A, Thorlabs) to introduce astigmatism. For astigmatic dual-color imaging with AF647 and CF680, the fluorescence was split by a 665 nm long pass dichroic (ET665lp, Chroma), filtered by a 685/70 (ET685/70 m, Chroma) bandpass filter for the transmitted light and a 676/37 (FF01-676/37-25, Semrock) bandpass filter for the reflected light. An EMCCD camera (Evolve512D, Photometrics, Tucson, AZ, USA) was used to collect final fluorescence. The microscope is entirely controlled by Micro-Manager41 using htSMLM, a custom EMU plugin<sup><xref ref-type="bibr" rid="R72">72</xref></sup>.</p></sec><sec id="S23"><title>Large FOV imaging system</title><p id="P50">Large FOV imaging system is a custom-built microscope designed for high-throughput SMLM imaging at room temperature (24 °C). The sample illumination is achieved by combining lasers with a multimode fiber (WFR CT200x200/230x230/440/620/1100N, NA 0.22, CeramOptec). The lasers pass through a laser cleanup filter (ZET405/488/561/640xv2, Chroma) and a main dichroic (ZT405/488/561/640rpcxt-UF2, Chroma) before entering the objective for sample illumination. The fluorescence emitted by the sample is collected by a high-NA objective (NA 1.5, UPLAPO ×100 OHR) and filtered using a quad-band emission filter (ZET405/488/561/640mv2, Chroma). A cylindrical lens is placed at a specific distance in front of the imaging camera for astigmatism-based 3D imaging. Prior to reaching the sCMOS camera (PRIME 95B, Teledyne Photometrics), the residual laser is eliminated using a band-pass filter (ET680/40m, Chroma). A 785 nm near-infrared laser (iBEAM-SMART-785-S, Toptica Photonics) is introduced to stabilize the sample focus using a dichroic mirror (FF750-SDi02, Semrock). The reflected laser is detected by a quadrant photodiode (SD197-23-21-041, Advanced Photonix), and the position-dependent output voltage serves as feedback for the z-axis of the objective (P-726.1CD, Physik Instrumente). The microscope is controlled using Micro-Manager integrated with EMU<sup><xref ref-type="bibr" rid="R72">72</xref></sup>. Typically, we acquire 50,000 to 100,000 frames with exposure times ranging from 15 to 25 ms.</p></sec><sec id="S24"><title>Adaptive optics single-channel SMLM system</title><p id="P51">Adaptive optics single-channel SMLM system is a custom-built microscope as described before<sup><xref ref-type="bibr" rid="R73">73</xref></sup>. A combination of laser beams of different wavelengths is used in the experiment. A 405 nm laser (iBEAM-SMART-405-S, 150 mW, TOPTICA Photonics), a 488 nm laser (iBEAM-SMART-488-S-HP, 200 mW, TOPTICA Photonics), a 561 nm laser (MGL-FN-561nm, 300mW, CNI), and a 640 nm laser (iBEAM-SMART-640-S-HP, 200mW, TOPTICA Photonics) are combined using a fiber coupler (PAF2-A4A, Thorlabs) and transmitted through a single-mode fiber (P3-405BPM-FC-2, Thorlabs). The position of the fiber output can be adjusted using a translation stage to achieve different illumination angles. To eliminate fluorescence induced by the fiber, the illumination beam is filtered using a laser clean-up filter (ZET405/488/561/640xv2, Chroma). The main dichroic mirror (ZT405/488/561/640rpcxt-UF2, Chroma) reflects the beam, which then enters the objective to illuminate the sample. The emitted fluorescence is collected by a high NA objective (NA 1.35, UPLSAPO 100XS or NA 1.5, UPLAPO 100XOHR, Olympus) and imaged using the tube lens (TTL-180-A, Thorlabs). Two bandpass filters (NF03-405/488/561/635E-25 and FF01-676/37-25, Semrock) are used to separate the emitted fluorescence from the excitation laser. A deformable mirror (DM140A-35-P01, Boston Micromachines) is placed in the Fourier plane is employed for PSF engineering. To accurately determine the influence function of each actuator in the DM, we adopted the method outlined in reference<sup><xref ref-type="bibr" rid="R74">74</xref></sup>. Finally, the images are captured using an sCMOS camera (ORCA-Flash4.0 V3, HAMAMATSU) with a pixel size of 108 nm on the sample. Typically, 50,000-100,000 frames are acquired with a 15-25 ms exposure time.</p></sec><sec id="S25"><title>Optical system for generating Tetrapod PSFs</title><p id="P52">Plan Apo 100X/1.45 NA Nikon objective was fitted on a Nikon Eclipse-Ti inverted fluorescence microscope with a sCMOS camera (Prime95B, Photometrics). The sample was illuminated by a high-intensity 638 nm 2000 mW red dot laser module, filtered through a 25 µm pinhole (Thorlabs) and low intensity 405nm laser (iChrome MLE, Toptica, &lt;5mw). The emission path was extended by a 4f system consisting of two achromatic doublet lenses (focal length 15 cm) and a dielectric phase mask (a 4 µm z-range Tetrapod, photolithographically fabricated) was placed in the conjugate back focal plane. The emission light was filtered through a 500 nm long pass dichroic and a 650 nm long pass (Chroma).</p></sec></sec><sec id="S26"><title>Sample preparation</title><sec id="S27"><title>Cell culture</title><p id="P53">COS-7 cells (catalog no. 100040, BNCC) were grown in DMEM (catalog no. 10569, Gibco) containing 10% (v/v) fetal bovine serum (FBS; catalog no. 10099-141C, Gibco), 100 U ml−1 penicillin and 100 μg ml−1 streptomycin (PS; catalog no. 15140-122, Gibco). U2OS cells (Nup96-SNAP no. 300444, Cell Line Services) were grown in DMEM containing 10% (v/v) FBS, 1× PS and 1× MEM non-essential amino acids (NEAAs; catalog no. 11140-050, Gibco). Cells were cultured in a humidified atmosphere with 5% CO2 at 37 °C and passaged every 2 or 3 d. Before cell plating, high-precision 25-mm round-glass coverslips (no. 1.5H, catalog no. CG15XH, Thorlabs) were cleaned by sequentially sonicating in 1 M potassium hydroxide (KOH), Milli-Q water and ethanol and finally irradiated under ultraviolet light for 30 min. For super-resolution imaging, COS-7 and U2OS cells were cultured on the clean coverslips for 2 d with a confluency of 80–90%. All cells were cultured at 37 °C in a humidified atmosphere containing 5% CO2. Mycoplasma detection was conducted routinely to ensure Mycoplasma-free conditions throughout the study.</p></sec><sec id="S28"><title>Nup96-mMaple in U2OS cells</title><p id="P54">U2OS-Nup96-mMaple cells were prepared as previously reported. Cells were prefixed for 30 s in 2.4% (w/v) formaldehyde in PBS and then permeabilized with 0.4% (v/v) Triton X-100 in PBS for 3 min. To complete the fixation, samples were incubated for 30 min in 2.4% (w/v) formaldehyde in PBS. Formaldehyde was subsequently quenched in 100 mM NH4Cl in PBS for 5 min before washing the coverslip twice for 5 min in PBS.</p></sec><sec id="S29"><title>Nup96-SNAP-AF647 in U2OS cells</title><p id="P55">To label Nup96, U2OS-Nup96-SNAP cells were prepared as previously reported. Cells were prefixed in 2.4% paraformaldehyde (PFA) for 30 s, permeabilized in 0.4% Triton X-100 for 3 min and subsequently fixed in 2.4% PFA for 30 min. Then, cells were quenched in 0.1 M NH4Cl for 5 min and washed twice with PBS. To decrease unspecific binding, cells were blocked for 30 min with Image-iT FX Signal Enhancer (catalog no. I36933, Invitrogen). For labeling, cells were incubated in dye solution (1 μM SNAP-tag ligand BG-AF647 (catalog no. S9136S, New England Biolabs), 1 mM dithiothreitol (catalog no. 1111GR005, BioFroxx) and 0.5% bovine serum albumin (BSA) in PBS) for 2 h and washed three times in PBS for 5 min each to remove excess dyes. Last, cells were post-fixed with 4% PFA for 10 min, washed with PBS three times for 3 min each and stored at 4 °C until imaged.</p></sec><sec id="S30"><title>TOMM20-AF647 imaging with Tetrapod PSFs</title><p id="P56">Sample preparation included cleaning coverslips (22 × 22 × 0.17 mm) in an ultrasonic bath with 5% Decon90 at 60°C for 30 min, then washing with water and incubating in ethanol absolute for 30 min. Finally sterilized with 70% filtered ethanol for another 30 min. COS7 cells were grown for 24 hours on the coverslips in 6-well plate in phenol red free Dulbecco’s Modified Eagle Medium (DMEM) With 1g/l D-Glucose (Low Glucose) supplemented with 10% Fetal bovine serum, 100 U/ml penicillin 100 ug/ml streptomycin and 2 mM glutamine, at 37oC, and 5% CO2. The cells were fixed with 4% paraformaldehyde and 0.2% glutaraldehyde in PBS, pH 6.2, for 45 min, washed and incubated in 0.3M glycine/PBS solution for 10 minutes. The coverslips were transferred into a clean 6-well plate and incubated in a blocking solution (10% goat serum, 3% BSA, 2.2% glycine, and 0.1% Triton-X in PBS, filtered with 0.45 µm PVDF filter unit, Millex) for 2 hours at 4oC. The cells were then immunostained overnight at 4°C with anti TOMM20-AF647 antibody (diluted 1:230 in the blocking buffer) and then washed X5 with PBS. Finally, blinking buffer was made from 100 mM β-mercaptoethylamine hydrochloride, 20% sodium lactate, and 3% OxyFluor (Sigma, SAE0059). At the time of imaging, a PDMS chamber was attached to the glass coverslip containing the fixed cells with a second coverslip on top to prevent evaporation. The camera exposure time was 30 ms.</p></sec><sec id="S31"><title>Fluorescence bead sample</title><p id="P57">The fluorescence beads used in this study include: 40 nm red bead (580/605 nm, Thermo Fisher, cat. no. F8793), 100 nm red bead (580/605 nm, Thermo Fisher, cat. no. F8801), 200 nm red bead (580/605 nm, Thermo Fisher, cat. no. F8810) and 100 nm TetraSpeck bead (Thermo Fisher Scientific, cat. no. T7279). For the single objective system, except the measurement of the Tetrapod PSF, the same preparation procedure is used. A clean 25 mm coverslip was incubated with 1 ml of bead dilution in 100 mM MgCl<sub>2</sub> for 10 minutes. The coverslip was then washed with PBS for three times. The coverslip was then transferred to a custom sample holder and 1 ml of PBS was added to the coverslip. The sample was then mounted for imaging. The concentration of the bead dilution in above mentioned beads are 1:10<sup>7</sup>, 1:10<sup>6</sup>, 1:10<sup>5</sup> and 1:10<sup>6</sup> respectively. For measuring Tetrapod PSF, 40 nm red beads (580/605 nm, Thermo Fisher, cat. no. F8793) immobilized on the coverslip with 1% Polyvinyl alcohol were imaged.</p></sec><sec id="S32"><title>Imaging buffer</title><p id="P58">Samples were imaged in refractive index matching buffer, including 50 mM Tris-HCl (pH 8.0), 10 mM NaCl, 10% (w/v) glucose, 0.5 mg/ml glucose oxidase (G7141, Sigma), 40 μg/ml catalase (C100, Sigma), 35 mM cysteamine and 28.5% (v/v) 2,2′-thiodiethanol (166782, Sigma). The refractive index of the final imaging buffer was n = 1.406.</p></sec></sec><sec id="S33"><title>Data acquisition</title><sec id="S34"><title>Imaging of Nup96-mMaple on 4Pi-SMLM</title><p id="P59">The fixed Nup96-mMaple cells were incubated with 100 nm red fluorescent beads in a dilution of 1:10<sup>6</sup> in 100 mM MgCl<sub>2</sub> for 10 minutes. The cells were then washed three times with PBS. The coverslip was picked up with a tweezer and the excess buffer was removed by gently touching the edge of the coverslip on a Kimwipe tissue. The coverslip was then transferred to a custom sample holder, 200 µl imaging buffer (43.2% (w/w) sucrose in 50 mM Tris in D2O, pH 8.0) was added to the coverslip. A clean 24 mm coverslip was slowly placed on top of the imaging buffer. The top coverslip was slightly touched with the blunt side of a tweezer and the excess buffer was extracted with Kimwipes. The coverslips were then sealed with a two-component dental glue (Picodent, 1300 1000). After the dental glue solidifies in ∼20 minutes, the sample was mounted for imaging.</p><p id="P60">Before data collection, the deformable mirror (DM) in each arm was optimized to minimize the system aberrations. The optimization procedure is as follows: a z-stack of bead data was collected from each emission arm and the Zernike coefficients were retrieved using a GS-based phase retrieval algorithm. The corresponding correction voltage-map based on the retrieved Zernike coefficients were applied to the respective DM. This process was repeated 2-3 times until the obtained Zernike coefficients were within ±0.02 radian.</p><p id="P61">140,000 frames were collected at an exposure time of 25 ms, with a 561 nm excitation laser power of 2.3 kW/cm<sup>2</sup>, and a 405 nm activation laser power of 0-40 W/cm<sup>2</sup> which was automatically adjusted to maintain the number of emitters per frame at ∼3.</p></sec><sec id="S35"><title>Dual-color ratiometric imaging of Nup96 and WGA</title><p id="P62">The sample for dual-color imaging of Nup96 and wheat germ agglutinin (WGA) was prepared as previously reported<sup><xref ref-type="bibr" rid="R75">75</xref></sup>. Nup96-SNAP-tag cells (catalog no. 300444, CLS Cell Line Service) were rinsed twice with warm PBS. Prefixation was carried out in a 2.4% [w/v] formaldehyde in PBS solution for 40 s before the samples were permeabilized in 0.4% [v/v] Triton X-100 in PBS for 3 min. Complete fixation was carried out in 2.4% [w/v] formaldehyde in PBS for 30 min followed by three 5 min washing steps in PBS after fixation. Subsequently, the sample was incubated for 30 min with Image-iT FX Signal Enhancer (catalog no. I36933, Thermo Fisher Scientific) before staining with SNAP dye buffer (1 µM BG-AF647 (catalog no. S9136S, New England Biolabs) and 1 µM dithiothreitol in 0.5% [w/v] BSA in PBS) for 2 h at room temperature. To remove unbound dye, coverslips were washed three times for 5 min in PBS. For WGA staining, the sample was then incubated for 10 min with 400 ng ml−1 WGA-CF680 (catalog no. 29029-1, Biotium) in 100 mM Tris pH 8.0, 40 mM NaCl, and rinsed three times with PBS. Before imaging, samples were mounted on a custom sample holder in imaging buffers. The holder was sealed with parafilm.</p></sec><sec id="S36"><title>Collection of SMLM data at various DM generated aberrations</title><p id="P63">We tested the accuracy of distortion wavefront estimation from a single-molecule blinking datasets (<xref ref-type="supplementary-material" rid="SD1">SI Fig. 20</xref>). The deformable mirrors were calibrated to introduce single-aberration modes based on Zernike polynomials (<xref ref-type="supplementary-material" rid="SD1">SI Note 5</xref>). We utilized 21 Zernike modes within the Fringe order, ranging from vertical astigmatism to third-order spherical aberration. Each mode was applied to distort fluorescent beads and single molecules with Zernike-based aberrations (amplitude ±1, units λ/2π) introduced by the DM. These aberrations were then used in the in situ PSF construction algorithm to globally fit the coefficients of the 21 Zernike modes post-acquisition. After processing the 21 Zernike modes, we created a heat map to illustrate the relationship between the DM input of the Zernike modes and the output amplitude of the algorithm.</p></sec><sec id="S37"><title>Imaging of Nup96-AF647 at large FOV</title><p id="P64">Nup96-SNAP-AF647 labeled U2OS cells were imaged with the sCMOS camera over an FOV covering the full chip (1608×1608 pixels). The camera was operated under rolling shutter readout mode with an exposure time of 20 ms. 100,000 frames were acquired. The position of the cylindrical lens before camera was adjusted so that ∼80 nm astigmatism aberration was introduced to the system.</p></sec><sec id="S38"><title>Collection of bead data on 4Pi-SMLM</title><p id="P65">Fluorescence beads were added to the cell sample as described in “Imaging of Nup96-mMaple on 4Pi-SMLM”. To reconstruct the 4Pi-PSF model from bead data, 20-30 bead stacks were collected. Each bead stack was collected by moving the sample stage from -0.5 µm to 0.5 µm with a step size of 50 nm, and three phase positions were collected at each z position by applying a piston phase to the DM at -2π/3, 0 2π/3. One frame per phase position was collected at an exposure time of 20 ms. The three phase positions were imaged with minimum delay where the DM change triggers the frame capture through software trigger.</p></sec><sec id="S39"><title>Collection of bead data on single objective SMLM systems</title><p id="P66">The bead data for dual-color ratio-metric imaging and single-color imaging were collected in similar procedures. The fluorescence bead sample was prepared as described above. 10-30 bead stacks were collected where each bead stack was acquired by moving the sample stage from -1 µm to 1 µm with a step size of 10-50 nm. One frame per z position was collected at an exposure time of 10-35 ms. Beads embedded in agarose gel were collected by moving the sample stage from -1 µm to 5 µm with a step size of 20 nm. One frame per z position was collected at an exposure time of 50 ms.</p></sec><sec id="S40"><title>uiPSF guided aberration correction with a DM</title><p id="P67">First, we acquired ∼1000 frame of single molecule data without adaptive optics (AO) correction. We then utilized uiPSF to perform <italic>in situ</italic> PSF modeling from single molecule data, resulting in Zernike aberrations. We applied 21 Zernike modes within the Fringe order, ranging from vertical astigmatism to third-order spherical aberration to the deformable mirror to compensate these aberrations using calibrated Zernike mirror modes (<xref ref-type="supplementary-material" rid="SD1">SI Note 5</xref>). Finally, we performed a complete single molecule data acquisition with AO correction activated.</p></sec></sec></sec><sec sec-type="extended-data" id="S41"><title>Extended Data</title><fig id="F5" position="anchor"><label>ED Fig 1</label><caption><title>In situ PSF model reduces the local deformation in z measured by the ring distance of Nup96.</title><p id="P68">(a) A subregion of the reconstructed Nup96 using the <italic>in situ</italic> PSF model. (b-c) XZ view of selected region in a from bead and <italic>in situ</italic> PSF models. (d) and (e) are the ring distance of Nup96 as a function of z-position at different depth reconstructed by using beads PSF model and in situ PSF model respectively. The points of various colors represent different imaging depths of Nup96. The straight lines represent the linear regression of the axial distance and z position for each imaging depth, with k representing the corresponding slope. An oil immersion objective lens (NA = 1.43) was used for imaging. (f) and (g) have the same meaning as (d) and (e), respectively, but imaged by a silicone oil immersion objective lens (NA = 1.35). Scale bars, 1 µm (a), 500 nm (b).</p></caption><graphic xlink:href="EMS190232-f005"/></fig><fig id="F6" position="anchor"><label>ED Fig 2</label><caption><title>Effect of pixelation using the vectorial PSF modelling method.</title><p id="P69">(a) Test on simulated data. Data were simulated from vectorial PSF model, with a binning of 5 in both x and y dimensions, and without extra blurring to the PSF model. (b) Test on experimental data. The estimated blur factor is slightly smaller when adding a binning of 5 in the forward model. However, the estimated PSF model and the localization bias are nearly identical with or without additional binning in the forward model. In contrast, under the same blur factor but without binning (bin=1), the axial bias increases dramatically and the estimated PSF model differs substantially. Scale bar, 1 µm.</p></caption><graphic xlink:href="EMS190232-f006"/></fig><fig id="F7" position="anchor"><label>ED Fig 3</label><caption><title>Estimation of voxel-based PSF model of a lattice light-sheet system from bead data.</title><p id="P70">The data were collected by imaging beads in agarose gel at sample stage positions from -50 µm to 50 µm, with a step size of 50 nm. Translation of the sample stage will translate the beads both in x and z dimensions in the coordinate of the detection objective. For this data, translating the sample stage by 50 nm, will translate the beads by 40.8 nm in x and 28.9 nm in z relative to the detection objective. (a) Localization in x of the deskewed data used for inverse modelling. (b) The raw data stack of each bead was deskewed using the above translation relationship between x and z dimensions. Only shifts of integer pixels were applied to maintain the photon statistics of the raw data. The deskewed bead stacks were used for inverse modelling. The sub-pixel shifts were incorporated in the forward model so that the estimated PSF model has no skew as in d. (c) localization of the data used for inverse modelling, sub-pixel shifts were applied to the localization result in a to remove the skew effect. (d) Estimated PSF model. (e) Comparison of an example bead stack and its corresponding forward model. Scale bars, 1 µm (b,d,e).</p></caption><graphic xlink:href="EMS190232-f007"/></fig><fig id="F8" position="anchor"><label>ED Fig. 4</label><caption><p id="P71"><bold>Incorporating refractive index mismatch aberrations</bold> in the estimated PSF model. Bead data at different imaging depth were collected by imaging beads in agarose gel at stage positions from -1 µm to 5 µm, with a step size of 20 nm. Bead data at the coverslip were collected at stage positions from -1.5 µm to 1.5 µm, with a step size of 10 nm. (a) Localization of beads in agarose gel using the PSF model estimated from beads at the coverslip. (b) Localization of beads in agarose gel using the PSF model estimated from beads at the coverslip and modified by adding an index mismatch aberration at the estimated imaging depth of each bead. Therefore, each bead stack was localized by its own modified PSF model. Depth is defined as the estimated emitter’s z position to the coverslip. (c) Comparison of the PSF models at the coverslip, bead data at different imaging depth and their corresponding PSF models. With increasing depth, the pupil size slightly decreases as the effective numerical aperture (NA) decreases from 1.43 to 1.33 (the refractive index of water), and the pupil phase show larger spherical aberration kind of patterns. Scale bars, 1 µm (c).</p></caption><graphic xlink:href="EMS190232-f008"/></fig><fig id="F9" position="anchor"><label>ED Fig. 5</label><caption><title>Validation of <italic>in situ</italic> PSF estimation using bead data in agarose gel.</title><p id="P72">The images of these beads were collected at stage positions from -1 µm to 25 µm. For each bead, the per-frame z position was used as an independent variable to simulate the <italic>in situ</italic> single molecule data. (a) The PSF estimated from the beads on the cover glass was used to localize the bead data at different depths. (b) The <italic>in situ</italic> PSF estimated by uiPSF was used to localize the bead data at different depths. Compared to the PSF model estimated from the beads on the cover glass, the <italic>in situ</italic> PSF model fitted z-positions exhibit a good linear relationship with the objective stage positions.</p></caption><graphic xlink:href="EMS190232-f009"/></fig><fig id="F10" position="anchor"><label>ED Fig 6</label><caption><title>Comparison of Zernike-based PSF modelling using uiPSF and INSPR.</title><p id="P73">Comparison between the input amplitude and the fitted amplitude of the <italic>in situ</italic> PSF modelling using the vectorial uiPSF (a) and the INSPR method (b) for 21 Zernike modes (fringe indices) of the deformable mirror input. Single-molecule data were collected when the DM was applied with 21 different Zernike modes separately. Such type of data was fitted by uiPSF and INSPR (b was adapted with permission from <xref rid="F3" ref-type="fig">Fig. 3f</xref> in Xu et. al. <sup><xref ref-type="bibr" rid="R41">41</xref></sup>). As shown in a and b, the Zernike aberrations returned by uiPSF have lower residual aberrations, compared to INSPR. Comparison of uiPSF (c) with the INSPR method (d) for fitted z-position and objective z-position. We imaged the dye AF647 immobilized on a coverslip and moved the objective the collect the z-stack imaging data. The z-position fitted by uiPSF is linearly related to the z-position of the objective (c), while there is a discontinuity at -300 nm for INSPR (d), indicating the mismatch of the INSPR PSF model.</p></caption><graphic xlink:href="EMS190232-f010"/></fig><fig id="F11" position="anchor"><label>ED Fig 7</label><caption><title>Comparison of pupil-image and Zernike-based <italic>in situ</italic> PSF estimation of Tetrapod blinking patterns generated from a phase plate.</title><p id="P74">(a) Comparison of estimated PSF and pupil from bead data and single molecule blinking patterns. The phase patten generated from a phase plate is more complex than the ones from a deformable mirror, both the pupil-imaged based and Zernike-based modelling methods can retrieve the pupil function from single molecule blinking data. However, the Zernike-based method requires accurate initial values of the Zernike coefficients, otherwise, it fails to retrieve the accurate pupil. (b,c) Estimated Zernike coefficients from Zernike-based <italic>in situ</italic> PSF modelling with (b) or without (c) accurate initial values of the Zernike coefficients. (d) Example raw camera frame used for <italic>in situ</italic> PSF learning. Scale bar, 1 µm (a), 10 µm (d).</p></caption><graphic xlink:href="EMS190232-f011"/></fig><fig id="F12" position="anchor"><label>ED Fig. 8</label><caption><title>Validation of <italic>in situ</italic> PSF modelling for imaging a thick sample.</title><p id="P75">Imaging of Nup96-SNAP-AF647 in U2OS cells was performed using an oil immersion objective lens (NA=1.5) on a single-channel SMLM system equipped with a DM. (a) A sandwiched sample of U2OS cells was prepared for an imaging depth of 25 µm. (b) Top view of the reconstructed Nup96 using the <italic>in situ</italic> PSF model. (c) Enlarged XY view of the selected region in (b). (d) XZ view of the selected region in (c) reconstructed from bead and <italic>in situ</italic> PSF models, respectively. Scale bars, 2 µm (b), 1 µm (c), and 0.5µm (d).</p></caption><graphic xlink:href="EMS190232-f012"/></fig><fig id="F13" position="anchor"><label>ED Fig. 9</label><caption><title>Application of uiPSF for aberration correction using a deformable mirror.</title><p id="P76">(a) Top view of the reconstructed Nup96 using the <italic>in situ</italic> PSF model with and without uiPSF guided aberration correction by AO. (b) Zernike aberrations calculated from single molecule data using uiPSF with and without AO correction. (c-d) XZ view of the selected region in (a) for samples with and without AO correction. After uiPSF guided aberration correction, the reconstructed image quality improved significantly as demonstrated by the resolved double ring structure. Scale bars, 1 µm (a), 500 nm (c-d).</p></caption><graphic xlink:href="EMS190232-f013"/></fig></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary File</label><media xlink:href="EMS190232-supplement-Supplementary_File.pdf" mimetype="application" mime-subtype="pdf" id="d76aAdFbB" position="anchor"/></supplementary-material></sec></body><back><ack id="S42"><title>Acknowledgements</title><p>We thank Y.E. Katrukha and L.C. Kapitein from Utrecht University, Netherlands; B. Hajj and L. Regnier from Institut Curie, France; K.J.A. Martens from Bonn University, Germany; A. Tschanz from European Molecular Biology Laboratory, Germany; S. Khan and S. Pani from the University of New Mexico, USA; Y. Li from Purdue University, USA for testing the software. We thank X. Liu from the University of Hong Kong for valuable suggestions on inverse modelling. This work was supported by the European Research Council (grant no. ERC CoG724489 to J.R.) and the European Molecular Biology Laboratory. This work was conducted with support from the University of New Mexico Office of the Vice President for Research Program for Enhancing Research Capacity. This research was supported by grants from NVIDIA and utilized an NVIDIA A6000 GPU. S.L. was supported by EMBL ARISE fellowship no. 945405. S.L. and K.A.L. were supported by NIH Grant 1R01GM140284. Y.L. was supported by National Natural Science Foundation of China (62375116); Key Technology Research and Development Program of Shandong (2021CXGC010212); Shenzhen Science and Technology Innovation Commission (Grant No. JCYJ20220818100416036 and KQTD20200820113012029); Guangdong Provincial Key Laboratory of Advanced Biomaterials (2022B1212010003); Startup grant from Southern University of Science and Technology. L.-R.M. was supported by the German Federal Ministry of Education and Research (BMBF; project SIMALESAM, FKZ 01|S21055A-B). R.H. was supported by the German research foundation (Deutsche Forschungsgemeinschaft, DFG, project TR 1278, TP C04, 316213987). C.K. was supported by the German research foundation (Deutsche Forschungsgemeinschaft, DFG, project SFB TR166 “Receptorlight”, TP B05). This project has received funding from the European Union’s Horizon 2020 research and innovation program under grant agreement No. 802567-ERC-Five-Dimensional Localization Microscopy for Sub-Cellular Dynamics (to Y.S), and from the ISRAEL SCIENCE FOUNDATION (grant No. 450/18 to Y.S). Y.S. was supported by the Zuckerman Foundation.</p></ack><sec id="S43" sec-type="data-availability"><title>Data availability</title><p id="P77">Example data for uiPSF is available at <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/records/10027718">https://zenodo.org/records/10027718</ext-link>.</p></sec><sec id="S44" sec-type="data-availability"><title>Code availability</title><p id="P78">uiPSF is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/ries-lab/uiPSF">https://github.com/ries-lab/uiPSF</ext-link>.</p></sec><fn-group><fn fn-type="con" id="FN2"><p id="P79"><bold>Contributions</bold></p><p id="P80">J.R., Y.L., R.H. and Y.S. conceived the project. J.R., Y.L., and K.A.L. provided supervision. S.L., J.H., J.C., C.K. and L.-R.M. wrote the software. S.L. and J.C. analyzed the data. S.L., J.C., J.R., B.F. and D.X. acquired the data. S.L., J.C., Y.L. and J.R. wrote the paper with input from all authors.</p></fn></fn-group><ref-list><ref id="R1"><label>1</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Theer</surname><given-names>P</given-names></name><name><surname>Mongis</surname><given-names>C</given-names></name><name><surname>Knop</surname><given-names>M</given-names></name></person-group><article-title>PSFj: know your fluorescence microscope</article-title><source>Nat Methods</source><year>2014</year><volume>11</volume><fpage>981</fpage><lpage>982</lpage><pub-id pub-id-type="pmid">25264772</pub-id></element-citation></ref><ref id="R2"><label>2</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Faklaris</surname><given-names>O</given-names></name><etal/></person-group><article-title>Quality assessment in light microscopy for routine use through simple tools and robust metrics</article-title><source>J Cell Biol</source><year>2022</year><volume>221</volume><elocation-id>e202107093</elocation-id><pub-id pub-id-type="pmcid">PMC9526251</pub-id><pub-id pub-id-type="pmid">36173380</pub-id><pub-id pub-id-type="doi">10.1083/jcb.202107093</pub-id></element-citation></ref><ref id="R3"><label>3</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nelson</surname><given-names>G</given-names></name><etal/></person-group><article-title>Monitoring the point spread function for quality control of confocal microscopes</article-title><source>protocols.io</source><year>2022</year><pub-id pub-id-type="doi">10.17504/protocols.io.bp2l61ww1vqe/v1</pub-id></element-citation></ref><ref id="R4"><label>4</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Qiao</surname><given-names>C</given-names></name><etal/></person-group><article-title>Zero-shot learning enables instant denoising and super-resolution in optical fluorescence microscopy</article-title><source>bioRxiv</source><year>2023</year><pub-id pub-id-type="doi">10.1101/2023.02.24.529803</pub-id></element-citation></ref><ref id="R5"><label>5</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Guo</surname><given-names>M</given-names></name><etal/></person-group><article-title>Rapid image deconvolution and multiview fusion for optical microscopy</article-title><source>Nat Biotechnol</source><year>2020</year><volume>38</volume><fpage>1337</fpage><lpage>1346</lpage><pub-id pub-id-type="pmcid">PMC7642198</pub-id><pub-id pub-id-type="pmid">32601431</pub-id><pub-id pub-id-type="doi">10.1038/s41587-020-0560-x</pub-id></element-citation></ref><ref id="R6"><label>6</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>Y</given-names></name><name><surname>Wu</surname><given-names>Y-L</given-names></name><name><surname>Hoess</surname><given-names>P</given-names></name><name><surname>Mund</surname><given-names>M</given-names></name><name><surname>Ries</surname><given-names>J</given-names></name></person-group><article-title>Depth-dependent PSF calibration and aberration correction for 3D single-molecule localization</article-title><source>Biomed Opt Express</source><year>2019</year><volume>10</volume><elocation-id>2708</elocation-id><pub-id pub-id-type="pmcid">PMC6583355</pub-id><pub-id pub-id-type="pmid">31259045</pub-id><pub-id pub-id-type="doi">10.1364/BOE.10.002708</pub-id></element-citation></ref><ref id="R7"><label>7</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hulleman</surname><given-names>CN</given-names></name><etal/></person-group><article-title>Simultaneous orientation and 3D localization microscopy with a Vortex point spread function</article-title><source>Nat Commun</source><year>2021</year><volume>12</volume><elocation-id>5934</elocation-id><pub-id pub-id-type="pmcid">PMC8505439</pub-id><pub-id pub-id-type="pmid">34635658</pub-id><pub-id pub-id-type="doi">10.1038/s41467-021-26228-5</pub-id></element-citation></ref><ref id="R8"><label>8</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>O</given-names></name><etal/></person-group><article-title>Six-dimensional single-molecule imaging with isotropic resolution using a multi-view reflector microscope</article-title><source>Nat Photonics</source><year>2023</year><volume>17</volume><fpage>179</fpage><lpage>186</lpage><pub-id pub-id-type="pmcid">PMC10035538</pub-id><pub-id pub-id-type="pmid">36968242</pub-id><pub-id pub-id-type="doi">10.1038/s41566-022-01116-6</pub-id></element-citation></ref><ref id="R9"><label>9</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tsang</surname><given-names>M</given-names></name><name><surname>Nair</surname><given-names>R</given-names></name><name><surname>Lu</surname><given-names>X-M</given-names></name></person-group><article-title>Quantum Theory of Superresolution for Two Incoherent Optical Point Sources</article-title><source>Phys Rev X</source><year>2016</year><volume>6</volume><elocation-id>031033</elocation-id></element-citation></ref><ref id="R10"><label>10</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shechtman</surname><given-names>Y</given-names></name><name><surname>Weiss</surname><given-names>LE</given-names></name><name><surname>Backer</surname><given-names>AS</given-names></name><name><surname>Lee</surname><given-names>MY</given-names></name><name><surname>Moerner</surname><given-names>WE</given-names></name></person-group><article-title>Multicolour localization microscopy by point-spread-function engineering</article-title><source>Nat Photonics</source><year>2016</year><volume>10</volume><fpage>590</fpage><lpage>594</lpage><pub-id pub-id-type="pmcid">PMC5391844</pub-id><pub-id pub-id-type="pmid">28413434</pub-id><pub-id pub-id-type="doi">10.1038/nphoton.2016.137</pub-id></element-citation></ref><ref id="R11"><label>11</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lelek</surname><given-names>M</given-names></name><etal/></person-group><article-title>Single-molecule localization microscopy</article-title><source>Nat Rev Methods Primer</source><year>2021</year><volume>1</volume><fpage>39</fpage><pub-id pub-id-type="pmcid">PMC9160414</pub-id><pub-id pub-id-type="pmid">35663461</pub-id><pub-id pub-id-type="doi">10.1038/s43586-021-00038-x</pub-id></element-citation></ref><ref id="R12"><label>12</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Huang</surname><given-names>B</given-names></name><name><surname>Wang</surname><given-names>W</given-names></name><name><surname>Bates</surname><given-names>M</given-names></name><name><surname>Zhuang</surname><given-names>X</given-names></name></person-group><article-title>Three-Dimensional Super-Resolution Imaging by Stochastic Optical Reconstruction Microscopy</article-title><source>Science</source><year>2008</year><volume>319</volume><fpage>810</fpage><lpage>813</lpage><pub-id pub-id-type="pmcid">PMC2633023</pub-id><pub-id pub-id-type="pmid">18174397</pub-id><pub-id pub-id-type="doi">10.1126/science.1153529</pub-id></element-citation></ref><ref id="R13"><label>13</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pavani</surname><given-names>SRP</given-names></name><etal/></person-group><article-title>Three-dimensional, single-molecule fluorescence imaging beyond the diffraction limit by using a double-helix point spread function</article-title><source>Proc Natl Acad Sci</source><year>2009</year><volume>106</volume><fpage>2995</fpage><lpage>2999</lpage><pub-id pub-id-type="pmcid">PMC2651341</pub-id><pub-id pub-id-type="pmid">19211795</pub-id><pub-id pub-id-type="doi">10.1073/pnas.0900245106</pub-id></element-citation></ref><ref id="R14"><label>14</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shechtman</surname><given-names>Y</given-names></name><name><surname>Sahl</surname><given-names>SJ</given-names></name><name><surname>Backer</surname><given-names>AS</given-names></name><name><surname>Moerner</surname><given-names>WE</given-names></name></person-group><article-title>Optimal Point Spread Function Design for 3D Imaging</article-title><source>Phys Rev Lett</source><year>2014</year><volume>113</volume><elocation-id>133902</elocation-id><pub-id pub-id-type="pmcid">PMC4381866</pub-id><pub-id pub-id-type="pmid">25302889</pub-id><pub-id pub-id-type="doi">10.1103/PhysRevLett.113.133902</pub-id></element-citation></ref><ref id="R15"><label>15</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Juette</surname><given-names>MF</given-names></name><etal/></person-group><article-title>Three-dimensional sub–100 nm resolution fluorescence microscopy of thick samples</article-title><source>Nat Methods</source><year>2008</year><volume>5</volume><fpage>527</fpage><lpage>529</lpage><pub-id pub-id-type="pmid">18469823</pub-id></element-citation></ref><ref id="R16"><label>16</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ram</surname><given-names>S</given-names></name><name><surname>Prabhat</surname><given-names>P</given-names></name><name><surname>Chao</surname><given-names>J</given-names></name><name><surname>Sally Ward</surname><given-names>E</given-names></name><name><surname>Ober</surname><given-names>RJ</given-names></name></person-group><article-title>High Accuracy 3D Quantum Dot Tracking with Multifocal Plane Microscopy for the Study of Fast Intracellular Dynamics in Live Cells</article-title><source>Biophys J</source><year>2008</year><volume>95</volume><fpage>6025</fpage><lpage>6043</lpage><pub-id pub-id-type="pmcid">PMC2599831</pub-id><pub-id pub-id-type="pmid">18835896</pub-id><pub-id pub-id-type="doi">10.1529/biophysj.108.140392</pub-id></element-citation></ref><ref id="R17"><label>17</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Legant</surname><given-names>WR</given-names></name><etal/></person-group><article-title>High-density three-dimensional localization microscopy across large volumes</article-title><source>Nat Methods</source><year>2016</year><volume>13</volume><fpage>359</fpage><lpage>365</lpage><pub-id pub-id-type="pmcid">PMC4889433</pub-id><pub-id pub-id-type="pmid">26950745</pub-id><pub-id pub-id-type="doi">10.1038/nmeth.3797</pub-id></element-citation></ref><ref id="R18"><label>18</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shtengel</surname><given-names>G</given-names></name><etal/></person-group><article-title>Interferometric fluorescent super-resolution microscopy resolves 3D cellular ultrastructure</article-title><source>Proc Natl Acad Sci</source><year>2009</year><volume>106</volume><fpage>3125</fpage><lpage>3130</lpage><pub-id pub-id-type="pmcid">PMC2637278</pub-id><pub-id pub-id-type="pmid">19202073</pub-id><pub-id pub-id-type="doi">10.1073/pnas.0813131106</pub-id></element-citation></ref><ref id="R19"><label>19</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Aquino</surname><given-names>D</given-names></name><etal/></person-group><article-title>Two-color nanoscopy of three-dimensional volumes by 4Pi detection of stochastically switched fluorophores</article-title><source>Nat Methods</source><year>2011</year><volume>8</volume><fpage>353</fpage><lpage>359</lpage><pub-id pub-id-type="pmid">21399636</pub-id></element-citation></ref><ref id="R20"><label>20</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Smith</surname><given-names>CS</given-names></name><name><surname>Joseph</surname><given-names>N</given-names></name><name><surname>Rieger</surname><given-names>B</given-names></name><name><surname>Lidke</surname><given-names>KA</given-names></name></person-group><article-title>Fast, single-molecule localization that achieves theoretically minimum uncertainty</article-title><source>Nat Methods</source><year>2010</year><volume>7</volume><fpage>373</fpage><lpage>375</lpage><pub-id pub-id-type="pmcid">PMC2862147</pub-id><pub-id pub-id-type="pmid">20364146</pub-id><pub-id pub-id-type="doi">10.1038/nmeth.1449</pub-id></element-citation></ref><ref id="R21"><label>21</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mlodzianoski</surname><given-names>MJ</given-names></name><name><surname>Juette</surname><given-names>MF</given-names></name><name><surname>Beane</surname><given-names>GL</given-names></name><name><surname>Bewersdorf</surname><given-names>J</given-names></name></person-group><article-title>Experimental characterization of 3D localization techniques for particle-tracking and super-resolution microscopy</article-title><source>Opt Express</source><year>2009</year><volume>17</volume><elocation-id>8264</elocation-id><pub-id pub-id-type="pmid">19434159</pub-id></element-citation></ref><ref id="R22"><label>22</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Babcock</surname><given-names>HP</given-names></name><name><surname>Zhuang</surname><given-names>X</given-names></name></person-group><article-title>Analyzing Single Molecule Localization Microscopy Data Using Cubic Splines</article-title><source>Sci Rep</source><year>2017</year><volume>7</volume><fpage>552</fpage><pub-id pub-id-type="pmcid">PMC5428856</pub-id><pub-id pub-id-type="pmid">28373678</pub-id><pub-id pub-id-type="doi">10.1038/s41598-017-00622-w</pub-id></element-citation></ref><ref id="R23"><label>23</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Real-time 3D single-molecule localization using experimental point spread functions</article-title><source>Nat Methods</source><year>2018</year><volume>15</volume><fpage>367</fpage><lpage>369</lpage><pub-id pub-id-type="pmcid">PMC6009849</pub-id><pub-id pub-id-type="pmid">29630062</pub-id><pub-id pub-id-type="doi">10.1038/nmeth.4661</pub-id></element-citation></ref><ref id="R24"><label>24</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bates</surname><given-names>M</given-names></name><etal/></person-group><article-title>Optimal precision and accuracy in 4Pi-STORM using dynamic spline PSF models</article-title><source>Nat Methods</source><year>2022</year><volume>19</volume><fpage>603</fpage><lpage>612</lpage><pub-id pub-id-type="pmcid">PMC9119851</pub-id><pub-id pub-id-type="pmid">35577958</pub-id><pub-id pub-id-type="doi">10.1038/s41592-022-01465-8</pub-id></element-citation></ref><ref id="R25"><label>25</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Accurate 4Pi single-molecule localization using an experimental PSF model</article-title><source>Opt Lett</source><year>2020</year><volume>45</volume><elocation-id>3765</elocation-id><pub-id pub-id-type="pmid">32630949</pub-id></element-citation></ref><ref id="R26"><label>26</label><element-citation publication-type="other"><person-group person-group-type="author"><name><surname>Goodman</surname><given-names>JW</given-names></name></person-group><source>Introduction to Fourier optics</source><year>2005</year></element-citation></ref><ref id="R27"><label>27</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolf</surname><given-names>E</given-names></name></person-group><article-title>Electromagnetic diffraction in optical systems - I. An integral representation of the image field</article-title><source>Proc R Soc Lond Ser Math Phys Sci</source><year>1959</year><volume>253</volume><fpage>349</fpage><lpage>357</lpage></element-citation></ref><ref id="R28"><label>28</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Siemons</surname><given-names>M</given-names></name><name><surname>Hulleman</surname><given-names>CN</given-names></name><name><surname>Thorsen</surname><given-names>RØ</given-names></name><name><surname>Smith</surname><given-names>CS</given-names></name><name><surname>Stallinga</surname><given-names>S</given-names></name></person-group><article-title>High precision wavefront control in point spread function engineering for single emitter localization</article-title><source>Opt Express</source><year>2018</year><volume>26</volume><elocation-id>8397</elocation-id><pub-id pub-id-type="pmid">29715807</pub-id></element-citation></ref><ref id="R29"><label>29</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Noll</surname><given-names>RJ</given-names></name></person-group><article-title>Zernike polynomials and atmospheric turbulence*</article-title><source>J Opt Soc Am</source><year>1976</year><volume>66</volume><fpage>207</fpage></element-citation></ref><ref id="R30"><label>30</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Niu</surname><given-names>K</given-names></name><name><surname>Tian</surname><given-names>C</given-names></name></person-group><article-title>Zernike polynomials and their applications</article-title><source>J Opt</source><year>2022</year><volume>24</volume><elocation-id>123001</elocation-id></element-citation></ref><ref id="R31"><label>31</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hanser</surname><given-names>BM</given-names></name><name><surname>Gustafsson</surname><given-names>MGL</given-names></name><name><surname>Agard</surname><given-names>DA</given-names></name><name><surname>Sedat</surname><given-names>JW</given-names></name></person-group><article-title>Phase-retrieved pupil functions in wide-field fluorescence microscopy</article-title><source>J Microsc</source><year>2004</year><volume>216</volume><fpage>32</fpage><lpage>48</lpage><pub-id pub-id-type="pmid">15369481</pub-id></element-citation></ref><ref id="R32"><label>32</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>S</given-names></name><name><surname>Kromann</surname><given-names>EB</given-names></name><name><surname>Krueger</surname><given-names>WD</given-names></name><name><surname>Bewersdorf</surname><given-names>J</given-names></name><name><surname>Lidke</surname><given-names>KA</given-names></name></person-group><article-title>Three dimensional single molecule localization using a phase retrieved pupil function</article-title><source>Opt Express</source><year>2013</year><volume>21</volume><elocation-id>29462</elocation-id><pub-id pub-id-type="pmcid">PMC3867195</pub-id><pub-id pub-id-type="pmid">24514501</pub-id><pub-id pub-id-type="doi">10.1364/OE.21.029462</pub-id></element-citation></ref><ref id="R33"><label>33</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McGorty</surname><given-names>R</given-names></name><name><surname>Schnitzbauer</surname><given-names>J</given-names></name><name><surname>Zhang</surname><given-names>W</given-names></name><name><surname>Huang</surname><given-names>B</given-names></name></person-group><article-title>Correction of depth-dependent aberrations in 3D single-molecule localization and super-resolution microscopy</article-title><source>Opt Lett</source><year>2014</year><volume>39</volume><fpage>275</fpage><pub-id pub-id-type="pmcid">PMC4030053</pub-id><pub-id pub-id-type="pmid">24562125</pub-id><pub-id pub-id-type="doi">10.1364/OL.39.000275</pub-id></element-citation></ref><ref id="R34"><label>34</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Aristov</surname><given-names>A</given-names></name><name><surname>Lelandais</surname><given-names>B</given-names></name><name><surname>Rensen</surname><given-names>E</given-names></name><name><surname>Zimmer</surname><given-names>C</given-names></name></person-group><article-title>ZOLA-3D allows flexible 3D localization microscopy over an adjustable axial range</article-title><source>Nat Commun</source><year>2018</year><volume>9</volume><elocation-id>2409</elocation-id><pub-id pub-id-type="pmcid">PMC6008307</pub-id><pub-id pub-id-type="pmid">29921892</pub-id><pub-id pub-id-type="doi">10.1038/s41467-018-04709-4</pub-id></element-citation></ref><ref id="R35"><label>35</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Petrov</surname><given-names>PN</given-names></name><name><surname>Shechtman</surname><given-names>Y</given-names></name><name><surname>Moerner</surname><given-names>WE</given-names></name></person-group><article-title>Measurement-based estimation of global pupil functions in 3D localization microscopy</article-title><source>Opt Express</source><year>2017</year><volume>25</volume><elocation-id>7945</elocation-id><pub-id pub-id-type="pmcid">PMC5810908</pub-id><pub-id pub-id-type="pmid">28380911</pub-id><pub-id pub-id-type="doi">10.1364/OE.25.007945</pub-id></element-citation></ref><ref id="R36"><label>36</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ferdman</surname><given-names>B</given-names></name><etal/></person-group><article-title>VIPR: vectorial implementation of phase retrieval for fast and accurate microscopic pixel-wise pupil estimation</article-title><source>Opt Express</source><year>2020</year><volume>28</volume><elocation-id>10179</elocation-id><pub-id pub-id-type="pmid">32225609</pub-id></element-citation></ref><ref id="R37"><label>37</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ferdman</surname><given-names>B</given-names></name><name><surname>Saguy</surname><given-names>A</given-names></name><name><surname>Xiao</surname><given-names>D</given-names></name><name><surname>Shechtman</surname><given-names>Y</given-names></name></person-group><article-title>Diffractive optical system design by cascaded propagation</article-title><source>Opt Express</source><year>2022</year><volume>30</volume><elocation-id>27509</elocation-id><pub-id pub-id-type="pmid">36236921</pub-id></element-citation></ref><ref id="R38"><label>38</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>P</given-names></name><etal/></person-group><article-title>Analyzing complex single-molecule emission patterns with deep learning</article-title><source>Nat Methods</source><year>2018</year><volume>15</volume><fpage>913</fpage><lpage>916</lpage><pub-id pub-id-type="pmcid">PMC6624853</pub-id><pub-id pub-id-type="pmid">30377349</pub-id><pub-id pub-id-type="doi">10.1038/s41592-018-0153-5</pub-id></element-citation></ref><ref id="R39"><label>39</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Möckl</surname><given-names>L</given-names></name><name><surname>Petrov</surname><given-names>PN</given-names></name><name><surname>Moerner</surname><given-names>WE</given-names></name></person-group><article-title>Accurate phase retrieval of complex 3D point spread functions with deep residual neural networks</article-title><source>Appl Phys Lett</source><year>2019</year><volume>115</volume><elocation-id>251106</elocation-id><pub-id pub-id-type="pmcid">PMC7043838</pub-id><pub-id pub-id-type="pmid">32127719</pub-id><pub-id pub-id-type="doi">10.1063/1.5125252</pub-id></element-citation></ref><ref id="R40"><label>40</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cumming</surname><given-names>BP</given-names></name><name><surname>Gu</surname><given-names>M</given-names></name></person-group><article-title>Direct determination of aberration functions in microscopy by an artificial neural network</article-title><source>Opt Express</source><year>2020</year><volume>28</volume><elocation-id>14511</elocation-id><pub-id pub-id-type="pmid">32403490</pub-id></element-citation></ref><ref id="R41"><label>41</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname><given-names>F</given-names></name><etal/></person-group><article-title>Three-dimensional nanoscopy of whole cells and tissues with in situ point spread function retrieval</article-title><source>Nat Methods</source><year>2020</year><volume>17</volume><fpage>531</fpage><lpage>540</lpage><pub-id pub-id-type="pmcid">PMC7289454</pub-id><pub-id pub-id-type="pmid">32371980</pub-id><pub-id pub-id-type="doi">10.1038/s41592-020-0816-x</pub-id></element-citation></ref><ref id="R42"><label>42</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fu</surname><given-names>S</given-names></name><etal/></person-group><article-title>Field-dependent deep learning enables high-throughput whole-cell 3D super-resolution imaging</article-title><source>Nat Methods</source><year>2023</year><volume>20</volume><fpage>459</fpage><lpage>468</lpage><pub-id pub-id-type="pmid">36823335</pub-id></element-citation></ref><ref id="R43"><label>43</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>DC</given-names></name><name><surname>Nocedal</surname><given-names>J</given-names></name></person-group><article-title>On the limited memory BFGS method for large scale optimization</article-title><source>Math Program</source><year>1989</year><volume>45</volume><fpage>503</fpage><lpage>528</lpage></element-citation></ref><ref id="R44"><label>44</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Thevathasan</surname><given-names>JV</given-names></name><etal/></person-group><article-title>Nuclear pores as versatile reference standards for quantitative superresolution microscopy</article-title><source>Nat Methods</source><year>2019</year><volume>16</volume><fpage>1045</fpage><lpage>1053</lpage><pub-id pub-id-type="pmcid">PMC6768092</pub-id><pub-id pub-id-type="pmid">31562488</pub-id><pub-id pub-id-type="doi">10.1038/s41592-019-0574-9</pub-id></element-citation></ref><ref id="R45"><label>45</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Axelrod</surname><given-names>D</given-names></name></person-group><article-title>Fluorescence excitation and imaging of single molecules near dielectric-coated and bare surfaces: a theoretical study</article-title><source>J Microsc</source><year>2012</year><volume>247</volume><fpage>147</fpage><lpage>160</lpage><pub-id pub-id-type="pmid">22612666</pub-id></element-citation></ref><ref id="R46"><label>46</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Vahid</surname><given-names>MR</given-names></name><name><surname>Hanzon</surname><given-names>B</given-names></name><name><surname>Ober</surname><given-names>RJ</given-names></name></person-group><article-title>Effect of Pixelation on the Parameter Estimation of Single Molecule Trajectories</article-title><source>IEEE Trans Comput Imaging</source><year>2021</year><volume>7</volume><fpage>98</fpage><lpage>113</lpage><pub-id pub-id-type="pmcid">PMC7879562</pub-id><pub-id pub-id-type="pmid">33604418</pub-id><pub-id pub-id-type="doi">10.1109/TCI.2020.3039951</pub-id></element-citation></ref><ref id="R47"><label>47</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Deschamps</surname><given-names>J</given-names></name><name><surname>Rowald</surname><given-names>A</given-names></name><name><surname>Ries</surname><given-names>J</given-names></name></person-group><article-title>Efficient homogeneous illumination and optical sectioning for quantitative single-molecule localization microscopy</article-title><source>Opt Express</source><year>2016</year><volume>24</volume><elocation-id>28080</elocation-id><pub-id pub-id-type="pmid">27906373</pub-id></element-citation></ref><ref id="R48"><label>48</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>B-C</given-names></name><etal/></person-group><article-title>Lattice light-sheet microscopy: Imaging molecules to embryos at high spatiotemporal resolution</article-title><source>Science</source><year>2014</year><volume>346</volume><elocation-id>1257998</elocation-id><pub-id pub-id-type="pmcid">PMC4336192</pub-id><pub-id pub-id-type="pmid">25342811</pub-id><pub-id pub-id-type="doi">10.1126/science.1257998</pub-id></element-citation></ref><ref id="R49"><label>49</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sapoznik</surname><given-names>E</given-names></name><etal/></person-group><article-title>A versatile oblique plane microscope for large-scale and high-resolution imaging of subcellular dynamics</article-title><source>eLife</source><year>2020</year><volume>9</volume><elocation-id>e57681</elocation-id><pub-id pub-id-type="pmcid">PMC7707824</pub-id><pub-id pub-id-type="pmid">33179596</pub-id><pub-id pub-id-type="doi">10.7554/eLife.57681</pub-id></element-citation></ref><ref id="R50"><label>50</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yang</surname><given-names>B</given-names></name><etal/></person-group><article-title>DaXi—high-resolution, large imaging volume and multi-view single-objective light-sheet microscopy</article-title><source>Nat Methods</source><year>2022</year><volume>19</volume><fpage>461</fpage><lpage>469</lpage><pub-id pub-id-type="pmcid">PMC9007742</pub-id><pub-id pub-id-type="pmid">35314838</pub-id><pub-id pub-id-type="doi">10.1038/s41592-022-01417-2</pub-id></element-citation></ref><ref id="R51"><label>51</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Quirin</surname><given-names>S</given-names></name><name><surname>Pavani</surname><given-names>SRP</given-names></name><name><surname>Piestun</surname><given-names>R</given-names></name></person-group><article-title>Optimal 3D single-molecule localization for superresolution microscopy with aberrations and engineered point spread functions</article-title><source>Proc Natl Acad Sci</source><year>2012</year><volume>109</volume><fpage>675</fpage><lpage>679</lpage><pub-id pub-id-type="pmcid">PMC3271897</pub-id><pub-id pub-id-type="pmid">22210112</pub-id><pub-id pub-id-type="doi">10.1073/pnas.1109011108</pub-id></element-citation></ref><ref id="R52"><label>52</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bossi</surname><given-names>M</given-names></name><etal/></person-group><article-title>Multicolor Far-Field Fluorescence Nanoscopy through Isolated Detection of Distinct Molecular Species</article-title><source>Nano Lett</source><year>2008</year><volume>8</volume><fpage>2463</fpage><lpage>2468</lpage><pub-id pub-id-type="pmid">18642961</pub-id></element-citation></ref><ref id="R53"><label>53</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Testa</surname><given-names>I</given-names></name><etal/></person-group><article-title>Multicolor Fluorescence Nanoscopy in Fixed and Living Cells by Exciting Conventional Fluorophores with a Single Wavelength</article-title><source>Biophys J</source><year>2010</year><volume>99</volume><fpage>2686</fpage><lpage>2694</lpage><pub-id pub-id-type="pmcid">PMC2956215</pub-id><pub-id pub-id-type="pmid">20959110</pub-id><pub-id pub-id-type="doi">10.1016/j.bpj.2010.08.012</pub-id></element-citation></ref><ref id="R54"><label>54</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gahlmann</surname><given-names>A</given-names></name><etal/></person-group><article-title>Quantitative Multicolor Subdiffraction Imaging of Bacterial Protein Ultrastructures in Three Dimensions</article-title><source>Nano Lett</source><year>2013</year><volume>13</volume><fpage>987</fpage><lpage>993</lpage><pub-id pub-id-type="pmcid">PMC3599789</pub-id><pub-id pub-id-type="pmid">23414562</pub-id><pub-id pub-id-type="doi">10.1021/nl304071h</pub-id></element-citation></ref><ref id="R55"><label>55</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Backlund</surname><given-names>MP</given-names></name><name><surname>Joyner</surname><given-names>R</given-names></name><name><surname>Weis</surname><given-names>K</given-names></name><name><surname>Moerner</surname><given-names>WE</given-names></name></person-group><article-title>Correlations of three-dimensional motion of chromosomal loci in yeast revealed by the double-helix point spread function microscope</article-title><source>Mol Biol Cell</source><year>2014</year><volume>25</volume><fpage>3619</fpage><lpage>3629</lpage><pub-id pub-id-type="pmcid">PMC4230621</pub-id><pub-id pub-id-type="pmid">25318676</pub-id><pub-id pub-id-type="doi">10.1091/mbc.E14-06-1127</pub-id></element-citation></ref><ref id="R56"><label>56</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nehme</surname><given-names>E</given-names></name><etal/></person-group><article-title>Learning Optimal Wavefront Shaping for Multi-Channel Imaging</article-title><source>IEEE Trans Pattern Anal Mach Intell</source><year>2021</year><volume>43</volume><fpage>2179</fpage><lpage>2192</lpage><pub-id pub-id-type="pmid">34029185</pub-id></element-citation></ref><ref id="R57"><label>57</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Backlund</surname><given-names>MP</given-names></name><name><surname>Lew</surname><given-names>MD</given-names></name><name><surname>Backer</surname><given-names>AS</given-names></name><name><surname>Sahl</surname><given-names>SJ</given-names></name><name><surname>Moerner</surname><given-names>WE</given-names></name></person-group><article-title>The Role of Molecular Dipole Orientation in Single-Molecule Fluorescence Microscopy and Implications for Super-Resolution Imaging</article-title><source>ChemPhysChem</source><year>2014</year><volume>15</volume><fpage>587</fpage><lpage>599</lpage><pub-id pub-id-type="pmcid">PMC3992256</pub-id><pub-id pub-id-type="pmid">24382708</pub-id><pub-id pub-id-type="doi">10.1002/cphc.201300880</pub-id></element-citation></ref><ref id="R58"><label>58</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Global fitting for high-accuracy multi-channel single-molecule localization</article-title><source>Nat Commun</source><year>2022</year><volume>13</volume><elocation-id>3133</elocation-id><pub-id pub-id-type="pmcid">PMC9170706</pub-id><pub-id pub-id-type="pmid">35668089</pub-id><pub-id pub-id-type="doi">10.1038/s41467-022-30719-4</pub-id></element-citation></ref><ref id="R59"><label>59</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Huang</surname><given-names>F</given-names></name><etal/></person-group><article-title>Ultra-High Resolution 3D Imaging of Whole Cells</article-title><source>Cell</source><year>2016</year><volume>166</volume><fpage>1028</fpage><lpage>1040</lpage><pub-id pub-id-type="pmcid">PMC5005454</pub-id><pub-id pub-id-type="pmid">27397506</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2016.06.016</pub-id></element-citation></ref><ref id="R60"><label>60</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>S</given-names></name><name><surname>Hoess</surname><given-names>P</given-names></name><name><surname>Ries</surname><given-names>J</given-names></name></person-group><article-title>Super-Resolution Microscopy for Structural Cell Biology</article-title><source>Annu Rev Biophys</source><year>2022</year><volume>51</volume><fpage>301</fpage><lpage>326</lpage><pub-id pub-id-type="pmid">35119945</pub-id></element-citation></ref><ref id="R61"><label>61</label><element-citation publication-type="journal"><article-title>LocMoFit quantifies cellular structures in super-resolution data</article-title><source>Nat Methods</source><year>2023</year><volume>20</volume><fpage>44</fpage><lpage>45</lpage><pub-id pub-id-type="pmid">36522504</pub-id></element-citation></ref><ref id="R62"><label>62</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Douglass</surname><given-names>KM</given-names></name><name><surname>Sieben</surname><given-names>C</given-names></name><name><surname>Archetti</surname><given-names>A</given-names></name><name><surname>Lambert</surname><given-names>A</given-names></name><name><surname>Manley</surname><given-names>S</given-names></name></person-group><article-title>Super-resolution imaging of multiple cells by optimized flat-field epi-illumination</article-title><source>Nat Photonics</source><year>2016</year><volume>10</volume><fpage>705</fpage><lpage>708</lpage><pub-id pub-id-type="pmcid">PMC5089541</pub-id><pub-id pub-id-type="pmid">27818707</pub-id><pub-id pub-id-type="doi">10.1038/nphoton.2016.200</pub-id></element-citation></ref><ref id="R63"><label>63</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yan</surname><given-names>R</given-names></name><name><surname>Moon</surname><given-names>S</given-names></name><name><surname>Kenny</surname><given-names>SJ</given-names></name><name><surname>Xu</surname><given-names>K</given-names></name></person-group><article-title>Spectrally Resolved and Functional Super-resolution Microscopy via Ultrahigh-Throughput Single-Molecule Spectroscopy</article-title><source>Acc Chem Res</source><year>2018</year><volume>51</volume><fpage>697</fpage><lpage>705</lpage><pub-id pub-id-type="pmid">29443498</pub-id></element-citation></ref><ref id="R64"><label>64</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mlodzianoski</surname><given-names>MJ</given-names></name><name><surname>Curthoys</surname><given-names>NM</given-names></name><name><surname>Gunewardene</surname><given-names>MS</given-names></name><name><surname>Carter</surname><given-names>S</given-names></name><name><surname>Hess</surname><given-names>ST</given-names></name></person-group><article-title>Super-Resolution Imaging of Molecular Emission Spectra and Single Molecule Spectral Fluctuations</article-title><source>PLOS ONE</source><year>2016</year><volume>11</volume><elocation-id>e0147506</elocation-id><pub-id pub-id-type="pmcid">PMC4803349</pub-id><pub-id pub-id-type="pmid">27002724</pub-id><pub-id pub-id-type="doi">10.1371/journal.pone.0147506</pub-id></element-citation></ref><ref id="R65"><label>65</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gu</surname><given-names>L</given-names></name><etal/></person-group><article-title>Molecular resolution imaging by repetitive optical selective exposure</article-title><source>Nat Methods</source><year>2019</year><volume>16</volume><fpage>1114</fpage><lpage>1118</lpage><pub-id pub-id-type="pmid">31501551</pub-id></element-citation></ref><ref id="R66"><label>66</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cnossen</surname><given-names>J</given-names></name><etal/></person-group><article-title>Localization microscopy at doubled precision with patterned illumination</article-title><source>Nat Methods</source><year>2020</year><volume>17</volume><fpage>59</fpage><lpage>63</lpage><pub-id pub-id-type="pmcid">PMC6989044</pub-id><pub-id pub-id-type="pmid">31819263</pub-id><pub-id pub-id-type="doi">10.1038/s41592-019-0657-7</pub-id></element-citation></ref><ref id="R67"><label>67</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jouchet</surname><given-names>P</given-names></name><etal/></person-group><article-title>Nanometric axial localization of single fluorescent molecules with modulated excitation</article-title><source>Nat Photonics</source><year>2021</year><volume>15</volume><fpage>297</fpage><lpage>304</lpage></element-citation></ref><ref id="R68"><label>68</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Balzarotti</surname><given-names>F</given-names></name><etal/></person-group><article-title>Nanometer resolution imaging and tracking of fluorescent molecules with minimal photon fluxes</article-title><source>Science</source><year>2017</year><volume>355</volume><fpage>606</fpage><lpage>612</lpage><pub-id pub-id-type="pmid">28008086</pub-id></element-citation></ref><ref id="R69"><label>69</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ries</surname><given-names>J</given-names></name></person-group><article-title>SMAP: a modular super-resolution microscopy analysis platform for SMLM data</article-title><source>Nat Methods</source><year>2020</year><volume>17</volume><fpage>870</fpage><lpage>872</lpage><pub-id pub-id-type="pmid">32814874</pub-id></element-citation></ref><ref id="R70"><label>70</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Speiser</surname><given-names>A</given-names></name><etal/></person-group><article-title>Deep learning enables fast and dense single-molecule localization with high accuracy</article-title><source>Nat Methods</source><year>2021</year><volume>18</volume><fpage>1082</fpage><lpage>1090</lpage><pub-id pub-id-type="pmcid">PMC7611669</pub-id><pub-id pub-id-type="pmid">34480155</pub-id><pub-id pub-id-type="doi">10.1038/s41592-021-01236-x</pub-id></element-citation></ref><ref id="R71"><label>71</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>J</given-names></name><etal/></person-group><article-title>Implementation of a 4Pi-SMS super-resolution microscope</article-title><source>Nat Protoc</source><year>2021</year><volume>16</volume><fpage>677</fpage><lpage>727</lpage><pub-id pub-id-type="pmcid">PMC9118368</pub-id><pub-id pub-id-type="pmid">33328610</pub-id><pub-id pub-id-type="doi">10.1038/s41596-020-00428-7</pub-id></element-citation></ref><ref id="R72"><label>72</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Deschamps</surname><given-names>J</given-names></name><name><surname>Ries</surname><given-names>J</given-names></name></person-group><article-title>EMU: reconfigurable graphical user interfaces for Micro-Manager</article-title><source>BMC Bioinformatics</source><year>2020</year><volume>21</volume><fpage>456</fpage><pub-id pub-id-type="pmcid">PMC7559757</pub-id><pub-id pub-id-type="pmid">33059591</pub-id><pub-id pub-id-type="doi">10.1186/s12859-020-03727-8</pub-id></element-citation></ref><ref id="R73"><label>73</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fu</surname><given-names>S</given-names></name><etal/></person-group><article-title>Deformable mirror based optimal PSF engineering for 3D super-resolution imaging</article-title><source>Opt Lett</source><year>2022</year><volume>47</volume><elocation-id>3031</elocation-id><pub-id pub-id-type="pmid">35709042</pub-id></element-citation></ref><ref id="R74"><label>74</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Antonello</surname><given-names>J</given-names></name><name><surname>Wang</surname><given-names>J</given-names></name><name><surname>He</surname><given-names>C</given-names></name><name><surname>Phillips</surname><given-names>M</given-names></name><name><surname>Booth</surname><given-names>M</given-names></name></person-group><source>Interferometric calibration of a deformable mirror</source><year>2020</year><pub-id pub-id-type="doi">10.5281/ZENODO.3714951</pub-id></element-citation></ref><ref id="R75"><label>75</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wu</surname><given-names>Y-L</given-names></name><etal/></person-group><article-title>Maximum-likelihood model fitting for quantitative analysis of SMLM data</article-title><source>Nat Methods</source><year>2023</year><volume>20</volume><fpage>139</fpage><lpage>148</lpage><pub-id pub-id-type="pmcid">PMC9834062</pub-id><pub-id pub-id-type="pmid">36522500</pub-id><pub-id pub-id-type="doi">10.1038/s41592-022-01676-z</pub-id></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Figure 1</label><caption><title>Concept and modalities of uiPSF.</title><p>(a) Inverse modelling concept of uiPSF. (b) PSF modelling methods in both the spatial and the Fourier domain. (c) Supported imaging and data modalities. (d) Example PSF modelling results from uiPSF and Gaussian approximation for a single-channel astigmatic imaging system. (e) Effect of bead size on modelling 4Pi-SMLM PSFs using the voxel-based PSF model. Scale bar, 1 µm (d,e).</p></caption><graphic xlink:href="EMS190232-f001"/></fig><fig id="F2" position="float"><label>Figure 2</label><caption><title>Application of uiPSF to multi-channel ratiometric dual-color SMLM and 4Pi-SMLM.</title><p>PSF models are estimated from bead data. (a, b) Estimated PSF model and the transformation for a dual-color system. (c, d) 3D dual-color SMLM imaging of NPC, where Nup96-SNAP is labeled with Alexa Fluor 647 and WGA is labeled with CF680. (e) Estimated IAB model for each channel of a 4Pi-SMLM system. (f) Example beads and corresponding forward models at various z and <italic>φ</italic> positions. (g) Estimated transformation of each target channel to the reference channel of a 4Pi-SMLM system. (h,i) 4Pi-SMLM imaging of Nup96-mMaple. Scale bars, 5 µm (b, g), 2 µm (h), 1 µm (a, c, e, f), 100 nm (d, i).</p></caption><graphic xlink:href="EMS190232-f002"/></fig><fig id="F3" position="float"><label>Figure 3</label><caption><title>Modelling PSFs <italic>in situ</italic> from single blinking fluorophores.</title><p>(a) uiPSF was used to determine a PSF model from single blinking fluorophores when specific Zernike aberrations were applied by a deformable mirror (DM) with a magnitude of −<italic>λ</italic>/2<italic>π</italic>. (b) The estimated Zernike coefficients from single blinking fluorophores for 25 different Zernike aberrations applied by the DM. Samples for a,b are microtubules labeled with AF647. (c) Tetrapod PSF model generated from a phase plate, the pupil-image based PSF model is estimated from single blinking fluorophores. The sample is TOMM20 labeled with AF647. (d-f) Estimation of a Zernike-based 4Pi-PSF model (estimated PSF model (d) pupil function (e) and Zernike coefficients (f)) from blinking single fluorophores. The sample is Nup96-mMaple in U2OS cells. (g-i) Comparison of PSF models from SMLM data and from bead data for astigmatic 3D SMLM (h). (j) The sample is Nup96-AF647 imaged at 5 µm above the coverslip using an oil immersion objective. (i) XZ view of the selected region in (g), a few zoom-in NPCs under the white arrows shows consistent ring separation for the in-situ PSF model. Scale bars, 1 µm (a,c,d,h,i), 5 µm (g), 200 nm (i, zoom in).</p></caption><graphic xlink:href="EMS190232-f003"/></fig><fig id="F4" position="float"><label>Figure 4</label><caption><title>Field-dependent PSF modeling.</title><p>(a) FD map of Zernike coefficients obtained from beads and single fluorophores in an FOV of about 180 µm × 180 µm. (b) uiPSF successfully recovers FD PSFs from beads at different positions indicated in (a). (c) Comparison of localization bias in x, y, and z obtained through the localization of beads data using the FD PSF and an average PSF. (d-l) in-situ FD PSF. (d) Nup96-AF647 in U2OS cells imaged, fitted with FD-DeepLoc using a FD <italic>in situ</italic> PSF model. The different colors represent various z positions. (e) and (f) zooms as indicated in (d). e(i-iii) and f(i-iii) are side view reconstructions of the selected region indicated in (e-f) and intensity profiles through individual NPCs (h-l) demonstrate the higher quality for the FD <italic>in situ</italic> PSF. Scale bars, 50 µm (a), 1 µm (b), 20 µm (d), and 0.5 µm (e-f).</p></caption><graphic xlink:href="EMS190232-f004"/></fig></floats-group></article>