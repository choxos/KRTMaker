<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="ppub"/></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS150917</article-id><article-id pub-id-type="doi">10.1101/2021.11.28.470236</article-id><article-id pub-id-type="archive">PPR425614</article-id><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group><subj-group subj-group-type="europepmc-category"><subject>Covid-19</subject></subj-group></article-categories><title-group><article-title><italic>propeller</italic>: testing for differences in cell type proportions in single cell data</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Phipson</surname><given-names>Belinda</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A4">4</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><contrib contrib-type="author"><name><surname>Sim</surname><given-names>Choon Boon</given-names></name><xref ref-type="aff" rid="A5">5</xref><xref ref-type="aff" rid="A6">6</xref></contrib><contrib contrib-type="author"><name><surname>Porrello</surname><given-names>Enzo R.</given-names></name><xref ref-type="aff" rid="A5">5</xref><xref ref-type="aff" rid="A6">6</xref><xref ref-type="aff" rid="A7">7</xref><xref ref-type="aff" rid="A8">8</xref></contrib><contrib contrib-type="author"><name><surname>Hewitt</surname><given-names>Alex W</given-names></name><xref ref-type="aff" rid="A9">9</xref><xref ref-type="aff" rid="A10">10</xref></contrib><contrib contrib-type="author"><name><surname>Powell</surname><given-names>Joseph</given-names></name><xref ref-type="aff" rid="A11">11</xref><xref ref-type="aff" rid="A12">12</xref></contrib><contrib contrib-type="author"><name><surname>Oshlack</surname><given-names>Alicia</given-names></name><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A13">13</xref><xref ref-type="aff" rid="A14">14</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><aff id="A1"><label>1</label>Walter and Eliza Hall Institute of Medical Research, Parkville, Victoria, 3052, Australia</aff><aff id="A2"><label>2</label>Department of Pediatrics, University of Melbourne, Parkville, Victoria, 3010, Australia</aff><aff id="A3"><label>3</label>Sir Peter MacCallum Department of Oncology, University of Melbourne, Parkville, Victoria, 3010, Australia</aff><aff id="A4"><label>4</label>Department of Medical Biology, University of Melbourne, Parkville, Victoria, 3010, Australia</aff><aff id="A5"><label>5</label>Murdoch Children’s Research Institute, Royal Children’s Hospital, Melbourne 3052, VIC, Australia</aff><aff id="A6"><label>6</label>Melbourne Centre for Cardiovascular Genomics and Regenerative Medicine, The Royal Children's Hospital, Melbourne 3052, VIC, Australia</aff><aff id="A7"><label>7</label>Department of Anatomy and Physiology, School of Biomedical Sciences, The University of Melbourne, Melbourne 3010, VIC, Australia</aff><aff id="A8"><label>8</label>Novo Nordisk Foundation Center for Stem Cell Medicine, Murdoch Children’s Research Institute, Royal Children’s Hospital, Melbourne 3052, VIC, Australia</aff><aff id="A9"><label>9</label>Menzies Institute for Medical Research, School of Medicine, University of Tasmania, Tasmania, Australia</aff><aff id="A10"><label>10</label>Centre for Eye Research Australia, The University of Melbourne, Victoria, Australia</aff><aff id="A11"><label>11</label>Garvan-Weizmann Centre for Cellular Genomics, Garvan Institute of Medical Research, Darlinghurst, NSW, 2010, Australia</aff><aff id="A12"><label>12</label>UNSW Cellular Genomics Futures Institute, University of New Souith Wales, Kingston, NSW, 2052, Australia</aff><aff id="A13"><label>13</label>Peter MacCallum Cancer Centre, Melbourne, Victoria, 3000, Australia</aff><aff id="A14"><label>14</label>School of Biosciences, University of Melbourne, Parkville, Victoria, 3010, Australia</aff></contrib-group><author-notes><corresp id="CR1"><label>*</label>corresponding author <email>Alicia.Oshlack@petermac.org</email>, <email>phipson.b@wehi.edu.au</email></corresp></author-notes><pub-date pub-type="nihms-submitted"><day>15</day><month>07</month><year>2022</year></pub-date><pub-date pub-type="preprint"><day>13</day><month>07</month><year>2022</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by-nc-nd/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0 International license</ext-link>.</license-p></license></permissions><abstract><sec id="S1"><title>Motivation</title><p id="P1">Single cell RNA Sequencing (scRNA-seq) has rapidly gained popularity over the last few years for profiling the transcriptomes of thousands to millions of single cells. This technology is now being used to analyse experiments with complex designs including biological replication. One question that can be asked from single cell experiments, which has been difficult to directly address with bulk RNA-seq data, is whether the cell type proportions are different between two or more experimental conditions. As well as gene expression changes, the relative depletion or enrichment of a particular cell type can be the functional consequence of disease or treatment. However, cell type proportions estimates from scRNA-seq data are variable and statistical methods that can correctly account for different sources of variability are needed to confidently identify statistically significant shifts in cell type composition between experimental conditions.</p></sec><sec id="S2"><title>Results</title><p id="P2">We have developed <italic>propeller</italic>, a robust and flexible method that leverages biological replication to find statistically significant differences in cell type proportions between groups. Using simulated cell type proportions data we show that <italic>propeller</italic> performs well under a variety of scenarios. We applied <italic>propeller</italic> to test for significant changes in proportions of cell types related to human heart development, ageing and COVID-19 disease severity.</p></sec><sec id="S3"><title>Availability and implementation</title><p id="P3">The <italic>propeller</italic> method is publicly available in the open source <monospace>speckle</monospace> R package (<ext-link ext-link-type="uri" xlink:href="https://github.com/phipsonlab/speckle">https://github.com/phipsonlab/speckle</ext-link>). All the analysis code for the paper is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/phipsonlab/propeller-paper-analysis/">https://github.com/phipsonlab/propeller-paper-analysis/</ext-link>, and the associated analysis website is available at <ext-link ext-link-type="uri" xlink:href="https://phipsonlab.github.io/propeller-paper-analysis/">https://phipsonlab.github.io/propeller-paper-analysis/</ext-link>.</p></sec></abstract></article-meta></front><body><sec id="S4" sec-type="intro"><label>1</label><title>Introduction</title><p id="P4">Single cell RNA-sequencing (scRNA-seq) technology has led to breakthroughs in the discovery of novel cell types and enhanced our understanding of the development of complex tissues. As the technology has matured it has become relatively straightforward to profile the transcriptomes of hundreds of thousands of cells, resulting in valuable insight into the composition of tissues.</p><p id="P5">While many of the first published single cell papers focused on defining the resident cell types in complex tissues<sup><xref ref-type="bibr" rid="R1">1</xref>–<xref ref-type="bibr" rid="R4">4</xref></sup>, the field is now using this technology for complex experimental comparisons with biological replication<sup><xref ref-type="bibr" rid="R5">5</xref>–<xref ref-type="bibr" rid="R8">8</xref></sup>. Experiments with different conditions and multiple biological samples can be costly, however substantial savings can be made by pooling cells from multiple samples. If samples are genetically diverse, they can be demultiplexed using genetic information<sup><xref ref-type="bibr" rid="R9">9</xref>,<xref ref-type="bibr" rid="R10">10</xref></sup>. An alternative approach is to use molecular cell multiplexing protocols, such as the commercially available CellPlex from 10x Genomics. Collectively, cell multiplexing makes designing larger scRNA-seq experiments more feasible.</p><p id="P6">The first step in analysis for an scRNA-seq experiment with multiple experimental conditions and biological replicates is to identify the cell types present in each sample. However, downstream analysis requires sophisticated tools to address specific hypotheses about how a perturbation affects the biological system. Two analysis tasks are commonly performed following cell type identification in order to understand the effect of the condition. One task is to find genes that are differentially expressed between groups of samples, for every cell type observed in the experiment, similar to the analysis of bulk RNA-seq experiments<sup><xref ref-type="bibr" rid="R11">11</xref></sup>. However, a benefit of scRNA-seq data is that we have additional information on the composition of the samples. The relative change in abundance of a cell type can be a consequence of normal development, disease or treatment. Due to technical as well as biological sources, the cell type proportions estimates from single cell data can be quite variable. The focus of this work is to find statistically significant differences in cell type proportions between groups of samples that appropriately takes into account sample-to-sample variability.</p><p id="P7">Here we present <italic>propeller</italic>, a robust and flexible linear modeling based solution to test for differences in cell type proportions between experimental conditions. The <italic>propeller</italic> method leverages biological replication to obtain measures of variability of cell type proportion estimates, and uses empirical Bayes to stabilise variance estimates by borrowing information across cell types. It is a flexible approach that can be applied to complex experimental designs with multiple factors. Using simulated data, we compared the performance of commonly used statistical models for testing for differences in cell type proportions and show that <italic>propeller</italic> performs well across a variety of experimental scenarios. We applied <italic>propeller</italic> to three different single cell datasets on ageing, human heart development and COVID-19 disease severity and find additional cell types changing in abundance that were not reported in the original analysis. Our <italic>propeller</italic> method is publicly available in the <monospace>speckle</monospace> R package (<ext-link ext-link-type="uri" xlink:href="https://github.com/phipsonlab/speckle">https://github.com/phipsonlab/speckle</ext-link>).</p></sec><sec id="S5"><label>2</label><title>The <italic>propeller</italic> method</title><p id="P8"><italic>Propeller</italic> is a function in the <monospace>speckle</monospace> R package that uses cell level annotation information to calculate sample level cell type proportions, followed by data transformation and statistical testing for each cell type. <italic>Propeller</italic> leverages biological replication to estimate the high sample-to-sample variability in cell type counts often observed in real single cell data (<xref ref-type="fig" rid="F1">Figure 1a</xref>, PBMC scRNA-seq data from 12 healthy human donors). The variability in cell type proportions estimates between samples can be large both due to technical sources such as variation in dissociation protocols, and due to valid biological factors that contribute to variability. For example, blood cell type composition is known to change with age<sup><xref ref-type="bibr" rid="R12">12</xref></sup>. Taking into account sample-to-sample variability when analysing differences in cell type proportions is critical as observed cell type variances are far greater than variances estimated under a binomial or Poisson distribution, which can only account for sampling variation (<xref ref-type="fig" rid="F1">Figure 1b</xref>, PBMC scRNA-seq dataset from 12 healthy human donors).</p><p id="P9">The first step of <italic>propeller</italic> is to calculate the cell type proportions for each sample. <italic>Propeller</italic> can directly derive the counts and calculate the proportions from a Seurat or SingleCellExperiment object. This results in a matrix of proportions where the rows are the cell types and the columns are the samples. The binomial distribution has the statistical property that proportions close to 0 and 1 have small variance, and values close to 0.5 have large variance i.e. the variances are heteroskedastic. To overcome this, we have implemented two transformations in <italic>propeller</italic>: (1) arcsin square root transformation, and (2) logit transformation. The arcsin square root transformation has the benefit that it will always produce a real value. If the logit transformation is selected an offset of 0.5 is added to the raw cell type counts matrix prior to transformation to avoid taking the log of zeroes.</p><p id="P10">Next we test whether the transformed proportions for every cell type are significantly different between two or more experimental conditions using a linear modelling framework. If there are exactly two groups, we perform moderated t-tests; if there are more than two groups, we perform moderated ANOVA tests<sup><xref ref-type="bibr" rid="R13">13</xref></sup>. These tests are moderated using an empirical Bayes framework, allowing information to be borrowed across cell types to stabilise the cell type specific variance estimates. This is particularly effective when the number of biological replicates is small and the number of cell types is at least three<sup><xref ref-type="bibr" rid="R14">14</xref></sup>, a common situation in scRNA-seq experiments. The final step in <italic>propeller</italic> is to calculate false discovery rates<sup><xref ref-type="bibr" rid="R15">15</xref></sup> to account for testing across multiple cell types. The output of <italic>propeller</italic> consists of condition specific proportions estimates, <italic>p</italic>-values and false discovery rates for every cell type observed in the experiment.</p><p id="P11">The minimal annotation information that <italic>propeller</italic> requires for each cell is cluster/cell type, sample and group/condition, which can be manually entered or automatically extracted from Seurat and SingleCellExperiment class objects. More complex experimental designs can be accommodated using the <italic>propeller</italic>.<italic>ttest</italic> and <italic>propeller</italic>.<italic>anova</italic> functions, which have the flexibility to model additional covariates of interest such as sex or age.</p></sec><sec id="S6"><label>3</label><title>Performance using simulated datasets</title><sec id="S7"><label>3.1</label><title>Type I error control under null simulation scenario</title><p id="P12">Although it is clear from the PBMC scRNA-seq data that cell type proportions estimates are overdispersed (<xref ref-type="fig" rid="F1">Figure 1b</xref>), we wanted to more thoroughly evaluate the performance of <italic>propeller</italic> as well as other statistical methods that have commonly been used for testing differences in proportions in other fields. Using simulated cell type proportions, we compared the performance of nine different statistical models.</p><list list-type="order" id="L1"><list-item><p id="P13">Chi-square test for differences in proportions</p></list-item><list-item><p id="P14">Logistic binomial regression (special case of beta-binomial with dispersion=0)</p></list-item><list-item><p id="P15">Poisson regression (special case of negative binomial with dispersion=0)</p></list-item><list-item><p id="P16"><italic>propeller</italic> with arcsin square root transformation of proportions, denoted propeller(asin)</p></list-item><list-item><p id="P17"><italic>propeller</italic> with logit transformation of proportions, denoted propeller(logit)</p></list-item><list-item><p id="P18">Beta-binomial regression on cell type counts</p></list-item><list-item><p id="P19">Negative binomial regression on cell type counts</p></list-item><list-item><p id="P20">Quasi-likelihood negative binomial regression on cell type counts</p></list-item><list-item><p id="P21">Centred log-ratio transformation (CLR) followed by linear regression, denoted CODA</p></list-item></list><p id="P22">The first three methods do not take into account sample to sample variability, while the remaining 6 methods (<italic>4-9</italic>) do. The quasi-likelihood approach (method 8) is described in the Bioconductor book “Orchestrating single cell analysis with Bioconductor”<sup><xref ref-type="bibr" rid="R16">16</xref></sup>. The two variations of <italic>propeller</italic> model transformed proportions, while the remaining statistical tests, with the exception of the CODA method, model the cell type counts directly. Method 9 is an example from the compositional data analysis field where the cell types are modeled relative to a reference “cell type”. Here the geometric mean of the cell types forms the baseline as is commonly done in microbiome data analysis<sup><xref ref-type="bibr" rid="R17">17</xref></sup>. The log-ratio of the counts to the geometric mean is calculated and a linear model fitted with group as the explanatory variable to obtain p-values.</p><p id="P23">We simulated cell type counts in a hierarchical manner under a simple null scenario where the cell type proportions do not differ between two groups in order to determine whether the nine methods control the Type I error rate. We simulated five cell types with proportions that varied from rare to abundant (true proportions <italic>π</italic><sub><italic>i</italic></sub> = 0.01, 0.02, 0.15, 0.34, 0.45). The sample proportions, <italic>p</italic><sub><italic>ij</italic></sub>, for cell type <italic>i</italic> and sample <italic>j</italic>, were generated from a Beta distribution with parameters <italic>α</italic><sub><italic>i</italic></sub> and β<sub><italic>i</italic></sub>, which control how variable the proportions are. Larger values of <italic>α</italic><sub><italic>i</italic></sub> and β<sub><italic>i</italic></sub> result in a more precise distribution centred around the true proportions, while smaller values result in a more diffuse prior (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 1</xref>). We set <italic>α</italic><sub><italic>i</italic></sub> = 10, and calculated the corresponding <italic>β</italic><sub><italic>i</italic></sub> for each cell type <italic>i</italic> from the following relationship derived from properties of the Beta distribution: <disp-formula id="FD1"><mml:math id="M1"><mml:mrow><mml:msub><mml:mi>β</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>α</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>1</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>π</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>π</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:math></disp-formula></p><p id="P24">Cell type counts <italic>x</italic><sub><italic>ij</italic></sub> were then sampled from a binomial distribution with parameters <italic>n</italic><sub><italic>j</italic></sub> and <italic>p</italic><sub><italic>ij</italic></sub>. The total number of cells, <italic>n</italic><sub><italic>j</italic></sub>, per sample <italic>j</italic>, were sampled from a negative binomial distribution with mean 5000 and dispersion 20 to simulate variation in total cell numbers per sample observed in real data. We simulated 10,000 datasets, and counted the number of times each of the five cell types were statistically significant with p-value &lt; 0.05 for the nine different statistical models. We also varied the number of samples per group to determine the effect of sample size on the Type I error rate (<italic>n</italic> = 3, 5, 10, 20). <xref ref-type="fig" rid="F2">Figure 2a</xref> shows the cell type proportions per sample observed for an example simulated dataset under these conditions.</p><p id="P25"><xref ref-type="table" rid="T1">Table 1</xref> shows the type I error rates for the nine different methods for each of the five different cell types at a nominal p-value cut-off of 0.05 when the number of samples per group is five. The most striking observation is that the statistical tests (methods <italic>1-3</italic>) that do not account for additional biological variability frequently find significant differences between the two groups when there are none. As expected, it is clear that methods that account for this additional variability are required and methods <italic>1-3</italic> are not further explored in this analysis.</p><p id="P26">For the methods that model sample-to-sample variability none have perfect type I error rate control, although the observed rates are generally close to 0.05 (methods <italic>4-9</italic>). Propeller(asin) tends to be conservative for the most rare cell type, and permissive for more abundant cell types whereas the opposite tends to be true for the other tests, particularly for the negative binomial methods. These results show that the type I error rate differs between different cell types depending on how abundant the cell type is, and no method perfectly controls the type I error rate for both rare and abundant cell types.</p><p id="P27"><xref ref-type="fig" rid="F2">Figure 2b</xref> summarises the Type I error rates for different sample sizes. As the number of samples in each group increases, the type I error rate for all methods is closer to 0.05 (<xref ref-type="fig" rid="F2">Figure 2b</xref>). For sample sizes of 10 and 20 per group, the arcsin-square root transformation shows the best type I error rate control for almost all cell types abundances, however with smaller sample sizes (<italic>n</italic> = 3, 5), the logit transform appears to better control the type I error rate. Across all sample sizes there was a trend of increased Type I error rate for less abundant cell types for propeller(logit), beta-binomial, negative binomial, quasi-likelihood negative binomial and the CODA method, while propeller(asin) tends to be conservative for the most rare cell type (<italic>π</italic> = 0.01). It is not surprising that the beta-binomial model performs favourably as this method most closely resembles the distributional assumptions underlying the simulation.</p></sec><sec id="S8"><label>3.2</label><title>Power to detect true differences in cell type proportions in simulated data</title><p id="P28">Next we expanded the simulation to include seven cell types, three of which change proportions between the two groups by between 2 and 3-fold, while the remaining four did not (<xref ref-type="fig" rid="F2">Figure 2c</xref>). The parameters α<sub><italic>i</italic></sub> and β<sub><italic>i</italic></sub> of the beta distribution were estimated from real human heart single nuclei RNA-seq data (<xref ref-type="fig" rid="F3">Figure 3a</xref>) using the <italic>estimateBetaParamsFromCounts</italic> function available in the <monospace>speckle</monospace> package. We simulated 1000 datasets and evaluated the performance of the models by examining the proportion of simulated datasets with p-value &lt; 0.05 for each of the seven cell types for each of the six methods. The proportions of the three cell types that are simulated to differ between the two groups range from very rare to quite abundant (baseline proportions in group 1 = 0.008, 0.183, 0.551). We repeated these simulations for sample sizes <italic>n =</italic> 3, 5, 10, 20.</p><p id="P29">At <italic>n=5</italic> samples per group, propeller(asin) detected the rare cell type difference in only 52% of the simulated datasets, while the other methods detected the rare cell type difference in 71-81% of simulated datasets (<xref ref-type="fig" rid="F2">Figure 2d</xref>). However, propeller(asin) detected the differences in the more abundant cell types in a larger percentage of the simulated datasets compared to the other methods (82% and 74% of simulated datasets). The negative binomial methods detected the difference in the most abundant cell type in &lt; 50% of the simulated datasets. The CODA method had relatively poor performance for the more abundant cell types compared to the propeller methods and the beta-binomial model. The most consistent performing models across cell type abundances were propeller(logit) and the beta-binomial model. In terms of the cell types that did not change between the two groups, we noted that propeller(asin) generally had the best false discovery rate control and CODA had the worst. Heatmaps for sample sizes <italic>n</italic> = 3, 10 and 20 are shown in <xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 2</xref>.</p><p id="P30"><xref ref-type="fig" rid="F2">Figure 2e</xref> shows the mean area under the receiver operating curve (AUC) for the six methods at the four different sample sizes (<italic>n</italic> = 3, 5, 10, 20). As sample size increases, all methods show an improvement in performance. With at least 10 samples in each group, all methods except CODA have an AUC above 98%. In general, propeller(asin), propeller(logit) and the Beta binomial method have the highest AUC at each of the four sample sizes.</p></sec><sec id="S9"><label>3.3</label><title>Extreme case: varying numbers of cell types</title><p id="P31">While the simulations above examine Type I error control and power to detect true positives with 5 and 7 cell types respectively, we wanted to examine the performance of the methods in the extreme case when there are only 2 cell types present in the dataset, compared to when there are 20. Here we focussed on <italic>n</italic> = 5 and simulating cell types with true differences between two groups.</p><p id="P32">The scenario when only two cell types are present in the data is interesting from the perspective that if one cell type changes in proportion, the other cell type will also naturally change. In this scenario, we set the Group 1 true proportions as <italic>π</italic><sub><italic>1i</italic></sub> = 0.4, 0.6; and Group 2 true proportions as <italic>π</italic><sub><italic>2i</italic></sub> = 0.2, 0.8 (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 3a</xref>). Hence, cell type 1 is halved in Group 2 compared to Group 1, and cell type 2 increases by 33.3%. In this scenario, all the methods detected the changes in the two cell types in the majority of the simulated datasets (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 3b</xref>).There was a slight decrease in power for the negative binomial methods for the more abundant cell type.</p><p id="P33">For the scenario with 20 cell types, we used cell type proportion estimates from the 12 healthy human PBMC scRNA-seq dataset as our true baseline proportions. We modified 8 of the 20 cell types to be different between the two groups (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 4a</xref>). The cell types that differed in abundance between the two groups ranged from rare to abundant. The heatmap in <xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 4b</xref> shows the proportion of significant tests across the 1000 simulated datasets for each cell type and each method. In this scenario with a larger number of cell types, the negative binomial methods have similar performance compared to the other methods. Cell types with larger log-fold changes are detected as statistically significant in the majority of simulated datasets by all methods.</p><p id="P34"><xref ref-type="table" rid="T2">Table 2</xref> shows the recall, precision and F1 score for each method averaged across the 1000 simulated datasets. In this scenario, the CODA method is able to detect more true differences in cell type proportions compared to any of the other methods, at the expense of detecting the most false positives. In general, the propeller methods have high precision indicating that not many false discoveries are reported. The negative binomial methods perform well in this scenario, and the beta-binomial model has the second highest F1 score with a good balance between precision and recall. Propeller(logit) has the highest precision and CODA has the highest recall.</p></sec></sec><sec id="S10"><label>4</label><title>Application to real single cell datasets</title><p id="P35">One important feature of <italic>propeller</italic> is that complex experimental designs can be modelled by using a design matrix that takes account of multiple factors. In order to demonstrate the types of experimental designs that can be accommodated, we applied propeller(logit) to three different scRNA-seq datasets that varied in terms of the experimental design and the number of samples and cell types in each dataset:</p><list list-type="order" id="L2"><list-item><p id="P36">9 human heart biopsy samples across development (fetal, young, adult), with 8 broad cell types annotated<sup><xref ref-type="bibr" rid="R5">5</xref></sup>. We modelled development as a continuous variable and sex as a categorical variable.</p></list-item><list-item><p id="P37">20 PBMC samples across young and old male and female samples with 24 cell types annotated<sup><xref ref-type="bibr" rid="R6">6</xref></sup>. We modelled age and sex as categorical variables.</p></list-item><list-item><p id="P38">13 bronchoalveolar lavage fluid immune cell samples across three groups (healthy controls, moderate and severe COVID-19 infection) with 10 cell types annotated<sup><xref ref-type="bibr" rid="R18">18</xref></sup>. We modelled disease status as a categorical variable and performed an ANOVA to find cell type differences between the three groups.</p></list-item></list><p id="P39"><xref ref-type="fig" rid="F3">Figure 3a-c</xref> shows the cell type proportion estimates for each sample for the three different datasets. The cell type proportions are highly variable between individuals across all datasets. Across healthy human heart development, we detected significant changes in the abundances of immune, erythroid, cardiomyocyte and fibroblast cells (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 5</xref>). In the original analysis, propeller(logit) was applied as an ANOVA test, ignoring sex. While the conclusions are not markedly different, the order of significant cell types has changed with immune cells the most significant cell type when modelling development as a continuous variable. The immune and erythroid cell type changes across development form a type of positive control and it is encouraging that they are the most significant cell types. As noted in the initial paper<sup><xref ref-type="bibr" rid="R5">5</xref></sup>, immune cells increase throughout development, as would be expected as the fetus has not been exposed to many pathogens, while an adult would have a larger and more diverse repertoire of immune cells. With the erythroid cells, only fetal red blood cells are nucleated, and hence they are captured with the nuclei protocol in fetal samples and absent in young and adult samples. An interesting finding in this study was that the relative abundance of cardiomyocytes decline with age (<xref ref-type="fig" rid="F3">Figure 3d</xref>), while fibroblasts increase across development (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 6</xref>).</p><p id="P40">For the aging PBMC dataset, we detected statistically significant differences in CD8 naive and CD16 cells between young and old samples, while controlling for sex, at a false discovery rate threshold of 0.05. CD8 naive cells were enriched in the young samples (<xref ref-type="fig" rid="F3">Figure 3e</xref>), and CD16 cells were depleted in the young samples compared to old (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 6</xref>). While the CD8 naive result was reported in the initial paper, we detected a significant change in abundance of CD16 cells between young and old samples that was not reported in the original analysis<sup><xref ref-type="bibr" rid="R6">6</xref></sup>.</p><p id="P41">For the COVID-19 dataset, we found four cell types to have significant changes in abundance between the three groups when we used propeller(logit) (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 7</xref>). We found that neutrophils were the most significantly different between healthy controls and moderate and severe bronchoalveolar lavage samples from COVID-19 patients (<xref ref-type="fig" rid="F3">Figure 3f</xref>), and this was not reported as statistically significant in the original analysis<sup><xref ref-type="bibr" rid="R18">18</xref></sup>. Plasma, pDC and NK cells also showed significant changes in abundance. Upon closer inspection, it appeared that the significant result for Plasma was driven by one sample in the severe COVID-19 group (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 7</xref>). When we re-analysed the data with propeller(asin), this cell type was no longer significant, while neutrophils, pDC and NK cells were still statistically significant. This indicates that propeller(logit) may be sensitive to outlier samples and suggests that propeller(asin) is a more robust method to use when outliers are present in the data. Compared to the results from the original analysis, we detected two additional cell types, neutrophils and NK cells, that significantly changed in abundance between healthy controls, moderate and severe COVID-19 patients.</p></sec><sec id="S11" sec-type="discussion"><label>5</label><title>Discussion</title><p id="P42">In this paper we present <italic>propeller</italic>, a new method for testing for differences in cell type proportions from single cell data. It takes account of sample-to-sample variability, which is large due to both technical and biological sources. The <italic>propeller</italic> function itself inter-operates with Seurat and SingleCellExperiment class objects, and the <italic>propeller</italic>.<italic>ttest</italic> and <italic>propeller</italic>.<italic>anova</italic> functions have the ability to model complex experimental designs. In order to work specifically with the features of single cell data which often have extreme cell proportions, we have implemented <italic>propeller</italic> with two different transformations: the arcsin square root transformation and the logit transformation. Through simulation studies, we found propeller(logit) has superior performance in terms of power to detect changes in cell type proportions, as well as good false discovery rate control. Through analysis of real datasets, we found that propeller(logit) may be sensitive to outlier samples, while propeller(asin) is not, which suggests that propeller(asin) is a good alternative in this scenario. A recent comparison of statistical methods for performing cell type composition analysis of single cell data found that propeller(asin) and Dirichlet regression had the best performance across a variety of scenarios<sup><xref ref-type="bibr" rid="R19">19</xref></sup>. The <italic>propeller</italic> methods have the ability to handle zeros and ones in the data, which are not uncommon in cell type proportion estimates from single cell data. Zero values need to be carefully dealt with when using compositional data analysis methods (CODA). For the simulation studies, we replaced zeroes with 0.5 prior to centred-log ratio transformation. Another factor to consider when using a CODA framework is the choice of reference cell type, and all results need to be interpreted relative to the reference cell type, which can make interpretation of the output more challenging.</p><p id="P43">In our simulation studies we explored the effect of the number of cell types on the performance of the methods. For datasets with fewer cell types, the negative binomial methods and the CODA method show decreased performance compared to beta-binomial and <italic>propeller</italic> methods. As the number of cell types increases to 20, the performance of negative binomial and CODA methods improve to be comparable to the other methods. We also explored the effect of sample size and baseline abundance of the cell type on the performance of the methods. For small sample sizes the differences between the methods is more pronounced, with propeller(logit) and beta-binomial showing the best overall performance. As the sample size increases beyond 10 samples per group, all methods show good power and false discovery rate control, with the exception of the CODA method, which has increased false discovery rates for all cell types with increasing sample size. We also found that at smaller sample sizes, propeller(asin) had less power to detect the differences in the most rare cell types, while the negative binomial methods had less power to detect differences in the most abundant cell types.</p><p id="P44">We applied <italic>propeller</italic> to the analysis of three different single cell datasets that differed in terms of tissue, number of cell types, sample size and experimental conditions. We found significant biological differences in abundance, including some cell types that had not been previously reported, in three different studies: across healthy human heart development, comparing blood from young and old patients, and in lung fluid from individuals with severe covid versus moderate and healthy controls. All our analysis is available via a <italic>workflowr</italic><sup><xref ref-type="bibr" rid="R20">20</xref></sup> website (<ext-link ext-link-type="uri" xlink:href="https://phipsonlab.github.io/propeller-paper-analysis/">https://phipsonlab.github.io/propeller-paper-analysis/</ext-link>), with the original source code available on github (<ext-link ext-link-type="uri" xlink:href="https://github.com/phipsonlab/propeller-paper-analysis/tree/master">https://github.com/phipsonlab/propeller-paper-analysis/tree/master</ext-link>). The <italic>propeller</italic> methods are available in the <monospace>speckle</monospace> R package (<ext-link ext-link-type="uri" xlink:href="https://github.com/phipsonlab/speckle">https://github.com/phipsonlab/speckle</ext-link>).</p></sec><sec id="S12" sec-type="materials | methods"><label>6</label><title>Materials and Methods</title><sec id="S13"><label>6.1</label><title>The <italic>propeller</italic> statistical model</title><p id="P45">Let <italic>x</italic><sub><italic>ij</italic></sub> denote the number of cells observed for cell type <italic>i</italic> for sample <italic>j</italic>, and let <italic>N</italic><sub><italic>j</italic></sub> denote the total number of cells observed for sample <italic>j</italic>. For each cell type <italic>i</italic> and sample <italic>j</italic>, we calculate the cell type proportions as <disp-formula id="FD2"><mml:math id="M2"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>N</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mfrac><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P46">We perform a variance stabilising step in <italic>propeller</italic> by performing a data transformation. The arcsin square root transform, denoted <italic>z</italic><sub><italic>ij</italic></sub>, is simply calculated as follows: <disp-formula id="FD3"><mml:math id="M3"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>c</mml:mi><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msqrt><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:msqrt><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P47">For the logit transform, more care is needed to deal with zeroes in the data. We thus add a count of 0.5 to <italic>x</italic><sub><italic>ij</italic></sub> when calculating the proportions: <disp-formula id="FD4"><mml:math id="M4"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>0.5</mml:mi></mml:mrow><mml:mrow><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>I</mml:mi></mml:mrow></mml:munderover><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>0.5</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P48">The logit transform is then given by <disp-formula id="FD5"><mml:math id="M5"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>l</mml:mi><mml:mi>o</mml:mi><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P49">Let <italic>Z<sub>i<sup>T</sup></sub></italic>= (<italic>z<sub>i</sub>1, ..., z<sub>i</sub>j</italic>) denote the vector of transformed proportions for cell type <italic>i</italic> for samples 1,…,<italic>J</italic>. We fit a linear model, <disp-formula id="FD6"><label>(1)</label><mml:math id="M6"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:mrow><mml:mi mathvariant="normal">E</mml:mi></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>X</mml:mi><mml:msub><mml:mi mathvariant="bold-italic">β</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula> where <italic>X</italic> is a design matrix of full column rank and <bold><italic>β</italic></bold><sub><italic>i</italic></sub> is a vector of coefficients. In general, <bold><italic>β</italic></bold><sub><italic>i</italic></sub> can be estimated by <disp-formula id="FD7"><mml:math id="M7"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>β</mml:mi><mml:mo>⌢</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>X</mml:mi><mml:mi>T</mml:mi></mml:msup><mml:mi>X</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mi>X</mml:mi><mml:mi>T</mml:mi></mml:msup><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P50">The variance of the transformed proportions for the <italic>i</italic><sup><italic>th</italic></sup> cell type is denoted <italic>s</italic><sub><italic>i</italic></sub><sup><italic>2</italic></sup> and are the residuals obtained from fitting the linear model in (1). Moderated t-statistics for each contrast <italic>k</italic> are calculated as <disp-formula id="FD8"><mml:math id="M8"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mover><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>ι</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msqrt><mml:mi>v</mml:mi></mml:msqrt></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula> where <italic>v</italic> is the appropriate diagonal element from the positive definite matrix (<italic>X</italic><sup><italic>T</italic></sup><italic>X</italic>)<sup>-1</sup>, and <italic>s</italic><sub><italic>ik</italic></sub><sup><italic>2</italic></sup> are the squeezed variances from Smyth (2004). The <italic>t</italic><sub><italic>ik</italic></sub> follow a scaled t distribution with augmented degrees of freedom <italic>d</italic><sub><italic>o</italic></sub><italic>+d</italic><sub><italic>i</italic></sub>. Once p-values are obtained from the moderated t-statistics, they are adjusted for multiple testing using the method of Benjamini and Hochberg<sup><xref ref-type="bibr" rid="R15">15</xref></sup>, which has been shown to be robust to dependence of the test statistics<sup><xref ref-type="bibr" rid="R21">21</xref></sup>. The BH procedure is also robust to the number of cell types and will compute when the number of cell types is as low as two.</p></sec><sec id="S14"><label>6.2</label><title>Estimating the parameters of the Beta distribution from observed cell type counts</title><p id="P51">We used the method of moments to estimate the parameters <italic>α</italic> and <italic>β</italic> of the Beta distribution from observed cell type counts <italic>x</italic><sub><italic>ij</italic></sub> from real single cell data in some of our simulated datasets. We implemented the estimation procedure on both cell type counts and proportions in the <italic>estimateBetaParamsFromCounts</italic> and <italic>estimateBetaParam</italic> functions respectively. We found the estimation procedure more stable on the cell type counts and it is described here.</p><p id="P52">The cell type proportions <italic>p</italic><sub><italic>ij</italic></sub> for cell type <italic>i</italic> and sample <italic>j</italic> are calculated as <disp-formula id="FD9"><mml:math id="M9"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>N</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mfrac><mml:mo>,</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula> where <disp-formula id="FD10"><mml:math id="M10"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>N</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>I</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula> are the total cell counts for sample <italic>j</italic>. In practice the cell type counts are scaled to the median <italic>N</italic><sub><italic>j</italic></sub>, such that all <italic>N</italic><sub><italic>j</italic></sub> =<italic>N</italic>. For cell type <italic>i</italic>, the mean and variance of the Beta distribution are given by <disp-formula id="FD11"><mml:math id="M11"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>N</mml:mi></mml:mfrac><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>X</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula> and <disp-formula id="FD12"><mml:math id="M12"><mml:mrow><mml:mi>V</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msup><mml:mi>N</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mi>V</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>X</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>β</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P53">The <italic>k</italic><sup><italic>th</italic></sup> raw moment can be estimated from the <italic>k</italic><sup><italic>th</italic></sup> raw sample moment for cell type <italic>i</italic> <disp-formula id="FD13"><mml:math id="M13"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>J</mml:mi></mml:mfrac><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>J</mml:mi></mml:mrow></mml:munderover><mml:msubsup><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msubsup></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P54">The estimated first and second moments for cell type <italic>i</italic> are given by <disp-formula id="FD14"><mml:math id="M14"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>J</mml:mi></mml:mfrac><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>J</mml:mi></mml:mrow></mml:munderover><mml:mspace width="1em"/><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>2</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>J</mml:mi></mml:mfrac><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>J</mml:mi></mml:mrow></mml:munderover><mml:mspace width="1em"/><mml:msubsup><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>2</mml:mi></mml:mrow></mml:msubsup><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P55">It can hence be shown through the mathematical relationships between the mean, variance and moments that estimators for <italic>α</italic><sub><italic>i</italic></sub> and <italic>β</italic><sub><italic>i</italic></sub> can be obtained by <disp-formula id="FD15"><mml:math id="M15"><mml:mtable rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:mrow><mml:mover><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>N</mml:mi><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>2</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mfrac><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>2</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac><mml:mo>−</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>1</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mover><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi>N</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi>N</mml:mi><mml:mo>−</mml:mo><mml:mfrac><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mn>2</mml:mn><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>l</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mfrac><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>2</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac><mml:mo>−</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>1</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p></sec><sec id="S15"><label>6.3</label><title>The hierarchical model for the simulated datasets</title><p id="P56">Let <bold><italic>π</italic></bold> denote a vector of true probabilities for the cell types. For a given value of <bold><italic>α, β</italic></bold> can be calculated as <disp-formula id="FD16"><mml:math id="M16"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:mi>β</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>α</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>π</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>π</mml:mi></mml:mfrac><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P57">Alternatively, <bold><italic>α</italic></bold> and <bold><italic>β</italic></bold> can be estimated from observed cell type counts in real single cell datasets using the method of moments described above.</p><p id="P58">The sample proportions <italic>p</italic><sub><italic>ij</italic></sub> for cell type <italic>i</italic> and sample <italic>j</italic> are generated from a Beta distribution: <disp-formula id="FD17"><mml:math id="M17"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo><mml:mi>Beta</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P59">The cell type counts <italic>x</italic><sub><italic>ij</italic></sub> are sampled from a binomial distribution <disp-formula id="FD18"><mml:math id="M18"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">j</mml:mi></mml:mrow></mml:mrow></mml:msub><mml:mo>∼</mml:mo><mml:mi>Bin</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula> where the total number of cells per sample <italic>j</italic> are sampled from a negative binomial distribution <disp-formula id="FD19"><mml:math id="M19"><mml:mtable columnalign="left" rowspacing="4pt" columnspacing="1em"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true"><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo><mml:mi>NegBin</mml:mi><mml:mo>⁡</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>μ</mml:mi><mml:mo>=</mml:mo><mml:mn>5000</mml:mn><mml:mo>,</mml:mo><mml:mi>φ</mml:mi><mml:mo>=</mml:mo><mml:mn>20</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P60">The resulting cell type counts follow a beta-binomial distribution.</p></sec><sec id="S16"><label>6.4</label><title>Implementation of the different methods in R</title><p id="P61">For the chi-square test, cells from the samples within each group were summed and the <italic>prop</italic>.<italic>test</italic> function was used to obtain p-values for each cell type. For the negative binomial models, the <italic>edgeR</italic> Bioconductor package was used. For the classic negative binomial regression, the <italic>glmFit</italic> and <italic>glmLRT</italic> functions were used to model cell type counts. For quasi-likelihood negative binomial, <italic>glmQLFit</italic> and <italic>glmQLFTest</italic> were used. To fit Poisson regression, the <italic>glmFit</italic> and <italic>glmLRT</italic> functions in <italic>edgeR</italic> were used with the dispersion set to zero. For beta-binomial, an alternate parameterisation for the negative binomial was employed, as described in Chen et al.,<sup><xref ref-type="bibr" rid="R22">22</xref></sup> to analyse bisulfite sequencing data. For logistic binomial regression, the same approach was taken but with the dispersion set to zero. We implemented the CODA method from first principles. First, we replaced any zeroes in the data with 0.5. For each sample <italic>j</italic> we calculated the geometric mean. The centred log-ratio transformation divides the observed cell type count for sample <italic>j</italic> by the geometric mean for sample <italic>j</italic> and then takes the log of the ratio. Normal regression theory can then be applied to the transformed data. We used <monospace>limma</monospace> to fit linear regression models on the transformed data.</p></sec></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary Material</label><media xlink:href="EMS150917-supplement-Supplementary_Material.pdf" mimetype="application" mime-subtype="pdf" id="d136aAdGbB" position="anchor"/></supplementary-material></sec></body><back><ack id="S17"><title>Acknowledgements</title><p>We thank Xinyi Jin for preparing the <monospace>speckle</monospace> package for submission to Bioconductor. We thank Dr Jovana Maksimovic for suggesting the COVID-19 dataset as an application dataset, and Prof Gordon Smyth for discussions regarding multiple testing adjustment under dependence of test statistics.</p><sec id="S18"><title>Funding</title><p>BP is funded by an NHMRC Investigator grant GNT1175653, AO is funded by an NHMRC Investigator grant GNT1196256, JP is funded by an NHMRC Investigator grant GNT1175781, and ERP is funded by an NHMRC Investigator grant GNT2008376. The work was supported by NHMRC Grant GNT1187748. The snRNA-seq dataset for heart was funded by Royal Children’s Hospital Foundation and NHMRC Project grant GNT1160257. The Novo Nordisk Foundation Center for Stem Cell Medicine (ERP) is supported by Novo Nordisk Foundation grants (NNF21CC0073729). MCRI is supported by the Victorian Government’s Operational Infrastructure Support Program.</p></sec></ack><ref-list><ref id="R1"><label>1</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zeisel</surname><given-names>A</given-names></name><etal/></person-group><article-title>Brain structure Cell types in the mouse cortex and hippocampus revealed by single-cell RNA-seq</article-title><source>Science</source><year>2015</year><volume>347</volume><fpage>1138</fpage><lpage>1142</lpage></element-citation></ref><ref id="R2"><label>2</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bornstein</surname><given-names>C</given-names></name><etal/></person-group><article-title>Single-cell mapping of the thymic stroma identifies IL-25-producing tuft epithelial cells</article-title><source>Nature</source><year>2018</year><volume>559</volume><fpage>622</fpage><lpage>626</lpage></element-citation></ref><ref id="R3"><label>3</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Single-cell RNA-seq reveals the diversity of trophoblast subtypes and patterns of differentiation in the human placenta</article-title><source>Cell Res</source><year>2018</year><volume>28</volume><fpage>819</fpage><lpage>832</lpage></element-citation></ref><ref id="R4"><label>4</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Combes</surname><given-names>AN</given-names></name><etal/></person-group><article-title>Single cell analysis of the developing mouse kidney provides deeper insight into marker gene expression and ligand-receptor crosstalk</article-title><source>Development</source><year>2019</year><volume>146</volume></element-citation></ref><ref id="R5"><label>5</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sim</surname><given-names>CB</given-names></name><etal/></person-group><article-title>Sex-Specific Control of Human Heart Maturation by the Progesterone Receptor</article-title><source>Circulation</source><year>2021</year><volume>143</volume><fpage>1614</fpage><lpage>1628</lpage></element-citation></ref><ref id="R6"><label>6</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Huang</surname><given-names>Z</given-names></name><etal/></person-group><article-title>Effects of sex and aging on the immune cell landscape as assessed by single-cell transcriptomic analysis</article-title><source>Proc Natl Acad Sci U S A</source><year>2021</year><volume>118</volume></element-citation></ref><ref id="R7"><label>7</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ren</surname><given-names>X</given-names></name><etal/></person-group><article-title>COVID-19 immune features revealed by a large-scale single-cell transcriptome atlas</article-title><source>Cell</source><year>2021</year><volume>184</volume><fpage>1895</fpage><lpage>1913</lpage><elocation-id>e19</elocation-id></element-citation></ref><ref id="R8"><label>8</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bunis</surname><given-names>DG</given-names></name><etal/></person-group><article-title>Single-Cell Mapping of Progressive Fetal-to-Adult Transition in Human Naive T Cells</article-title><source>Cell Rep</source><year>2021</year><volume>34</volume><elocation-id>108573</elocation-id></element-citation></ref><ref id="R9"><label>9</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname><given-names>J</given-names></name><etal/></person-group><article-title>Genotype-free demultiplexing of pooled single-cell RNA-seq</article-title><source>Genome Biol</source><year>2019</year><volume>20</volume><fpage>290</fpage></element-citation></ref><ref id="R10"><label>10</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Huang</surname><given-names>Y</given-names></name><name><surname>McCarthy</surname><given-names>DJ</given-names></name><name><surname>Stegle</surname><given-names>O</given-names></name></person-group><article-title>Vireo: Bayesian demultiplexing of pooled single-cell RNA-seq data without genotype reference</article-title><source>Genome Biol</source><year>2019</year><volume>20</volume><fpage>273</fpage></element-citation></ref><ref id="R11"><label>11</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Crowell</surname><given-names>HL</given-names></name><etal/></person-group><article-title>muscat detects subpopulation-specific state transitions from multi-sample multi-condition single-cell transcriptomics data</article-title><source>Nat Commun</source><year>2020</year><volume>11</volume><elocation-id>6077</elocation-id></element-citation></ref><ref id="R12"><label>12</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tan</surname><given-names>Q</given-names></name><etal/></person-group><article-title>Handling blood cell composition in epigenetic studies on ageing</article-title><source>International journal of epidemiology</source><year>2017</year><volume>46</volume><fpage>1717</fpage><lpage>1718</lpage></element-citation></ref><ref id="R13"><label>13</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Smyth</surname><given-names>GK</given-names></name></person-group><article-title>Linear models and empirical bayes methods for assessing differential expression in microarray experiments</article-title><source>Stat Appl Genet Mol Biol</source><year>2004</year><volume>3</volume><elocation-id>Article3</elocation-id></element-citation></ref><ref id="R14"><label>14</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Efron</surname><given-names>B</given-names></name><name><surname>Morris</surname><given-names>C</given-names></name></person-group><article-title>Stein’s Paradox in Statistics</article-title><source>Sci Am</source><year>1977</year><volume>236</volume><fpage>119</fpage><lpage>127</lpage></element-citation></ref><ref id="R15"><label>15</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Benjamini</surname><given-names>Y</given-names></name><name><surname>Hochberg</surname><given-names>Y</given-names></name></person-group><article-title>Controlling the False Discovery Rate: A Practical and Powerful Approach to Multiple Testing</article-title><source>J R Stat Soc Series B Stat Methodol</source><year>1995</year><volume>57</volume><fpage>289</fpage><lpage>300</lpage></element-citation></ref><ref id="R16"><label>16</label><element-citation publication-type="web"><source>Orchestrating Single-Cell Analysis with Bioconductor</source><comment><ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/books/release/OSCA/">https://bioconductor.org/books/release/OSCA/</ext-link></comment></element-citation></ref><ref id="R17"><label>17</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Quinn</surname><given-names>TP</given-names></name><etal/></person-group><article-title>A field guide for the compositional analysis of any-omics data</article-title><source>Gigascience</source><year>2019</year><volume>8</volume></element-citation></ref><ref id="R18"><label>18</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liao</surname><given-names>M</given-names></name><etal/></person-group><article-title>Single-cell landscape of bronchoalveolar immune cells in patients with COVID-19</article-title><source>Nat Med</source><year>2020</year><volume>26</volume><fpage>842</fpage><lpage>844</lpage></element-citation></ref><ref id="R19"><label>19</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Simmons</surname><given-names>S</given-names></name></person-group><article-title>Cell Type Composition Analysis: Comparison of statistical methods</article-title><source>bioRxiv</source><year>2022</year><elocation-id>2022.02.04.479123</elocation-id><pub-id pub-id-type="doi">10.1101/2022.02.04.479123</pub-id></element-citation></ref><ref id="R20"><label>20</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Blischak</surname><given-names>JD</given-names></name><name><surname>Carbonetto</surname><given-names>P</given-names></name><name><surname>Stephens</surname><given-names>M</given-names></name></person-group><article-title>Creating and sharing reproducible research code the workflowr way</article-title><source>F1000Res</source><year>2019</year><volume>8</volume><fpage>1749</fpage></element-citation></ref><ref id="R21"><label>21</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Benjamini</surname><given-names>Y</given-names></name><name><surname>Yekutieli</surname><given-names>D</given-names></name></person-group><article-title>The Control of the False Discovery Rate in Multiple Testing under Dependency</article-title><source>Ann Stat</source><year>2001</year><volume>29</volume><fpage>1165</fpage><lpage>1188</lpage></element-citation></ref><ref id="R22"><label>22</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>Y</given-names></name><name><surname>Pal</surname><given-names>B</given-names></name><name><surname>Visvader</surname><given-names>JE</given-names></name><name><surname>Smyth</surname><given-names>GK</given-names></name></person-group><article-title>Differential methylation analysis of reduced representation bisulfite sequencing experiments using edgeR</article-title><source>F1000Res</source><year>2017</year><volume>6</volume><fpage>2055</fpage></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Figure 1</label><caption><title>Exploring heterogeneity in cell type proportions estimated from single cell RNA-seq data.</title><p><bold>a</bold>. Barplot showing high levels of variability of cell type proportion estimates between 12 healthy PBMC scRNA-seq samples. <bold>b</bold>. Mean-variance relationship for 27 cell types in 12 healthy PBMC scRNA-seq samples showing that cell type proportions are over-dispersed compared to the variance estimated under a Binomial distribution. The plot is produced using the <italic>plotCellTypePropsMeanVar</italic> function in the <monospace>speckle</monospace> package.</p></caption><graphic xlink:href="EMS150917-f001"/></fig><fig id="F2" position="float"><label>Figure 2</label><caption><title>Simulation results.</title><p><bold>a</bold>. Cell type proportions for one simulated dataset with no abundance differences between group 1 (samples S1 - S5) and group 2 (samples S6 - S10). <bold>b</bold>. Type I error rate at <italic>α</italic>=0.05 for sample sizes n=3, 5, 10, 20 for the six methods. 1000 datasets with 5 cell types that do not change in abundance between two groups were simulated, varying the sample size. For each of the cell types, the proportion of simulated datasets with p-value &lt; 0.05 was calculated when testing for cell type proportion differences for each of the six models. <bold>c</bold>. True cell type proportions for group 1 and group 2. Three cell types that range in abundance are simulated to vary by 2 - 3 fold (denoted by asterisks). The remaining four cell types do not differ. <bold>d</bold>. Heatmap showing the proportions of 1000 simulated datasets with p-value &lt; 0.05 when testing for cell type proportion differences between two groups. True positives are denoted by an asterisk. Dark red indicates greater power to detect significant cell type differences (proportion significant is high). For true negatives, dark blue without the # symbol indicates good false discovery rate control with proportion significant &lt;0.05, # indicates proportion significant between 0.05 and 0.1, and ## indicates poorest control with the proportion significant &gt; 0.1. <bold>e</bold>. Heatmap showing the mean area under the receiver operating curve (AUC) for each of the six methods for all sample sizes across 1000 simulated datasets. Higher AUC (darker red) indicates a method has both good power to detect true positives as well as good false discovery rate control.</p></caption><graphic xlink:href="EMS150917-f002"/></fig><fig id="F3" position="float"><label>Figure 3</label><caption><title>Applying propeller to three single cell RNA-seq datasets.</title><p><bold>a</bold>. Barplot showing cell type proportions for nine samples in a human heart development snRNA-seq dataset. f=fetal, y=young, a=adult <bold>b</bold>. Barplot showing cell type proportions for 20 PBMC samples that differ in terms of their age (Y/O) and sex (M/F) <bold>c</bold>. Barplot showing cell type proportions for 13 samples in a COVID-19 study. HC=healthy control, M=moderate COVID-19 infection, S=severe COVID-19 infection. <bold>d</bold>. Treating developmental stage as a continuous variable, the cardiomyocyte populations show a relative decline across development in human heart samples. <bold>e</bold>. There is a statistically significant difference in the proportions of CD8 naive cells between young and old PBMC samples, taking sex into account. <bold>f</bold>. Neutrophils are statistically significantly different between healthy control, moderate and severe COVID-19 bronchoalveolar lavage samples.</p></caption><graphic xlink:href="EMS150917-f003"/></fig><table-wrap id="T1" position="float" orientation="portrait"><label>Table 1</label><caption><p>Proportion of significant tests for each cell type between two groups with no differences at a nominal p-value cut-off of 0.05. Ten thousand datasets were simulated under a beta binomial model with five samples in each group. In order to control the type 1 error rate correctly, the proportion of significant tests should be approximately 0.05 for each cell type. The number in brackets in the first column corresponds to the true cell type proportion, and the cell types are ordered from most rare to most abundant. The bold numbers indicate Type I error estimates &lt; 0.05.</p></caption><table frame="box" rules="all"><thead><tr><th align="left" valign="middle"><bold>Cell type</bold></th><th align="left" valign="middle"><italic>χ</italic><sup>2</sup> test</th><th align="left" valign="middle"><bold>Logistic Bin</bold></th><th align="left" valign="middle"><bold>Poisson</bold></th><th align="left" valign="middle"><bold>Propelle r (asin)</bold></th><th align="left" valign="middle"><bold>Propelle r (logit)</bold></th><th align="left" valign="middle"><bold>BetaBin</bold></th><th align="left" valign="middle"><bold>LRT NegBin</bold></th><th align="left" valign="middle"><bold>QLF NegBin</bold></th><th align="left" valign="middle"><bold>CODA</bold></th></tr></thead><tbody><tr><td align="left" valign="middle"><bold>C1</bold><break/><bold>(0.01)</bold></td><td align="left" valign="middle">0.4501</td><td align="left" valign="middle">0.4605</td><td align="left" valign="middle">0.4589</td><td align="left" valign="middle"><bold>0.0141</bold></td><td align="left" valign="middle">0.0738</td><td align="left" valign="middle">0.0651</td><td align="left" valign="middle">0.0951</td><td align="left" valign="middle">0.0815</td><td align="left" valign="middle">0.0791</td></tr><tr><td align="left" valign="middle"><bold>C2</bold><break/><bold>(0.05)</bold></td><td align="left" valign="middle">0.7238</td><td align="left" valign="middle">0.7268</td><td align="left" valign="middle">0.7198</td><td align="left" valign="middle"><bold>0.0493</bold></td><td align="left" valign="middle">0.0662</td><td align="left" valign="middle">0.0757</td><td align="left" valign="middle">0.1003</td><td align="left" valign="middle">0.0854</td><td align="left" valign="middle">0.0693</td></tr><tr><td align="left" valign="middle"><bold>C3</bold><break/><bold>(0.15)</bold></td><td align="left" valign="middle">0.8142</td><td align="left" valign="middle">0.8155</td><td align="left" valign="middle">0.798</td><td align="left" valign="middle">0.0705</td><td align="left" valign="middle">0.0579</td><td align="left" valign="middle">0.0694</td><td align="left" valign="middle">0.0789</td><td align="left" valign="middle">0.0672</td><td align="left" valign="middle">0.0585</td></tr><tr><td align="left" valign="middle"><bold>C4</bold><break/><bold>(0.34)</bold></td><td align="left" valign="middle">0.8473</td><td align="left" valign="middle">0.8478</td><td align="left" valign="middle">0.816</td><td align="left" valign="middle">0.0774</td><td align="left" valign="middle"><bold>0.0466</bold></td><td align="left" valign="middle">0.0578</td><td align="left" valign="middle"><bold>0.0428</bold></td><td align="left" valign="middle"><bold>0.0364</bold></td><td align="left" valign="middle"><bold>0.0433</bold></td></tr><tr><td align="left" valign="middle"><bold>C5</bold><break/><bold>(0.45)</bold></td><td align="left" valign="middle">0.8552</td><td align="left" valign="middle">0.8563</td><td align="left" valign="middle">0.8041</td><td align="left" valign="middle">0.0746</td><td align="left" valign="middle"><bold>0.0389</bold></td><td align="left" valign="middle"><bold>0.0487</bold></td><td align="left" valign="middle"><bold>0.0254</bold></td><td align="left" valign="middle"><bold>0.0201</bold></td><td align="left" valign="middle"><bold>0.0348</bold></td></tr></tbody></table></table-wrap><table-wrap id="T2" position="float" orientation="portrait"><label>Table 2</label><caption><p>Recall, precision and F1 score for 1000 simulated datasets with 20 cell types. 8 out of 20 cell types differ in abundance between two groups by between 1.4 - 3 fold. Recall, precision and F1 scores were calculated for each of the 1000 simulated datasets, and mean values shown. Bold values highlight best performing method for each metric.</p></caption><table frame="box" rules="all"><thead><tr><th align="left" valign="middle"><bold>Method</bold></th><th align="left" valign="middle"><bold>Recall</bold></th><th align="left" valign="middle"><bold>Precision</bold></th><th align="left" valign="middle"><bold>F1 score</bold></th></tr></thead><tbody><tr><td align="left" valign="middle">propeller(asin)</td><td align="left" valign="middle">0.646125</td><td align="left" valign="middle">0.9085725</td><td align="left" valign="middle">0.7463168</td></tr><tr><td align="left" valign="middle">propeller(logit)</td><td align="left" valign="middle">0.694250</td><td align="left" valign="middle"><bold>0.9161798</bold></td><td align="left" valign="middle">0.7808882</td></tr><tr><td align="left" valign="middle">Beta-binomial</td><td align="left" valign="middle">0.725125</td><td align="left" valign="middle">0.9091364</td><td align="left" valign="middle">0.7984171</td></tr><tr><td align="left" valign="middle">Negative binomial</td><td align="left" valign="middle">0.710500</td><td align="left" valign="middle">0.8972013</td><td align="left" valign="middle">0.7839388</td></tr><tr><td align="left" valign="middle">Quasi-likelihood neg bin</td><td align="left" valign="middle">0.690125</td><td align="left" valign="middle">0.9098287</td><td align="left" valign="middle">0.7756611</td></tr><tr><td align="left" valign="middle">CODA</td><td align="left" valign="middle"><bold>0.794500</bold></td><td align="left" valign="middle">0.8640721</td><td align="left" valign="middle"><bold>0.8197626</bold></td></tr></tbody></table></table-wrap></floats-group></article>