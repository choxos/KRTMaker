<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="ppub"/></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS144182</article-id><article-id pub-id-type="doi">10.1101/2021.08.28.458012</article-id><article-id pub-id-type="archive">PPR388426</article-id><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>SampleQC: robust multivariate, multi-celltype, multi-sample quality control for single cell data</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Macnair</surname><given-names>Will</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="fn" rid="FN1">2</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><contrib contrib-type="author"><name><surname>Robinson</surname><given-names>Mark D.</given-names></name><xref ref-type="aff" rid="A1">1</xref></contrib></contrib-group><aff id="A1"><label>1</label>Department of Molecular Life Sciences and SIB Swiss Institute of Bioinformatics, University of Zurich, Winterthurerstrasse 190, 8057 Zurich, Switzerland</aff><author-notes><corresp id="CR1"><label>*</label> to whom correspondence should be addressed: <email>will.macnair@roche.com</email></corresp><fn id="FN1" fn-type="present-address"><label>2</label><p id="P1">Current address: F. Hoffmann-La Roche Ltd., Pharma Research and Early Development, Neuroscience, Ophthalmology and Rare Diseases, Roche Innovation Center Basel, Grenzacherstrasse 124, 4070 Basel, Switzerland.</p></fn></author-notes><pub-date pub-type="nihms-submitted"><day>06</day><month>04</month><year>2022</year></pub-date><pub-date pub-type="preprint"><day>05</day><month>04</month><year>2022</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P2">Quality control (QC) is a critical component of single-cell RNA-seq (scRNA-seq) processing pipelines. Current approaches to QC implicitly assume that datasets are comprised of one celltype, potentially resulting in biased exclusion of rare celltypes. We introduce <monospace>SampleQC</monospace>, which robustly fits a Gaussian mixture model across multiple samples, and improves sensitivity and reduces bias compared to current approaches. We show via simulations that <monospace>SampleQC</monospace> is less susceptible to exclusion of rarer celltypes. We also demonstrate <monospace>SampleQC</monospace> on a complex real dataset (867k cells over 172 samples). <monospace>SampleQC</monospace> is general, is implemented in R, and could be applied to other data types.</p></abstract></article-meta></front><body><sec id="S1" sec-type="intro"><title>Background</title><p id="P3">Developments in single cell RNA-seq (scRNAseq) technology have enabled experimenters to quantify transcriptional profiles for ever larger and more complex experiments (<xref ref-type="bibr" rid="R1">1</xref>; <xref ref-type="bibr" rid="R2">2</xref>; <xref ref-type="bibr" rid="R3">3</xref>). The transformational nature of single cell RNA-seq is its ability to measure transcriptional expression from nanolitre volumes. However, these tiny volumes result in noisy measurement, and the cells themselves can be strongly affected by the process of measurement. Quality control (QC) is therefore a critical element of pre-processing scRNAseq data: experimenters wish to carefully remove ‘bad’ cells, while minimising both loss of healthy cell datapoints and any bias in the types of cells retained (<xref ref-type="bibr" rid="R4">4</xref>). Cells can be ‘bad’ due to either technical issues such as droplets with unsuccessful reactions, or biological perturbations such as apoptosis. As the size and complexity of experiments increases, doing this for each sample individually becomes more challenging, and researchers require computational assistance to make the task feasible.</p><p id="P4">A fundamental issue with methods aiming to exclude poor quality cells is adequately defining ‘poor quality’. This is both challenging in itself and context-dependent. One approach to defining quality is in terms of the quantity of information provided by a cell, i.e. the number of reads or features. We might then seek to exclude all cells with too few reads. However, if there are sufficiently many of these cells, the total information provided could be enough to perform useful tasks (e.g. using ‘pseudobulk’ approaches to identify genes with differential expression between conditions (<xref ref-type="bibr" rid="R5">5</xref>; <xref ref-type="bibr" rid="R6">6</xref>)). Similarly, high proportions of mitochondrial reads are associated with stressed and apoptotic cells (<xref ref-type="bibr" rid="R7">7</xref>), and excluding cells on the basis of high mitochondrial proportion (e.g. cells with greater than 5% mitochondrial reads in mice, or greater than 10% in human cells; (<xref ref-type="bibr" rid="R8">8</xref>)) is a recommended approach to QC (<xref ref-type="bibr" rid="R4">4</xref>; <xref ref-type="bibr" rid="R9">9</xref>). However, analysis of healthy tissue shows that the proportion of mitochondrial reads shows strong variation across both species and tissue type (<xref ref-type="bibr" rid="R8">8</xref>), suggesting that this fixed-threshold strategy may exclude healthy cells and fail to exclude relatively stressed cells. Users may prefer more sensitive approaches that do not give hard assessments of cell quality, but give them the power to decide which are the unwanted cells.</p><p id="P5">Based on the various tutorials available, the current industry standards for QC are <monospace>scater</monospace> (<xref ref-type="bibr" rid="R10">10</xref>) and <monospace>Seurat</monospace> (<xref ref-type="bibr" rid="R11">11</xref>), both of which are data-driven rather than based on a fixed threshold. In addition, a probabilistic method <monospace>miQC</monospace> was recently introduced (<xref ref-type="bibr" rid="R12">12</xref>). All three of these are unimodal (<monospace>scater</monospace> and <monospace>Seurat</monospace> are also univariate in typical use). <monospace>scater</monospace> and <monospace>Seurat</monospace> function by calculating robust measures of centre and scale (such as median and median absolute deviation, or MAD) for each QC metric, then discarding cells that are a specified number of deviations away from the centres. They are typically applied individually to each sample, which we find may introduce bias. Most importantly, where samples are composed of multiple celltypes whose QC metric distributions differ (e.g. they have lower counts, or higher mitochondrial proportions), such filtering will preferentially exclude cells from the celltypes with more extreme values, leading to a bias towards excluding cells from particular celltypes. This was noted by Germain <italic>et al</italic>., who found that stringent filtering on all cells simultaneously led to exclusion of cells that have extreme QC metrics, but not poor quality cells (<xref ref-type="bibr" rid="R13">13</xref>). <monospace>miQC</monospace> is multivariate, assuming that the relationship between features detected and mitochondrial proportion is different in healthy cells and in ‘compromised’ cells. This approach is also unimodal, and may therefore also suffer from a bias against extreme celltypes. Germain <italic>et al</italic>. also found that filtering was necessary, as lenient filtering led to poorer downstream performance (as measured by clustering). Taken together, these findings motivate the need for a QC filtering tool that allows for the presence of multiple celltypes.</p><p id="P6">As the size of scRNAseq experiments increases, so does their complexity, resulting in ever-higher numbers of conditions and samples measured per experiment (<xref ref-type="bibr" rid="R14">14</xref>). This increases the challenge of doing sensitive QC, e.g. by manually deciding a threshold for each sample. In addition, it is important to measure experimental quality at a <italic>sample</italic> and not just a cell level. An experimenter may wish to make comparisons between samples deriving from multiple experimental conditions; this requires establishing that there are sufficient high quality samples of each desired condition.</p><p id="P7">To address these problems, we have developed <monospace>SampleQC</monospace>, a computational method designed for QC of large scRNAseq experiments with complex designs. <monospace>SampleQC</monospace> is implemented as an <monospace>R</monospace> package based on a robust multivariate Gaussian mixture model (GMM). By fitting a mixture model in which each of the mixture components corresponds to one ‘QC celltype’, <monospace>SampleQC</monospace> identifies the QC distributions for multiple celltypes simultaneously, removing the bias towards excluding healthy celltypes with extreme QC metric values. We use a fitting procedure that is statistically robust, in the sense that it expects outliers to be present and inference is not distorted by them. By allowing each sample to have its own ‘sample shift’ term, <monospace>SampleQC</monospace> fits simultaneously across multiple samples, which both increases statistical power and automates an otherwise tedious process. This addresses not only problems with sensitivity of outlier detection, but also provides sample-level QC outputs. Finally, <monospace>SampleQC</monospace> provides a comprehensive, automatically-generated report on cell and sample quality.</p></sec><sec id="S2" sec-type="results"><title>Results</title><sec id="S3"><title><monospace>SampleQC</monospace> overview</title><p id="P8">Examining the distributions of QC metrics across many single-cell experiments, we observed that the values for a given sample would typically follow a multivariate Gaussian mixture distribution, i.e. groups of cells concentrated around distinct mean values, with distances from these mean values following approximately ellipsoid densities (<xref ref-type="supplementary-material" rid="SD1">Figure S1</xref>). We also observed that multiple samples often showed approximately the same distribution, subject to a sample-level shift in values, i.e. the individual values might be on average higher or lower than other samples, but the shapes of the ellipsoids and the relative distances between their means remained approximately the same (<xref ref-type="supplementary-material" rid="SD1">Figure S1</xref>). This motivated the following model to describe the metrics: for a cell <italic>i</italic> from sample <italic>j</italic>, which is a member of QC celltype <italic>k</italic> (<italic>k</italic> is not known), <italic>X</italic><sub><italic>i</italic></sub> ∼ <italic>N</italic> (<italic>α</italic><sub>0</sub> + <italic>α</italic><sub><italic>j</italic></sub> + <italic>β</italic><sub><italic>k</italic></sub>, Σ<sub><italic>k</italic></sub>), where <italic>X</italic><sub><italic>i</italic></sub> is the vector of QC metrics, <italic>α</italic><sub>0</sub> is the global mean, <italic>α</italic><sub><italic>j</italic></sub> is the mean shift of sample <italic>j</italic> relative to the global mean, and (<italic>β</italic><sub><italic>k</italic></sub>, Σ<sub><italic>k</italic></sub>) describe mean and variance-covariance of mixture component <italic>k</italic>. Finally, we observed that across large experiments, not all samples would follow the same mixture distribution, but that the samples could be grouped into ‘sample groups’ with similar distributions of QC metrics.</p><p id="P9">For the metrics to follow a Gaussian mixture model, it is important that the marginal distributions of unimodal data are approximately Gaussian. This is dependent on appropriate transformations of the data, that allow non-Gaussian metrics to be transformed into spaces where they are approximately Gaussian. Applying <monospace>log</monospace> transformations to library sizes and genes detected is common practice; in addition, we have found that applying the <monospace>logit</monospace> (inverse logistic) transform to mitochondrial proportions often results in approximately Gaussian distributions (<xref ref-type="supplementary-material" rid="SD1">Figure S2</xref>). These observations suggest that, after appropriate transformations, a Gaussian mixture model may be a reasonable description of the data.</p><p id="P10">We assumed that the components of the mixture model represent ‘QC celltypes’, where cells at the centres of the distributions are good quality, and cells that are unusually distant from these centres are cells with extreme QC metric values that should be discarded. In addition, we sought to identify entire samples that were very different from most samples, to flag these to the user for possible exclusion. This motivated an outlier detection algorithm based on the following two steps: (<xref ref-type="bibr" rid="R1">1</xref>) identifying groups of samples whose multivariate QC values approximately follow the same distributions; and (<xref ref-type="bibr" rid="R2">2</xref>) within each of these, fitting a multivariate GMM to identify cell-level outliers. These steps are outlined in <xref ref-type="fig" rid="F1">Figure 1</xref>.</p><p id="P11">To identify groups of samples with similar distributions, <monospace>SampleQC</monospace> uses a non-parametric statistical measure of dissimilarity between multivariate samples, maximum mean discrepancy (MMD: (<xref ref-type="bibr" rid="R15">15</xref>)), to estimate ‘distances’ between samples. MMD takes two samples as input, which must have the same dimensions but may have different numbers of observations, and calculates a measure of distance/dissimilarity that summarizes differences in means, (co)variances and higher moments. We then use pairwise distances to construct a nearest neighbour graph that allows the identification of ‘sample groups’, i.e. groups of samples following approximately the same QC metric distributions. We use Louvain clustering to identify the groups (<xref ref-type="bibr" rid="R16">16</xref>). The distances are also used as input to dimensionality reduction techniques, such as multidimensional scaling (MDS: (<xref ref-type="bibr" rid="R17">17</xref>)) and UMAP (<xref ref-type="bibr" rid="R18">18</xref>). This gives low-dimensional embeddings where each point corresponds to a sample, and permit users to check for batch effects or other issues with the data. For example, users can check the extent to which samples from the same batch are clustered together, potentially indicating sample quality problems with a batch.</p><p id="P12">The second step identifies cell outliers, i.e. cells with very different QC metric values to most other cells. Additionally, this step checks for outlier samples by estimating the mean shift in QC statistics for each sample. After <monospace>SampleQC</monospace> has identified sample groups, the user then determines how many components are present in each sample group by inspecting the QC distributions within each group, i.e. how many components the GMM should have. <monospace>SampleQC</monospace> then fits a robust GMM to the cells in each sample group.</p><p id="P13">Our GMM makes two main assumptions: (<xref ref-type="bibr" rid="R1">1</xref>) the configuration of QC celltypes (i.e. their covariance matrices and relative means) is constant across the samples in a sample group; and (<xref ref-type="bibr" rid="R2">2</xref>) each sample has a uniform shift in (transformed) QC metrics. Our justification for these assumptions is the observations on distributions of QC metrics discussed above, and the empirical performance of the method, although reasonable biological arguments can also be made for them. The model allows the proportions of QC celltypes (i.e. mixture components) to vary by sample; details of the mathematical model are discussed in Methods (see <monospace>SampleQC</monospace> model). This model structure, in which the same QC celltypes are assumed to be present in every sample, has benefits when identifying outlier cells. The model learns the parameters for the QC celltype components across the <italic>whole</italic> sample group, so that even when a sample has only a small proportion of a given QC celltype, these cells are not regarded as outliers. These cells may in fact be of particular interest, being from a celltype with reduced proportion relative to other samples.</p><p id="P14">We fit this model to identify poor quality cells, namely those that are outliers with respect to the distribution of the bulk of cells. While the presence of outliers is known to affect the estimation of statistics, especially higher order moments such as covariance (<xref ref-type="bibr" rid="R19">19</xref>), accurate estimation of the covariance matrices is essential precisely for identifying those outliers. We therefore use a <italic>robust</italic> estimation of the mean and covariance matrices (<xref ref-type="bibr" rid="R20">20</xref>): robust estimators (like the MAD) give good but slightly less than optimal results when the data do follow an assumed distribution, but are also guaranteed to give good results when the data is contaminated and MLEs may fail (<xref ref-type="bibr" rid="R19">19</xref>). We explicitly assume that outliers may be present, making this approach necessary.</p><p id="P15">Once we have fit models to each sample group, <monospace>SampleQC</monospace> is able to describe all cells in the included samples in terms of mixture components, which we assume to represent good quality cells. We can then identify outlier cells by calculating a statistical measure of distance from the centre of each QC celltype (Mahalanobis distance, which indicates how unlikely a particular observation is under a <italic>χ</italic><sup>2</sup> distribution), and exclude cells that are unlikely to be a member of any component.</p></sec><sec id="S4"><title>Simulating QC data for a large experiment</title><p id="P16">With single cell data, there is no ground truth regarding which cells or samples are poor quality, making assessment of the performance of QC methods challenging. To evaluate <monospace>SampleQC</monospace> against other approaches, we therefore developed a simulation framework that replicates the distributions of QC metrics observed in biological datasets (pseudocode provided in Methods; see Simulations). The framework and parameters are derived from large and complex experimental designs, including outliers, and are based on a hierarchical model.</p><p id="P17">At the experiment level, we make the following assumptions: (<xref ref-type="bibr" rid="R1">1</xref>) the experiment is composed of a number of sample groups with similar QC distributions; (<xref ref-type="bibr" rid="R2">2</xref>) there are a small number of ‘QC celltypes’ present in the experiment. By ‘QC celltype’, we mean a cluster of cells that is distinct within ‘QC space’, i.e. the selected QC metrics. We expect that multiple true celltypes, i.e. clusters that are distinct in terms of expression, may have the same distribution in QC terms. These QC celltypes are assumed to be common across all groups of samples, with a different subset present in each sample group. For each group, we randomly sample samples and cells, and which celltypes are present. We also sample the means and covariances for the QC celltypes, {<italic>β</italic><sub><italic>k</italic></sub>, Σ<sub><italic>k</italic></sub>}.</p><p id="P18">Within each sample group, we then model outliers and sample shifts at the level of samples. We assume that for each sample <italic>j</italic>, there is a uniform shift in the (transformed) QC metrics, <italic>α</italic><sub><italic>j</italic></sub>. This affects all cells in a sample equally. We also assume that each sample has different proportions of the QC celltypes, sampled from a Dirichlet distribution. Each sample has a different proportion of outliers, modeled as a beta distribution, which gives all samples from the same group outlier proportions that vary around a common mean value. Outliers are assumed to differ from ‘good’ cells by having lower non-mitochondrial reads and numbers of features, and correspondingly higher mitochondrial proportions; we model this by a sample-level parameter corresponding to the proportion of non-mitochondrial reads lost (modelled as a logistic normal).</p><p id="P19">For every cell, we have annotations of sample group (<italic>g</italic>), sample (<italic>j</italic>) and QC celltype (<italic>k</italic>), with corresponding values of global mean (<italic>µ</italic><sub><italic>g</italic></sub>), sample shift (<italic>α</italic><sub><italic>j</italic></sub>) and QC celltype mean and covariance (<italic>β</italic><sub><italic>k</italic></sub> and Σ<sub><italic>k</italic></sub>). We draw a healthy QC metric vector for a given cell via a multivariate normal with mean <italic>µ</italic><sub><italic>g</italic></sub> + <italic>α</italic><sub><italic>j</italic></sub> + <italic>β</italic><sub><italic>k</italic></sub>, and covariance Σ<sub><italic>k</italic></sub>. We then determine whether this cell is an outlier via a Bernoulli distribution, and if it is, we perturb this value by downsampling the non-mitochondrial reads and the QC metrics are updated accordingly.</p><p id="P20">This approach follows the model assumed by the GMM (<monospace>SampleQC</monospace> model), with two additional points to make the simulations more challenging. Firstly, the GMM does not include any outliers. To model these, we assume that each sample has a given proportion of outlier cells, selected at random. For each of these cells, the non-mitochondrial reads and the number of features are decreased by a given proportion, according to a beta distribution. This results in both a reduction in total counts and features, and an increase in mitochondrial proportion, consistent with outliers observed in real data. Secondly, we assume that the relative positions of the components, {<italic>β</italic><sub><italic>k</italic></sub>}, are not identical in each sample, and vary by a small amount, <italic>δ</italic><sub><italic>jk</italic></sub>.</p><p id="P21">This results in simulated QC metrics for tens of thousands of cells across tens of samples, where the distributions of these metrics vary coherently across different groups of samples. The simulations provide two matrices of QC metrics: one that mimics the QC values we might see from experiments, and one for the QC values of the cells ‘before’ they became low quality (such a matrix would never be observed in real life).</p></sec><sec id="S5"><title>Benchmarking <monospace>SampleQC</monospace> against <monospace>scater</monospace> and <monospace>miQC</monospace> on simulated data</title><p id="P22">We generated simulated data for an experiment with 100,000 cells across multiple samples, resulting in 64 samples with a median of 1,300 cells per sample, including outliers. We then ran <monospace>SampleQC</monospace>, <monospace>scater</monospace> and <monospace>miQC</monospace> to compare performance: both in terms of excluding outliers, and retaining ‘good’ cells. Inspecting the distributions of the outliers identified by the different methods, we observe that where multiple QC celltypes are present, <monospace>SampleQC</monospace> identifies outliers correctly, while both <monospace>scater</monospace> and <monospace>miQC</monospace> may preferentially exclude cells from one QC celltype as outliers (<xref ref-type="fig" rid="F2">Figure 2</xref>). Where only one QC celltype is present, <monospace>SampleQC</monospace>, <monospace>scater</monospace> and <monospace>miQC</monospace> show similar results (<xref ref-type="supplementary-material" rid="SD1">Figure S3</xref>), as expected.</p><p id="P23">When we assess performance in identifying good cells across the entire simulated dataset, we find that <monospace>SampleQC</monospace> has equal or better performance than both <monospace>scater</monospace> and <monospace>miQC</monospace> for both precision and recall (<xref ref-type="fig" rid="F3">Figure 3A</xref>, <xref ref-type="supplementary-material" rid="SD1">Figure S4</xref>). The relative performance on individual samples is affected by how many celltypes are present in the sample. Where the data is multimodal, the multimodal model in <monospace>SampleQC</monospace> gives it equal or better performance than <monospace>scater</monospace> and <monospace>miQC</monospace> for both precision and recall (<xref ref-type="supplementary-material" rid="SD1">Figure S4</xref>, <xref ref-type="supplementary-material" rid="SD1">Figure S5</xref>). Where the data is unimodal (i.e. has one mixture component), <monospace>scater</monospace> and <monospace>SampleQC</monospace> show similar performance (<xref ref-type="fig" rid="F3">Figure 3B</xref>). In this case, performance of <monospace>miQC</monospace> is slightly worse, potentially because it assumes that a reasonable quantity of ‘compromised’ cells must be present; when there are only few such cells, this may result in ‘good’ cells reported as outliers.</p><p id="P24">Importantly, <monospace>SampleQC</monospace> also shows better performance than the compared methods in terms of celltype bias. As above, when one QC celltype is present in a sample, <monospace>SampleQC</monospace> and <monospace>scater</monospace> have very similar biases in excluding good cells at default settings. However, when multiple QC celltypes are present in a sample, <monospace>SampleQC</monospace> excludes similar numbers of good cells, and shows low bias towards any particular QC celltype. In this setting, the good cells mistakenly excluded by both <monospace>miQC</monospace> and <monospace>scater</monospace> are almost entirely comprised of one celltype, while <monospace>SampleQC</monospace>’s more flexible model better preserves rare QC celltype proportions. We note that these results are dependent on the choices made in developing the simulation, and that alternative reasonable choices may give different results.</p><p id="P25">We performed the same comparisons for simulations where the data is t-distributed, and found similar differences in performance between the methods (see dashed lines in <xref ref-type="supplementary-material" rid="SD1">Figure S4</xref>).</p></sec><sec id="S6"><title>Number of QC clusters</title><p id="P26">Determining the appropriate number of distinct clusters in a dataset is a well-studied problem in statistics that remains challenging (<xref ref-type="bibr" rid="R21">21</xref>). To avoid this problem, <monospace>SampleQC</monospace> requires users to specify the number of mixture components for each group of samples. We simulated experiments to test the sensitivity of our results to mismatches between the selected and true <italic>k</italic>. We simulated data with different true numbers of QC celltypes, varying over 1, 2 and 3 QC celltypes (our observation over many studies has been that many samples have between 1 and 4 mixture components). For each value of <monospace>k_true</monospace>, we simulated data for 20,000 cells divided into samples, with an average of 2000 cells per sample. We then fit <monospace>SampleQC</monospace> to each dataset, with the assumed number of clusters <monospace>k_fit</monospace> varying between 1 and 4. We found that a mismatch between <monospace>k_true</monospace> and <monospace>k_fit</monospace> could result in a reduction in performance (while <monospace>SampleQC</monospace> performed well when <monospace>k_fit</monospace> was correctly specified) (<xref ref-type="supplementary-material" rid="SD1">Figure S7</xref>). However, for multiple of the combinations where <monospace>k_fit</monospace> was misspecified, <monospace>SampleQC</monospace> was not able to fit; this provides some protection in itself. These results indicate that review of the diagnostic plots rendered by <monospace>SampleQC</monospace> is an important part of the QC process, allowing users to determine plausible values of <italic>k</italic> from the empirical distributions.</p></sec><sec id="S7"><title>Applying <monospace>SampleQC</monospace> to complex biological datasets</title><p id="P27">We applied <monospace>SampleQC</monospace> to a large single-nuclei RNA-seq dataset comprising 867k cells over 172 samples (see Data availability), taken from human brain tissue, including samples from patients with neurodegenerative conditions. This illustrates an intended use case for <monospace>SampleQC</monospace>: a dataset with sufficiently many samples to make it challenging to adjust outlier thresholds for each sample individually, and where complex batch effects could be present. Here, we use log library size, logistic transform of mitochondrial proportion; and log2(spliced reads / unspliced reads) as QC metrics. The motivation for using log splice ratio in single nuclei data comes from the difference in abundance of unspliced reads between the nucleus and the cytoplasm (<xref ref-type="bibr" rid="R22">22</xref>). In principle, unspliced reads should only be present in the nucleus; high ratios of spliced to unspliced read counts therefore allow us to identify nuclei that were not successfully stripped of their cytoplasm, and are likely to be contaminated. In addition, this demonstrates the flexibility of <monospace>SampleQC</monospace>, which only assumes that multiple QC celltypes are present, and does not require specific metrics to be used.</p><p id="P28"><monospace>SampleQC</monospace> first identifies samples with similar QC distributions, by calculating pairwise MMD distances between the samples. The principle reason for this is to allow <monospace>SampleQC</monospace> to fit separate models to each group of individual samples. Low dimensional projections of the resulting dissimilarities are shown in <xref ref-type="fig" rid="F4">Figure 4</xref> (UMAP) and <xref ref-type="supplementary-material" rid="SD1">Figure S8</xref> (MDS), showing the groups identified by <monospace>SampleQC</monospace> (<xref ref-type="fig" rid="F4">Figure 4A</xref>), allowing investigators to assess whether sample source, sequencing run or other covariates might have influenced sample quality (<xref ref-type="fig" rid="F4">Figure 4B</xref>). Investigators can also check whether there are groups of samples that should be excluded entirely due to poor quality.</p><p id="P29">Applying <monospace>SampleQC</monospace> to this dataset shows similar results to those for the simulation: where a cell population is present in the whole dataset but only makes up a small proportion of a sample, <monospace>SampleQC</monospace> is better able to preserve these cells than <monospace>scater</monospace> and <monospace>miQC</monospace> (<xref ref-type="fig" rid="F5">Figure 5</xref>). The Mahalanobis distances calculated under the <monospace>SampleQC</monospace> model also follow the expected distribution, i.e. most points follow a Chi-squared distribution with degrees of freedom equal to the number of dimensions, plus an outlier component with larger distances (<xref ref-type="supplementary-material" rid="SD1">Figure S9</xref>).</p><p id="P30">An alternative approach to QC for single cell data is to apply only a minimal filter on QC metrics (to remove droplets that contain very little information and / or contain only lysed cells), cluster the cells as is normal for single cell, then remove clusters that show poor QC metrics. This approach works for some datasets, however it may become difficult to apply in more challenging samples. Applying this approach to single cell data from ovarian cancer tissue (<xref ref-type="bibr" rid="R12">12</xref>), we found that while some of the clusters should clearly be excluded, other clusters showed a wide range of QC metrics (<xref ref-type="supplementary-material" rid="SD1">Figure S11</xref>). For example, clusters K06, K07 and K08 all include substantial numbers of cells with mitochondrial percentages both above 25% and below 10%, showing that this approach to excluding poor quality cells may be more difficult in samples not comprising healthy cells.</p><p id="P31">Although <monospace>SampleQC</monospace> is a more complex model than other approaches to QC, this does not substantially decrease speed. As an illustration, we timed <monospace>SampleQC</monospace> on the simulated dataset in <xref ref-type="fig" rid="F3">Figure 3</xref>, comprising 100k cells over 64 samples. The three steps of <monospace>SampleQC</monospace> took the following times: 44s to calculate pairwise MMDs; 70s to fit the <monospace>SampleQC</monospace> models; and 104s to render the report.</p><p id="P32">The methodology underlying <monospace>SampleQC</monospace> is general, and not specific to scRNAseq. The example above demonstrates its application to single nuclei RNAseq, and in principle it can identify outliers in any dataset comprising a small set of mixture components described by a small set of variables. This includes other single cell technologies, such as CITE-seq, which is similar to scRNAseq but also quantifies protein expression via oligo-tagged antibodies (<xref ref-type="bibr" rid="R23">23</xref>), and scATACseq, which quantifies chromatin accessibility in single cells (<xref ref-type="bibr" rid="R24">24</xref>). To demonstrate this, we ran <monospace>SampleQC</monospace> on CITE-seq data from PBMCs (<xref ref-type="bibr" rid="R25">25</xref>), using similar QC metrics to scRNAseq: log RNA counts; log RNA features; logistic transform of mitochondrial proportion; log ADT (protein) counts; log ADT features. The models fit by <monospace>SampleQC</monospace> successfully converged to the modes of the data, and could be used for outlier detection (<xref ref-type="supplementary-material" rid="SD1">Figure S10</xref>).</p></sec></sec><sec id="S8" sec-type="discussion"><title>Discussion</title><p id="P33">We introduced <monospace>SampleQC</monospace>, an approach for quality control of scRNAseq experiments that improves on the current industry standard, and is designed for large and complex experimental designs. We show that our model simultaneously allows flexibility and sensitivity, and reduces bias. Grouping samples by similarity of QC metric distributions allows a different model to be used for each sample group, which then increases sensitivity by borrowing strength across samples.</p><p id="P34">One of the main challenges in this work is the lack of ground truth to evaluate methods. For this reason, previous QC filtering methods have not performed comprehensive benchmarks. Meanwhile, most datasets are annotated to celltypes after filtering and therefore not annotated as good/bad for such an assessment. And while filtering is necessary at some level, it is also not always straightforward to assign a reason for a cell’s exclusion. For example, many of the excluded cells according to <monospace>SampleQC</monospace> are in low-density regions, but it could be they are not too extreme in each univariate QC metric, but reside in a low-density region in a multivariate sense. Furthermore, none of the tools available for QC filtering, including <monospace>SampleQC</monospace>, perform rigorous validation that low-quality cells are truly removed.</p><p id="P35">Our method is based on empirical observations of real data, and is motivated by known biological mechanisms. Many single cell techniques assume that scRNAseq data comprises multiple celltypes that are distinct in terms of gene expression, however this is not reflected in current approaches to QC. Metrics used for quality control are functions of the full expression vector of counts. When multiple celltypes are present in the full expression data, our observations over multiple datasets are that at least some separation into ‘QC celltypes’ is typically preserved in the restricted ‘QC space’. Our motivations regarding outliers, i.e. that they form a small proportion of the dataset with lower read counts and higher mitochondrial proportions, are also consistent with this observation. <monospace>SampleQC</monospace> allows users to choose any metric for input, and if the selected metrics approximately follow a GMM, the approach should produce sensible outputs. A GMM is a reasonable model given that single cell data is known to often form clusters, and we have shown that the individual metrics (after appropriate transformations) typically follow Gaussian distributions. Non-Gaussian and non-parametric approaches to outlier detection could also be considered, such as estimating cell densities in QC space and then excluding cells in sparsely populated regions. However, this would risk excluding cells that were only rare in that sample, and our observations suggest that a GMM is reasonable for various experiments. By fitting one model across multiple samples, <monospace>SampleQC</monospace> is able to preserve celltypes that are abundant in some samples, but have low abundance in others and are therefore discarded by methods that operate only at the sample level.</p><p id="P36">Although the downstream effects of choice of QC metrics are not well understood, there are good biological motivations for the metrics currently in use. Low library sizes indicate droplets where the cell lysed before the reaction took place, droplets that contain only debris, or where the reaction was not successful, while high library sizes may correspond to multiple cells in one droplet. Number of features observed is highly correlated with library size, and therefore the same mechanisms for cell quality are relevant. Mitochondrial proportion may be high in cells that are stressed, or that lysed partially before measurement (resulting in a loss of cytoplasmic RNA and corresponding increased proportion of mitochondrial RNA); in single nuclei RNA-seq, the process of preparing nuclei should wash away mitochondria, meaning that mitochondrial reads may indicate contamination by ambient RNA. The relative proportion of spliced to unspliced reads indicates the relative abundances of nuclear and cytoplasmic RNA in a droplet (<xref ref-type="bibr" rid="R22">22</xref>). Unspliced reads should only be present in the nucleus; high ratios of spliced to unspliced read counts in single nuclei data therefore allow us to identify nuclei that were not successfully stripped of their cytoplasm, and are likely to be contaminated; meanwhile in single <italic>cell</italic> RNA-seq data, high proportions of unspliced (nuclear) RNA may indicate lysed cells. We expect that as new technologies are developed, new QC metrics will accompany them.</p><p id="P37">We have demonstrated <monospace>SampleQC</monospace> on standard measures of cell quality. However, the model is flexible, and can be applied to any set of metrics specified by the user that approximately follow a Gaussian mixture distribution. We also note transformations that allow non-Gaussian metrics to be transformed into spaces where they are more likely to be Gaussian. For example, <monospace>SampleQC</monospace> transforms mitochondrial proportions via the logit function, and spliced:unspliced ratios via log. <monospace>SampleQC</monospace> is effectively a general outlier detection technique for GMMs, and this should allow <monospace>SampleQC</monospace> to be applied to datasets with other or multiple modalities. We have applied <monospace>SampleQC</monospace> to CITEseq (<xref ref-type="supplementary-material" rid="SD1">Figure S10</xref>), but in principle, the framework can be applied to data from scATACseq (<xref ref-type="bibr" rid="R24">24</xref>), scCATseq (<xref ref-type="bibr" rid="R26">26</xref>), single cell techniques based on combined modalities, and spatial transcriptomics, by selecting appropriate measures (e.g., antibody tag depths for CITE-seq, sparseness for scATAC-seq, etc.). More exploration may be required to identify the set of QC measures that are sufficient to filter questionable cells, also because many existing measures are highly correlated, which could mean they are redundant.</p><p id="P38">QC does not need to be conducted entirely at the filtering stage. Another option is to carry forward more cells to a clustering/annotation step and then filter out subpopulations that are of debatable quality, assuming some biological knowledge can be used to assign this. And here, it is difficult to know if there is a clear “optimal” path. On the one hand, including more sparser cells may have adverse effects on similarity calculations, estimation of highly-variable genes, or on the low dimensional projections that clustering is based on; on the other hand, <monospace>SampleQC</monospace> summaries (e.g., P-values representing cells in low-density regions of their QC space) could be used afterwards as indicators for removal of individual clusters. The effect of including sparse cells on direct cell type annotation methods is not well studied. Furthermore, it is not clear at what point entire samples should be removed from downstream analysis; while <monospace>SampleQC</monospace> gives useful visualizations to characterize the QC of many samples, a judgement call is still needed.</p><p id="P39">It is worth noting that our performance results depend on the choices made in implementing the simulation, largely because we are not aware of other frameworks to simulate scRNA-seq QC summaries. Ultimately, our simulation highlights that inference from our model is possible, but does not directly show that cells are ‘bad’. While we tried to represent parameters and phenomena observed based on our experience in large scRNA-seq datasets, further development of the simulation framework would be desirable. We note that as the underlying models for both <monospace>scater</monospace> and <monospace>miQC</monospace> are unimodal, any circumstance where there are multiple distinct healthy cell populations may result in a performance advantage for <monospace>SampleQC</monospace>.</p><p id="P40">We do not provide any statistical guarantees that <monospace>SampleQC</monospace> converges to the optimal solution. However, <monospace>SampleQC</monospace> does provide automatically generated and comprehensive reports that show the fitted model over the empirical density. The models defined are conceptually simple, and the reports should therefore allow users to check both the validity of the fits and the appropriate number of clusters for each group.</p><p id="P41">We also do not attempt to solve the problem of selecting the appropriate value of <italic>k</italic>; this is a challenging and extensively-discussed problem in statistics (<xref ref-type="bibr" rid="R21">21</xref>). As noted above, the automatic reports allow users to inspect whether the model has fit appropriately. In addition, using robust estimators makes the procedure less sensitive to misspecification of the number of components: robust methods expect some of the data to be outliers, and therefore do not attempt to ‘explain’ all data; non-robust methods attempt to explain the whole dataset, and where the number of components is misspecified, the estimated means may lie between components.</p><p id="P42">As experiments increase in size and complexity, the task of removing unwanted cells becomes correspondingly more challenging, especially if users would like to preserve rarer populations. <monospace>SampleQC</monospace> attempts to solve this problem, by first identifying groups of samples with similar QC distributions, then fitting an empirically motivated statistical model to the QC metric data for each group. The model is simple, meaning that it is fast to fit and easy to check. This allows users to obtain an overview of data quality for their entire experiment, and to accurately identify cells for exclusion without having to make decisions regarding every sample individually. Our intention is to provide a fast, flexible and easy-to-use method that allows investigators to do quality control with minimal loss of their valuable data.</p></sec><sec id="S9" sec-type="methods"><title>Methods</title><sec id="S10"><title><monospace>SampleQC</monospace> model</title><p id="P43"><monospace>SampleQC</monospace> is based on standard approaches to identifying GMMs, with two important changes. Firstly, the model includes terms that are sample-specific: each sample has a sample shift term, i.e. a uniform change in values applying to all cells in a given sample. In addition, while we assume that each sample has the same mixture components (= QC celltypes), the <italic>proportion</italic> of these components may vary within each sample. For cell <italic>i</italic>, which comes from sample <italic>j</italic> in QC celltype <italic>k</italic>, this gives us the following model for the QC values <italic>X</italic><sub><italic>i</italic></sub>:</p><p id="P44"><italic>X</italic><italic><sub>i</sub></italic> ∼ <italic>N</italic>(α<sub>0</sub> + α<sub>j</sub> + β<italic><sub>k</sub></italic>, ∑<italic><sub>k</sub></italic>) and        (1)</p><p id="P45"><italic>P</italic>(<italic>Z</italic><italic><sub>i</sub></italic> = <italic>k</italic>|<italic>s</italic><italic><sub>i</sub></italic> = <italic>j</italic> = <italic>p</italic><italic><sub>jk</sub></italic>)                       (2)</p><p id="P46">where</p><p id="P47"><italic>s</italic><sub><italic>i</italic></sub> = <italic>j</italic>, cell <italic>i</italic> is from sample <italic>j</italic></p><p id="P48"><italic>Z</italic><sub><italic>i</italic></sub> = <italic>k</italic>, cell <italic>i</italic> is in mixture component <italic>k</italic></p><p id="P49">        <italic>α</italic><sub><italic>j</italic></sub> sample shift for sample <italic>j</italic></p><p id="P50">        <italic>β</italic><sub><italic>j</italic></sub> mean for mixture component <italic>k</italic></p><p id="P51">        Σ<sub><italic>j</italic></sub> covariance matrix for mixture component <italic>k</italic></p><p id="P52">        <italic>p</italic><sub><italic>jk</italic></sub> mixing proportions in sample <italic>j</italic></p><p id="P53">Secondly, the fit is robust, in the sense that it is less sensitive to outliers. The standard approach to fitting GMMs is via expectation-maximization, where the method alternates between fixing the means and covariance matrices then identifying the expected values for the latent cluster variables (‘expectation’), and fixing the latent cluster variables then calculating the maximum likelihood estimators (MLEs) for the means and covariances (‘maximization’). This approach assumes that all observations come from the GMM distribution. If the data is contaminated by a small proportion of observations that do not come from the assumed distribution (outliers), then this procedure may fail, especially regarding estimation of covariance matrices, in turn affecting cluster membership identification (<xref ref-type="bibr" rid="R19">19</xref>). To mitigate this problem, we use a robust method to estimate the means and covariance matrices, based on using the points nearest the centre of the component (<xref ref-type="bibr" rid="R20">20</xref>). Robust estimators are designed to return good results even in the presence of outliers, which is especially important when the principle assumption of our task is that outliers may be present.</p><p id="P54">In addition to identifying outlier cells, fitting the GMM gives in estimated statistics as outputs, namely: the QC metric shift for each sample (Q)<sub>j</sub> the location and shape of each mixture component, and the proportions of the components in each sample (<italic>p</italic><sub><italic>jk</italic></sub>). These can be used to identify samples with markedly different statistics to others in their sample group, both in terms of mean QC values, and in terms of the split of cells across QC celltypes. These samples are therefore flagged to experimenters for detailed checking and potential exclusion.</p></sec><sec id="S11"><title>Criteria for outliers</title><p id="P55">In the software (see below), the user can also specify the threshold of the <italic>χ</italic><sup>2</sup> distribution to determine the how stringent the outlier exclusion should be. In particular, under the null of no outliers, the Mahalanobis distance (to the centre of the nearest GMM component) should follow a <italic>χ</italic><sup>2</sup> distribution (with degrees of freedom equal to the number of QC metrics used as input). Large distances are therefore by definition very unlikely under the GMM model and represent the candidates to filter out. This can be achieved by setting a threshold on the tail of the <italic>χ</italic><sup>2</sup> distribution</p></sec><sec id="S12"><title>Software</title><p id="P56">The input to <monospace>SampleQC</monospace> is a data.frame where each row corresponds to a cell; the columns must contain the chosen QC metrics and sample labels, and can optionally also include additional sample annotations such as batch or experimental condition. <monospace>Using a data.frame</monospace> as input makes the software accessible to users of both the <monospace>SingleCellExperiment</monospace> and <monospace>Seurat</monospace> packages (and, by saving intermediate files as CSV, to users of <monospace>scanpy</monospace>). Please see the user guide for further details.</p><p id="P57">Prior to running <monospace>SampleQC</monospace>, we recommend excluding empty droplets, for example by running emptyDrops with either the default or a more generous cutoff, to ensure that all genuine cells are included. This may result in some empty droplets being used as input to <monospace>SampleQC</monospace>, but they should be identified as outlier cells and later excluded.</p><p id="P58">We then recommend removing multiplets <italic>before</italic> running <monospace>SampleQC</monospace> for two principal reasons. Firstly, excluding low quality cells first assumes that all doublets are composed of two good quality cells; by excluding low quality cells first, it is then more difficult to detect doublets comprising one good quality and one low quality cell. Secondly, just as the count vectors for doublets are linear combinations of two true cells, their QC metric values are also functions of combinations of two true cells. The practical impact of this is that doublets introduce a small amount of noise to the QC metric distributions; excluding them results in cleaner distributions that are slightly easier for <monospace>SampleQC</monospace> to fit. (In addition, the number of cells used in the run is needed to accurately estimate the expected number of doublets. Excluding low quality cells first would distort this calculation; although this can be addressed by recording the initial number of cells.)</p><p id="P59">To run <monospace>SampleQC</monospace>, the user first runs the function <monospace>calculate_pairwise_mmds</monospace>, which estimates MMD values for each pair of samples, identifies groups of samples with similar QC metric distributions, and calculates embeddings in lower-dimensional spaces (both MDS and UMAP). The user can then plot the samples and check for evidence of batch effects, e.g. if all samples from a given well, run or experimental condition are grouped together. Users can also check whether any sample group has consistently low quality cells (e.g. high mitochondrial proportions) and consider excluding all samples in that group.</p><p id="P60">To run the cell outlier section of <monospace>SampleQC</monospace>, the user then selects <monospace>qc_names</monospace>, the QC metrics to use, and <italic>k</italic>, a vector corresponding to the number of mixture components for each sample group, and calls the function <monospace>fit_sampleqc</monospace>. <monospace>SampleQC</monospace> then fits a GMM to each sample group, and uses cell likelihoods to identify outlier cells. Users would typically start by using <italic>k</italic> = 1 for all sample groups; as the simplest model, this is extremely fast. The report includes biaxial plots of the QC metrics for all samples, which allow users to judge what value of <italic>k</italic> is most appropriate for each sample group, then rerun <monospace>SampleQC</monospace>. Users can inspect the cells identified as outliers by generating an html report with the function <monospace>make_sampleqc_report</monospace>. The user can also specify <monospace>alpha</monospace>, the <italic>χ</italic><sup>2</sup> distribution threshold determining the how stringent outlier exclusion should be, however this is less critical and the default value (<monospace>alpha</monospace> = 0.01) is generally appropriate. alpha specifies the distance away from the centre of the nearest GMM component that should be considered as an outlier. Under a robust model, the distribution is assumed to be a GMM plus a contamination component that does not follow the GMM, and is therefore by definition very unlikely under the GMM distribution, so as long as <monospace>alpha</monospace> is set reasonably low (e.g. 1%, 0.1%), this will only have marginal effects on results.</p><p id="P61">If a large proportion of a sample is of poor quality, <monospace>SampleQC</monospace> may identify these cells as one sample cluster, and one of the mixture model components may therefore be centred on them (e.g. the cells with high splice ratio in <xref ref-type="fig" rid="F5">Figure 5</xref>). Without intervention, these would be reported as good cells rather than outliers. <monospace>SampleQC</monospace> therefore includes functionality allowing users to specify that any component whose mean meets a certain criteria should be regarded as outliers. For example, a component whose mean mitochondrial percentage is greater than a given percentage can be labelled as outliers.</p></sec><sec id="S13"><title>Simulations</title><p id="P62">We developed a framework for simulating samples of QC data that reflects the complexity observed in real datasets, following the model given in Equation 1, but additionally modelling outliers; in the <monospace>SampleQC</monospace> R package, users can access this functionality from the <monospace>simulate_qcs</monospace> function. For the simulations, we assume that there are three QC metrics: log library sizes, log feature counts and <monospace>logit</monospace> mitochondrial proportion. The simulations are hierarchical: firstly, parameters for group size and GMM components are drawn at the whole-experiment level; then, we draw parameters for sample quality at the sample group level, capturing variability that is coherent across groups of samples; then we draw parameters for each individual sample and QC metrics for each individual cell. To model the QC metrics, we assume that most cells are healthy, i.e. they derive from the experiment-level GMM, while a small number are ‘bad’, i.e. their values are perturbed away from the means of the GMM. These steps are set out in <xref ref-type="boxed-text" rid="BX1">Algorithm 1</xref>.</p><p id="P63">At the experiment level, we simulate the covariance matrices and relative means of the mixture components (QC celltypes) that are present in the experiment (<xref ref-type="boxed-text" rid="BX2">Algorithm 2</xref>). We then simulate parameters reflecting coherent behaviour across different groups of samples. First, we partition the cells between the groups according to a multinomial distribution, simulate how many samples are present in each group, and randomly assign QC celltypes to each group. We assign the QC celltypes such that each group has at least one QC celltype present, and that no two groups have identical sets of QC celltypes. To simulate coherent differences in outliers between each group, we simulate parameters from a beta distribution that determines how the proportion of outliers varies across samples (<monospace>p_out_0, theta_0</monospace>), and how perturbed these outliers will be relative to healthy cells (<monospace>p_loss_0</monospace>, the mean proportion of non-mitochondrial reads that is lost).</p><p id="P64">We then simulate samples and cells within each sample group (<xref ref-type="boxed-text" rid="BX4">Algorithm 4</xref>). Within each sample, we first simulate the sample shift from a multivariate Gaussian, and simulate the proportions of the different QC celltypes via a Dirichlet distribution (<monospace>p_jk</monospace>). We also simulate what proportion of cells in this sample are outliers, <monospace>p_out_j</monospace>, from a beta distribution with parameters (<monospace>p_loss_0, theta_0</monospace>), and the extent of perturbation in unhealthy cells, <monospace>p_loss_j</monospace>, from a logit-normal distribution.</p><p id="P65">We can then simulate each healthy cell, by first drawing its QC celltype from a multinomial with <bold>p</bold> = {<monospace>p_jk</monospace>}, then drawing from multivariate normal (<monospace>beta_k, Sigma_k</monospace>) for the appropriate <italic>k</italic>. Adding this to the relevant mu_0 gives us the QC metrics for a healthy cell. We then decide whether this cell is healthy or not by drawing from a binomial distribution (with probability <monospace>p_out_j</monospace>. If the cell is healthy, its QC metrics are left unchanged. If not, its non-mitochondrial reads are randomly decreased by a proportion <monospace>p_loss_j</monospace>. This results in both a reduction in total counts, and an increase in mitochondrial proportion. We apply the same random reduction to the number of features.</p><p id="P66">The outputs from the simulations show similar distributions of QC metrics to real data (<xref ref-type="fig" rid="F5">Figure 5</xref>).</p><boxed-text id="BX1" position="anchor" content-type="below"><label>Algorithm 1</label><caption><title>simulate_qcs: Overview of simulations (* indicates variables that would be known and used as input for real data)</title></caption><p id="P67"><bold>Input:</bold> n_groups, number of sample groups</p><p id="P68"><bold>Input:</bold> n_cells, number of cells in experiment</p><p id="P69"><bold>Input:</bold> n_p_sample, average number of cells per sample</p><p id="P70"><bold>Input:</bold> D, number of QC dimensions</p><p id="P71"><bold>Input:</bold> K, number of QC celltypes</p><p id="P72"><bold>Output:</bold> cell_ids*, labels for each cell</p><p id="P73"><bold>Output:</bold> sample_ids*, sample ID for each cell</p><p id="P74"><bold>Output:</bold> qc_out*, matrix of QC metrics including outliers for simulated experiment</p><p id="P75"><bold>Output:</bold> qc_ok, matrix of healthy QC metrics for simulated experiment</p><p id="P76"><bold>Output:</bold> groups, sample group for each sample</p><p id="P77"><bold>Output:</bold> z, QC celltype for each cell</p><p id="P78"><bold>Output:</bold> outliers, whether each cell is an outlier</p><p id="P79">draw experiment-level hyper-parameters:</p><p id="P80">   beta_k, Sigma_k = draw_expt_level(D, K);</p><p id="P81">draw sample group-level hyper-parameters:</p><p id="P82">   Ns, Js, mu_0s, sel_ks, p_out_0s, theta_0s, p_loss_0s = draw_group_level(n_groups, n_cells, n_p_sample, D, K);</p><p id="P83">simulate cells for each sample group:</p><p id="P84"><bold>for</bold> <italic>g</italic> ← 1 to n_groups do</p><p id="P85">       qc_oks[g], qc_outs[g], zs[g], outliers[g] = draw_sample_level(Ns[g], Js[g], mu_0s[g], sel_ks[g], p_out_0s[g], theta_0s[g], p_loss_0s[g]);</p><p id="P86">end</p><p id="P87">concatenate qc_oks[g], qc_outs[g], zs[g], outliers[g] to qc_ok, qc_out, z, outliers;</p></boxed-text><boxed-text id="BX2" position="anchor" content-type="below"><label>Algorithm 2</label><caption><title>draw_expt_level: Pseudocode for drawing experiment-level parameters</title></caption><p id="P88"><bold>Input:</bold> D, number of QC dimensions</p><p id="P89"><bold>Input:</bold> K, number of QC celltypes</p><p id="P90"><bold>Output:</bold> beta_k, means of GMM components</p><p id="P91"><bold>Output:</bold> Sigma_k, covariance matrices of GMM components</p><p id="P92"><bold>for</bold> <italic>k</italic> ← 1 to K <bold>do</bold></p><p id="P93">       draw <italic>β<sub>k</sub></italic> from multivariate distribution with mean 0, correlation matrix with off-diagonal elements [0.999,–0.4,–0.4], and standard deviations [0.3, 0.2, 0.1];</p><p id="P94">       draw Σ<italic><sub>k</sub></italic> from a Wishart distribution with 10 degrees of freedom, and Sigma defined by a correlation matrix with off-diagonal elements [0.99, –0.4, –0.4] multiplied by a vector of standard deviations [0.15, 0.13, 0.54] (these values are derived from the MS dataset);</p><p id="P95">end</p></boxed-text><boxed-text id="BX3" position="anchor" content-type="below"><label>Algorithm 3</label><caption><title>draw_group_level: Pseudocode for drawing sample group-level parameters</title></caption><p id="P96"><bold>Input:</bold> n_groups, number of sample groups</p><p id="P97"><bold>Input:</bold>n_cells, number of cells in experiment</p><p id="P98"><bold>Input:</bold>n_p_sample, average number of cells per sample</p><p id="P99"><bold>Input:</bold>D, number of QC dimensions</p><p id="P100"><bold>Input:</bold>K, number of QC celltypes</p><p id="P101"><bold>Output:</bold> Ns, number of cells in each sample group</p><p id="P102"><bold>Output:</bold>Output: Js, number of samples in each sample group</p><p id="P103"><bold>Output:</bold>Output: mu_0s, global mean of each sample group</p><p id="P104"><bold>Output:</bold>Output: sel_ks, which mixture components are present in each group</p><p id="P105"><bold>Output:</bold>Output: p_out_0s, mean outlier proportion in each group</p><p id="P106"><bold>Output:</bold>Output: theta_0s, size parameter for beta distribution of sample outlier proportions</p><p id="P107"><bold>Output:</bold>Output: p_loss_0s, mean proportion of non-mitochondrial reads lost in each outlier group</p><p id="P108">draw number of cells per sample group, Ns, with Dirichlet-multinomial (<italic>α</italic> = 10, <italic>n</italic> = n_cells);</p><p id="P109"><bold>while</bold> any rows of sel_ks identical OR any row of sel_ks all <italic>0</italic>s <bold>do</bold></p><p id="P110">       <bold>for</bold> <italic>g</italic> ← 1 to n_groups <bold>do</bold></p><p id="P111">              draw sel_ks[g] with binomial distribution (<italic>n</italic> = K, <italic>p</italic> = 0.5);</p><p id="P112">       <bold>end</bold></p><p id="P113">end</p><p id="P114"><bold>for</bold> <italic>g</italic> ← 1 to n_groups <bold>do</bold></p><p id="P115">       draw Js[g] from Pois(Ns[g]/cells_p_sample) + 1;</p><p id="P116">       draw mu_0s[g] from multivariate normal with mean [log10(3000), log10(1500), logit(0.03)], correlation matrix with off-diagonal elements [0.98,-0.7,-0.8] and standard deviations [0.3, 0.4, 1.5];</p><p id="P117">       draw p_out_0[g] from logistic normal with mean logit(0.08) and standard deviation 0.3 (on logistic scale);</p><p id="P118">       draw theta_0[g] from log-normal with mean 4 and standard deviation 0.5 (on log scale);</p><p id="P119">       draw p_loss_0[g] from logistic normal, with sample group mean logit(0.5) and standard deviation 0.5 (on logistic scale);</p><p id="P120">end</p></boxed-text><boxed-text id="BX4" position="anchor" content-type="below"><label>Algorithm 4</label><caption><title>draw_cell_level: Pseudocode for drawing cell-level parameters</title></caption><p id="P121"><bold>Input:</bold>N_g, number of cells in group</p><p id="P122"><bold>Input:</bold>J_g, number of samples in group</p><p id="P123"><bold>Input:</bold>mu0_g, global mean in group</p><p id="P124"><bold>Input:</bold>sel_ks_g, QC celltypes observed in group</p><p id="P125"><bold>Input:</bold>beta_k, Sigma_k, distributions of GMM components</p><p id="P126"><bold>Input:</bold>p_out_0_g, mean outlier proportion</p><p id="P127"><bold>Input:</bold>theta_0_g, size parameter of beta distribution for sample outlier proportions</p><p id="P128"><bold>Input:</bold>p_loss_0_g, mean proportion of non-mitochondrial reads lost in group</p><p id="P129"><bold>Output:</bold>qc_ok, matrix of unperturbed QC metrics for sample group</p><p id="P130"><bold>Output:</bold>qc_out, matrix of observed QC metrics for sample group</p><p id="P131"><bold>Output:</bold>z, QC celltype for each cell in group</p><p id="P132"><bold>Output:</bold>outliers, outlier status for each cell in group</p><p id="P133">assign N_<bold>g</bold> cells to J_<bold>g</bold> groups via multinomial distribution;</p><p id="P134"><bold>for</bold> <italic>j</italic> ← 1 <italic>to J_g</italic> <bold>do</bold></p><p id="P135">       draw sample shift <bold>alpha_</bold>j from multivariate normal (mean 0, correlation matrix off-diagonal elements [0.9,–0.4,–0.6], standard deviations [0.25, 0.25, 0.6]);</p><p id="P136">       draw probability of each QC celltype <italic>p<sub>jk</sub></italic> from Dirichlet (<italic>α</italic> = 5,K = n_types);</p><p id="P137">       draw outlier probability of each sample, <bold>p</bold>_out_j from Beta distribution (a = theta<sub>0</sub>_g * <bold>p</bold>_out_0_<bold>g</bold>, b = theta<sub>0</sub>_g * (1 – <bold>p</bold>_out_0_<bold>g</bold>));</p><p id="P138">       draw proportion of reads lost in each sample, <bold>p</bold>_loss_j from logistic normal distribution (mean <bold>p</bold>_loss_0_<bold>g</bold>, sd 0.5);</p><p id="P139">       <bold>for</bold> <italic>n</italic> ← 1 <italic>to N_g</italic> <bold>do</bold></p><p id="P140">              draw celltype, <bold>z[n]</bold>, from categorical (<bold>p</bold> = {<italic>p<sub>jk</sub></italic>});</p><p id="P141">              simulate healthy QC metrics, qc_ok multivariate normal with mean and covariance (mu0_<bold>g</bold> + <bold>alpha</bold>_<bold>j</bold> + <bold>beta_k[z]</bold>, <bold>Sigma_k[z]</bold>);</p><p id="P142">              draw outlier status: outliers<bold>[n]</bold> = Bernoulli(<bold>p_out_j</bold>);</p><p id="P143">              <bold>if</bold> <italic>outlier[n] is</italic> TRUE <bold>then</bold></p><p id="P144">                     <bold>qc_out[n]</bold> = downsample non-mitochondrial reads, <bold>Binomial</bold>(<italic>p</italic> = <bold>p_loss_j</bold>);</p><p id="P145">                     downsample number of features, <bold>Binomial</bold>(<italic>p</italic> = <bold>p_loss_j</bold>);</p><p id="P146">                     update mitochondrial proportion;</p><p id="P147">              <bold>else</bold></p><p id="P148">                     qc_out[n] = qc_ok[n]</p><p id="P149">              <bold>end</bold></p><p id="P150">       <bold>end</bold></p><p id="P151">end</p></boxed-text></sec></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary Figures</label><media xlink:href="EMS144182-supplement-Supplementary_Figures.pdf" mimetype="application" mime-subtype="pdf" id="d15aAeEbB" position="anchor"/></supplementary-material></sec></body><back><ack id="S14"><title>Acknowledgements</title><p>We thank Helena Crowell, Pierre-Luc Germain and Simone Tiberi for their valuable feedback on the manuscript and software. We thank Dheeraj Malhotra and Roche for the large experimental dataset (see Data availability below).</p><sec id="S15"><title>Funding</title><p>This work was supported by the Swiss National Science Foundation (grant numbers 310030_175841, CR-SII5_177208). MDR acknowledges support from the University Research Priority Program Evolution in Action at the University of Zurich. The funder played no role in the design of this study or in its execution.</p></sec></ack><sec id="S16" sec-type="data-availability"><title>Data availability</title><p id="P152">The data in Figures <xref ref-type="fig" rid="F4">Figure 4</xref> and <xref ref-type="fig" rid="F5">Figure 5</xref> is QC data taken from human brain tissue, including samples from patients with neurodegenerative conditions. The data derives from a study undertaken as part of a research collaboration agreement between the University of Zürich and F. Hoffman La Roche AG. The study is not yet published and the experimental labels have therefore been anonymized. Although we have made the anonymized QC metric data available (see DOI: 10.5281/zenodo.5258847), the full expression data is not yet public.</p></sec><sec id="S17" sec-type="data-availability"><title>Code availability</title><p id="P153">The <monospace>SampleQC</monospace> software package is accessible at <ext-link ext-link-type="uri" xlink:href="https://github.com/wmacnair/SampleQC">https://github.com/wmacnair/SampleQC</ext-link>; a code snapshot of the software package is available here: DOI: 10.5281/zenodo.6414310). A repo for reproducing the analyses in the paper is accessible at <ext-link ext-link-type="uri" xlink:href="https://github.com/wmacnair/SampleQC_paper_analyses">https://github.com/wmacnair/SampleQC_paper_analyses</ext-link> and the corresponding HTML reports are available from <ext-link ext-link-type="uri" xlink:href="https://github.com/wmacnair/SampleQC_paper_analyses/blob/main/docs/index.html">https://github.com/wmacnair/SampleQC_paper_analyses/blob/main/docs/index.html</ext-link>; a code snapshot of the analysis repository at time of submission is available here: (see DOI: 10.5281/zenodo.6414318)</p></sec><fn-group><fn id="FN"><p id="P154"><bold>Datasets</bold></p><p id="P155">The datasets listed in Table were used in this paper, obtained via the <monospace>scRNAseq</monospace> package (<xref ref-type="bibr" rid="R27">27</xref>).</p></fn><fn id="FN2" fn-type="conflict"><p id="P156"><bold>Competing interests</bold></p><p id="P157">The authors declare that they have no competing interests.</p></fn><fn id="FN3" fn-type="con"><p id="P158"><bold>Author’s contributions</bold></p><p id="P159">We use the CRediT taxonomy to define author contributions: <list list-type="bullet" id="L1"><list-item><p id="P160">WM: Conceptualization, Methodology, Software, Formal analysis, Investigation, Visualization, Data curation, Writing - Original Draft, Writing - Review &amp; Editing</p></list-item><list-item><p id="P161">MDR: Supervision, Methodology, Writing - Review &amp; Editing, Funding acquisition</p></list-item></list></p></fn></fn-group><ref-list><ref id="R1"><label>[1]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tang</surname><given-names>F</given-names></name><name><surname>Barbacioru</surname><given-names>C</given-names></name><name><surname>Wang</surname><given-names>Y</given-names></name><name><surname>Nordman</surname><given-names>E</given-names></name><name><surname>Lee</surname><given-names>C</given-names></name><name><surname>Xu</surname><given-names>N</given-names></name><name><surname>Wang</surname><given-names>X</given-names></name><name><surname>Bodeau</surname><given-names>J</given-names></name><name><surname>Tuch</surname><given-names>BB</given-names></name><name><surname>Siddiqui</surname><given-names>A</given-names></name><name><surname>Lao</surname><given-names>K</given-names></name><etal/></person-group><article-title>mRNA-Seq whole-transcriptome analysis of a single cell</article-title><source>Nat Methods</source><year>2009</year><volume>6</volume><issue>5</issue><fpage>377</fpage><lpage>382</lpage></element-citation></ref><ref id="R2"><label>[2]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Macosko</surname><given-names>EZ</given-names></name><name><surname>Basu</surname><given-names>A</given-names></name><name><surname>Satija</surname><given-names>R</given-names></name><name><surname>Nemesh</surname><given-names>J</given-names></name><name><surname>Shekhar</surname><given-names>K</given-names></name><name><surname>Goldman</surname><given-names>M</given-names></name><name><surname>Tirosh</surname><given-names>I</given-names></name><name><surname>Bialas</surname><given-names>AR</given-names></name><name><surname>Kamitaki</surname><given-names>N</given-names></name><name><surname>Martersteck</surname><given-names>EM</given-names></name><name><surname>Trombetta</surname><given-names>JJ</given-names></name><etal/></person-group><article-title>Highly parallel genome-wide expression profiling of individual cells using nanoliter droplets</article-title><source>Cell</source><year>2015</year><volume>161</volume><issue>5</issue><fpage>1202</fpage><lpage>1214</lpage></element-citation></ref><ref id="R3"><label>[3]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Klein</surname><given-names>AM</given-names></name><name><surname>Mazutis</surname><given-names>L</given-names></name><name><surname>Akartuna</surname><given-names>I</given-names></name><name><surname>Tallapragada</surname><given-names>N</given-names></name><name><surname>Veres</surname><given-names>A</given-names></name><name><surname>Li</surname><given-names>V</given-names></name><name><surname>Peshkin</surname><given-names>L</given-names></name><name><surname>Weitz</surname><given-names>DA</given-names></name><name><surname>Kirschner</surname><given-names>MW</given-names></name></person-group><article-title>Droplet barcoding for Single-Cell transcriptomics applied to embryonic stem cells</article-title><source>Cell</source><year>2015</year><volume>161</volume><issue>5</issue><fpage>1187</fpage><lpage>1201</lpage></element-citation></ref><ref id="R4"><label>[4]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luecken</surname><given-names>MD</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>Current best practices in single-cell RNA-seq analysis: a tutorial</article-title><source>Mol Syst Biol</source><year>2019</year><volume>15</volume><issue>6</issue></element-citation></ref><ref id="R5"><label>[5]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Crowell</surname><given-names>HL</given-names></name><name><surname>Soneson</surname><given-names>C</given-names></name><name><surname>Germain</surname><given-names>P-L</given-names></name><name><surname>Calini</surname><given-names>D</given-names></name><name><surname>Collin</surname><given-names>L</given-names></name><name><surname>Raposo</surname><given-names>C</given-names></name><name><surname>Malhotra</surname><given-names>D</given-names></name><name><surname>Robinson</surname><given-names>MD</given-names></name></person-group><article-title>On the discovery of population-specific state transitions from multi-sample multi-condition single-cell RNA sequencing data</article-title><year>2019</year></element-citation></ref><ref id="R6"><label>[6]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Squair</surname><given-names>JW</given-names></name><name><surname>Gautier</surname><given-names>M</given-names></name><name><surname>Kathe</surname><given-names>C</given-names></name><name><surname>Anderson</surname><given-names>MA</given-names></name><name><surname>James</surname><given-names>ND</given-names></name><name><surname>Hutson</surname><given-names>TH</given-names></name><name><surname>Hudelle</surname><given-names>R</given-names></name><name><surname>Qaiser</surname><given-names>T</given-names></name><name><surname>Matson</surname><given-names>KJE</given-names></name><name><surname>Barraud</surname><given-names>Q</given-names></name><name><surname>Levine</surname><given-names>AJ</given-names></name><etal/></person-group><article-title>Confronting false discoveries in single-cell differential expression</article-title><year>2021</year></element-citation></ref><ref id="R7"><label>[7]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Márquez-Jurado</surname><given-names>S</given-names></name><name><surname>Díaz-Colunga</surname><given-names>J</given-names></name><name><surname>Das Neves</surname><given-names>RP</given-names></name><name><surname>Martinez-Lorente</surname><given-names>A</given-names></name><name><surname>Almazán</surname><given-names>F</given-names></name><name><surname>Guantes</surname><given-names>R</given-names></name><name><surname>Iborra</surname><given-names>FJ</given-names></name></person-group><article-title>Mitochondrial levels determine variability in cell death by modulating apoptotic gene expression</article-title><source>Nat Commun</source><year>2018</year><volume>9</volume><issue>1</issue><fpage>389</fpage></element-citation></ref><ref id="R8"><label>[8]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Osorio</surname><given-names>D</given-names></name><name><surname>Cai</surname><given-names>JJ</given-names></name></person-group><article-title>Systematic determination of the mitochondrial proportion in human and mice tissues for single-cell RNA sequencing data quality control</article-title><year>2020</year></element-citation></ref><ref id="R9"><label>[9]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Amezquita</surname><given-names>RA</given-names></name><name><surname>Lun</surname><given-names>ATL</given-names></name><name><surname>Becht</surname><given-names>E</given-names></name><name><surname>Carey</surname><given-names>VJ</given-names></name><name><surname>Carpp</surname><given-names>LN</given-names></name><name><surname>Geistlinger</surname><given-names>L</given-names></name><name><surname>Marini</surname><given-names>F</given-names></name><name><surname>Rue-Albrecht</surname><given-names>K</given-names></name><name><surname>Risso</surname><given-names>D</given-names></name><name><surname>Soneson</surname><given-names>C</given-names></name><name><surname>Waldron</surname><given-names>L</given-names></name><etal/></person-group><article-title>Orchestrating single-cell analysis with bioconductor</article-title><source>Nat Methods</source><year>2020</year><volume>17</volume><issue>2</issue><fpage>137</fpage><lpage>145</lpage></element-citation></ref><ref id="R10"><label>[10]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McCarthy</surname><given-names>DJ</given-names></name><name><surname>Campbell</surname><given-names>KR</given-names></name><name><surname>Lun</surname><given-names>ATL</given-names></name><name><surname>Wills</surname><given-names>QF</given-names></name></person-group><article-title>Scater: pre-processing, quality control, nor-malization and visualization of single-cell RNA-seq data in R</article-title><source>Bioinformatics</source><year>2017</year><volume>33</volume><issue>8</issue><fpage>1179</fpage><lpage>1186</lpage></element-citation></ref><ref id="R11"><label>[11]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stuart</surname><given-names>T</given-names></name><name><surname>Butler</surname><given-names>A</given-names></name><name><surname>Hoffman</surname><given-names>P</given-names></name><name><surname>Hafemeister</surname><given-names>C</given-names></name><name><surname>Papalexi</surname><given-names>E</given-names></name><name><surname>Mauck</surname><given-names>WM</given-names></name><name><surname>Hao</surname><given-names>Y</given-names></name><name><surname>Stoeckius</surname><given-names>M</given-names></name><name><surname>Smibert</surname><given-names>P</given-names></name><name><surname>Satija</surname><given-names>R</given-names></name></person-group><article-title>Comprehensive integration of Single-Cell data</article-title><source>Cell</source><year>2019</year><volume>177</volume><issue>7</issue><fpage>1888</fpage><lpage>190221</lpage></element-citation></ref><ref id="R12"><label>[12]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hippen</surname><given-names>AA</given-names></name><name><surname>Falco</surname><given-names>MM</given-names></name><name><surname>Weber</surname><given-names>LM</given-names></name><name><surname>Erkan</surname><given-names>EP</given-names></name><name><surname>Zhang</surname><given-names>K</given-names></name><name><surname>Doherty</surname><given-names>JA</given-names></name><name><surname>Vähärautio</surname><given-names>A</given-names></name><name><surname>Greene</surname><given-names>CS</given-names></name><name><surname>Hicks</surname><given-names>SC</given-names></name></person-group><article-title>miQC: An adaptive probabilistic framework for quality control of single-cell RNA-sequencing data</article-title><year>2021</year></element-citation></ref><ref id="R13"><label>[13]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Germain</surname><given-names>P-L</given-names></name><name><surname>Sonrel</surname><given-names>A</given-names></name><name><surname>Robinson</surname><given-names>MD</given-names></name></person-group><article-title>pipecomp, a general framework for the evaluation of computational pipelines, reveals performant single cell RNA-seq preprocessing tools</article-title><source>Genome Biol</source><year>2020</year><volume>21</volume><issue>1</issue><fpage>227</fpage></element-citation></ref><ref id="R14"><label>[14]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Svensson</surname><given-names>V</given-names></name><name><surname>Da Veiga Beltrame</surname><given-names>E</given-names></name></person-group><article-title>A curated database reveals trends in single cell transcriptomics</article-title><year>2019</year></element-citation></ref><ref id="R15"><label>[15]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gretton</surname><given-names>A</given-names></name><name><surname>Borgwardt</surname><given-names>KM</given-names></name><name><surname>Rasch</surname><given-names>MJ</given-names></name><name><surname>Schölkopf</surname><given-names>B</given-names></name><name><surname>Smola</surname><given-names>A</given-names></name></person-group><article-title>A kernel Two-Sample test</article-title><source>J Mach Learn Res</source><year>2012</year><month>Mar</month><volume>13</volume><fpage>723</fpage><lpage>773</lpage></element-citation></ref><ref id="R16"><label>[16]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Blondel</surname><given-names>VD</given-names></name><name><surname>Guillaume</surname><given-names>JL</given-names></name></person-group><article-title>Fast unfolding of communities in large networks. Journal of Statistical Mechanics</article-title><source>Theory and Experiment</source><year>2008</year><fpage>1</fpage><lpage>12</lpage></element-citation></ref><ref id="R17"><label>[17]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Torgerson</surname><given-names>WS</given-names></name></person-group><article-title>Multidimensional scaling: I. theory and method</article-title><source>Psychometrika</source><year>1952</year><volume>17</volume><issue>4</issue><fpage>401</fpage><lpage>419</lpage></element-citation></ref><ref id="R18"><label>[18]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McInnes</surname><given-names>L</given-names></name><name><surname>Healy</surname><given-names>J</given-names></name></person-group><article-title>UMAP: Uniform manifold approximation and projection for dimension reduction</article-title><year>2018</year><elocation-id>1802.03426</elocation-id></element-citation></ref><ref id="R19"><label>[19]</label><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Huber</surname><given-names>PJ</given-names></name></person-group><source>Robust Statistics</source><publisher-name>John Wiley &amp; Sons</publisher-name><year>2004</year></element-citation></ref><ref id="R20"><label>[20]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rousseeuw</surname><given-names>PJ</given-names></name><name><surname>Van Driessen</surname><given-names>K</given-names></name></person-group><article-title>A fast algorithm for the minimum covariance determinant estimator</article-title><source>Technometrics</source><year>1999</year><volume>41</volume><issue>3</issue><fpage>212</fpage><lpage>223</lpage></element-citation></ref><ref id="R21"><label>[21]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McLachlan</surname><given-names>GJ</given-names></name><name><surname>Lee</surname><given-names>SX</given-names></name><name><surname>Rathnayake</surname><given-names>SI</given-names></name></person-group><article-title>Finite mixture models</article-title><source>Annual review of statistics and its application</source><year>2019</year></element-citation></ref><ref id="R22"><label>[22]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Alvarez</surname><given-names>M</given-names></name><name><surname>Rahmani</surname><given-names>E</given-names></name><name><surname>Jew</surname><given-names>B</given-names></name><name><surname>Garske</surname><given-names>KM</given-names></name><name><surname>Miao</surname><given-names>Z</given-names></name><name><surname>Benhammou</surname><given-names>JN</given-names></name><name><surname>Ye</surname><given-names>CJ</given-names></name><name><surname>Pisegna</surname><given-names>JR</given-names></name><name><surname>Pietiläinen</surname><given-names>KH</given-names></name><name><surname>Halperin</surname><given-names>E</given-names></name><name><surname>Pajukanta</surname><given-names>P</given-names></name></person-group><article-title>Enhancing droplet-based single-nucleus RNA-seq resolution using the semi-supervised machine learning classifier DIEM</article-title><source>Sci Rep</source><year>2020</year><volume>10</volume><issue>1</issue><elocation-id>11019</elocation-id></element-citation></ref><ref id="R23"><label>[23]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stoeckius</surname><given-names>M</given-names></name><name><surname>Hafemeister</surname><given-names>C</given-names></name><name><surname>Stephenson</surname><given-names>W</given-names></name><name><surname>Houck-Loomis</surname><given-names>B</given-names></name><name><surname>Chattopadhyay</surname><given-names>PK</given-names></name><name><surname>Swerdlow</surname><given-names>H</given-names></name><name><surname>Satija</surname><given-names>R</given-names></name><name><surname>Smibert</surname><given-names>P</given-names></name></person-group><article-title>Simultaneous epitope and transcriptome measurement in single cells</article-title><source>Nat Methods</source><year>2017</year><volume>14</volume><issue>9</issue><fpage>865</fpage><lpage>868</lpage></element-citation></ref><ref id="R24"><label>[24]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Buenrostro</surname><given-names>JD</given-names></name><name><surname>Wu</surname><given-names>B</given-names></name><name><surname>Litzenburger</surname><given-names>UM</given-names></name><name><surname>Ruff</surname><given-names>D</given-names></name><name><surname>Gonzales</surname><given-names>ML</given-names></name><name><surname>Snyder</surname><given-names>MP</given-names></name><name><surname>Chang</surname><given-names>HY</given-names></name><name><surname>Greenleaf</surname><given-names>WJ</given-names></name></person-group><article-title>Single-cell chromatin accessibility reveals principles of regulatory variation</article-title><source>Nature</source><year>2015</year><volume>523</volume><issue>7561</issue><fpage>486</fpage><lpage>490</lpage></element-citation></ref><ref id="R25"><label>[25]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kotliarov</surname><given-names>Y</given-names></name><name><surname>Sparks</surname><given-names>R</given-names></name><name><surname>Martins</surname><given-names>AJ</given-names></name><name><surname>Mulè</surname><given-names>MP</given-names></name><name><surname>Lu</surname><given-names>Y</given-names></name><name><surname>Goswami</surname><given-names>M</given-names></name><name><surname>Kardava</surname><given-names>L</given-names></name><name><surname>Banchereau</surname><given-names>R</given-names></name><name><surname>Pascual</surname><given-names>V</given-names></name><name><surname>Biancotto</surname><given-names>A</given-names></name><name><surname>Chen</surname><given-names>J</given-names></name><etal/></person-group><article-title>Broad immune activation underlies shared set point signatures for vaccine responsiveness in healthy individuals and disease activity in patients with lupus</article-title><source>Nat Med</source><year>2020</year><volume>26</volume><issue>4</issue><fpage>618</fpage><lpage>629</lpage></element-citation></ref><ref id="R26"><label>[26]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>L</given-names></name><name><surname>Liu</surname><given-names>C</given-names></name><name><surname>Quintero</surname><given-names>A</given-names></name><name><surname>Wu</surname><given-names>L</given-names></name><name><surname>Yuan</surname><given-names>Y</given-names></name><name><surname>Wang</surname><given-names>M</given-names></name><name><surname>Cheng</surname><given-names>M</given-names></name><name><surname>Leng</surname><given-names>L</given-names></name><name><surname>Xu</surname><given-names>L</given-names></name><name><surname>Dong</surname><given-names>G</given-names></name><name><surname>Li</surname><given-names>R</given-names></name><etal/></person-group><article-title>Deconvolution of single-cell multi-omics layers reveals regulatory heterogeneity</article-title><source>Nat Commun</source><year>2019</year><volume>10</volume><issue>1</issue><fpage>470</fpage></element-citation></ref><ref id="R27"><label>[27]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Risso</surname><given-names>D</given-names></name><name><surname>Cole</surname><given-names>M</given-names></name></person-group><article-title>scRNAseq: Collection of Public Single-Cell RNA-Seq Datasets</article-title><source>R package version 240</source><year>2020</year></element-citation></ref><ref id="R28"><label>[28]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Campbell</surname><given-names>JN</given-names></name><name><surname>Macosko</surname><given-names>EZ</given-names></name><name><surname>Fenselau</surname><given-names>H</given-names></name><name><surname>Pers</surname><given-names>TH</given-names></name><name><surname>Lyubetskaya</surname><given-names>A</given-names></name><name><surname>Tenen</surname><given-names>D</given-names></name><name><surname>Goldman</surname><given-names>M</given-names></name><name><surname>Verstegen</surname><given-names>AMJ</given-names></name><name><surname>Resch</surname><given-names>JM</given-names></name><name><surname>McCarroll</surname><given-names>SA</given-names></name><name><surname>Rosen</surname><given-names>ED</given-names></name><etal/></person-group><article-title>A molecular census of arcuate hypothalamus and median eminence cell types</article-title><source>Nat Neurosci</source><year>2017</year><volume>20</volume><issue>3</issue><fpage>484</fpage><lpage>496</lpage></element-citation></ref><ref id="R29"><label>[29]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Weber</surname><given-names>LM</given-names></name><name><surname>Hippen</surname><given-names>AA</given-names></name><name><surname>Hickey</surname><given-names>PF</given-names></name><name><surname>Berrett</surname><given-names>KC</given-names></name><name><surname>Gertz</surname><given-names>J</given-names></name><name><surname>Doherty</surname><given-names>JA</given-names></name><name><surname>Greene</surname><given-names>CS</given-names></name><name><surname>Hicks</surname><given-names>SC</given-names></name></person-group><article-title>Genetic demultiplexing of pooled single-cell RNA-sequencing samples in cancer facilitates effective experimental design</article-title><year>2021</year></element-citation></ref><ref id="R30"><label>[30]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shekhar</surname><given-names>K</given-names></name><name><surname>Lapan</surname><given-names>SW</given-names></name><name><surname>Whitney</surname><given-names>IE</given-names></name><name><surname>Tran</surname><given-names>NM</given-names></name><name><surname>Macosko</surname><given-names>EZ</given-names></name><name><surname>Kowalczyk</surname><given-names>M</given-names></name><name><surname>Adiconis</surname><given-names>X</given-names></name><name><surname>Levin</surname><given-names>JZ</given-names></name><name><surname>Nemesh</surname><given-names>J</given-names></name><name><surname>Goldman</surname><given-names>M</given-names></name><name><surname>McCarroll</surname><given-names>SA</given-names></name><etal/></person-group><article-title>Comprehensive classification of retinal bipolar neurons by Single-Cell transcriptomics</article-title><source>Cell</source><year>2016</year><volume>166</volume><issue>5</issue><elocation-id>1308-132330</elocation-id></element-citation></ref><ref id="R31"><label>[31]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>W</given-names></name><name><surname>Vilella</surname><given-names>F</given-names></name><name><surname>Alama</surname><given-names>P</given-names></name><name><surname>Moreno</surname><given-names>I</given-names></name><name><surname>Mignardi</surname><given-names>M</given-names></name><name><surname>Isakova</surname><given-names>A</given-names></name><name><surname>Pan</surname><given-names>W</given-names></name><name><surname>Simon</surname><given-names>C</given-names></name><name><surname>Quake</surname><given-names>SR</given-names></name></person-group><article-title>Single-cell transcriptomic atlas of the human endometrium during the menstrual cycle</article-title><source>Nat Med</source><year>2020</year><volume>26</volume><issue>10</issue><fpage>1644</fpage><lpage>1653</lpage></element-citation></ref><ref id="R32"><label>[32]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zeisel</surname><given-names>A</given-names></name><name><surname>Muñoz-Manchado</surname><given-names>AB</given-names></name><name><surname>Codeluppi</surname><given-names>S</given-names></name><name><surname>Lönnerberg</surname><given-names>P</given-names></name><name><surname>La Manno</surname><given-names>G</given-names></name><name><surname>Juréus</surname><given-names>A</given-names></name><name><surname>Marques</surname><given-names>S</given-names></name><name><surname>Munguba</surname><given-names>H</given-names></name><name><surname>He</surname><given-names>L</given-names></name><name><surname>Betsholtz</surname><given-names>C</given-names></name><name><surname>Rolny</surname><given-names>C</given-names></name><etal/></person-group><article-title>Cell types in the mouse cortex and hippocampus revealed by single-cell RNA-seq</article-title><source>Science</source><year>2015</year><volume>347</volume><issue>6226</issue><fpage>1138</fpage><lpage>1142</lpage></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Figure 1</label><caption><title><monospace>SampleQC</monospace> methodology.</title><p><bold>A</bold> Cartoon of cells and samples with varying quality, and their corresponding QC metrics. <bold>B</bold> <monospace>SampleQC</monospace> estimates distributional distances between samples, and uses this to identify groups of samples. <bold>C</bold> <monospace>SampleQC</monospace> fits a robust GMM to each group of samples. <bold>D</bold> Low likelihood is used to exclude poor quality cells. <bold>E</bold> <monospace>SampleQC</monospace> generates report of outliers and overall sample quality.</p></caption><graphic xlink:href="EMS144182-f001"/></fig><fig id="F2" position="float"><label>Figure 2</label><caption><title>QC method comparisons on multimodal simulated data.</title><p><bold>A</bold> Biaxial plot of QC metrics for one simulated sample. Each point represents the QC metrics for one cell, with (known) simulated outliers in red and non-outliers in grey. <bold>B</bold> Multivariate density plot of data in (A), annotated with models fit by <monospace>SampleQC</monospace>. The distinct clusters here are examples of what we term ‘QC celltypes’, i.e. cells with similar distributions in their QC metrics, although their gene expression distributions may be distinct. <bold>C</bold> Mahalanobis distances to nearest cluster under the fit <monospace>SampleQC</monospace> model, with large values indicating low likelihood under multivariate Gaussian mixture model. <bold>D, E, F</bold> Outliers detected by <monospace>SampleQC</monospace>, <monospace>scater</monospace> and <monospace>miQC</monospace> respectively. These indicate the different assumptions on outliers made by the different methods: <monospace>SampleQC</monospace> calls droplets in low-density regions of the QC metric space as outliers; <monospace>scater</monospace> calls droplets with extreme values on at least one metric as outliers, in effect drawing a box around the central mode of the data; <monospace>miQC</monospace> identifies droplets with high mitochondrial proportion relative to the number of features observed, which may correspond to a good quality celltype with high mitochondrial proportion.</p></caption><graphic xlink:href="EMS144182-f002"/></fig><fig id="F3" position="float"><label>Figure 3</label><caption><p>Performance comparison of <monospace>SampleQC</monospace>, <monospace>scater</monospace> and <monospace>miQC</monospace> on simulated data. Results from a simulated experiment of 100k cells with 3 QC celltypes. <bold>A</bold> Precision-recall curve of identification of ‘good’ cells. Solid lines show curve calculated over all cells. Transparent lines show curves for individual samples. Dots show default exclusion thresholds for each method (&lt; 1% Chi-squared likelihood under fitted model for <monospace>SampleQC</monospace>; &gt; 2.5 MADs for <monospace>scater</monospace>; &gt; 0.75 posterior probability of compromised cell for <monospace>miQC</monospace>). <bold>B</bold> Bias in number of cells reported by sample, samples split by whether one or multiple QC celltypes present in the sample (i.e. whether samples is uni- or multimodal). <italic>y</italic>-axis is bias in reporting of good cells.</p></caption><graphic xlink:href="EMS144182-f003"/></fig><fig id="F4" position="float"><label>Figure 4</label><caption><p>Sample-to-sample distance embedding (UMAP). <monospace>UMAP</monospace> embedding, based on sample-sample similarities calculated with MMD, resulting in samples with similar QC metrics being plotted close to each other. <bold>A</bold> Sample group, i.e. clusters of samples with similar QC metrics distributions, as estimated by <monospace>SampleQC</monospace>. Remaining plots show sample metadata and statistical summaries: <bold>B</bold> Sequencing batch <bold>C</bold> Mitochondrial proportion (categorized) <bold>D</bold> Number of cells (categorized) <bold>E</bold> Median counts per cell <bold>F</bold> Median log2 splice ratio per cell.</p></caption><graphic xlink:href="EMS144182-f004"/></fig><fig id="F5" position="float"><label>Figure 5</label><caption><title>QC method comparisons on complex biological data.</title><p><bold>A</bold> Biaxial empirical density plot of QC metrics for single nuclei data, showing one selected sample, annotated with models fit by <monospace>SampleQC</monospace>. Colour indicates density of cells with the same QC metrics. <bold>B</bold> Mahalanobis distances to nearest cluster under fit <monospace>SampleQC</monospace> model, with large values indicating low likelihood under multivariate Gaussian mixture model. <bold>C, D, E</bold> Outliers detected by <monospace>SampleQC</monospace>, <monospace>scater</monospace> and <monospace>miQC</monospace> respectively. <monospace>SampleQC</monospace> outliers include user specification that QC celltypes with mean splice ratio &gt; 3 should be excluded.</p></caption><graphic xlink:href="EMS144182-f005"/></fig><table-wrap id="T1" orientation="portrait" position="float"><label>Table 1</label><caption><p>List of datasets used in paper. All datasets are single cell RNA-seq unless otherwise stated.</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left" valign="top">Short name</th><th align="left" valign="top">Tissue</th><th align="left" valign="top">Reference</th></tr></thead><tbody><tr><td align="left" valign="top">Campbell</td><td align="left" valign="top">Mouse brain</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R28">28</xref>)</td></tr><tr><td align="left" valign="top">CITEseq</td><td align="left" valign="top">Human PBMC (CITE-seq)</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R25">25</xref>)</td></tr><tr><td align="left" valign="top">HGSOC</td><td align="left" valign="top">Human ovarian cancer</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R29">29</xref>)</td></tr><tr><td align="left" valign="top">Macosko</td><td align="left" valign="top">Mouse retina</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R2">2</xref>)</td></tr><tr><td align="left" valign="top">Roche</td><td align="left" valign="top">Human brain (single nuclei RNA-seq)</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R30">30</xref>)</td></tr><tr><td align="left" valign="top">Shekhar</td><td align="left" valign="top">Mouse retina</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R30">30</xref>)</td></tr><tr><td align="left" valign="top">Wang</td><td align="left" valign="top">Human endometrium</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R31">31</xref>)</td></tr><tr><td align="left" valign="top">Zeisel</td><td align="left" valign="top">Mouse brain</td><td align="left" valign="top">(<xref ref-type="bibr" rid="R32">32</xref>)</td></tr></tbody></table></table-wrap></floats-group></article>