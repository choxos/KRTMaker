<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="epub">2692-8205</issn></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS202000</article-id><article-id pub-id-type="doi">10.1101/2024.12.06.627196</article-id><article-id pub-id-type="archive">PPR954105</article-id><article-version-alternatives><article-version article-version-type="status">preprint</article-version><article-version article-version-type="number">1</article-version></article-version-alternatives><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>inVAE: Conditionally invariant representation learning for generating multivariate single-cell reference maps</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Aliee</surname><given-names>Hananeh</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><contrib contrib-type="author"><name><surname>Kapl</surname><given-names>Ferdinand</given-names></name><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A3">3</xref></contrib><contrib contrib-type="author"><name><surname>Pham</surname><given-names>Duy</given-names></name><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author"><name><surname>Cakir</surname><given-names>Batuhan</given-names></name><xref ref-type="aff" rid="A1">1</xref></contrib><contrib contrib-type="author"><name><surname>Jimba</surname><given-names>Takahiro</given-names></name><xref ref-type="aff" rid="A5">5</xref></contrib><contrib contrib-type="author"><name><surname>Cranley</surname><given-names>James</given-names></name><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author"><name><surname>Teichmann</surname><given-names>Sarah A.</given-names></name><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author"><name><surname>Meyer</surname><given-names>Kerstin B.</given-names></name><xref ref-type="aff" rid="A6">6</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><contrib contrib-type="author"><name><surname>Vento-Tormo</surname><given-names>Roser</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A4">4</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><contrib contrib-type="author"><name><surname>Theis</surname><given-names>Fabian J.</given-names></name><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A3">3</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><aff id="A1"><label>1</label><institution-wrap><institution-id institution-id-type="ror">https://ror.org/05cy4wa09</institution-id><institution>Wellcome Sanger Institute</institution></institution-wrap>, <city>Hinxton, Cambridge</city>, <country country="GB">United Kingdom</country></aff><aff id="A2"><label>2</label>Helmholtz Center, Munich, Germany</aff><aff id="A3"><label>3</label>Department of Mathematics, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/02kkvpp62</institution-id><institution>Technical University of Munich</institution></institution-wrap>, <country country="DE">Germany</country></aff><aff id="A4"><label>4</label>Cambridge Stem Cell Institute, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/013meh722</institution-id><institution>University of Cambridge</institution></institution-wrap>, <city>Cambridge</city>, <country country="GB">United Kingdom</country></aff><aff id="A5"><label>5</label>Department of Cardiovascular Medicine, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/057zh3y96</institution-id><institution>University of Tokyo</institution></institution-wrap>, <country country="JP">Japan</country></aff><aff id="A6"><label>6</label>Respiratory and Immunology Research Unit, GSK, Stevenage, United Kingdom</aff></contrib-group><author-notes><corresp id="CR1">
<label>*</label>Corresponding authors (<email>ha10@sanger.ac.uk</email>, <email>kerstin.b.meyer@gsk.com</email>, <email>rv4@sanger.ac.uk</email>, <email>fabian.theis@helmholtz-munich.de</email>)</corresp></author-notes><pub-date pub-type="nihms-submitted"><day>18</day><month>12</month><year>2024</year></pub-date><pub-date pub-type="preprint"><day>12</day><month>12</month><year>2024</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by-nc/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P1">Single-cell data is driving new insights into the spatiotemporal dynamics of cells and individual disease susceptibility. However, accurately identifying cell states across diverse cohorts remains challenging, as both biological variation and technical biases cause distributional shifts in the data. Separating these effects is crucial for capturing cellular heterogeneity and ensuring interpretability. To address this, we developed <italic>inVAE</italic>, a conditionally invariant deep generative model based on variational autoencoders. inVAE models the latent space as a combination of invariant variables, encoding true biological signals, and spurious variables, capturing technical biases. By conditioning the prior distribution of cells on biological covariates, such as disease variants, inVAE identifies high-resolution cell states in the invariant representation. Enforcing independence between the two representations disentangles biological signals from noise, enabling a more interpretable and generalizable model with a causal semantic. inVAE outperformed existing methods across four human cellular atlases of the human heart and lung, while uncovering novel cell states. It precisely stratified cell atlas donors based on the genetic impact of pathogenic variants, and excelled in predicting cell types and disease in unseen data, proving its generalizability as a reference model for label transfer. Furthermore, inVAE accurately identified temporal cell states and trajectories from developmental datasets, and captured spatial cell states in a spatially-resolved atlas. In summary, inVAE provides a powerful method for integrating multivariate single-cell transcriptomics data. By leveraging prior knowledge such as metadata, it effectively accounts for biological variation and improves latent space interpretability by disentangling biological and technical sources of variation. These capabilities enable deeper insights into cellular heterogeneity and its role in disease progression.</p></abstract></article-meta></front><body><p id="P2">Single-cell transcriptomics datasets are increasing in number and complexity, including diverse cell states derived from multiple diseases, developmental stages and spatial locations<sup><xref ref-type="bibr" rid="R1">1</xref>,<xref ref-type="bibr" rid="R2">2</xref></sup>. Integrating this data is essential for capturing the full spectrum of cellular diversity, particularly in human studies, where limited sample availability and finite biological material restrict the experimental conditions that can be examined within a single study or lab. By building integrated cellular atlases from multiple studies, we can better identify inter-individual variation and the molecular characteristics unique to specific conditions<sup><xref ref-type="bibr" rid="R3">3</xref>,<xref ref-type="bibr" rid="R4">4</xref></sup>. The resulting integrated atlases have led to discoveries of previously unknown cell types<sup><xref ref-type="bibr" rid="R5">5</xref>–<xref ref-type="bibr" rid="R7">7</xref></sup>, enhanced patient stratification<sup><xref ref-type="bibr" rid="R8">8</xref>–<xref ref-type="bibr" rid="R10">10</xref></sup>, enabled robust analyses of differentially expressed genes (DEGs) across donors<sup><xref ref-type="bibr" rid="R11">11</xref></sup>, identified reproducible marker genes<sup><xref ref-type="bibr" rid="R12">12</xref></sup>, and facilitated comparisons between in vivo and in vitro models<sup><xref ref-type="bibr" rid="R13">13</xref>,<xref ref-type="bibr" rid="R14">14</xref></sup> and between species<sup><xref ref-type="bibr" rid="R15">15</xref>–<xref ref-type="bibr" rid="R17">17</xref></sup>.</p><p id="P3">Building comprehensive atlases involves data collection under varying experimental protocols and technologies, which introduces technical biases, commonly known as batch effects. Batch effects make the separation of noise from key biological signals exceptionally challenging. Numerous computational methods have been developed to address this issue, allowing us to capture cellular phenotypes more accurately while minimising technical variation<sup><xref ref-type="bibr" rid="R18">18</xref>–<xref ref-type="bibr" rid="R23">23</xref></sup>. Among them, machine learning-based data integration methods have gained attention both due to their performance and because they enable a wide range of tasks. These tasks include mapping high-dimensional data to lower-dimensional space (representation learning), performing differential expression testing, reducing noise in data (denoising), mapping new datasets to the same low-dimensional space of a reference atlas (reference mapping), and performing automated cell-type annotation (label transfer)<sup><xref ref-type="bibr" rid="R19">19</xref>,<xref ref-type="bibr" rid="R24">24</xref>–<xref ref-type="bibr" rid="R28">28</xref></sup>.</p><p id="P4">The existing integration methods often remove the impact of spurious correlation, like batch effects, assuming that the underlying distribution of cells—once isolated from these confounding effects—remains consistent across datasets<sup><xref ref-type="bibr" rid="R19">19</xref></sup>. This assumption is based on the idea that invariant causal mechanisms are present across datasets, enabling the model to generalise to new data. However, in biological contexts, causal mechanisms can change over time or across different experimental conditions, which can invalidate the assumption of uniform distribution<sup><xref ref-type="bibr" rid="R29">29</xref></sup>. For instance, the causal relationship between a gene and a phenotype might depend on disease variants that vary across donors. Therefore, these methods often fail to capture critical biological variations unique to individual donors or specific conditions.</p><p id="P5">Given this assumption underlying the existing integration methods, a common approach to identify disease-specific cell states is to build atlases using similar datasets (e.g., all healthy donors) and apply reference mapping algorithms to project more distinct samples (e.g., diseased samples) onto the reference atlases<sup><xref ref-type="bibr" rid="R4">4</xref>,<xref ref-type="bibr" rid="R30">30</xref></sup>. However, the effectiveness of this approach is limited by the models’ capacity to serve as comprehensive references and the performance of the reference-mapping algorithms. This underscores the need for more generalizable integration methods that can build reference models capable of spanning a broader range of biological conditions and supporting more robust reference mapping.</p><p id="P6">Here, we developed a <italic>conditionally</italic> invariant deep generative model based on variational autoencoders (VAEs)<sup><xref ref-type="bibr" rid="R31">31</xref></sup>, named inVAE, to integrate diverse single-cell transcriptomics datasets. To accurately dissect the sources of variation across cells, inVAE infers two sets of latent variables, invariant, capturing true biological signals, and spurious, representing noise or technical biases. inVAE further incorporates prior knowledge, such as metadata, into the inference process, learning prior distributions of cells specific to each biological condition, like disease variants, developmental stage, or anatomical region. This is crucial to discover high-resolution cell states and generate representative reference atlases from multivariate data which accounts for both shared and unique molecular signatures across individuals. Moreover, inVAE has built-in predictors that transfer labels to new datasets and, crucially, identifies novel cell states when the cells in a new dataset undergo domain shifts, such as those caused by previously unseen diseases.</p><p id="P7">We applied inVAE to construct four reference atlases in the heart and the lung, providing valuable resources for future research. Our results show that inVAE effectively stratified human heart cell atlas donors by the genetic impact of pathogenic variants and excelled in predicting cell types and disease in unseen datasets, demonstrating its generalizability for label transfer. Additionally, it accurately identified temporal cell states and derived realistic lineage trajectories from developmental human lung datasets, as well as capturing spatial cell states in a spatially-resolved adult human lung atlas. Recognizing that experimental validation is not always feasible, we also provide a comprehensive set of computational methods to increase confidence in cell state identification.</p><sec id="S1" sec-type="results"><title>Results</title><sec id="S2"><title>Conditionally invariant representation learning for disentangling biological and technical variation</title><p id="P8">A schematic overview of the proposed invariant variational autoencoder (inVAE) model is presented in <xref ref-type="fig" rid="F1">Figure 1</xref> (see also <xref ref-type="supplementary-material" rid="SD1">Supplementary Note, Box 1</xref>). The model inputs consist of the gene expression vector <italic>X</italic> and its associated domain <italic>U</italic>, indicating the conditions under which the sample was collected (i.e. metadata). The domain <italic>U</italic> = (<italic>B, T</italic>) encompasses two categories of observed variables: biologically relevant (<italic>B</italic>) and technical (<italic>T</italic>) variables. The biological variables <italic>B</italic> may include disease variants, developmental stages, anatomical tissue locations, perturbations, or other concurrently observed factors that could drive cellular changes (<xref ref-type="fig" rid="F1">Figure 1c</xref>). In contrast, the technical variables <italic>T</italic> capture unwanted variability or biases within the data, such as batch effects or confounding factors like sex or age, depending on the experimental design.</p><p id="P9">The inputs (<italic>X, B, T</italic>) are encoded into two distinct latent variables, <italic>Z</italic><sub><italic>I</italic></sub> and <italic>Z</italic><sub><italic>S</italic></sub>, via a nonlinear encoder (<xref ref-type="fig" rid="F1">Figure 1a</xref>). The latent variables <italic>Z</italic><sub><italic>I</italic></sub> encode an invariant representation of cells conditioned on the biological variables <italic>B</italic>, while <italic>Z</italic><sub><italic>S</italic></sub> models a spurious representation that captures unwanted variability in the data (<xref ref-type="fig" rid="F1">Figure 1b</xref>). <italic>Z</italic><sub><italic>I</italic></sub> is explicitly designed to be invariant to technical artefacts and is disentangled from <italic>Z</italic><sub><italic>S</italic></sub> (details provided in the <xref ref-type="sec" rid="S9">Methods</xref> section). In the context of large datasets with diverse biological and technical covariates, <italic>Z</italic><sub><italic>I</italic></sub> represents a batch-corrected embedding of the data that identifies cell states faithfully and is suitable for downstream analyses, including clustering, cell annotation, and differential abundance testing (<xref ref-type="fig" rid="F1">Figure 1b</xref>).</p><p id="P10">The latent variable <italic>Z</italic><sub><italic>S</italic></sub> retains information related to spurious correlations typically regressed out during batch correction. We assume that the spurious correlations stemming from data biases are unrelated to the causal explanation of interest, although they are required for a perfect reconstruction of the input data by the model. By learning <italic>Z</italic><sub><italic>S</italic></sub>, the inVAE model enhances interpretability, allowing visualisation of the data biases (<xref ref-type="fig" rid="F1">Figure 1b</xref>). Analysing <italic>Z</italic><sub><italic>S</italic></sub> provides insights into the influence of technical artefacts on sample proximity. Moreover, the independence of <italic>Z</italic><sub><italic>S</italic></sub> from <italic>Z</italic><sub><italic>I</italic></sub> serves as an indicator of model performance, guiding potential adjustments to hyperparameters. To reconstruct the input, a non-linear decoder maps the latent variables <italic>Z</italic> = (<italic>Z</italic><sub><italic>I</italic></sub>, <italic>Z</italic><sub><italic>S</italic></sub>) into the parameters of a negative binomial distribution, which is particularly well-suited for modelling count data frequently encountered in genomic applications (<xref ref-type="fig" rid="F1">Figure 1a</xref>).</p><p id="P11">In order to model the distributional shifts caused by biological or technical factors, inVAE infers conditional prior distributions over both invariant and spurious latent variables (<xref ref-type="fig" rid="F1">Figure 1a</xref>, right). To learn these priors, inVAE utilises Gaussian distributions, directly estimating the means and variances of the distributions as a function of biological (<italic>B</italic>) or technical covariates (<italic>T</italic>) implemented by two separate neural networks. The parameters of these networks are jointly optimized with the rest of the model using backpropagation and the designated loss function. The means of the prior distributions can be further used to derive, for example, the severity across disease conditions or clustering datasets based on their technical artefacts (<xref ref-type="fig" rid="F1">Figure 1b</xref>). Using inVAE, cells from diverse conditions are integrated into a shared phenotypic latent space, and by aligning the latent variable distributions with the conditional prior distributions through Kullback-Leibler (KL) divergence, we capture both common and condition-specific cell states within the invariant representation (details provided in the <xref ref-type="sec" rid="S9">Methods</xref> section).</p><p id="P12">To process a new dataset, reference mapping and label transfer are performed by freezing the weights of the encoder and first inferring the latent representation by reusing previous knowledge about known covariates. For label transfer, a separate classifier is then trained on the invariant latent representation of the new dataset to predict unlabelled cells (details are provided in the <xref ref-type="sec" rid="S9">Methods</xref> section).</p><p id="P13">In summary, inVAE provides a shared representation of multivariate datasets, incorporating prior knowledge such as metadata, into the integration process to accurately identify cell states. inVAE improves interpretability by dissecting the biological and spurious sources of variation.</p></sec><sec id="S3"><title>inVAE accurately identifies disease-specific cell states in human heart failure</title><p id="P14">Recent single-nucleus RNA sequencing (scRNA-seq) analyses of healthy and diseased adult human hearts provide an opportunity to explore disease-specific molecular changes at the cellular level<sup><xref ref-type="bibr" rid="R5">5</xref>,<xref ref-type="bibr" rid="R32">32</xref>–<xref ref-type="bibr" rid="R34">34</xref></sup>. Although pathogenic variants have been identified in genetic cardiomyopathies like dilated cardiomyopathy (DCM) and arrhythmogenic cardiomyopathy (ACM)<sup><xref ref-type="bibr" rid="R35">35</xref></sup>, the shared and unique molecular signatures of the distinct genetic cardiomyopathies in heart failure remain poorly understood. To facilitate such discoveries, comparing the impact of different pathogenic variants is essential<sup><xref ref-type="bibr" rid="R32">32</xref></sup>. However, integrating and identifying cellular populations across samples from individuals of different age, sex, and unknown disease or genetic background poses significant challenges.</p><p id="P15">To assess the capacity of inVAE to link molecular to clinical traits, we used a large dataset of human heart failure<sup><xref ref-type="bibr" rid="R32">32</xref></sup>. We specifically reanalysed snRNA-seq data from explanted ventricular tissues of patients with pathogenic variants in genes related to DCM (<italic>TTN, LMNA</italic>, and <italic>RBM20</italic>) and ACM (<italic>PKP2</italic>) (n=16) as well as controls (n=6). We utilised pathogenic variants and anatomical regions (left and right ventricle) as biological covariates (see <xref ref-type="sec" rid="S9">Methods</xref>). Our final dataset included 284,727 high-quality nuclei from both diseased and healthy left and right ventricles from male and female donors aged 30-60 (<xref ref-type="fig" rid="F2">Figure 2a</xref>).</p><p id="P16">The manifold generated by inVAE accurately identified all cell types previously detected in the original article (<xref ref-type="fig" rid="F2">Figure 2b</xref>), and displayed a clear separation between control and disease samples (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 1</xref>). inVAE outperformed 9 alternative data integration methods (scVI<sup><xref ref-type="bibr" rid="R19">19</xref></sup>, Combat-PCA<sup><xref ref-type="bibr" rid="R36">36</xref></sup>, PCA, scPoli<sup><xref ref-type="bibr" rid="R26">26</xref></sup>, fastMNN<sup><xref ref-type="bibr" rid="R21">21</xref></sup>, scDisInFact<sup><xref ref-type="bibr" rid="R37">37</xref></sup>, scMerge-PCA<sup><xref ref-type="bibr" rid="R38">38</xref></sup>, scanorama<sup><xref ref-type="bibr" rid="R18">18</xref></sup>, harmony<sup><xref ref-type="bibr" rid="R22">22</xref></sup>) in preserving biological variation between diseased and control samples while maintaining comparable performance in batch correction (<xref ref-type="fig" rid="F2">Figure 2c</xref>, see <xref ref-type="sec" rid="S9">Methods</xref>). Conventional metrics for evaluating batch correction usually focus on merging samples from multiple batches. This poses a problem in datasets with multiple diseases, as disease-specific cell states should remain distinct (and not integrated). Thus, what is considered by such methods as “successful batch correction” could risk over-correcting biological differences. To accurately assess the robustness of the inVAE representation of the heart disease dataset, we conducted a detailed analysis of the inferred cell states.</p><p id="P17">The visualisation of our embedding revealed distinct distributions of fibroblasts and cardiomyocytes that were associated with specific genotypes (<xref ref-type="fig" rid="F2">Figure 2b</xref>), unlike in the original study<sup><xref ref-type="bibr" rid="R32">32</xref></sup>, where the manifold masked these associations. We examined if the distribution of cells in inVAE’s manifold revealed known molecular signatures associated with the disease. For this, we first generated meta cells via seaCell<sup><xref ref-type="bibr" rid="R39">39</xref></sup> using inVAE’s embedding of fibroblasts, and identified neighbourhoods enriched for specific genotypes and control samples (<xref ref-type="fig" rid="F2">Figure 2d</xref>). ACM cells (<italic>PKP2</italic> variants) were located in a specific region of the embedding, while DCM variants (<italic>LMNA, TTN</italic>, and <italic>RBM20</italic>) showed higher similarity to each other, resulting in more merged samples. This was further supported by the expression of known genotype-specific genes from the literature, such as the upregulation of <italic>AGTR1</italic> in PKP2 cells, the variable expression of <italic>ARHGAP10, COL4A1, COL4A2</italic>, and <italic>FKBP5</italic> in all disease samples, and the downregulation of <italic>TIMP1</italic> in all disease samples (<xref ref-type="fig" rid="F2">Figure 2e</xref>). Thus, this new embedding successfully highlighted disease-specific differences amongst cells.</p><p id="P18">We next investigated whether inVAE could reveal new cell states. We identified a distinct fibroblast cell state present in both disease and control samples, expressing activated fibroblast markers <italic>POSTN</italic> and <italic>FAP</italic><sup><xref ref-type="bibr" rid="R33">33</xref>,<xref ref-type="bibr" rid="R40">40</xref></sup> (<xref ref-type="fig" rid="F2">Figure 2f</xref>), which was not identified in the original study. These activated fibroblasts were derived from all donors (<xref ref-type="fig" rid="F2">Figure 2g</xref>), suggesting that inVAE successfully corrected for batch effects by aggregating activated fibroblasts from control and disease samples.</p><p id="P19">Additionally, within the representations of both fibroblasts and cardiomyocytes, we identified subsets of cells from DCM hearts (termed DCM cells) that were co-located in the embedding with ACM cells (<xref ref-type="fig" rid="F2">Figure 2b</xref>, we termed these cells ACM-like fibroblasts and ACM-like cardiomyocytes). This suggests that cellular alterations in DCM can resemble ACM changes.</p><p id="P20">To further understand the molecular identity of these newly identified cell types, we first focused on investigating the new fibroblast subsets associated with disease genotype. The ACM-like fibroblasts had an enrichment score for ACM markers (<italic>ARHGAP10, COL4A1, COL4A2</italic>, and <italic>FKBP5</italic>), and a significant overlap in the transcriptomic signatures with ACM cells (<xref ref-type="fig" rid="F2">Figures 2e and 2h</xref>, <xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 2a</xref>). ACM-like fibroblast cells were present across all DCM samples, with most of these samples derived from <italic>TTN</italic> and <italic>RBM20</italic> variants (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 2b</xref>). Pathway enrichment analysis of genes differentially expressed in DCM compared to ACM-like fibroblasts revealed significant enrichment in pathways related to extracellular matrix and collagen organisation, consistent with known transcriptional changes in DCM fibroblasts associated with extracellular matrix and fibrotic progression<sup><xref ref-type="bibr" rid="R42">42</xref></sup> (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 2c-d</xref>).</p><p id="P21">Secondly, we focused on the new cardiomyocyte subsets associated with disease genotype. Using meta cells within the cardiomyocyte embeddings, we identified neighbourhoods significantly enriched for control, <italic>LMNA</italic> (a causal gene of DCM), and <italic>PKP2</italic> (a causal gene of ACM) expressing cells (<xref ref-type="fig" rid="F2">Figure 2i</xref>). Consistent with previous reports<sup><xref ref-type="bibr" rid="R32">32</xref></sup>, DCM upregulated <italic>NPPB</italic> and <italic>ACTA1</italic>, ACM upregulated <italic>PKP2</italic> and <italic>ANKRD1</italic>, while control cells upregulated <italic>MYH6</italic> (<xref ref-type="fig" rid="F2">Figure 2j</xref>). We then calculated enrichment scores for ACM markers (<italic>PKP2</italic> and <italic>ANKRD1</italic>), revealing distribution shifts across ACM, DCM, and control cardiomyocytes, and highlighting the similarity between ACM and ACM-like cardiomyocytes, consistent with our earlier findings (<xref ref-type="fig" rid="F2">Figures 2j and 2k</xref>). Differential expression analysis showed a strong overlap of differentially expressed genes between ACM and ACM-like cardiomyocytes (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 3a</xref>), further demonstrating the robustness of inVAE’s representation. Sample composition indicated that the ACM-like population includes cardiomyocyte cells from all DCM samples, with a predominance of cells harbouring the <italic>TTN</italic> variant, known for being less severe and more responsive to standard therapy than other forms of DCM<sup><xref ref-type="bibr" rid="R43">43</xref></sup> (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 3b</xref>). Pathway enrichment analysis of differentially expressed genes in ACM-like cardiomyocytes showed significant enrichment in mitochondrial function and oxidative phosphorylation, indicating relatively preserved metabolic function in ACM-like cells compared to DCM cells (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 3c-d</xref>). Collectively, these findings suggest that ACM-like cardiomyocytes share phenotypic traits with ACM cardiomyocytes and are marked by preserved metabolic function and lower stress-related gene expression compared to other DCM cells.</p><p id="P22">In summary, inVAE characterises disease-specific cell states including the phenotypic features of distinct genotypes, while capturing known markers and pathways associated with poor outcomes.</p></sec><sec id="S4"><title>inVAE offers enhanced interpretability by accurately disentangling biological signals from noise and generalises to unseen data of human heart failure</title><p id="P23">To demonstrate inVAE’s interpretability and generalizability in a comparable context, we generated a comprehensive atlas of human heart failure and used it to predict disease and cell types in unseen samples, allowing for direct benchmarking against specialized integration methods. We collected and harmonised the annotations of three previously published datasets from 110 donors across three conditions: control, DCM and hypertrophic cardiomyopathy (HCM)<sup><xref ref-type="bibr" rid="R32">32</xref>–<xref ref-type="bibr" rid="R34">34</xref></sup> (see <xref ref-type="sec" rid="S9">Methods</xref>). To evaluate inVAE’s generalizability as a reference model for label transfer, we first split the data into training and testing data. We then built an integrated atlas of the heart using the training data and transferred the labels to the testing data after projecting it on the reference atlas.</p><p id="P24">The training and testing datasets were sourced from different studies, ensuring no overlap in donor IDs (<xref ref-type="fig" rid="F3">Figure 3a</xref>). Two studies containing both control and DCM, from Reichart et al.<sup><xref ref-type="bibr" rid="R32">32</xref></sup> and Kanemaru et al.<sup><xref ref-type="bibr" rid="R33">33</xref></sup>, were used for training. A third study, from Chaffin et al.<sup><xref ref-type="bibr" rid="R34">34</xref></sup> originally containing control, DCM and HCM samples, served as the testing set. We further split the testing data into out-of-sample and out-of-disease to study two different scenarios. In the out-of-sample testing data, the disease conditions matched those in the training subset (i.e. we only considered control and DCM data from Chaffin et al.) (scenario 1, <xref ref-type="fig" rid="F3">Figure 3a</xref>). In contrast, the out-of-disease testing data consisted only of HCM donors from Chaffin et al. (scenario 2, <xref ref-type="fig" rid="F3">Figure 3a</xref>). We anticipated that both scenarios would be challenging due to batch effects expected from different studies, with the out-of-disease scenario (scenario 2) being particularly difficult due to potential biological variation introduced by differing disease conditions.</p><p id="P25">To assess inVAE generalizability for label transfer, we first trained the model exclusively on the training data (from Reichart et al.<sup><xref ref-type="bibr" rid="R32">32</xref></sup> and Kanemaru et al.<sup><xref ref-type="bibr" rid="R33">33</xref></sup>), creating a joint embedding of control and DCM cells. The integration results demonstrated a clear separation between control and disease cells (<xref ref-type="fig" rid="F3">Figure 3a</xref>, right top row). Next, we trained a classifier using the invariant latent representation from the training data and tested the two scenarios. In the first scenario (out-of-sample), where the testing data shares similar conditions with the training data, we used the classifier to predict both cell type and disease status for each cell. The results showed a significant improvement with inVAE (<xref ref-type="fig" rid="F3">Figure 3b</xref>), enhancing its generalizability for label transfer to unseen data. In the second scenario, which involved samples from an unseen disease (out-of-disease), we trained the classifier to predict only cell type labels using the learned latent representation. Cell type prediction is generally easier than disease prediction due to the presence of strong signals distinguishing cell types. The results indicated that inVAE consistently improved cell type classification accuracy, outperforming related methods (<xref ref-type="fig" rid="F3">Figure 3c</xref>).</p><p id="P26">We expected the invariant and spurious latent spaces to be effectively disentangled with minimum shared information. In inVAE’s framework, the invariant representation should capture biological signals, while the spurious representation encodes technical variations. To assess this separation, we trained different classifiers using both invariant and spurious latent variables to predict targets such as donor ID, disease condition, and cell type. A permutation-based importance metric<sup><xref ref-type="bibr" rid="R44">44</xref></sup> assessed the contribution of each latent variable to each prediction target (<xref ref-type="fig" rid="F3">Figure 3d</xref>, <xref ref-type="sec" rid="S9">Methods</xref>). In this analysis, high variable importance suggests relevance to the target prediction. The results revealed that cell type and disease predictions relied primarily on invariant variables, with spurious latent variables having near-zero importance. As expected, donor ID prediction depended mainly on spurious variables. These findings demonstrate that inVAE effectively separates batch effects from biological variation. They also highlight inVAE’s interpretability, which allows validation of this disentanglement—a feature often missing in other batch correction methods that do not explicitly model or remove spurious variations.</p><p id="P27">In summary, inVAE significantly outperforms existing methods in disease and cell type classification, effectively creating representative atlases that capture true biological variation while filtering out technical artefacts. Moreover, inVAE offers a unique advantage by enabling the analysis of the spurious latent space, enhancing model interpretability by pinpointing technical sources. For downstream analyses that rely on invariant representations, the spurious representations provide valuable insights into the excluded information and its dependency on covariates, enriching the overall understanding of the data.</p></sec><sec id="S5"><title>inVAE identifies temporal cell states in human fetal lung</title><p id="P28">Accurate modelling of differentiation trajectories in dynamic biological systems requires time-course single-cell analyses, which capture snapshots of consecutive developmental states. However, integrating these datasets poses challenges due to technical and temporal variations, and existing methods often struggle to account for cellular dynamics. We next used inVAE to infer a representation of real dynamic systems that maintains the developmental stage of cells.</p><p id="P29">We applied inVAE to a temporal single-cell transcriptomics atlas of the human fetal lung<sup><xref ref-type="bibr" rid="R45">45</xref></sup>, which includes 65,564 cells from 29 donors and 8 time points spanning 5–22 post-conception weeks (PCWs) (<xref ref-type="fig" rid="F4">Figure 4a</xref>, <xref ref-type="sec" rid="S9">Methods</xref>). The integrated single-cell atlas using inVAE successfully identified all 144 cell states previously characterised in the original study using principal component analysis<sup><xref ref-type="bibr" rid="R45">45</xref></sup> (<xref ref-type="fig" rid="F4">Figure 4b</xref>, <xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 4</xref>). We also integrated the data using 4 additional methods (scVI, Combat-PCA, PCA, scPoli) and observed an improvement in batch effect correction and bio-conservation (<xref ref-type="fig" rid="F4">Figure 4c</xref>).</p><p id="P30">In the fetal lung, epithelial cells progress through differentiation from tips to stalks to airway progenitors, with additional temporal variations influencing each stage (<xref ref-type="fig" rid="F4">Figure 4d</xref>, bottom). This means that at each temporal stage–early (5–6 PCW), mid (9–11 PCW), and late (15–22 PCW)–the identity of tips, stalks, and airway progenitors evolve. By including developmental stages as biological covariates, inVAE accurately captured these temporal variations among epithelial cells while preserving their developmental trajectories (<xref ref-type="fig" rid="F4">Figure 4d-e</xref>). In the inVAE manifold, cell states follow a developmental trajectory along the vertical axis (from tip to stalk to early airway) and reveal temporal state changes along the horizontal axis (from early to mid to late) (<xref ref-type="fig" rid="F4">Figure 4d</xref>, top). These dynamic cell transitions along the horizontal axis were not captured in the original manifold, where cells were grouped as distinct populations by their stage (early, mid, and late).</p><p id="P31">Stage-specific markers (<italic>TPPP3, MAD2L2, and ADM</italic>) showed a gradient of change across the early-mid-late axis (<xref ref-type="fig" rid="F4">Figure 4f</xref>). To quantify the accuracy of the cellular transition within the latent representation, we applied Milo<sup><xref ref-type="bibr" rid="R46">46</xref></sup>, which assigns cells to partially overlapping neighbourhoods on a k-nearest neighbour graph (<xref ref-type="fig" rid="F4">Figure 4g</xref>). This approach, based on cell-cell similarity within inVAE’s latent space, allowed us to assess the model’s representation. Results showed a strong correlation between the mean expression of key markers and neighbourhood-stage (<xref ref-type="fig" rid="F4">Figure 4h</xref>), confirming inVAE’s ability to capture both temporal and lineage-specific transitions in cell states.</p><p id="P32">Additionally, we identified two distinct cell states with unique transcriptomic signatures in late tip cells at 15 and 18 PCW, which were not observed in the original study (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 5a</xref>). Using scFates<sup><xref ref-type="bibr" rid="R47">47</xref></sup> on inVAE’s latent embedding, we inferred the pseudo-ordering of cells along the tip axis and identified genes with dynamic changes throughout this transition (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 5b</xref>). The analysis revealed distinct gene modules associated with each stage of the trajectory, which were also differentially expressed between the two late tip cell states (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 5b</xref>). Among these gene modules, we highlight the expression patterns of three genes with distinct expression patterns: <italic>TPPP3, CD36</italic><sup><xref ref-type="bibr" rid="R48">48</xref></sup>, and <italic>EEF1G</italic> (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 5c</xref>).</p><p id="P33">Airway progenitor and stalk cells differentiate into either pulmonary or <italic>GHRL</italic>+ neuroendocrine cells as described by He et al.<sup><xref ref-type="bibr" rid="R45">45</xref></sup> (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 6a</xref>). Using PAGA trajectory inference on inVAE’s latent embedding, we accurately derived these developmental trajectories, which were further validated by the expression of specific markers, including <italic>ASCL1, MAD2L1, NEUROD1, NKX2-2</italic>, and <italic>NEUROG3</italic><sup><xref ref-type="bibr" rid="R45">45</xref></sup> (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 6b-d</xref>). Thus, the inVAE’s embedding captures final cell states and, in addition, suggests that the starting population previously defined “as airway progenitors and stalk cells” may already be developmentally skewed to distinct fates, with airway progenitors more closely linked to <italic>GHRL</italic>+ NE and stalk cells to pulmonary NE cells (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 6c</xref>).</p><p id="P34">In conclusion, inVAE successfully identified high-resolution cell states in the fetal lung, derived both developmental trajectories and temporal cell states in epithelial cells, and suggested an earlier cell fate split in the neuroendocrine developmental trajectories.</p></sec><sec id="S6"><title>inVAE unravels spatial cell-state variability in adult human lung</title><p id="P35">We next applied inVAE’s to disentangle spatially resolved cell states using a high-resolution single-cell atlas of the healthy human lung<sup><xref ref-type="bibr" rid="R49">49</xref></sup>, which encompasses data from five anatomical locations along the proximal-to-distal axis (<xref ref-type="fig" rid="F5">Figure 5a</xref>). This atlas is comprehensively annotated with 78 distinct cell types derived from single-cell and single-nucleus RNA sequencing of the trachea, two bronchi, and upper and lower parenchyma regions.</p><p id="P36">By training inVAE with anatomical regions as biological covariates, we captured high-resolution spatial variation in cell type distributions, achieving greater bio-conservation and better batch correction than conventional methods (<xref ref-type="fig" rid="F5">Figures 5b-d</xref>). inVAE highlighted unique spatial and functional characteristics in alveolar type 1 (AT1) cells, responsible for gas exchange (<xref ref-type="fig" rid="F5">Figures 5e</xref>), and in the ciliated cells lining the airways (<xref ref-type="fig" rid="F5">Figures 5j</xref>). Using Hotspot<sup><xref ref-type="bibr" rid="R50">50</xref></sup> we identified key pathways and gene modules enriched in specific spatial regions (see <xref ref-type="sec" rid="S9">Methods</xref>).</p><p id="P37">In AT1 cells, we identified eight gene modules with distinct spatial patterns (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 7a</xref>). The lower parenchyma was particularly distinct from other lung regions, with module 7 showing the strongest association with this area (<xref ref-type="fig" rid="F5">Figure 5f</xref>). In the experimental design of this study each sequencing pool contained samples from each region, but with each region being derived from a different donor. <xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 8a</xref> shows that the high contribution of module 7 to the lower lobe signature was consistent across all donors analysed, and did not track with the sequencing pool. We used gene autocorrelation metrics—Z-scores and p-values—to find the expression patterns among the top differentially expressed genes (<xref ref-type="fig" rid="F5">Figure 5g</xref>). Pathway enrichment analysis identified significant pathways, including TGF-beta<sup><xref ref-type="bibr" rid="R51">51</xref></sup>, EGF-EGFR<sup><xref ref-type="bibr" rid="R52">52</xref></sup>, PDGF<sup><xref ref-type="bibr" rid="R53">53</xref></sup>, and VEGFA-VEGFR2<sup><xref ref-type="bibr" rid="R54">54</xref></sup>, known to contribute to lung fibrosis, a condition that often begins in the lower lobes<sup><xref ref-type="bibr" rid="R55">55</xref></sup> (<xref ref-type="fig" rid="F5">Figures 5h–i</xref>).</p><p id="P38">Ciliated cells exhibit spatial differences across lung regions, leading to functional variations<sup><xref ref-type="bibr" rid="R56">56</xref>,<xref ref-type="bibr" rid="R57">57</xref></sup>. Using inVAE’s embedding, Hotspot identified five gene modules for ciliated cells (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 7b</xref>), with module 4 highly expressed in the lower parenchyma (<xref ref-type="fig" rid="F5">Figure 5k</xref>), and unbiasedly distributed across donors and sequencing pools (<xref ref-type="supplementary-material" rid="SD1">Supplementary Figure 8b</xref>). Enrichment analysis revealed that ciliated cells in the lower left parenchyma are primarily enriched in netrin signalling and other growth factor related pathways (<xref ref-type="fig" rid="F5">Figures 5m-n</xref>)<sup><xref ref-type="bibr" rid="R58">58</xref></sup>. Netrin-1 has been linked to pulmonary fibrosis and interstitial lung disease rheumatoid arthritis patients<sup><xref ref-type="bibr" rid="R59">59</xref></sup>. While previous studies have provided limited insights into the regional variation of ciliated cells, our analysis identifies specific gene modules and signalling pathways associated with distal lower bronchi, offering new perspectives on their function and regulation throughout the lung.</p><p id="P39">In summary, inVAE uncovered not only spatially-resolved cell states but also preserved key gene expression patterns unique to specific lung regions, demonstrating its ability to highlight spatially significant variations across cell types.</p></sec></sec><sec id="S7" sec-type="discussion"><title>Discussion</title><p id="P40">inVAE is a generative representation learning model designed to incorporate biological covariates, infer conditional cell distributions, and retain essential and subtle biological variations. inVAE represents the latent space with two sets of variables: invariant and spurious. By disentangling these two representations, it enhances the interpretability of the latent space by dissecting the sources of variation in the data. The invariant representations are suited for downstream analyses like high-resolution cell state identification, while spurious representations capture the distribution of biases across cells or samples. inVAE infers prior distributions of cells specific to each biological condition, like disease variants, or technical biases like study. This provides insights into both biological and technical variation across samples with potential implications for understanding pathogenesis, identifying biomarkers, and discovering drug targets<sup><xref ref-type="bibr" rid="R10">10</xref>,<xref ref-type="bibr" rid="R12">12</xref>,<xref ref-type="bibr" rid="R33">33</xref>,<xref ref-type="bibr" rid="R60">60</xref>–<xref ref-type="bibr" rid="R62">62</xref></sup>. While invariant representation models<sup><xref ref-type="bibr" rid="R63">63</xref>–<xref ref-type="bibr" rid="R66">66</xref></sup> are known to generalise well to unseen datasets generated under similar conditions, inVAE transfers labels to new datasets and, crucially, identifies novel cell states when the cells in a new dataset undergo domain shifts, such as those caused by previously unseen diseases.</p><p id="P41">We validated inVAE’s capabilities through four complex data integration tasks aimed at identifying cell states from samples with diverse biological conditions. In the first task, we generated a human heart atlas encompassing both healthy and diseased samples, showing that inVAE could stratify donors based on the genetic impact of pathogenic variants with higher resolution than previous methods. For the second task, we expanded this atlas to include samples from three distinct studies, demonstrating the model’s ability to generalise to unseen data, including samples from previously unobserved disease conditions, with significant improvements in cell and disease annotations over leading methods. In the third task, inVAE successfully captured temporal cell states and inferred realistic temporal cell state relationships from human lung developmental data. Future experimental work will be required to validate these suggested cell states in vivo. In the final task, inVAE identified spatial cell states in spatially-resolved datasets of human lung cells, and highlighted gene modules and signalling pathways that reflect regional variations of AT1 and ciliated cells. Identified gene modules were linked to fibrosis, recapitulating the known spatial distribution of this disease. Collectively, inVAE allowed for the identification of new cell states, more precise pathway enrichment, and enhanced differential expression gene analysis through improved sample stratification.</p><p id="P42">In this manuscript, we demonstrated the success of inVAE in integrating large cohorts using categorical covariates such as disease variants modeled with one-hot encoders. However, some real-world applications might involve continuous covariates, such as spatial positions of cells along a spatial axis. Although inVAE supports continuous covariates through multi-layer perceptron (MLP) encoders, we have not extensively tested this capability, leaving it as an interesting direction for future work. Additionally, the one-hot encoding of categorical covariates treats them as independent variables, with equal distances between encoded categories. While the model effectively infers the similarities and differences across prior distributions, it could benefit from incorporating hierarchical structures or prior knowledge about the relationships between covariates. For instance, in disease modeling, where certain variants may share closer biological similarities, leveraging this information could reduce the search space and accelerate convergence. However, integrating such prior knowledge would require reliable biological metrics to assess these relationships, offering an exciting avenue for future exploration.</p><p id="P43">While our current evaluation focuses on single-cell transcriptomics, we envision future applications of inVAE in integrating other modalities. In addition to the negative binomial distribution, Poisson and Gaussian distributions are already implemented, enabling the integration of scATAC-seq and spatial data. Another promising future direction for inVAE is the identification of key genes—whether causal, condition-specific targets, or those predominantly influenced by noise—providing deeper insights into disease mechanisms.</p><p id="P44">In conclusion, inVAE enables comprehensive analysis of multivariate data while disentangling true biological signals from technical biases. We anticipate that inVAE will play a key role in large-scale atlasing efforts, helping to stratify patients based on various biological factors and across a range of diseases.</p></sec><sec id="S8" sec-type="methods"><title>Methods</title><sec id="S9"><title>Ethics statement</title><p id="P45">This study relies on the analysis of previously published data, which were collected with written informed consent obtained from all participants and comply with the ethical guidelines for human samples.</p></sec><sec id="S10"><title>Data preprocessing</title><p id="P46">The inVAE models were trained using raw counts. Further details are explained in the following.</p></sec><sec id="S11"><title>Reichart et al. heart data preprocessing</title><p id="P47">The raw gene expression data was downloaded from Reichart et al.<sup><xref ref-type="bibr" rid="R32">32</xref></sup>. For this study, we selected samples from control, TNN, LMNA, RBM20, and PKP2 donors aged 30–60. This preprocessing resulted in a final dataset of 284,727 cells and 5,000 highly variable genes, which were used for training.</p></sec><sec id="S12"><title>Heart atlas data curation</title><p id="P48">We collected the raw gene expression counts from three studies—Kanemaru et al. (2023), Reichart et al.<sup><xref ref-type="bibr" rid="R32">32</xref></sup>, and Chaffin et al.<sup><xref ref-type="bibr" rid="R34">34</xref></sup>. We randomly selected 400,000 cells due to resource constraints. We used Scanpy package<sup><xref ref-type="bibr" rid="R67">67</xref></sup> to filter out low-quality cells, removing those with counts lower than 500 and higher than 15,000. Doublets were removed using Scrublet<sup><xref ref-type="bibr" rid="R68">68</xref></sup>, retaining cells with a doublet score below 0.2. We trained the models using 4,000 highly variable genes and 167,633 cells in total. The annotations were harmonised across the three studies using celltypist<sup><xref ref-type="bibr" rid="R69">69</xref></sup>.</p></sec><sec id="S13"><title>Splitting heart atlas data into train, test, and validation</title><p id="P49">The filtered heart atlas data was divided into training and validation sets by randomly selecting 90% (n=167,633) and 10% (n=18,625) of the cells from both the Kanemaru et al.<sup><xref ref-type="bibr" rid="R33">33</xref></sup> and Reichart et al.<sup><xref ref-type="bibr" rid="R32">32</xref></sup> studies, respectively. For scenario 1, the test set consisted of cells (n=84,801) from the Chaffin et al.<sup><xref ref-type="bibr" rid="R34">34</xref></sup> study under the same conditions as the training and validation sets, specifically control and DCM. In scenario 2, the test set included cells (n=52,270) from the Chaffin et al. study collected from donors with HCM, representing an unseen condition during training.</p></sec><sec id="S14"><title>Fetal lung data preprocessing</title><p id="P50">We re-analysed the fetal lung atlas in He et al.<sup><xref ref-type="bibr" rid="R45">45</xref></sup> using the set of highly variable genes (n=5101) identified in the original study. To refine this gene set, we removed a cluster of genes (n=121) associated with cell cycle activity (e.g., CDK1, MKI67, CCNB2) by applying Leiden clustering<sup><xref ref-type="bibr" rid="R70">70</xref></sup> in PCA space (n_pcs=15) of the genes using Scanpy. This preprocessing resulted in a dataset comprising 65,564 cells and 4,980 highly variable genes, which was subsequently used for training.</p></sec><sec id="S15"><title>Spatial lung data preprocessing</title><p id="P51">The raw gene expression data was downloaded from Madissoon et al.<sup><xref ref-type="bibr" rid="R49">49</xref></sup>. A total of 193108 cells and 4000 highly variable genes identified by the original paper were used for training.</p></sec><sec id="S16"><title>inVAE method</title><p id="P52">inVAE is a semi-supervised deep generative model that builds upon the framework of identifiable Variational Auto-Encoders (iVAE)<sup><xref ref-type="bibr" rid="R71">71</xref></sup>. The primary purpose of inVAE is to disentangle latent factors into two components: an invariant latent representation and a spurious one. This allows the model to distinguish signals originating from biological variations from those unwanted, like technical noise.</p></sec><sec id="S17"><title>Notations</title><p id="P53">In inVAE’s model, the variable <italic>X</italic> ∈ <italic>N</italic><sub>0</sub><sup><italic>n</italic>×<italic>m</italic></sup> represents the observed data, such as gene expression counts in single-cell genomics, with <italic>n</italic> cells and <italic>m</italic> genes. The variable <italic>B</italic> ∈ <italic>R</italic> <sup><italic>n</italic>×<italic>b</italic></sup> refers to biological or condition-specific covariates such as cell types or disease states, with <italic>b</italic> the number of dimensions resulting from concatenating one-hot encoded or continuous covariates. <italic>T</italic> ∈ <italic>R</italic><sup><italic>n</italic>×<italic>t</italic></sup> represents batch or technical covariates that may introduce unwanted variability, for example, sequencing technologies, with again <italic>t</italic> the number of dimensions resulting from concatenation. The latent representation is denoted by <italic>Z</italic> ∈ <italic>R</italic><sup><italic>n</italic>×(<italic>k</italic>+<italic>l</italic>)</sup>, which is further composed of two components: an invariant latent representation <italic>Z</italic><sub><italic>I</italic></sub> ∈ <italic>R</italic><sup><italic>k</italic></sup> and a spurious latent representation <italic>Z</italic><sub><italic>S</italic></sub> ∈ <italic>R</italic><sup><italic>l</italic></sup>, such that <italic>Z</italic> = (<italic>Z</italic><sub><italic>I</italic></sub>, <italic>Z</italic><sub><italic>S</italic></sub>). The component <italic>Z</italic><sub><italic>I</italic></sub> represents the invariant latent representation, which encodes biological signals that are consistent across conditions, whereas <italic>Z</italic><sub><italic>S</italic></sub> represents the spurious latent representation, which encodes technical noise or other unwanted variations. The approximate posterior distribution over the latent variables <italic>Z</italic>, given the observed variables <italic>X, B, T</italic>, is denoted by <italic>q</italic><sub><italic>ϕ</italic></sub>(<italic>Z</italic>|<italic>X, B, T</italic>). This distribution is parameterized by a neural network with parameters <italic>ϕ</italic>. The prior distribution over the latent variables is denoted by <italic>p</italic><sub><italic>θ</italic></sub>(<italic>Z</italic>|<italic>B, T</italic>), which can be further decomposed into the conditional priors <inline-formula><mml:math id="M1"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>I</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>B</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> and <inline-formula><mml:math id="M2"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>S</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>S</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>. The likelihood of the observed data <italic>X</italic> given the latent variables <italic>Z</italic> is represented by <italic>p</italic><sub><italic>f</italic></sub>(<italic>X</italic>|<italic>Z</italic>), which is parameterized by a neural network with parameters <italic>f</italic>.</p></sec><sec id="S18"><title>Framework</title><p id="P54">inVAE encodes observed data <italic>X</italic>, along with biological covariates <italic>B</italic> and technical covariates <italic>T</italic>, into a structured latent space <italic>Z</italic> that consists of an invariant latent representation <italic>Z</italic><sub><italic>I</italic></sub> and a spurious latent representation <italic>Z</italic><sub><italic>S</italic></sub>. To achieve this, inVAE employs an encoder parameterized by a neural network that maps the inputs (<italic>X, B, T</italic>) to the approximate posterior distribution <italic>q</italic><sub><italic>ϕ</italic></sub>(<italic>Z</italic> ∣ <italic>X, B, T</italic>). This distribution is modelled as a Gaussian distribution with a mean and variance parameterized by a neural network with parameters <italic>ϕ</italic>.</p><p id="P55">The latent representation <italic>Z</italic> is then used by the decoder to reconstruct the observed data. Specifically, the latent variables <italic>Z</italic> = (<italic>Z</italic><sub><italic>I</italic></sub>, <italic>Z</italic><sub><italic>S</italic></sub>) are passed through a decoder, which generates parameters for the data likelihood <italic>p</italic><sub><italic>f</italic></sub>(<italic>X</italic>|<italic>Z</italic>). The data likelihood follows a Negative Binomial distribution, which is suitable for modelling count data and a popular choice for gene expression levels in single-cell genomics. In theory, any other sensible distribution could be used.</p><p id="P56">In the inVAE framework, two distinct conditional priors are assumed for the latent space. The first prior distribution is for the invariant latent representation and is denoted as <inline-formula><mml:math id="M3"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>I</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>B</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>. This prior belongs to a general exponential family distribution and aims to capture dependencies that arise from biological mechanisms that remain invariant across different biological conditions. The use of an exponential family prior provides flexibility and allows the model to effectively represent complex interdependencies between invariant latent variables. The second prior distribution is for the spurious latent representation, denoted as <inline-formula><mml:math id="M4"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>S</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>S</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>, and captures the technical variations that are specific to different conditions, such as batch effects or other forms of technical noise. In practice, both priors are modelled as Gaussian distributions with diagonal covariance.</p><p id="P57">By assuming different priors for the invariant and spurious latent representations, inVAE can disentangle biological signals from technical noise. This disentanglement is particularly important for preserving the biological variability across datasets while mitigating the effects of technical artefacts.</p></sec><sec id="S19"><title>Loss function</title><p id="P58">The training of the inVAE model is conducted by optimising evidence lower bound (ELBO) that consists of a data reconstruction term and a regularisation term involving the KL divergence between the approximate posterior and the prior distribution. The ELBO is defined as: <disp-formula id="FD1"><mml:math id="M5"><mml:mrow><mml:msub><mml:mi>L</mml:mi><mml:mrow><mml:mi>E</mml:mi><mml:mi>L</mml:mi><mml:mi>B</mml:mi><mml:mi>O</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>Z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mo>,</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mi>T</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi>l</mml:mi><mml:mi>o</mml:mi><mml:mi>g</mml:mi><mml:mspace width="0.2em"/><mml:msub><mml:mi>p</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>X</mml:mi><mml:mo>∣</mml:mo><mml:mi>Z</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>β</mml:mi><mml:mo>⋅</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>K</mml:mi><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>Z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mo>,</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mi>T</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>‖</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mi>θ</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>Z</mml:mi><mml:mo>∣</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mi>T</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula>
</p><p id="P59">This term encourages the model to reconstruct the observed data accurately while regularising the latent space to follow the inferred prior distributions for <italic>Z</italic><sub><italic>I</italic></sub> and <italic>Z</italic><sub><italic>S</italic></sub>. In practice, we set <italic>β</italic> = 1 and perform a linear warm up for a small number of iterations from 0 to 1, such that first, a good reconstruction is ensured, and then the regularisation strength is increased. Disentanglement is implicitly encouraged as the number of latent dimensions for both the invariant and spurious latent space is restricted, and the reconstruction by the decoder is more effective if the information contained in the latent space is not duplicated. Furthermore, the conditionally independent priors on the latent spaces additionally encourage them to depend on the conditioning variables. We can further enforce independence between <italic>Z</italic><sub><italic>I</italic></sub> and <italic>Z</italic><sub><italic>S</italic></sub> by minimizing their total correlation. The total correlation is a measure of dependence between two random variables, and penalizing this correlation encourages the model to learn statistically independent factors<sup><xref ref-type="bibr" rid="R72">72</xref>,<xref ref-type="bibr" rid="R73">73</xref></sup>: <disp-formula id="FD2"><mml:math id="M6"><mml:mrow><mml:msub><mml:mi>L</mml:mi><mml:mrow><mml:mi>T</mml:mi><mml:mi>C</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:msup><mml:mi>β</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo>⋅</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>K</mml:mi><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>Z</mml:mi><mml:mo>∣</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mi>T</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>‖</mml:mo><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>I</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>S</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mi>T</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula>
</p><p id="P60">Measuring <italic>q</italic><sub><italic>ϕ</italic></sub> (<italic>Z</italic>|<italic>B, T</italic>) requires the evaluation of the density <inline-formula><mml:math id="M7"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>p</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>X</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:msub><mml:mi>X</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mi>T</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>, where <italic>p</italic>(<italic>X</italic><sub><italic>n</italic></sub>|<italic>B, T</italic>) is the probability of observing sample <italic>X</italic><sub><italic>n</italic></sub> ∈ <italic>X</italic> in domain (<italic>B, T</italic>). To solve this in practice, we extended the minibatch-weighted sampling proposed by Chen et al<sup><xref ref-type="bibr" rid="R73">73</xref></sup>.</p></sec><sec id="S20"><title>Data Representation</title><p id="P61">After training the model, we can use the learned encoder to represent the data as the mean of the underlying Gaussian distribution, using all available covariates, and can then optionally split the latent representation into the invariant and spurious parts.</p></sec><sec id="S21"><title>Prediction, reference mapping, and label transfer</title><p id="P62">For predicting annotations, e.g. cell types or diseases, a separate multilayer perceptron (MLP) can be trained using the invariant latent representation of the data. The MLP is trained in a supervised manner using the cell labels or metadata in the training data by predicting the labels from the invariant latent representation and backpropagating the cross-entropy loss of the predicted and ground-truth label.</p><p id="P63">Reference mapping is performed by employing the learned encoder and the available information in the form of gene counts and additional metadata and then taking the invariant part of the inferred mean of the latent distribution. In the straightforward approach, we simply use the known categories of the covariates or, for a new category, treat the corresponding one-hot encoded vector as all zeros. A more involved approach would infer the most suitable one-hot encoded vector for a new category. This can be done by selecting exactly one of the known categories that maximises the decoder density after passing all possible combinations to the encoder and decoder to reconstruct the input <italic>X</italic>. Another solution is to directly optimise the one-hot encoded vector by treating it as a parameter and performing backpropagation to maximise the decoder density with respect to the covariate vector. This results in a continuous version of the one-hot vector where multiple entries can be non-zero. In the classification experiments, we used the straightforward approach to show that our method already works well without using more complicated inference schemes.</p><p id="P64">After inferring the covariate vectors and the invariant latent representation, we can transfer labels by feeding this invariant latent presentation to the previously trained MLP to predict the reference labels.</p></sec><sec id="S22"><title>Hyperparameter</title><p id="P65">The inVAE model includes several key hyperparameters that impact both the training process and the quality of learned representations. In this section, we focus on hyperparameters specifically related to the model architecture, regularisation, and disentanglement objectives, along with default settings and alternative configurations.</p><p id="P66">Two of the most critical hyperparameters are the dimensions of the latent and spurious latent spaces, with default values of 30 and 5, respectively, for larger datasets. However, these values may be adjusted based on the number of cells, conditions, and the level of technical variation present in the data.</p><p id="P67">The neural network structure—shared across the encoder, decoder, and prior networks—includes several architectural parameters. These include the number of hidden layers, set by default to two; the hidden layer dimensions, set to 128; and the activation function, which is ReLU. Batch normalisation and dropout are also configurable, with default values set to True and a dropout rate of 0.1, respectively. We observed that these default values worked commonly well across all the datasets in this paper.</p><p id="P68">Conditional priors for latent variables can be modified to depend on selected covariates, as detailed in the following section. For the Gaussian distribution used in the priors, the default setting fixes the mean at zero while allowing the variance to be learned. However, depending on the data, the mean can be learned as well.</p><p id="P69">By default, the decoder models the observed data using a Negative Binomial distribution, although other distributions—such as Gaussian for normalised gene expression data or Poisson for raw count data—are also possible.</p><p id="P70">The batch size, set to 256, determines the number of samples processed per update of model parameters. Larger batch sizes generally yield more stable gradient estimates but require additional memory.</p><p id="P71">Lastly, an option is available to incorporate spurious covariates, such as batch ID, directly into the latent space via one-hot encoding, similar to the approach in scVI<sup><xref ref-type="bibr" rid="R19">19</xref></sup>. This setting bypasses the need to learn a separate spurious latent representation, effectively reducing the spurious latent dimension to zero. While this can help remove technical variation in some datasets, it should be used cautiously to avoid potential overcorrection.</p></sec><sec id="S23"><title>Covariates</title><p id="P72">Covariates can serve as inputs to either the conditional prior of the invariant latent space or the spurious latent space. The combined set of covariates is appended to the gene expression counts and then fed into the encoder of inVAE. Continuous covariates are input directly, with any necessary transformations applied beforehand, while categorical covariates are encoded as one-hot vectors, with the number of categories specified at initialization. For categorical covariates not observed during inference, all entries are set to zero. In this paper, all covariates are treated as categorical variables.</p></sec><sec id="S24"><title>Feature Importance</title><p id="P73">The feature importance of inVAE’s latent space is assessed by first training a separate random forest classifier from scikit-learn<sup><xref ref-type="bibr" rid="R44">44</xref></sup> for each covariate, using the entire latent space (both invariant and spurious) across the dataset. Next, we used the ‘permutation_importance’ function in scikit-learn<sup><xref ref-type="bibr" rid="R44">44</xref></sup>, with 10 repetitions, to estimate the importance of each latent variable. This approach permutes each feature individually and calculates the difference between the original score and the mean score of the permuted versions, providing a more robust estimate of feature importance, particularly for prediction targets with high cardinality, such as batch ID.</p></sec><sec id="S25"><title>Classification</title><p id="P74">Classification is conducted by initially training each integration method using its default or recommended hyperparameters, with the latent space dimension set to 30 for consistency across models. For cell type prediction, each method’s built-in classifier is utilised; in inVAE’s case, this is a shallow MLP with a single hidden layer of dimension 50. For the other prediction targets—disease status and combined cell type-disease status—a separate MLP with the same configuration is trained on each model’s latent space.</p></sec><sec id="S26"><title>Benchmarking of scRNA-seq Integration Methods</title><p id="P75">We benchmarked several tools to assess the performance of scRNA-seq integration (batch correction), including scVI<sup><xref ref-type="bibr" rid="R19">19</xref></sup>, Combat-PCA<sup><xref ref-type="bibr" rid="R36">36</xref></sup>, PCA, scPoli<sup><xref ref-type="bibr" rid="R26">26</xref></sup>, fastMNN<sup><xref ref-type="bibr" rid="R21">21</xref></sup>, scDisInFact<sup><xref ref-type="bibr" rid="R37">37</xref></sup>, scMerge-PCA<sup><xref ref-type="bibr" rid="R38">38</xref></sup>, scanorama<sup><xref ref-type="bibr" rid="R18">18</xref></sup>, and harmony<sup><xref ref-type="bibr" rid="R22">22</xref></sup>. The evaluation was conducted using the scib-metrics package<sup><xref ref-type="bibr" rid="R41">41</xref></sup>, calculating metrics based on embeddings generated by each method. For tools that output a corrected matrix rather than embeddings, we applied PCA to the corrected matrices for a standardised comparison. The input data was provided in h5ad format for direct access in Python, while R-based tools used data via the schard package<sup><xref ref-type="bibr" rid="R74">74</xref></sup>.</p><p id="P76"><bold>Combat</bold> was executed in Python using Scanpy’s combat function, specifying donor ID as the batch key. PCA was run with 25 dimensions for heart data and 30 for lung data, as Combat does not directly produce embeddings.</p><p id="P77"><bold>scVI</bold> was implemented using the scVI Python package, with donor ID set as the batch_key and n_latent dimensions set to 25 for heart and 30 for lung. Default parameters were used (n_layers=2, gene_likelihood=“nb”).</p><p id="P78"><bold>Harmony</bold> was run using a PyTorch-based version of the Harmony package (originally in R). First, we computed PCA embeddings with 25 components for heart data and 30 for lung data. These embeddings were then passed to the harmonise function, with donor ID specified as the batch_key.</p><p id="P79"><bold>scMerge</bold> was executed using the scMerge2 function from its R package, with donor ID set as the batch key and disease as the condition, employing default settings (k_celltype=20). Since scMerge does not output embeddings directly, PCA with 25 dimensions for heart and 30 for lung data was applied afterward.</p><p id="P80"><bold>Scanorama</bold> was applied using the scanorama package in Python. The input data was divided into separate objects based on donor ID (batch), and integration was performed using the integrate_scanpy function with 25 dimensions for heart and 30 for lung. The resulting embeddings from individual objects were then concatenated.</p><p id="P81"><bold>fastMNN</bold> was implemented using the batchelor package in R, with donor ID specified as the batch key and the number of dimensions (d) set to 25 for heart and 30 for lung. As fastMNN does not generate embeddings directly, we applied PCA with 25 dimensions for heart and 30 for lung to ensure consistency across methods.</p></sec></sec><sec id="S27"><title>Metrics</title><sec id="S28"><title>Data integration metrics</title><p id="P82">We evaluated the quality of data integration using established metrics for assessing single-cell data integration, all implemented in the scIB package<sup><xref ref-type="bibr" rid="R41">41</xref></sup>. Biological conservation was quantified using the following metrics: Cell Type Average Silhouette Width (ASW), Isolated Label F1, Isolated Label Silhouette, Normalised Mutual Information (NMI), and Adjusted Rand Index (ARI). Batch mixing was assessed with Graph Connectivity and Batch ASW.</p><p id="P83"><bold>Normalised Mutual Information (NMI)</bold> measures the overlap between two clusterings, calculated between cell type labels and clusters derived from unsupervised clustering of the integrated dataset. NMI values range from 0 to 1, where 1 indicates a perfect match between clusterings, and 0 indicates no overlap.</p><p id="P84"><bold>Adjusted Rand Index (ARI)</bold> assesses the similarity between two clusterings by considering both matching overlaps and correct disagreements. This score is calculated between the cell type labels and the clusters on the integrated dataset, ranging from 0 to 1, with 1 representing a perfect score.</p><p id="P85"><bold>kBET (k-nearest neighbour Batch Effect Test)</bold> evaluates whether the label composition within the k nearest neighbours of a cell matches the expected global label composition. This test is repeated across a random subset of cells, with results reported as a rejection rate across tested neighbourhoods, operating on a K-nearest-neighbour (KNN) graph.</p><p id="P86"><bold>Cell Type Average Silhouette Width (ASW)</bold> quantifies the relationship between the within-cluster distance of a cell and its between-cluster distance to the nearest other cluster. Scores range from -1 to 1, where -1 indicates complete misclassification, 0 indicates cluster overlap, and 1 indicates well-separated clusters. We use two versions of ASW: one based on cell type labels and a modified version for batch mixing (Batch ASW). The ASW score is rescaled to values between 0 and 1 using the following equation: <disp-formula id="FD3"><mml:math id="M8"><mml:mrow><mml:mspace width="0.2em"/><mml:mi>c</mml:mi><mml:mi>e</mml:mi><mml:mi>l</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi><mml:mi>y</mml:mi><mml:mi>p</mml:mi><mml:mi>e</mml:mi><mml:mspace width="0.2em"/><mml:mi>A</mml:mi><mml:mi>S</mml:mi><mml:mi>W</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>A</mml:mi><mml:mi>S</mml:mi><mml:msub><mml:mi>W</mml:mi><mml:mi>C</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where C represents the set of all cell type labels.</p><sec id="S29"><title>Batch ASW (Average Silhouette Width)</title><p id="P87">The batch ASW quantifies the quality of batch mixing in the integrated object. We obtain it by computing the ASW but on batch labels instead of cell type labels. Scores of 0 are indicative of good batch mixing, while any deviation from this score is the result of batch effects. In order to have a metric bound between 0 and 1, the following transformation is applied: <disp-formula id="FD4"><mml:math id="M9"><mml:mrow><mml:mspace width="0.2em"/><mml:mi>b</mml:mi><mml:mi>a</mml:mi><mml:mi>t</mml:mi><mml:mi>c</mml:mi><mml:mi>h</mml:mi><mml:mspace width="0.2em"/><mml:mi>A</mml:mi><mml:mi>S</mml:mi><mml:msub><mml:mi>W</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mstyle displaystyle="true"><mml:mi>∑</mml:mi></mml:mstyle><mml:mspace width="0.2em"/></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:munder><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>b</mml:mi><mml:mi>a</mml:mi><mml:mi>t</mml:mi><mml:mi>c</mml:mi><mml:mi>h</mml:mi><mml:mspace width="0.2em"/></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula>
</p><p id="P88">Here, <italic>C</italic><sub><italic>j</italic></sub> is the set of cells with label <italic>j</italic> and |<italic>C</italic><sub><italic>j</italic></sub>| is the support of the set.</p><p id="P89">The final score is obtained by averaging the batch ASW values obtained for each label: <disp-formula id="FD5"><mml:math id="M10"><mml:mrow><mml:mspace width="0.2em"/><mml:mi>b</mml:mi><mml:mi>a</mml:mi><mml:mi>t</mml:mi><mml:mi>c</mml:mi><mml:mi>h</mml:mi><mml:mspace width="0.2em"/><mml:mi>A</mml:mi><mml:mi>S</mml:mi><mml:mi>W</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mo>|</mml:mo><mml:mi>M</mml:mi><mml:mo>|</mml:mo></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mstyle displaystyle="true"><mml:mi>∑</mml:mi></mml:mstyle><mml:mspace width="0.2em"/></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mspace width="0.2em"/><mml:mo>∈</mml:mo><mml:mi>M</mml:mi></mml:mrow></mml:munder><mml:mspace width="0.2em"/><mml:mi>b</mml:mi><mml:mi>a</mml:mi><mml:mi>t</mml:mi><mml:mi>c</mml:mi><mml:mi>h</mml:mi><mml:mspace width="0.2em"/><mml:mi>A</mml:mi><mml:mi>S</mml:mi><mml:msub><mml:mi>W</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:math></disp-formula> with <italic>M</italic> being the set of unique cell labels.</p></sec><sec id="S30"><title>Isolated label F1</title><p id="P90">Isolated labels are defined as cell type labels which are found in the smallest number of batches. We aim to determine how well these cell types are separated from the rest in the integrated data. To do so, we find the cluster containing the highest number of cells from such isolated labels, and we then compute the F<sub>1</sub> score of the isolated label against all other labels within the cluster. We use the standard F<sub>1</sub> formulation: <disp-formula id="FD6"><mml:math id="M11"><mml:mrow><mml:msub><mml:mi>F</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mn>2</mml:mn><mml:mfrac><mml:mrow><mml:mspace width="0.2em"/><mml:mi>p</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>c</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mi>o</mml:mi><mml:mi>n</mml:mi><mml:mspace width="0.2em"/><mml:mo>⋅</mml:mo><mml:mspace width="0.2em"/><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>c</mml:mi><mml:mi>a</mml:mi><mml:mi>l</mml:mi><mml:mi>l</mml:mi><mml:mspace width="0.2em"/></mml:mrow><mml:mrow><mml:mspace width="0.2em"/><mml:mi>p</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>c</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mi>o</mml:mi><mml:mi>n</mml:mi><mml:mspace width="0.2em"/><mml:mo>+</mml:mo><mml:mspace width="0.2em"/><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>c</mml:mi><mml:mi>a</mml:mi><mml:mi>l</mml:mi><mml:mi>l</mml:mi><mml:mspace width="0.2em"/></mml:mrow></mml:mfrac></mml:mrow></mml:math></disp-formula></p><p id="P91">Once again, scores of 1 represent the desirable outcome in which all cells from the isolated labels are grouped in one cluster.</p></sec><sec id="S31"><title>Macro F1</title><p id="P92">This score treats every class equally, irrespective of the class size, and is thus suitable for imbalanced datasets. It is calculated by an unweighted average of the <italic>F</italic><sub>1,<italic>i</italic></sub> scores per class <italic>i</italic> as <disp-formula id="FD7"><mml:math id="M12"><mml:mrow><mml:mi>M</mml:mi><mml:mi>a</mml:mi><mml:mi>c</mml:mi><mml:mi>r</mml:mi><mml:mi>o</mml:mi><mml:mtext> </mml:mtext><mml:msub><mml:mi>F</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>n</mml:mi></mml:mfrac><mml:msubsup><mml:mstyle displaystyle="true"><mml:mtext>Σ</mml:mtext></mml:mstyle><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:msubsup><mml:msub><mml:mi>F</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p></sec><sec id="S32"><title>Isolated label silhouette</title><p id="P93">This is a cell type ASW score but computed only on the isolated labels.</p></sec><sec id="S33"><title>Graph connectivity</title><p id="P94">This metric measures whether a KNN graph (G) computed on the integrated object connects cells that fall within the same cell type. It is bound between 0 and 1, with 0 indicating a graph where all cells are unconnected and, and 1 occurring when all cells of the same cell type are connected in the integrated output.</p><p id="P95">For each cell type label a subset graph G(N<sub>c</sub>, E<sub>c</sub>) is computed, the final score is obtained using the following formulation: <disp-formula id="FD8"><mml:math id="M13"><mml:mrow><mml:mi>G</mml:mi><mml:mi>C</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mo>|</mml:mo><mml:mi>C</mml:mi><mml:mo>|</mml:mo></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mstyle displaystyle="true"><mml:mi>∑</mml:mi></mml:mstyle></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mspace width="0.2em"/><mml:mo>∈</mml:mo><mml:mi>C</mml:mi></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mo>|</mml:mo><mml:mi>L</mml:mi><mml:mi>C</mml:mi><mml:mi>C</mml:mi><mml:mspace width="0.2em"/><mml:mo stretchy="false">(</mml:mo><mml:mi>G</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>N</mml:mi><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:mi>E</mml:mi><mml:mi>c</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>N</mml:mi><mml:mi>c</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:math></disp-formula> where <italic>C</italic> is the set of unique cell type labels, |<italic>LCC</italic> (<italic>G</italic>(<italic>Nc, Ec</italic>))| is the number of nodes in the largest connected component in the KNN graph and |<italic>N</italic><sub><italic>c</italic></sub>| is the number of nodes in the graph.</p></sec></sec><sec id="S34"><title>Gene module identification</title><p id="P96">We first applied inVAE to the entire spatial lung dataset<sup><xref ref-type="bibr" rid="R49">49</xref></sup>, followed by selecting AT1 and ciliated cells to examine spatial variation and identify related genes and pathways in specific locations.</p><p id="P97">For downstream analysis, we used the Hotspot (v1.1.1) software<sup><xref ref-type="bibr" rid="R50">50</xref></sup> to identify gene modules in an unsupervised manner, leveraging the similarity graph (KNN) constructed from inVAE’s embedding. Hotspot performed a gene autocorrelation test on this KNN graph to detect genes exhibiting non-random spatial patterns. We then selected the top 1000 genes based on their autocorrelation scores for hierarchical clustering, which produced gene modules. These modules were visualised in a correlation plot accompanied by a dendrogram.</p></sec><sec id="S35"><title>Meta cells</title><p id="P98">We used two tools for inferring meta cells, each with slightly different features but both based on similarity graphs, such as KNN. SEACells<sup><xref ref-type="bibr" rid="R39">39</xref></sup> (n_seacells=100) identified meta cells from inVAE’s embedding and assessed the purity of subpopulations, defined as the percentage of the most frequent cell type within each meta cell.</p><p id="P99">Milo<sup><xref ref-type="bibr" rid="R46">46</xref></sup> (n_neighbors=10), was run on inVAE’s embedding and provided the mean developmental stage within each neighbourhood of cells.</p></sec><sec id="S36"><title>Pseudo ordering of cells</title><p id="P100">To derive pseudo order of the lung tip cells, we used the basic curved trajectory analysis workflow from scFates<sup><xref ref-type="bibr" rid="R47">47</xref></sup> (v1.0.7), with default parameters as specified in the software’s tutorial. First, a principal curve was inferred, followed by the identification of root cells. Cells were then projected onto this principal graph to compute pseudo-orders. Genes significantly associated with cell state dynamics were identified and modelled as functions of their positions along the trajectory. These genes were then clustered based on their expression patterns. Finally, we visualised gene expression trends by plotting residuals—differences between observed and fitted expression values—against pseudo-orders.</p></sec><sec id="S37"><title>Pathway enrichment analysis</title><p id="P101">In the heart failure dataset, we ranked the differentially expressed genes (DEGs) using sc.tl.rank_genes_groups. We then selected the genes with adjusted p-value&lt;0.05 and log fold change &gt;0.0. We ran the EnrichR<sup><xref ref-type="bibr" rid="R75">75</xref></sup> which is implemented in gseapy<sup><xref ref-type="bibr" rid="R76">76</xref></sup> with Gene Ontology Database<sup><xref ref-type="bibr" rid="R77">77</xref></sup> (gene_sets=‘GO_Biological_Process_2023’) using the selected DEGs to find the enriched pathways. For the spatial lung datasets, we used the EnrichR with Wiki Pathways<sup><xref ref-type="bibr" rid="R78">78</xref></sup> (gene_sets=‘WikiPathways_2024_Human’) for the significant gene modules. The significant pathways are selected based on the threshold of adjusted p-value &lt; 0.05.</p></sec><sec id="S38"><title>Gene score</title><p id="P102">We used scanpy.tl.score_genes to measure gene enrichment scores. This score is calculated as the average expression of a target gene set, minus the average expression of a reference gene set. The reference set is randomly sampled from the gene pool for each binned expression value.</p></sec></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary Figures</label><media xlink:href="EMS202000-supplement-Supplementary_Figures.pdf" mimetype="application" mime-subtype="pdf" id="d68aAcKbB" position="anchor"/></supplementary-material></sec></body><back><ack id="S39"><title>Acknowledgements</title><p>We would like to express our gratitude to Aidan Maartens for his insightful comments on the manuscript and A. García from Bio-Graphics for the illustration of <xref ref-type="fig" rid="F1">Figure 1</xref>. We are also grateful to Ana Paredes and Kazumasa Kanemaru for fruitful discussions on heart data analysis and Peng He for his assistance with the fetal lung data. Additionally, we thank all members of Vento-Tormo, Theis, and Teichmann laboratories for their valuable discussions and feedback throughout this project. We also extend our thanks to everyone who has used our tool, providing invaluable input that helped us improve inVAE. We are especially grateful to the CellGen admin team at the Wellcome Sanger Institute for their continuous support with computational resources and infrastructure. We acknowledge that <xref ref-type="fig" rid="F2">Figures 2a</xref>, <xref ref-type="fig" rid="F4">4a</xref>-<xref ref-type="fig" rid="F5">5a</xref> are depicted using bioRender.</p></ack><sec id="S40" sec-type="data-availability"><title>Data availability</title><p id="P103">All datasets used in this manuscript are publicly available and already published. The original papers regarding each dataset are cited in the manuscript. The processed data and train models are available at [link to the github].</p></sec><sec id="S41" sec-type="data-availability"><title>Code availability</title><p id="P104">The python package is available in [<ext-link ext-link-type="uri" xlink:href="https://github.com/theislab/inVAE">https://github.com/theislab/inVAE</ext-link>]. The preprocessing and downstream analysis pipelines are included in [<ext-link ext-link-type="uri" xlink:href="https://github.com/theislab/inVAE_reproducibility">https://github.com/theislab/inVAE_reproducibility</ext-link>].</p></sec><fn-group><fn id="FN1" fn-type="con"><p id="P105"><bold>Contributions</bold></p><p id="P106">H.A. conceptualised and designed the study. H.A. and F.K. developed the tool. F.K. wrote the package. H.A., K.B.M. and J.C. selected the datasets. H.A., F.K., D.P. and B.C. performed the analysis. H.A. wrote the first draft of the manuscript and made the figures. H.A., F.K., D.P. and B.C. wrote the Methods Section. H.A., D.P., K.B.M. and R.V. edited the manuscript. T.J., J.C., and S.A.T. proofread the heart results. D.P. and K.B.M. proofread the lung results. All the authors critically reviewed and approved the manuscript. R.V. and F.J.T funded the project.</p></fn><fn id="FN2" fn-type="conflict"><p id="P107"><bold>Disclosure of Potential Competing Interest</bold></p><p id="P108">F.J.T. consults for Immunai Inc., CytoReason Ltd, Cellarity, and BioTuring Inc. and has an ownership interest in Dermagnostix GmbH and Cellarity. In the past 3 years, S.A.T. has consulted for or been a member of scientific advisory boards at Qiagen, Sanofi, Element Biosciences, Xaira Therapeutics, GlaxoSmithKline and ForeSite Labs. She is a co-founder and an equity holder of TransitionBio and EnsoCell. She is a part-time employee at GlaxoSmithKline and a non-executive director of 10x Genomics.</p></fn></fn-group><ref-list><ref id="R1"><label>1</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lindeboom</surname><given-names>RGH</given-names></name><name><surname>Regev</surname><given-names>A</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name></person-group><article-title>Towards a Human Cell Atlas: Taking notes from the past</article-title><source>Trends Genet</source><year>2021</year><volume>37</volume><fpage>625</fpage><lpage>630</lpage><pub-id pub-id-type="pmid">33879355</pub-id></element-citation></ref><ref id="R2"><label>2</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wagner</surname><given-names>A</given-names></name><name><surname>Regev</surname><given-names>A</given-names></name><name><surname>Yosef</surname><given-names>N</given-names></name></person-group><article-title>Revealing the vectors of cellular identity with single-cell genomics</article-title><source>Nat Biotechnol</source><year>2016</year><volume>34</volume><fpage>1145</fpage><lpage>1160</lpage><pub-id pub-id-type="pmcid">PMC5465644</pub-id><pub-id pub-id-type="pmid">27824854</pub-id><pub-id pub-id-type="doi">10.1038/nbt.3711</pub-id></element-citation></ref><ref id="R3"><label>3</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luecken</surname><given-names>MD</given-names></name><etal/></person-group><article-title>Benchmarking atlas-level data integration in single-cell genomics</article-title><source>Nat Methods</source><year>2022</year><volume>19</volume><fpage>41</fpage><lpage>50</lpage><pub-id pub-id-type="pmcid">PMC8748196</pub-id><pub-id pub-id-type="pmid">34949812</pub-id><pub-id pub-id-type="doi">10.1038/s41592-021-01336-8</pub-id></element-citation></ref><ref id="R4"><label>4</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sikkema</surname><given-names>L</given-names></name><etal/></person-group><article-title>An integrated cell atlas of the lung in health and disease</article-title><source>Nat Med</source><year>2023</year><volume>29</volume><fpage>1563</fpage><lpage>1577</lpage><pub-id pub-id-type="pmcid">PMC10287567</pub-id><pub-id pub-id-type="pmid">37291214</pub-id><pub-id pub-id-type="doi">10.1038/s41591-023-02327-2</pub-id></element-citation></ref><ref id="R5"><label>5</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Litviňuková</surname><given-names>M</given-names></name><etal/></person-group><article-title>Cells of the adult human heart</article-title><source>Nature</source><year>2020</year><volume>588</volume><fpage>466</fpage><lpage>472</lpage><pub-id pub-id-type="pmcid">PMC7681775</pub-id><pub-id pub-id-type="pmid">32971526</pub-id><pub-id pub-id-type="doi">10.1038/s41586-020-2797-4</pub-id></element-citation></ref><ref id="R6"><label>6</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Montoro</surname><given-names>DT</given-names></name><etal/></person-group><article-title>A revised airway epithelial hierarchy includes CFTR-expressing ionocytes</article-title><source>Nature</source><year>2018</year><volume>560</volume><fpage>319</fpage><lpage>324</lpage><pub-id pub-id-type="pmcid">PMC6295155</pub-id><pub-id pub-id-type="pmid">30069044</pub-id><pub-id pub-id-type="doi">10.1038/s41586-018-0393-7</pub-id></element-citation></ref><ref id="R7"><label>7</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Travaglini</surname><given-names>KJ</given-names></name><etal/></person-group><article-title>A molecular cell atlas of the human lung from single-cell RNA sequencing</article-title><source>Nature</source><year>2020</year><volume>587</volume><fpage>619</fpage><lpage>625</lpage><pub-id pub-id-type="pmcid">PMC7704697</pub-id><pub-id pub-id-type="pmid">33208946</pub-id><pub-id pub-id-type="doi">10.1038/s41586-020-2922-4</pub-id></element-citation></ref><ref id="R8"><label>8</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jackson</surname><given-names>HW</given-names></name><etal/></person-group><article-title>The single-cell pathology landscape of breast cancer</article-title><source>Nature</source><year>2020</year><volume>578</volume><fpage>615</fpage><lpage>620</lpage><pub-id pub-id-type="pmid">31959985</pub-id></element-citation></ref><ref id="R9"><label>9</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wu</surname><given-names>SZ</given-names></name><etal/></person-group><article-title>A single-cell and spatially resolved atlas of human breast cancers</article-title><source>Nat Genet</source><year>2021</year><volume>53</volume><fpage>1334</fpage><lpage>1347</lpage><pub-id pub-id-type="pmcid">PMC9044823</pub-id><pub-id pub-id-type="pmid">34493872</pub-id><pub-id pub-id-type="doi">10.1038/s41588-021-00911-1</pub-id></element-citation></ref><ref id="R10"><label>10</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Marečková</surname><given-names>M</given-names></name><etal/></person-group><article-title>An integrated single-cell reference atlas of the human endometrium</article-title><source>Nat Genet</source><year>2024</year><volume>56</volume><fpage>1925</fpage><lpage>1937</lpage><pub-id pub-id-type="pmcid">PMC11387200</pub-id><pub-id pub-id-type="pmid">39198675</pub-id><pub-id pub-id-type="doi">10.1038/s41588-024-01873-w</pub-id></element-citation></ref><ref id="R11"><label>11</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Briggs</surname><given-names>JA</given-names></name><etal/></person-group><article-title>The dynamics of gene expression in vertebrate embryogenesis at single-cell resolution</article-title><source>Science</source><year>2018</year><volume>360</volume><elocation-id>eaar5780</elocation-id><pub-id pub-id-type="pmcid">PMC6038144</pub-id><pub-id pub-id-type="pmid">29700227</pub-id><pub-id pub-id-type="doi">10.1126/science.aar5780</pub-id></element-citation></ref><ref id="R12"><label>12</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Eraslan</surname><given-names>G</given-names></name><etal/></person-group><article-title>Single-nucleus cross-tissue molecular reference maps toward understanding disease gene function</article-title><source>Science</source><year>2022</year><volume>376</volume><elocation-id>eabl4290</elocation-id><pub-id pub-id-type="pmcid">PMC9383269</pub-id><pub-id pub-id-type="pmid">35549429</pub-id><pub-id pub-id-type="doi">10.1126/science.abl4290</pub-id></element-citation></ref><ref id="R13"><label>13</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lee</surname><given-names>W</given-names></name><etal/></person-group><article-title>A single-cell atlas of in vitro multiculture systems uncovers the in vivo lineage trajectory and cell state in the human lung</article-title><source>Exp Mol Med</source><year>2023</year><volume>55</volume><fpage>1831</fpage><lpage>1842</lpage><pub-id pub-id-type="pmcid">PMC10474282</pub-id><pub-id pub-id-type="pmid">37582976</pub-id><pub-id pub-id-type="doi">10.1038/s12276-023-01076-z</pub-id></element-citation></ref><ref id="R14"><label>14</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kanton</surname><given-names>S</given-names></name><etal/></person-group><article-title>Single-cell genomic atlas of great ape cerebral organoids uncovers human-specific features of brain development</article-title><year>2019</year><pub-id pub-id-type="pmid">31619793</pub-id></element-citation></ref><ref id="R15"><label>15</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Song</surname><given-names>Y</given-names></name><name><surname>Miao</surname><given-names>Z</given-names></name><name><surname>Brazma</surname><given-names>A</given-names></name><name><surname>Papatheodorou</surname><given-names>I</given-names></name></person-group><article-title>Benchmarking strategies for cross-species integration of single-cell RNA sequencing data</article-title><source>Nat Commun</source><year>2023</year><volume>14</volume><elocation-id>6495</elocation-id><pub-id pub-id-type="pmcid">PMC10576752</pub-id><pub-id pub-id-type="pmid">37838716</pub-id><pub-id pub-id-type="doi">10.1038/s41467-023-41855-w</pub-id></element-citation></ref><ref id="R16"><label>16</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hao</surname><given-names>S</given-names></name><etal/></person-group><article-title>Cross-species single-cell spatial transcriptomic atlases of the cerebellar cortex</article-title><source>Science</source><year>2024</year><volume>385</volume><elocation-id>eado3927</elocation-id><pub-id pub-id-type="pmid">39325889</pub-id></element-citation></ref><ref id="R17"><label>17</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rosen</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Toward universal cell embeddings: integrating single-cell RNA-seq datasets across species with SATURN</article-title><source>Nat Methods</source><year>2024</year><volume>21</volume><fpage>1492</fpage><lpage>1500</lpage><pub-id pub-id-type="pmcid">PMC11310084</pub-id><pub-id pub-id-type="pmid">38366243</pub-id><pub-id pub-id-type="doi">10.1038/s41592-024-02191-z</pub-id></element-citation></ref><ref id="R18"><label>18</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hie</surname><given-names>BL</given-names></name><name><surname>Kim</surname><given-names>S</given-names></name><name><surname>Rando</surname><given-names>TA</given-names></name><name><surname>Bryson</surname><given-names>B</given-names></name><name><surname>Berger</surname><given-names>B</given-names></name></person-group><article-title>Scanorama: integrating large and diverse single-cell transcriptomic datasets</article-title><source>Nat Protoc</source><year>2024</year><volume>19</volume><fpage>2283</fpage><lpage>2297</lpage><pub-id pub-id-type="pmcid">PMC11361826</pub-id><pub-id pub-id-type="pmid">38844552</pub-id><pub-id pub-id-type="doi">10.1038/s41596-024-00991-3</pub-id></element-citation></ref><ref id="R19"><label>19</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lopez</surname><given-names>R</given-names></name><name><surname>Regier</surname><given-names>J</given-names></name><name><surname>Cole</surname><given-names>MB</given-names></name><name><surname>Jordan</surname><given-names>MI</given-names></name><name><surname>Yosef</surname><given-names>N</given-names></name></person-group><article-title>Deep generative modeling for single-cell transcriptomics</article-title><source>Nat Methods</source><year>2018</year><volume>15</volume><fpage>1053</fpage><lpage>1058</lpage><pub-id pub-id-type="pmcid">PMC6289068</pub-id><pub-id pub-id-type="pmid">30504886</pub-id><pub-id pub-id-type="doi">10.1038/s41592-018-0229-2</pub-id></element-citation></ref><ref id="R20"><label>20</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Polański</surname><given-names>K</given-names></name><etal/></person-group><article-title>BBKNN: fast batch alignment of single cell transcriptomes</article-title><source>Bioinformatics</source><year>2020</year><volume>36</volume><fpage>964</fpage><lpage>965</lpage><pub-id pub-id-type="pmcid">PMC9883685</pub-id><pub-id pub-id-type="pmid">31400197</pub-id><pub-id pub-id-type="doi">10.1093/bioinformatics/btz625</pub-id></element-citation></ref><ref id="R21"><label>21</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Haghverdi</surname><given-names>L</given-names></name><name><surname>Lun</surname><given-names>ATL</given-names></name><name><surname>Morgan</surname><given-names>MD</given-names></name><name><surname>Marioni</surname><given-names>JC</given-names></name></person-group><article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title><source>Nat Biotechnol</source><year>2018</year><volume>36</volume><fpage>421</fpage><lpage>427</lpage><pub-id pub-id-type="pmcid">PMC6152897</pub-id><pub-id pub-id-type="pmid">29608177</pub-id><pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id></element-citation></ref><ref id="R22"><label>22</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Korsunsky</surname><given-names>I</given-names></name><etal/></person-group><article-title>Fast, sensitive and accurate integration of single-cell data with Harmony</article-title><source>Nat Methods</source><year>2019</year><volume>16</volume><fpage>1289</fpage><lpage>1296</lpage><pub-id pub-id-type="pmcid">PMC6884693</pub-id><pub-id pub-id-type="pmid">31740819</pub-id><pub-id pub-id-type="doi">10.1038/s41592-019-0619-0</pub-id></element-citation></ref><ref id="R23"><label>23</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stuart</surname><given-names>T</given-names></name><etal/></person-group><article-title>Comprehensive integration of single-cell data</article-title><source>Cell</source><year>2019</year><volume>177</volume><fpage>1888</fpage><lpage>1902</lpage><elocation-id>e21</elocation-id><pub-id pub-id-type="pmcid">PMC6687398</pub-id><pub-id pub-id-type="pmid">31178118</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2019.05.031</pub-id></element-citation></ref><ref id="R24"><label>24</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Missarova</surname><given-names>A</given-names></name><name><surname>Dann</surname><given-names>E</given-names></name><name><surname>Rosen</surname><given-names>L</given-names></name><name><surname>Satija</surname><given-names>R</given-names></name><name><surname>Marioni</surname><given-names>J</given-names></name></person-group><article-title>Leveraging neighborhood representations of single-cell data to achieve sensitive DE testing with miloDE</article-title><source>Genome Biol</source><year>2024</year><volume>25</volume><fpage>189</fpage><pub-id pub-id-type="pmcid">PMC11256449</pub-id><pub-id pub-id-type="pmid">39026254</pub-id><pub-id pub-id-type="doi">10.1186/s13059-024-03334-3</pub-id></element-citation></ref><ref id="R25"><label>25</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Boyeau</surname><given-names>P</given-names></name><etal/></person-group><article-title>An empirical Bayes method for differential expression analysis of single cells with deep generative models</article-title><source>Proc Natl Acad Sci U S A</source><year>2023</year><volume>120</volume><elocation-id>e2209124120</elocation-id><pub-id pub-id-type="pmcid">PMC10214125</pub-id><pub-id pub-id-type="pmid">37192164</pub-id><pub-id pub-id-type="doi">10.1073/pnas.2209124120</pub-id></element-citation></ref><ref id="R26"><label>26</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>De Donno</surname><given-names>C</given-names></name><etal/></person-group><article-title>Population-level integration of single-cell datasets enables multi-scale analysis across samples</article-title><source>Nat Methods</source><year>2023</year><volume>20</volume><fpage>1683</fpage><lpage>1692</lpage><pub-id pub-id-type="pmcid">PMC10630133</pub-id><pub-id pub-id-type="pmid">37813989</pub-id><pub-id pub-id-type="doi">10.1038/s41592-023-02035-2</pub-id></element-citation></ref><ref id="R27"><label>27</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname><given-names>C</given-names></name><etal/></person-group><article-title>Probabilistic harmonization and annotation of single-cell transcriptomics data with deep generative models</article-title><source>Mol Syst Biol</source><year>2021</year><volume>17</volume><elocation-id>e9620</elocation-id><pub-id pub-id-type="pmcid">PMC7829634</pub-id><pub-id pub-id-type="pmid">33491336</pub-id><pub-id pub-id-type="doi">10.15252/msb.20209620</pub-id></element-citation></ref><ref id="R28"><label>28</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Amodio</surname><given-names>M</given-names></name><etal/></person-group><article-title>Exploring single-cell data with deep multitasking neural networks</article-title><source>Nat Methods</source><year>2019</year><volume>16</volume><fpage>1139</fpage><lpage>1145</lpage><pub-id pub-id-type="pmcid">PMC10164410</pub-id><pub-id pub-id-type="pmid">31591579</pub-id><pub-id pub-id-type="doi">10.1038/s41592-019-0576-7</pub-id></element-citation></ref><ref id="R29"><label>29</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Saengkyongam</surname><given-names>S</given-names></name><name><surname>Thams</surname><given-names>N</given-names></name><name><surname>Peters</surname><given-names>J</given-names></name><name><surname>Pfister</surname><given-names>N</given-names></name></person-group><article-title>Invariant policy learning: A causal perspective</article-title><source>IEEE Trans Pattern Anal Mach Intell</source><year>2023</year><volume>45</volume><fpage>8606</fpage><lpage>8620</lpage><pub-id pub-id-type="pmid">37018267</pub-id></element-citation></ref><ref id="R30"><label>30</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dann</surname><given-names>E</given-names></name><etal/></person-group><article-title>Precise identification of cell states altered in disease using healthy single-cell references</article-title><source>Nat Genet</source><year>2023</year><volume>55</volume><fpage>1998</fpage><lpage>2008</lpage><pub-id pub-id-type="pmcid">PMC10632138</pub-id><pub-id pub-id-type="pmid">37828140</pub-id><pub-id pub-id-type="doi">10.1038/s41588-023-01523-7</pub-id></element-citation></ref><ref id="R31"><label>31</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kingma</surname><given-names>DP</given-names></name><name><surname>Welling</surname><given-names>M</given-names></name></person-group><article-title>Auto-Encoding Variational Bayes</article-title><source>arXiv [statML]</source><year>2013</year></element-citation></ref><ref id="R32"><label>32</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Reichart</surname><given-names>D</given-names></name><etal/></person-group><article-title>Pathogenic variants damage cell composition and single cell transcription in cardiomyopathies</article-title><source>Science</source><year>2022</year><volume>377</volume><elocation-id>eabo1984</elocation-id><pub-id pub-id-type="pmcid">PMC9528698</pub-id><pub-id pub-id-type="pmid">35926050</pub-id><pub-id pub-id-type="doi">10.1126/science.abo1984</pub-id></element-citation></ref><ref id="R33"><label>33</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kanemaru</surname><given-names>K</given-names></name><etal/></person-group><article-title>Spatially resolved multiomics of human cardiac niches</article-title><source>Nature</source><year>2023</year><volume>619</volume><fpage>801</fpage><lpage>810</lpage><pub-id pub-id-type="pmcid">PMC10371870</pub-id><pub-id pub-id-type="pmid">37438528</pub-id><pub-id pub-id-type="doi">10.1038/s41586-023-06311-1</pub-id></element-citation></ref><ref id="R34"><label>34</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chaffin</surname><given-names>M</given-names></name><etal/></person-group><article-title>Single-nucleus profiling of human dilated and hypertrophic cardiomyopathy</article-title><source>Nature</source><year>2022</year><volume>608</volume><fpage>174</fpage><lpage>180</lpage><pub-id pub-id-type="pmid">35732739</pub-id></element-citation></ref><ref id="R35"><label>35</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Arbelo</surname><given-names>E</given-names></name><etal/></person-group><article-title>2023 ESC Guidelines for the management of cardiomyopathies</article-title><source>Eur Heart J</source><year>2023</year><volume>44</volume><fpage>3503</fpage><lpage>3626</lpage><pub-id pub-id-type="pmid">37622657</pub-id></element-citation></ref><ref id="R36"><label>36</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Büttner</surname><given-names>M</given-names></name><name><surname>Miao</surname><given-names>Z</given-names></name><name><surname>Wolf</surname><given-names>FA</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>A test metric for assessing single-cell RNA-seq batch correction</article-title><source>Nat Methods</source><year>2019</year><volume>16</volume><fpage>43</fpage><lpage>49</lpage><pub-id pub-id-type="pmid">30573817</pub-id></element-citation></ref><ref id="R37"><label>37</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>Z</given-names></name><name><surname>Zhao</surname><given-names>X</given-names></name><name><surname>Bindra</surname><given-names>M</given-names></name><name><surname>Qiu</surname><given-names>P</given-names></name><name><surname>Zhang</surname><given-names>X</given-names></name></person-group><article-title>scDisInFact: disentangled learning for integration and prediction of multi-batch multi-condition single-cell RNA-sequencing data</article-title><source>Nat Commun</source><year>2024</year><volume>15</volume><fpage>912</fpage><pub-id pub-id-type="pmcid">PMC10827746</pub-id><pub-id pub-id-type="pmid">38291052</pub-id><pub-id pub-id-type="doi">10.1038/s41467-024-45227-w</pub-id></element-citation></ref><ref id="R38"><label>38</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lin</surname><given-names>Y</given-names></name><name><surname>Cao</surname><given-names>Y</given-names></name><name><surname>Willie</surname><given-names>E</given-names></name><name><surname>Patrick</surname><given-names>E</given-names></name><name><surname>Yang</surname><given-names>JYH</given-names></name></person-group><article-title>Atlas-scale single-cell multi-sample multi-condition data integration using scMerge2</article-title><source>Nat Commun</source><year>2023</year><volume>14</volume><elocation-id>4272</elocation-id><pub-id pub-id-type="pmcid">PMC10352351</pub-id><pub-id pub-id-type="pmid">37460600</pub-id><pub-id pub-id-type="doi">10.1038/s41467-023-39923-2</pub-id></element-citation></ref><ref id="R39"><label>39</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Persad</surname><given-names>S</given-names></name><etal/></person-group><article-title>SEACells infers transcriptional and epigenomic cellular states from single-cell genomics data</article-title><source>Nat Biotechnol</source><year>2023</year><volume>41</volume><fpage>1746</fpage><lpage>1757</lpage><pub-id pub-id-type="pmcid">PMC10713451</pub-id><pub-id pub-id-type="pmid">36973557</pub-id><pub-id pub-id-type="doi">10.1038/s41587-023-01716-9</pub-id></element-citation></ref><ref id="R40"><label>40</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Amrute</surname><given-names>JM</given-names></name><etal/></person-group><article-title>Targeting immune–fibroblast cell communication in heart failure</article-title><source>Nature</source><year>2024</year><fpage>1</fpage><lpage>11</lpage></element-citation></ref><ref id="R41"><label>41</label><element-citation publication-type="web"><person-group person-group-type="author"><name><surname>Gayoso</surname><given-names>A</given-names></name></person-group><article-title>scib-metrics</article-title><source>Python</source><comment><ext-link ext-link-type="uri" xlink:href="https://scib-metrics.readthedocs.io/en/stable/">https://scib-metrics.readthedocs.io/en/stable/</ext-link></comment></element-citation></ref><ref id="R42"><label>42</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>L</given-names></name><name><surname>Zhao</surname><given-names>Q</given-names></name><name><surname>Kong</surname><given-names>W</given-names></name></person-group><article-title>Extracellular matrix remodeling and cardiac fibrosis</article-title><source>Matrix Biol</source><year>2018</year><volume>68-69</volume><fpage>490</fpage><lpage>506</lpage><pub-id pub-id-type="pmid">29371055</pub-id></element-citation></ref><ref id="R43"><label>43</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jansweijer</surname><given-names>JA</given-names></name><etal/></person-group><article-title>Truncating titin mutations are associated with a mild and treatable form of dilated cardiomyopathy</article-title><source>Eur J Heart Fail</source><year>2017</year><volume>19</volume><fpage>512</fpage><lpage>521</lpage><pub-id pub-id-type="pmid">27813223</pub-id></element-citation></ref><ref id="R44"><label>44</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pedregosa</surname><given-names>F</given-names></name><etal/></person-group><article-title>Scikit-learn: Machine Learning in Python</article-title><source>arXiv [csLG]</source><year>2012</year></element-citation></ref><ref id="R45"><label>45</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>He</surname><given-names>P</given-names></name><etal/></person-group><article-title>A human fetal lung cell atlas uncovers proximal-distal gradients of differentiation and key regulators of epithelial fates</article-title><source>Cell</source><year>2022</year><volume>185</volume><fpage>4841</fpage><lpage>4860</lpage><elocation-id>e25</elocation-id><pub-id pub-id-type="pmid">36493756</pub-id></element-citation></ref><ref id="R46"><label>46</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dann</surname><given-names>E</given-names></name><name><surname>Henderson</surname><given-names>NC</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name><name><surname>Morgan</surname><given-names>MD</given-names></name><name><surname>Marioni</surname><given-names>JC</given-names></name></person-group><article-title>Differential abundance testing on single-cell data using k-nearest neighbor graphs</article-title><source>Nat Biotechnol</source><year>2022</year><volume>40</volume><fpage>245</fpage><lpage>253</lpage><pub-id pub-id-type="pmcid">PMC7617075</pub-id><pub-id pub-id-type="pmid">34594043</pub-id><pub-id pub-id-type="doi">10.1038/s41587-021-01033-z</pub-id></element-citation></ref><ref id="R47"><label>47</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Faure</surname><given-names>L</given-names></name><name><surname>Soldatov</surname><given-names>R</given-names></name><name><surname>Kharchenko</surname><given-names>PV</given-names></name><name><surname>Adameyko</surname><given-names>I</given-names></name></person-group><article-title>scFates: a scalable python package for advanced pseudotime and bifurcation analysis from single-cell data</article-title><source>Bioinformatics</source><year>2023</year><volume>39</volume><pub-id pub-id-type="pmcid">PMC9805561</pub-id><pub-id pub-id-type="pmid">36394263</pub-id><pub-id pub-id-type="doi">10.1093/bioinformatics/btac746</pub-id></element-citation></ref><ref id="R48"><label>48</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lim</surname><given-names>K</given-names></name><etal/></person-group><article-title>Organoid modeling of human fetal lung alveolar development reveals mechanisms of cell fate patterning and neonatal respiratory disease</article-title><source>Cell Stem Cell</source><year>2023</year><volume>30</volume><fpage>20</fpage><lpage>37</lpage><elocation-id>e9</elocation-id><pub-id pub-id-type="pmid">36493780</pub-id></element-citation></ref><ref id="R49"><label>49</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Madissoon</surname><given-names>E</given-names></name><etal/></person-group><article-title>A spatially resolved atlas of the human lung characterizes a gland-associated immune niche</article-title><source>Nat Genet</source><year>2023</year><volume>55</volume><fpage>66</fpage><lpage>77</lpage><pub-id pub-id-type="pmcid">PMC9839452</pub-id><pub-id pub-id-type="pmid">36543915</pub-id><pub-id pub-id-type="doi">10.1038/s41588-022-01243-4</pub-id></element-citation></ref><ref id="R50"><label>50</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>DeTomaso</surname><given-names>D</given-names></name><name><surname>Yosef</surname><given-names>N</given-names></name></person-group><article-title>Hotspot identifies informative gene modules across modalities of single-cell genomics</article-title><source>Cell Syst</source><year>2021</year><volume>12</volume><fpage>446</fpage><lpage>456</lpage><elocation-id>e9</elocation-id><pub-id pub-id-type="pmid">33951459</pub-id></element-citation></ref><ref id="R51"><label>51</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Martin</surname><given-names>MM</given-names></name><etal/></person-group><article-title>TGF-beta1 stimulates human AT1 receptor expression in lung fibroblasts by cross talk between the Smad, p38 MAPK, JNK, and PI3K signaling pathways</article-title><source>Am J Physiol Lung Cell Mol Physiol</source><year>2007</year><volume>293</volume><fpage>L790</fpage><lpage>9</lpage><pub-id pub-id-type="pmcid">PMC2413071</pub-id><pub-id pub-id-type="pmid">17601799</pub-id><pub-id pub-id-type="doi">10.1152/ajplung.00099.2007</pub-id></element-citation></ref><ref id="R52"><label>52</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Vallath</surname><given-names>S</given-names></name><name><surname>Hynds</surname><given-names>RE</given-names></name><name><surname>Succony</surname><given-names>L</given-names></name><name><surname>Janes</surname><given-names>SM</given-names></name><name><surname>Giangreco</surname><given-names>A</given-names></name></person-group><article-title>Targeting EGFR signalling in chronic lung disease: therapeutic challenges and opportunities</article-title><source>Eur Respir J</source><year>2014</year><volume>44</volume><fpage>513</fpage><lpage>522</lpage><pub-id pub-id-type="pmcid">PMC4209854</pub-id><pub-id pub-id-type="pmid">24435005</pub-id><pub-id pub-id-type="doi">10.1183/09031936.00146413</pub-id></element-citation></ref><ref id="R53"><label>53</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chaudhary</surname><given-names>NI</given-names></name><etal/></person-group><article-title>Inhibition of PDGF, VEGF and FGF signalling attenuates fibrosis</article-title><source>Eur Respir J</source><year>2007</year><volume>29</volume><fpage>976</fpage><lpage>985</lpage><pub-id pub-id-type="pmid">17301095</pub-id></element-citation></ref><ref id="R54"><label>54</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Barratt</surname><given-names>SL</given-names></name><name><surname>Flower</surname><given-names>VA</given-names></name><name><surname>Pauling</surname><given-names>JD</given-names></name><name><surname>Millar</surname><given-names>AB</given-names></name></person-group><article-title>VEGF (Vascular Endothelial Growth Factor) and fibrotic lung disease</article-title><source>Int J Mol Sci</source><year>2018</year><volume>19</volume><elocation-id>1269</elocation-id><pub-id pub-id-type="pmcid">PMC5983653</pub-id><pub-id pub-id-type="pmid">29695053</pub-id><pub-id pub-id-type="doi">10.3390/ijms19051269</pub-id></element-citation></ref><ref id="R55"><label>55</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nemec</surname><given-names>SF</given-names></name><name><surname>Bankier</surname><given-names>AA</given-names></name><name><surname>Eisenberg</surname><given-names>RL</given-names></name></person-group><article-title>Lower lobe-predominant diseases of the lung</article-title><source>AJR Am J Roentgenol</source><year>2013</year><volume>200</volume><fpage>712</fpage><lpage>728</lpage><pub-id pub-id-type="pmid">23521438</pub-id></element-citation></ref><ref id="R56"><label>56</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nawroth</surname><given-names>JC</given-names></name><name><surname>van der Does</surname><given-names>AM</given-names></name><name><surname>Firth</surname><given-names>Ryan</given-names></name><name><surname>Kanso</surname><given-names>E</given-names></name></person-group><article-title>Multiscale mechanics of mucociliary clearance in the lung</article-title><source>Philos Trans R Soc Lond B Biol Sci</source><year>2020</year><volume>375</volume><elocation-id>20190160</elocation-id><pub-id pub-id-type="pmcid">PMC7017338</pub-id><pub-id pub-id-type="pmid">31884926</pub-id><pub-id pub-id-type="doi">10.1098/rstb.2019.0160</pub-id></element-citation></ref><ref id="R57"><label>57</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Clary-Meinesz</surname><given-names>C</given-names></name><etal/></person-group><article-title>Ciliary beat frequency in human bronchi and bronchioles</article-title><source>Chest</source><year>1997</year><volume>111</volume><fpage>692</fpage><lpage>697</lpage><pub-id pub-id-type="pmid">9118710</pub-id></element-citation></ref><ref id="R58"><label>58</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kaza</surname><given-names>AK</given-names></name><etal/></person-group><article-title>Contrasting natures of lung growth after transplantation and lobectomy</article-title><source>J Thorac Cardiovasc Surg</source><year>2002</year><volume>123</volume><fpage>288</fpage><lpage>294</lpage><pub-id pub-id-type="pmid">11828288</pub-id></element-citation></ref><ref id="R59"><label>59</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kor</surname><given-names>A</given-names></name><etal/></person-group><article-title>Serum netrin-1 levels are high in Rheumatoid arthritis associated interstitial lung disease</article-title><source>Clin Biochem</source><year>2024</year><volume>127-128</volume><elocation-id>110760</elocation-id><pub-id pub-id-type="pmid">38556035</pub-id></element-citation></ref><ref id="R60"><label>60</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Adams</surname><given-names>TS</given-names></name><etal/></person-group><article-title>Single-cell RNA-seq reveals ectopic and aberrant lung-resident cell populations in idiopathic pulmonary fibrosis</article-title><source>Sci Adv</source><year>2020</year><volume>6</volume><elocation-id>eaba1983</elocation-id><pub-id pub-id-type="pmcid">PMC7439502</pub-id><pub-id pub-id-type="pmid">32832599</pub-id><pub-id pub-id-type="doi">10.1126/sciadv.aba1983</pub-id></element-citation></ref><ref id="R61"><label>61</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Eisenstein</surname><given-names>M</given-names></name></person-group><article-title>Machine learning powers biobank-driven drug discovery</article-title><source>Nat Biotechnol</source><year>2022</year><volume>40</volume><fpage>1303</fpage><lpage>1305</lpage><pub-id pub-id-type="pmid">36050552</pub-id></element-citation></ref><ref id="R62"><label>62</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Teichmann</surname><given-names>S</given-names></name><name><surname>Regev</surname><given-names>A</given-names></name></person-group><article-title>The network effect: studying COVID-19 pathology with the Human Cell Atlas</article-title><source>Nat Rev Mol Cell Biol</source><year>2020</year><volume>21</volume><fpage>415</fpage><lpage>416</lpage><pub-id pub-id-type="pmcid">PMC7325637</pub-id><pub-id pub-id-type="pmid">32606379</pub-id><pub-id pub-id-type="doi">10.1038/s41580-020-0267-3</pub-id></element-citation></ref><ref id="R63"><label>63</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhao</surname><given-names>H</given-names></name><name><surname>Combes</surname><given-names>RTD</given-names></name><name><surname>Zhang</surname><given-names>K</given-names></name><name><surname>Gordon</surname><given-names>GJ</given-names></name></person-group><article-title>On learning invariant representation for domain adaptation</article-title><source>arXiv [csLG]</source><year>2019</year></element-citation></ref><ref id="R64"><label>64</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lu</surname><given-names>C</given-names></name><name><surname>Wu</surname><given-names>Y</given-names></name><name><surname>Hernández-Lobato</surname><given-names>JM</given-names></name><name><surname>Schölkopf</surname><given-names>B</given-names></name></person-group><article-title>Nonlinear invariant risk minimization: A causal approach</article-title><source>arXiv [csLG]</source><year>2021</year></element-citation></ref><ref id="R65"><label>65</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ahuja</surname><given-names>K</given-names></name><name><surname>Wang</surname><given-names>J</given-names></name><name><surname>Dhurandhar</surname><given-names>A</given-names></name><name><surname>Shanmugam</surname><given-names>K</given-names></name><name><surname>Varshney</surname><given-names>KR</given-names></name></person-group><article-title>Empirical or invariant risk minimization? A sample complexity perspective</article-title><source>arXiv [csLG]</source><year>2020</year></element-citation></ref><ref id="R66"><label>66</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Arjovsky</surname><given-names>M</given-names></name><name><surname>Bottou</surname><given-names>L</given-names></name><name><surname>Gulrajani</surname><given-names>I</given-names></name><name><surname>Lopez-Paz</surname><given-names>D</given-names></name></person-group><article-title>Invariant Risk Minimization</article-title><source>arXiv [statML]</source><year>2019</year></element-citation></ref><ref id="R67"><label>67</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolf</surname><given-names>FA</given-names></name><name><surname>Angerer</surname><given-names>P</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title><source>Genome Biol</source><year>2018</year><volume>19</volume><pub-id pub-id-type="pmcid">PMC5802054</pub-id><pub-id pub-id-type="pmid">29409532</pub-id><pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id></element-citation></ref><ref id="R68"><label>68</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolock</surname><given-names>SL</given-names></name><name><surname>Lopez</surname><given-names>R</given-names></name><name><surname>Klein</surname><given-names>AM</given-names></name></person-group><article-title>Scrublet: Computational identification of cell Doublets in Single-cell transcriptomic data</article-title><source>Cell Syst</source><year>2019</year><volume>8</volume><fpage>281</fpage><lpage>291</lpage><elocation-id>e9</elocation-id><pub-id pub-id-type="pmcid">PMC6625319</pub-id><pub-id pub-id-type="pmid">30954476</pub-id><pub-id pub-id-type="doi">10.1016/j.cels.2018.11.005</pub-id></element-citation></ref><ref id="R69"><label>69</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname><given-names>C</given-names></name><etal/></person-group><article-title>Automatic cell-type harmonization and integration across Human Cell Atlas datasets</article-title><source>Cell</source><year>2023</year><volume>186</volume><fpage>5876</fpage><lpage>5891</lpage><elocation-id>e20</elocation-id><pub-id pub-id-type="pmid">38134877</pub-id></element-citation></ref><ref id="R70"><label>70</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Traag</surname><given-names>VA</given-names></name><name><surname>Waltman</surname><given-names>L</given-names></name><name><surname>van Eck</surname><given-names>NJ</given-names></name></person-group><article-title>From Louvain to Leiden: guaranteeing well-connected communities</article-title><source>Sci Rep</source><year>2019</year><volume>9</volume><elocation-id>5233</elocation-id><pub-id pub-id-type="pmcid">PMC6435756</pub-id><pub-id pub-id-type="pmid">30914743</pub-id><pub-id pub-id-type="doi">10.1038/s41598-019-41695-z</pub-id></element-citation></ref><ref id="R71"><label>71</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Khemakhem</surname><given-names>I</given-names></name><name><surname>Kingma</surname><given-names>DP</given-names></name><name><surname>Monti</surname><given-names>RP</given-names></name><name><surname>Hyvärinen</surname><given-names>A</given-names></name></person-group><article-title>Variational Autoencoders and Nonlinear ICA: A Unifying Framework</article-title><source>arXiv [statML]</source><year>2019</year></element-citation></ref><ref id="R72"><label>72</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Watanabe</surname><given-names>S</given-names></name></person-group><article-title>Information theoretical analysis of multivariate correlation</article-title><source>IBM J Res Dev</source><year>1960</year><volume>4</volume><fpage>66</fpage><lpage>82</lpage></element-citation></ref><ref id="R73"><label>73</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>RTQ</given-names></name><name><surname>Li</surname><given-names>X</given-names></name><name><surname>Grosse</surname><given-names>R</given-names></name><name><surname>Duvenaud</surname><given-names>D</given-names></name></person-group><article-title>Isolating sources of disentanglement in variational autoencoders</article-title><source>arXiv [csLG]</source><year>2018</year></element-citation></ref><ref id="R74"><label>74</label><element-citation publication-type="book"><source>Schard: Reticulate-Free Single Cell Format Conversion</source><publisher-name>Github</publisher-name></element-citation></ref><ref id="R75"><label>75</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kuleshov</surname><given-names>MV</given-names></name><etal/></person-group><article-title>Enrichr: a comprehensive gene set enrichment analysis web server 2016 update</article-title><source>Nucleic Acids Res</source><year>2016</year><volume>44</volume><fpage>W90</fpage><lpage>7</lpage><pub-id pub-id-type="pmcid">PMC4987924</pub-id><pub-id pub-id-type="pmid">27141961</pub-id><pub-id pub-id-type="doi">10.1093/nar/gkw377</pub-id></element-citation></ref><ref id="R76"><label>76</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fang</surname><given-names>Z</given-names></name><name><surname>Liu</surname><given-names>X</given-names></name><name><surname>Peltz</surname><given-names>G</given-names></name></person-group><article-title>GSEApy: a comprehensive package for performing gene set enrichment analysis in Python</article-title><source>Bioinformatics</source><year>2023</year><volume>39</volume><pub-id pub-id-type="pmcid">PMC9805564</pub-id><pub-id pub-id-type="pmid">36426870</pub-id><pub-id pub-id-type="doi">10.1093/bioinformatics/btac757</pub-id></element-citation></ref><ref id="R77"><label>77</label><element-citation publication-type="journal"><collab>Gene Ontology Consortium</collab><etal/><article-title>The Gene Ontology knowledgebase in 2023</article-title><source>Genetics</source><year>2023</year><volume>224</volume><elocation-id>iyad031</elocation-id><pub-id pub-id-type="pmcid">PMC10158837</pub-id><pub-id pub-id-type="pmid">36866529</pub-id><pub-id pub-id-type="doi">10.1093/genetics/iyad031</pub-id></element-citation></ref><ref id="R78"><label>78</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Agrawal</surname><given-names>A</given-names></name><etal/></person-group><article-title>WikiPathways 2024: next generation pathway database</article-title><source>Nucleic Acids Res</source><year>2024</year><volume>52</volume><fpage>D679</fpage><lpage>D689</lpage><pub-id pub-id-type="pmcid">PMC10767877</pub-id><pub-id pub-id-type="pmid">37941138</pub-id><pub-id pub-id-type="doi">10.1093/nar/gkad960</pub-id></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Figure 1</label><caption><title>Schematic overview of the inVAE framework.</title><p><bold>a</bold>, The inVAE model incorporates both technical (T) and biological (B) covariates, using a nonlinear encoder to learn both invariant and spurious latent representations from high-dimensional data (X). Conditional prior distributions of cells are inferred via separate encoders, while a nonlinear decoder estimates the parameters of negative binomial distributions. The model’s loss function consists of two terms: (1) the negative log-likelihood, assessing the difference between the reconstructed and original count matrices, and (2) the KL divergence, measuring the divergence between the posterior <italic>q</italic><sub><italic>ϕ</italic></sub> and prior <italic>p</italic><sub><italic>θ</italic></sub> distributions. <bold>b</bold>, inVAE generates a range of outputs, including invariant and spurious representations of the data, which can be leveraged for downstream analysis such as data visualisation. The learned prior distributions can be used to infer relationships across biological conditions or samples. The trained model can be applied to map new datasets onto a reference atlas, with built-in classifiers available for cell annotation in these new datasets. <bold>c</bold>, inVAE enables several applications, including the identification of cell states across different health and disease conditions, developmental stages, or spatial cell locations.</p></caption><graphic xlink:href="EMS202000-f001"/></fig><fig id="F2" position="float"><label>Figure 2</label><caption><title>inVAE reveals disease-specific cell states in human heart failure.</title><p><bold>a</bold>, The dataset encompasses samples from control and patients with dilated cardiomyopathy (DCM) and arrhythmogenic cardiomyopathy (ACM), with diverse pathogenic variants, as well as donors of varying sex and age. <bold>b</bold>, The Uniform Manifold Approximation and Projection (UMAP) visualisation of inVAE’s invariant representation highlighted by cell types and disease-specific states, focusing particularly on cardiomyocytes and fibroblasts. <bold>c</bold>, Overall biological conservation and batch correction scores across leading integration methods using scIB metrics<sup><xref ref-type="bibr" rid="R41">41</xref></sup>. <bold>d</bold>, Meta-cell analysis using seaCell reveals variant-specific regions in the fibroblast cell embedding. Each dot represents a meta cell, which is a cluster of neighbouring cells, and is coloured according to the most frequent variant observed within that meta cell. The size of the dots indicates the percentage of cells within the meta cell that are labelled with the top variant. Meta cells are projected on the UMAP representation of fibroblast cells, shown in grey. <bold>e</bold>, Dot plot displaying log2-transformed expression of differentially expressed genes (DEG) across variants and disease conditions in fibroblasts. <bold>f</bold>, Activated fibroblast scores using <italic>POSTN</italic> and <italic>FAP</italic> genes. <bold>g</bold>, Sample compositions for cells with high fibroblast score (&gt;1.0) for both diseased (ACM and DCM) and control cells. <bold>h</bold>, The box plot showing the distribution of ACM scores using <italic>ARHGAP10, COL4A1, COL4A2</italic>, and <italic>FKBP5</italic> genes across disease states for fibroblasts. <bold>i</bold>, Meta cell analysis identifying variant-specific regions in the embedding of cardiomyocytes. <bold>j</bold>, Dot plot displaying DEG across variants and disease conditions in cardiomyocytes. <bold>k</bold>, Box plot showing the distribution of ACM score using PKP2 and ANKRD1 genes across disease states for cardiomyocytes.</p></caption><graphic xlink:href="EMS202000-f002"/></fig><fig id="F3" position="float"><label>Figure 3</label><caption><title>inVAE transfers labels and disease states in the human heart to an unseen study.</title><p><bold>a</bold>, The UMAP visualisation of inVAE’s extended heart atlas. The inVAE model is trained on two studies comprising samples from control and DCM donors. This trained model is then applied to map an unseen study onto the reference atlas. Two scenarios are considered: in the first, the unseen study involves similar conditions (control and DCM) to the training data, while in the second, it includes an unseen disease (HCM). <bold>b</bold>, Bar plot indicating the performance of disease and cell type classification for scenario 1. Shown are the average (Macro F1 scores) and per cell type and disease prediction performance (F1 scores). The prediction uncertainty is displayed per class. <bold>c</bold>, Cell type classification performance for scenario 2. Overall prediction performance (Macro F1 scores) and cell-type specific performance are shown (F1 scores). <bold>d</bold>, The importance of latent variables for different classification tasks (batch ID, cell type and disease) using a permutation-based importance measure metric<sup><xref ref-type="bibr" rid="R44">44</xref></sup>. ACM, arrhythmogenic cardiomyocyte; DCM, dilated cardiomyocyte; HCM, hypertrophic cardiomyopathy.</p></caption><graphic xlink:href="EMS202000-f003"/></fig><fig id="F4" position="float"><label>Figure 4</label><caption><title>inVAE identifies temporal cell states in the human fetal lung atlas.</title><p><bold>a</bold>, The experimental design of the fetal lung atlas study using samples from 29 donors, spanning 5 to 22 post-conception weeks (PCW). <bold>b</bold>, The UMAP visualisation of the atlas after applying the inVAE integration method coloured by cell type. Major cell types are labelled. <bold>c</bold>, Overall biology conservation and batch correction scores across the top five integration methods using scIB metrics<sup><xref ref-type="bibr" rid="R41">41</xref></sup>. <bold>d</bold>, top: UMAP focused on epithelial cells coloured by developmental stage. Shown are differentiation and temporal state axes. Bottom: The schematic overview of the cell types and their transitions along the two axes. <bold>e</bold>, UMAPs revealing similar cell types at three developmental stages, assigned as early, mid and late. <bold>f</bold>, The expression patterns of key markers (<italic>TPPP3, MAD2L1</italic>, and <italic>ADM</italic>) at each developmental stage shown using box plots across cell types. <bold>g</bold>, Neighbouring cell relationships depicted using Milo<sup><xref ref-type="bibr" rid="R46">46</xref></sup>. Each dot in the plot represents a neighbourhood of cells, coloured by the average developmental stage of the cells within that neighbourhood (termed ‘nhood-stage’). <bold>h</bold>, The distribution of marker genes in each cell type as a function of nhood-stage. The dashed lines show the correlation between the gene expression and nhood-stage by fitting a linear model. NK, natural killer cell; B, B cell; T, T cell; ILC, innate lymphoid cell; Myofibro, myofibroblast cell; SMC, smooth muscle cell; Meg-ery, megakaryocyte and erythroblast cells; PNS, peripheral nervous system; sil., silhouette; ROC AUC, Receiver Operating Characteristic Area Under the Curve.</p></caption><graphic xlink:href="EMS202000-f004"/></fig><fig id="F5" position="float"><label>Figure 5</label><caption><title>inVAE identifies spatial cell states in the adult human lung atlas.</title><p><bold>a</bold>. Lung samples collected from multiple anatomical regions of the lung. <bold>b-c</bold>. Uniform Manifold Approximation and Projection (UMAP) visualisations of the atlas after inVAE integration highlighted by cell types and regions. <bold>d</bold>. Overall biology conservation and batch correction scores comparing top-performing integration methods using scIB metrics<sup><xref ref-type="bibr" rid="R41">41</xref></sup>. <bold>e</bold>. A UMAP visualisation highlights AT1 cells, coloured by anatomical region. <bold>f</bold>. Enrichment score for differentially expressed genes (DEGs) in the lower left parenchyma, identified using unsupervised Hotspot. <bold>g</bold>. A dot plot displaying the log2-transformed expression of the DEGs. <bold>h</bold>. Enriched pathways, ranked by their -log10-transformed adjusted p-value. The dashed line marks significantly enriched pathways (p-value &gt; 0.05). <bold>i</bold>. The enrichment score for growth factor pathways in each AT1 cell region. <bold>j</bold>. UMAP visualisation highlights ciliated cells, coloured by anatomical region. <bold>k</bold>. The enrichment score for DEGs of the lower left parenchyma, identified by unsupervised Hotspot. <bold>l</bold>. A dot plot showing the corresponding DEGs and their log2-transformed expression. <bold>m</bold>. Enriched pathways in the lower left parenchyma of ciliated cells. <bold>n</bold>. The enrichment score for growth factor pathways in each region of ciliated cells. AT1, alveolar type 1.</p></caption><graphic xlink:href="EMS202000-f005"/></fig></floats-group></article>