<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="epub">2692-8205</issn></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS206282</article-id><article-id pub-id-type="doi">10.1101/2025.06.03.657578</article-id><article-id pub-id-type="archive">PPR1032227</article-id><article-version-alternatives><article-version article-version-type="status">preprint</article-version><article-version article-version-type="number">1</article-version></article-version-alternatives><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>Integrating multi-covariate disentanglement with counterfactual analysis on synthetic data enables cell type discovery and counterfactual predictions</article-title></title-group><contrib-group><contrib contrib-type="author" equal-contrib="yes"><name><surname>Megas</surname><given-names>Stathis</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref></contrib><contrib contrib-type="author" equal-contrib="yes"><name><surname>Amani</surname><given-names>Arian</given-names></name><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author" equal-contrib="yes"><name><surname>Rose</surname><given-names>Antony</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A5">5</xref></contrib><contrib contrib-type="author"><name><surname>Dufva</surname><given-names>Olli</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A3">3</xref></contrib><contrib contrib-type="author"><name><surname>Shamsaie</surname><given-names>Kian</given-names></name><xref ref-type="aff" rid="A6">6</xref></contrib><contrib contrib-type="author"><name><surname>Asadollahzadeh</surname><given-names>Hesam</given-names></name><xref ref-type="aff" rid="A7">7</xref></contrib><contrib contrib-type="author"><name><surname>Polanski</surname><given-names>Krzysztof</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A3">3</xref></contrib><contrib contrib-type="author"><name><surname>Haniffa</surname><given-names>Muzlifah</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A5">5</xref><xref ref-type="corresp" rid="CR1">†</xref></contrib><contrib contrib-type="author"><name><surname>Teichmann</surname><given-names>Sarah A.</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A8">8</xref><xref ref-type="corresp" rid="CR1">†</xref></contrib><contrib contrib-type="author"><name><surname>Lotfollahi</surname><given-names>Mohammad</given-names></name><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A1">1</xref><xref ref-type="corresp" rid="CR1">†</xref></contrib></contrib-group><aff id="A1"><label>1</label>Cambridge Stem Cell Institute, Department of Medicine, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/013meh722</institution-id><institution>University of Cambridge</institution></institution-wrap>, <city>Cambridge</city>, <country country="GB">United Kingdom</country></aff><aff id="A2"><label>2</label>Cambridge Center for AI in Medicine, Department of Applied Mathematics and Theoretical Physics, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/013meh722</institution-id><institution>University of Cambridge</institution></institution-wrap>, <city>Cambridge</city>, <country country="GB">United Kingdom</country></aff><aff id="A3"><label>3</label>Department of Cellular Genetics, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/05cy4wa09</institution-id><institution>Wellcome Sanger Institute</institution></institution-wrap>, <city>Hinxton</city>, <country country="GB">United Kingdom</country></aff><aff id="A4"><label>4</label>Department of Computer Science, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/02be6w209</institution-id><institution>Sapienza University of Rome</institution></institution-wrap>, <city>Rome</city><country country="IT">Italy</country></aff><aff id="A5"><label>5</label>Biosciences Institute, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/01kj2bm70</institution-id><institution>Newcastle University</institution></institution-wrap>, <city>Newcastle upon Tyne</city>, <country country="GB">United Kingdom</country></aff><aff id="A6"><label>6</label><institution-wrap><institution-id institution-id-type="ror">https://ror.org/041kmwe10</institution-id><institution>Imperial College London</institution></institution-wrap>, <city>London</city>, <country country="GB">United Kingdom</country></aff><aff id="A7"><label>7</label><institution-wrap><institution-id institution-id-type="ror">https://ror.org/024c2fq17</institution-id><institution>Sharif University of Technology</institution></institution-wrap>, <city>Tehran</city>, <country country="IR">Iran</country></aff><aff id="A8"><label>8</label><institution-wrap><institution-id institution-id-type="ror">https://ror.org/01sdtdd95</institution-id><institution>Canadian Institute for Advanced Research</institution></institution-wrap>, <city>Toronto</city>, <country country="CA">Canada</country></aff><author-notes><corresp id="CR1"><label>†</label>Correspondence: <email>ml19@sanger.ac.uk</email>, <email>sat1003@cam.ac.uk</email>, <email>mh32@sanger.ac.uk</email></corresp></author-notes><pub-date pub-type="nihms-submitted"><day>08</day><month>06</month><year>2025</year></pub-date><pub-date pub-type="preprint"><day>06</day><month>06</month><year>2025</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by-nc-nd/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P1">Single-cell gene expression is influenced by diverse covariates such as genomics protocol, tissue origin, donor attributes, and microenvironment, which are challenging to disentangle. We present CellDISECT, a novel method combining disentangled representations and causal inference for multi-batch, multi-covariate single-cell data analysis. CellDISECT employs a mixture of expert variational autoencoders to learn covariate-specific and unsupervised latent spaces, enabling counterfactual predictions and biological discovery. Drawing inspiration from LLM training on synthetic data, CellDISECT generates synthetic counterfactuals during training and their quality is scored in the loss function. This semi-autoencoding of counterfactuals during training increases model performance in counterfactual predictions at test time. Benchmarking across datasets, CellDISECT outperformed existing methods in disentanglement, counterfactual <italic>in-silico</italic> prediction of responses to perturbations, and cell type discovery. CellDISECT predicted responses of cells to changing tissue microenvironments and identified a novel pre-natal megakaryocyte subpopulation with immune characteristics distinct from classical platelet-producing MKs, highlighting its unique capabilities in single-cell analysis to help identify novel subpopulations and reduce concerns of technical effects during integration.</p></abstract></article-meta></front><body><sec id="S1" sec-type="intro"><title>Introduction</title><p id="P2">A cell’s gene expression profile is a function of multiple attributes such as tissue of origin, its surrounding microenvironment, biometric factors of the donor, and experimental technical variables, as well as clinical variables such as treatments or infections. Single-cell sequencing has enabled profiling gene expression at single-cell resolution in a high-throughput manner<sup><xref ref-type="bibr" rid="R1">1</xref>,<xref ref-type="bibr" rid="R2">2</xref></sup>, but it still remains challenging to analyze and interpret millions of cells at the same time due to the simultaneous and intertwined effects of the aforementioned attributes on gene expression, which can be hard to disentangle<sup><xref ref-type="bibr" rid="R3">3</xref></sup>. Such a disentangled representation of single-cell data would be more interpretable and would facilitate understanding of biological mechanisms<sup><xref ref-type="bibr" rid="R4">4</xref>,<xref ref-type="bibr" rid="R5">5</xref></sup>, and if combined with causal modeling, would also allow for better counterfactual predictions<sup><xref ref-type="bibr" rid="R6">6</xref></sup>. Counterfactual predictions could allow understanding the molecular responses of various cell types and patient groups to environmental challenges such as infections or therapeutic interventions.</p><p id="P3">Disentanglement methods in representation learning aim to find a latent representation that naturally organizes in semantically distinct components<sup><xref ref-type="bibr" rid="R4">4</xref>,<xref ref-type="bibr" rid="R5">5</xref></sup>. Such representations are at the core of explainable AI since they not only facilitate learning but also offer insights into the inner workings of neural networks, allowing us to understand why models make the predictions they do.</p><p id="P4">In statistics, causal inference is the field that tries to uncover causal links between variables in the presence of spurious correlations in the data<sup><xref ref-type="bibr" rid="R6">6</xref></sup>. Uncovering these causal links can then be leveraged to predict counterfactual outcomes, which are simulated outcomes for different scenarios and actions that were never observed. Since at any given time, we can only opt for one course of action, often referred to as the fundamental problem of causal inference, counterfactual simulation analysis is necessary to estimate individualized treatment effects and personalize medical treatments<sup><xref ref-type="bibr" rid="R7">7</xref></sup>.</p><p id="P5">Finally, recent work in large language modelling has shown opportunities and limitations<sup><xref ref-type="bibr" rid="R8">8</xref>,<xref ref-type="bibr" rid="R9">9</xref></sup> of training on data generated by AI, often referred to as synthetic data. In the seminal Deepseek-R1 series of models<sup><xref ref-type="bibr" rid="R10">10</xref></sup>, the authors used Deepseek-R1 to generate 800k (synthetic) training samples to then train a set of smaller models. However, training recursively on synthetically (non-causally) generated data leads to mode collapse<sup><xref ref-type="bibr" rid="R11">11</xref>,<xref ref-type="bibr" rid="R12">12</xref></sup>.</p><p id="P6">In single-cell data, there have been earlier attempts at disentangled representations with Biolord<sup><xref ref-type="bibr" rid="R13">13</xref></sup> and scDisInFact<sup><xref ref-type="bibr" rid="R14">14</xref></sup> and also earlier attempts with causal inference methods<sup><xref ref-type="bibr" rid="R15">15</xref>–<xref ref-type="bibr" rid="R17">17</xref></sup> for single-cell data, but not both simultaneously. Importantly, only one of these methods<sup><xref ref-type="bibr" rid="R16">16</xref></sup> leverages the abilities of generative models to be trained on their own (synthetic) data, but it does not perform an ablation study of its effect. Moreover, most of these methods allow modeling of only one covariate at a time<sup><xref ref-type="bibr" rid="R15">15</xref>,<xref ref-type="bibr" rid="R16">16</xref></sup>; learn cell embeddings that are akin to covariate embeddings and are therefore not able to capture biological information<sup><xref ref-type="bibr" rid="R13">13</xref>,<xref ref-type="bibr" rid="R14">14</xref>,<xref ref-type="bibr" rid="R16">16</xref></sup>; and suffer from lack of causal identifiability which can impact the quality of the counterfactual predictions<sup><xref ref-type="bibr" rid="R13">13</xref>,<xref ref-type="bibr" rid="R14">14</xref></sup>. Modelling multiple covariates is essential in complex biological datasets for understanding the impact of features such as age, sex and genetics simultaneously on cell states.</p><p id="P7">Here we introduce Cell DISentangled Experts for Covariate counTerfactuals (CellDISECT) for disentangled representations and causal inference for multi-batch, multi-covariate single-cell data analysis. We demonstrate the utility of CellDISECT in counterfactual predictions of responses to inflammatory stimuli, infectious agents, and tissue microenvironments across cell types and patient groups. We also reprocess and integrate a public single-cell cross-organ study of the developing immune system<sup><xref ref-type="bibr" rid="R18">18</xref></sup> to resolve the different populations of immune cell types and revealed a novel subpopulation of early megakaryocytes (MKs) with immune properties but distinct from previously identified immune MKs in the yolk sac (YS)<sup><xref ref-type="bibr" rid="R19">19</xref></sup>. Moreover, CellDISECT highlighted important differences in erythropoiesis between liver and bone marrow.</p></sec><sec id="S2" sec-type="results"><title>Results</title><sec id="S3"><title>CellDISECT offers covariate-supervised cell embeddings that capture biological information</title><p id="P8">Existing approaches for disentangled representations in single cell data are focused on either counterfactual predictions<sup><xref ref-type="bibr" rid="R13">13</xref></sup> or inferring which genes are affected by each covariate<sup><xref ref-type="bibr" rid="R14">14</xref></sup>. As such, they utilize latent spaces resembling covariate embeddings, which cannot be effectively leveraged to explore cell type specificity.</p><p id="P9">We present CellDISECT, a method that integrates disentangled representations with causal learning on synthetic training data to analyse multi-batch, multi-covariate single-cell datasets. (see <xref ref-type="fig" rid="F1">Figure 1a</xref>). CellDISECT consists of a mixture of expert VAEs<sup><xref ref-type="bibr" rid="R20">20</xref></sup>, each specializing in one of the covariates at a time by finding a representation of cells that is supervised by this covariate as well as an unsupervised VAE that aims to learn a representation for unobserved covariates (see <xref ref-type="fig" rid="F1">Figure 1b</xref>). CellDISECT can then leverage the learnt latent factors to compute counterfactual gene expression due to perturbations on one covariate at a time or many covariates together, a novelty that has hitherto been ignored in the literature (see <xref ref-type="fig" rid="F1">Figure 1c</xref>). During the training process we repeatedly generate (synthetic) counterfactuals and include a penalty term in the loss function for the quality of these predictions (see <xref ref-type="sec" rid="S17">Methods</xref>).</p><p id="P10">CellDISECT estimates for cell n the conditional distribution, <italic>p</italic>(<italic>x<sub>n</sub></italic> | <italic>s</italic><sub>1<italic>n</italic></sub>, …, <italic>s<sub>Cn</sub></italic>) in which <italic>x</italic> <sub><italic>n</italic></sub> is the G-dimensional vector of observed RNA counts (G is the total number of genes), and <italic>s</italic><sub>1<italic>n</italic></sub>, …, <italic>s<sub>Cn</sub></italic> are covariate vectors describing information such as batch index of cell, age of donor, tissue etc. In total there are N cells, and C covariates for each cell. This distribution is estimated using a Mixture of C + 1 Expert (MoE) VAEs, and C(C + 1) auxiliary MLPs that decouple these expert VAEs. In addition to interpretability, and flexible batch correction, this decoupling also offers a straightforward approach to counterfactual prediction<sup><xref ref-type="bibr" rid="R15">15</xref></sup>.</p><p id="P11">The architecture of CellDISECT is mathematically derived from rigorous manipulations of the stipulated causality graph where we integrate out a different subset of covariates each time (see <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref> for the theory of the model). The generality of our approach and its use of a mixture of disentangled experts also offers three features unique to our approach: 1) supervised latent representations of cells, which capture covariate information and at the same time 2) new biology, thereby providing users with a multifaceted view of the data and facilitating exploration of cell type specificity; 3) flexible fairness in batch correction<sup><xref ref-type="bibr" rid="R21">21</xref></sup>, which enables the user to define which covariates to use as biological and which as batch at <italic>test time</italic>, as opposed to only at train time as with most methods.</p><p id="P12">Leveraging both causal inference and disentanglement (see <xref ref-type="fig" rid="F1">Figure 1d</xref>), allows CellDISECT to outperform both Biolord and scDisInFact across several tasks in disentanglement and out-of-distribution (OOD) counterfactual predictions, which we benchmark using famous as well as novel metrics. We implemented CellDISECT using the scvi-tools library and made it publicly available to download<sup><xref ref-type="bibr" rid="R22">22</xref></sup>.</p><sec id="S4"><title>CellDISECT captures covariate-specific information in complex single-cell studies</title><p id="P13">To assess how CellDISECT’s covariate-supervised cell embeddings can capture biological information we applied CellDISECT to the cross-organ dataset<sup><xref ref-type="bibr" rid="R23">23</xref></sup> which consists of &gt;200k nuclei of 25 samples from 16 donors. The covariates for each cell in this dataset include the sample ID, organ location, and the donor’s gender and age. The results, presented in <xref ref-type="fig" rid="F2">Figure 2</xref>, highlight the novelty of CellDISECT which offers latent spaces that not only capture covariate information but also biological variation. We compare CellDISECT to other baseline models<sup><xref ref-type="bibr" rid="R13">13</xref>,<xref ref-type="bibr" rid="R14">14</xref></sup> across several metrics, illustrating CellDISECT’s advantages in terms of both latent space structure and quantitative performance.</p><p id="P14">To assess the ability of each model to disentangle covariates, we visualized the latent spaces for CellDISECT, Biolord, and scDisInFact, each coloured by different covariates (<xref ref-type="fig" rid="F2">Figure 2a</xref>). The latent space of CellDISECT (top row) clearly clusters cells by each covariate in a structured manner, demonstrating effective separation of biological signals, such as age, sex and tissue. In contrast, supervised cell embeddings generated by Biolord and scDisInFact are akin to covariate embeddings that display more overlap across clusters, suggesting both weaker disentanglement and inability to capture non-covariate biological information within the supervised latent spaces.</p><p id="P15">In tissue-aligned latent space (see <xref ref-type="fig" rid="F2">Figure 2b</xref>), CellDISECT successfully identifies various cell types (e.g., epithelial, immune, endothelial) as distinct clusters, whereas Biolord and scDisInFact do not learn any more biology than tissue specific information. The results suggest that CellDISECT can uncover cell type specificity in an unsupervised manner in all its latent spaces, thereby offering a multifaceted view of the data.</p><p id="P16">To quantitatively verify the above qualitative observations we evaluate CellDISECT’s integration performance using scIB<sup><xref ref-type="bibr" rid="R24">24</xref></sup> (see <xref ref-type="fig" rid="F2">Figure 2c</xref>), where we assess both biological conservation and batch correction metrics over all latents, across CellDISECT, Biolord, and scDisInFact. CellDISECT achieves superior scores in both categories, with an aggregate score of 0.53, outperforming Biolord and scDisInFact (aggregate scores of 0.41 and 0.34, respectively). For each covariate given to the model, we ran scIB metrics on Z<sub>0</sub> and Z<sub>i</sub> (covariate’s respective latent) with label_key set to the cell type annotations (not an observed covariate), and batch_key set to all other covariates. Showing the ability to discover cell types (Bio conservation), while removing observed covariates’ effects (Batch correction) from all latent spaces (see <xref ref-type="fig" rid="F2">Figure 2c</xref> and <xref ref-type="supplementary-material" rid="SD2">Supplemental Figures 8-12</xref>).</p><p id="P17">These results demonstrate that CellDISECT effectively balances the removal of batch effects while maintaining the biological relevance of cell types, underscoring its suitability for integrating multi-batch, multi-condition single-cell datasets.</p></sec></sec><sec id="S5"><title>CellDISECT accurately disentangles covariate information and predicts responses to inflammatory and infectious perturbations</title><p id="P18">Having verified CellDISECT’s novel ability to offer multi-faceted cell embeddings, we then seek to demonstrate the second use case of CellDISECT: counterfactual predictions with new state-of-the-art performance on biologically relevant perturbations. To benchmark our approach we devised several different scenarios for out-of-distribution counterfactual predictions (see <xref ref-type="fig" rid="F3">Figure 3a</xref>). Importantly we also introduced a benchmark on double counterfactual prediction which to our knowledge marks the first time double counterfactuals are used to benchmark cell perturbations.</p><sec id="S6"><title>Description of datasets</title><p id="P19">To achieve comprehensive benchmarking for disentanglement and counterfactual prediction we use not only the Cross-organ dataset (introduced above) but also Blood, and Intestine datasets. The Blood dataset<sup><xref ref-type="bibr" rid="R25">25</xref></sup> comprises 13,576 cells from control and interferon (IFN)-β stimulated cells, which we treat as a binary covariate, and a categorical covariate indicating the cell type. Finally, the intestine data<sup><xref ref-type="bibr" rid="R26">26</xref>,<xref ref-type="bibr" rid="R27">27</xref></sup> contains 9,842 individual epithelial cells from the small intestine of mice whose condition is either healthy, infected by Salmonella or by Heligmosomoides polygyrus (H.Poly). For this dataset we used the covariates for “batch”, “condition” and “cell label”.</p><p id="P20">To benchmark CellDISECT in the Blood dataset, which is a popular dataset used for benchmarking perturbations<sup><xref ref-type="bibr" rid="R3">3</xref>,<xref ref-type="bibr" rid="R28">28</xref></sup>, we used 8 different train/validation/OOD splits, corresponding to the 8 different cell types in the data where in each split the stimulated cells in the corresponding cell type are left out as out-of-distribution. At inference time, and for every split (cell type), we are predicting what the gene expression of these control cell types would have been, had they been stimulated, and comparing it to the held out stimulated cells. We observe that CellDISECT has the highest performance in 5 out of 6 comparisons with Biolord and scDisInFact. These comparisons include three different metrics (Pearson, Delta Pearson and Earth Mover’s Distance (EMD) and two different gene sets (for all genes and for the top 20 differentially expressed genes (DEGs)), see <xref ref-type="supplementary-material" rid="SD2">Supplemental Figure 1 and 2</xref>.</p><p id="P21">In the Intestine dataset, we challenged our model even more by performing perturbations from source to target cells, where both the source and the target cells are out-of-distribution (OOD) during training. In particular, for each of its 8 cell types, we constructed 2 scenarios, one with control cells and Salmonella-infected cells being held out, and one with control cells and 10 days H. poly-infected cells being held out (making up to 16 splits). For the counterfactual prediction task in each split, we predict what the gene expression of the infected cells in the corresponding cell type would be, given the control cells. We observe that CellDISECT has the highest performance in 4 out of the 6 comparisons, see <xref ref-type="supplementary-material" rid="SD2">Supplemental Figure 3 and 4</xref>.</p><p id="P22">Finally to showcase CellDISECT’s ability to model and perturb many covariates on the same dataset, we devised several perturbation scenarios for the Cross-organ dataset, including a double counterfactual where two covariates are perturbed at the same time. To our knowledge, this is the first time double perturbations are used to benchmark perturbation models for single cell data.</p><p id="P23">In scenario A, we studied sex perturbation, by holding out (across all organs) all male cells of cell type T, NK, and DC/macrophage; as well as all female cells of these cell types in the lung. During evaluation, we performed counterfactual predictions on these cell types, to predict what the gene expression would be if female cells in the lung were male. In scenario B we devise a double perturbation experiment, where we perturb both the sex of the donor and the tissue environment of the cells while remaining within the epithelial luminal cell type. In particular we hold out all the epithelial luminal cells in the dataset, and then try to predict the male prostate epithelial cell from the female breast epithelial cells. In scenario C, we studied the effect of perturbations on the tissue environment of a cell. We held out all the male cells in the dataset, and trained solely on female cells. Then, we predicted the response of male muscle macrophages upon changing their tissue environment to the lingua of the left lung and then compared to the male alveolar macrophages. In this more complex dataset, CellDISECT exhibited strong performance increases across all 6 comparisons to competing models, see <xref ref-type="supplementary-material" rid="SD2">Supplemental Figure 5 and 6</xref>.</p></sec><sec id="S7"><title>CellDISECT achieves superior counterfactual prediction performance</title><p id="P24">Benchmarking CellDISECT against Biolord and scDisInFact on the datasets and scenarios, metrics and gene sets we described above, we observe that it exhibits a nearly 20% performance increase in predicting the top20 DEGs (see <xref ref-type="fig" rid="F3">Figure 3b</xref>) and 6.5% increase in predicting all genes (see <xref ref-type="fig" rid="F3">Figure 3c</xref>), with respect to Biolord, which is the previous state of the art in our benchmarking.</p><p id="P25">As noted in a recent publication<sup><xref ref-type="bibr" rid="R28">28</xref></sup>, Pearson correlation becomes a less and less useful metric for comparing models’ performance as their performance improves. Instead, they recommend using Delta Pearson<sup><xref ref-type="bibr" rid="R28">28</xref></sup> as a harder and more reliable task when models’ performance approaches pearson correlation of 1. In line with these observations, we report that CellDISECT is roughly tied with Biolord and scDisInfact when benchmarked with the Pearson correlation, but exhibits strong performance increases in Delta Pearson correlation, as well as on average over all metrics. Notably, overall CellDISECT shows strong performance increases in the hard tasks, such as the double counterfactual scenario in Eraslan, where our model predicts the target cells with a Pearson correlation of 0.89, whereas both the competitors and the control cells have negative correlations with the target cells (see <xref ref-type="supplementary-material" rid="SD2">Supplemental Figure 7</xref>).</p></sec><sec id="S8"><title>CellDISECT achieves superior disentanglement of covariates</title><p id="P26">We can get an intuition of CellDISECT’s approach to disentanglement from the UMAP visualization of its latent spaces on the Kang dataset, see <xref ref-type="fig" rid="F3">Figure 3d</xref>. <italic>Z</italic> <sub><italic>cell type</italic></sub> has learned to disentangle cell type information, but is completely uninformative to the condition covariate, conversely, <italic>Z<sub>condition</sub></italic> disentangles the condition covariate but is uninformative to the cell types. <italic>Z</italic><sub>0</sub> has forgotten both the cell type information and the condition information, but instead has learnt another unmeasured covariate, which is the lineage of the cells. Specifically <italic>Z</italic><sub>0</sub> clusters all the lymphoid cell types together and separately from all the myeloid cell types, showcasing how CellDISECT can learn new biology in an unsupervised fashion.</p><p id="P27">We now proceed to quantitatively benchmark the disentanglement properties of CellDISECT against those of Biolord and scDisInFact using information-theoretic (see <xref ref-type="fig" rid="F3">Figure 3e</xref>) and biological metrics (see <xref ref-type="fig" rid="F3">Figure 3f</xref>).</p><p id="P28">To benchmark the information-theoretic disentanglement properties of CellDISECT, we introduce a new metric, which we call concatenated mutual information gap (concatMIG), to overcome limitations of MIG <sup><xref ref-type="bibr" rid="R5">5</xref></sup> related to nested covariates. concatMIG calculates the difference (“gap”) of the mutual information between <italic>Z<sub>i</sub></italic> and covariate i minus the mutual information between all other latents spaces together (<italic>Z</italic><sub>−<italic>i</italic></sub>) and covariate i. Across all three datasets, CellDISECT shows the highest level of information-theoretic disentanglement. Notably in the Cross-organ dataset, not only CellDISECT exhibits superior disentanglement, but the competing methods report a negative concatMIG which implies that all the non-aligned latent spaces when taken together contain more information about a covariate than the covariate space which is aligned to it.</p><p id="P29">Moreover, to benchmark the biological disentanglement properties of CellDISECT we employ the SCIB metrics, a widely used framework for evaluating methods on tasks of batch effect correction and biological information preservation. For the Blood and the Intestine dataset, we applied scIB on each of the latents <italic>Z<sub>i</sub></italic> s.t. i &gt; 0 with the label key (the covariate we expect the latent space to be preserving; bio conservation) set to the covariate aligned to it, while setting the rest of the covariates (once at a time) to the batch key (the covariate we expect the latent space to be ignorant of). As for the Cross-organ dataset, since the cell type is not provided as a seen covariate while training, we are calculating the scIB metrics over each of the latents (including <italic>Z</italic><sub>0</sub>) with the label key set to the cell type annotations from the dataset, and the batch key set to all the seen covariates, that are non-correspondent to the latent each time. The final values reported in <xref ref-type="fig" rid="F3">Figure 3f</xref> show the aggregated mean values of scIB metrics on all 3 datasets.</p><p id="P30">Finally, to test the effect that causal analysis on synthetic counterfactuals <italic>during</italic> training has on CellDISECT’s performance on counterfactual predictions at <italic>test</italic> time we perform an ablation study of the counterfactual term in the loss function. In our model we introduce hyperparameters as coefficients of all the terms in the loss function. In our ablation experiment, we keep the coefficients of all the terms in the ELBO as derived in proposition 1 (see <xref ref-type="sec" rid="S17">Methods</xref>) and vary the coefficient associated with the counterfactual term. We observe that ablating this counterfactual loss term leads to reduced model performance in counterfactual predictions at test time (see <xref ref-type="fig" rid="F3">Figure 3g</xref>). In more detail, CellDISECT’s performance deteriorates without the counterfactual term in 9 out of 12 metrics, stays roughly constant in 1 and improves only in 2 (see <xref ref-type="supplementary-material" rid="SD2">Supplemental Figures 15, 16</xref>).</p></sec></sec><sec id="S9"><title>CellDISECT identifies non-classical megakaryocyte sub-population</title><p id="P31">We now demonstrate how CellDISECT’s latent spaces, which capture covariate information as well as biological variation, can be used to explore cell type specificity. In particular, CellDISECT identifies a new subpopulation of megakaryocytes which exhibits immune behavior.</p><sec id="S10"><title>Description of data</title><p id="P32">A recent study<sup><xref ref-type="bibr" rid="R18">18</xref></sup> mapped the developing human immune system across nine prenatal organs using single-cell RNA sequencing and spatial transcriptomics, creating an atlas of over 900,000 immune cells, see <xref ref-type="fig" rid="F4">Figure 4a</xref>. They discovered system-wide blood and immune cell development beyond traditional haematopoietic sites, including the gut and skin. The study highlighted the maturation of monocytes and T cells before migration to peripheral tissues, characterised innate-like B1 cells and unconventional T cells, and identified lineage-committed progenitors in unexpected locations.</p></sec><sec id="S11"><title>Megakaryocyte biology</title><p id="P33">Megakaryocytes (MK) are large bone marrow cells responsible for producing platelets, which are critical for blood clotting. They arise from megakaryocyte-erythroid progenitors (MEPs) and undergo a unique maturation process called endomitosis<sup><xref ref-type="bibr" rid="R29">29</xref></sup>, where they replicate DNA without dividing, leading to their large size which is where their name derives from. Mature megakaryocytes then release platelets into the bloodstream by shedding cytoplasmic fragments<sup><xref ref-type="bibr" rid="R29">29</xref></sup>. Previous studies<sup><xref ref-type="bibr" rid="R19">19</xref>,<xref ref-type="bibr" rid="R30">30</xref>,<xref ref-type="bibr" rid="R31">31</xref></sup> have shown the possibility for immune function of such cells. One study<sup><xref ref-type="bibr" rid="R19">19</xref></sup> showed MK cells in the yolk sac (YS) using single-cell transcriptomics and identified two MK subpopulations with likely niche support and immune functions respectively, suggesting potential immune-like functions for MK cells in primitive haematopoiesis. Additionally, studies in mice<sup><xref ref-type="bibr" rid="R31">31</xref></sup> and adult bone marrow<sup><xref ref-type="bibr" rid="R30">30</xref></sup> cells also show the potential for immune-like MK cells in adult life.</p></sec><sec id="S12"><title>SPINK4 MK subpopulation in developing immune system</title><p id="P34">We processed the immune atlas<sup><xref ref-type="bibr" rid="R18">18</xref></sup> using CellDISECT with default settings. Using Leiden clustering (with default scanpy settings) in the <italic>Z</italic><sub>0</sub> latent space in the CellDISECT embeddings (see <xref ref-type="fig" rid="F4">Figure 4a</xref>) we observe that the cells annotated as early MK cells in the original publication<sup><xref ref-type="bibr" rid="R18">18</xref></sup> split into two distinct clusters (see <xref ref-type="fig" rid="F4">Figure 4b</xref>). The smaller of the two clusters contains mainly contributions from spleen, liver, and bone marrow from different donors (see <xref ref-type="supplementary-material" rid="SD2">Supplementary Figure 14</xref>). Connectivity and trajectory analysis (see <xref ref-type="fig" rid="F4">Figure 4c,d</xref>) shows SPINK4+ early MK cells differentiation away from MEP into the MK lineage but not following into late MK cells. This subpopulation expresses MK gene markers (see <xref ref-type="fig" rid="F4">Figure 4e</xref>) such as FLI1<sup><xref ref-type="bibr" rid="R32">32</xref>,<xref ref-type="bibr" rid="R33">33</xref></sup>, which is a known key MK lineage TF, and PLEK<sup><xref ref-type="bibr" rid="R34">34</xref></sup>. At the same time, however, these MK cells do have low expression of PF4 and lacking expression of THBS1 indicating that they are not moving towards platelet formation. They also express MITF, a known mast cell TF, and genes related to mast cell/basophil functions including FCER1A and ENPP3<sup><xref ref-type="bibr" rid="R35">35</xref>,<xref ref-type="bibr" rid="R36">36</xref></sup>, suggesting a potential immune function. They also express HPGD and HPGDS<sup><xref ref-type="bibr" rid="R37">37</xref></sup>, enzymes involved in prostaglandin synthesis released by activated mast cells that mediate inflammatory functions. However, the differentiation trajectory makes it clear that they are somewhere between MEP and MK in the lineage, and therefore not along the mast cell differentiation trajectory. This suggests that these MK cells may share immune-like roles similar to other immune cell types, showing post primitive haematopoiesis MK cells can also exhibit immune roles during definitive haematopoiesis. The newly identified subpopulation also expresses unique gene markers such as SPINK4 whose function is not yet clear. SPINK4 is primarily linked to goblet cell function <sup><xref ref-type="bibr" rid="R38">38</xref>–<xref ref-type="bibr" rid="R40">40</xref></sup> but expression in the hematopoietic lineage has not been previously reported. It is worth noting that Leiden clustering with default settings (of the same cells) in the scVI latent does not assign this new subpopulation to a separate cluster (see <xref ref-type="supplementary-material" rid="SD2">supplemental Figure 13</xref>) which highlight CellDISECT’s ability to resolve distinct clusters that are masked by scVI embeddings.</p><p id="P35">Finally, the <italic>Z</italic> <sub><italic>organ</italic></sub> latent space provides a latent representation of the immune atlas stratified by organ (see <xref ref-type="fig" rid="F4">Figure 4f</xref>). The stratification of the organs in this space captures the underlying biology between organs, with more similar organs located more closely (see <xref ref-type="fig" rid="F4">Figure 4g</xref>). Bone marrow, yolk sac, and fetal liver are all major hematopoietic organs, whereas lymph nodes and thymus are major lymphoid organs rich in lymphocytes such as T cells.</p><p id="P36">In conclusion, we identify a subpopulation of early MK cells during fetal development which exhibits immune-like roles during definitive haematopoiesis, distinct from MK cells with immune-like roles previously reported in the YS.</p></sec></sec><sec id="S13"><title>CellDISECT highlights erythropoiesis difference between liver and bone marrow by leveraging multiple latents</title><p id="P37">We now demonstrate how CellDISECT’s multiple latents not only offer a multifaceted view of the data but at the same time enable flexible fairness in single-cell integration. CellDISECT allows selecting which covariates to designate as biological and which as batch covariates at test time, as opposed to only at train time like other methods. We then leverage this ability to highlight differences in erythropoiesis between the liver and bone marrow.</p><sec id="S14"><title>Erythropoiesis biology</title><p id="P38">Erythropoiesis is a highly regulated, key function which is transferred between organs throughout embryonic and fetal development<sup><xref ref-type="bibr" rid="R41">41</xref></sup>. Two of the key organs this occurs in is the liver, the primary haematopoietic organ during development, and the bone marrow which is then the main organ responsible for erythropoiesis throughout adulthood.</p></sec><sec id="S15"><title>Differences in erythropoiesis between liver and bone marrow</title><p id="P39">To study erythropoiesis in the <sup><xref ref-type="bibr" rid="R18">18</xref></sup> atlas, we leverage the flexible fairness inherent in our method by concatenating the latent representations from <italic>Z</italic><sub>0</sub> and <italic>Z<sub>organ</sub></italic> to construct the <italic>Z</italic> <sub>0,<italic>organ</italic></sub>. This latent space is aligned with both the organ covariate and unknown covariates, and has the effect of the platform and donor covariates regressed out (see <xref ref-type="fig" rid="F5">Figure 5a</xref>). Notably to construct this latent space, we did not need to retrain our model, but manage to construct it at test time by leveraging the flexible fairness property of our method. Subsetting the dataset to the erythropoiesis branch, as annotated in the original publication<sup><xref ref-type="bibr" rid="R18">18</xref></sup> (see <xref ref-type="fig" rid="F5">Figure 5b</xref>), we observed that erythroids would split into two main routes caused by the biological covariate organ; depending on if they are contributed by the liver or the bone marrow, and not due to technical effects. Other organs would also split however, with the low number of erythroid contributions from these organs however, these differences are less prominent due to the lack of cell numbers.</p><p id="P40">To investigate these 2 splits of erythroid maturation seen between the liver and bone marrow, trajectory analysis was performed using Cellrank on <italic>Z</italic><sub>0,<italic>organ</italic></sub> (see <xref ref-type="fig" rid="F5">Figure 5c</xref>). This analysis shows that the split between organs first becomes apparent at the MEP stage with liver erythroids further splitting at mid-erythroid stage primarily linked to increased mitochondrial activity. Gene trends of known erythroid maturation markers (HBA1, HBA2, HBG1, HBG2, HBB) shows both routes increasing across as well as highlighting bone marrow erythroids having increased expression of histone genes compared to liver, occurring in the early to mid erythroids (see <xref ref-type="fig" rid="F5">Figure 5d</xref>). As erythroid maturation is modulated through histone regulation by processes such as acetylation, methylation and phosphorylation<sup><xref ref-type="bibr" rid="R41">41</xref>–<xref ref-type="bibr" rid="R43">43</xref></sup>, this gene expression pattern suggests a higher proportion of histones may be produced in bone marrow erythroids. An increase in histone levels and accessibility could enable greater control over erythroid maturation providing more sites for control which could be one contributing reason why the bone marrow takes over the role of erythropoiesis from the liver and into adulthood.</p><p id="P41">In summary, CellDISECT’s flexible fairness enables users to identify and explore gene expression patterning linked to a given category of interest. Without a need to retrain, CellDISECT offers many supervised latent spaces, some of which provide negative controls where the category of interest is regressed out by treating it as a batch covariate. This multifaceted view afforded by CellDISECT enhances data exploration and interpretability relative to other methods.</p></sec></sec></sec><sec id="S16" sec-type="discussion"><title>Discussion</title><p id="P42">CellDISECT represents a significant advancement in single-cell analysis by integrating disentangled representation learning with causal analysis on synthetic training data, and addresses the complexity of multi-batch, multi-covariate data. Its novel architecture and use of synthetic data during training enables covariate-specific latent spaces while retaining the ability to capture biologically meaningful variations. This dual capability not only enhances interpretability but also allows for robust counterfactual predictions, offering a new dimension in single-cell research.</p><p id="P43">Compared to existing methods such as Biolord and scDisInFact, CellDISECT demonstrates superior disentanglement and predictive accuracy, particularly in out-of-distribution scenarios.</p><p id="P44">CellDISECT is able to model both observed and unobserved covariates while maintaining biological relevance, enabling discovery of cell types at enhanced resolution. For instance, its application to the immune atlas uncovered a previously unidentified megakaryocyte subpopulation with immune-like characteristics.</p><p id="P45">Although it has been shown that MK cells can have an immune role in the YS and in adult life, its entire immune repertoire is yet underexplored. We highlight the identification of immune-like MK cells during early human development in the spleen, liver and bone marrow across multiple donors at single cell resolution. Unlike classical platelet-producing MKs, these cells exhibit high expression of immune-related genes, such as FCER1A, ENPP3 and HPGDS, suggesting potential roles in immune modulation, as well as the unique marker SPINK4. This discovery underscores the potential of CellDISECT to unveil novel cell populations.</p><p id="P46">CellDISECT also introduces flexibility in defining biological and batch covariates, addressing a limitation of traditional methods that require such decisions during training. This adaptability makes it a powerful tool for integrating heterogeneous datasets, as demonstrated in its ability to resolve complex tissue-specific and donor-specific patterns in cross-organ single-cell data.</p><p id="P47">Despite its strengths, CellDISECT’s reliance on pre-defined covariates may limit its applicability to datasets with unknown covariate structures. Future developments could explore adding more unsupervised latent spaces for inferring latent variables directly from the data.</p><p id="P48">In conclusion, CellDISECT establishes a new benchmark for single-cell analysis, combining interpretability, biological discovery, and predictive power. Its ability to disentangle and leverage covariates paves the way for deeper insights into cellular heterogeneity and its drivers.</p></sec><sec id="S17" sec-type="methods"><title>Methods</title><sec id="S18"><title>Datasets</title><sec id="S19"><title>Collection and pre-processing</title><p id="P49">The datasets, their count matrices, cell types, and associated metadata in this study were downloaded from the original study or from CellxGene data portals where the authors have submitted them. All the preprocessing steps such as gene filtering, log normalisation and highly variable genes (HVG) selection were performed using scanpy<sup><xref ref-type="bibr" rid="R47">47</xref></sup>) unless stated otherwise.</p><p id="P50"><italic>Eraslan dataset</italic><sup><italic><xref ref-type="bibr" rid="R23">23</xref></italic></sup> was downloaded from CZ CELLxGENE<sup><xref ref-type="bibr" rid="R48">48</xref></sup> and count matrix comprised of 209,126 cells and 32,922 genes. Genes that have at least 3 counts and log-normalised data was used to select 1212 HVGs comprising 1200 HVGs (highly variable genes), and “Toll-like receptor” genes were used in the model.</p><p id="P51"><italic>Kang dataset</italic><sup><italic><xref ref-type="bibr" rid="R25">25</xref></italic></sup> was downloaded from CPA<sup><xref ref-type="bibr" rid="R3">3</xref></sup> tutorials, preprocessed, filtered, and 5000 HVGs were used in the model. The dataset consists of 13576 PBMCs, from eight lupus patients. These blood cells are either untreated or treated using IFN-β stimulation. (7217 stimulated and 6359 control cells)</p><p id="P52"><italic>Haber dataset</italic><sup><italic><xref ref-type="bibr" rid="R26">26</xref></italic></sup> was downloaded from the Pertpy library<sup><xref ref-type="bibr" rid="R45">45</xref></sup> using the command “pertpy.data.haber_2017_regions()”. We filtered the dataset to genes that are expressed in at least 20 cells, log-normalized the counts, and selected 7000 HVGs for training the model. This dataset consists of intestinal epithelial cells of mice, after being subjected to Salmonella (1770 cells) or Heligmosomoides polygyrus (H. poly) infections (2121 after 3 days and 2711 after 10 days), and 3240 control cells.</p><p id="P53"><italic>Suo dataset</italic><sup><italic><xref ref-type="bibr" rid="R18">18</xref></italic></sup> was provided by original authors and then subsetted to retain only good quality cells. Good quality cells were determined by selecting only cells which were used to generate part of the Human_Whole_Embryo/v1 model from CellTypist<sup><xref ref-type="bibr" rid="R46">46</xref></sup>. This model compared cells against multiple other public fetal datasets and is publicly available<sup><xref ref-type="bibr" rid="R46">46</xref></sup>. Original author annotations were then used throughout analysis. The data was log-normalized the counts using Scanpy’s “normalize_total” and “log1p” methods. Finally, we selected the top 8192 HVGs ranked by gene dispersion norm following the same logic as the original publication. As input covariates for CellDISECT to model, we provided donor and chemistry (3GEX/5GEX) matching the original publication, as well as organ.</p></sec><sec id="S20"><title>Splits</title><sec id="S21"><title>Haber dataset</title><p id="P54">We constructed 16 different train/validation/ood splits, and the results are reported as the average of these splits. For each cell type (there are 8 cell types in the dataset), we constructed 2 splits, one with control cells and Salmonella-infected cells being held out, and one with control cells and 10 days H. poly-infected cells being held out (making up to 16 splits). For the counterfactual prediction task in each split, we predict what would the gene expression of the infected (infection corresponding to the split) cells in the corresponding cell type be, given the control cells. Both source and target cells are unseen and out-of-distribution in this case.</p></sec><sec id="S22"><title>Kang dataset</title><p id="P55">To achieve comprehensive benchmarking, we used 8 different train/validation/OOD splits, corresponding to the 8 different cell types in the data where each in each split, all the stimulated cells in the corresponding cell type, are left out as out-of-distribution. Accordingly, in each split (cell type), we predict what the gene expression of the stimulated cells would be, given the control cells in that cell type. These splits were available in the downloaded object from CPA<sup><xref ref-type="bibr" rid="R3">3</xref></sup> tutorials.</p></sec><sec id="S23"><title>Eraslan dataset</title><p id="P56">To do counterfactual predictions and benchmark our method against other methods in different scenarios, we created 3 different splits in the dataset, each with a different Out-Of-Distribution (OOD) set of cells (<xref ref-type="fig" rid="F3">Fig. 3a</xref>).</p><p id="P57">Scenario A: Immune T, NK, and DC/macrophage cells were held out from all male cells across organs, as well as within the lung for male cells to acquire an out-of-distribution set. During the evaluation, we performed counterfactual predictions on “Immune (DC/macrophage)” cells, to predict what the gene expression would be if female cells in the lung were male. Scenario B: This scenario’s OOD cells consist of all the “Epithelial cell (luminal)” cells. Then we performed a double counterfactual prediction, evaluating the methods for predicting what would the gene expression for Epithelial cells in the female breast tissue be, if they were actually male prostate gland cells. Scenario C: In this case, we held out all the male cells in the dataset, and trained solely on female cells. Then, we performed counterfactual prediction, on “ Male” Immune DC/macrophage and alveolar macrophage cells in the anterior wall of the left ventricle, to predict what their gene expression would be if they were the same cells in the lingula of the left lung.</p></sec></sec></sec><sec id="S24"><title>Model</title><sec id="S25"><title>Theoretical Foundations</title><p id="P58">We provide here a brief overview of the theory and architecture of CellDISECT, for more details see <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>. CellDISECT estimates for cell n the conditional distribution, <italic>p</italic>(<italic>x<sub>n</sub></italic> |<italic>s</italic><sub>1<italic>n</italic></sub>, <italic>s</italic><sub>2<italic>n</italic></sub>, …, <italic>s<sub>Cn</sub></italic>) in which <italic>x<sub>n</sub></italic> is the G-dimensional vector of observed RNA counts (G is the total number of genes), and <italic>s</italic><sub>1<italic>n</italic></sub>, …, <italic>s<sub>Cn</sub></italic> are covariate vectors describing information such as batch index of cell, age of donor, tissue, etc. In total there are N cells and C covariates for each cell. This distribution is estimated using a Mixture of C +1 Expert (MoE) VAEs, and C(C +1) MLPs that (de)couple these expert VAEs. In addition to interpretability, and flexible batch correction, this decoupling also offers a straightforward approach to counterfactual prediction as explained in Foster et al. (2022), and we leverage this by training our algorithm to maximize the sum of the likelihood of the observed data and the likelihood of the model’s counterfactual predictions. Throughout the rest of the paper, when we refer to a specific cell or generally the random variable, we will drop the superscript <italic>n</italic>.</p><p id="P59">CellDISECT provides users with a multifaceted view of the data with many different latent spaces and VAEs, each aligned with a different covariate. We get each of these expert VAEs by mathematically marginalizing out all covariates to which we don’t want to align, as shown in the cartoon of <xref ref-type="fig" rid="F1">Figure 1d</xref>.</p><p id="P60">With these specifications the architecture of the encoders and decoders of the model follows mathematically from our structural causal model (SCM), see <xref ref-type="supplementary-material" rid="SD2">Supplementary Figure 17</xref>. This derivation is the content of Proposition 1 which also derives the appropriate ELBO function of our model.</p><p id="P61"><bold>Proposition 1</bold>. The factorization of the SCM in <xref ref-type="fig" rid="F1">figure 1</xref> implies the following evidence lower bound, <disp-formula id="FD1"><mml:math id="M1"><mml:mrow><mml:mi>log</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mi>v</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>∣</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≥</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mi>c</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow><mml:mi>c</mml:mi></mml:munderover><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:msub><mml:mo>[</mml:mo><mml:mrow><mml:mi>log</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo><mml:mo>−</mml:mo><mml:mi>log</mml:mi><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>]</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:msub><mml:mo>[</mml:mo><mml:mrow><mml:mi>log</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>∣</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>]</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>ν</italic> = {<italic>χ</italic><sub><italic>i</italic></sub>, <italic>λ</italic><sub><italic>i</italic></sub> : ∀<italic>i</italic>}. As Proposition 1 shows, CellDISECT has C+1 encoders, <inline-formula><mml:math id="M2"><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula>, which take as input all the covariates and the gene expression; C+1 decoders, <inline-formula><mml:math id="M3"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>∣</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula>, which take as input a latent variable, and all the covariates except for the one corresponding to this latent variable; and C+1 prior encoders, <inline-formula><mml:math id="M4"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula>, to allow more flexibility in learning the prior distributions for the latent variables, which has also been shown to promote identifiability of the latent space variables<sup><xref ref-type="bibr" rid="R49">49</xref></sup>.</p><p id="P62"><italic>Sketch of proof</italic>: We marginalise out all covariates but one and derive an ELBO for the reduced SCM, then average all these ELBOs. For details see <xref ref-type="supplementary-material" rid="SD1">Supplementary note 1</xref>.</p><p id="P63">Our approach to implementing counterfactual predictions in Pearl’s three-step approach is inspired by Foster et al<sup><xref ref-type="bibr" rid="R15">15</xref></sup>, which streamlines it by imposing an orthogonality constraint between latent variables and observed covariates. However, their constraint needs to be generalized to meet the demands of our multi-covariate model. Our proposed generalization is the constraint ∀<italic>i</italic> ≠ <italic>j</italic> : <italic>z<sub>i</sub></italic> ⊥ <italic>s<sub>j</sub></italic>, which demands that different representations are aligned to only one covariate at a time. We then follow the three steps in Pearl’s method of counterfactual prediction<sup><xref ref-type="bibr" rid="R6">6</xref></sup>:</p><list list-type="simple" id="L1"><list-item><label>1)</label><p id="P64">abduction: we infer the value of the root nodes {<italic>z</italic><sub>0</sub>} based on the observations, <italic>p</italic>(<italic>z</italic><sub>0</sub> |<italic>s, x</italic>),</p></list-item><list-item><label>2</label><p id="P65">action: swapping <italic>s<sub>i</sub></italic> for <italic>s<sub>i</sub></italic>', <italic>do</italic>(<italic>s<sub>i</sub></italic> = <italic>s<sub>i</sub></italic>'),</p></list-item><list-item><label>3)</label><p id="P66">prediction, <inline-formula><mml:math id="M5"><mml:mrow><mml:mi>p</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:msubsup><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mo>'</mml:mo></mml:msubsup></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mo>∣</mml:mo><mml:msubsup><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mo>'</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:msub><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></inline-formula></p></list-item></list><p id="P67">The fundamental problem in causal inference is that we have access only to one outcome (termed factual). We never observe the counterfactual outcome, which is defined by the do operations on the causality graph and therefore might not even be identifiable from the observations we actually performed. As we show in proposition 2, in our model, the counterfactual outcome of intervention on any covariate is identifiable by data that has been observed via functions learned by our model during training.</p><p id="P68"><bold>Proposition 2</bold>. The counterfactual (never observed) value of the response variable x due to an intervention <italic>do</italic>(<italic>s<sub>i</sub></italic> = <italic>s<sub>i</sub></italic>') on any covariate i can be identified based on the rules of counterfactual reasoning by observed data and is equal to, <disp-formula id="FD2"><mml:math id="M6"><mml:mrow><mml:mi>P</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:msubsup><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mo>'</mml:mo></mml:msubsup></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mo>∣</mml:mo><mml:msubsup><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mo>'</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:msub><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>P</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mo>'</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:msub><mml:mo>[</mml:mo><mml:mrow><mml:mi>P</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mo>∣</mml:mo><mml:msubsup><mml:mi>S</mml:mi><mml:mi>i</mml:mi><mml:mo>'</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>]</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P69">We notice that the RHS contains only ordinary probabilistic expressions (involving no counterfactuals). Moreover, the distributions <italic>P</italic>(<italic>z<sub>j</sub></italic> |<italic>s<sub>i</sub></italic>, <italic>s</italic><sub>−<italic>i</italic></sub>, <italic>s<sub>i</sub></italic>', <italic>x</italic>) and <inline-formula><mml:math id="M7"><mml:mrow><mml:mi>P</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mo>∣</mml:mo><mml:msubsup><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mo>'</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula> are the j-th encoder and decoder (as derived in proposition 1) respectively, and are learned by CellDISECT during training.</p><p id="P70">The identifiability of counterfactual predictions allows us to use the idea in Wu et al. (2002)<sup><xref ref-type="bibr" rid="R16">16</xref></sup> of semi-autoencoding an algorithm’s counterfactual predictions and jointly maximizing the likelihood of both real data and counterfactuals, log p(x|s) + log p(x'|x, s, s'), where <italic>s</italic>' = <italic>s</italic><sub>−<italic>i</italic></sub> ∪ <italic>s</italic>'<sub><italic>i</italic></sub>. To implement the counterfactual semi-autoencoding we generalize Wu et al. (2022) to the case of multiple conditions.</p><p id="P71">Specifically, before training, we generate counterfactual pairs of cells. Every cell c is paired with all other cells c′ of the same cell type that have at most one covariate different. Let <italic>s<sub>i</sub></italic> be the covariate that differs in the pair (c, c′). Then, during training, we predict counterfactual gene expressions values associated with the new value of <italic>s<sub>i</sub></italic> (one <italic>s<sub>i</sub></italic> at a time) and penalize them in the loss function using negative log-likelihood loss under the learned distributions.</p></sec><sec id="S26"><title>Model Architecture</title><sec id="S27"><title>ENCODERS</title><p id="P72">CellDISECT employs n + 1 encoders, parameterised by ϕ<sub>0</sub>, ϕ <sub>1</sub>, …, ϕ<sub><italic>n</italic></sub>, to independently infer n + 1 latent vectors <italic>z</italic> <sub>0</sub>, <italic>z</italic><sub>1</sub>, …, <italic>z<sub>n</sub></italic>. Each encoder receives the same input: the gene expression vector X and the complete covariate vector s. Additionally, we use n encoders, parameterised by Ψ<sub>0</sub>, Ψ<sub>1</sub>, …, Ψ <sub><italic>n</italic></sub>, to infer n prior distributions for the latent variables. The input to the encoder Ψ consists solely of <italic>s</italic> <sub><italic>k</italic></sub>. For the latent variable <italic>z</italic> <sub><italic>k</italic></sub>, we apply amortised inference <inline-formula><mml:math id="M8"><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>s</mml:mi></mml:mrow><mml:mo>)</mml:mo><mml:mo>~</mml:mo><mml:mi>N</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>μ</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>a</mml:mi><mml:mi>g</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msubsup><mml:mi>g</mml:mi><mml:mi>σ</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula>, where <italic>N</italic>(µ, <italic>σ</italic>) is a Normal distribution of mean μ and variance <italic>σ</italic>. In line with Proposition 1, we infer a prior distribution for <italic>z<sub>k</sub></italic> as: <disp-formula id="FD3"><mml:math id="M9"><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:msub><mml:mi>ψ</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>∣</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo><mml:mo>~</mml:mo><mml:mi>N</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>μ</mml:mi></mml:msub><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo><mml:mo>,</mml:mo><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>a</mml:mi><mml:mi>g</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msubsup><mml:mi>g</mml:mi><mml:mi>σ</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula>
</p></sec><sec id="S28"><title>Decoders</title><p id="P73">We implement n + 1 decoders, parameterised by θ<sub>0</sub>, θ<sub>1</sub>, …, θ<sub><italic>n</italic></sub>, to generate the gene expression vector x within each decoder independently. The input for decoder 0 is (<italic>z</italic> <sub>0</sub>; s), while for the k-th decoder (where <italic>k</italic> ≠ 0), the input is (<italic>z<sub>k</sub></italic> ; <italic>s</italic><sub>−<italic>k</italic></sub>), where <italic>s<sub>–k</sub></italic> refers to all attributes except <italic>s</italic><sub><italic>k</italic></sub>. The rationale behind this setup is to ensure that <italic>z<sub>k</sub></italic> encapsulates all the information in <italic>s<sub>k</sub></italic> but none from <italic>s</italic><sub>−<italic>k</italic></sub>. This architecture enables CellDISECT to learn disentangled representations. Moreover, <italic>z</italic><sub>0</sub> is designed to exclude any information about s, instead learning cell-specific background variation due to unobserved covariates. Using decoder θ <sub><italic>k</italic></sub>, we predict the expression of gene g using a Zero Inflated Negative Binomial (ZINB) distribution, or alternatively a Negative Binomial (NB) distribution, which has been shown to appropriately model gene expression data Lopez et al. (2018). The gene expression for gene g in cell j is given by: <italic>x<sub>g</sub></italic> ~ <italic>NB</italic>(<italic>l f</italic><sup><italic>g</italic></sup>(<italic>z</italic>), <italic>d<sub>g</sub></italic>), where <italic>l</italic> is the observed random variable representing the number of RNA molecules captured for that gene in the cell. f is a function that maps the latent space to the simplex of the gene expression space, and dg is the dispersion parameter of the negative binomial distribution. By default, we use the ZINB distribution in the generative process.</p></sec><sec id="S29"><title>Ablation Study</title><p id="P74">To benchmark the effect of the counterfactual term on CellDISECT’s performance in counterfactual prediction, we used 22 different values in the range [0,10] for the weight for the counterfactual term and trained CellDISECT models on the Blood and Intestine datasets. We then performed predictions for the different scenarios and splits (see above “Splits”) and evaluated the quality of the predictions using our three metrics for counterfactual predictions: EMD, Pearson correlation, and Delta Pearson. Throughout these experiments we kept the values of most of the rest of the weight hyperparameters equal to 1, which is the value they get assigned in the ELBO. The exception was the prior loss term, whose contribution to the total loss was found to be disproportionately large under this uniform scaling, and was therefore assigned a smaller weight of 0.0003. This adjustment was necessary because, with the default prior weight of 0.003, the prior loss term began to dominate the overall loss function – an effect not observed when using the full set of default hyperparameters – and caused premature early stopping – after 5 epochs – before convergence. Importantly, this rescaling does not reflect a change to the model’s default hyperparameter configuration, but rather ensures stability in the context of this specific ablation study, where other weights were set to 1.</p></sec></sec><sec id="S30"><title>Hyperparameter tuning</title><sec id="S31"><title>CellDISECT Hyperparameters</title><p id="P75">To demonstrate the robustness of our method in various tasks, use cases, and datasets, we used the same set of hyperparameters for our experiments across all datasets. We are using encoders/decoders with 2 layers each, 128 hidden neurons, latent dimension 32 for Z<sub>i</sub> for all i, a dropout rate of 0.1, a learning rate of 0.003, weight decay of 0.00005, and the Adam optimizer.</p><p id="P76">Biolord hyperparameters: We used the proposed hyperparameters in Biolord’s tutorials and documentations, with two changes after discussions with the method’s authors: first, decreasing the early stopping patience due to the observation of extreme overfitting on the training data in some cases, and second using the “ nb” distribution instead of “ normal” to acquire counts for better comparison with scDisInFact and CellDISECT.</p><p id="P77">scDisInfact hyperparameters: We used the proposed learning hyperparameters in scDisInfact’s tutorials and documentation, while increasing the size of the latent dimensions from 8 and 2, to 40 and 10 for the shared and unshared latents respectively, as well as increasing the maximum training epochs to give the model more time and flexibility to learn. These changes were decided and made to keep the comparison fair, due to the observation of scDisInFact achieving better results in the benchmarking using the increased dimensions and epochs.</p></sec><sec id="S32"><title>Choice of DEGs in benchmarking</title><p id="P78">For each of the counterfactual prediction scenarios, we performed a curated computation process to determine the top differentially expressed genes that mark the difference between control and target cells. We used Scanpy’s rank_genes_groups function with the Wilcoxon method to find these genes, within each cell type, between the control and target cells. We ranked these genes by the absolute value of their log fold-change values and took the top 20 DEGs from this ranking to perform evaluations specified for each task and scenario, on all models.</p></sec></sec><sec id="S33"><title>Counterfactual training when cell type is not provided</title><p id="P79">In scenarios where cell type annotations are unavailable, unreliable, or undesired (such as our analysis on the Cross-Organ dataset) CellDISECT is designed to learn and contain the cell type effects as an unobserved covariate within the latent spaces (<xref ref-type="fig" rid="F2">Fig. 2A, B</xref>). This flexibility facilitates exploratory analyses, but introduces a challenge to generating the counterfactual pairs for the evaluation of the counterfactual term. Since there is no cell type annotation given to CellDISECT, counterfactual training which involves pairing cells at random to generate predictions, may pair cells from distinct cell types, which could lead to model collapse. To address this challenge, we implement a preprocessing and augmentation strategy for scenarios where the cell type information is not provided as a seen covariate. Prior to training, Leiden clustering is applied to the PCA-transformed gene expression profiles, partitioning cells into clusters that serve as proxies for cell type groupings. During counterfactual training, cell pairs are sampled exclusively from within the same cluster, ensuring that the counterfactual predictions involve biologically similar cells. This approach prevents the model from encountering mismatched cell types, thereby preserving its capacity to capture cell type-specific information while training.</p></sec></sec><sec id="S34"><title>Model assessment</title><sec id="S35"><title>Metrics</title><p id="P80">Disentanglement:</p><p id="P81">We assess the disentanglement capabilities of the methods using two key metrics. For the first metric, we apply the widely used scIB metrics to evaluate how effectively each latent space preserves its relevant covariate information (biological conservation) while minimizing information related to noise covariates (batch correction).</p><p id="P82">For the second disentanglement metric, we introduce concatMIG, a variation of the Mutual Information Gap (MIG) metric originally developed by Chen et al. (2018). concatMIG assesses the disentanglement of a covariate from all latent dimensions (spaces) except its corresponding one. To compute this, we compute the difference of the mutual information between each latent and its covariate, minus the mutual information between the concatenated remaining latents and that covariate. concatMIG reports the average of those differences across covariate, <disp-formula id="FD4"><mml:math id="M10"><mml:mrow><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>n</mml:mi><mml:mi>c</mml:mi><mml:mi>a</mml:mi><mml:mi>t</mml:mi><mml:mi>M</mml:mi><mml:mi>I</mml:mi><mml:mi>G</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>Z</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>;</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>n</mml:mi></mml:mfrac><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:munderover><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mi>H</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mfrac><mml:mo>[</mml:mo><mml:mrow><mml:mi>M</mml:mi><mml:mi>I</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo><mml:mo>−</mml:mo><mml:mi>M</mml:mi><mml:mi>I</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>]</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P83">By design, concatMIG can yield negative values; for example, when the non-age latent spaces together contain more information about age than the age-specific latent space does.</p><p id="P84">Counterfactual Prediction:</p><p id="P85">To evaluate and report the counterfactual gene expression prediction abilities of each model, we utilized three different metrics once on all the genes the models were trained on, and once only on the top 20 DEGs (chosen as explained above).</p><list list-type="order" id="L2"><list-item><p id="P86">Pearson correlation,</p></list-item><list-item><p id="P87">Delta Pearson Correlation (Pearson correlation between the difference of true minus control expressions and the difference of predicted minus control expressions),</p></list-item><list-item><p id="P88">Earth Mover’s Distance.</p></list-item></list></sec></sec></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary Note 1</label><media xlink:href="EMS206282-supplement-Supplementary_Note_1.pdf" mimetype="application" mime-subtype="pdf" id="d26aAcEbB" position="anchor"/></supplementary-material><supplementary-material content-type="local-data" id="SD2"><label>Supplementary Figures</label><media xlink:href="EMS206282-supplement-Supplementary_Figures.pdf" mimetype="application" mime-subtype="pdf" id="d26aAcEcB" position="anchor"/></supplementary-material></sec></body><back><ack id="S36"><title>Acknowledgments</title><p>We would like to thank Dr. Arash Mehrjou for helpful feedback and discussions. This work was made possible in part by the Wellcome Trust (220540/Z/20/A) and the Accelerate program for Scientific Discovery. M.H. is funded by Wellcome (WT107931/Z/15/Z, WT223092/Z/21/Z, WT206194, and WT220540/Z/20/A), the Lister Institute for Preventive Medicine, and NIHR and Newcastle Biomedical Research Centre. The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript. Figure cartoons were created with <ext-link ext-link-type="uri" xlink:href="http://BioRender.com">BioRender.com</ext-link>.</p></ack><sec id="S37" sec-type="data-availability"><title>Data Availability</title><p id="P89">The real data can be downloaded from the links. We downloaded the annotated dataset<sup><xref ref-type="bibr" rid="R23">23</xref></sup> in h5ad format from the CZI CELLxGENE dataset hub<sup><xref ref-type="bibr" rid="R44">44</xref></sup>. The blood dataset<sup><xref ref-type="bibr" rid="R25">25</xref></sup> was downloaded and obtained from CPA<sup><xref ref-type="bibr" rid="R3">3</xref></sup> tutorials. The anndata object for the mouse intestine dataset<sup><xref ref-type="bibr" rid="R26">26</xref></sup> was obtained using the Pertpy library<sup><xref ref-type="bibr" rid="R45">45</xref></sup>. The dataset for the developing immune system<sup><xref ref-type="bibr" rid="R18">18</xref></sup> was provided by the original authors but is also publicly available<sup><xref ref-type="bibr" rid="R46">46</xref></sup>.</p></sec><sec id="S38" sec-type="data-availability"><title>Code Availability</title><p id="P90">Our source code for the method is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/Lotfollahi-lab/CellDISECT">https://github.com/Lotfollahi-lab/CellDISECT</ext-link> and the code for reproducing the results of our experiments is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/stathismegas/CellDISECT_reproducibility">https://github.com/stathismegas/CellDISECT_reproducibility</ext-link>.</p></sec><fn-group><fn fn-type="con" id="FN1"><p id="P91"><bold>Author Contributions</bold></p><p id="P92">S.M. conceived the theory of the model and the perturbation modeling, implemented it in code and as a GitHub package, and wrote and edited the manuscript. A.A. performed the benchmarking on simulations and real data, applied the model on the immune atlas, improved the code implementation and documentation, and helped edit the manuscript. A.R. led the biological interpretation of the results on the immune atlas and helped edit the manuscript. O.D. performed literature research for gene markers and helped edit the manuscript. K.S. wrote parts of the code in the early stages of the project. H.A. implemented the continuous embedding of the categorical covariates. K.P. helped create conda environments for the project. M.H. provided key biological interpretation, and supervised the project. S.A.T. provided key biological interpretation, and supervised the project. M.L. conceived the idea of disentangled representations in single-cell data and of a model that provides multiple latent spaces for each covariate, and supervised the project.</p></fn><fn fn-type="conflict" id="FN2"><p id="P93"><bold>Competing Interests</bold></p><p id="P94">In the past three years, S.A.T. has received remuneration for scientific advisory board membership from Sanofi, GlaxoSmithKline, Foresite Labs and Qiagen. S.A.T. is a co-founder and holds equity in Transition Bio and Ensocell. From January 8th of 2024, S.A.T. is a part-time employee of GlaxoSmithKline. The remaining authors declare no competing interests. M.L. consults and owns interests in Relation Therapeutics and is a scientific cofounder and part-time employee at AIVIVO.</p></fn></fn-group><ref-list><ref id="R1"><label>1</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Klein</surname><given-names>AM</given-names></name><etal/></person-group><article-title>Droplet barcoding for single-cell transcriptomics applied to embryonic stem cells</article-title><source>Cell</source><year>2015</year><volume>161</volume><fpage>1187</fpage><lpage>1201</lpage><pub-id pub-id-type="pmcid">PMC4441768</pub-id><pub-id pub-id-type="pmid">26000487</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2015.04.044</pub-id></element-citation></ref><ref id="R2"><label>2</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Macosko</surname><given-names>EZ</given-names></name><etal/></person-group><article-title>Highly Parallel Genome-wide Expression Profiling of Individual Cells Using Nanoliter Droplets</article-title><source>Cell</source><year>2015</year><volume>161</volume><fpage>1202</fpage><lpage>1214</lpage><pub-id pub-id-type="pmcid">PMC4481139</pub-id><pub-id pub-id-type="pmid">26000488</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2015.05.002</pub-id></element-citation></ref><ref id="R3"><label>3</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lotfollahi</surname><given-names>M</given-names></name><etal/></person-group><article-title>Predicting cellular responses to complex perturbations in high-throughput screens</article-title><source>Mol Syst Biol</source><year>2023</year><volume>19</volume><elocation-id>e11517</elocation-id><pub-id pub-id-type="pmcid">PMC10258562</pub-id><pub-id pub-id-type="pmid">37154091</pub-id><pub-id pub-id-type="doi">10.15252/msb.202211517</pub-id></element-citation></ref><ref id="R4"><label>4</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>X</given-names></name><name><surname>Chen</surname><given-names>H</given-names></name><name><surname>Tang</surname><given-names>S</given-names></name><name><surname>Wu</surname><given-names>Z</given-names></name><name><surname>Zhu</surname><given-names>W</given-names></name></person-group><article-title>Disentangled Representation Learning</article-title><source>IEEE Trans Pattern Anal Mach Intell</source><year>2024</year><volume>46</volume><fpage>9677</fpage><lpage>9696</lpage><pub-id pub-id-type="pmid">38949944</pub-id></element-citation></ref><ref id="R5"><label>5</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>RTQ</given-names></name><name><surname>Li</surname><given-names>X</given-names></name><name><surname>Grosse</surname><given-names>R</given-names></name><name><surname>Duvenaud</surname><given-names>D</given-names></name></person-group><article-title>Isolating sources of disentanglement in variational autoencoders</article-title><source>arXiv [csLG]</source><year>2018</year></element-citation></ref><ref id="R6"><label>6</label><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Pearl</surname><given-names>J</given-names></name></person-group><source>Causality</source><publisher-name>Cambridge University Press</publisher-name><year>2009</year></element-citation></ref><ref id="R7"><label>7</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Feuerriegel</surname><given-names>S</given-names></name><etal/></person-group><article-title>Causal machine learning for predicting treatment outcomes</article-title><source>Nat Med</source><year>2024</year><volume>30</volume><fpage>958</fpage><lpage>968</lpage><pub-id pub-id-type="pmid">38641741</pub-id></element-citation></ref><ref id="R8"><label>8</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>R</given-names></name><etal/></person-group><article-title>Best practices and lessons learned on synthetic data for language models</article-title><source>ArXiv</source><year>2024</year><comment>abs/2404.07503</comment></element-citation></ref><ref id="R9"><label>9</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>van Breugel</surname><given-names>B</given-names></name><name><surname>van der Schaar</surname><given-names>M</given-names></name></person-group><article-title>Beyond privacy: Navigating the opportunities and challenges of synthetic data</article-title><source>arXiv [csLG]</source><year>2023</year></element-citation></ref><ref id="R10"><label>10</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>DeepSeek-AI</surname></name><etal/></person-group><article-title>DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning</article-title><source>arXiv [csCL]</source><year>2025</year></element-citation></ref><ref id="R11"><label>11</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shumailov</surname><given-names>I</given-names></name><etal/></person-group><article-title>AI models collapse when trained on recursively generated data</article-title><source>Nature</source><year>2024</year><volume>631</volume><fpage>755</fpage><lpage>759</lpage><pub-id pub-id-type="pmcid">PMC11269175</pub-id><pub-id pub-id-type="pmid">39048682</pub-id><pub-id pub-id-type="doi">10.1038/s41586-024-07566-y</pub-id></element-citation></ref><ref id="R12"><label>12</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dohmatob</surname><given-names>E</given-names></name><name><surname>Feng</surname><given-names>Y</given-names></name><name><surname>Subramonian</surname><given-names>A</given-names></name><name><surname>Kempe</surname><given-names>J</given-names></name></person-group><article-title>Strong model collapse</article-title><source>arXiv [csLG]</source><year>2024</year></element-citation></ref><ref id="R13"><label>13</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Piran</surname><given-names>Z</given-names></name><name><surname>Cohen</surname><given-names>N</given-names></name><name><surname>Hoshen</surname><given-names>Y</given-names></name><name><surname>Nitzan</surname><given-names>M</given-names></name></person-group><article-title>Disentanglement of single-cell data with biolord</article-title><source>Nat Biotechnol</source><year>2024</year><volume>42</volume><fpage>1678</fpage><lpage>1683</lpage><pub-id pub-id-type="pmcid">PMC11554562</pub-id><pub-id pub-id-type="pmid">38225466</pub-id><pub-id pub-id-type="doi">10.1038/s41587-023-02079-x</pub-id></element-citation></ref><ref id="R14"><label>14</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>Z</given-names></name><name><surname>Zhao</surname><given-names>X</given-names></name><name><surname>Bindra</surname><given-names>M</given-names></name><name><surname>Qiu</surname><given-names>P</given-names></name><name><surname>Zhang</surname><given-names>X</given-names></name></person-group><article-title>scDisInFact: disentangled learning for integration and prediction of multi-batch multi-condition single-cell RNA-sequencing data</article-title><source>Nat Commun</source><year>2024</year><volume>15</volume><fpage>912</fpage><pub-id pub-id-type="pmcid">PMC10827746</pub-id><pub-id pub-id-type="pmid">38291052</pub-id><pub-id pub-id-type="doi">10.1038/s41467-024-45227-w</pub-id></element-citation></ref><ref id="R15"><label>15</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Foster</surname><given-names>A</given-names></name><etal/></person-group><article-title>Contrastive Mixture of posteriors for counterfactual inference, data integration and fairness</article-title><source>arXiv [statML]</source><year>2021</year></element-citation></ref><ref id="R16"><label>16</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wu</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Variational Causal Inference</article-title><source>arXiv [statML]</source><year>2022</year></element-citation></ref><ref id="R17"><label>17</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Weinberger</surname><given-names>E</given-names></name><name><surname>Lin</surname><given-names>C</given-names></name><name><surname>Lee</surname><given-names>SI</given-names></name></person-group><article-title>Isolating salient variations of interest in single-cell data with contrastiveVI</article-title><source>Nat Methods</source><year>2023</year><volume>20</volume><fpage>1336</fpage><lpage>1345</lpage><pub-id pub-id-type="pmid">37550579</pub-id></element-citation></ref><ref id="R18"><label>18</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Suo</surname><given-names>C</given-names></name><etal/></person-group><article-title>Mapping the developing human immune system across organs</article-title><source>Science</source><year>2022</year><pub-id pub-id-type="pmcid">PMC7612819</pub-id><pub-id pub-id-type="pmid">35549310</pub-id><pub-id pub-id-type="doi">10.1126/science.abo0510</pub-id></element-citation></ref><ref id="R19"><label>19</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>H</given-names></name><etal/></person-group><article-title>Decoding human megakaryocyte development</article-title><source>Cell Stem Cell</source><year>2021</year><volume>28</volume><fpage>535</fpage><lpage>549</lpage><elocation-id>e8</elocation-id><pub-id pub-id-type="pmid">33340451</pub-id></element-citation></ref><ref id="R20"><label>20</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kingma</surname><given-names>DP</given-names></name><name><surname>Welling</surname><given-names>M</given-names></name></person-group><source>An Introduction to Variational Autoencoders</source><year>2019</year></element-citation></ref><ref id="R21"><label>21</label><element-citation publication-type="confproc"><person-group person-group-type="author"><name><surname>Creager</surname><given-names>E</given-names></name><etal/></person-group><source>Flexibly Fair Representation Learning by Disentanglement</source><conf-name>International Conference on Machine Learning</conf-name><conf-sponsor>PMLR</conf-sponsor><year>2019</year><fpage>1436</fpage><lpage>1445</lpage></element-citation></ref><ref id="R22"><label>22</label><element-citation publication-type="web"><collab>Website</collab><comment><ext-link ext-link-type="uri" xlink:href="https://github.com/Lotfollahi-lab/CellDISECT">https://github.com/Lotfollahi-lab/CellDISECT</ext-link></comment></element-citation></ref><ref id="R23"><label>23</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Eraslan</surname><given-names>G</given-names></name><etal/></person-group><article-title>Single-nucleus cross-tissue molecular reference maps toward understanding disease gene function</article-title><source>Science</source><year>2022</year><volume>376</volume><elocation-id>eabl4290</elocation-id><pub-id pub-id-type="pmcid">PMC9383269</pub-id><pub-id pub-id-type="pmid">35549429</pub-id><pub-id pub-id-type="doi">10.1126/science.abl4290</pub-id></element-citation></ref><ref id="R24"><label>24</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luecken</surname><given-names>MD</given-names></name><etal/></person-group><article-title>Benchmarking atlas-level data integration in single-cell genomics</article-title><source>Nat Methods</source><year>2022</year><volume>19</volume><fpage>41</fpage><lpage>50</lpage><pub-id pub-id-type="pmcid">PMC8748196</pub-id><pub-id pub-id-type="pmid">34949812</pub-id><pub-id pub-id-type="doi">10.1038/s41592-021-01336-8</pub-id></element-citation></ref><ref id="R25"><label>25</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kang</surname><given-names>HM</given-names></name><etal/></person-group><article-title>Multiplexed droplet single-cell RNA-sequencing using natural genetic variation</article-title><source>Nature Biotechnology</source><year>2017</year><volume>36</volume><fpage>89</fpage><lpage>94</lpage><pub-id pub-id-type="pmcid">PMC5784859</pub-id><pub-id pub-id-type="pmid">29227470</pub-id><pub-id pub-id-type="doi">10.1038/nbt.4042</pub-id></element-citation></ref><ref id="R26"><label>26</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Haber</surname><given-names>AL</given-names></name><etal/></person-group><article-title>A single-cell survey of the small intestinal epithelium</article-title><source>Nature</source><year>2017</year><volume>551</volume><fpage>333</fpage><lpage>339</lpage><pub-id pub-id-type="pmcid">PMC6022292</pub-id><pub-id pub-id-type="pmid">29144463</pub-id><pub-id pub-id-type="doi">10.1038/nature24489</pub-id></element-citation></ref><ref id="R27"><label>27</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Heumos</surname><given-names>L</given-names></name><etal/></person-group><article-title>Best practices for single-cell analysis across modalities</article-title><source>Nat Rev Genet</source><year>2023</year><volume>24</volume><fpage>550</fpage><lpage>572</lpage><pub-id pub-id-type="pmcid">PMC10066026</pub-id><pub-id pub-id-type="pmid">37002403</pub-id><pub-id pub-id-type="doi">10.1038/s41576-023-00586-w</pub-id></element-citation></ref><ref id="R28"><label>28</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cui</surname><given-names>H</given-names></name><etal/></person-group><article-title>scGPT: toward building a foundation model for single-cell multi-omics using generative AI</article-title><source>Nat Methods</source><year>2024</year><volume>21</volume><fpage>1470</fpage><lpage>1480</lpage><pub-id pub-id-type="pmid">38409223</pub-id></element-citation></ref><ref id="R29"><label>29</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Vitrat</surname><given-names>N</given-names></name><etal/></person-group><article-title>Endomitosis of human megakaryocytes are due to abortive mitosis</article-title><source>Blood</source><year>1998</year><volume>91</volume><pub-id pub-id-type="pmid">9573008</pub-id></element-citation></ref><ref id="R30"><label>30</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>C</given-names></name><etal/></person-group><article-title>Characterization of Cellular Heterogeneity and an Immune Subpopulation of Human Megakaryocytes</article-title><source>Advanced Science</source><year>2021</year><volume>8</volume><elocation-id>2100921</elocation-id><pub-id pub-id-type="pmcid">PMC8336508</pub-id><pub-id pub-id-type="pmid">34042332</pub-id><pub-id pub-id-type="doi">10.1002/advs.202100921</pub-id></element-citation></ref><ref id="R31"><label>31</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pariser</surname><given-names>DN</given-names></name><etal/></person-group><article-title>Lung megakaryocytes are immune modulatory cells</article-title><source>The Journal of Clinical Investigation</source><year>2021</year><volume>131</volume><elocation-id>e137377</elocation-id><pub-id pub-id-type="pmcid">PMC7773372</pub-id><pub-id pub-id-type="pmid">33079726</pub-id><pub-id pub-id-type="doi">10.1172/JCI137377</pub-id></element-citation></ref><ref id="R32"><label>32</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hart</surname><given-names>A</given-names></name><etal/></person-group><article-title>Fli-1 is required for murine vascular and megakaryocytic development and is hemizygously deleted in patients with thrombocytopenia</article-title><source>Immunity</source><year>2000</year><volume>13</volume><fpage>167</fpage><lpage>177</lpage><pub-id pub-id-type="pmid">10981960</pub-id></element-citation></ref><ref id="R33"><label>33</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Doré</surname><given-names>LC</given-names></name><name><surname>Crispino</surname><given-names>JD</given-names></name></person-group><article-title>Transcription factor networks in erythroid cell and megakaryocyte development</article-title><source>Blood</source><year>2011</year><volume>118</volume><fpage>231</fpage><lpage>239</lpage><pub-id pub-id-type="pmcid">PMC3138678</pub-id><pub-id pub-id-type="pmid">21622645</pub-id><pub-id pub-id-type="doi">10.1182/blood-2011-04-285981</pub-id></element-citation></ref><ref id="R34"><label>34</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Psaila</surname><given-names>B</given-names></name><etal/></person-group><article-title>Single-Cell Analyses Reveal Megakaryocyte-Biased Hematopoiesis in Myelofibrosis and Identify Mutant Clone-Specific Targets</article-title><source>Mol Cell</source><year>2020</year><volume>78</volume><fpage>477</fpage><lpage>492</lpage><elocation-id>e8</elocation-id><pub-id pub-id-type="pmcid">PMC7217381</pub-id><pub-id pub-id-type="pmid">32386542</pub-id><pub-id pub-id-type="doi">10.1016/j.molcel.2020.04.008</pub-id></element-citation></ref><ref id="R35"><label>35</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bühring</surname><given-names>HJ</given-names></name><etal/></person-group><article-title>The basophil activation marker defined by antibody 97A6 is identical to the ectonucleotide pyrophosphatase/phosphodiesterase 3</article-title><source>Blood</source><year>2001</year><volume>97</volume><fpage>3303</fpage><lpage>3305</lpage><pub-id pub-id-type="pmid">11342463</pub-id></element-citation></ref><ref id="R36"><label>36</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tsai</surname><given-names>SH</given-names></name><etal/></person-group><article-title>The ectoenzyme E-NPP3 negatively regulates ATP-dependent chronic allergic responses by basophils and mast cells</article-title><source>Immunity</source><year>2015</year><volume>42</volume><fpage>279</fpage><lpage>293</lpage><pub-id pub-id-type="pmid">25692702</pub-id></element-citation></ref><ref id="R37"><label>37</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Krystel-Whittemore</surname><given-names>M</given-names></name><name><surname>Dileepan</surname><given-names>KN</given-names></name><name><surname>Wood</surname><given-names>JG</given-names></name></person-group><article-title>Mast Cell: A Multi-Functional Master Cell</article-title><source>Front Immunol</source><year>2015</year><volume>6</volume><fpage>620</fpage><pub-id pub-id-type="pmcid">PMC4701915</pub-id><pub-id pub-id-type="pmid">26779180</pub-id><pub-id pub-id-type="doi">10.3389/fimmu.2015.00620</pub-id></element-citation></ref><ref id="R38"><label>38</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Anbazhagan</surname><given-names>M</given-names></name><etal/></person-group><article-title>PTGER4 signaling regulates class IIa HDAC function and SPINK4 mRNA levels in rectal epithelial cells</article-title><source>Cell Commun Signal</source><year>2024</year><volume>22</volume><fpage>493</fpage><pub-id pub-id-type="pmcid">PMC11472582</pub-id><pub-id pub-id-type="pmid">39396982</pub-id><pub-id pub-id-type="doi">10.1186/s12964-024-01879-1</pub-id></element-citation></ref><ref id="R39"><label>39</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hu</surname><given-names>BL</given-names></name><name><surname>Yin</surname><given-names>YX</given-names></name><name><surname>Li</surname><given-names>KZ</given-names></name><name><surname>Li</surname><given-names>SQ</given-names></name><name><surname>Li</surname><given-names>Z</given-names></name></person-group><article-title>SPINK4 promotes colorectal cancer cell proliferation and inhibits ferroptosis</article-title><source>BMC Gastroenterol</source><year>2023</year><volume>23</volume><fpage>104</fpage><pub-id pub-id-type="pmcid">PMC10071753</pub-id><pub-id pub-id-type="pmid">37013514</pub-id><pub-id pub-id-type="doi">10.1186/s12876-023-02734-2</pub-id></element-citation></ref><ref id="R40"><label>40</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Therapeutic potential of the secreted Kazal-type serine protease inhibitor SPINK4 in colitis</article-title><source>Nat Commun</source><year>2024</year><volume>15</volume><fpage>5874</fpage><pub-id pub-id-type="pmcid">PMC11245600</pub-id><pub-id pub-id-type="pmid">38997284</pub-id><pub-id pub-id-type="doi">10.1038/s41467-024-50048-y</pub-id></element-citation></ref><ref id="R41"><label>41</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wells</surname><given-names>M</given-names></name><name><surname>Steiner</surname><given-names>L</given-names></name></person-group><article-title>Epigenetic and Transcriptional Control of Erythropoiesis</article-title><source>Front Genet</source><year>2022</year><volume>13</volume><elocation-id>805265</elocation-id><pub-id pub-id-type="pmcid">PMC8940284</pub-id><pub-id pub-id-type="pmid">35330735</pub-id><pub-id pub-id-type="doi">10.3389/fgene.2022.805265</pub-id></element-citation></ref><ref id="R42"><label>42</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhao</surname><given-names>B</given-names></name><name><surname>Yang</surname><given-names>J</given-names></name><name><surname>Ji</surname><given-names>P</given-names></name></person-group><article-title>Chromatin condensation during terminal erythropoiesis</article-title><source>Nucleus</source><year>2016</year><volume>7</volume><fpage>425</fpage><lpage>429</lpage><pub-id pub-id-type="pmcid">PMC5120594</pub-id><pub-id pub-id-type="pmid">27579498</pub-id><pub-id pub-id-type="doi">10.1080/19491034.2016.1226717</pub-id></element-citation></ref><ref id="R43"><label>43</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wong</surname><given-names>P</given-names></name><etal/></person-group><article-title>Gene induction and repression during terminal erythropoiesis are mediated by distinct epigenetic changes</article-title><source>Blood</source><year>2011</year><volume>118</volume><fpage>e128</fpage><lpage>38</lpage><pub-id pub-id-type="pmcid">PMC3204918</pub-id><pub-id pub-id-type="pmid">21860024</pub-id><pub-id pub-id-type="doi">10.1182/blood-2011-03-341404</pub-id></element-citation></ref><ref id="R44"><label>44</label><element-citation publication-type="web"><source>Cellxgene Data Portal</source><comment><ext-link ext-link-type="uri" xlink:href="https://cellxgene.cziscience.com/">https://cellxgene.cziscience.com/</ext-link></comment></element-citation></ref><ref id="R45"><label>45</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Heumos</surname><given-names>L</given-names></name><etal/></person-group><article-title>Pertpy: an end-to-end framework for perturbation analysis</article-title><source>bioRxiv</source><year>2024</year><pub-id pub-id-type="doi">10.1101/2024.08.04.606516</pub-id></element-citation></ref><ref id="R46"><label>46</label><element-citation publication-type="web"><collab>Website</collab><comment><ext-link ext-link-type="uri" xlink:href="https://www.celltypist.org/encyclopedia/Human_Whole_Embryo/v1">https://www.celltypist.org/encyclopedia/Human_Whole_Embryo/v1</ext-link></comment></element-citation></ref><ref id="R47"><label>47</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolf</surname><given-names>FA</given-names></name><name><surname>Angerer</surname><given-names>P</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title><source>Genome Biology</source><year>2018</year><volume>19</volume><fpage>1</fpage><lpage>5</lpage><pub-id pub-id-type="pmcid">PMC5802054</pub-id><pub-id pub-id-type="pmid">29409532</pub-id><pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id></element-citation></ref><ref id="R48"><label>48</label><element-citation publication-type="web"><source>Cellxgene Data Portal</source><comment><ext-link ext-link-type="uri" xlink:href="https://cellxgene.cziscience.com/">https://cellxgene.cziscience.com/</ext-link></comment></element-citation></ref><ref id="R49"><label>49</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Khemakhem</surname><given-names>I</given-names></name><name><surname>Kingma</surname><given-names>DP</given-names></name><name><surname>Monti</surname><given-names>RP</given-names></name><name><surname>Hyvärinen</surname><given-names>A</given-names></name></person-group><article-title>Variational Autoencoders and Nonlinear ICA: A Unifying Framework</article-title><source>arXiv [statML]</source><year>2019</year></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Figure 1</label><caption><title>CellDISECT overall architecture to disentangle biological covariates and enable counterfactual predictions.</title><p>a) CellDISECT provides a multi-facetted interpretation of multi-condition, multi-batch datasets by capturing effects of covariates such as cell type, tissue, sex and age on each cells expression profile. b) CellDISECT is a mixture of expert variational autoencoders (VAEs), one for each covariate plus a VAE for unobserved covariates. Each VAE learns a latent space aligned to its associated covariate but also captures the underlying biology. c) Using a structural causal model, we can generate counterfactual profiles for single-cell data by changing one or more of the values of the covariates. d) A cartoon that explains the mathematical foundation of our method. Our latent spaces are defined by the causal model on the left-hand side, where x is the observed gene expression, S are the observed covariates, and Z are the latent variables. Each expert VAE is derived from this causal model by integrating out a different set of the latent variables and auxiliary neural networks are added to disentangle them.</p></caption><graphic xlink:href="EMS206282-f001"/></fig><fig id="F2" position="float"><label>Figure 2</label><caption><title>CellDISECT captures covariate-specific information in complex single-cell studies</title><p>a) UMAP visualizations of covariate-supervised and unsupervised latent spaces by CellDISECT, Biolord, and scDisInFact on a cross-tissue multi-donor atlas<sup><xref ref-type="bibr" rid="R23">23</xref></sup>. The supervised cell embeddings in Biolord and scDisInFact only capture the covariate information and are analogous to covariate embeddings. In contrast, CellDISECT provides cell embeddings that can reveal more cell type specificity. b) UMAP visualization of the latent space Z<sub>Tissue</sub> colored by tissue (left) and magnified portion of mucosa colored by cell type (right). The magnified portion highlights CellDISECT’s ability to distinguish cell types in all its latent spaces even when cell type information is not provided to the model, thereby offering a multifaceted view of the data. c) scIB metrics are used to evaluate the performance of methods in data integration. Here we report for three different methods the average scores of scIB metrics over all given covariates in their respective latent space.</p></caption><graphic xlink:href="EMS206282-f002"/></fig><fig id="F3" position="float"><label>Figure 3</label><caption><title>Benchmarks on modelling and disentangling cell type specific response to inflammation, disease and tissue perturbations</title><p>a) Illustration of counterfactual prediction scenarios for 3 different datasets used to benchmark our method (for details see <xref ref-type="sec" rid="S17">Methods section</xref>). b) Aggregation of 3 different metrics and their average to evaluate counterfactual prediction capabilities for the top 20 differentially expressed genes. The reported Pearson correlation is between in-silico perturbed and in-vivo perturbed cells across genes. The Delta Pearson reported is the correlation between in-silico perturbed and in-vivo perturbed after the unperturbed gene expression profile has been subtracted from both. The Earth Mover’s Distance (EMD) is the average of distances between in-silico perturbed and in-vivo perturbed cells in gene space. To have all metrics be such that higher value is better prediction, we plot here 1-EMD, instead of EMD (for details see <xref ref-type="sec" rid="S17">Methods section</xref>). c) Aggregation of 3 different metrics and their average to evaluate counterfactual prediction capabilities for all genes. d) UMAP representations of the latent spaces obtained from Kang et al. offer a visualization of CellDISECT’s disentanglement abilities. Each latent space has been aligned to its supervising covariate as evidenced by the disentangled UMAPs along the main diagonal, but is agnostic to the other covariate. We also observe that the unsupervised covariate space uncovered a “ lineage” covariate and has separated the cell according to their lymphoid or myeloid lineages. e) Disentanglement comparison of CellDISECT and other models, over 3 different datasets using a novel information theoretic measure, called Concatenated Mutual Information Gap (concatMIG), that captures how much more information a latent space has about its supervising covariate than all the other covariates combined. Higher concatMIG value indicates higher disentanglement. f) Disentanglement comparison of CellDISECT and other models using biologically motivated metrics. We report the integration metrics computed using scIB averaged over all latents of all datasets. g) CellDISECT performance on counterfactual predictions at test time on our counterfactual scenarios for the blood and intestine datasets. The y-axis includes three different metrics: Earth-Movers-Distance (EMD) – where lower is better –, Pearson correlation and Delta Pearson correlation and we report the average of these metrics across datasets, counterfactual scenarios, and gene sets. The x-axis shows the value of the coefficient multiplying the counterfactual term, which is a hyperparameter of our model.</p></caption><graphic xlink:href="EMS206282-f003"/></fig><fig id="F4" position="float"><label>Figure 4</label><caption><title>CellDISECT identifies a non-classical megakaryocyte subpopulation</title><p>a) Schematic application of CellDISECT on the 9 organ developing immune system atlas<sup><xref ref-type="bibr" rid="R18">18</xref></sup> and UMAP visualization of the megakaryocyte-erythroid-mast (MEM) lineage in CellDISECT’s unsupervised latent space, <italic>Z</italic> <sub>0</sub>. The UMAP is colored by Leiden clustering in CellDISECT’s <italic>Z</italic><sub>0</sub> latent space identifies a (non-classical) hematopoietic subpopulation annotated as an early megakaryocyte in the original publication<sup><xref ref-type="bibr" rid="R18">18</xref></sup> but distinct from other cells annotated as early megakaryocytes. c) Connectivity analysis of the latent manifold using PAGA reveals the new population to be located close to MEP and early MK populations. d) Trajectory analysis using sc-velo shows that the non-classical MK subpopulation is moving away from MEM but not in the direction of platelet or granulocyte differentiation. E) Dotplot of clusters as originally annotated<sup><xref ref-type="bibr" rid="R18">18</xref></sup> against relevant gene markers. The non-classical (SPINK4+) subpopulation expresses known transcription factors active in MK cells, such as FLI-1, but also TFs and gene markers active in mast cells, such as MITF, HPGD, HPGDS, and does not express THBS1 and has reduced expression of PF4 which are known markers that drive differentiation into platelets. It also expresses unique gene markers such as SPINK4, whose expression has not been previously reported in hematopoiesis. f) UMAP visualization of the MEM lineage in the latent space <italic>Z<sub>organ</sub></italic> which is supervised by the organ covariate. <italic>Z<sub>organ</sub></italic> learned a biological manifold stratified by organ. g) The stratification of <italic>Z<sub>organ</sub></italic> by organ covariate is biologically meaningful with more similar organs located closer together.</p></caption><graphic xlink:href="EMS206282-f004"/></fig><fig id="F5" position="float"><label>Figure 5</label><caption><title>CellDISECT identifies erythroid maturation difference between liver and bone marrow</title><p>a) UMAP visualisation of Erythroids (top) and organ (bottom) distribution in <italic>Z</italic><sub>0,<italic>organ</italic></sub> derived embedding.</p><p>b) UMAP visualisation of Erythroid lineage plotting original author cell types. Arrows indicating direction of maturation for liver (purple) and bone marrow (green).</p><p>c) Terminal states for erythroid maturation determined from GPCCA model using cytotrace kernel from Cellrank. Left showing 3 terminal cell states. Right showing fate probabilities of all cells for each terminal cell state identified.</p><p>d) Dot plot showing the mean expression (colour) and proportion of cells expressing proteins (dot size) of known erythroid maturation markers, markers separating Liver and Bone marrow lineages being increased in Bone marrow and Mitochondrial markers separating liver specific erythroid cluster offshoot</p></caption><graphic xlink:href="EMS206282-f005"/></fig></floats-group></article>