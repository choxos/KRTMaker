<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="epub">2692-8205</issn></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS206022</article-id><article-id pub-id-type="doi">10.1101/2025.05.23.655749</article-id><article-id pub-id-type="archive">PPR1027522</article-id><article-version-alternatives><article-version article-version-type="status">preprint</article-version><article-version article-version-type="number">1</article-version></article-version-alternatives><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>Automated evaluation of single-cell reference atlas mappings enables the identification of disease-associated cell states</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Sikkema</surname><given-names>Lisa</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref></contrib><contrib contrib-type="author"><name><surname>Lkandushi</surname><given-names>Mariam</given-names></name></contrib><contrib contrib-type="author"><name><surname>Scarcella</surname><given-names>Daniele</given-names></name><xref ref-type="aff" rid="A3">3</xref></contrib><contrib contrib-type="author"><name><surname>Moinfar</surname><given-names>Amir Ali</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref></contrib><contrib contrib-type="author"><name><surname>Engelmann</surname><given-names>Jan</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref></contrib><contrib contrib-type="author"><name><surname>Theis</surname><given-names>Fabian J.</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A4">4</xref></contrib></contrib-group><aff id="A1"><label>1</label>Department of Computational Health, Institute of Computational Biology, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/00cfam450</institution-id><institution>Helmholtz Zentrum München</institution></institution-wrap>, <city>Munich</city>, <country country="DE">Germany</country></aff><aff id="A2"><label>2</label>TUM School of Life Sciences Weihenstephan, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/02kkvpp62</institution-id><institution>Technical University of Munich</institution></institution-wrap>, <city>Freising</city>, <country country="DE">Germany</country></aff><aff id="A3"><label>3</label>Institute of AI for Health<institution-wrap><institution-id institution-id-type="ror">https://ror.org/00cfam450</institution-id><institution>Helmholtz Zentrum München</institution></institution-wrap>, <city>Munich</city>, <country country="DE">Germany</country></aff><aff id="A4"><label>4</label>Department of Mathematics, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/02kkvpp62</institution-id><institution>Technical University of Munich</institution></institution-wrap>, <city>Garching</city>, <country country="DE">Germany</country></aff><pub-date pub-type="nihms-submitted"><day>30</day><month>05</month><year>2025</year></pub-date><pub-date pub-type="preprint"><day>28</day><month>05</month><year>2025</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by-nc-nd/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P1">The rise of single-cell atlases has opened up the use of reference atlases as a comprehensive healthy control for the study of disease. A key step for using atlases is the mapping of “query” disease or perturbed datasets onto a healthy reference atlas, which allows for comparison of the query to healthy controls and thereby the identification of perturbation-specific transcriptional cell states. However, the mapping success, i.e. the extent to which these mappings correctly reflect biological similarities and differences between query and reference, varies with e.g. experimental confounders in the data (dissociation protocol, single-cell assay) or the mapping method used, and cannot be predicted in advance. Moreover, an unsuccessful mapping can result in falsely reporting technical artifacts as disease or perturbation-specific cellular changes and in overlooking true altered states. Here, we present MapQC, a method that quantifies query-to-reference mapping success by leveraging the information present in the reference embedding. Specifically, MapQC tests the presence of remaining batch effect in the embedding after mapping by comparing inter-sample distances in the healthy reference itself to distance of query control samples to the reference. Similarly, it tests whether disease or perturbation-specific variation has been retained during mapping by testing whether query perturbed samples are more distant to the reference than reference samples are from each other. We apply MapQC to lung and endometrial query datasets, including data of idiopathic pulmonary fibrosis and Asherman Syndrome, mapped to large-scale healthy references. We show that MapQC correctly distinguishes successful mappings from unsuccessful ones where data visualization techniques such as UMAP can be deceiving, and that mapQC outperforms integration metrics often re-purposed for mapping qualitycontrol. Moreover, only mappings that MapQC identified as successful result in the correct identification of cell state changes specific to disease. Taken together, MapQC provides a critical quality-control metric for a more reliable, robust, and accurate use of reference atlases to study disease.</p></abstract></article-meta></front><body><sec id="S1" sec-type="intro"><label>1</label><title>Introduction</title><p id="P2">Large-scale cellular reference atlases are being constructed for a variety of tissues and organs[<xref ref-type="bibr" rid="R1">1</xref>], and are used increasingly widely for the annotation and interpretation of new data [<xref ref-type="bibr" rid="R2">2</xref>–<xref ref-type="bibr" rid="R4">4</xref>]. Reference atlases bring together data from many different studies and thereby offer a uniquely broad view of the phenotypic variation existing in a population, including among healthy individuals. Whereas single datasets often only include a limited set of healthy controls, complicating the distinction between normal variation and disease-induced changes, healthy tissue atlases offer a more comprehensive collection of healthy controls. Thus, comparing newly generated data of disease or other perturbations (e.g. genetic knock-outs, drug treatments, etc.) to an existing healthy reference atlas enables a more accurate distinction between “normal” and perturbation-specific variation [<xref ref-type="bibr" rid="R5">5</xref>, <xref ref-type="bibr" rid="R6">6</xref>], an essential goal of biomedical research.</p><p id="P3">Several methods have been developed to allow for a fast and easy comparison of newly generated data (i.e. a “query”) to an existing atlas (i.e. a “reference”) [<xref ref-type="bibr" rid="R7">7</xref>–<xref ref-type="bibr" rid="R10">10</xref>]. These methods enable the mapping of query data onto an existing low-dimensional representation of a reference, for example using transfer learning[<xref ref-type="bibr" rid="R8">8</xref>, <xref ref-type="bibr" rid="R11">11</xref>]. The resulting joint representation can be used for the interpretation of the query data, such as the identification of cell types from diseased tissue in the query data that are different from their healthy counterparts [<xref ref-type="bibr" rid="R5">5</xref>, <xref ref-type="bibr" rid="R6">6</xref>].</p><p id="P4">For the correct interpretation of query data mapped onto a reference atlas, it is essential that the variation captured in the mapped data reflects the true biological variation. If, instead, variation caused by technical covariates (e.g. sequencing platform or tissue dissociation protocol) is preserved in the mapping, disease-specific effects are likely to be confounded with technical artifacts in the data, making it impossible to confidently infer new disease-specific knowledge from the query-to-reference comparison without prior knowledge. Conversely, if a mapping removes too much variation from the query, disease-specific changes can become undetectable. Metrics to capture and quantify these possible mapping failures are therefore crucial.</p><p id="P5">A number of metrics are currently used to characterize the quality of query-to-reference mappings. One group of metrics measures the preservation of variation in the query before and after mapping, for example by quantifying preservation of query cell neighborhoods or clusters[<xref ref-type="bibr" rid="R9">9</xref>, <xref ref-type="bibr" rid="R10">10</xref>, <xref ref-type="bibr" rid="R12">12</xref>]. These metrics require that the topology of thequery’s embedding remains unchanged after mapping, which defeats the purpose of the mapping - namely, that by using the reference during embedding, the query’s topology changes, revealing subtle sources of variation in the query such as rare cell types. Moreover, the metrics are insensitive to the extent to which the query and the reference mix, an essential aspect of mapping quality. A second group of metrics consists of general batch integration metrics, that are now re-purposed to assess the quality of a mapping by treating the reference as one batch and the query as another. For example, some metrics quantify the mixing of cells from distinct donors or batches in the latent space after integration or mapping [<xref ref-type="bibr" rid="R9">9</xref>, <xref ref-type="bibr" rid="R13">13</xref>]. Whereas such metrics are useful as relative metrics, i.e. to compare different mapping approaches applied to the same data in a benchmark setting, they fail to define clear thresholds to distinguish a failed from a successful mapping and are therefore difficult to interpret. Most importantly, none of these metrics take into account the fact that there is not just one healthy state, but that variation exists even within the healthy population. Acknowledging and leveraging this fact opens the path to a new and better way to evaluate query-to-reference mappings.</p><p id="P6">Here we present MapQC, a metric to assess the success of the mapping of a query dataset onto an existing healthy reference atlas, independent of the mapping method used. Leveraging the comprehensive coverage of healthy phenotypes in a reference, MapQC learns the inter-sample distances expected between healthy samples at the cell-state level. It then validates successful removal of batch effects by performing a control test on the query control samples, checking whether query control sample distances to the reference samples are as expected based on the reference. Finally, MapQC ensures that biological variation has been retained during mapping by performing a case test, in which it checks whether case samples from the query (e.g. from diseased tissue or perturbed cells) display a larger distance to the reference. We apply MapQC to two query datasets mapped to two distinct references, and show that MapQC identifies mappings in which batch effects were not successfully removed. We furthermore demonstrate that such mapping failures, if left undetected, could lead to false identification of putative disease effects. In contrast, mappings identified as successful by MapQC, e.g. through improved mapping parameter settings, enable the correct identification of disease-specific cell states. Overall, given the upcoming wide use of reference atlases for the analysis and interpretation of new data, MapQC is an essential tool for guiding correct and reliable atlas use.</p></sec><sec id="S2" sec-type="results"><label>2</label><title>Results</title><sec id="S3"><label>2.1</label><title>MapQC uses local intersample distances to evaluate mappings</title><p id="P7">To distinguish a successful from an unsuccessful query-to-reference mapping, MapQC builds on two basic assumptions:</p><sec id="S4"><title>Assumption 1</title><p id="P8">Healthy reference atlases capture most of the cellular variation present within the healthy population.</p></sec><sec id="S5"><title>Assumption 2</title><p id="P9">Diseased tissue is transcriptionally different from healthy tissue for one or more cell types.From these assumptions, two hypotheses can be derived that should hold true in the case of a successful query-to-reference mapping. These are the two hypotheses that MapQC tests for a given mapping.</p></sec><sec id="S6"><title>Hypothesis 1</title><p id="P10">Healthy “control” samples in the query are equally similar to healthy samples in the reference, as healthy reference samples are similar to each other.</p></sec><sec id="S7"><title>Hypothesis 2</title><p id="P11">“Case” samples (of e.g. diseased individuals) are, at least for some cell types, less similar to healthy reference samples, than healthy reference samples are similar to each other.</p><p id="P12">Based on hypothesis 1 and 2, we can establish data-driven thresholds to distinguish between successful and failed mappings, with query control samples similar to the reference and query case samples dissimilar to the reference in the case of a successful mapping (<xref ref-type="fig" rid="F1">fig. 1a</xref>). In this framework, dissimilar samples are defined as those whose distance from the reference falls outside of the normal range as observed in the healthy reference. MapQC thus uniquely leverages a key aspect of healthy reference atlases: given their wide coverage of the healthy population, they enable learning what normal, healthy inter-sample variation looks like.</p><p id="P13">Concretely, to establish the “null distribution” of normal inter-sample variation as observed in the reference, distances between reference samples themselves are first calculated (including only control samples from the reference). These distances are calculated in the integrated embedding space using the Energy distance metric[<xref ref-type="bibr" rid="R14">14</xref>, <xref ref-type="bibr" rid="R15">15</xref>] (<xref ref-type="sec" rid="S12">Methods</xref>). Notably, normal inter-sample distances can differ from cell type to cell type and even from state to state. To account for this cell-type specific level of inter-sample variation, baselines are calculated within large neighborhoods of cells instead of on the entire atlas (<xref ref-type="fig" rid="F1">fig. 1b</xref>). Indeed, inter-sample distances in the reference vary markedly between neighborhoods, even within the same cell type, as do their variances (<xref ref-type="fig" rid="F5">Extended Data fig. 1</xref>), supporting the use of local inter-sample distance null-distributions over global. Taken together, a sample’s distance to the reference <italic>d<sub>h</sub>(s<sub>i</sub>, ref</italic>) in a given neighborhood <italic>h</italic> is calculated as its mean distance to all reference samples in that neighborhood: <disp-formula id="FD1"><mml:math id="M1"><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>r</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>r</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:mrow></mml:munderover><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:mrow></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p><p id="P14">where <italic>r<sub>h</sub></italic> is the number of samples from the reference in neighborhood h that have passed filtering (see <xref ref-type="sec" rid="S12">Methods</xref>), <italic>S<sub>j,r</sub></italic> is a sample from the reference, <italic>s<sub>i</sub></italic> ≠ <italic>S<sub>j</sub></italic>, and <italic>E<sub>h</sub></italic>(<italic>s<sub>i</sub>, S<sub>j</sub></italic>) is the energy distance between <italic>s<sub>i</sub></italic> and <italic>S<sub>j</sub></italic>. The distances to the reference for the set of reference samples in a given neighborhood together form that neighborhood’s null distribution.</p><p id="P15">Using the neighborhood-specific null-distributions, sample distances to the reference can now be normalized across neighborhoods, such that a sample’s normalized distance -in a given neighborhood- is a measure of its distance to the reference as compared to inter-sample distances in the reference itself (<xref ref-type="fig" rid="F1">fig. 1b</xref>). Normalizing distances accordingly results in a standardized and interpretable measure of a sample’s distance to the reference across neighborhoods, and even across mappings. The normalization is performed by Z-scoring distances to the reference within neighborhoods, using the neighborhood’s null distributions mean and standard deviation for the Z-scoring, such that a sample <italic>s<sub>i</sub></italic>’s normalized distance to the reference in a given neighborhood <italic>h</italic> is calculated as follows: <disp-formula id="FD2"><mml:math id="M2"><mml:mrow><mml:mi>n</mml:mi><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:math></disp-formula></p><p id="P16">where <italic>s<sub>i</sub></italic> is sample i, and <italic>μ<sub>h</sub></italic> and <italic>σ<sub>h</sub></italic> are the mean and standard deviation of the reference samples’ own distance to the reference, as based on the neighborhood’s null distribution. A cell <italic>c<sub>i</sub></italic>’s mapQC score is then calculated as its sample <italic>s</italic>’s mean normalized distance to the reference across all the neighborhoods that the cell was part of (<italic>N<sub>c</sub></italic>): <disp-formula id="FD3"><mml:math id="M3"><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>p</mml:mi><mml:mi>Q</mml:mi><mml:mi>C</mml:mi><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:msub><mml:mi>e</mml:mi><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>N</mml:mi><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>N</mml:mi><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:munderover><mml:mrow><mml:mi>n</mml:mi><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p><p id="P17">This results in a cell-level resolution score indicating for each cell whether it is close to or distant from the reference. A mapQC score of 0 for a cell means that in the cell’s neighborhood(s), its sample has a distance to the reference equal to the mean intersample distances in the reference itself, indicating high similarity of the sample to the reference. A mapQC score above 2 means a sample’s distance to the reference is more than two standard deviations above the reference’s mean inter-sample distance (which is expected for approximately 2% of samples from the null distribution, assuming it is Gaussian), indicating dissimilarity to the reference. We thus define a mapQC score&gt;2 for a query cell as likely indicating either remaining batch effect or the presence of biological states not observed in the reference (<xref ref-type="fig" rid="F1">fig. 1a</xref>).</p><p id="P18">MapQC’s cell-level resolution (each query cell has its own mapQC score) enables mapping analysis at any resolution of choice. In practice, as outliers are often expected, we recommend analyzing mapQC scores initially at the aggregate level, e.g. looking at the score distribution per cluster or cell type. This can aid in identifying groups of cells consistently mapping distant from the reference.</p><p id="P19">The mapQC scores can then used to determine if a query-to-reference mapping was successful, or if it has failed in one of two possible ways: by under-integrating or by over-integrating the query data into the reference (<xref ref-type="fig" rid="F1">fig. 1a</xref>). A mapping was successful if query control samples are close to the reference (mapQC score&lt;2) across the mapping, indicating no remaining batch effect, while query case samples have subset of cells distant to the reference (mapQC score&gt;2), indicating preservation of case-specific cell states. If this is the case, the mapping can safely be used for downstream analysis. In contrast, the mapping has failed due to under-integration if distances between control samples in the query dataset and the healthy reference are larger than expected (mapQC score&gt;2) based on the baselines, such that query-specific batch-effect is likely still present in the embedding. Conversely, the mapping has failed due to over-integration if case-related variation, such as a disease-related shift in gene expression, has been removed from the embedding, such that case samples consistently look equally similar to healthy reference samples as healthy reference samples are similar to each other.</p></sec></sec><sec id="S8"><label>2.2</label><title>MapQC identifies remaining batch effects after mapping</title><p id="P20">To investigate whether mapQC evaluates mappings correctly, we applied it to the mapping of an IPF dataset[<xref ref-type="bibr" rid="R16">16</xref>] including 5 samples from patients with IPF, and 6 control samples, onto the Human Lung Cell Atlas[<xref ref-type="bibr" rid="R6">6</xref>] (<xref ref-type="fig" rid="F2">fig. 2a</xref>, <xref ref-type="fig" rid="F6">Extended Data fig. 2a</xref>, <xref ref-type="sec" rid="S12">Methods</xref>). First, to evaluate the presence of remaining batch effect in the query after mapping, we looked at mapQC scores for the control samples of the query (<xref ref-type="fig" rid="F2">fig. 2a-c</xref>, <xref ref-type="fig" rid="F6">Extended Data fig. 2b</xref>, query controls). Many cells were distant from the reference (mapQC-score&gt;2), suggesting batch effects were still strongly present in the data (<xref ref-type="fig" rid="F2">fig. 2b, c</xref>, query controls). Notably, this could not be visually inferred from the UMAP embedding in all cases (e.g. blood vessel endothelium, alveolar epithelium <xref ref-type="fig" rid="F2">fig. 2a, b</xref>, <xref ref-type="fig" rid="F6">Extended Data fig. 2a</xref>).</p><p id="P21">To determine whether a large distance from the reference (mapQC score&gt;2) in the query control indeed indicates remaining batch effect in the embedding, we selected a subset of cells to analyze in more detail. Specifically, we chose a cell type for which the large distance of the control cells from the reference, as inferred by mapQC, could not be seen in the UMAP. Blood vessel endothelial cells from query control samples accordingly mixed with the reference in the UMAP despite high mapQC scores, whereas query disease cells separated from the reference (<xref ref-type="fig" rid="F2">fig. 2a, b</xref>). Mimicking a standard analysis workflow, we clustered the endothelial cells to see if disease cells formed a separate cluster. Indeed, clustering not only resulted in separate clusters for different endothelial cell subtypes, but also in an additional cluster containing almost all query disease endothelial cells (<xref ref-type="fig" rid="F2">fig. 2d</xref>, <xref ref-type="fig" rid="F6">Extended Data fig. 2c, d</xref>). Normally, differences between this disease-specific cluster and other clusters would be interpreted as disease-specific expression patterns. However, the top differentially expressed genes, aside from cell type marker genes, consisted of expression changes related to experimental artifacts, including ambient RNA (such as from B cells, <italic>IGKC</italic> and <italic>IGHA1</italic>), dissociation-stress related (<italic>FOSB</italic>), and ribosomal protein (often related with batch effects[<xref ref-type="bibr" rid="R6">6</xref>], <italic>RPS4Y1</italic>) genes (<xref ref-type="fig" rid="F2">fig. 2e</xref>, <xref ref-type="fig" rid="F6">Extended Data fig. 2e, f</xref>). MapQC thus correctly identifies mapped cells from this cell type as containing remaining batch effects by assigning high mapQC scores to the control cells. It thereby prevents the downstream interpretation of batch effects as disease-specific effects.</p><p id="P22">As a second use case, we mapped a dataset to the Human Endometrial Cell Atlas (HECA)[<xref ref-type="bibr" rid="R17">17</xref>] (<xref ref-type="fig" rid="F2">fig. 2f</xref>, <xref ref-type="fig" rid="F7">Extended Data fig. 3a, b</xref>). The query dataset included data from 6 healthy donors and 9 donors with Asherman’s syndrome (AS), a disease of the uterus that can cause infertility[<xref ref-type="bibr" rid="R18">18</xref>]. Most query control cells mapped close to the reference (mapQC score&lt;2 for 93.9% of cells), suggesting a largely successful removal of batch effects during the mapping (<xref ref-type="fig" rid="F2">fig. 2g</xref>, <xref ref-type="fig" rid="F7">Extended Data fig. 3c</xref>). While no clear difference in scores between control and disease cells could be observed at the cell type level, partitioning the cells into clusters did result in the isolation of groups distant from the reference: two clusters (cluster 21 and 25) consistently showed mapQC scores above 2, and consisted largely of cells from the query (94 and 97% of cells, <xref ref-type="fig" rid="F7">Extended Data fig. 3c-f</xref>). Interestingly, one of these two clusters (cluster 21) contained 74% of cells from the cell type described as disease-specific “AS epithelium” in the original publication of the query dataset (<xref ref-type="fig" rid="F2">fig. 2f, g</xref>, zoom-in), possibly indicating these cells mapped separate from the reference due to disease-specific gene expression patterns.However, both clusters also contained many cells from query control samples with high mapQC scores, suggesting that the observed distance between these clusters and the reference was at least partly batch-rather than disease-driven (<xref ref-type="fig" rid="F7">Extended Data fig. 3d, f</xref>).</p><p id="P23">To investigate if the query-specific clusters were indeed batch-effect-dominated, we identified cluster-specific differentially expressed genes for cluster 21, containing the putative disease-specific AS epithelium. Up-regulated genes in this cluster revealed a disease-specific gene expression pattern, with the query disease but not query control cells in the cluster showing doublet-like expression of both stroma- and epithelium-specific genes (<xref ref-type="fig" rid="F3">fig. 3h</xref>). However, down-regulated genes in the cluster were lowly expressed in both control and disease query cells, while highly expressed across the rest of the cells in the reference and query, showing that differential expression patterns in this cluster were only partly disease-specific (<xref ref-type="fig" rid="F3">fig. 3h</xref>). Moreover, cells in both cluster 21 and 25 showed a low number of total counts per cell, did not express marker genes for any specific cell-type (as based on HECA markers) beyond general stromal markers, and showed low <italic>MALAT1</italic> expression in the case of cluster 25 (<xref ref-type="fig" rid="F7">Extended Data fig. 3g-i</xref>). Noisy gene expression patterns, which can result in lack of specific marker expression, low total counts, and low <italic>MALAT1</italic> expression are known signs of low-quality “cells”, such as empty droplets[<xref ref-type="bibr" rid="R19">19</xref>–<xref ref-type="bibr" rid="R21">21</xref>]. Similarly, the co-expression of genes from distinct lineages (stroma, epithelium) observed in the query disease cells is characteristic of doublets, as further supported by the lack of genes uniquely expressed in the cluster. Overall, the two clusters with high mapQC scores appear to be dataset-specific low-quality cells rather than disease-specific cellular phenotypes, as claimed in the original publication. The cell types have thus been correctly flagged by mapQC as a mapping artifact that cannot be used for downstream analysis. In contrast, the remainder of control cells in the query dataset largely show low mapQC scores, suggesting downstream analysis can be performed after removal of the low-quality cells. Thus, mapQC aids in identifying integration failures during the mapping, preventing mis-interpretation of the data.</p></sec><sec id="S9"><label>2.3</label><title>Successful mappings enable the identification of disease-specific cell states</title><p id="P24">To investigate whether mapQC could correctly identify a successful mapping, we remapped the previously discussed query dataset of IPF onto the HLCA, while changing several mapping parameters to non-default settings aiming to improve the mapping (<xref ref-type="sec" rid="S12">Methods</xref>). Changing the maximum KL weight parameter only worsened mapping quality (percentage of cells distant from the reference (mapQC score&gt;2), in query control samples in original mapping: 28.4%, versus 100% for maximum KL weight 2, 49.1% for maximum KL weight 0.1). In contrast, mapping with a different batch covariate (sample instead of dataset) substantially improved the mapQC scores of the control samples (17.1% of cells distant from the reference). Additionally recovering counts from 69 mapping input genes that had gotten lost during genome annotation harmonization further improved mapping scores (9.3% of cells distant from the reference, <xref ref-type="fig" rid="F3">fig. 3a-d</xref>, <xref ref-type="fig" rid="F8">Extended Data fig. 4a, b</xref>, query controls). Lymphoid (NK, B, and T) cells, low in cell number, and pericytes mapped distant from the reference (high-mapQC scores) in both control and disease samples, suggesting these cell types still included batch-specific variation in the embedding and should be analyzed with caution. Interestingly, integration quality of NK and T cells was already reported to be poor in the reference itself[<xref ref-type="bibr" rid="R6">6</xref>], stressing the importance of a high-quality reference for high-quality mapping. Overall, cells from disease samples were more distant from the reference than those from the controls for several cell types (9.3% versus 23.7% of cells with mapQC score&gt;2), indicating disease-specific effects were likely well-preserved during mapping (<xref ref-type="fig" rid="F3">fig. 3b-d</xref>, query IPF). Unlike in the previous mapping with query control ECs mapping distant from the reference (<xref ref-type="fig" rid="F2">fig. 2a-e</xref>), in this mapping ECs from the query disease samples mapped close to the reference and did not form a separate cluster (<xref ref-type="fig" rid="F8">Extended Data fig. 4c</xref>). The previously described batch-specific ambient RNA thus seems to have correctly been ignored during this mapping.</p><p id="P25">In contrast to the endothelial cells, query smooth muscle cells did map distant from the reference, with 26% of cells from IPF lungs but only 2% of cells from control samples (<xref ref-type="fig" rid="F3">fig. 3d</xref>) showing high mapQC scores. Moreover, this result is consistent across study subjects (<xref ref-type="fig" rid="F8">Extended Data fig. 4d</xref>). Comparing gene expression between query smooth muscle cells mapped close to or distant from the reference, we found many genes specifically expressed in cells distant from the reference (<xref ref-type="fig" rid="F3">fig. 3e</xref>), suggesting a disease-specific smooth muscle phenotype. Indeed, most of these genes also show increased expression in IPF smooth muscle in several other datasets [<xref ref-type="bibr" rid="R22">22</xref>–<xref ref-type="bibr" rid="R24">24</xref>], confirming the disease state identified by mapQC is not caused by batch-related artifacts in the data (<xref ref-type="fig" rid="F8">Extended Data fig. 4e</xref>). Several of these genes, including <italic>IGFBP2, FAM162B,</italic> [<xref ref-type="bibr" rid="R25">25</xref>] and <italic>CCL21</italic>[<xref ref-type="bibr" rid="R26">26</xref>–<xref ref-type="bibr" rid="R28">28</xref>], have been previously associated with lung fibrosis and IPF.</p><p id="P26">Notably, alveolar macrophages highly expressing <italic>SPP1,</italic> a previously described IPF-specific cell state[<xref ref-type="bibr" rid="R6">6</xref>, <xref ref-type="bibr" rid="R24">24</xref>, <xref ref-type="bibr" rid="R29">29</xref>], are also correctly identified as disease-specific based on their distance from the reference, while alveolar macrophages low in <italic>SPP1</italic> and high in <italic>FABP4</italic> and <italic>INHBA</italic> expression, as previously observed in healthy[<xref ref-type="bibr" rid="R30">30</xref>, <xref ref-type="bibr" rid="R31">31</xref>], map close to the reference (<xref ref-type="fig" rid="F3">fig. 3f,g</xref>). Importantly, in the UMAP of the joint reference and query, macrophages from IPF patients do not visibly map separately from their healthy counterparts (<xref ref-type="fig" rid="F3">fig. 3a, b</xref>), confirming that a more quantitative approach -not based on two-dimensional data visualization- is needed to identify cells distant from the reference. Interestingly, query fibroblasts highly expressing <italic>CTHRC1,</italic> reported as disease-specific in the original publication of the mapped dataset[<xref ref-type="bibr" rid="R16">16</xref>], map close to the reference according to mapQC, thus not being highlighted as disease-specific. Indeed, inspection of <italic>CTHRC1</italic> expression of samples clustering with <italic>CTHRC1</italic>-high cells from IPF donors shows that 7 healthy donors show a mean <italic>CTHRC1</italic> expression equal to or higher than the IPF donors in the cluster (<xref ref-type="fig" rid="F3">fig. 3h</xref>, <xref ref-type="fig" rid="F8">Extended Data fig. 4f-h</xref>). None of these are control samples from the query dataset itself, showing the relevance of mapping to a larger control population (reference atlas) for a more accurate identification of disease-specific phenotypes. Overall, mapQC aids in identifying disease-specific cell populations in a successful query-to-reference mapping.</p></sec><sec id="S10"><label>2.4</label><title>MapQC outperforms integration metrics</title><p id="P27">Currently, several metrics are being used to evaluate query-to-reference mappings. These metrics are largely pre-existing integration metrics that were re-purposed as mapping metrics. We here focus specifically on metrics that do not require cell-type labels of the query, that allow for cell-level scores, and that can be used in combination with any mapping method.</p><p id="P28">First, a number of metrics aim to quantify preservation of the query manifold structure before and after mapping. For example, Azimuth’s cluster preservation score compares clustering of the query before and after mapping[<xref ref-type="bibr" rid="R12">12</xref>]. Similarly, Azimuth’s mapping score[<xref ref-type="bibr" rid="R12">12</xref>] and Symphony’s within-query k-NN-correlation[<xref ref-type="bibr" rid="R9">9</xref>] (“wiq-kNN-corr”) compare query cells’ nearest query neighbors before and after mapping. Whereas these metrics could be used to highlight loss of information after mapping, they do not evaluate the quality of the integration of the query and the reference. This is confirmed by these metrics’ evaluation of the best and worst mapping, according to mapQC, of the previously discussed IPF dataset to the HLCA. Whereas for the worst mapping the query control cells separate completely from the reference even in the UMAP, scores for these metrics (cluster preservation score, wiq-kNN-corr) are nearly indistinguishable from those for the best mapping (<xref ref-type="fig" rid="F4">fig. 4a-c</xref>). Similarly, donor LISI scores, which aim to quantify the mixing of query donors in the embedding after mapping, show no clear differences between the two mappings. In contrast, mapQC identifies 100% of query control cells as distant from the reference in the bad mapping.</p><p id="P29">A fourth metric, kBET[<xref ref-type="bibr" rid="R32">32</xref>], which quantifies the preservation of batch composition in neighborhoods across the embedding, shows the lowest possible score for almost all cells in both embeddings. kBET assumes that query and reference proportions should be constant across larger regions in the embedding, an assumption that is not expected to hold given a reference highly diverse in sample types (different anatomical regions sampled, different protocols used, etc.), making the metric overly sensitive (<xref ref-type="fig" rid="F4">fig. 4</xref>).</p><p id="P30">The final metric, the LISI score, while showing a clearer difference between the two mappings, is highly sensitive to the abundance of different batches. The value of the score is determined by the number of draws from a cell’s nearest neighbors until a “batch” (query donor for “donor LISI”, or reference or query for “batch LISI”) is observed twice. Indeed, “batch LISI”, the LISI score that is widely used to compare batch integration performance across different integrations <xref ref-type="sec" rid="S12">Methods</xref> [<xref ref-type="bibr" rid="R13">13</xref>], shows dramatically different scores when down-sampling query cells to 1% or even 10% of the original number of cells, whereas mapQC scores generally stay stable (<xref ref-type="fig" rid="F9">Extended Data fig. 5</xref>).</p><p id="P31">Unlike for mapQC, a clear interpretation of the absolute values of any of these metrics is lacking, making a non-arbitrary and generalizable cutoff value for bad integration as well as a successful integration impossible. MapQC is thus the first evaluation metric that can be readily interpreted and is suited for a quality-check of any given mapping to a large-scale reference, reliably identifying both successful and failed mappings.</p><p id="P32">Crucially, all the discussed metrics ignore natural variation between samples, making their integration scores less accurate and often ill-founded: these metrics do not distinguish between normal versus abnormal inter-sample variation, but qualify any lack of inter-batch mixing as bad. In contrast, mapQC is the first metric to incorporate a natural inter-sample variation estimate into its score calculation, thus enabling a more precise distinction between failed and successful mappings.</p></sec></sec><sec id="S11" sec-type="discussion"><label>3</label><title>Discussion</title><p id="P33">Large-scale reference atlases are being constructed at an increasingly fast pace, with atlases including a large set of healthy or unperturbed controls now available for several organs, model systems, and cell types in both human and mouse [<xref ref-type="bibr" rid="R1">1</xref>, <xref ref-type="bibr" rid="R33">33</xref>–<xref ref-type="bibr" rid="R37">37</xref>]. This development ushers in a transformed way of analyzing single-cell data: rather than analyzing datasets in isolation, they will now routinely be analyzed in the context of large-scale references[<xref ref-type="bibr" rid="R1">1</xref>, <xref ref-type="bibr" rid="R7">7</xref>]. Indeed, reference atlases are already being used widely for the annotation and interpretation of new data [<xref ref-type="bibr" rid="R2">2</xref>–<xref ref-type="bibr" rid="R4">4</xref>]. Correct usage of reference atlases is therefore more important than ever: incorrect mapping of a new query dataset to an existing reference will lead to misinterpretation of the query. In this study we presented mapQC, a metric to evaluate query-to-reference mappings in an automated and interpretable fashion. Leveraging the availability of a large-scale reference, mapQC takes into account normal inter-sample variation by constructing local null-distributions of inter-sample distances. This results in the first biologically grounded and interpretable distance metric to evaluate query-to-reference mappings. We show that mapQC correctly identifies remaining batch effects in query-to-reference mappings based on large distances of query controls to the reference, and does so better than standard integration metrics. MapQC moreover correctly identifies successful mappings, enabling the discovery of true disease-specific cell states. It thus facilitates a more reliable usage of reference atlases for the analysis of new data.</p><p id="P34">We note that the use of mapQC is bound to several limitations. First, it requires the availability of control samples in the query dataset that were generated with a protocol similar to the case samples. Whereas the requirement of control samples in a dataset might incur extra costs, including controls is considered good scientific practice in any scientific experiment and is currently also routinely done in single-cell experiments[<xref ref-type="bibr" rid="R38">38</xref>–<xref ref-type="bibr" rid="R40">40</xref>]. Moreover, it has been shown previously that the availability of a limited set of matched controls, even when mapping to a reference atlas of more controls, significantly reduces the chance of false positives in disease state identification[<xref ref-type="bibr" rid="R5">5</xref>]. Second, mapQC’s assumption that the reference covers most of the variation in the control population is only likely to hold for large-scale reference atlases. Therefore, mapQC is less suitable for evaluating the mapping of one dataset to a single other dataset. Its ability to accurately distinguish batch-effects from query-specific cell states depends on the number and diversity of donors in the reference. For example, if the reference only covers a subset of the healthy population (e.g. only people of European descent) and the query contains data from a different population, mapQCs assumptions are violated, causing it to conflate biology with batch effects. Similarly, the quality of the reference can affect mapQC’s performance: if inter-sample distances in the reference are driven by batch effects, mapQC will not be able to identify remaining batch effects of the same strength in the query after the mapping. Finally, mapQC makes the assumption that the extent of batch effects is similar in the query control and query disease samples. While this assumption has a clear rationale (sample collection and processing, which are a major source of batch effect, are often similar across samples from the same dataset), it might not always hold. However, a perfect confounding between experimental conditions and covariates of interest (e.g. disease status) cannot be solved by any data-driven metric, and would require the use of prior knowledge for correct analysis of the data.</p><p id="P35">One important feature of mapQC is its calculation of inter-sample distance null distributions at the neighborhood level. This neighborhood-level approach accounts for cell-state specific levels of inter-sample variation. Indeed, we observed substantial differences in inter-sample distance between and even within cell types (<xref ref-type="fig" rid="F5">Extended Data fig. 1</xref>). This variation might have multiple sources. First, it could be caused by biological phenomena, such as cell type or state-specific expression quantitative trait loci (eQTLs) that cause different levels of inter-individual variaton, or cell type-specific sensitivity to changes in environment (e.g. disease, aging))[<xref ref-type="bibr" rid="R6">6</xref>, <xref ref-type="bibr" rid="R41">41</xref>, <xref ref-type="bibr" rid="R42">42</xref>]. Second, it might have computational sources, such as a better representation of cell-type specific gene expression variance by the embedding model for more abundant cell types. In both cases, taking this variation into account is essential when quantifying a query cell’s distance to the reference.</p><p id="P36">For our mapping of IPF data to the HLCA reference, we showed an example of improving the quality of a mapping by tuning several mapping parameters and by increasing the quality of the query input data. However, in many other mapping cases parameter tuning did not lead to a sufficiently good mapping due to remaining batch effects in the data. Moreover, tuning possibilities are limited for all <xref ref-type="sec" rid="S12">Methods</xref>[<xref ref-type="bibr" rid="R8">8</xref>–<xref ref-type="bibr" rid="R10">10</xref>]. We therefore identify a need for new query-to-reference methods that allow for more tuning flexibility and a stronger batch-correction of the query or even the reference data when mapping.</p><p id="P37">Whereas we only showed the use of mapQC in the context of query-to-reference mapping of a query to a large-scale healthy reference, there are several other possible uses of mapQC that have not been show-cased here. For example, mapQC could be used during the construction of large-scale reference atlases themselves, to compare the integration of specific datasets to the rest of the datasets in the reference. Similarly, mapQC can be employed in the context of smaller references (e.g. one large reference dataset instead of an integrated atlas). In all these cases, it is important to keep in mind -and validate where possible- the assumptions that mapQC is built on (e.g. that the subjects from the query dataset are a sample from a healthy population that was also sampled in the reference).</p><p id="P38">In this study, we introduced mapQC, a metric designed to evaluate the quality of query-to-reference mappings in single-cell analysis. MapQC is the first metric tailored specifically to the query-to-reference mapping scenario, leveraging information about inter-sample variation present in the reference to accurately evaluate a query’s integration into the reference. We demonstrated that existing integration metrics fail to distinguish failed from successful mappings. In contrast, mapQC correctly detects failed mappings, and accurately evaluates successful ones, enabling the discovery of true disease-associated cell states. The emergence of large-scale single-cell atlases has fundamentally shifted the way single-cell data analysis is performed, with reference mapping now being a key first step in annotation and interpretation of new data. The need for a rigorous evaluation of such mappings has thus become more critical than ever. We anticipate that mapQC will serve as an essential tool to ensure the reliability of reference-based analyses, advancing our ability to identify disease-specific cell states and ultimately advancing our understanding of health and its changes in disease.</p></sec><sec id="S12" sec-type="methods"><label>4</label><title>Methods</title><sec id="S13"><label>4.1</label><title>Selecting neighborhoods</title><p id="P39">Inter-sample distances are calculated at the level of neighborhoods. As centers of the neighborhoods, a subset of query cells are selected, for which the k nearest neighbors are calculated. The query center cells are randomly selected per cluster of the joint embedding of the reference and query, with the number of query cells sampled per cluster being proportional to the fraction of query and the fraction of reference cells in each cluster. This approach ensures that both cell types abundant in the reference, but less abundant in the query and <italic>vice versa</italic> are well sampled. Specifically, the fraction of the total number of sampled cells per cluster <italic>c</italic> is calculated as follows: <disp-formula id="FD4"><mml:math id="M4"><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>q</mml:mi><mml:mo>,</mml:mo><mml:mi>c</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:mi>c</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mn>2</mml:mn></mml:mfrac></mml:mrow></mml:math></disp-formula></p><p id="P40">where <italic>f<sub>q,c</sub></italic> and <italic>f<sub>r,c</sub></italic> are the fraction of total query and total reference cells, respectively, that are part of cluster <italic>c</italic>. In cases where the target number of query cells to sample from a cluster is lower than the total number of query cells in that cluster, the remainder of cells is sampled from the remaining clusters proportional to their sampling fractions <italic>f<sub>c<sub>i</sub></sub></italic>. In total, 500 neighborhoods are selected per query dataset. This number can be adapted based on the size of the joint reference and query. Note that as the sizes of the neighborhoods are large (see “setting the neighborhood size k” below), these neighborhoods are expected to overlap in many cases. A neighborhood-based approach is also taken by a related method, Milo[<xref ref-type="bibr" rid="R43">43</xref>], which aims to quantify local differential abundance between (groups of) samples, e.g. of different conditions. However, whereas they are similar in their neighborhood-based approach, mapQC and Milo have different goals: Milo quantifies changes in cell abundance, while mapQC is deliberately made insensitive to abundance (number of cells per sample), as these can change depending on sample processing protocol, anatomical location sampled, single-cell method, etc., which are independent of the quality of a specific mapping. Rather, mapQC quantifies the local <italic>distance</italic> between samples, which reflects the mixing of the samples’ cells in the embedding space, as will be discussed below.</p></sec><sec id="S14"><label>4.2</label><title>Setting the neighborhood size k</title><p id="P41">For all organ reference atlases analyzed in this paper, the number of neighbors k per neighborhood was set to 500. The size of k should be set such that each neighborhood encompasses something between a cell type and a cell substate. Setting the k too large will result in inter-sample distances being overshadowed by inter-cell type distances, in cases where cell type sizes are smaller than k, which is not what mapQC tries to quantify. Moreover, a large k is more likely to result in a bi-or multi-modal distribution of cells for a single sample in the embedding space of the neighborhood, which defies mapQC’s assumptions for inter-sample distance calculations. In contrast, setting k too small will fail to capture the general mixing behavior of reference samples for a given cellular phenotype. Note that the k can be adapted to the type of atlas. For example, for single-cell-type atlases (e.g. a NK cell atlas), we recommend using a much larger neighborhood size, such that the chosen k covers biologically relevant subgroups of cells. Additionally, the k of individual neighborhoods can be adapted if these neighborhoods do not pass specific filters, as further described below.</p></sec><sec id="S15"><label>4.3</label><title>Sample and neighborhood filtering and adapting individual neighborhood sizes</title><p id="P42">Briefly, the following filtering and parameter change steps are followed before proceeding to inter-sample distance: 1) in each neighborhood, remove samples with too few cells; 2) identify neighborhoods with too few reference samples; 3) increase neighborhood size for neighborhoods from (2); 4) remove neighborhoods with too few reference samples even after increasing the neighborhood size. More specifically, for step 1, in each neighborhood, samples with fewer than 10 cells are excluded from distance calculations. For steps 2 and 3, for neighborhoods with fewer than 3 reference samples that passed filtering, the k is increased, as the baseline distance between reference samples cannot be reliably assessed for these neighborhoods with the standard neighborhood size. The cells from poorly mapped query datasets will map far from the reference, resulting in such query-only neighborhoods. For these neighborhoods, the final k is set to 1.1 times the neighborhood size needed to reach the minimum number of reference samples per neighborhood. To limit computation time and to prevent neighborhoods from covering multiple cell types at the same time, the maximum k is set to 10 times the original k (e.g. 5000 for a default k of 500). For step 4, a neighborhood is excluded from downstream calculations if it still does not include sufficient reference samples at the maximum k. Note that in many cases, at least part of the cells in those neighborhoods will still be covered by other neighborhoods.</p></sec><sec id="S16"><label>4.4</label><title>Calculating a sample’s distance to the reference</title><p id="P43">To calculate a sample’s distance to the reference in a given neighborhood <italic>h</italic>, the procedure as described below is followed. First, samples that do not pass the above-described filtering are excluded from calculations, such that <italic>S<sub>h</sub></italic> is the set of all samples in the neighborhood <italic>h</italic> that passed filtering. Then, for each sample <italic>s<sub>i</sub> ∈ S<sub>h</sub></italic>, its distance to each sample <italic>S<sub>i</sub> ∈ S<sub>h,r</sub></italic> is calculated, where <italic>i</italic> ≠ <italic>j</italic>, and with <italic>S<sub>h,r</sub></italic> being the set of samples in <italic>S<sub>h</sub></italic> coming from the reference. To calculate the distance between samples, several distance metrics were explored. First, earth-mover’s distance or “Wasserstein distance” was tried, a distance metric which is often used to calculate the distance between two distributions, such as two sets of cells[<xref ref-type="bibr" rid="R44">44</xref>–<xref ref-type="bibr" rid="R46">46</xref>]. However, calculating this distance is computationally expensive, and since the number of times this distance has to be calculated per mapping is approximately <disp-formula id="FD5"><mml:math id="M5"><mml:mrow><mml:mn>2</mml:mn><mml:msub><mml:mi>N</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:msubsup><mml:mi>N</mml:mi><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></disp-formula></p><p id="P44">where <italic>N<sub>n</sub></italic> is the number of neighborhoods and <italic>N<sub>m</sub></italic> is the mean number of samples per neighborhood, using this distance was not computationally feasible: it took more than 48 hours to calculate for a single mapping. As a second alternative, a simple mean pairwise distance metric was considered. This metric can be used to quantify the distance between two sets of cells, but also depends on the variance within these sets: the distance between two groups of cells is zero if and only if their means are equal and they both have a variance of zero. As the primary goal of the metric was to quantify distance between distributions (i.e. lack of mixing) rather than (changes in) variance, we decided against using a simple pairwise distance. Finally, energy distance or “E-distance”[<xref ref-type="bibr" rid="R14">14</xref>] was investigated as a metric to quantify distances between samples. E-distance is a statistical measure of the distance between distributions, intuitively reflecting the signal-to-noise ratio of a specific effect (e.g. of a perturbation) in a given set of data points[<xref ref-type="bibr" rid="R47">47</xref>]. E-distance has been used previously to detect effects of specific perturbations[<xref ref-type="bibr" rid="R15">15</xref>, <xref ref-type="bibr" rid="R48">48</xref>]. Briefly, the E-distance is calculated by taking the mean Euclidean distance between two groups of cells, and then subtracting the mean distance within the two groups. As this metric seemed to be a more accurate formalization of our aim (identifying shifts in distributions between reference and query), we decided to use E-distance as our default distance metric, although other distance metrics are also available to the MapQC user. Specifically, the E-distance between <italic>s<sub>i</sub></italic> and <italic>S<sub>j</sub> E(s<sub>i</sub>, s<sub>j</sub>)</italic> in a given neighborhood is calculated, considering only the cells in that neighborhood, as: <disp-formula id="FD6"><mml:math id="M6"><mml:mrow><mml:mi>E</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mn>2</mml:mn><mml:mi>δ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>σ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>σ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p><p id="P45">where <italic>δ(s<sub>i</sub>,S<sub>j</sub>)</italic> is the mean pairwise distance between the cells from sample <italic>s<sub>i</sub></italic> and sample <italic>s<sub>j</sub></italic>: <disp-formula id="FD7"><mml:math id="M7"><mml:mrow><mml:mi>δ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:munderover><mml:mrow><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:munderover><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mo>‖</mml:mo><mml:mrow><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>c</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>k</mml:mi></mml:mstyle></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>c</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mn>1</mml:mn></mml:mstyle></mml:msub></mml:mrow><mml:mo>‖</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p id="P46">and <italic>σ(s<sub>i</sub>)</italic> is the mean pairwise distance between cells from sample <italic>s<sub>i</sub></italic>: <disp-formula id="FD8"><mml:math id="M8"><mml:mrow><mml:mi>σ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mspace width="0.1em"/><mml:mo>=</mml:mo><mml:mspace width="0.1em"/><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msubsup><mml:mi>n</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:munderover><mml:mrow><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:munderover><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mo>‖</mml:mo><mml:mrow><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>c</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>k</mml:mi></mml:mstyle></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>c</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mn>1</mml:mn></mml:mstyle></mml:msub></mml:mrow><mml:mo>‖</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p id="P47">and where <italic>n<sub>i</sub></italic> is the number of cells in <italic>s<sub>i</sub></italic>. As distances between pairs of cells, the euclidean distance ||c<sub>k</sub> – <bold>c</bold><sub>1</sub>||<sub>2</sub> between the cells in the embedding space is used.</p><p id="P48">The distance of a given query sample <italic>s<sub>i,q</sub></italic> to the reference is then calculated as the mean distance of that sample to all samples from the reference: <disp-formula id="FD9"><mml:math id="M9"><mml:mrow><mml:mi>d</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>q</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mspace width="0.1em"/><mml:mo>=</mml:mo><mml:mspace width="0.1em"/><mml:mfrac><mml:mn>1</mml:mn><mml:mi>r</mml:mi></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>r</mml:mi></mml:munderover><mml:mi>E</mml:mi></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>q</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p><p id="P49">where <italic>r</italic> is the number of samples from the reference in neighborhood <italic>h</italic> that have passed filtering |<italic>S<sub>h,r</sub></italic>|, and <italic>s<sub>j,r</sub></italic> is a sample from the reference. Importantly, to calculate the distance of query samples to the reference, no distances between samples from the same dataset are ever used during the calculation (as the query by definition comes from a different dataset than the reference). To not bias distance to the reference for reference samples, which could be smaller within dataset than between datasets, we therefore exclude reference samples from the same dataset when calculating the distance of any reference sample to the reference, such that: <disp-formula id="FD10"><mml:math id="M10"><mml:mrow><mml:mi>d</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:mtext>ref</mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mspace width="0.1em"/><mml:mo>=</mml:mo><mml:mspace width="0.1em"/><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:mtext>diff</mml:mtext><mml:mspace width="0.1em"/></mml:mrow></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munder><mml:mi>∑</mml:mi><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>∈</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:mtext>diff</mml:mtext><mml:mspace width="0.1em"/></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mi>d</mml:mi></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P50">where <italic>S</italic><sub><italic>r</italic>,diff</sub> is the set of reference samples in <italic>S<sub>h</sub></italic> that are from a different dataset than that of <italic>s<sub>i</sub></italic>.</p></sec><sec id="S17"><label>4.5</label><title>Normalizing distances across neighborhoods</title><p id="P51">Inter-sample distances can differ considerably from neighborhood to neighborhood, both as a result of differences in cell density across the embedding space, and due to lower or higher levels of mixing between samples in different regions of the embedding, e.g. due to cell types showing more or less inter-individual heterogeneity. The goal of mapQC is to establish whether or not query samples mix “normally” with the reference, which is approximated by checking if they are at a ‘normal” distance from the reference. Here, the reference itself is considered the baseline and is therefore used to define what normal inter-sample distances are. Thus, distances to the reference are normalized or “Z-scored” as follows, with all variables below being specific to the neighborhood under consideration: <disp-formula id="FD11"><mml:math id="M11"><mml:mi>n</mml:mi><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>-</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi><mml:mi/></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi><mml:mi/></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:math></disp-formula></p><p id="P52">where <disp-formula id="FD12"><mml:math id="M12"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi><mml:mi/></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>r</mml:mi></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>r</mml:mi></mml:munderover><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P53">and <disp-formula id="FD13"><mml:math id="M13"><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi><mml:mi/></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mi>r</mml:mi></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>r</mml:mi></mml:munderover><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>-</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi><mml:mi/></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mstyle></mml:mrow></mml:msqrt></mml:math></disp-formula></p><p id="P54">such that the normalized distances of the reference samples to the reference in any given neighborhood have a mean of 0 and a standard deviation of one. In cases of extreme outliers among the reference samples, these outliers are removed from the above calculation of the mean and standard deviation, such that normalized distances are not heavily affected by single outliers in the data. Outliers are defined as any points more than 3.5 times the inter-quartile range (IQR) above the third quartile of reference sample distances to the reference, or more than 3.5 times the IQR below the first quartile.</p></sec><sec id="S18"><label>4.6</label><title>MapQC score calculation</title><p id="P55">The mapQC score for a given query cell <italic>c<sub>i,s</sub></italic> quantifies how well the sample <italic>s</italic> from which that cell came mixes with the reference in the region around cell <italic>c<sub>i,s</sub></italic>. The mapQC score is therefore calculated as the mean distance to the reference of sample s across the set of all neighborhoods that cell <italic>c<sub>i,s</sub></italic> is part of (<italic>N<sub>c</sub></italic>): <disp-formula id="FD14"><mml:math id="M14"><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>p</mml:mi><mml:mi>Q</mml:mi><mml:mi>C</mml:mi><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:msub><mml:mi>e</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>N</mml:mi><mml:mi>c</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>N</mml:mi><mml:mi>c</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:munderover><mml:mrow><mml:mi>n</mml:mi><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi/><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p><p id="P56">Note that due to the stochastic nature of the mapQC algorithm (sampling a random subset of query cells as neighborhood centers), in some cases cells will not have a mapQC score. This can be e.g. because all neighborhoods it was part of were filtered out, or because it was not part of any neighborhood. If this is the case for many cells, the neighborhood size or number might need to be increased.</p></sec><sec id="S19"><label>4.7</label><title>Query-to-reference mapping with scArches</title><p id="P57">As currently available large healthy reference atlases are almost all integrated with scVI or related methods[<xref ref-type="bibr" rid="R1">1</xref>, <xref ref-type="bibr" rid="R17">17</xref>, <xref ref-type="bibr" rid="R34">34</xref>, <xref ref-type="bibr" rid="R49">49</xref>–<xref ref-type="bibr" rid="R51">51</xref>], all reference atlases used in this paper had also been integrated with scVI[<xref ref-type="bibr" rid="R11">11</xref>] or scANVI[<xref ref-type="bibr" rid="R52">52</xref>]. Mapping was therefore done exclusively with scArches[<xref ref-type="bibr" rid="R8">8</xref>], currently the only query-to-reference mapping method available that is compatible with conditional variational autoencoder-based integrations such as those generated with scVI and scANVI. For the mapping, raw counts were used, subsetted to the input genes of the base integration model. For the mapping of the IPF lung query dataset[<xref ref-type="bibr" rid="R16">16</xref>], raw counts were taken directly from the Human Lung Cell Atlas[<xref ref-type="bibr" rid="R6">6</xref>]. For re-mapping of that same data with counts recovered from 69 genes that had gone missing during gene name conversion for upload of the HLCA to cellxgene, the original counts were used as made available with the original query publication (GSE132771). For the mapping of the Asherman’s syndrom query dataset[<xref ref-type="bibr" rid="R18">18</xref>], controls that were included in the data but that were generated as part of a different dataset originally were excluded, as mapQC assumes similar sample handling across samples from the same dataset. As base integration models, the reference model of the HLCA[<xref ref-type="bibr" rid="R6">6</xref>] was used for the lung IPF data query, and the scANVI reference model of the HECA developed for reference mapping [<xref ref-type="bibr" rid="R17">17</xref>] was used for the endometrial Asher-man Syndrome data query. Batch covariate was set as indicated in the main text, as dataset or sample for the IPF query, and as sample for the Asherman Syndrome query. No cell type labels were included for the mapping. The following parameter settings were used for the mapping: number of epochs: 500, weight decay: 0, and maximum KL weight set to default 1 unless specified otherwise.</p></sec><sec id="S20"><label>4.8</label><title>Count pre-processing, clustering, and visualization of joint reference and query</title><p id="P58">For the HLCA core reference and the mapped query, normalized and log-transformed counts were directly taken from the HLCA[<xref ref-type="bibr" rid="R6">6</xref>]. For the HECA, non-control samples in the reference (i.e. from donors with endometriosis) were excluded from all downstream analyses, as mapQC works under the assumption that the reference includes control samples only. For both the HECA reference and the Asherman Syndrom query dataset, raw counts were normalized to 10,000 counts per cell, and then log-transformed using the natural log and a pseudo-count of 1. For all mapping-derived joint reference and query embeddings, a knn-graph was constructed based on the embedding using the scanpy package[<xref ref-type="bibr" rid="R53">53</xref>] setting the number of neighbors k=30 for the HECA, and k=50 for the HLCA mappings, and with default settings otherwise. To cluster the data, leiden clustering[<xref ref-type="bibr" rid="R54">54</xref>] was performed based on the kNN-graph, using the scanpy package with default settings. For data visualization, a UMAP embedding[<xref ref-type="bibr" rid="R55">55</xref>] was calculated based on the kNN graph using the scanpy package with default settings.</p></sec><sec id="S21"><label>4.9</label><title>Cell type label transfer from reference to query</title><p id="P59">To annotate cells in the query, cell type label transfer was performed from the reference to the query for all mapped datasets. For each cell in the query, its k (30 for HECA, 50 for HLCA) nearest neighbors in the reference were calculated based on the joint embedding derived from the mapping. To reduce computation time, the pynndescent package[<xref ref-type="bibr" rid="R56">56</xref>] (specifically the PyNNDescentTransformer function) was used to identify, and calculate Euclidean distances to the k nearest neighbors. For each query cell, the probability of the cell being of cell type <italic>l (pl)</italic> was then calculated as follows: <disp-formula id="FD15"><mml:math id="M15"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mstyle displaystyle="true"><mml:msubsup><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msubsup><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:mrow><mml:mrow><mml:mstyle displaystyle="true"><mml:msubsup><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>k</mml:mi></mml:msubsup><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:mrow></mml:mfrac></mml:mrow></mml:math></disp-formula></p><p id="P60">where <italic>k</italic> is the total number of neighbors, <italic>n<sub>l</sub></italic> is the number of neighbors with cell type label l, and <italic>d<sub>i</sub></italic> is the distance of neighbor i to the query cell. Each cell was then labeled as the cell type with the highest probability for that cell.</p></sec><sec id="S22"><label>4.10</label><title>Downstream analysis of IPF query-to-reference mappings</title><p id="P61">For the first mapping (used as an example of failed mapping) of the IPF query dataset[<xref ref-type="bibr" rid="R16">16</xref>], with default mapping parameters and treating all samples as a single batch (batch covariate “dataset”), endothelial cells were clustered as follows: first, all endothelial cells (excluding lymphatic endothelium) were selected based on their level 2 annotation in the reference (“blood vessels”) or based on the transferred annotation in the query. The resulting subset of cells was re-clustered by first re-calculating a kNN-graph based on the embedding as described above, with the number of neighbors k=30, and then performing Leiden clustering as described above with resolution=0.3. To identify differentially expressed genes, log-normalized gene expression of the cluster containing almost exclusively and almost all endothelial cells from the donors with IPF (cluster 6) was compared to gene expression in all other endothelial cells using a t-test (<xref ref-type="supplementary-material" rid="SD1">Supplementary table 1</xref>). P-value correction for multiple tests was done using the Benjamini-Hochberg procedure. The resulting gene list was loosely filtered based on the following criteria, to select the most relevant differentially expressed genes: minimum fraction of cells within the cluster expressing the gene: 0.25, minimum fold change: 1 (i.e. only up-regulated genes), maximum fraction of cells outside of the cluster expressing the gene: 0.5. Finally, to ensure that differentially expressed genes identified as possible batch-effect related genes were actually used during the mapping and could therefore have changed the embedding of the cells, we subsetted the resulting gene list to only genes that were used during the mapping. For visualization (<xref ref-type="fig" rid="F2">fig. 2e</xref>, <xref ref-type="fig" rid="F6">Extended Data fig. 2e,f</xref>), the top 30 genes that passed filtering were taken, after which genes not used for mapping were excluded, such that 10 genes remained. Marker genes shown in the figure were taken from the HLCA marker gene set[<xref ref-type="bibr" rid="R6">6</xref>]. For the second mapping (used as an example of a successful mapping), with the batch covariate set to sample and a larger set of genes included for the mapping, endothelial cells were clustered exactly as described for the previous mapping. For the smooth muscle analysis, query smooth muscle cells with high mapQC scores (&gt;2) were compared to query smooth muscle cells with low mapQC scores (&lt;2) (<xref ref-type="supplementary-material" rid="SD2">Supplementary table 2</xref>), after which the results were filtered as described above (minimum ingroup fraction 0.25, maximum out-group fraction 0.5) and keeping only genes with Benjamini-Hochberg multiple testing-corrected p-values below 0.05. From the resulting list of 50 genes, the genes most unique for the high mapQC score query cells (compared to all other stromal subgroups) were selected based on visual inspection and used for visualization (<xref ref-type="fig" rid="F3">fig. 3e</xref>) and for comparison to other datasets (<xref ref-type="fig" rid="F8">Extended Data fig. 4e</xref>). For comparison to other datasets, all datasets in the HLCA[<xref ref-type="bibr" rid="R6">6</xref>] that included smooth muscle cells from both healthy donors and donors with IPF were taken (“Sheppard_2020” is the mapped query[<xref ref-type="bibr" rid="R16">16</xref>], other studies: Banovich_2020[<xref ref-type="bibr" rid="R22">22</xref>, <xref ref-type="bibr" rid="R23">23</xref>], Kaminski_2020[<xref ref-type="bibr" rid="R24">24</xref>], Misharin_Budinger_2018[<xref ref-type="bibr" rid="R29">29</xref>]), and pre-processed gene counts from the published HLCA were used for visualization of gene expression (<xref ref-type="fig" rid="F8">Extended Data fig. 4e</xref>). For the analysis of <italic>CTHRC1</italic>-high cells, all cells labeled as stromal except for mesothelium cells were re-clustered in the same way as described above for the endothelial cells. To determine which samples from both the reference and query showed high <italic>CTHRC1</italic> expression, cells were then subset to only the fibroblast cluster containing the far majority of <italic>CTHRC1</italic>-high cells. <italic>CTHRC1</italic>-expression for cells in this cluster is shown per donor in <xref ref-type="fig" rid="F3">fig. 3h</xref> and <xref ref-type="fig" rid="F8">Extended Data fig. 4h</xref>.</p></sec><sec id="S23"><label>4.11</label><title>4.11 Downstream analysis of Asherman Syndrome query-to-reference mapping</title><p id="P62">To compare gene expression of cells in cluster 21 (containing many query cells with high mapQC scores) to that of other cells, a differential gene expression analysis was performed comparing cells in cluster 21 to all other cells in the joint reference and query, including only genes that were detected in at least one cell in both the reference and the query, using a t-test (<xref ref-type="supplementary-material" rid="SD3">Supplementary table 3</xref>). P-value correction for multiple tests was done using the Benjamini-Hochberg procedure. The results were then loosely filtered such that only genes expressed in at least 25% of cells within cluster 21, and expressed in at most 50% of cells outside of cluster 21, and with a mean expression higher inside than outside the cluster were kept (i.e. only up-regulated genes). The resulting set of 12 genes was largely widely expressed in either the stromal or the epithelial subset of all cells, while being jointly expressed in cluster 21. The 8 genes for which this was most clearly the case are shown in <xref ref-type="fig" rid="F2">fig. 2h</xref> and labeled as “stromal (up in 21)” and “epithelial (up in 21 q. disease)”. A second differential gene expression analysis was performed to identify genes down-regulated in query cells from cluster 21 compared to query cells only from all other clusters as described above (<xref ref-type="supplementary-material" rid="SD4">Supplementary table 4</xref>). The resulting list of differentially expressed genes was stringently filtered, such that only genes being expressed in at least 50% of cells outside of the cluster, and in no more than 50% of cells within the cluster were kept, and only genes with a mean expression higher outside of the cluster than inside. Of the resulting 19 genes, 7 were excluded as these were expressed in subsets of cells outside of the cluster based on visual inspection. The remaining 12 genes are shown in <xref ref-type="fig" rid="F2">fig. 2h</xref> and labeled as “ubiquitous (down in cl. 21 query)”.</p></sec><sec id="S24"><label>4.12</label><title>Comparison to commonly used integration and mapping metrics</title><p id="P63">To compare mapQC to existing mapping and integration metrics, we calculated scores for five other metrics: within-query-kNN correlation, cluster preservation, donor LISI, batch LISI, and kBET. Importantly, in order to make a fair comparison to mapQC, in cases where the metric as previously used consisted of a single value per dataset, we used the metric at the cell level, i.e. before summarizing per-cell values in a single dataset score. Finally, we used parameter settings as used in the original metric calculations to obtain the best possible version of the score, resulting in slightly different pre-processing per metric as further specified below. As an example of a good mapping, we took the best-performing mapping of the IPF query dataset[<xref ref-type="bibr" rid="R16">16</xref>] in terms of mapQC scores, i.e. with sample as batch covariate, maximum KL divergence set to 1 during mapping, and with 69 more input genes recovered as compared to the cellxgene HLCA counts matrix. As an example of a bad mapping, we took the worst-performing mapping of the same dataset, i.e. with dataset as batch covariate, the maximum KL divergence set to 2 for the mapping, and using the HLCA cellxgene counts matrix (i.e. 69 input genes missing).</p><p id="P64">The <bold>within-query kNN-correlation</bold> (wiq-kNN-corr) score, used to quantify mapping quality with the query-to-reference method Symphony, was calculated as previously described[<xref ref-type="bibr" rid="R9">9</xref>]. This score aims to quantify preservation of the local embedding structure of the query by comparing the distance to each cell’s k nearest neighbors in two embeddings. Specifically, a principal component analysis (PCA) was performed on the normalized, log-transformed query count matrix. The first 50 principal components were subsequently used to calculate Euclidean distances to the 500 nearest neighbors for each query cell. Then, the same distances (between all query cells and their original 500 nearest neighbors) were calculated in the embedding space resulting from the mapping. To determine how well the neighborhood structure was preserved for each cell after mapping, the distances in the two different embeddings were compared using Spearman correlation, such that perfect correlation would result in the maximum score of 1 for a given cell.</p><p id="P65">Similar to the wiq-kNN-corr score, the <bold>cluster preservation</bold> score aims to quantify embedding similarity in two different embeddings of the same data using clustering. The cluster preservation score is a mapping quality metric used for Seurat’s Azimuth query to reference mapping method[<xref ref-type="bibr" rid="R10">10</xref>, <xref ref-type="bibr" rid="R12">12</xref>]. Specifically, the normalized, log-transformed gene expression matrix of the query dataset was scaled per gene such that each gene’s mean and variance were 0 and 1, respectively. Then, a PCA was performed on the scaled count matrix, and the first 50 components were used for the rest of the analysis (embedding 1). The 20 nearest neighbors of each cell were calculated based on the PCA embedding, and cells were then clustered using the Louvain algorithm[<xref ref-type="bibr" rid="R57">57</xref>] with the resolution parameter set to 0.6. To calculate the cluster entropy in the original PCA embedding, for each cell the frequency of each cluster label was determined among its 20 nearest neighbors. Cluster entropy <italic>H</italic> for this cell was then calculated using Shannon entropy: <disp-formula id="FD16"><mml:math id="M16"><mml:mrow><mml:mi>H</mml:mi><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:munderover><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:mstyle><mml:mi>log</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:math></disp-formula></p><p id="P66">where m is the number of distinct cluster labels observed among the cells nearest neighbors, and <italic>p<sub>ci</sub></italic> is the proportion of cells among the nearest neighbors from cluster <italic>c<sub>i</sub></italic>.</p><p id="P67">Then, the same was done using the mapping-based embedding (embedding 2), calculating each cell’s 20 nearest neighbors and calculating cluster entropy for each cell based on its neighbors and the original cluster labels (from embedding 1). To compare how well the new embedding had preserved the structure of the original embedding, the difference in clustering entropy was calculated for each cell as: <disp-formula id="FD17"><mml:math id="M17"><mml:mrow><mml:msub><mml:mi>δ</mml:mi><mml:mi>H</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mrow><mml:mi>e</mml:mi><mml:mi>m</mml:mi><mml:mi>b</mml:mi><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mrow><mml:mi>e</mml:mi><mml:mi>m</mml:mi><mml:mi>b</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:math></disp-formula></p><p id="P68">The final cluster preservation score per cell was then calculated by setting the score to the maximum value of 5 if the entropy was lower in the new than in the original embedding (i.e. <italic>δ<sub>H</sub></italic> &lt; 0), or re-scaling otherwise: <disp-formula id="FD18"><mml:math id="M18"><mml:mrow><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mspace width="0.1em"/><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtable columnalign="left"><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mn>5</mml:mn></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mspace width="0.1em"/><mml:mtext>if</mml:mtext><mml:mspace width="0.1em"/><mml:msub><mml:mi>δ</mml:mi><mml:mi>H</mml:mi></mml:msub><mml:mo>&lt;</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mn>5</mml:mn></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mspace width="0.1em"/><mml:mtext>if</mml:mtext><mml:mspace width="0.1em"/><mml:mi>s</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>5</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mn>0</mml:mn></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mspace width="0.1em"/><mml:mtext>if</mml:mtext><mml:mspace width="0.1em"/><mml:mi>s</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mi>s</mml:mi></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mspace width="0.1em"/><mml:mtext>if</mml:mtext><mml:mspace width="0.1em"/><mml:mn>0</mml:mn><mml:mo>≤</mml:mo><mml:mspace width="0.1em"/><mml:mi>s</mml:mi><mml:mspace width="0.1em"/><mml:mo>≤</mml:mo><mml:mn>5</mml:mn></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow></mml:mrow></mml:math></disp-formula></p><p id="P69">where <disp-formula id="FD19"><mml:math id="M19"><mml:mrow><mml:mspace width="0.1em"/><mml:mi>s</mml:mi><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>log</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>δ</mml:mi><mml:mi>H</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P70">The <bold>kBET</bold> score was calculated as previously described[<xref ref-type="bibr" rid="R13">13</xref>]. Specifically, the 50 nearest neighbors were calculated for each query cell, after which a chi-square test was used to compare the observed reference and query cell frequency in the cell’s neighborhood to the overall reference and query cell frequency across all cells. The resulting p-values were then reported as cell-level scores.</p><p id="P71">The Local Inverse Simpson’s Index (LISI) scores, <bold>donor LISI</bold> and <bold>batch LISI</bold>, were calculated as previously described[<xref ref-type="bibr" rid="R9">9</xref>, <xref ref-type="bibr" rid="R58">58</xref>]. LISI quantifies how many cells can be drawn from a group of neighbors before the same group (e.g. donor, batch) is observed twice. Specifically, for donor LISI scores, a kNN graph was constructed with number of neighbors k=30 using the embedding from the mapping, and taking only the query cells into account. The donor LISI score per cell was then calculated (ranging from 1 to N, where N is the number of donors in the query), after which the results were rescaled such that they ranged from 0 to 1, as follows: <disp-formula id="FD20"><mml:math id="M20"><mml:mrow><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mspace width="0.1em"/><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>l</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac></mml:mrow></mml:math></disp-formula></p><p id="P72">where l is the original, non-normalized LISI score, and n is the total number of groups (donors in this case).</p><p id="P73">Similarly, the batch LISI score was calculated on the combined query and reference, first constructing a kNN graph with number of neighbors k=90 using the mapping-based embedding, after which the LISI score was calculated for each cell, now using only two groups: reference or query. The final batch LISI score per cell was then obtained by normalizing for the donor LISI score.</p><p id="P74">For determining the robustness of the batch LISI score and mapQC score to changes in query cell numbers, the “successful” mapping of the mapped IPF dataset[<xref ref-type="bibr" rid="R16">16</xref>] was used, i.e. the mapping as shown in <xref ref-type="fig" rid="F3">fig. 3</xref>, and only query control cells were included and randomly down-sampled twice to both 10% and 1% of the total number of query cells.</p></sec><sec id="S25"><label>4.13</label><title>Software versions</title><p id="P75">For all preprocessing, MapQC runs, and downstream analyses: anndata: 0.10.9; leidenalg: 0.10.1; pynndescent: 0.5.10; python: 3.9.0; scanpy: 1.10.3; scikit-learn: 1.3.0; scipy: 1.11.2; umap-learn: 0.5.3. For all query-to-reference mappings, and for the comparison to existing metrics: python: 3.8, scanpy: 1.9.2; scarches 0.5.7, scib-metrics: 0.5.1, scvi-tools 0.20.1.</p></sec></sec><sec sec-type="extended-data" id="S26"><title>Extended Data</title><fig id="F5" position="anchor"><label>Extended Data Figure 1</label><caption><title>Sample absolute distances to the reference highly vary across neighborhoods.</title><p id="P76">Each neighborhood is labeled based on the cell type of its center cell. Distances are shown for reference samples (grey) and query samples (blue). Neighborhoods are ordered based on the mean distance to the reference among reference samples. Boxes show the median and interquartile range. Whiskers extend to the lowest and highest non-outlier points, with data points more than 1.5 times the interquartile range outside the low and high quartile considered outliers.</p></caption><graphic xlink:href="EMS206022-f005"/></fig><fig id="F6" position="anchor"><label>Extended Data Figure 2</label><caption><title>Clustering and marker gene expression among query and reference cell subsets of a failed mapping.</title><p id="P77"><bold>a,</bold> UMAP of a query dataset with data from IPF donors and controls mapped onto the Human Lung Cell Atlas reference. Cells are colored by cell type. Query data was annotated by performing label transfer from the reference to the query. <bold>b,</bold> Query cell mapQC scores shown per cell type. A horizontal red dotted line indicates the cutoff value of 2, above which cells are considered not to mix well with the reference. Boxes are included for all groups of at least 100 cells, show the median and interquartile range. Whiskers extend to the lowest and highest non-outlier points, with data points more than 1.5 times the interquartile range outside the low and high quartile considered outliers. <bold>c,</bold> Cluster composition by EC subtype of blood vessel endothelial cell clusters, <bold>d,</bold> Expression of blood vessel subtype marker genes per annotation, split by reference (annotation) and query. Cell annotations with fewer than 50 cells were excluded. <bold>e,</bold> Expression of genes differentially highly expressed in cluster 6 -dominated by query IPF cells. Expression is shown for all EC clusters, split by reference (all controls), query controls and query IPF. Groups with fewer than 50 cells were excluded. <bold>f,</bold> Expression across all cell types of genes differentially expressed in query IPF blood vessel cells as compared to other blood vessel cells (see (d)). Note that query stromal cells (pericytes, fibroblasts, smooth muscle and mesothelium) largely came from separate, stromal lineage-enriched samples, therefore showing independent ambient RNA patterns. Only groups with at least 200 cells are shown. For (c-e), gene expression values were normalized per gene, such that minimum and maximum expression were set to 0 and 1, respectively.</p></caption><graphic xlink:href="EMS206022-f006"/></fig><fig id="F7" position="anchor"><label>Extended Data Figure 3</label><caption><title>Details of the mapping of a query dataset of donors with Asherman syndrome onto the Human Endometrial Cell Atlas (HECA) reference.</title><p id="P78"><bold>a</bold>, UMAP of the joint reference and query. Cells are colored by lineage. Query cells were annotated based on label transfer from the reference. <bold>b</bold>, As (a), now coloring cells by cell type. <bold>c</bold>, MapQC scores of mapped query cells, grouped by cell type. Cells are split into cells from control donors (light blue) or cells from donors with Asherman Syndrome (dark blue). A red dashed horizontal line shows the mapQC score cutoff value of two. <bold>d</bold>, As (c), now grouping cells by cluster. <bold>e</bold>, UMAP of the joint reference and query (as in (a)), now showing the location of the two clusters with the highest mapQC scores (21 and 25, yellow and ochre yellow, respectively) in the UMAP <bold>f,</bold> Composition of cluster 21, 25, and the rest of the cells by group, with groups being reference (grey), query controls (light blue), and query Asherman syndrome (dark blue). <bold>g</bold>, Log 10 of the total number of RNA counts per cell in the query dataset, grouping cells by cluster, showing only clusters with at least 50 cells from the query data. <bold>h,</bold> Expression of MALAT1 per cell in the query datasets, grouping cells by cluster as in (g). <bold>i</bold>, Marker gene expression (marker gene set based on HECA markers) among all cell types in the joint reference and query, showing cells from cluster 21 and 25 separately, and splitting the latter two into cells from the reference (“r control”), from query control donors (“q control”), and query donors with Asherman syndrome (“q Asherman’s syndrome). Expression values are normalized per gene, such that the minimum and maximum expression are set to 0 and 1, respectively. For all box plots, boxes are included for all groups with at least 50 cells. The boxes show the median and interquartile range. Whiskers extend to the lowest and highest non-outlier points, with data points more than 1.5 times the interquartile range outside the low and high quartile considered outliers.</p></caption><graphic xlink:href="EMS206022-f007"/></fig><fig id="F8" position="anchor"><label>Extended Data Figure 4</label><caption><title>Details of a successful mapping of a query dataset of donors with IPF onto the HLCA.</title><p id="P79"><bold>a</bold>, UMAP of the joint reference and query, colored by cell type. Query cells were annotated by performing label transfer from the query to the reference. <bold>b</bold>, Query mapQC scores of mapped cells shown per cell type, split into control and case (IPF) cells. A horizontal red dotted line indicates the cutoff value of 2, above which cells are considered not to mix well with the reference. Boxes are shown for groups with at least 100 cells. <bold>c</bold>, Composition of blood vessel endothelial cell clusters by subgroup, breaking cells down by reference or query and lung condition (reference controls (grey), query controls (light blue), and query IPF (dark blue)). <bold>d</bold>, MapQC scores among smooth muscle cells, splitting cells by donor, with boxes for query controls colored in light blue (left three boxes) and for query donors with IPF in dark blue (right three boxes). <bold>e</bold>, Expression of general smooth muscle cell markers and genes up-regulated in high mapQC score smooth muscle cells from the mapped query dataset (“Sheppard_2020”). Expression is shown across several datasets from studies including donors with IPF and controls. Cells are grouped by study, and then by lung condition. <bold>f</bold>, UMAP of the joint reference and query, colored by <italic>CTHRC1</italic> expression, a marker identified as IPF-specific in the original query publication. <bold>g</bold> UMAP as in (e), now showing the location of the fibroblast cluster high in CTHRC1. <bold>h</bold>, CTHRC1 expression among donors with at least 10 cells in the cluster from (f). Boxes are grey for donors from the reference, light blue for query control donors, and dark blue for query donors with IPF. X tick labels show the donor’s lung condition, the study from which the donor came, and the number of cells the donor had in the cluster. For box plots in (c) and (g), the boxes show the median and interquartile range. Whiskers extend to the lowest and highest non-outlier points, with data points more than 1.5 times the interquartile range outside the low and high quartile considered outliers.</p></caption><graphic xlink:href="EMS206022-f008"/></fig><fig id="F9" position="anchor"><label>Extended Data Figure 5</label><caption><title>The number of query cells dramatically changes the batch LISI scores, while having a small effect on mapQC scores.</title><p id="P80">Scores were calculated twice on the full query control data (blue boxes), on the control data randomly down-sampled twice to 10% of cells (green boxes), and to 1% of cells (purple boxes). Results are show only for cell types that had at least 50 cells remaining after a specific down-sampling. Top panel: mapQC scores, with a dashed line showing the threshold value of 2. Bottom: batch LISI scores, treating reference and query as batches. Boxes show the median and interquartile range. Whiskers extend to the lowest and highest non-outlier points, with data points more than 1.5 times the interquartile range outside the low and high quartile considered outliers, which are not shown.</p></caption><graphic xlink:href="EMS206022-f009"/></fig></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary Table 1</label><media xlink:href="EMS206022-supplement-Supplementary_Table_1.csv" mimetype="text" mime-subtype="csv; charset=utf-8" id="d62aAcFbB" position="anchor"/></supplementary-material><supplementary-material content-type="local-data" id="SD2"><label>Supplementary Table 2</label><media xlink:href="EMS206022-supplement-Supplementary_Table_2.csv" mimetype="text" mime-subtype="csv; charset=utf-8" id="d62aAcFcB" position="anchor"/></supplementary-material><supplementary-material content-type="local-data" id="SD3"><label>Supplementary Table 3</label><media xlink:href="EMS206022-supplement-Supplementary_Table_3.csv" mimetype="text" mime-subtype="csv; charset=utf-8" id="d62aAcFdB" position="anchor"/></supplementary-material><supplementary-material content-type="local-data" id="SD4"><label>Supplementary Table 4</label><media xlink:href="EMS206022-supplement-Supplementary_Table_4.csv" mimetype="text" mime-subtype="csv; charset=utf-8" id="d62aAcFeB" position="anchor"/></supplementary-material></sec></body><back><ack id="S27"><title>Acknowledgments</title><p>We thank Lennard Halle, Michaela Müller and Chelsea Bright for feedback on the manuscript, Dominik Klein for help with implementing Jax-based Sinkhorn distance as part of mapQC’s distance metric comparisons, Eljas Roellin for the suggestion to use Energy distance as a distance metric, and Ronan Le Gleut from the Core Facility Statistical Consulting at Helmholtz Munich for statistical advice.</p><sec id="S28"><title>Funding</title><p>This work was supported by the German Federal Ministry of Education and Research (BMBF) under grant no. 81Z0600106, the Chan Zuckerberg Initiative grant no. 5123688, the European Union (ERC, DeepCell - 101054957), and the Deutsche Forschungsgemeinschaft (DFG) - Project number 458958943, grant number 5010338.</p></sec></ack><sec id="S29" sec-type="data-availability"><title>Code availability</title><p id="P81">The mapQC package can be found under <ext-link ext-link-type="uri" xlink:href="https://github.com/theislab/mapqc/">https://github.com/theislab/mapqc/</ext-link>. All code used for results in this manuscript can be found under <ext-link ext-link-type="uri" xlink:href="https://github.com/theislab/mapqc_reproducibility/tree/v0.1.0-manuscript">https://github.com/theislab/mapqc_reproducibility/tree/v0.1.0-manuscript</ext-link>.</p></sec><fn-group><fn id="FN1" fn-type="conflict"><p id="P82"><bold>Competing interests.</bold> F.J.T. consults for Immunai Inc., CytoReason Ltd, Cellarity, BioTuring Inc., and Genbio.AI Inc., and has an ownership interest in Dermagnostix GmbH and Cellarity.</p></fn><fn id="FN2"><p id="P83"><bold>Supplementary information.</bold> Supplementary Information includes <xref ref-type="supplementary-material" rid="SD1">supplementary table 1</xref> to <xref ref-type="supplementary-material" rid="SD4">4</xref>.</p></fn><fn id="FN3" fn-type="con"><p id="P84"><bold>Authors’ contributions.</bold> L.S. and F.J.T. conceived of the initial idea for the project. L.S., M.L. and D.S. conceptualized the project. L.S. implemented the project, with contributions from M.L. and D.S. A.A.M. implemented and organized code for comparison to existing integration metrics. J.E. contributed to reference atlas search and setup. L.S. wrote the manuscript with contributions from A.A.M., D.S, and F.J.T. All authors read and provided feedback on the manuscript.</p></fn></fn-group><ref-list><ref id="R1"><label>[1]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hrovatin</surname><given-names>K</given-names></name><name><surname>Sikkema</surname><given-names>L</given-names></name><name><surname>Shitov</surname><given-names>VA</given-names></name><name><surname>Heimberg</surname><given-names>G</given-names></name><name><surname>Shulman</surname><given-names>M</given-names></name><name><surname>Oliver</surname><given-names>AJ</given-names></name><name><surname>Mueller</surname><given-names>MF</given-names></name><name><surname>Ibarra</surname><given-names>IL</given-names></name><name><surname>Wang</surname><given-names>H</given-names></name><name><surname>Ramírez-Suastegui</surname><given-names>C</given-names></name><name><surname>He</surname><given-names>P</given-names></name><etal/></person-group><article-title>Considerations for building and using integrated single-cell atlases</article-title><source>Nature Methods</source><year>2024</year><volume>22</volume><issue>1</issue><fpage>41</fpage><lpage>57</lpage><pub-id pub-id-type="pmid">39672979</pub-id></element-citation></ref><ref id="R2"><label>[2]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Galimberti</surname><given-names>M</given-names></name><name><surname>Nucera</surname><given-names>MR</given-names></name><name><surname>Bocchi</surname><given-names>VD</given-names></name><name><surname>Conforti</surname><given-names>P</given-names></name><name><surname>Vezzoli</surname><given-names>E</given-names></name><name><surname>Cereda</surname><given-names>M</given-names></name><name><surname>Maffezzini</surname><given-names>C</given-names></name><name><surname>lennaco</surname><given-names>R</given-names></name><name><surname>Scolz</surname><given-names>A</given-names></name><name><surname>Falqui</surname><given-names>A</given-names></name><name><surname>Cordiglieri</surname><given-names>C</given-names></name><etal/></person-group><article-title>Huntington’s disease cellular phenotypes are rescued non-cell autonomously by healthy cells in mosaic telen-cephalic organoids</article-title><source>Nature Communications</source><year>2024</year><volume>15</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC11297310</pub-id><pub-id pub-id-type="pmid">39095390</pub-id><pub-id pub-id-type="doi">10.1038/s41467-024-50877-x</pub-id></element-citation></ref><ref id="R3"><label>[3]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lang</surname><given-names>NJ</given-names></name><name><surname>Gote-Schniering</surname><given-names>J</given-names></name><name><surname>Porras-Gonzalez</surname><given-names>D</given-names></name><name><surname>Yang</surname><given-names>L</given-names></name><name><surname>De Sadeleer</surname><given-names>LJ</given-names></name><name><surname>Jentzsch</surname><given-names>RC</given-names></name><name><surname>Shitov</surname><given-names>VA</given-names></name><name><surname>Zhou</surname><given-names>S</given-names></name><name><surname>Ansari</surname><given-names>M</given-names></name><name><surname>Agami</surname><given-names>A</given-names></name><name><surname>Mayr</surname><given-names>CH</given-names></name><etal/></person-group><article-title>Ex vivo tissue perturbations coupled to single-cell rna-seq reveal multilineage cell circuit dynamics in human lung fibrogenesis</article-title><source>Science Translational Medicine</source><year>2023</year><volume>15</volume><issue>725</issue><pub-id pub-id-type="pmid">38055803</pub-id></element-citation></ref><ref id="R4"><label>[4]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yuan</surname><given-names>F</given-names></name><name><surname>Gasser</surname><given-names>GN</given-names></name><name><surname>Lemire</surname><given-names>E</given-names></name><name><surname>Montoro</surname><given-names>DT</given-names></name><name><surname>Jagadeesh</surname><given-names>K</given-names></name><name><surname>Zhang</surname><given-names>Y</given-names></name><name><surname>Duan</surname><given-names>Y</given-names></name><name><surname>Ievlev</surname><given-names>V</given-names></name><name><surname>Wells</surname><given-names>KL</given-names></name><name><surname>Rotti</surname><given-names>PG</given-names></name><name><surname>Shahin</surname><given-names>W</given-names></name><etal/></person-group><article-title>Transgenic ferret models define pulmonary ionocyte diversity and function</article-title><source>Nature</source><year>2023</year><volume>621</volume><issue>7980</issue><fpage>857</fpage><lpage>867</lpage><pub-id pub-id-type="pmcid">PMC10533402</pub-id><pub-id pub-id-type="pmid">37730992</pub-id><pub-id pub-id-type="doi">10.1038/s41586-023-06549-9</pub-id></element-citation></ref><ref id="R5"><label>[5]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dann</surname><given-names>E</given-names></name><name><surname>Cujba</surname><given-names>A-M</given-names></name><name><surname>Oliver</surname><given-names>AJ</given-names></name><name><surname>Meyer</surname><given-names>KB</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name><name><surname>Marioni</surname><given-names>JC</given-names></name></person-group><article-title>Precise identification of cell states altered in disease using healthy single-cell references</article-title><source>Nature Genetics</source><year>2023</year><volume>55</volume><issue>11</issue><fpage>1998</fpage><lpage>2008</lpage><pub-id pub-id-type="pmcid">PMC10632138</pub-id><pub-id pub-id-type="pmid">37828140</pub-id><pub-id pub-id-type="doi">10.1038/s41588-023-01523-7</pub-id></element-citation></ref><ref id="R6"><label>[6]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sikkema</surname><given-names>L</given-names></name><name><surname>Ramírez-Suástegui</surname><given-names>C</given-names></name><name><surname>Strobl</surname><given-names>DC</given-names></name><name><surname>Gillett</surname><given-names>TE</given-names></name><name><surname>Zappia</surname><given-names>L</given-names></name><name><surname>Madissoon</surname><given-names>E</given-names></name><name><surname>Markov</surname><given-names>NS</given-names></name><name><surname>Zaragosi</surname><given-names>L-E</given-names></name><name><surname>Ji</surname><given-names>Y</given-names></name><name><surname>Ansari</surname><given-names>M</given-names></name><name><surname>Arguel</surname><given-names>M-J</given-names></name><etal/></person-group><article-title>An integrated cell atlas of the lung in health and disease</article-title><source>Nature Medicine</source><year>2023</year><volume>29</volume><issue>6</issue><fpage>1563</fpage><lpage>1577</lpage><pub-id pub-id-type="pmcid">PMC10287567</pub-id><pub-id pub-id-type="pmid">37291214</pub-id><pub-id pub-id-type="doi">10.1038/s41591-023-02327-2</pub-id></element-citation></ref><ref id="R7"><label>[7]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lotfollahi</surname><given-names>M</given-names></name><name><surname>Hao</surname><given-names>Y</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name><name><surname>Satija</surname><given-names>R</given-names></name></person-group><article-title>The future of rapid and automated single-cell data analysis using reference mapping</article-title><source>Cell</source><year>2024</year><volume>187</volume><issue>10</issue><fpage>2343</fpage><lpage>2358</lpage><pub-id pub-id-type="pmcid">PMC11184658</pub-id><pub-id pub-id-type="pmid">38729109</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2024.03.009</pub-id></element-citation></ref><ref id="R8"><label>[8]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lotfollahi</surname><given-names>M</given-names></name><name><surname>Naghipourfar</surname><given-names>M</given-names></name><name><surname>Luecken</surname><given-names>MD</given-names></name><name><surname>Khajavi</surname><given-names>M</given-names></name><name><surname>Büttner</surname><given-names>M</given-names></name><name><surname>Wagenstetter</surname><given-names>M</given-names></name><name><surname>Avsec</surname><given-names>Ž</given-names></name><name><surname>Gayoso</surname><given-names>A</given-names></name><name><surname>Yosef</surname><given-names>N</given-names></name><name><surname>Interlandi</surname><given-names>M</given-names></name><name><surname>Rybakov</surname><given-names>S</given-names></name><etal/></person-group><article-title>Mapping single-cell data to reference atlases by transfer learning</article-title><source>Nature Biotechnology</source><year>2021</year><volume>40</volume><issue>1</issue><fpage>121</fpage><lpage>130</lpage><pub-id pub-id-type="pmcid">PMC8763644</pub-id><pub-id pub-id-type="pmid">34462589</pub-id><pub-id pub-id-type="doi">10.1038/s41587-021-01001-7</pub-id></element-citation></ref><ref id="R9"><label>[9]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kang</surname><given-names>JB</given-names></name><name><surname>Nathan</surname><given-names>A</given-names></name><name><surname>Weinand</surname><given-names>K</given-names></name><name><surname>Zhang</surname><given-names>F</given-names></name><name><surname>Millard</surname><given-names>N</given-names></name><name><surname>Rumker</surname><given-names>L</given-names></name><name><surname>Moody</surname><given-names>DB</given-names></name><name><surname>Korsunsky</surname><given-names>I</given-names></name><name><surname>Raychaudhuri</surname><given-names>S</given-names></name></person-group><article-title>Efficient and precise single-cell reference atlas mapping with symphony</article-title><source>Nature Communications</source><year>2021</year><volume>12</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC8497570</pub-id><pub-id pub-id-type="pmid">34620862</pub-id><pub-id pub-id-type="doi">10.1038/s41467-021-25957-x</pub-id></element-citation></ref><ref id="R10"><label>[10]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hao</surname><given-names>Y</given-names></name><name><surname>Hao</surname><given-names>S</given-names></name><name><surname>Andersen-Nissen</surname><given-names>E</given-names></name><name><surname>Mauck</surname><given-names>WM</given-names></name><name><surname>Zheng</surname><given-names>S</given-names></name><name><surname>Butler</surname><given-names>A</given-names></name><name><surname>Lee</surname><given-names>MJ</given-names></name><name><surname>Wilk</surname><given-names>AJ</given-names></name><name><surname>Darby</surname><given-names>C</given-names></name><name><surname>Zager</surname><given-names>M</given-names></name><name><surname>Hoffman</surname><given-names>P</given-names></name><etal/></person-group><article-title>Integrated analysis of multimodal single-cell data</article-title><source>Cell</source><year>2021</year><volume>184</volume><issue>13</issue><fpage>3573</fpage><lpage>358729</lpage><pub-id pub-id-type="pmcid">PMC8238499</pub-id><pub-id pub-id-type="pmid">34062119</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2021.04.048</pub-id></element-citation></ref><ref id="R11"><label>[11]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lopez</surname><given-names>R</given-names></name><name><surname>Regier</surname><given-names>J</given-names></name><name><surname>Cole</surname><given-names>MB</given-names></name><name><surname>Jordan</surname><given-names>MI</given-names></name><name><surname>Yosef</surname><given-names>N</given-names></name></person-group><article-title>Deep generative modeling for single-cell transcriptomics</article-title><source>Nature Methods</source><year>2018</year><volume>15</volume><issue>12</issue><fpage>1053</fpage><lpage>1058</lpage><pub-id pub-id-type="pmcid">PMC6289068</pub-id><pub-id pub-id-type="pmid">30504886</pub-id><pub-id pub-id-type="doi">10.1038/s41592-018-0229-2</pub-id></element-citation></ref><ref id="R12"><label>[12]</label><element-citation publication-type="web"><collab>Azimuth</collab><source>azimuth.hubmapconsortium.org</source><date-in-citation>Accessed 10-12-2024</date-in-citation><comment><ext-link ext-link-type="uri" xlink:href="https://azimuth.hubmapconsortium.org/">https://azimuth.hubmapconsortium.org/</ext-link></comment></element-citation></ref><ref id="R13"><label>[13]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luecken</surname><given-names>MD</given-names></name><name><surname>Büttner</surname><given-names>M</given-names></name><name><surname>Chaichoompu</surname><given-names>K</given-names></name><name><surname>Danese</surname><given-names>A</given-names></name><name><surname>Interlandi</surname><given-names>M</given-names></name><name><surname>Mueller</surname><given-names>MF</given-names></name><name><surname>Strobl</surname><given-names>DC</given-names></name><name><surname>Zappia</surname><given-names>L</given-names></name><name><surname>Dugas</surname><given-names>M</given-names></name><name><surname>Colomé-Tatché</surname><given-names>M</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>Benchmarking atlas-level data integration in single-cell genomics</article-title><source>Nature Methods</source><year>2021</year><volume>19</volume><issue>1</issue><fpage>41</fpage><lpage>50</lpage><pub-id pub-id-type="pmcid">PMC8748196</pub-id><pub-id pub-id-type="pmid">34949812</pub-id><pub-id pub-id-type="doi">10.1038/s41592-021-01336-8</pub-id></element-citation></ref><ref id="R14"><label>[14]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rizzo</surname><given-names>ML</given-names></name><name><surname>Szekely</surname><given-names>GJ</given-names></name></person-group><article-title>Energy distance</article-title><source>WIREs Computational Statistics</source><year>2015</year><volume>8</volume><issue>1</issue><fpage>27</fpage><lpage>38</lpage><pub-id pub-id-type="doi">10.1002/wics.1375</pub-id></element-citation></ref><ref id="R15"><label>[15]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Replogle</surname><given-names>JM</given-names></name><name><surname>Saunders</surname><given-names>RA</given-names></name><name><surname>Pogson</surname><given-names>AN</given-names></name><name><surname>Hussmann</surname><given-names>JA</given-names></name><name><surname>Lenail</surname><given-names>A</given-names></name><name><surname>Guna</surname><given-names>A</given-names></name><name><surname>Mascibroda</surname><given-names>L</given-names></name><name><surname>Wagner</surname><given-names>EJ</given-names></name><name><surname>Adelman</surname><given-names>K</given-names></name><name><surname>Lithwick-Yanai</surname><given-names>G</given-names></name><name><surname>Iremadze</surname><given-names>N</given-names></name><etal/></person-group><article-title>Mapping information-rich genotype-phenotype landscapes with genomescale perturb-seq</article-title><source>Cell</source><year>2022</year><volume>185</volume><issue>14</issue><fpage>2559</fpage><lpage>257528</lpage><pub-id pub-id-type="pmcid">PMC9380471</pub-id><pub-id pub-id-type="pmid">35688146</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2022.05.013</pub-id></element-citation></ref><ref id="R16"><label>[16]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tsukui</surname><given-names>T</given-names></name><name><surname>Sun</surname><given-names>K-H</given-names></name><name><surname>Wetter</surname><given-names>JB</given-names></name><name><surname>Wilson-Kanamori</surname><given-names>JR</given-names></name><name><surname>Hazelwood</surname><given-names>LA</given-names></name><name><surname>Henderson</surname><given-names>NC</given-names></name><name><surname>Adams</surname><given-names>TS</given-names></name><name><surname>Schupp</surname><given-names>JC</given-names></name><name><surname>Poli</surname><given-names>SD</given-names></name><name><surname>Rosas</surname><given-names>IO</given-names></name><name><surname>Kaminski</surname><given-names>N</given-names></name><etal/></person-group><article-title>Collagen-producing lung cell atlas identifies multiple subsets with distinct localization and relevance to fibrosis</article-title><source>Nature Communications</source><year>2020</year><volume>11</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC7174390</pub-id><pub-id pub-id-type="pmid">32317643</pub-id><pub-id pub-id-type="doi">10.1038/s41467-020-15647-5</pub-id></element-citation></ref><ref id="R17"><label>[17]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Marečková</surname><given-names>M</given-names></name><name><surname>Garcia-Alonso</surname><given-names>L</given-names></name><name><surname>Moullet</surname><given-names>M</given-names></name><name><surname>Lorenzi</surname><given-names>V</given-names></name><name><surname>Petryszak</surname><given-names>R</given-names></name><name><surname>Sancho-Serra</surname><given-names>C</given-names></name><name><surname>Oszlanczi</surname><given-names>A</given-names></name><name><surname>Icoresi Mazzeo</surname><given-names>C</given-names></name><name><surname>Wong</surname><given-names>FCK</given-names></name><name><surname>Kelava</surname><given-names>I</given-names></name><name><surname>Hoffman</surname><given-names>S</given-names></name><etal/></person-group><article-title>An integrated single-cell reference atlas of the human endometrium</article-title><source>Nature Genetics</source><year>2024</year><pub-id pub-id-type="pmcid">PMC11387200</pub-id><pub-id pub-id-type="pmid">39198675</pub-id><pub-id pub-id-type="doi">10.1038/s41588-024-01873-w</pub-id></element-citation></ref><ref id="R18"><label>[18]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Santamaria</surname><given-names>X</given-names></name><name><surname>Roson</surname><given-names>B</given-names></name><name><surname>Perez-Moraga</surname><given-names>R</given-names></name><name><surname>Venkatesan</surname><given-names>N</given-names></name><name><surname>Pardo-Figuerez</surname><given-names>M</given-names></name><name><surname>Gonzalez-Fernandez</surname><given-names>J</given-names></name><name><surname>Llera-Oyola</surname><given-names>J</given-names></name><name><surname>Fernaéndez</surname><given-names>E</given-names></name><name><surname>Moreno</surname><given-names>I</given-names></name><name><surname>Salumets</surname><given-names>A</given-names></name><name><surname>Vankelecom</surname><given-names>H</given-names></name><etal/></person-group><article-title>Decoding the endometrial niche of ash-erman’s syndrome at single-cell resolution</article-title><source>Nature Communications</source><year>2023</year><volume>14</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC10514053</pub-id><pub-id pub-id-type="pmid">37735465</pub-id><pub-id pub-id-type="doi">10.1038/s41467-023-41656-1</pub-id></element-citation></ref><ref id="R19"><label>[19]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ilicic</surname><given-names>T</given-names></name><name><surname>Kim</surname><given-names>JK</given-names></name><name><surname>Kolodziejczyk</surname><given-names>AA</given-names></name><name><surname>Bagger</surname><given-names>FO</given-names></name><name><surname>McCarthy</surname><given-names>DJ</given-names></name><name><surname>Marioni</surname><given-names>JC</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name></person-group><article-title>Classification of low quality cells from single-cell rna-seq data</article-title><source>Genome Biology</source><year>2016</year><volume>17</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC4758103</pub-id><pub-id pub-id-type="pmid">26887813</pub-id><pub-id pub-id-type="doi">10.1186/s13059-016-0888-1</pub-id></element-citation></ref><ref id="R20"><label>[20]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Heumos</surname><given-names>L</given-names></name><name><surname>Schaar</surname><given-names>AC</given-names></name><name><surname>Lance</surname><given-names>C</given-names></name><name><surname>Litinetskaya</surname><given-names>A</given-names></name><name><surname>Drost</surname><given-names>F</given-names></name><name><surname>Zappia</surname><given-names>L</given-names></name><name><surname>Lücken</surname><given-names>MD</given-names></name><name><surname>Strobl</surname><given-names>DC</given-names></name><name><surname>Henao</surname><given-names>J</given-names></name><name><surname>Curion</surname><given-names>F</given-names></name><name><surname>Aliee</surname><given-names>H</given-names></name><etal/></person-group><article-title>Best practices for single-cell analysis across modalities</article-title><source>Nature Reviews Genetics</source><year>2023</year><volume>24</volume><issue>8</issue><fpage>550</fpage><lpage>572</lpage><pub-id pub-id-type="pmcid">PMC10066026</pub-id><pub-id pub-id-type="pmid">37002403</pub-id><pub-id pub-id-type="doi">10.1038/s41576-023-00586-w</pub-id></element-citation></ref><ref id="R21"><label>[21]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Montserrat-Ayuso</surname><given-names>T</given-names></name><name><surname>Esteve-Codina</surname><given-names>A</given-names></name></person-group><article-title>High content of nuclei-free low-quality cells in reference single-cell atlases: a call for more stringent quality control using nuclear fraction</article-title><source>BMC Genomics</source><year>2024</year><volume>25</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC11580415</pub-id><pub-id pub-id-type="pmid">39574015</pub-id><pub-id pub-id-type="doi">10.1186/s12864-024-11015-5</pub-id></element-citation></ref><ref id="R22"><label>[22]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Habermann</surname><given-names>AC</given-names></name><name><surname>Gutierrez</surname><given-names>AJ</given-names></name><name><surname>Bui</surname><given-names>LT</given-names></name><name><surname>Yahn</surname><given-names>SL</given-names></name><name><surname>Winters</surname><given-names>NI</given-names></name><name><surname>Calvi</surname><given-names>CL</given-names></name><name><surname>Peter</surname><given-names>L</given-names></name><name><surname>Chung</surname><given-names>M-I</given-names></name><name><surname>Taylor</surname><given-names>CJ</given-names></name><name><surname>Jetter</surname><given-names>C</given-names></name><name><surname>Raju</surname><given-names>L</given-names></name><etal/></person-group><article-title>Single-cell rna sequencing reveals profibrotic roles of distinct epithelial and mesenchymal lineages in pulmonary fibrosis</article-title><source>Science Advances</source><year>2020</year><volume>6</volume><issue>28</issue><pub-id pub-id-type="pmcid">PMC7439444</pub-id><pub-id pub-id-type="pmid">32832598</pub-id><pub-id pub-id-type="doi">10.1126/sciadv.aba1972</pub-id></element-citation></ref><ref id="R23"><label>[23]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Natri</surname><given-names>HM</given-names></name><name><surname>Del Azodi</surname><given-names>CB</given-names></name><name><surname>Peter</surname><given-names>L</given-names></name><name><surname>Taylor</surname><given-names>CJ</given-names></name><name><surname>Chugh</surname><given-names>S</given-names></name><name><surname>Kendle</surname><given-names>R</given-names></name><name><surname>Chung</surname><given-names>M-i</given-names></name><name><surname>Flaherty</surname><given-names>DK</given-names></name><name><surname>Matlock</surname><given-names>BK</given-names></name><name><surname>Calvi</surname><given-names>CL</given-names></name><name><surname>Blackwell</surname><given-names>TS</given-names></name><etal/></person-group><article-title>Cell type-specific and disease-associated eqtl in the human lung</article-title><year>2023</year><pub-id pub-id-type="doi">10.1101/2023.03.17.533161</pub-id></element-citation></ref><ref id="R24"><label>[24]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Adams</surname><given-names>TS</given-names></name><name><surname>Schupp</surname><given-names>JC</given-names></name><name><surname>Poli</surname><given-names>S</given-names></name><name><surname>Ayaub</surname><given-names>EA</given-names></name><name><surname>Neumark</surname><given-names>N</given-names></name><name><surname>Ahangari</surname><given-names>F</given-names></name><name><surname>Chu</surname><given-names>SG</given-names></name><name><surname>Raby</surname><given-names>BA</given-names></name><name><surname>DeIuliis</surname><given-names>G</given-names></name><name><surname>Januszyk</surname><given-names>M</given-names></name><name><surname>Duan</surname><given-names>Q</given-names></name><etal/></person-group><article-title>Single-cell rna-seq reveals ectopic and aberrant lung-resident cell populations in idiopathic pulmonary fibrosis</article-title><source>Science Advances</source><year>2020</year><volume>6</volume><issue>28</issue><pub-id pub-id-type="pmcid">PMC7439502</pub-id><pub-id pub-id-type="pmid">32832599</pub-id><pub-id pub-id-type="doi">10.1126/sciadv.aba1983</pub-id></element-citation></ref><ref id="R25"><label>[25]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Valenzi</surname><given-names>E</given-names></name><name><surname>Bulik</surname><given-names>M</given-names></name><name><surname>Tabib</surname><given-names>T</given-names></name><name><surname>Morse</surname><given-names>C</given-names></name><name><surname>Sembrat</surname><given-names>J</given-names></name><name><surname>Trejo Bittar</surname><given-names>H</given-names></name><name><surname>Rojas</surname><given-names>M</given-names></name><name><surname>Lafyatis</surname><given-names>R</given-names></name></person-group><article-title>Single-cell analysis reveals fibroblast heterogeneity and myofibroblasts in systemic sclerosis-associated interstitial lung disease</article-title><source>Annals of the Rheumatic Diseases</source><year>2019</year><volume>78</volume><issue>10</issue><fpage>1379</fpage><lpage>1387</lpage><pub-id pub-id-type="pmcid">PMC7255436</pub-id><pub-id pub-id-type="pmid">31405848</pub-id><pub-id pub-id-type="doi">10.1136/annrheumdis-2018-214865</pub-id></element-citation></ref><ref id="R26"><label>[26]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pierce</surname><given-names>EM</given-names></name><name><surname>Carpenter</surname><given-names>K</given-names></name><name><surname>Jakubzick</surname><given-names>C</given-names></name><name><surname>Kunkel</surname><given-names>SL</given-names></name><name><surname>Evanoff</surname><given-names>H</given-names></name><name><surname>Flaherty</surname><given-names>KR</given-names></name><name><surname>Martinez</surname><given-names>FJ</given-names></name><name><surname>Toews</surname><given-names>GB</given-names></name><name><surname>Hogaboam</surname><given-names>CM</given-names></name></person-group><article-title>Idiopathic pulmonary fibrosis fibroblasts migrate and proliferate to cc chemokine ligand 21</article-title><source>European Respiratory Journal</source><year>2007</year><volume>29</volume><issue>6</issue><fpage>1082</fpage><lpage>1093</lpage><pub-id pub-id-type="pmid">17331965</pub-id></element-citation></ref><ref id="R27"><label>[27]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pierce</surname><given-names>EM</given-names></name><name><surname>Carpenter</surname><given-names>K</given-names></name><name><surname>Jakubzick</surname><given-names>C</given-names></name><name><surname>Kunkel</surname><given-names>SL</given-names></name><name><surname>Flaherty</surname><given-names>KR</given-names></name><name><surname>Martinez</surname><given-names>FJ</given-names></name><name><surname>Hogaboam</surname><given-names>CM</given-names></name></person-group><article-title>Therapeutic targeting of cc ligand 21 or cc chemokine receptor 7 abrogates pulmonary fibrosis induced by the adoptive transfer of human pulmonary fibroblasts to immunodeficient mice</article-title><source>The American Journal of Pathology</source><year>2007</year><volume>170</volume><issue>4</issue><fpage>1152</fpage><lpage>1164</lpage><pub-id pub-id-type="pmcid">PMC1829450</pub-id><pub-id pub-id-type="pmid">17392156</pub-id><pub-id pub-id-type="doi">10.2353/ajpath.2007.060649</pub-id></element-citation></ref><ref id="R28"><label>[28]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mothes</surname><given-names>R</given-names></name><name><surname>Pascual-Reguant</surname><given-names>A</given-names></name><name><surname>Koehler</surname><given-names>R</given-names></name><name><surname>Liebeskind</surname><given-names>J</given-names></name><name><surname>Liebheit</surname><given-names>A</given-names></name><name><surname>Bauherr</surname><given-names>S</given-names></name><name><surname>Philipsen</surname><given-names>L</given-names></name><name><surname>Dittmayer</surname><given-names>C</given-names></name><name><surname>Laue</surname><given-names>M</given-names></name><name><surname>Manitius</surname><given-names>R</given-names></name><name><surname>Elezkurtaj</surname><given-names>S</given-names></name><etal/></person-group><article-title>Distinct tissue niches direct lung immunopathology via ccl18 and ccl21 in severe covid-19</article-title><source>Nature Communications</source><year>2023</year><volume>14</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC9922044</pub-id><pub-id pub-id-type="pmid">36774347</pub-id><pub-id pub-id-type="doi">10.1038/s41467-023-36333-2</pub-id></element-citation></ref><ref id="R29"><label>[29]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Reyfman</surname><given-names>PA</given-names></name><name><surname>Walter</surname><given-names>JM</given-names></name><name><surname>Joshi</surname><given-names>N</given-names></name><name><surname>Anekalla</surname><given-names>KR</given-names></name><name><surname>McQuattie-Pimentel</surname><given-names>AC</given-names></name><name><surname>Chiu</surname><given-names>S</given-names></name><name><surname>Fernandez</surname><given-names>R</given-names></name><name><surname>Akbarpour</surname><given-names>M</given-names></name><name><surname>Chen</surname><given-names>C-I</given-names></name><name><surname>Ren</surname><given-names>Z</given-names></name><name><surname>Verma</surname><given-names>R</given-names></name><etal/></person-group><article-title>Single-cell transcriptomic analysis of human lung provides insights into the pathobiology of pulmonary fibrosis</article-title><source>American Journal of Respiratory and Critical Care Medicine</source><year>2019</year><volume>199</volume><issue>12</issue><fpage>1517</fpage><lpage>1536</lpage><pub-id pub-id-type="pmcid">PMC6580683</pub-id><pub-id pub-id-type="pmid">30554520</pub-id><pub-id pub-id-type="doi">10.1164/rccm.201712-2410OC</pub-id></element-citation></ref><ref id="R30"><label>[30]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Morse</surname><given-names>C</given-names></name><name><surname>Tabib</surname><given-names>T</given-names></name><name><surname>Sembrat</surname><given-names>J</given-names></name><name><surname>Buschur</surname><given-names>KL</given-names></name><name><surname>Bittar</surname><given-names>HT</given-names></name><name><surname>Valenzi</surname><given-names>E</given-names></name><name><surname>Jiang</surname><given-names>Y</given-names></name><name><surname>Kass</surname><given-names>DJ</given-names></name><name><surname>Gibson</surname><given-names>K</given-names></name><name><surname>Chen</surname><given-names>W</given-names></name><name><surname>Mora</surname><given-names>A</given-names></name><etal/></person-group><article-title>Proliferating spp1/mertk-expressing macrophages in idiopathic pulmonary fibrosis</article-title><source>European Respiratory Journal</source><year>2019</year><volume>54</volume><issue>2</issue><elocation-id>1802441</elocation-id><pub-id pub-id-type="pmcid">PMC8025672</pub-id><pub-id pub-id-type="pmid">31221805</pub-id><pub-id pub-id-type="doi">10.1183/13993003.02441-2018</pub-id></element-citation></ref><ref id="R31"><label>[31]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mould</surname><given-names>KJ</given-names></name><name><surname>Moore</surname><given-names>CM</given-names></name><name><surname>McManus</surname><given-names>SA</given-names></name><name><surname>McCubbrey</surname><given-names>AL</given-names></name><name><surname>McClendon</surname><given-names>JD</given-names></name><name><surname>Griesmer</surname><given-names>CL</given-names></name><name><surname>Henson</surname><given-names>PM</given-names></name><name><surname>Janssen</surname><given-names>WJ</given-names></name></person-group><article-title>Airspace macrophages and monocytes exist in transcriptionally distinct subsets in healthy adults</article-title><source>American Journal of Respiratory and Critical Care Medicine</source><year>2021</year><volume>203</volume><issue>8</issue><fpage>946</fpage><lpage>956</lpage><pub-id pub-id-type="pmcid">PMC8048748</pub-id><pub-id pub-id-type="pmid">33079572</pub-id><pub-id pub-id-type="doi">10.1164/rccm.202005-1989OC</pub-id></element-citation></ref><ref id="R32"><label>[32]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Büttner</surname><given-names>M</given-names></name><name><surname>Miao</surname><given-names>Z</given-names></name><name><surname>Wolf</surname><given-names>FA</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>A test metric for assessing single-cell rna-seq batch correction</article-title><source>Nature Methods</source><year>2018</year><volume>16</volume><issue>1</issue><fpage>43</fpage><lpage>49</lpage><pub-id pub-id-type="pmid">30573817</pub-id></element-citation></ref><ref id="R33"><label>[33]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>X</given-names></name><name><surname>Chen</surname><given-names>Y</given-names></name><name><surname>Hua</surname><given-names>K</given-names></name><name><surname>Xu</surname><given-names>S</given-names></name><name><surname>You</surname><given-names>R</given-names></name><name><surname>Hao</surname><given-names>M</given-names></name><name><surname>Li</surname><given-names>W</given-names></name><name><surname>Wei</surname><given-names>L</given-names></name><name><surname>Jia</surname><given-names>J</given-names></name><name><surname>Xi</surname><given-names>X</given-names></name><name><surname>Chen</surname><given-names>S</given-names></name><etal/></person-group><article-title>uniheart: An ensemble atlas of cardiac cells provides multifaceted portraits of the human heart</article-title><year>2023</year><pub-id pub-id-type="doi">10.21203/rs.3.rs-3215038/v1</pub-id></element-citation></ref><ref id="R34"><label>[34]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Netskar</surname><given-names>H</given-names></name><name><surname>Pfefferle</surname><given-names>A</given-names></name><name><surname>Goodridge</surname><given-names>JP</given-names></name><name><surname>Sohlberg</surname><given-names>E</given-names></name><name><surname>Dufva</surname><given-names>O</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name><name><surname>Brownlie</surname><given-names>D</given-names></name><name><surname>Michaelsson</surname><given-names>J</given-names></name><name><surname>Marquardt</surname><given-names>N</given-names></name><name><surname>Clancy</surname><given-names>T</given-names></name><name><surname>Horowitz</surname><given-names>A</given-names></name><etal/></person-group><article-title>Pan-cancer profiling of tumor-infiltrating natural killer cells through transcriptional reference mapping</article-title><source>Nature Immunology</source><year>2024</year><volume>25</volume><issue>8</issue><fpage>1445</fpage><lpage>1459</lpage><pub-id pub-id-type="pmcid">PMC11291284</pub-id><pub-id pub-id-type="pmid">38956379</pub-id><pub-id pub-id-type="doi">10.1038/s41590-024-01884-z</pub-id></element-citation></ref><ref id="R35"><label>[35]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Herpelinck</surname><given-names>T</given-names></name><name><surname>Ory</surname><given-names>L</given-names></name><name><surname>Verbraeken</surname><given-names>T</given-names></name><name><surname>Nasello</surname><given-names>G</given-names></name><name><surname>Barzegari</surname><given-names>M</given-names></name><name><surname>Bolander</surname><given-names>J</given-names></name><name><surname>Luyten</surname><given-names>FP</given-names></name><name><surname>Tylzanowski</surname><given-names>P</given-names></name><name><surname>Geris</surname><given-names>L</given-names></name></person-group><article-title>An integrated single-cell atlas of the limb skeleton from development through adulthood</article-title><year>2022</year><pub-id pub-id-type="doi">10.1101/2022.03.14.484345</pub-id></element-citation></ref><ref id="R36"><label>[36]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>He</surname><given-names>Z</given-names></name><name><surname>Dony</surname><given-names>L</given-names></name><name><surname>Fleck</surname><given-names>JS</given-names></name><name><surname>Szałata</surname><given-names>A</given-names></name><name><surname>Li</surname><given-names>KX</given-names></name><name><surname>Sliškovié</surname><given-names>I</given-names></name><name><surname>Lin</surname><given-names>H-C</given-names></name><name><surname>Santel</surname><given-names>M</given-names></name><name><surname>Atamian</surname><given-names>A</given-names></name><name><surname>Quadrato</surname><given-names>G</given-names></name><name><surname>Sun</surname><given-names>J</given-names></name><etal/></person-group><article-title>An integrated transcriptomic cell atlas of human neural organoids</article-title><source>Nature</source><year>2024</year><volume>635</volume><issue>8039</issue><fpage>690</fpage><lpage>698</lpage><pub-id pub-id-type="pmcid">PMC11578878</pub-id><pub-id pub-id-type="pmid">39567792</pub-id><pub-id pub-id-type="doi">10.1038/s41586-024-08172-8</pub-id></element-citation></ref><ref id="R37"><label>[37]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hrovatin</surname><given-names>K</given-names></name><name><surname>Bastidas-Ponce</surname><given-names>A</given-names></name><name><surname>Bakhti</surname><given-names>M</given-names></name><name><surname>Zappia</surname><given-names>L</given-names></name><name><surname>Büttner</surname><given-names>M</given-names></name><name><surname>Salinno</surname><given-names>C</given-names></name><name><surname>Sterr</surname><given-names>M</given-names></name><name><surname>Böttcher</surname><given-names>A</given-names></name><name><surname>Migliorini</surname><given-names>A</given-names></name><name><surname>Lickert</surname><given-names>H</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>Delineating mouse-cell identity during lifetime and in diabetes with a single cell atlas</article-title><source>Nature Metabolism</source><year>2023</year><volume>5</volume><issue>9</issue><fpage>1615</fpage><lpage>1637</lpage><pub-id pub-id-type="pmcid">PMC10513934</pub-id><pub-id pub-id-type="pmid">37697055</pub-id><pub-id pub-id-type="doi">10.1038/s42255-023-00876-x</pub-id></element-citation></ref><ref id="R38"><label>[38]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bandesh</surname><given-names>K</given-names></name><name><surname>Motakis</surname><given-names>E</given-names></name><name><surname>Nargund</surname><given-names>S</given-names></name><name><surname>Kursawe</surname><given-names>R</given-names></name><name><surname>Selvam</surname><given-names>V</given-names></name><name><surname>Bhuiyan</surname><given-names>RM</given-names></name><name><surname>Eryilmaz</surname><given-names>GN</given-names></name><name><surname>Krishnan</surname><given-names>SN</given-names></name><name><surname>Spracklen</surname><given-names>CN</given-names></name><name><surname>Ucar</surname><given-names>D</given-names></name><name><surname>Stitzel</surname><given-names>ML</given-names></name></person-group><article-title>Singlecell decoding of human islet cell type-specific alterations in type 2 diabetes reveals converging genetic-and state-driven-cell gene expression defects</article-title><year>2025</year><pub-id pub-id-type="doi">10.1101/2025.01.17.633590</pub-id></element-citation></ref><ref id="R39"><label>[39]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jenkins</surname><given-names>BH</given-names></name><name><surname>Tracy</surname><given-names>I</given-names></name><name><surname>Rodrigues</surname><given-names>MFSD</given-names></name><name><surname>Smith</surname><given-names>MJL</given-names></name><name><surname>Martinez</surname><given-names>BR</given-names></name><name><surname>Edmond</surname><given-names>M</given-names></name><name><surname>Mahadevan</surname><given-names>S</given-names></name><name><surname>Rao</surname><given-names>A</given-names></name><name><surname>Zong</surname><given-names>H</given-names></name><name><surname>Liu</surname><given-names>K</given-names></name><name><surname>Aggarwal</surname><given-names>A</given-names></name><etal/></person-group><article-title>Single cell and spatial analysis of immune-hot and immune-cold tumours identifies fibroblast subtypes associated with distinct immunological niches and positive immunotherapy response</article-title><source>Molecular Cancer</source><year>2025</year><volume>24</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC11702232</pub-id><pub-id pub-id-type="pmid">39757146</pub-id><pub-id pub-id-type="doi">10.1186/s12943-024-02191-9</pub-id></element-citation></ref><ref id="R40"><label>[40]</label><element-citation publication-type="journal"><person-group person-group-type="author"><collab>N. M., P</collab><name><surname>Fullard</surname><given-names>JF</given-names></name><name><surname>Clarence</surname><given-names>T</given-names></name><name><surname>Mathur</surname><given-names>D</given-names></name><name><surname>Casey</surname><given-names>C</given-names></name><name><surname>Hennigan</surname><given-names>E</given-names></name><name><surname>Alvia</surname><given-names>M</given-names></name><name><surname>Krause-Massaguer</surname><given-names>J</given-names></name><name><surname>Barreda</surname><given-names>A</given-names></name><name><surname>Davis</surname><given-names>DA</given-names></name><name><surname>Vontell</surname><given-names>RT</given-names></name><etal/></person-group><article-title>A multi-region single nucleus transcriptomic atlas of parkinson’s disease</article-title><source>Scientific Data</source><year>2024</year><volume>11</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC11585549</pub-id><pub-id pub-id-type="pmid">39580497</pub-id><pub-id pub-id-type="doi">10.1038/s41597-024-04117-y</pub-id></element-citation></ref><ref id="R41"><label>[41]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>M</given-names></name><name><surname>Dahl</surname><given-names>A</given-names></name></person-group><article-title>A robust model for cell type-specific interindividual variation in single-cell rna sequencing data</article-title><source>Nature Communications</source><year>2024</year><volume>15</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC11186839</pub-id><pub-id pub-id-type="pmid">38898015</pub-id><pub-id pub-id-type="doi">10.1038/s41467-024-49242-9</pub-id></element-citation></ref><ref id="R42"><label>[42]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yazar</surname><given-names>S</given-names></name><name><surname>Alquicira-Hernandez</surname><given-names>J</given-names></name><name><surname>Wing</surname><given-names>K</given-names></name><name><surname>Senabouth</surname><given-names>A</given-names></name><name><surname>Gordon</surname><given-names>MG</given-names></name><name><surname>Andersen</surname><given-names>S</given-names></name><name><surname>Lu</surname><given-names>Q</given-names></name><name><surname>Rowson</surname><given-names>A</given-names></name><name><surname>Taylor</surname><given-names>TRP</given-names></name><name><surname>Clarke</surname><given-names>L</given-names></name><name><surname>Maccora</surname><given-names>K</given-names></name><etal/></person-group><article-title>Single-cell eqtl mapping identifies cell type–specific genetic control of autoimmune disease</article-title><source>Science</source><year>2022</year><volume>376</volume><issue>6589</issue><pub-id pub-id-type="pmid">35389779</pub-id></element-citation></ref><ref id="R43"><label>[43]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dann</surname><given-names>E</given-names></name><name><surname>Henderson</surname><given-names>NC</given-names></name><name><surname>Teichmann</surname><given-names>SA</given-names></name><name><surname>Morgan</surname><given-names>MD</given-names></name><name><surname>Marioni</surname><given-names>JC</given-names></name></person-group><article-title>Differential abundance testing on single-cell data using k-nearest neighbor graphs</article-title><source>Nature Biotechnology</source><year>2021</year><volume>40</volume><issue>2</issue><fpage>245</fpage><lpage>253</lpage><pub-id pub-id-type="pmcid">PMC7617075</pub-id><pub-id pub-id-type="pmid">34594043</pub-id><pub-id pub-id-type="doi">10.1038/s41587-021-01033-z</pub-id></element-citation></ref><ref id="R44"><label>[44]</label><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Peyré</surname><given-names>G</given-names></name><name><surname>Cuturi</surname><given-names>M</given-names></name></person-group><source>Computational Optimal Transport</source><publisher-name>now Publishers Inc</publisher-name><year>2019</year><comment>10.1561/9781680835519</comment><pub-id pub-id-type="doi">10.1561/9781680835519</pub-id></element-citation></ref><ref id="R45"><label>[45]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Schiebinger</surname><given-names>G</given-names></name><name><surname>Shu</surname><given-names>J</given-names></name><name><surname>Tabaka</surname><given-names>M</given-names></name><name><surname>Cleary</surname><given-names>B</given-names></name><name><surname>Subramanian</surname><given-names>V</given-names></name><name><surname>Solomon</surname><given-names>A</given-names></name><name><surname>Gould</surname><given-names>J</given-names></name><name><surname>Liu</surname><given-names>S</given-names></name><name><surname>Lin</surname><given-names>S</given-names></name><name><surname>Berube</surname><given-names>P</given-names></name><name><surname>Lee</surname><given-names>L</given-names></name><etal/></person-group><article-title>Optimal-transport analysis of single-cell gene expression identifies developmental trajectories in reprogramming</article-title><source>Cell</source><year>2019</year><volume>176</volume><issue>4</issue><fpage>928</fpage><lpage>94322</lpage><pub-id pub-id-type="pmcid">PMC6402800</pub-id><pub-id pub-id-type="pmid">30712874</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2019.01.006</pub-id></element-citation></ref><ref id="R46"><label>[46]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Klein</surname><given-names>D</given-names></name><name><surname>Palla</surname><given-names>G</given-names></name><name><surname>Lange</surname><given-names>M</given-names></name><name><surname>Klein</surname><given-names>M</given-names></name><name><surname>Piran</surname><given-names>Z</given-names></name><name><surname>Gander</surname><given-names>M</given-names></name><name><surname>Meng-Papaxanthos</surname><given-names>L</given-names></name><name><surname>Sterr</surname><given-names>M</given-names></name><name><surname>Saber</surname><given-names>L</given-names></name><name><surname>Jing</surname><given-names>C</given-names></name><name><surname>Bastidas-Ponce</surname><given-names>A</given-names></name><etal/></person-group><article-title>Mapping cells through time and space with moscot</article-title><source>Nature</source><year>2025</year><volume>638</volume><issue>8052</issue><fpage>1065</fpage><lpage>1075</lpage><pub-id pub-id-type="pmcid">PMC11864987</pub-id><pub-id pub-id-type="pmid">39843746</pub-id><pub-id pub-id-type="doi">10.1038/s41586-024-08453-2</pub-id></element-citation></ref><ref id="R47"><label>[47]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Széekely</surname><given-names>GJ</given-names></name><name><surname>Rizzo</surname><given-names>ML</given-names></name></person-group><article-title>Energy statistics: A class of statistics based on distances</article-title><source>Journal of Statistical Planning and Inference</source><year>2013</year><volume>143</volume><issue>8</issue><fpage>1249</fpage><lpage>1272</lpage><pub-id pub-id-type="doi">10.1016/j.jspi.2013.03.018</pub-id></element-citation></ref><ref id="R48"><label>[48]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Peidli</surname><given-names>S</given-names></name><name><surname>Green</surname><given-names>TD</given-names></name><name><surname>Shen</surname><given-names>C</given-names></name><name><surname>Gross</surname><given-names>T</given-names></name><name><surname>Min</surname><given-names>J</given-names></name><name><surname>Garda</surname><given-names>S</given-names></name><name><surname>Yuan</surname><given-names>B</given-names></name><name><surname>Schumacher</surname><given-names>LJ</given-names></name><name><surname>Taylor-King</surname><given-names>JP</given-names></name><name><surname>Marks</surname><given-names>DS</given-names></name><name><surname>Luna</surname><given-names>A</given-names></name><etal/></person-group><article-title>scperturb: harmonized single-cell perturbation data</article-title><source>Nature Methods</source><year>2024</year><volume>21</volume><issue>3</issue><fpage>531</fpage><lpage>540</lpage><pub-id pub-id-type="pmid">38279009</pub-id></element-citation></ref><ref id="R49"><label>[49]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Novella-Rausell</surname><given-names>C</given-names></name><name><surname>Grudniewska</surname><given-names>M</given-names></name><name><surname>Peters</surname><given-names>DJM</given-names></name><name><surname>Mahfouz</surname><given-names>A</given-names></name></person-group><article-title>A comprehensive mouse kidney atlas enables rare cell population characterization androbust marker discovery</article-title><source>iScience</source><year>2023</year><volume>26</volume><issue>6</issue><elocation-id>106877</elocation-id><pub-id pub-id-type="pmcid">PMC10238935</pub-id><pub-id pub-id-type="pmid">37275529</pub-id><pub-id pub-id-type="doi">10.1016/j.isci.2023.106877</pub-id></element-citation></ref><ref id="R50"><label>[50]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Swamy</surname><given-names>VS</given-names></name><name><surname>Fufa</surname><given-names>TD</given-names></name><name><surname>Hufnagel</surname><given-names>RB</given-names></name><name><surname>McGaughey</surname><given-names>DM</given-names></name></person-group><article-title>Building the mega single-cell transcriptome ocular meta-atlas</article-title><source>GigaScience</source><year>2021</year><volume>10</volume><issue>10</issue><pub-id pub-id-type="pmcid">PMC8514335</pub-id><pub-id pub-id-type="pmid">34651173</pub-id><pub-id pub-id-type="doi">10.1093/gigascience/giab061</pub-id></element-citation></ref><ref id="R51"><label>[51]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wu</surname><given-names>Y</given-names></name><name><surname>Fan</surname><given-names>Y</given-names></name><name><surname>Miao</surname><given-names>Y</given-names></name><name><surname>Li</surname><given-names>Y</given-names></name><name><surname>Du</surname><given-names>G</given-names></name><name><surname>Chen</surname><given-names>Z</given-names></name><name><surname>Diao</surname><given-names>J</given-names></name><name><surname>Chen</surname><given-names>Y-A</given-names></name><name><surname>Ye</surname><given-names>M</given-names></name><name><surname>You</surname><given-names>R</given-names></name><name><surname>Chen</surname><given-names>A</given-names></name><etal/></person-group><article-title>uniliver: a human liver cell atlas for data-driven cellular state mapping</article-title><year>2023</year><pub-id pub-id-type="pmid">39892777</pub-id></element-citation></ref><ref id="R52"><label>[52]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname><given-names>C</given-names></name><name><surname>Lopez</surname><given-names>R</given-names></name><name><surname>Mehlman</surname><given-names>E</given-names></name><name><surname>Regier</surname><given-names>J</given-names></name><name><surname>Jordan</surname><given-names>MI</given-names></name><name><surname>Yosef</surname><given-names>N</given-names></name></person-group><article-title>Probabilistic harmonization and annotation of single-cell transcriptomics data with deep generative models</article-title><source>Molecular Systems Biology</source><year>2021</year><volume>17</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC7829634</pub-id><pub-id pub-id-type="pmid">33491336</pub-id><pub-id pub-id-type="doi">10.15252/msb.20209620</pub-id></element-citation></ref><ref id="R53"><label>[53]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolf</surname><given-names>FA</given-names></name><name><surname>Angerer</surname><given-names>P</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>Scanpy: large-scale single-cell gene expression data analysis</article-title><source>Genome Biology</source><year>2018</year><volume>19</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC5802054</pub-id><pub-id pub-id-type="pmid">29409532</pub-id><pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id></element-citation></ref><ref id="R54"><label>[54]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Traag</surname><given-names>VA</given-names></name><name><surname>Waltman</surname><given-names>L</given-names></name><name><surname>Eck</surname><given-names>NJ</given-names></name></person-group><article-title>From louvain to leiden: guaranteeing well-connected communities</article-title><source>Scientific Reports</source><year>2019</year><volume>9</volume><issue>1</issue><pub-id pub-id-type="pmcid">PMC6435756</pub-id><pub-id pub-id-type="pmid">30914743</pub-id><pub-id pub-id-type="doi">10.1038/s41598-019-41695-z</pub-id></element-citation></ref><ref id="R55"><label>[55]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McInnes</surname><given-names>L</given-names></name><name><surname>Healy</surname><given-names>J</given-names></name><name><surname>Melville</surname><given-names>J</given-names></name></person-group><article-title>UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</article-title><source>arXiv</source><year>2018</year><comment><ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1802.03426">https://arxiv.org/abs/1802.03426</ext-link></comment><pub-id pub-id-type="doi">10.48550/ARXIV.1802.03426</pub-id></element-citation></ref><ref id="R56"><label>[56]</label><element-citation publication-type="confproc"><person-group person-group-type="author"><name><surname>Dong</surname><given-names>W</given-names></name><name><surname>Moses</surname><given-names>C</given-names></name><name><surname>Li</surname><given-names>K</given-names></name></person-group><source>Efficient k-nearest neighbor graph construction for generic similarity measures</source><conf-name>Proceedings of the 20th International Conference on World Wide Web WWW ‘11</conf-name><conf-sponsor>ACM</conf-sponsor><conf-date>2011</conf-date><comment><ext-link ext-link-type="uri" xlink:href="http://dx.doi.org/10.1145/1963405.1963487">http://dx.doi.org/10.1145/1963405.1963487</ext-link></comment><pub-id pub-id-type="doi">10.1145/1963405.1963487</pub-id></element-citation></ref><ref id="R57"><label>[57]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Blondel</surname><given-names>VD</given-names></name><name><surname>Guillaume</surname><given-names>J-L</given-names></name><name><surname>Lambiotte</surname><given-names>R</given-names></name><name><surname>Lefebvre</surname><given-names>E</given-names></name></person-group><article-title>Fast unfolding of communities in large networks</article-title><source>Journal of Statistical Mechanics: Theory and Experiment</source><year>2008</year><volume>2008</volume><issue>10</issue><elocation-id>10008</elocation-id><pub-id pub-id-type="doi">10.1088/1742-5468/2008/10/p10008</pub-id></element-citation></ref><ref id="R58"><label>[58]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Korsunsky</surname><given-names>I</given-names></name><name><surname>Millard</surname><given-names>N</given-names></name><name><surname>Fan</surname><given-names>J</given-names></name><name><surname>Slowikowski</surname><given-names>K</given-names></name><name><surname>Zhang</surname><given-names>F</given-names></name><name><surname>Wei</surname><given-names>K</given-names></name><name><surname>Baglaenko</surname><given-names>Y</given-names></name><name><surname>Brenner</surname><given-names>M</given-names></name><name><surname>Loh</surname><given-names>P-r</given-names></name><name><surname>Raychaudhuri</surname><given-names>S</given-names></name></person-group><article-title>Fast, sensitive and accurate integration of single-cell data with harmony</article-title><source>Nature Methods</source><year>2019</year><volume>16</volume><issue>12</issue><fpage>1289</fpage><lpage>1296</lpage><pub-id pub-id-type="pmcid">PMC6884693</pub-id><pub-id pub-id-type="pmid">31740819</pub-id><pub-id pub-id-type="doi">10.1038/s41592-019-0619-0</pub-id></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Figure 1</label><caption><title>MapQC evaluates query-to-reference mapping quality, enabling correct identification of case (e.g. disease)-specific cell states.</title><p><bold>a</bold>, MapQC workflow. Left: mapQC can be used when mapping a dataset (“query data”) that includes control samples, and optionally “case” samples (e.g. diseased or perturbed) onto a large-scale reference atlas of control samples. Right: The MapQC procedure includes two tests: first, it tests whether batch effects were sufficiently removed during the mapping by testing if the query mixes with the reference. If distance to the reference is large for control cells, the mapping has failed. Second, if case (e.g. disease)-specific states are expected to be present, it tests whether biological variation has been retained by checking whether some of the cells from the case samples do not mix with the reference, indicating a case-specific cell state. If both tests are passed, downstream analysis can be performed and case-specific cell states can be identified and analyzed. <bold>b</bold>, Calculation of mapQC scores. First (1) neighborhoods of size k around randomly sampled query cells are calculated. Then (2) within each neighborhood, the mean distance to the reference samples is calculated for both query and reference samples. Finally (3), the distances are normalized per neighborhood, such that reference sample distances to the reference have mean 0 and standard deviation 1 in each neighborhood. Query cell distances to the reference are considered large if they are more than 2 standard deviations above the reference mean (dashed red line), in which case the mapQC score is higher than 2. These cells can be considered as not mixing with the reference.</p></caption><graphic xlink:href="EMS206022-f001"/></fig><fig id="F2" position="float"><label>Figure 2</label><caption><title>MapQC correctly identifies failed mappings with remaining batch-effect.</title><p><bold>a,</bold> UMAP of a query dataset including samples from patients with IPF (dark blue) and controls (light blue) mapped onto the Human Lung Cell Atlas (“reference”, grey). Blood vessel endothelium cells are shown in magnified version in dashed circle. <bold>b,</bold> As (a), with query cells from control samples now colored by mapQC scores, split into low (&lt;2, beige) and high (&gt;2, red) scores. Inset: query control endothelial cells that appear to be mixing with the reference based on the UMAP visualization are in fact distant from the reference, as shown by high mapQC scores. Cells from query IPF samples are not shown. <bold>c,</bold> Query cell mapQC scores shown per cell type. A horizontal red dotted line indicates the cutoff value of 2, above which cells are considered to map distant to the reference. Cell types for which more than half of the cells mapped far from the reference (score&gt;2) are indicated with red crosses. Boxes are included for all groups of at least 100 cells, and show the median and interquartile range. Whiskers extend to the lowest and highest non-outlier points, with data points more than 1.5 times the interquartile range outside the low and high quartile considered outliers. Outliers above 20 or below -5 are not shown for figure legibility, but are shown in <xref ref-type="fig" rid="F6">Extended Data fig. 2b</xref>. <bold>d</bold>, Blood vessel cell cluster composition, broken down by data subset and lung condition (reference, query control, or query IPF). <bold>e</bold>, Expression of genes related to experimental artifacts across blood vessel cell clusters of the joint HLCA reference and query. <bold>f</bold>, UMAP of a query dataset including samples from patients with Asherman syndrome (dark blue) and healthy controls (light blue) mapped onto the Human Endometrial Cell Atlas (HECA “reference”, grey). Cells identified as a disease-specific cell state in the original publication are shown in magnified version in dashed square. <bold>g,</bold> As (f), with query cells now colored by mapQC scores, split into low (&lt;2, beige), and high (&gt;2, red) scores. <bold>h</bold>, Expression of several marker/gene groups among cells in the HECA reference and mapped query, showing marker expression for high-mapQC-score-cluster 21 (split into reference, query control, and query disease), and all other cells split by lineage (and further split into reference “r” or query “q”). For both (e) and (h), expression values were normalized per gene, such that the group with the highest expression was set to 1, and the group with the lowest expression to 0.</p></caption><graphic xlink:href="EMS206022-f002"/></fig><fig id="F3" position="float"><label>Figure 3</label><caption><title>Successful mappings identified by mapQC enable the identification of disease-specific cell states.</title><p><bold>a</bold>, UMAP of a query dataset (see <xref ref-type="fig" rid="F2">fig. 2a</xref>) remapped with different parameter settings, including cells from healthy controls from HLCA reference (grey), from query controls (light blue) and query donors with IPF (dark blue). A zoom-in of the UMAP of the blood vessel endothelium is shown. <bold>b</bold>, As (a), with query control cells now colored by mapQC scores, split into low (&lt;2, beige) and high (&gt;2, red) scores. Query disease cells are not shown. <bold>c,</bold> As (b), but now showing query disease cells from IPF patients, while excluding query control cells. <bold>d</bold>, Query mapQC scores from (b) and (c) shown per cell type, split into control and case (IPF) cells. Cell types with more than half of the control cells mapping close to the reference (score &lt;2) are indicated with green ticks, and those with more than half mapping far from the reference (&gt;2) with red crosses. Double green ticks indicate cell types with control cells close to the reference, and disease cells far from the reference. A horizontal red dotted line indicates the cutoff value of 2, above which cells are considered distant from the reference. Boxes are shown for groups with at least 100 cells. Outliers above 15 and below -5 (29 and 64 cells, respectively) are not shown for legibility, but are shown in extended data <xref ref-type="fig" rid="F4">fig. 4b</xref>. <bold>e</bold>, Expression of genes differentially highly expressed among smooth muscle cells distant from the reference (mapQC score &gt;2), shown for smooth muscle cells from the reference and from the query (“Q.”), the latter split into high and low mapQC score groups. <bold>f</bold>, MapQC scores among subgroups of macrophages in the query. <bold>g</bold>, Expression of known alveolar macrophage markers, either general or IPF-specific, among reference alveolar macrophages, and query alveolar macrophages mapped close to or distant from the reference according to mapQC. <bold>h</bold>, Expression of CTHRC1, reported as IPF specific in the query data publication, among cells in the CTHRC1-high fibroblast cluster of the joint reference and query. Mean expression per donor is shown, with only donors with at least 10 cells in the cluster included in the figure. Donors are grouped based on coming from the reference or query, and based on lung condition. For all box plots, the boxes show the median and interquartile range. Whiskers extend to the lowest and highest non-outlier points, with data points more than 1.5 times the interquartile range outside the low and high quartile considered outliers.</p></caption><graphic xlink:href="EMS206022-f003"/></fig><fig id="F4" position="float"><label>Figure 4</label><caption><title>MapQC is the only metric that correctly distinguishes a failed from a successful mapping, compared to commonly used integration and query-to-reference mapping metrics.</title><p><bold>a</bold>, UMAP of a failed; and <bold>b</bold>, a successful query-to-reference mapping. Only cells from the HLCA reference (grey) and query healthy controls (light blue) were included for this benchmark. <bold>c</bold>, Scores of mapQC and 5 other commonly used integration and mapping metrics. Scores shown in red were calculated calculated on the mapping shown in (a), scores in green on the mapping shown in (b). A vertical red dotted line is shown for the cutoff-value of mapQC scores separating good from bad mappings. Arrows in the x-axis labels show whether a lower or a higher value indicates good mapping for the specific metric. For mapQC scores, the x-axis is split into 0-10 and 10-100, to enable easy visual comparison of the scores for the two different mappings (c and d, left panel).</p></caption><graphic xlink:href="EMS206022-f004"/></fig></floats-group></article>