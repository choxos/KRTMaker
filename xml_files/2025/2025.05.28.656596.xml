<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="epub">2692-8205</issn></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS206121</article-id><article-id pub-id-type="doi">10.1101/2025.05.28.656596</article-id><article-id pub-id-type="archive">PPR1029260</article-id><article-version-alternatives><article-version article-version-type="status">preprint</article-version><article-version article-version-type="number">1</article-version></article-version-alternatives><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>Phylogenetic Estimation of branch-specific Shifts in the Tempo of Origination</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Kopperud</surname><given-names>Bjørn T.</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib><contrib contrib-type="author"><name><surname>Höhna</surname><given-names>Sebastian</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref></contrib></contrib-group><aff id="A1"><label>1</label>GeoBio-Center LMU, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/05591te55</institution-id><institution>Ludwig-Maximilians-Universität München</institution></institution-wrap>, <postal-code>80333</postal-code><city>Munich</city>, <country country="DE">Germany</country></aff><aff id="A2"><label>2</label>Department of Earth and Environmental Sciences, Paleontology &amp; Geobiology, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/05591te55</institution-id><institution>Ludwig-Maximilians-Universität München</institution></institution-wrap>, <postal-code>80333</postal-code><city>Munich</city>, <country country="DE">Germany</country></aff><author-notes><corresp id="CR1">
<label>*</label>Correspondence to be sent to: Bjørn T. Kopperud, LMU München, Richard-Wagner-Straße 10, München, Germany; <email>kopperud@protonmail.com</email></corresp></author-notes><pub-date pub-type="nihms-submitted"><day>04</day><month>06</month><year>2025</year></pub-date><pub-date pub-type="preprint"><day>31</day><month>05</month><year>2025</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by-nc/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P1">Studying rates of species diversification is one of the key themes in macroevolution. In particular, we are interested in if some clades in a phylogeny diversify more rapidly/slowly than others due to branch-specific diversification rates. A common approach in neontological studies is to use a phylogenetic birth-death process to model species diversification. Specifically, the birth-death-shift process is used to model branch-specific shifts in the tempo of diversification. Here, we present Pesto, a new method and software for estimating branch-specific diversification rates that does not rely on Markov chain Monte Carlo simulations for fitting the model and instead deterministically computes the posterior mean branch-specific diversification rates using only two traversals of the tree. This method is blazingly fast: the birth-death-shift model can be fitted to large phylogenies (&gt;20k taxa) in minutes on a personal computer while also providing branch-specific inference of diversification rate shift events. Thus, we can robustly infer branch-specific diversification rates and the number of diversification rate shift events for large-scale phylogenies as well as exploring the characteristic of the birth-death-shift model through complex and large-scale simulations. Here, we first describe the method and the software implementation <monospace>Pesto</monospace> and explore its behavior using trees simulated under the birth-death-shift model. Then, we explore the behavior of inferring significant branch-specific diversification rate shifts using both Bayes factors and effect sizes. We find few to none false positive inferences of diversification rate shift events but many false negatives (reduced power). The most difficult parameter to estimate is the rate at which diversification rate shifts occur (shift rate). Despite this, branch-specific diversification rate estimates are precise and nearly unbiased.</p></abstract><kwd-group><kwd>diversification</kwd><kwd>speciation</kwd><kwd>extinction</kwd><kwd>phylogeny</kwd><kwd>birth-death</kwd><kwd>macroevolution</kwd><kwd>origination</kwd><kwd>clade-varying</kwd><kwd>branch-specific</kwd></kwd-group></article-meta></front><body><sec id="S1" sec-type="intro"><title>Introduction</title><p id="P2">Estimating rates of diversification is one of the key interests in macroevolutionary biology and paleontology. Diversification rates are fundamental to our understanding of how historical biodiversity has changed. Recent developments in the field have focused on birth-death models that describe the tempo of lineage diversification (<xref ref-type="bibr" rid="R53">Ricklefs, 2007</xref>; <xref ref-type="bibr" rid="R37">Morlon, 2014</xref>). This process is highly variable; diversification rates may vary over time with episodes of mass extinctions (<xref ref-type="bibr" rid="R52">Raup and Sepkoski, 1982</xref>) or elevated speciation rates (<xref ref-type="bibr" rid="R56">Sepkoski, 1998</xref>) and vary among branches with clades in high or low turnover (<xref ref-type="bibr" rid="R54">Sanderson and Donoghue, 1994</xref>, <xref ref-type="bibr" rid="R55">1996</xref>; <xref ref-type="bibr" rid="R27">Jetz et al., 2012</xref>). Moreover, we can speculate that diversification rate variation over time is associated with climatic or environmental factors (<xref ref-type="bibr" rid="R24">Hua and Wiens, 2013</xref>; <xref ref-type="bibr" rid="R10">Condamine et al., 2018</xref>; <xref ref-type="bibr" rid="R41">Palazzesi et al., 2022</xref>) whereas diversification rate variation among branches is associated with, amongst others, key innovations or changes in habitat (<xref ref-type="bibr" rid="R20">Hodges and Arnold, 1995</xref>; <xref ref-type="bibr" rid="R2">Allen and Gillooly, 2006</xref>; <xref ref-type="bibr" rid="R62">Weir and Schluter, 2007</xref>; <xref ref-type="bibr" rid="R58">Silvestro et al., 2014</xref>). Thus, we are ultimately interested in linking diversification rates to, for example, underlying ecological and environmental factors (<xref ref-type="bibr" rid="R10">Condamine et al., 2018</xref>). However, as a first step, we should infer diversification rates independently to learn if there was any diversification rate variation for the specific study group (<xref ref-type="bibr" rid="R7">Budd and Mann, 2024</xref>). Here, we will not consider branch-specific shifts in diversification rates in relation to the evolution of novel characters or changes in ecosystems, however we are nonetheless interested in identifying the branch-specific diversification rate shifts themselves. In particular, we are interested in where on the phylogeny the diversification rates shifted and the size of the shifts, in order to test hypotheses about the generation of biodiversity.</p><p id="P3">In recent years, several statistical approaches were developed to estimate branch-specific diversification rates from phylogenies (<monospace>BAMM</monospace>, <xref ref-type="bibr" rid="R48">Rabosky 2014</xref>; <monospace>ClaDS</monospace>, <xref ref-type="bibr" rid="R30">Maliet et al. 2019</xref>; <monospace>LSBDS</monospace>, <xref ref-type="bibr" rid="R21">Höhna et al. 2019</xref>; <monospace>MTBD</monospace>, <xref ref-type="bibr" rid="R4">Barido-Sottani et al. 2020</xref>; <monospace>MiSSE</monospace>, <xref ref-type="bibr" rid="R60">Vasconcelos et al. 2022</xref>; <monospace>RPANDA</monospace> <xref ref-type="bibr" rid="R34">Mazet et al. 2023</xref>; see <xref ref-type="bibr" rid="R31">Martínez-Gómez et al. 2024</xref> for a review). One key limitation of existing methods is that they are prohibitively slow. Existing methods rely on simulation techniques (i.e., Markov-chain Monte Carlo simulations together with data augmentation or stochastic mapping) with long run times (i.e., often days to weeks). To complicate matters, these highly complex simulation algorithms are slow to converge and can often fail (<xref ref-type="bibr" rid="R31">Martínez-Gómez et al., 2024</xref>). Thus, current methods are (i) impractical for phylogenies that contain many tips (i.e., &gt; 10, 000) which should be of main interest to study diversification rate variation (<xref ref-type="bibr" rid="R49">Rabosky et al., 2018</xref>), and (ii) too computationally demanding to explore model assumptions and behavior via large-scale simulation studies. We solve the computational bottleneck by developing a novel approach that deterministically computes branch-specific diversification rates on a given phylogeny. Thus, our approach does not suffer from convergence issues. Our approach uses the same underlying birth-death-shift process as developed by <xref ref-type="bibr" rid="R4">Barido-Sottani et al. (2020)</xref> and <xref ref-type="bibr" rid="R21">Höhna et al. (2019)</xref> and inherits its biological assumptions and statistical properties. Therefore, our new approach and the implementation in <monospace>RevBayes</monospace> (<xref ref-type="bibr" rid="R22">Höhna et al., 2016</xref>, <xref ref-type="bibr" rid="R21">2019</xref>) give identical estimates of the posterior mean branch-specific diversification rates, if the same parameters (i.e., diversification rate categories and shift rate) and model assumptions are chosen. However, our new approach is orders of magnitude faster.</p><p id="P4">An outstanding question is whether we can reliably infer the number and location of diversification rate shifts, or if we can only reliably estimate branch-specific diversification rates (<xref ref-type="bibr" rid="R57">Shi and Rabosky, 2015</xref>; <xref ref-type="bibr" rid="R36">Moore et al., 2016</xref>; <xref ref-type="bibr" rid="R35">Mitchell and Rabosky, 2017</xref>; <xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>). A change in diversification rates could either be explained by several small or a few large shifts. Therefore, the number of estimated diversification rate shifts depends strongly on the prior assumption on the shift rate (<xref ref-type="bibr" rid="R36">Moore et al., 2016</xref>; <xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>). Nevertheless, hypothesis testing using Bayes factors can be used to assess the support for alternative hypotheses despite sensitivity to the prior (<xref ref-type="bibr" rid="R28">Kass and Raftery, 1995</xref>). In this study we develop an efficient approach to infer the number and location of diversification rate shifts on phylogenies using Bayes factors (see also <xref ref-type="bibr" rid="R57">Shi and Rabosky, 2015</xref>).</p><p id="P5">Our approach for inferring branch-specific diversification rates and branch-specific rate shift events is inspired by Bayesian inference of ancestral discrete characters (<xref ref-type="bibr" rid="R63">Yang et al., 1995</xref>; <xref ref-type="bibr" rid="R39">Nielsen, 2002</xref>). However, we discovered that the probabilistic description of the birth-death-shift model is incompatible with established theory on Bayesian belief networks (<xref ref-type="bibr" rid="R44">Pearl, 1988</xref>). Specifically, we are not able to represent branch-specific diversification rates as random variables that are separable from the phylogeny (see <xref ref-type="supplementary-material" rid="SD1">Fig. S1</xref>). Thus, if we assume the phylogeny as “observed” data, then the branch-specific diversification rates are “unobserved” data instead of parameters of the model. This is an issue, as the prior probability and the likelihood of branch-specific diversification rates are conflated (see also <xref ref-type="bibr" rid="R33">May and Rothfels, 2023</xref>). We suspect that the inseparability of prior and likelihood is also relevant for previous approaches that used Bayesian inference to fit identical (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>; <xref ref-type="bibr" rid="R4">Barido-Sottani et al., 2020</xref>) or very similar stochastic processes (<xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>; <xref ref-type="bibr" rid="R30">Maliet et al., 2019</xref>; <xref ref-type="bibr" rid="R46">Quintero et al., 2024</xref>). Nevertheless, we conceptualize our approach using ideas and terminology from Bayesian inference theory (for more discussion see <xref ref-type="supplementary-material" rid="SD1">Supplementary Material Section S1</xref>).</p><p id="P6">We provide a Julia implementation of our new algorithm called <italic>Phylogenetic Estimation of Shifts in the Tempo of Origination (<monospace>Pesto</monospace>).</italic> The algorithm requires only two tree traversals: one postorder (from the tips to the root) and one preorder (from the root to the tips) tree traversal. The first pass over the tree is used to compute the likelihood scores and the second pass is used to compute and map the posterior mean branch-specific diversification rates. We show the time complexity of the algorithm for various tree sizes, demonstrating that <monospace>Pesto</monospace> infers robust branch-specific diversification rates and diversification rate shifts for phylogenies with &gt; 10, 000 taxa in a few minutes on a standard personal computer. We validate <monospace>Pesto</monospace> by showing that branch-specific diversification rate estimates are identical to estimates obtained using <monospace>LSBDS</monospace> (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>), up to some Monte Carlo error, when the identical model is used. Furthermore, we explore the behavior of <monospace>Pesto</monospace> using a simulation study and show that parameter estimation is robust given sufficiently large phylogenies. For example, estimates of the shift rate are less reliable when there are few shifts, i.e., if shifts are rare and/or if the phylogeny is small. Branch-specific diversification rates are robustly inferred even for small trees (minimum 100 taxa). Finally, we present a simulation study to explore the ability to estimate the number and location of diversification rate shifts. <monospace>Pesto</monospace> is conservative in the inference of diversification rate shift events with virtually no false positives, but has low power (i.e., more false negative shift event inferences).</p></sec><sec id="S2" sec-type="materials | methods"><title>Materials and Methods</title><sec id="S3"><title>The Underlying Theory of Phylogenetic Estimation of Shifts in the Tempo of Origination (PESTO)</title><p id="P7">Our new method <italic>Phylogenetic Estimation of Shifts in the Tempo of Origination (<monospace>Pesto</monospace>)</italic> relies on and extends existing methods for estimating branch-specific diversification rates. The underlying stochastic process in <monospace>Pesto</monospace> is equivalent to the <italic>birth-death-shift</italic> process (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>). The existing implementations of the birth-death-shift process and similar processes use computationally expensive techniques such as Markov chain Monte Carlo simulation with data augmentation (<xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>; <xref ref-type="bibr" rid="R30">Maliet et al., 2019</xref>; <xref ref-type="bibr" rid="R4">Barido-Sottani et al., 2020</xref>) or stochastic mapping (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>) to infer branch-specific diversification rates. The fundamental novelty of <monospace>Pesto</monospace> is our deterministic algorithm for calculating the posterior mean branch-specific diversification rates and the number of diversification rate shifts, conditional on the specific choice of diversification rate categories and shift rate. Unlike with simulation approaches, the calculations are performed only once and there is no randomness or inherent uncertainty in the inference procedure. Hence, we can run analyses in <monospace>Pesto</monospace> using trees that have tens of thousands of tips in a matter of minutes on a personal computer. We describe the details of the method in the following sections.</p><sec id="S4"><title>The birth-death-shift model</title><p id="P8"><monospace>Pesto</monospace> uses the same underlying birth-death-shift process as described by <xref ref-type="bibr" rid="R21">Höhna et al. (2019)</xref>, which we recapitulate here. The birth-death-shift process has a speciation rate <italic>λ</italic>, an extinction rate <italic>μ</italic>, as well as a shift rate <italic>η</italic>. Suppose one begins a tree simulation with a starting (root) node that represents the common ancestor of the clade, and that the root node has two descendant branches of unknown lengths. After a waiting time modeled as an exponentially distributed random variable (with rate <italic>λ</italic> + <italic>μ</italic> + <italic>η</italic>), there are three possible events. First, there can be a speciation event, with probability <italic>λ</italic>/(<italic>λ</italic> + <italic>μ</italic> + <italic>η</italic>), where two new branches are created. Second, there can be an extinction event, with probability <italic>μ</italic>/(<italic>λ</italic> + <italic>μ</italic> + <italic>η</italic>), where the branch terminates. Third, there can be a rate shift event, with probability <italic>η</italic>/(<italic>λ</italic> + <italic>μ</italic> + <italic>η</italic>). At a rate-shift event, a new set of diversification rates (i.e. the pair <italic>λ</italic>′,<italic>μ</italic>′) is chosen randomly, which we will explain in the following section. Note that we assume that the new diversification rates are independent of the old diversification rates (unlike <xref ref-type="bibr" rid="R30">Maliet et al., 2019</xref>; <xref ref-type="bibr" rid="R46">Quintero et al., 2024</xref>). After some time <italic>t</italic> has passed, the tree has either gone entirely extinct or it has survived. If the process survived, then each species is sampled with probability <italic>ρ</italic>. Finally, extinction events and unsampled species are pruned, resulting in a so-called “reconstructed tree”, meaning that the tree appears as if it was reconstructed from molecular or morphological data at the present.</p></sec><sec id="S5"><title>Base distribution of diversification rates</title><p id="P9">When a diversification rate shift event occurs in the birth-death-shift process, new diversification rates are drawn randomly from a base distribution. For example, <monospace>BAMM</monospace> uses an exponential base distribution (<xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>) and <xref ref-type="bibr" rid="R21">Höhna et al. (2019)</xref> proposed to use instead a log-normal distribution. However, any non-negative base distribution could in principle be used. Thus, in addition to the exponential and the log-normal base distributions, we also explored the use of a log-uniform and a gamma base distribution. We parameterized the base distributions in terms of their means and variances where applicable. Specifically, we specified the exponential distribution with a mean of <inline-formula><mml:math id="M1"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, the log-normal distribution with a median of <inline-formula><mml:math id="M2"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> and standard deviation of <italic>H</italic> ≈ 0.587 (meaning that the 2.5%–97.5% quantile interval of the base distribution spans one order of magnitude), and the log-uniform with a mean of <inline-formula><mml:math id="M3"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> and a span of one order of magnitude. For the gamma distribution, we set the scale and shape parameters such that the mean was <inline-formula><mml:math id="M4"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, and the variance was equal to that of the log-normal distribution. This results in four base distributions whose location is controlled by the <inline-formula><mml:math id="M5"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>-parameter, and the variance is either fixed or also determined by the <inline-formula><mml:math id="M6"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> parameter. We will discuss specific choices of <inline-formula><mml:math id="M7"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> and the variance later in section <italic>Estimating the parameters of the birth-death-shift model.</italic></p></sec><sec id="S6"><title>Discretization of diversification rates</title><p id="P10">Simulating a phylogeny under the birth-death-shift process with continuous base distributions is relatively straight forward. Moreover, modeling the base distributions as being fully continuous might be the preferable approach for inference. However, it is not trivial to calculate the probability of observing the phylogeny when using continuous base distributions. For the probability calculation to be computationally tractable, we follow the birth-death-shift implementation of the <monospace>LSBDS</monospace> model (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>) where an approximation approach is used.</p><p id="P11">Specifically, the continuous base distributions are discretized by splitting them into <italic>n</italic> bins with equal probability mass (i.e., the bins represent quantiles). This results in a vector of diversification rate <italic>classes,</italic> i.e., <inline-formula><mml:math id="M8"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>→</mml:mo></mml:mover></mml:math></inline-formula> for speciation rates, and <inline-formula><mml:math id="M9"><mml:mover accent="true"><mml:mtext>μ</mml:mtext><mml:mo>→</mml:mo></mml:mover></mml:math></inline-formula> for extinction rates. Next, we select all pairwise combinations of <inline-formula><mml:math id="M10"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>→</mml:mo></mml:mover></mml:math></inline-formula> and <inline-formula><mml:math id="M11"><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>→</mml:mo></mml:mover></mml:math></inline-formula> to form the vectors <bold>λ</bold> = [λ<sub>1</sub>, λ<sub>2</sub>,…, λ<sub>K</sub>] and <bold><italic>μ</italic></bold> = [<italic>μ</italic><sub>1</sub>, <italic>μ</italic><sub>2</sub>, …, <italic>μ</italic><sub>K</sub>], which represent the <italic>n</italic><sup>2</sup> = <italic>K</italic> diversification rate <italic>categories</italic> (see <xref ref-type="fig" rid="F1">Fig. 1</xref>). Choosing a higher number of rate classes will result in a better approximation of the base distributions (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>). In the limit of infinitely many rate classes, the birth-death-shift process with discrete and continuous base distributions for the diversification rates are equivalent. Therefore, we expect that inferences made using the discrete base distribution should converge and stabilize as more bins are used, however at the cost of increased computational time.</p></sec></sec><sec id="S7"><title>Computing the likelihood of the phylogeny</title><p id="P12">In this section we will explain how we compute the probability density of observing the phylogeny, as well as how we set up the likelihood function. While there are no known analytical solutions for the probabilities and probability densities, it is possible to find solutions using numerical methods. The idea is to express the change in probability (density) by considering which events (i.e., speciation, extinction or rate shift events) are possible in a small time interval Δ<italic>t</italic>, and taking the limit as Δ<italic>t</italic> → 0, in other words using differential equations (see <xref ref-type="bibr" rid="R29">Maddison et al., 2007</xref>; <xref ref-type="bibr" rid="R14">FitzJohn, 2012</xref>, for more details on how the differential equations are derived). As the data, we assume a rooted, bifurcating phylogenetic tree with branch lengths in units of time. We also assume that the tree is known without error. Note that the likelihood function (<xref ref-type="disp-formula" rid="FD4">Eq. 4</xref>) is analogous to the likelihood function of a state-dependent birth-death process without observed states (<xref ref-type="bibr" rid="R29">Maddison et al., 2007</xref>; <xref ref-type="bibr" rid="R14">FitzJohn, 2012</xref>; <xref ref-type="bibr" rid="R5">Beaulieu and O’Meara, 2016</xref>; <xref ref-type="bibr" rid="R16">Freyman and Höhna, 2018</xref>) and we repeat it here as we require the likelihood function and the probability density computations to derive our algorithm to deterministically compute the posterior mean branch-specific diversification rates.</p><p id="P13">Conceptually, our algorithm contains the following steps. First, we calculate the extinction probabilities (<bold>E</bold>(<italic>t</italic>)), which are invariant to the topology and divergence times. Second, we calculate the probability density of observing the tree (<bold>D</bold>(<italic>t</italic>)). Since the probability density depends on the topology and divergence times, it needs to be computed for each branch in a postorder tree traversal. Third, we use the probability density of observing the tree to set up the likelihood function. Note that we write scalars in plain typeface and vectors and matrices in bold. We treat vectors as matrices with a single column and transposed vectors as matrices with a single row. See <xref ref-type="supplementary-material" rid="SD1">table S1</xref> for an overview of the notation and symbols that are used.</p><sec id="S8"><title>Computing extinction probabilities</title><p id="P14">In order to calculate the extinction probabilities, we use the following system of differential equations (<xref ref-type="bibr" rid="R29">Maddison et al., 2007</xref>): <disp-formula id="FD1"><label>(1)</label><mml:math id="M12"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mi>μ</mml:mi><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>λ</mml:mi></mml:mstyle><mml:mo>+</mml:mo><mml:mi>μ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>⊙</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>λ</mml:mi></mml:mstyle><mml:mo>⊙</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>⊙</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>Q</mml:mi><mml:mi>E</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P15">More precisely, <italic>E<sub>j</sub>(t)</italic> represents the probability that a lineage that was in rate category <italic>j</italic> at time <italic>t</italic> went extinct before the present or was not sampled in the phylogeny. Note that we use the symbol ⊙ to represent element-wise multiplication. The matrix <bold>Q</bold> has entries –<italic>η</italic> on the diagonal, and entries <italic>η</italic>/(<italic>K</italic> – 1) elsewhere. For example in the case of a three-category model, <bold>Q</bold> would be <disp-formula id="FD2"><label>(2)</label><mml:math id="M13"><mml:mrow><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>Q</mml:mi></mml:mstyle><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mrow><mml:mo>−</mml:mo><mml:mi>η</mml:mi></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mi>η</mml:mi><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mi>η</mml:mi><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mi>η</mml:mi><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mo>−</mml:mo><mml:mi>η</mml:mi></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mi>η</mml:mi><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mi>η</mml:mi><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mi>η</mml:mi><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mo>−</mml:mo><mml:mi>η</mml:mi></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P16">We allow for the possibility that the taxa are incompletely sampled, but we assume an equal probability of taxon sampling (<xref ref-type="bibr" rid="R13">FitzJohn, 2010</xref>; <xref ref-type="bibr" rid="R23">Höhna et al., 2011</xref>). Therefore, the initial values of the extinction probabilities are all set to <italic>E<sub>j</sub></italic>(<italic>t</italic> = 0) = 1 – <italic>ρ,</italic> where <italic>ρ</italic> is the known/fixed taxon sampling fraction.</p></sec><sec id="S9"><title>Computing the probability density of the observed branches</title><p id="P17">The probability of observing the branch (or subtree) at time <italic>t</italic> is likewise represented as a set of differential equations (<xref ref-type="bibr" rid="R29">Maddison et al., 2007</xref>; <xref ref-type="bibr" rid="R14">FitzJohn, 2012</xref>): <disp-formula id="FD3"><label>(3)</label><mml:math id="M14"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>D</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mo>−</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>λ</mml:mi></mml:mstyle><mml:mo>−</mml:mo><mml:mi>μ</mml:mi><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>λ</mml:mi></mml:mstyle><mml:mo>⊙</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo>⊙</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>D</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>Q</mml:mi></mml:mstyle><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>D</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>M</italic> is the branch index. Specifically, if <italic>M</italic> is a terminal branch, then <italic>D<sub>M,j</sub></italic> (<italic>t</italic>t) is the probability of observing the branch if the process was in category <italic>j</italic> at time <italic>t</italic>. If M is an internal branch, then <italic>D<sub>M,j</sub></italic>(<italic>t</italic>) represents the probability density of observing the subtree descended from branch <italic>M</italic>. For initial values, we assign <italic>D<sub>Mj</sub></italic>(<italic>t</italic> = 0) = <italic>ρ</italic> for all categories <italic>j</italic> if <italic>M</italic> is a terminal branch. For internal branches, the initial (youngest) value of a branch <italic>M</italic> is assigned to <bold>D</bold><sub><italic>M</italic></sub>(<italic>t</italic>) := <bold>D</bold><sub><italic>A</italic></sub>(<italic>t</italic>) ⊙ <bold>D</bold><sub><italic>B</italic></sub>(<italic>t</italic>) ⊙ <bold>λ</bold>, where the branches <italic>A</italic> and <italic>B</italic> are the descendants of branch <italic>M</italic>. We iterate and solve <bold>D</bold><sub><italic>M</italic></sub> (<italic>t</italic>) for all branches <italic>M</italic> in a postorder traversal of the tree (<xref ref-type="fig" rid="F2">Fig. 2a–c</xref>) until the root node (<bold>D</bold><sub><italic>R</italic></sub>(<italic>t</italic>)) is reached.</p></sec><sec id="S10"><title>Computing the probability of observing the tree (likelihood)</title><p id="P18">The likelihood function for the birth-death-shift process is defined as the weighted average of the probabilities at the root node (<xref ref-type="disp-formula" rid="FD3">Eq. 3</xref>) over all diversification rate categories. When calculating the likelihood of observing the tree, we condition on (i) that the two branches subtending from the root survived until the present, and (ii) that there was a speciation event at the root: <disp-formula id="FD4"><label>(4)</label><mml:math id="M15"><mml:mrow><mml:mi>L</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>η</mml:mi><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mi>ρ</mml:mi><mml:mo>∣</mml:mo><mml:mi>Ψ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>K</mml:mi></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>R</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>R</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>R</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>t<sub>R</sub></italic> is the age of the root, Ψ represents the phylogeny (i.e., topology and branch lengths), and we follow <xref ref-type="bibr" rid="R40">Pagel (1994)</xref> in using a flat prior probability (1/<italic>K</italic>) of being in any of the diversification rate categories at the root (see also <xref ref-type="bibr" rid="R18">Goldberg and Igić, 2008</xref>; <xref ref-type="bibr" rid="R15">FitzJohn et al., 2009</xref>; <xref ref-type="bibr" rid="R14">FitzJohn, 2012</xref>, for alternative root treatments).</p></sec><sec id="S11"><title>Estimating the parameters of the birth-death-shift model</title><p id="P19"><xref ref-type="bibr" rid="R21">Höhna et al. (2019)</xref> argued for estimating the shift rate <italic>η</italic> jointly with the parameters of the base distributions (<inline-formula><mml:math id="M16"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> and <inline-formula><mml:math id="M17"><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>) using Bayesian inference while <xref ref-type="bibr" rid="R50">Rabosky et al. (2014)</xref> advocates using an empirical Bayes approach to estimate the prior means of the base distributions under a constant rate birth-death process and the shift rate <italic>η</italic> is replaced with a geometric distribution directly on the number of shift events (<xref ref-type="bibr" rid="R35">Mitchell and Rabosky, 2017</xref>). We discovered, however, that estimating the base distribution parameters and the shift rate jointly is more difficult than previously thought. The joint likelihood surface includes many local optima and a hill-climber algorithm can easily get stuck in these local optima (<xref ref-type="supplementary-material" rid="SD1">Fig. S6</xref>). As a compromise, we settled for a two-step approach (<xref ref-type="fig" rid="F1">Fig. 1</xref>). This involves first finding the maximum-likelihood estimates for <inline-formula><mml:math id="M18"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, <inline-formula><mml:math id="M19"><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> using the simpler lineage-homogeneous constant-rate birth-death model (as done in <xref ref-type="bibr" rid="R50">Rabosky et al., 2014</xref>). Second, we infer <italic>η</italic> by maximizing the likelihood of the birth-death-shift model while keeping the other parameters fixed <disp-formula id="FD5"><label>(5)</label><mml:math id="M20"><mml:mrow><mml:mi>L</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>η</mml:mi><mml:mo>∣</mml:mo><mml:mi>Ψ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>η</mml:mi><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mi>ρ</mml:mi><mml:mo>∣</mml:mo><mml:mi>Ψ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P20">This is also called an estimated likelihood function (<xref ref-type="bibr" rid="R42">Pawitan, 2001</xref>, p. 274), with which we did not encounter any local optima issues. We note, however, that the estimated base distribution parameters and shift rate using the two-step approach are not necessarily the same as the true maximum likelihood estimates, and the optimal approach for selecting or estimating the diversification rate base distribution and shift rate requires further research.</p></sec></sec><sec id="S12"><title>The posterior distribution of rate shift histories</title><p id="P21">It is not possible to directly observe the true rate shift history on a phylogeny except in the case of simulated phylogenies. When we wish to make inferences about the birth-death-shift process that led to an “observed” phylogeny, we consider the diversification rate shift history to be an unobserved random variable. As we can not observe it directly, we calculate the likelihood by considering all possible diversification rate shift histories that could have led to the phylogeny in question (<xref ref-type="disp-formula" rid="FD4">Eq. 4</xref>). In other words, when calculating the likelihood, we integrate across all possible realizations of the diversification rate shift history. By doing so, however, we are omitting several aspects of interest. For example, we are interested in the branch-specific diversification rates and how many diversification rate shift events occurred, across branches and across time. Therefore, we wish to investigate the posterior distribution of diversification rate shift histories, i.e., the probability distribution of the diversification rate shift histories conditioned on the data. <xref ref-type="bibr" rid="R21">Höhna et al. (2019)</xref> showed how one could approximate the posterior distribution of the diversification rate shift histories using stochastic mappings similar to stochastic character mapping for discrete character evolution (<xref ref-type="bibr" rid="R25">Huelsenbeck et al., 2003</xref>). By simulating many samples of the posterior distribution of diversification rate shift histories, one can compute summaries such as the posterior mean branch-specific diversification rate, the posterior mean number of diversification rate shift events, or the posterior probability that there was at least one diversification rate shift. In order for this sampling approach to yield a good approximation of the posterior distribution, one must i) simulate with small step sizes in time, and ii) repeat the stochastic mapping thousands or millions of times. Accordingly, one of the main disadvantages of the stochastic mapping approach is its slow run time and computational burden, although it is more efficient than data augmentation (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>).</p><p id="P22">In the next sections, we will outline a deterministic algorithm that gives equivalent summaries of the posterior distribution. Instead of using stochastic mappings, this algorithm is entirely non-random (i.e., it is deterministic), and thus will yield the same results every time the algorithm is executed. Notably, we will compute i) the posterior probability that the process was in a particular diversification rate category, ii) the posterior mean branch-specific diversification rates, iii) the posterior mean number of branch-specific rate shift events, iv) the posterior probability that there was at least one rate shift event at a given branch, and v) the Bayes factor for the support of the hypothesis that there was at least one rate shift event at a given branch. These calculations are facilitated by simple formulae or differential equations that need to be solved only once per branch. Compared with stochastic mapping, our approach is much more computationally efficient and consequently the inferences can be made in a fraction of the time.</p><sec id="S13"><title>Performing a preorder traversal to calculate posterior rate category probabilities</title><p id="P23">We use a dynamic programming approach to compute the posterior probabilities of the rate categories (<xref ref-type="fig" rid="F3">Fig. 3</xref>), specifically the backward-forward algorithm (<xref ref-type="bibr" rid="R47">Rabiner, 1989</xref>) extended to accommodate a tree structure (<xref ref-type="bibr" rid="R43">Pearl, 1982</xref>). The motivation for applying the backward-forward algorithm is based on the fact that the birth-death-shift process can along a lineage be seen as a hidden Markov model where the diversification rate categories are the hidden states. The backward pass of the algorithm was explained previously, where we calculated the probabilities <bold>D</bold><sub><italic>M</italic></sub>(<italic>t</italic>). In the forward pass, we calculate the forward probabilities <bold>F</bold><sub><italic>M</italic></sub>(<italic>t</italic>). Specifically, <italic>F<sub>M,j</sub></italic>(<italic>t</italic>) represents the probability that the rate category was <italic>j</italic> on branch <italic>M</italic> at time <italic>t</italic>, given the part of the phylogeny that is not descended from branch <italic>M</italic> at time <italic>t.</italic> At the root node <italic>R,</italic> there is no ancestral node, meaning that <italic>F<sub>R,j</sub></italic>(<italic>t<sub>R</sub></italic>) represents the prior probability of the rate category being <italic>j</italic>. We assume that the ancestral diversification rate is a random variable that is distributed according to the (discretized) base distribution. Therefore, we initialize <italic>F<sub>R,j</sub></italic>(<italic>t</italic>) to 1/<italic>K</italic> at the root node (recall that each diversification rate category represents quantile intervals with equal probability mass). When initializing <italic>F<sub>R,j</sub></italic>(<italic>t</italic>), we also condition on i) survival and ii) that there was a speciation event at the root, in the same manner as in the likelihood function (<xref ref-type="disp-formula" rid="FD4">Eq. 4</xref>). Since the rate category variable is the only random variable (<inline-formula><mml:math id="M21"><mml:mrow><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mi>η</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mi>ρ</mml:mi></mml:mrow></mml:math></inline-formula> are fixed to their estimates), there are no other priors (see <xref ref-type="supplementary-material" rid="SD1">Figure S1</xref>). In order to solve for <bold>F</bold><italic><sub>M</sub></italic>(<italic>t</italic>) along the branches, we use the following set of differential equations <disp-formula id="FD6"><label>(6)</label><mml:math id="M22"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>F</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>λ</mml:mi></mml:mstyle><mml:mo>+</mml:mo><mml:mi>μ</mml:mi><mml:mo>−</mml:mo><mml:mn>2</mml:mn><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>λ</mml:mi></mml:mstyle><mml:mo>⊙</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo>⊙</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>F</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>Q</mml:mi></mml:mstyle><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>F</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P24">Note that <italic>d</italic><bold>F</bold>/<italic>dt</italic> is equal to <italic>d</italic><bold>D</bold>/<italic>dt</italic>, except the sign has changed on both the left and the right sides. The reason for the change in sign is that we are solving <italic>d</italic><bold>F</bold>/<italic>dt</italic> in forward time (from ancient to recent), and therefore the time differential <italic>dt</italic> is negative.</p><p id="P25">Once we have solved <bold>F</bold><sub><italic>M</italic></sub>(<italic>t</italic>), we compute posterior probabilities of the rate categories (see the <xref ref-type="supplementary-material" rid="SD1">supplementary material</xref> for a discussion on the posterior). They are given as follows <disp-formula id="FD7"><label>(7)</label><mml:math id="M23"><mml:mrow><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>S</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>α</mml:mi><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>F</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="0.2em"/><mml:mo>⊙</mml:mo><mml:mspace width="0.2em"/><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>D</mml:mi></mml:mstyle><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>α</italic> is a normalizing factor such that <bold>S</bold><sub><italic>M</italic></sub>(<italic>t</italic>) sums to one (<xref ref-type="fig" rid="F3">Fig. 3</xref>, see <xref ref-type="bibr" rid="R43">Pearl 1982</xref>, <xref ref-type="bibr" rid="R44">1988</xref>). In summary, the preorder traversal consists of two steps. First, we initialize <bold>F</bold><italic><sub>M</sub></italic>(<italic>t</italic>) := <bold>S</bold><italic><sub>P</sub></italic>(<italic>t</italic>) ⊘ <bold>D</bold><sub><italic>M</italic></sub>(<italic>t</italic>, where <italic>P</italic> is the parental branch, <italic>t</italic> is the divergence time, and ⊘ represents element-wise division. Second, we solve <bold>F</bold>(<italic>t</italic>) along branch <italic>M</italic>. We repeat these two steps for all descendant branches, in a preorder traversal of the tree (<xref ref-type="fig" rid="F2">Fig. 2d–f</xref>). When the preorder traversal is completed, the backward-forward algorithm is also completed.</p></sec><sec id="S14"><title>Estimating the posterior mean branch-specific diversification rates</title><p id="P26">Estimating branch-specific diversification rates is a key result for any method that fits the birth-death-shift process to a phylogeny. We consider the diversification rate shift history and thus also the branch-specific diversification rates as random variables. For a given branch <italic>M</italic> and a time <italic>t</italic>, the moments of the speciation rate λ<sub>M</sub>(<italic>t</italic>) are weighted averages of the speciation rate categories <italic>λ<sub>j</sub></italic>, with the weights given by their posterior probabilities, which we can use to compute the posterior mean and variance <disp-formula id="FD8"><label>(8)</label><mml:math id="M24"><mml:mtable columnalign="left"><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mspace width="1em"/><mml:mrow><mml:mi mathvariant="double-struck">E</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mi>∑</mml:mi><mml:mi>j</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mstyle><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:mi>Var</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mi>∑</mml:mi><mml:mi>j</mml:mi></mml:munder><mml:mrow><mml:msubsup><mml:mi>λ</mml:mi><mml:mi>j</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mstyle><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mstyle displaystyle="true"><mml:munder><mml:mi>∑</mml:mi><mml:mi>j</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mstyle><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula></p><p id="P27">This can for example be used to compute tip rates, where the posterior mean speciation rates are computed at the present. To summarize over a branch as a whole, we use the symbol <inline-formula><mml:math id="M25"><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo stretchy="true">¯</mml:mo></mml:mover></mml:mrow><mml:mi>M</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, and get the expectation by integrating over the time span and dividing by the length of the branch: <disp-formula id="FD9"><label>(9)</label><mml:math id="M26"><mml:mi mathvariant="double-struck">E</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mi>M</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>old</mml:mtext></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>young</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:mrow><mml:msubsup><mml:mo>∫</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>young</mml:mtext></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>old</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:msubsup><mml:mrow><mml:mstyle displaystyle="true"><mml:munder><mml:mi>∑</mml:mi><mml:mi>j</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:mrow></mml:mstyle><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:math></disp-formula> meaning that <inline-formula><mml:math id="M27"><mml:mrow><mml:mi mathvariant="double-struck">E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo stretchy="true">¯</mml:mo></mml:mover></mml:mrow><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> is the posterior mean speciation rate for branch <italic>M</italic>, and <italic>t</italic><sub>young</sub>, <italic>t</italic><sub>old</sub> represent the youngest and oldest times of branch <italic>M</italic> (<xref ref-type="fig" rid="F3">Fig. 3</xref>). If one is interested in the variance of <inline-formula><mml:math id="M28"><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo stretchy="true">¯</mml:mo></mml:mover></mml:mrow><mml:mi>M</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, it is possible to approximate the integral by splitting the branch into <italic>c</italic> discrete bins represented by <italic>λ</italic>(<italic>t</italic><sub>1</sub>), <italic>λ</italic>(<italic>t</italic><sub>2</sub>),… etc. Then, we can apply the standard formula for the variance of a linear combination of correlated random variables <disp-formula id="FD10"><label>(10)</label><mml:math id="M29"><mml:mi>Var</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mi>M</mml:mi></mml:msub></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msup><mml:mi>c</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>a</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>c</mml:mi></mml:munderover><mml:mrow><mml:mi>Var</mml:mi></mml:mrow></mml:mstyle><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>a</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msup><mml:mi>c</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>a</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>c</mml:mi></mml:munderover><mml:mspace width="0.2em"/><mml:mrow><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>b</mml:mi><mml:mo>&gt;</mml:mo><mml:mi>a</mml:mi></mml:mrow><mml:mi>c</mml:mi></mml:munderover><mml:mrow><mml:mi>Cov</mml:mi></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>a</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>b</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:math></disp-formula></p><p id="P28">Since the time bins are not independent, it is necessary to calculate the covariance, which one can calculate as <disp-formula id="FD11"><label>(11)</label><mml:math id="M30"><mml:mtable columnalign="left"><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:mi>Cov</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>a</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>b</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:mspace width="0.2em"/><mml:mrow><mml:mstyle displaystyle="true"><mml:munderover><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>a</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>a</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mi>b</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"/><mml:mtd columnalign="left"><mml:mrow><mml:mo>×</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:mi mathvariant="double-struck">E</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>a</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:mi mathvariant="double-struck">E</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>b</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:math></disp-formula> where <italic>S<sub>M,j</sub></italic>(<italic>t<sub>a</sub></italic>) is the marginal probability of the diversification rate category being <italic>j</italic> at time <italic>t<sub>a</sub>,</italic> and <italic>P<sub><italic>M,ij</italic></sub></italic>(<italic>t<sub>a</sub></italic>, <italic>t<sub>b</sub></italic>) is the transition probability from category <italic>j</italic> at time <italic>t<sub>a</sub></italic> to category <italic>i</italic> at a younger time <italic>t<sub>b</sub></italic>, normalized such that <italic>P<sub>M,ij</sub></italic>(<italic>t<sub>a</sub></italic>,<italic>t<sub>b</sub></italic>) sums to one over the departure categories <italic>j</italic>. We note that computing the variance of the branch-specific speciation rates is significantly more computationally expensive than computing the mean. For more details on how to calculate the posterior variance of the speciation rate, see the <xref ref-type="supplementary-material" rid="SD1">supplementary material</xref>.</p><p id="P29">If one is interested in the posterior mean and variance of the branch-specific extinction rate, net-diversification rate, or relative extinction rate, one can substitute <italic>λ<sub>j</sub></italic> for <italic>μ<sub>j</sub></italic>, <italic>λ<sub>j</sub></italic> – <italic>μ<sub>j</sub></italic>, or <italic>μ<sub>j</sub></italic>/<italic>λ<sub>j</sub></italic>, respectively, and use the same formulae. In order to evaluate the integrals, we use Gauss-Legendre quadrature with <italic>n</italic> =10 points. We want to emphasize that previous methods (<xref ref-type="bibr" rid="R17">Freyman and Höhna, 2019</xref>; <xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>) used <xref ref-type="disp-formula" rid="FD7">Eq. 7</xref> to simulate the branch-specific diversification rates (i.e., stochastic mappings), whereas Pesto uses <xref ref-type="disp-formula" rid="FD9">Eq. 9</xref> to compute the posterior mean deterministically. To present the results, we plot the posterior mean branch-specific diversification rates on the tree, however standard visualizations like scatter plots or histograms can also be used.</p></sec><sec id="S15"><title>Estimating the number of rate shifts</title><p id="P30">Another key property of the birth-death-shift process that we are interested in is the number of diversification rate shift events that occurred across a phylogeny. As for the branch-specific diversification rates, the number of diversification rate shifts for a particular branch is also a random variable, which we will summarize by computing the posterior mean. The idea is to compute the average number of diversification rate shifts in a small time interval Δ<italic>t</italic>, by computing the probability of a rate shift from rate category <italic>j</italic> to a different rate category <italic>i</italic>, and multiplying by the posterior probability that the process was in rate category <italic>j</italic> at the time. By summing the number of diversification shifts over several small time intervals Δ<italic>t</italic><sub>1</sub>, Δ<italic>t</italic><sub>2</sub>,… across the branch, we can calculate the total number of rate shifts across the time span of the branch. In the limit of Δ<italic>t</italic> → 0, the number of rate shifts converge to zero, however the change in the average number of rate shifts per time can still be expressed as a differential equation: <disp-formula id="FD12"><label>(12)</label><mml:math id="M31"><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtable columnalign="left"><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mfrac><mml:mi>η</mml:mi><mml:mrow><mml:mi>K</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mtext>if</mml:mtext><mml:mspace width="0.3em"/><mml:mi>j</mml:mi><mml:mo>≠</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mn>0</mml:mn></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mtext>if</mml:mtext><mml:mspace width="0.2em"/><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow></mml:math></disp-formula> where <inline-formula><mml:math id="M32"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> is the posterior mean number of accumulated rate shifts from a diversification rate category <italic>j</italic> to another diversification rate category <italic>i</italic> from the beginning of branch <italic>M</italic> until a younger time <italic>t.</italic> The initial value is <inline-formula><mml:math id="M33"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mtext>old</mml:mtext></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:math></inline-formula> and the time steps <italic>dt</italic> are negative. For the posterior mean number of diversification rate shifts to be of any note (i.e., non-zero), two conditions must be met. First, the posterior probability that the process was in the departure category <italic>j</italic> at time <italic>t</italic> must be non-zero. Second, the probability density (of observing the tree, given the process was in the rate category) of the arrival category <italic>i</italic> must be equal or larger than that of the departure category <italic>j</italic> (i.e., <italic>D<sub>M,i</sub></italic>(<italic>t</italic>) ⩾ <italic>D<sub>M,j</sub></italic>(<italic>t</italic>)). For details on how the expression is derived, see the <xref ref-type="supplementary-material" rid="SD1">supplementary material</xref>. Since we can compute <inline-formula><mml:math id="M34"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> for all diversification rate shifts from any diversification rate category <italic>j</italic> to any other category <italic>i</italic>, we can build a rate shift matrix: <disp-formula id="FD13"><label>(13)</label><mml:math id="M35"><mml:msub><mml:mover accent="true"><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>N</mml:mi></mml:mstyle><mml:mo stretchy="true">^</mml:mo></mml:mover><mml:mi>M</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mn>0</mml:mn></mml:mtd><mml:mtd><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mtd><mml:mtd><mml:mo>…</mml:mo></mml:mtd><mml:mtd><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mi>K</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mn>21</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mtd><mml:mtd><mml:mn>0</mml:mn></mml:mtd><mml:mtd/><mml:mtd/></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd><mml:mtd/><mml:mtd><mml:mo>⋱</mml:mo></mml:mtd><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>K</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mtd><mml:mtd/><mml:mtd><mml:mo>…</mml:mo></mml:mtd><mml:mtd><mml:mn>0</mml:mn></mml:mtd></mml:mtr></mml:mtable></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:math></disp-formula> and group the elements <inline-formula><mml:math id="M36"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math></inline-formula> depending on which specific question we are interested in. For example, one can group <inline-formula><mml:math id="M37"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> by whether it was the speciation rate or extinction rate that shifted. Another use case is to estimate the number of diversification rate shifts of a minimum shift size (e.g., <italic>λ<sub>i</sub></italic> – <italic>λ<sub>j</sub></italic> &gt; 0.2). In the remainder of the manuscript, we will only focus on the total number of shifts, <inline-formula><mml:math id="M38"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>M</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:msub><mml:mi>∑</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mstyle displaystyle="true"><mml:msub><mml:mi>∑</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:mrow></mml:math></inline-formula>, regardless of whether it was a shift in the speciation or extinction rate or both. If only the total number of diversification rate shifts is of interest, it is possible to simplify <xref ref-type="disp-formula" rid="FD12">Eq. 12</xref> to the following <disp-formula id="FD14"><label>(14)</label><mml:math id="M39"><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:msub><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtable columnalign="left"><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mi>η</mml:mi></mml:mrow><mml:mrow><mml:mi>K</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mstyle displaystyle="true"><mml:msub><mml:mi>∑</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mstyle displaystyle="true"><mml:msub><mml:mi>∑</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mtext>if</mml:mtext><mml:mspace width="0.2em"/><mml:mi>j</mml:mi><mml:mo>≠</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mn>0</mml:mn></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mtext>if</mml:mtext><mml:mspace width="0.2em"/><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow></mml:math></disp-formula> yielding the same result. We emphasize that <inline-formula><mml:math id="M40"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> is not the probability that a diversification rate shift occurred. In a realization of the birth-death-shift process, the number of diversification rate shift events are integers, for example 0, 1 or 2. The posterior mean number of diversification rate shifts <inline-formula><mml:math id="M41"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> is a measure of the average or expected number of diversification rate shifts, which can take continuous values, for example 0.01 or 0.95. While this may seem counter-intuitive, it is not unlike how a six-sided dice roll has an expectation of 3.5.</p></sec><sec id="S16"><title>Identification of branches with strong support for a diversification rate shift</title><p id="P31">In the previous section we derived an approach to estimate the posterior mean branch-specific number of diversification rate shifts. Next, we focus on estimating whether a branch experienced at least one significant diversification rate shift. More specifically, we calculate the posterior probability of no diversification rate shifts in a small time interval Δ<italic>t</italic>. Over a longer time interval such as a branch, the joint probability of no diversification rate shifts can then be calculated as the product of posterior probabilities over successive small time intervals Δ<italic>t</italic><sub>1</sub>, Δ<italic>t</italic><sub>2</sub>, etc. For computational convenience we replace the product with a sum by using log-transformed probabilities and we express the change in the sum as a differential equation. This allows us to use standard differential equation solvers (<italic>T</italic>sitouras, 2011), which give more precise solutions. Specifically, we calculate the posterior probability of no diversification rate shifts originating from rate category <italic>j</italic> on branch <italic>M</italic>, conditional on the process beginning in rate category <italic>j</italic>, represented by the quantity <italic>X<sub>M,j</sub></italic>(<italic>t</italic>). The following differential equation describes how log <italic>X<sub>M,j</sub></italic>(<italic>t</italic>) changes over time <disp-formula id="FD15"><label>(15)</label><mml:math id="M42"><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:mi>log</mml:mi><mml:msub><mml:mi>X</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfrac><mml:mi>η</mml:mi><mml:mrow><mml:mi>K</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac><mml:mfrac><mml:mrow><mml:mstyle displaystyle="true"><mml:msub><mml:mi>∑</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>≠</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:math></disp-formula> where the initial value is log <italic>X<sub>j</sub></italic>(<italic>t</italic><sub>old</sub>) = 0, and <italic>dt</italic> &lt; 0. We provide details of the derivation in the <xref ref-type="supplementary-material" rid="SD1">supplementary material</xref>. Next, we take the weighted average across the diversification rate categories <italic>j</italic>, with the weights being the posterior probabilities for the ancestral rate categories (at the beginning of the branch), and take the complement. This gives us the posterior probability that there was at least one rate shift <disp-formula id="FD16"><label>(16)</label><mml:math id="M43"><mml:msub><mml:mi>P</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mo>⩾</mml:mo><mml:mn>1</mml:mn><mml:mspace width="0.3em"/><mml:mtext>shifts</mml:mtext><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mi>∑</mml:mi><mml:mi>j</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>old</mml:mtext></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>log</mml:mi><mml:mspace width="0.2em"/><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>young</mml:mtext></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:math></disp-formula></p><p id="P32">If we want a measure of support for the hypothesis of at least one diversification rate shift on a branch, we can calculate the Bayes factor (<xref ref-type="bibr" rid="R57">Shi and Rabosky, 2015</xref>) <disp-formula id="FD17"><label>(17)</label><mml:math id="M44"><mml:mtext>Bayes</mml:mtext><mml:mspace width="0.2em"/><mml:mtext>factor</mml:mtext><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mi>P</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mo>⩾</mml:mo><mml:mn>1</mml:mn><mml:mspace width="0.2em"/><mml:mtext>shifts</mml:mtext><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>π</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mo>⩾</mml:mo><mml:mn>1</mml:mn><mml:mspace width="0.2em"/><mml:mtext>shifts</mml:mtext><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mrow><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mi>P</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mn>0</mml:mn><mml:mspace width="0.2em"/><mml:mtext>shifts</mml:mtext><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>π</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mn>0</mml:mn><mml:mspace width="0.2em"/><mml:mtext>shifts</mml:mtext><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:math></disp-formula> where we use <italic>π<sub><italic>M</italic></sub></italic> (0 shifts) = <italic>e</italic><sup>−(<italic>t</italic><sub>old</sub>– <italic>t</italic><sub>young</sub>)<italic>η</italic></sup> as an approximation for the prior probability of 0 diversification rate shifts —i.e., the probability of 0 events under a Poisson distribution with rate (<italic>t</italic><sub>old</sub> – <italic>t</italic><sub>young</sub>)<italic>η</italic>.</p><p id="P33">In our exploration of how the model fitted to several test datasets, we noticed that very short branches, which have an extremely low prior probability of a diversification rate shift, can produce strongly supported Bayes factors even though the posterior mean number of diversification rates shifts is very low (e.g., <inline-formula><mml:math id="M45"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> &lt; 0.05). Therefore, when considering whether a branch showed strong support for a diversification rate shift event, we employed two criteria. First, we required the rate shift event to have a Bayes factor of more than 10 (<xref ref-type="bibr" rid="R26">Jeffreys, 1961</xref>; <xref ref-type="bibr" rid="R28">Kass and Raftery, 1995</xref>). Second, we required the branch to deviate substantially from an estimate of 0 rate shifts, thus we picked <inline-formula><mml:math id="M46"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> &gt; 0.5 as a conservative criterion.</p></sec></sec><sec id="S17"><title>Birth-death-shift simulations</title><p id="P34">To assess the performance of <monospace>Pesto</monospace>, we designed a procedure to simulate trees under the birth-death-shift process. We use a forward-simulation approach, in other words we begin at the root and move towards the tips. This approach generates “complete trees”, i.e., trees that also include extinct tips. Our simulator for complete trees rejects the tree if i) the number of lineages exceeds the maximum, or ii) if one or both subtrees descending from the root went extinct. In other words, we only accept trees where both the left and the right descendant branches of the root node have at least one surviving species (i.e., conditioning on survival of both daughter lineages of the root, see <xref ref-type="disp-formula" rid="FD4">Eq. 4</xref>). Next, we prune the extinct lineages from the complete trees to form “reconstructed” trees. The information about diversification rate shifts on the surviving lineages is kept, while the records of diversification rate shifts on the extinct lineages is discarded. These final trees only have tips at the present, and appear as if the tree was reconstructed or inferred based on molecular or morphological characters of extant species.</p><sec id="S18"><title>Simulation specifics</title><p id="P35">We simulated phylogenies under different settings to assess the performance of the <monospace>Pesto</monospace> inferences in different scenarios. Specifically, we used several models with three rate categories, ranging from low to high net-diversification rates (<xref ref-type="table" rid="T1">Table 1</xref>), with constant relative extinction (<italic>μ</italic>/<italic>λ</italic>). The initial diversification rate category was always the one with the lowest net-diversification rate, meaning that i) the first rate shift that could happen must be an upwards shift, and that we ii) expected upward shifts to be more common. We varied the range of rate variation (from tiny to large), meaning that the difference among the rate categories <italic>λ<sub>j</sub></italic> within each model was varying. Moreover, we simulated trees with a time interval ranging from 25 to 125 Ma, resulting in different distributions of tree size. For computational purposes, we rejected simulations with too many tips (&gt; 50, 000), leading to a truncated distribution. We simulated 100 phylogenetic trees for each setting, meaning that there were in total 2000 simulated trees (5 time intervals and 4 levels of rate variation).</p><p id="P36">We tested the performance of Pesto under three different scenarios. First, we used the true diversification rate categories <bold><italic>λ</italic></bold> and <bold><italic>μ</italic></bold> and the true shift rate <italic>η</italic>. Second, we used the true diversification rate categories, but we assumed the shift rate to be unknown. Third, we assumed that both the diversification rate categories and the shift rate were were unknown. This allowed us to assess the estimates of the shift rate parameter, the inference of significant branch-specific diversification rate shifts, as well as the estimates of the branch-specific diversification rates, in various scenarios of parameter (un)certainty. To assess the inference of branch-specific diversification rate shift inferences, we used metrics that are standard in binary classification problems, including accuracy, false positive ratio, and false negative ratio (<xref ref-type="bibr" rid="R45">Powers, 2011</xref>).</p></sec></sec><sec id="S19"><title>Implementation</title><p id="P37">We implemented our inference method in the <monospace>Julia</monospace> (<xref ref-type="bibr" rid="R6">Bezanson et al., 2017</xref>) module <monospace>Pesto</monospace>. <monospace>Pesto</monospace> is an acronym for <italic>Phylogenetic Estimation of Shifts in the Tempo of Origination.</italic> The source code and documentation is available on github in the form of vignettes with example code (<ext-link ext-link-type="uri" xlink:href="https://github.com/kopperud/Pesto.jl">https://github.com/kopperud/Pesto.jl</ext-link>). To solve the differential equations numerically, we use the Runge–Kutta algorithm of <xref ref-type="bibr" rid="R59">Tsitouras (2011)</xref> implemented in <monospace>DifferentialEquations.jl</monospace> (<xref ref-type="bibr" rid="R51">Rackauckas and Nie, 2017</xref>). We implemented the simulations in a different module, <monospace>BirthDeathSimulation.jl</monospace> (<ext-link ext-link-type="uri" xlink:href="https://github.com/kopperud/BirthDeathSimulation.jl">https://github.com/kopperud/BirthDeathSimulation.jl</ext-link>), where it is possible to export the tree as an extended Newick string with metadata for each node. We plotted the figures using <monospace>ggtree</monospace> (<xref ref-type="bibr" rid="R64">Yu et al., 2017</xref>), <monospace>Makie.jl</monospace> (<xref ref-type="bibr" rid="R11">Danisch and Krumbiegel, 2021</xref>) and TikZ.</p></sec></sec><sec id="S20" sec-type="results"><title>Results</title><p id="P38">We implemented an extremely efficient method for inferring branch-specific diversification rates and diversification rate shifts under the birth-death-shift process. <monospace>Pesto</monospace> uses the same underlying model, the birth-death-shift process, as the <monospace>LSBDS</monospace> implementation in <monospace>RevBayes</monospace> (<xref ref-type="bibr" rid="R22">Höhna et al., 2016</xref>, 2019). Note that the <monospace>LSBDS</monospace> implementation of the birth-death-shift model can estimate the parameters of the base distributions (and the shift rate) jointly using hierarchical models, whereas our approach in <monospace>Pesto</monospace> can not. Therefore, the results of a <monospace>Pesto</monospace> and <monospace>LSBDS</monospace> analysis may in practice be different. If the same model is chosen, however (i.e., the prior distributions and discretization is identical) the two methods will give exactly the same estimates. We show the equivalence in <xref ref-type="supplementary-material" rid="SD1">Fig. S3</xref> and thus validated our implementation. The efficiency of our method enabled us to set up many tests for exploring various model choices and their impact on parameter estimates, which we explore in the following sections.</p><p id="P39">The primary use case of <monospace>Pesto</monospace> is to estimate branch-specific diversification rates and to infer branch-specific diversification rate shift events. As an example, we show the estimated number of accumulated diversification rate shifts and the average speciation rates —plotted with different colors and mapped on the branches of the phylogeny— for primates (<xref ref-type="bibr" rid="R61">Vos and Mooers, 2006</xref>, <xref ref-type="fig" rid="F4">Fig. 4</xref>). Based on the primates phylogeny, our posterior mean estimate for the total number of diversification shifts is <inline-formula><mml:math id="M47"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> = 4.9, summed across all diversification rate shifts and across all branches in the phylogeny. However, only one branch experienced a significant diversification rate shift event. On the branch that led to the Old World Monkeys clade (Cercopithecidae), we estimated that the number of diversification rate shifts is far higher than what is typical on other branches <italic>(N</italic> = 0.91 vs close to zero) and this branch had strong statistical support to have experienced at least one diversification rate shift event (with a Bayes factor of 173). This corresponds to the visual interpretation of one clear diversification rate shift (<xref ref-type="fig" rid="F4">Fig. 4</xref>), whereas the additional diversification rate shifts are inferred with low frequency and low magnitude distributed over the remaining branches</p><sec id="S21"><title>Evaluation and Exploration of Pesto &amp; Methods Choices</title><sec id="S22"><title>Impact of the diversification rate priors</title><p id="P40">When a rate shift occurs under the birth-death-shift process, the new diversification rates are determined based on a base distribution (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>). This base distribution could have many different shapes, for example, a log-normal distribution, a log-uniform distribution, an exponential distribution (e.g., as used in <monospace>BAMM</monospace>, <xref ref-type="bibr" rid="R48">Rabosky 2014</xref>), or a gamma distribution. So far, little is known about which base distribution is most realistic for diversification rates and what impact the choice of the base distribution has. The base distribution governs the rate heterogeneity allowed under the model. If the base distribution is too narrow or too wide, then the model may not be adequate to explain the data. Importantly, each potential base distribution has a different shape and therefore spreads the values differently.</p><p id="P41">For the primates example we see that the choice of base distribution has an impact on the estimated number of rate shifts (<xref ref-type="fig" rid="F5">Fig. 5c</xref>). The posterior mean number of rate shifts were 4.9, 6.6, 5.7 and 6.6 for the log-normal, log-uniform, exponential and gamma base distributions, respectively. The pattern of one strongly supported branch was supported for the log-normal, log-uniform and gamma distributions (<inline-formula><mml:math id="M48"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> ≈ 0.91 and Bayes factor in the range of 109–173). The exponential distribution also showed strong support for the Old World Monkeys branch (<inline-formula><mml:math id="M49"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> = 0.92 and a Bayes factor of 162), but additionally weaker support for a second branch (in the guenon clade, <italic>Cercopithecus</italic>). This second branch had a low number of estimated rate shifts (<inline-formula><mml:math id="M50"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> = 0.02) and weaker but still strong statistical support (with a Bayes factor of 11), but the overall magnitude of the rate shift was small. The pattern of many branches with few number of rate shifts (<inline-formula><mml:math id="M51"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> &lt; 0.2) was consistent across all four choices of the base distribution. The branch-specific diversification rate estimates were quantitatively different across the four base distributions (at most by 0.05 speciation rate units), but all four choices were consistent in inferring much higher rates for the Old World Monkeys clade.</p><p id="P42">In principle it could be possible to choose base distributions based on model testing (<xref ref-type="fig" rid="F5">Fig. 5b</xref>). For the remainder of this study we choose the log-normal distribution as the base distribution because it was the most supported distribution in this test case and has two main advantages. First, the standard deviation and thus the range of values can be specified independently of the mean (which is not possible for the exponential distribution). Second, the distribution is centered around an <italic>a priori</italic> specified value compared to assigning the highest density to small values, as is done for the log-uniform distribution (<xref ref-type="fig" rid="F5">Fig. 5a</xref>). Overall, we expect the log-normal and gamma prior distributions to produce similar results as both distributions can resemble one another, although the gamma distribution is usually more skewed towards smaller values (<xref ref-type="fig" rid="F5">Fig. 5a</xref>).</p></sec><sec id="S23"><title>Impact of the number of rate categories</title><p id="P43">The base distributions of the birth-death-shift process are, in theory, full continuous distributions. Therefore, the number of possible rate categories is infinite. However, the approach implemented in <monospace>Pesto</monospace> is limited to a finite number of rate categories. Ideally, we would like to pick as many rate categories as possible, as the model will potentially fit better. In practice, we want to pick as few rate categories as possible, since more categories increase the computational time. In other words, we need to establish at what point adding more rate categories does not change the number of inferred diversification rate shifts, nor the branch-specific diversification rate estimates. We tested whether the number of allowed rate categories had a systematic impact on the estimates of the number of shifts and the branch-specific diversification rates for the primates tree (<xref ref-type="fig" rid="F6">Fig. 6</xref>). When the state space is small, for example increasing the number of categories from 4 to 9, or from 9 to 16, there is some impact on the number of diversification rate shifts and the branch-specific diversification rates (<xref ref-type="fig" rid="F6">Fig. 6</xref>). However, the estimates appear to stabilize when additional categories are used (n ⩾ 6). This indicates that the number of diversification rate shifts and branch-specific diversification rates are not systematically biased by the decision to use discrete rate categories.</p></sec><sec id="S24"><title>Impact of the shift rate parameter on the number of diversification rate shifts</title><p id="P44">Estimating the number of diversification rate shift events is arguably the most exciting result of branch-specific diversification rate methods (<xref ref-type="bibr" rid="R1">Alfaro et al., 2009</xref>; <xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>). Previously, <xref ref-type="bibr" rid="R36">Moore et al. (2016)</xref> argued that estimates of the number of diversification rate shifts are not reliable and driven entirely by the choice of prior. That is, for a low rate of shifts, the methods infer few diversification rate shift events (or conversely, many events for a high shift rate). Our exploration of the impact of the shift rate parameter <italic>η</italic> on the posterior mean number of diversification rate shift events (<xref ref-type="fig" rid="F7">Fig. 7</xref>) discovered several important aspects. First, the total number of shifts is sensitive to the shift rate <italic>η</italic> (see also <xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>). Second, the posterior mean number of diversification rate shifts is almost perfectly correlated with the prior number of shifts when the shift rate <italic>η</italic> is large (<xref ref-type="fig" rid="F7">Fig. 7c</xref>). When <italic>η</italic> is small, however, the posterior number of diversification rate shifts is invariant to the rate prior (<xref ref-type="fig" rid="F7">Fig. 7c</xref>). Thus, there is some but weak information in the phylogeny to estimate the number of diversification rate shifts.</p><p id="P45">A common approach to assess the support for a hypothesis, e.g., how many diversification rate shift events occurred along the phylogeny, is to use Bayes factors (<xref ref-type="bibr" rid="R26">Jeffreys, 1961</xref>; <xref ref-type="bibr" rid="R28">Kass and Raftery, 1995</xref>). Bayes factors are defined as the ratio of marginal likelihoods of the data between two hypotheses, e.g., if there was at least one diversification rate shift on the branch vs. no diversification rate shifts. The marginal likelihood is the integral over all parameter values, e.g., the branch-specific diversification rates, weighted by the prior of the parameters. Thus, Bayes factors have the advantage that they account for the prior on the number of diversification rate shift events. Nevertheless, Bayes factors are not independent of the prior on the shift rate (<xref ref-type="fig" rid="F7">Fig. 7b</xref>). Since the marginal likelihood is often difficult to compute, as for the birth-death-shift process, one can compute instead the Bayes factor as the posterior ratio divided by the prior ratio (<xref ref-type="disp-formula" rid="FD17">Eq. 17</xref>). We implemented and explored branch-specific Bayes factors for detecting diversification rate shifts (<xref ref-type="fig" rid="F7">Fig. 7a,b</xref>). Indeed, we found that the Bayes factors are not independent of the shift rate parameter (<italic>η</italic>), which controls how many diversification rate shifts we expect <italic>a priori.</italic> Nevertheless, for the maximum likelihood estimate of the shift rate <italic>(η</italic> = 0.0032) we inferred one branchwith a strong support for a diversification rate shift (Bayes factor = 173).</p></sec><sec id="S25"><title>Run time</title><p id="P46">The run time of Pesto is the main advantage over similar methods that infer branch-specific diversification rates. We only perform two passes of the pruning algorithm to compute the likelihood function (backward pass) and find the posterior mean number of diversification rate shifts and branch-specific diversification rates (forward pass, <xref ref-type="fig" rid="F2">Fig. 2</xref>). Furthermore, our approach has the tremendous advantage that the diversification rate category probabilities are computed precisely, without the common Monte Carlo uncertainty. Thus, convergence of branch-specific diversification rate estimates is guaranteed and convergence assessment is not necessary. Every analysis will yield exactly the same results, provided the same model and phylogeny are used.</p><p id="P47">In <xref ref-type="fig" rid="F8">Fig. 8</xref> we provide an overview of how long one can expect to run the program with various number of taxa in the phylogeny. The entire analysis takes about 1 second for a phylogeny with 100 taxa, whereas it takes less than 20 minutes for a phylogeny with 20,000 taxa. The backwards pass and the forwards pass (calculating <bold>D</bold>(<italic>t</italic>) and <bold>F</bold>(<italic>t</italic>) scales approximately linearly with the number of tips, and quadratically with the number of rate categories. Computing the posterior mean number of diversification rate shifts <inline-formula><mml:math id="M52"><mml:mrow><mml:mover accent="true"><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>N</mml:mi></mml:mstyle><mml:mo stretchy="true">^</mml:mo></mml:mover></mml:mrow></mml:math></inline-formula> is considerably slower, and scales worse than linear (but better than quadratic) with the number of tips. <xref ref-type="fig" rid="F8">Fig. 8</xref> shows the run times using a single thread, however in the default settings we use multi-threading to calculate both the likelihood and <inline-formula><mml:math id="M53"><mml:mrow><mml:mover accent="true"><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>N</mml:mi></mml:mstyle><mml:mo stretchy="true">^</mml:mo></mml:mover></mml:mrow></mml:math></inline-formula> in parallel, meaning that one can expect the computation to be faster in practice. In our experience, finding the maximum-likelihood estimate for the shift rate parameter <italic>η</italic> is often the bottleneck of the inference procedure for small trees, requiring around 50-60 likelihood evaluations before a good estimate for <italic>η</italic> is found. We performed the time benchmarks using a desktop machine with an Intel Core i7-9700 CPU with a nominal clock rate of 3.0 GHz. Note that we did not want to compare the speed of <italic>Pesto</italic> to alternative implementations, e.g., <italic>LSBDS</italic>, as other implementations need to be carefully tailored to set up the length of the MCMC chain to achieve convergence. Nevertheless, <italic>Pesto</italic> runs easily 100 to 1000 times faster than <italic>LSBDS</italic>.</p></sec></sec><sec id="S26"><title>Simulation Study</title><p id="P48">In order to test the robustness of Pesto, we performed parameter estimation on phylogenies for which we knew the true model parameters, i.e., simulations. Note that we did not simulate under the exact same model as our inference settings, as we predefined different scenarios of rate variation (<xref ref-type="table" rid="T1">Table 1</xref>). Our prior settings for the inference on the rate variation is conservative, i.e., wider than realistic, which renders simulations computationally or practically infeasible. Furthermore, our simulations were not conditioned on specific outcomes, for example by conditioning on exactly one rate shift event, as has been done in some previous simulation studies (<xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>). Thus, our simulations include realizations with zero, one or many rate shifts and explore the robustness of Pesto in a more agnostic but also more challenging scenario. Finally, the insights of our simulation study should extrapolate to other methods that rely on the same or similar underlying models and theory (see also <xref ref-type="bibr" rid="R31">Martínez-Gómez et al., 2024</xref>).</p><sec id="S27"><title>Robustness in estimates of the shift rate</title><p id="P49">We estimated the shift rate both when we considered the speciation and extinction rate categories as known and unknown. First, we will discuss the known case, where we set the speciation and extinction rate categories (<bold><italic>λ</italic></bold>, <bold><italic>μ</italic></bold>) to their true values (see <xref ref-type="table" rid="T1">Table 1</xref>). The results indicate that it is almost impossible to accurately estimate the shift rate for small trees (&lt; 100 taxa). For large trees (&gt; 10, 000 taxa), the shift rate estimates converge to the true value. <xref ref-type="fig" rid="F9">Fig. 9</xref> broadly shows a bimodal distribution of estimates for the shift rate: one mode close to zero, and a second mode clearly larger than zero. Most of the trees with an estimated shift rate near zero either did not have any true shifts, or experienced shifts close to the present (e.g., on a terminal branch) during the simulation. Note that some shift rate estimates converged to our pre-defined boundary of the allowed parameter range (upper limit equal to one half times the maximum speciation rate). For these situations we noticed that the likelihood curve is flat and the hill-climbing algorithm can diverge.</p><p id="P50">Not surprising, when we consider the speciation and extinction rate categories (<bold><italic>λ</italic>, <italic>μ</italic></bold>) as unknown, it becomes more difficult to estimate the shift rate accurately (<xref ref-type="fig" rid="F9">Fig. 9b</xref>, bottom row). Overall, the estimation error in <italic>η</italic> is larger if we also want to estimate the parameters of base distributions. For large trees, the shift rate estimates converge closer to the true values. However, estimates of the shift rate are biased even for very large trees (50, 000 taxa) — with underestimates of about one order of magnitude. This is likely due to the diversification rates being estimated using the constant-rate process <inline-formula><mml:math id="M54"><mml:mrow><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo stretchy="true">^</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo stretchy="true">^</mml:mo></mml:mover></mml:mrow></mml:math></inline-formula>, which are not representative when the true tree has undergone rate shifts.</p></sec><sec id="S28"><title>Robustness of estimation in the number of diversification rate shifts</title><p id="P51">We also assessed how well <monospace>Pesto</monospace> can estimate the number of diversification rate shifts from simulated phylogenies. Altogether, 54.7% of the simulated trees experienced at least one diversification rate shift. Among these, shift histories with a single diversification rate shift were the most common (27.1%), and more numerous shifts less common. The mean number of diversification rate shifts (among the trees with at least one rate shift) was 8.3, while the median was 3. Before we discuss the quantitative results, we first present two hand-picked simulation-and-inference pairs that are useful in guiding the understanding of how the model behaves (<xref ref-type="fig" rid="F10">Fig. 10</xref>). As a brief reminder, we considered a branch to have experienced a diversification rate shift if the Bayes factor was larger than 10 and the number of diversification rate shifts (<inline-formula><mml:math id="M55"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>) was larger than 0.5.</p><p id="P52">In <xref ref-type="fig" rid="F10">Fig. 10</xref>, we show a tree simulated under a model that has tiny diversification rate variation, and a tree that has large diversification rate variation (models A and D, <xref ref-type="table" rid="T1">Table 1</xref>). These two trees are representative of the major trends across all 2,000 simulated trees. In the first tree, there were three diversification rate shifts, and <monospace>Pesto</monospace> incorrectly inferred zero shifts, i.e. no false positives and three false negative shifts. In the second tree, there were seven diversification rate shifts, and <monospace>Pesto</monospace> correctly inferred two major diversification rate shift events, i.e., no false positives and five false negative shifts. There are several reasons why <monospace>Pesto</monospace> might not be able to recover diversification rate shifts such as the ones in <xref ref-type="fig" rid="F10">Fig. 10</xref>. As a general rule, we believe that the power to detect diversificationrate shifts is high when the true diversification rate variation is large, and that the power is low when the true diversification rate variation is small. This is corroborated in <xref ref-type="fig" rid="F10">Fig. 10</xref> where we did not recover any diversification rate shifts in the tree with tiny diversification rate variation (<italic>r</italic><sub>1</sub> = 0.04 vs. <italic>r</italic><sub>3</sub> = 0.06), while we were able to detect some diversification rate shifts in the tree with large diversification rate variation (<italic>r</italic><sub>1</sub> = 0.04 vs. <italic>r</italic><sub>3</sub> = 0.12). For the diversification rate shifts that were not recovered in the second tree (despite there being a large amount of diversification rate variation), they i) occurred closer to the present, and some of the diversification rate shifts ii) led to a decrease in the net-diversification rate. Both of these scenarios make it unlikely for the descendant lineages to experience more than a few speciation events, and the resulting subclade is relatively poor in terms of the number of the species. When there are relatively few species in a particular clade, the information available for detecting a diversification rate shift is limited. In turn, this reduces the power of the method to detect diversification rate shifts.</p><p id="P53">Overall (<xref ref-type="fig" rid="F11">Fig. 11</xref>), we found that the accuracy of diversification rate shift detection was very high (mean = 99.6%), the false positive ratio was tiny (mean = 0.004%), and the false negative ratio was high (mean = 94.4%). The inference of diversification rate shift events is more robust when the tree size is larger, and when the diversification rate variation is higher. We only saw substantial false positive shifts for small trees with fewer than 250 taxa. For all larger trees, the number of false positives were negligible. This means that <monospace>Pesto</monospace> is conservative by underestimating the number of diversification rate shifts. If <monospace>Pesto</monospace> infers a diversification rate shift, then there is strong evidence that this diversification rate shift corresponds to a true diversification rate shift because of the extremely low false positive ratio.</p></sec><sec id="S29"><title>Robustness of branch-specific diversification rate estimates</title><p id="P54">Next, we assessed the robustness of the branch-specific diversification rate estimates. First, we consider again the same two example trees (<xref ref-type="fig" rid="F10">Fig. 10</xref>). For the tree simulated under tiny diversification rate variation, <monospace>Pesto</monospace> did not correctly infer the diversification rate shift, and thus the background net-diversification was overestimated, and the diversification rate was underestimated in the clades that shifted to a higher rate. For the second tree, <monospace>Pesto</monospace> recovered the two major shifts. Thus, <monospace>Pesto</monospace> correctly found a diversification rate difference in the two major clades that underwent a rate shift. However, the branch-specific diversification rates are slightly overestimated in the two high-rate clades, and slightly underestimated in the low-rate part of the tree.</p><p id="P55">To evaluate the estimation error in the full set of simulated trees, we calculated the proportional error in the branch-specific speciation rates (see <xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>, <xref ref-type="disp-formula" rid="FD15">eq. 15</xref>). For small trees (&lt; 100 taxa), the average proportional error is roughly in the range of 0.5 to 2.0, meaning that the branch-specific diversification rates were underestimated by half, or overestimated by twice the true value (<xref ref-type="fig" rid="F12">Fig. 12b</xref>, bottom row). When the true diversification rate category parameters (<bold><italic>λ, μ</italic></bold>) are used (<xref ref-type="fig" rid="F12">Fig. 12</xref>, top and middle row), the proportional error converges to one when the number of taxa increases, indicating that the branch-specific diversification rate estimates are unbiased, and the precision of the method increases with larger trees. When we also estimate the diversification rate categories via the base distribution parameters, then the proportional error still converges, however with a small bias towards overestimating branch-specific diversification rates.</p></sec></sec></sec><sec id="S30" sec-type="discussion"><title>Discussion</title><p id="P56">In this study we developed a new approach called <monospace>Pesto</monospace> for estimating branch-specific diversification rates. The key feature of our approach is the computational speed; we can estimate branch-specific diversification rates on phylogenies with thousands of taxa without algorithmic stochasticity in minutes or hours. In this discussion, we will first discuss general aspects about our ability to infer branch-specific diversification rates and the number of diversification rate shifts that are not exclusive to <monospace>Pesto</monospace>. Then, we briefly contrast <monospace>Pesto</monospace> with other existing methods and indicate the advantages and disadvantages. Finally, we provide some general recommendation about how to use <monospace>Pesto</monospace> for inferring branch-specific diversification rates.</p><sec id="S31"><title>Inferring diversification rate shifts</title><p id="P57">To explain how one can best interpret the branch-specific results obtained from <monospace>Pesto</monospace>, it can be useful to consider how <xref ref-type="bibr" rid="R21">Höhna et al. (2019)</xref> investigated the posterior distribution by simulating stochastic mappings, similar to how stochastic mappings of discrete character evolution can be simulated (<xref ref-type="bibr" rid="R25">Huelsenbeck et al., 2003</xref>). Our approach is conceptually the same. Consider a stochastic variable <italic>Z</italic> that represents the history of diversification rate shift events on the phylogeny. The posterior distribution of Z is determined by the model (i.e., the base distribution and its parameters, and the shift rate) and the observations (i.e., the reconstructed phylogeny). What we have done is to develop a fast algorithm that directly computes summaries of <italic>Z</italic>, for example the branch-specific posterior mean number of diversification rate shifts. While this approach is much faster than a stochastic mapping approach, it comes with the disadvantage that we disregard any information about the variation in <italic>Z</italic>, in other words how uncertain the branch-specific estimates are. If one wishes to know the extent of the uncertainty in the branch-specific estimates, we recommend to use stochastic mapping, for example as in <monospace>LSBDS</monospace> (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>).</p><sec id="S32"><title>Sensitivity to the shift rate</title><p id="P58"><xref ref-type="bibr" rid="R36">Moore et al. (2016)</xref> argued based on the performance of <monospace>BAMM</monospace> that the posterior distribution of the number of diversification rate shift events is strongly related to the prior expectation, which in our case is controlled by the diversification shift rate <italic>η</italic>. Overall, we agree that there is strong sensitivity to the shift rate parameter, or in other words that the diversification rate shift events are only weakly identifiable. Despite this, our exploration of the primates phylogeny revealed that the posterior mean number of diversification rate shifts is at minimum about one, even if the shift rate is assumed to be arbitrarily small. Therefore, the hypothesis of there being no diversification rate shifts can confidently be excluded, and more generally this indicates that there is some (but weak) information in a phylogeny to detect branch-specific shifts in the diversification rate (<xref ref-type="fig" rid="F7">Fig. 7c</xref>).</p></sec><sec id="S33"><title>Assessing significant diversification rate shifts events</title><p id="P59">Visually inspecting the branch-specific diversification rates can highlight the branches where a diversification rate shift event has occurred. Therefore, it might seem obvious to say how many branches experienced a diversification rate shift (<xref ref-type="fig" rid="F4">Fig. 4</xref>). However, quantitatively assessing how many rate shifts occurred (and on which branches) has remained more challenging (<xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>; <xref ref-type="bibr" rid="R57">Shi and Rabosky, 2015</xref>; <xref ref-type="bibr" rid="R32">May and Moore, 2016</xref>; <xref ref-type="bibr" rid="R35">Mitchell and Rabosky, 2017</xref>; <xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>). In principle, Bayes factors should be able to detect the branches for which the data and not only the prior increases the probability of a diversification rate shift. We note that the true prior distribution on the number of rate shifts is unknown, and we used a simplistic approximation for the prior. As with any statistical significance test, we recommend to assess both the hypothesis test (e.g., the Bayes factor) as well as the effect size (e.g., <inline-formula><mml:math id="M56"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, or the absolute change in net-diversification rate across the branch). In other words, if the statistical hypothesis test is significant, but the effect size is minimal, then we argue that the diversification rate shift is not biologically meaningful (<xref ref-type="bibr" rid="R38">Nakagawa and Cuthill, 2007</xref>). Therefore, we suggest to compute both the posterior mean number of diversification rate shifts (<inline-formula><mml:math id="M57"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>) and the Bayes factor for there being at least one or more rate shift events. If the posterior mean number of diversification rate shifts on a branch (<inline-formula><mml:math id="M58"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>) is substantially larger than 0, say 0.5, and the Bayes factor indicates strong support (say 10), then we are confident in that a diversification rate shift event actually occurred on the branch. These criteria are designed to be conservative, such that we get few false positives, and high accuracy, but not necessarily few false negatives (see also <xref ref-type="bibr" rid="R32">May and Moore, 2016</xref>).</p><p id="P60">In our simulation study, we observed that <monospace>Pesto</monospace> has high power to detect diversification rate shift events when there were sufficiently many descendant lineages (i.e., due to an increase in the net-diversification rate), and lower power in other cases (i.e., due to a decrease in net-diversification rate). Since roughly half of the branches in a phylogeny are terminal lineages with only one descendant, it is not surprising that <monospace>Pesto</monospace> and similar methods have low power to detect all diversification rate shift events. Finally, as expected, we find that larger diversification rate shifts are easier to detect.</p></sec></sec><sec id="S34"><title>Comparison with other methods</title><p id="P61">The birth-death-shift model as implemented here and in <monospace>LSBDS</monospace> (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>) is conceptually similar to other birth-death models that allow for among-lineage rate variation, including <monospace>BAMM</monospace> (<xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>), <monospace>ClaDS</monospace> (<xref ref-type="bibr" rid="R30">Maliet et al., 2019</xref>), <monospace>MTBD</monospace> (<xref ref-type="bibr" rid="R4">Barido-Sottani et al., 2020</xref>), <monospace>MiSSE</monospace> (<xref ref-type="bibr" rid="R60">Vasconcelos et al., 2022</xref>) or <monospace>RPANDA</monospace> (<xref ref-type="bibr" rid="R34">Mazet et al., 2023</xref>), and we provide a comparison in <xref ref-type="table" rid="T2">Table 2</xref>. For example, <monospace>ClaDS</monospace> models the diversification rate after a rate shift event as being correlated with the ancestral diversification rate, while we assume that the new diversification rate is drawn independently. Furthermore, <monospace>BAMM, MTBD, MiSSE</monospace> and our birth-death-shift model allow for diversification rates to shift along branches, unlike in <monospace>ClaDS</monospace> and <monospace>RPANDA</monospace>, where diversification rate shift events happen at branching events. BAMM is perhaps most similar to <monospace>Pesto</monospace> and <monospace>LSBDS</monospace>, although BAMM allows for the diversification rates to decay over time, while we assume the diversification rates to be constant within a diversification rate category. There are two main reasons for why <monospace>Pesto</monospace> is more computationally efficient than other methods. First, <monospace>Pesto</monospace> uses fixed values for the diversification rate categories (<xref ref-type="fig" rid="F1">Fig. 1</xref>). In other implementations, e.g., the <monospace>LSBDS</monospace> model in <monospace>RevBayes</monospace>, the values of the diversification rate categories can be estimated using hierarchical models. Second, unlike <monospace>LSBDS, BAMM, ClaDS</monospace> and <monospace>MTBD</monospace>, we do not make use of Monte Carlo algorithms for the inference. Instead, we use a dynamic programming algorithm to compute the marginal probabilities of the diversification rate categories across the tree, which only requires two tree traversals. This is in contrast to <monospace>MiSSE</monospace>, which uses the marginal ancestral state reconstruction algorithm of <xref ref-type="bibr" rid="R63">Yang et al. (1995)</xref> to obtain marginal probabilities at the nodes in the tree. The disadvantage of this marginal ancestral state reconstruction algorithm is that it requires a tree traversal for every node and every diversification rate category (<xref ref-type="bibr" rid="R8">Caetano et al., 2018</xref>), which is considerably more than the two in <monospace>Pesto</monospace>.</p></sec><sec id="S35"><title>Advantages and Disadvantages of <monospace>Pesto</monospace></title><p id="P62">When designing how the parameters and the branch-specific metrics were to be estimated, our overall goal was for <monospace>Pesto</monospace> to be suitable to be run on exceptionally species-rich phylogenies. The main advantages of <monospace>Pesto</monospace> include i) its fast run time, ii) it is based on a generative stochastic process (unlike e.g. <xref ref-type="bibr" rid="R9">Chan and Moore 2005</xref>; <xref ref-type="bibr" rid="R1">Alfaro et al. 2009</xref>), and iii) quantitative tests of the hypothesis of whether there was a diversification rate shift event. However, there are also some disadvantages with the estimation approaches that we used. Recall that we estimated the parameters of the base distributions (i.e., <inline-formula><mml:math id="M59"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> and <inline-formula><mml:math id="M60"><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>→</mml:mo></mml:mover></mml:math></inline-formula>) using the lineage-homogeneous, constant-rate birth-death process. While this gives a rough estimate of the overall scale of the birth and death rates, we expect that if a phylogeny has undergone diversification rate shifts, that the estimated rates obtained by fitting this simple model are biased. We suspect that the reason we see i) upward biased speciation rates and ii) downward biased shift rates, in particular for very large simulated trees, is partly due to the choice of using the lineage-homogeneous birth-death model for estimating the parameters of the base distributions. Furthermore, we investigated the posterior distribution of the rate shift histories conditionally on the parameters of the base distributions, and conditionally on the shift rate. We expect that i) joint estimation of the parameters and ii) joint inference of the parameters and the rate shift history would be more statistically robust (as in <xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>), however more research is needed for this to be computationally feasible for very large trees.</p><p id="P63">In keeping with most contemporaneous phylogenetic diversification rate studies (e.g. <xref ref-type="bibr" rid="R12">Egan et al., 2024</xref>; <xref ref-type="bibr" rid="R46">Quintero et al., 2024</xref>), we have assumed that the phylogeny is known without error. Even though <xref ref-type="bibr" rid="R3">Barido-Sottani and Morlon (2023)</xref> demonstrated that joint inference of phylogeny and a birth-death-shift model is possible, this type of joint inference is computationally challenging even for clades with few taxa, and is virtually impossible for species-rich clades. As a quicker but less robust alternative to the proper joint inference, however, one can independently apply <monospace>Pesto</monospace> to several samples from the posterior distribution of phylogenies, and interpret the variation in the results as estimation error that is due to uncertainty in the phylogeny.</p></sec><sec id="S36"><title>General Recommendations on how to use <monospace>Pesto</monospace></title><p id="P64">Both simple and more detailed instructions on how to use <monospace>Pesto</monospace> are provided at <ext-link ext-link-type="uri" xlink:href="https://kopperud.github.io/Pesto.jl/dev/">https://kopperud.github.io/Pesto.jl/dev/</ext-link>. As when fitting any probabilistic model, we recommend to inspect and consider the parameter estimates and their units. The speciation rates, extinction rates, and shift rates are in units of “number of events per lineage per time”. If the phylogenetic tree is a species tree, then the time unit is typically one million years. In our experience, the shift rate should be much smaller than the mean speciation and extinction rates, by at least one or two orders of magnitude. It is biologically plausible that there are more speciation events than diversification rate shift events (note that not all speciation events are included in a reconstructed tree but all rate shift events would have to be included). If the estimated shift rate is too large, this might indicate that there was a numerical problem. For this reason, we put limits on the maximum allowed shift rate when finding the maximum likelihood value, however this hard boundary is not guaranteed to always avoid the issue.</p><p id="P65">In general, we recommend to use the log-normal distribution for the base distribution of diversification rates. Moreover, users of <monospace>Pesto</monospace> will have to decide how many rate classes to use. In principle, more rate classes are better than fewer classes as the underlying continuous distribution is better approximated. However, additional rate classes come with computational demands. For clades that are similar to the primates in terms of time span and species heterogeneity, we recommend to use at least six or more rate classes, and to use all pairwise combinations of extinction and speciation rates (i.e., at least <italic>K</italic> = <italic>n</italic><sup>2</sup> = 36 rate categories). If a phylogeny is particularly heterogeneous, we recommend to test whether six diversification rate classes is sufficient, and to use more if necessary. This can for example be tested by fitting the model with seven or eight classes, and assessing whether the results remain similar or are substantially different.</p></sec></sec><sec id="S37" sec-type="conclusions"><title>Conclusion</title><p id="P66">We have shown that we are able to estimate posterior mean branch-specific diversification rates and number of diversification rate shift events more efficiently than before (one computation vs. thousands or millions of simulations). The birth-death-shift model can be fitted to small trees (&lt; 100 taxa) in about one second. Larger trees (&gt; 10, 000 taxa) take slightly more time, on the order of a few minutes on a standard desktop computer. Compared with the established estimation technique of using Markov-chain Monte Carlo and sampling stochastic mapping of the diversification rate shift history, which can take hours, days or even weeks for large trees, our new method and implementation is several orders of magnitude more efficient. This improvement in run time is not only more convenient, but enables empiricists to broaden their taxonomic resolution. We expect that through <monospace>Pesto</monospace>, investigations of diversification rate variation across the tree of life will become more practically feasible and accessible.</p></sec><sec id="S38"><title>Reproducibility</title><p id="P67">The analyses and figures presented here can be reproduced by running the scripts in the accompanying github repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/kopperud/pesto_ms_analyses">https://github.com/kopperud/pesto_ms_analyses</ext-link>). The simulated trees and results are not committed to the repository due to file size restrictions, however they can be downloaded from datadryad DOI: 10.5061/dryad.mgqnk995b</p></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary materials</label><media xlink:href="EMS206121-supplement-Supplementary_materials.pdf" mimetype="application" mime-subtype="pdf" id="d56aAcGbB" position="anchor"/></supplementary-material></sec></body><back><ack id="S39"><title>Acknowledgements</title><p>We thank Alessio Capobianco and John T. Clarke for discussions. This work was supported by the Deutsche Forschungsgemeinschaft (DFG) Emmy Noether-Program (Award HO 6201/1-1 to SH) and by the European Union (ERC, MacDrive, GA 101043187). Views and opinions expressed are however those of the authors only and do not necessarily reflect those of the European Union or the European Research Council Executive Agency. Neither the European Union nor the granting authority can be held responsible for them.</p></ack><ref-list><ref id="R1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Alfaro</surname><given-names>ME</given-names></name><name><surname>Santini</surname><given-names>F</given-names></name><name><surname>Brock</surname><given-names>C</given-names></name><name><surname>Alamillo</surname><given-names>H</given-names></name><name><surname>Dornburg</surname><given-names>A</given-names></name><name><surname>Rabosky</surname><given-names>DL</given-names></name><name><surname>Carnevale</surname><given-names>G</given-names></name><name><surname>Harmon</surname><given-names>LJ</given-names></name></person-group><article-title>Nine exceptional radiations plus high turnover explain species diversity in jawed vertebrates</article-title><source>Proceedings of the National Academy of Sciences</source><year>2009</year><volume>106</volume><fpage>13410</fpage><lpage>13414</lpage><pub-id pub-id-type="pmcid">PMC2715324</pub-id><pub-id pub-id-type="pmid">19633192</pub-id><pub-id pub-id-type="doi">10.1073/pnas.0811087106</pub-id></element-citation></ref><ref id="R2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Allen</surname><given-names>AP</given-names></name><name><surname>Gillooly</surname><given-names>JF</given-names></name></person-group><article-title>Assessing latitudinal gradients in speciation rates and biodiversity at the global scale</article-title><source>Ecology letters</source><year>2006</year><volume>9</volume><fpage>947</fpage><lpage>954</lpage><pub-id pub-id-type="pmid">16913938</pub-id></element-citation></ref><ref id="R3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Barido-Sottani</surname><given-names>J</given-names></name><name><surname>Morlon</surname><given-names>H</given-names></name></person-group><article-title>The clads rate-heterogeneous birth–death prior for full phylogenetic inference in beast2</article-title><source>Systematic Biology</source><year>2023</year><volume>72</volume><fpage>1180</fpage><lpage>1187</lpage><pub-id pub-id-type="pmcid">PMC10627560</pub-id><pub-id pub-id-type="pmid">37161619</pub-id><pub-id pub-id-type="doi">10.1093/sysbio/syad027</pub-id></element-citation></ref><ref id="R4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Barido-Sottani</surname><given-names>J</given-names></name><name><surname>Vaughan</surname><given-names>TG</given-names></name><name><surname>Stadler</surname><given-names>T</given-names></name></person-group><article-title>A Multitype Birth–Death Model for Bayesian Inference of Lineage-Specific Birth and Death Rates</article-title><source>Systematic Biology</source><year>2020</year><volume>69</volume><fpage>973</fpage><lpage>986</lpage><pub-id pub-id-type="pmcid">PMC7440751</pub-id><pub-id pub-id-type="pmid">32105322</pub-id><pub-id pub-id-type="doi">10.1093/sysbio/syaa016</pub-id></element-citation></ref><ref id="R5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Beaulieu</surname><given-names>JM</given-names></name><name><surname>O’Meara</surname><given-names>BC</given-names></name></person-group><article-title>Detecting hidden diversification shifts in models of trait-dependent speciation and extinction</article-title><source>Systematic Biology</source><year>2016</year><volume>65</volume><fpage>583</fpage><lpage>601</lpage><pub-id pub-id-type="pmid">27016728</pub-id></element-citation></ref><ref id="R6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bezanson</surname><given-names>J</given-names></name><name><surname>Edelman</surname><given-names>A</given-names></name><name><surname>Karpinski</surname><given-names>S</given-names></name><name><surname>Shah</surname><given-names>VB</given-names></name></person-group><article-title>Julia: A fresh approach to numerical computing</article-title><source>SIAM Review</source><year>2017</year><volume>59</volume><fpage>65</fpage><lpage>98</lpage></element-citation></ref><ref id="R7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Budd</surname><given-names>GE</given-names></name><name><surname>Mann</surname><given-names>RP</given-names></name></person-group><article-title>A covariant model of molecular and diversification patterns through time and the history of large clades</article-title><source>bioRxiv</source><year>2024</year><fpage>2024</fpage><lpage>02</lpage></element-citation></ref><ref id="R8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Caetano</surname><given-names>DS</given-names></name><name><surname>O’Meara</surname><given-names>BC</given-names></name><name><surname>Beaulieu</surname><given-names>JM</given-names></name></person-group><article-title>Hidden state models improve state-dependent diversification approaches, including biogeographical models</article-title><source>Evolution</source><year>2018</year><volume>72</volume><fpage>2308</fpage><lpage>2324</lpage><pub-id pub-id-type="pmid">30226270</pub-id></element-citation></ref><ref id="R9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chan</surname><given-names>KMA</given-names></name><name><surname>Moore</surname><given-names>BR</given-names></name></person-group><article-title>SYMMETREE: whole-tree analysis of differential diversification rates</article-title><source>Bioinformatics</source><year>2005</year><volume>21</volume><fpage>1709</fpage><lpage>1710</lpage><pub-id pub-id-type="pmid">15572466</pub-id></element-citation></ref><ref id="R10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Condamine</surname><given-names>FL</given-names></name><name><surname>Rolland</surname><given-names>J</given-names></name><name><surname>Höhna</surname><given-names>S</given-names></name><name><surname>Sperling</surname><given-names>FAH</given-names></name><name><surname>Sanmartín</surname><given-names>I</given-names></name></person-group><article-title>Testing the role of the Red Queen and Court Jester as drivers of the macroevolution of Apollo butterflies</article-title><source>Systematic Biology</source><year>2018</year><volume>67</volume><fpage>940</fpage><lpage>964</lpage><pub-id pub-id-type="pmid">29438538</pub-id></element-citation></ref><ref id="R11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Danisch</surname><given-names>S</given-names></name><name><surname>Krumbiegel</surname><given-names>J</given-names></name></person-group><article-title>Makie.jl: Flexible high-performance data visualization for Julia</article-title><source>Journal of Open Source Software</source><year>2021</year><volume>6</volume><elocation-id>3349</elocation-id></element-citation></ref><ref id="R12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Egan</surname><given-names>JP</given-names></name><name><surname>Simons</surname><given-names>AM</given-names></name><name><surname>Alavi-Yeganeh</surname><given-names>MS</given-names></name><name><surname>Hammer</surname><given-names>MP</given-names></name><name><surname>Tongnunui</surname><given-names>P</given-names></name><name><surname>Arcila</surname><given-names>D</given-names></name><name><surname>Betancur-R</surname><given-names>R</given-names></name><name><surname>Bloom</surname><given-names>DD</given-names></name></person-group><article-title>Phylogenomics, lineage diversification rates, and the evolution of diadromy in clupeiformes (anchovies, herrings, sardines, and relatives)</article-title><source>Systematic Biology</source><year>2024</year><volume>73</volume><fpage>683</fpage><lpage>703</lpage><pub-id pub-id-type="pmid">38756097</pub-id></element-citation></ref><ref id="R13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>FitzJohn</surname><given-names>RG</given-names></name></person-group><article-title>Quantitative traits and diversification</article-title><source>Systematic Biology</source><year>2010</year><volume>59</volume><fpage>619</fpage><lpage>633</lpage><pub-id pub-id-type="pmid">20884813</pub-id></element-citation></ref><ref id="R14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>FitzJohn</surname><given-names>RG</given-names></name></person-group><article-title>Diversitree: comparative phylogenetic nalyses of diversification in R</article-title><source>Methods in Ecology and Evolution</source><year>2012</year><volume>3</volume><fpage>1084</fpage><lpage>1092</lpage></element-citation></ref><ref id="R15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>FitzJohn</surname><given-names>RG</given-names></name><name><surname>Maddison</surname><given-names>WP</given-names></name><name><surname>Otto</surname><given-names>SP</given-names></name></person-group><article-title>Estimating trait-dependent speciation and extinction rates from incompletely resolved phylogenies</article-title><source>Systematic Biology</source><year>2009</year><volume>58</volume><fpage>595</fpage><lpage>611</lpage><pub-id pub-id-type="pmid">20525612</pub-id></element-citation></ref><ref id="R16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Freyman</surname><given-names>WA</given-names></name><name><surname>Höhna</surname><given-names>S</given-names></name></person-group><article-title>Cladogenetic and anagenetic models of chromosome number evolution: a Bayesian model averaging approach</article-title><source>Systematic Biology</source><year>2018</year><volume>67</volume><fpage>1995</fpage><lpage>215</lpage><pub-id pub-id-type="pmid">28945917</pub-id></element-citation></ref><ref id="R17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Freyman</surname><given-names>WA</given-names></name><name><surname>Höhna</surname><given-names>S</given-names></name></person-group><article-title>Stochastic character mapping of state-dependent diversification reveals the tempo of evolutionary decline in self-compatible Onagraceae lineages</article-title><source>Systematic Biology</source><year>2019</year><volume>68</volume><fpage>505</fpage><lpage>519</lpage><pub-id pub-id-type="pmid">30476308</pub-id></element-citation></ref><ref id="R18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Goldberg</surname><given-names>EE</given-names></name><name><surname>Igić</surname><given-names>B</given-names></name></person-group><article-title>On phylogenetic tests of irreversible evolution</article-title><source>Evolution</source><year>2008</year><volume>62</volume><fpage>2727</fpage><lpage>2741</lpage><pub-id pub-id-type="pmid">18764918</pub-id></element-citation></ref><ref id="R19"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Groves</surname><given-names>CP</given-names></name></person-group><chapter-title>Order Primates</chapter-title><person-group person-group-type="editor"><name><surname>Wilson</surname><given-names>D</given-names></name><name><surname>Reeder</surname><given-names>D</given-names></name></person-group><source>Mammal species of the world: a taxonomic and geographic reference</source><edition>3rd ed</edition><year>2005</year><publisher-name>Johns Hopkins University Press</publisher-name></element-citation></ref><ref id="R20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hodges</surname><given-names>SA</given-names></name><name><surname>Arnold</surname><given-names>ML</given-names></name></person-group><article-title>Spurring plant diversification: are floral nectar spurs a key innovation?</article-title><source>Proceedings of the Royal Society of London Series B: Biological Sciences</source><year>1995</year><volume>262</volume><fpage>343</fpage><lpage>348</lpage></element-citation></ref><ref id="R21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Höhna</surname><given-names>S</given-names></name><name><surname>Freyman</surname><given-names>WA</given-names></name><name><surname>Nolen</surname><given-names>Z</given-names></name><name><surname>Huelsenbeck</surname><given-names>JP</given-names></name><name><surname>May</surname><given-names>MR</given-names></name><name><surname>Moore</surname><given-names>BR</given-names></name></person-group><article-title>A Bayesian Approach for Estimating Branch-Specific Speciation and Extinction Rates</article-title><source>bioRxiv</source><year>2019</year></element-citation></ref><ref id="R22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Höhna</surname><given-names>S</given-names></name><name><surname>Landis</surname><given-names>MJ</given-names></name><name><surname>Heath</surname><given-names>TA</given-names></name><name><surname>Boussau</surname><given-names>B</given-names></name><name><surname>Lartillot</surname><given-names>N</given-names></name><name><surname>Moore</surname><given-names>BR</given-names></name><name><surname>Huelsenbeck</surname><given-names>JP</given-names></name><name><surname>Ronquist</surname><given-names>F</given-names></name></person-group><article-title>RevBayes: Bayesian Phylogenetic Inference Using Graphical Models and an Interactive Model-Specification Language</article-title><source>Systematic Biology</source><year>2016</year><volume>65</volume><fpage>726</fpage><lpage>736</lpage><pub-id pub-id-type="pmcid">PMC4911942</pub-id><pub-id pub-id-type="pmid">27235697</pub-id><pub-id pub-id-type="doi">10.1093/sysbio/syw021</pub-id></element-citation></ref><ref id="R23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Höhna</surname><given-names>S</given-names></name><name><surname>Stadler</surname><given-names>T</given-names></name><name><surname>Ronquist</surname><given-names>F</given-names></name><name><surname>Britton</surname><given-names>T</given-names></name></person-group><article-title>Inferring speciation and extinction rates under different species sampling schemes</article-title><source>Molecular Biology and Evolution</source><year>2011</year><volume>28</volume><fpage>2577</fpage><lpage>2589</lpage><pub-id pub-id-type="pmid">21482666</pub-id></element-citation></ref><ref id="R24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hua</surname><given-names>X</given-names></name><name><surname>Wiens</surname><given-names>JJ</given-names></name></person-group><article-title>How does climate influence speciation?</article-title><source>The American Naturalist</source><year>2013</year><volume>182</volume><fpage>1</fpage><lpage>12</lpage><pub-id pub-id-type="pmid">23778222</pub-id></element-citation></ref><ref id="R25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Huelsenbeck</surname><given-names>JP</given-names></name><name><surname>Nielsen</surname><given-names>R</given-names></name><name><surname>Rollback</surname><given-names>JP</given-names></name></person-group><article-title>Stochastic mapping of morphological characters</article-title><source>Systematic biology</source><year>2003</year><volume>52</volume><fpage>131</fpage><lpage>158</lpage><pub-id pub-id-type="pmid">12746144</pub-id></element-citation></ref><ref id="R26"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Jeffreys</surname><given-names>H</given-names></name></person-group><source>Theory of Probability</source><edition>3rd ed</edition><year>1961</year><publisher-name>Oxford University Press</publisher-name></element-citation></ref><ref id="R27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jetz</surname><given-names>W</given-names></name><name><surname>Thomas</surname><given-names>GH</given-names></name><name><surname>Joy</surname><given-names>JB</given-names></name><name><surname>Hartmann</surname><given-names>K</given-names></name><name><surname>Mooers</surname><given-names>AØ</given-names></name></person-group><article-title>The global diversity of birds in space and time</article-title><source>Nature</source><year>2012</year><volume>491</volume><fpage>444</fpage><lpage>448</lpage><pub-id pub-id-type="pmid">23123857</pub-id></element-citation></ref><ref id="R28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kass</surname><given-names>RE</given-names></name><name><surname>Raftery</surname><given-names>AE</given-names></name></person-group><article-title>Bayes factors</article-title><source>Journal of the american statistical association</source><year>1995</year><volume>90</volume><fpage>773</fpage><lpage>795</lpage></element-citation></ref><ref id="R29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Maddison</surname><given-names>WP</given-names></name><name><surname>Midford</surname><given-names>PE</given-names></name><name><surname>Otto</surname><given-names>SP</given-names></name></person-group><article-title>Estimating a binary character’s effect on speciation and extinction</article-title><source>Systematic Biology</source><year>2007</year><volume>56</volume><fpage>701</fpage><pub-id pub-id-type="pmid">17849325</pub-id></element-citation></ref><ref id="R30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Maliet</surname><given-names>O</given-names></name><name><surname>Hartig</surname><given-names>F</given-names></name><name><surname>Morlon</surname><given-names>H</given-names></name></person-group><article-title>A model with many small shifts for estimating species-specific diversification rates</article-title><source>Nature Ecology &amp; Evolution</source><year>2019</year><volume>3</volume><fpage>1086</fpage><lpage>1092</lpage><pub-id pub-id-type="pmid">31160736</pub-id></element-citation></ref><ref id="R31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Martínez-Gómez</surname><given-names>J</given-names></name><name><surname>Song</surname><given-names>MJ</given-names></name><name><surname>Tribble</surname><given-names>CM</given-names></name><name><surname>Kopperud</surname><given-names>BT</given-names></name><name><surname>Freyman</surname><given-names>WA</given-names></name><name><surname>Höhna</surname><given-names>S</given-names></name><name><surname>Specht</surname><given-names>CD</given-names></name><name><surname>Rothfels</surname><given-names>CJ</given-names></name></person-group><article-title>Commonly used bayesian diversification methods lead to biologically meaningful differences in branch-specific rates on empirical phylogenies</article-title><source>Evolution Letters</source><year>2024</year><volume>8</volume><fpage>189</fpage><lpage>199</lpage><pub-id pub-id-type="pmcid">PMC11275465</pub-id><pub-id pub-id-type="pmid">39070288</pub-id><pub-id pub-id-type="doi">10.1093/evlett/qrad044</pub-id></element-citation></ref><ref id="R32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>May</surname><given-names>MR</given-names></name><name><surname>Moore</surname><given-names>BR</given-names></name></person-group><article-title>How Well Can We Detect Lineage-Specific Diversification-Rate Shifts? A Simulation Study of Sequential AIC Methods</article-title><source>Systematic Biology</source><year>2016</year><volume>65</volume><fpage>1076</fpage><lpage>1084</lpage><pub-id pub-id-type="pmcid">PMC5066061</pub-id><pub-id pub-id-type="pmid">27037081</pub-id><pub-id pub-id-type="doi">10.1093/sysbio/syw026</pub-id></element-citation></ref><ref id="R33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>May</surname><given-names>MR</given-names></name><name><surname>Rothfels</surname><given-names>CJ</given-names></name></person-group><article-title>Diversification models conflate likelihood and prior, and cannot be compared using conventional model-comparison tools</article-title><source>Systematic Biology</source><year>2023</year><volume>72</volume><fpage>713</fpage><lpage>722</lpage><pub-id pub-id-type="pmid">36897743</pub-id></element-citation></ref><ref id="R34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mazet</surname><given-names>N</given-names></name><name><surname>Morlon</surname><given-names>H</given-names></name><name><surname>Fabre</surname><given-names>P-h</given-names></name><name><surname>Condamine</surname><given-names>FL</given-names></name></person-group><article-title>Estimating clade-specific diversification rates and palaeodiversity dynamics from reconstructed phylogenies</article-title><source>Methods in Ecology and Evolution</source><year>2023</year><volume>14</volume><fpage>2575</fpage><lpage>2591</lpage></element-citation></ref><ref id="R35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mitchell</surname><given-names>JS</given-names></name><name><surname>Rabosky</surname><given-names>DL</given-names></name></person-group><article-title>Bayesian model selection with BAMM: effects of the model prior on the inferred number of diversification shifts</article-title><source>Methods in Ecology and Evolution</source><year>2017</year><volume>8</volume><fpage>37</fpage><lpage>46</lpage></element-citation></ref><ref id="R36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Moore</surname><given-names>BR</given-names></name><name><surname>Höhna</surname><given-names>S</given-names></name><name><surname>May</surname><given-names>MR</given-names></name><name><surname>Rannala</surname><given-names>B</given-names></name><name><surname>Huelsenbeck</surname><given-names>JP</given-names></name></person-group><article-title>Critically evaluating the theory and performance of Bayesian analysis of macroevolutionary mixtures</article-title><source>Proceedings of the National Academy of Sciences</source><year>2016</year><volume>113</volume><fpage>9569</fpage><lpage>9574</lpage><pub-id pub-id-type="pmcid">PMC5003228</pub-id><pub-id pub-id-type="pmid">27512038</pub-id><pub-id pub-id-type="doi">10.1073/pnas.1518659113</pub-id></element-citation></ref><ref id="R37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Morlon</surname><given-names>H</given-names></name></person-group><article-title>Phylogenetic approaches for studying diversification</article-title><source>Ecology letters</source><year>2014</year><volume>17</volume><fpage>508</fpage><lpage>525</lpage><pub-id pub-id-type="pmid">24533923</pub-id></element-citation></ref><ref id="R38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nakagawa</surname><given-names>S</given-names></name><name><surname>Cuthill</surname><given-names>IC</given-names></name></person-group><article-title>Effect size, confidence interval and statistical significance: a practical guide for biologists</article-title><source>Biological reviews</source><year>2007</year><volume>82</volume><fpage>591</fpage><lpage>605</lpage><pub-id pub-id-type="pmid">17944619</pub-id></element-citation></ref><ref id="R39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nielsen</surname><given-names>R</given-names></name></person-group><article-title>Mapping mutations on phylogenies</article-title><source>Systematic biology</source><year>2002</year><volume>51</volume><fpage>729</fpage><lpage>739</lpage><pub-id pub-id-type="pmid">12396587</pub-id></element-citation></ref><ref id="R40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pagel</surname><given-names>M</given-names></name></person-group><article-title>Detecting correlated evolution on phylogenies: a general method for the comparative analysis of discrete characters</article-title><source>Proceedings of the Royal Society of London. Series B: Biological Sciences</source><year>1994</year><volume>255</volume><fpage>37</fpage><lpage>45</lpage></element-citation></ref><ref id="R41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Palazzesi</surname><given-names>L</given-names></name><name><surname>Hidalgo</surname><given-names>O</given-names></name><name><surname>Barreda</surname><given-names>VD</given-names></name><name><surname>Forest</surname><given-names>F</given-names></name><name><surname>Höhna</surname><given-names>S</given-names></name></person-group><article-title>The rise of grasslands is linked to atmospheric CO<sub>2</sub> decline in the late Paleogene</article-title><source>Nature Communications</source><year>2022</year><volume>13</volume><fpage>293</fpage><pub-id pub-id-type="pmcid">PMC8755714</pub-id><pub-id pub-id-type="pmid">35022396</pub-id><pub-id pub-id-type="doi">10.1038/s41467-021-27897-y</pub-id></element-citation></ref><ref id="R42"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Pawitan</surname><given-names>Y</given-names></name></person-group><source>In all likelihood: statistical modelling and inference using likelihood</source><year>2001</year><publisher-name>Oxford University Press</publisher-name></element-citation></ref><ref id="R43"><element-citation publication-type="confproc"><person-group person-group-type="author"><name><surname>Pearl</surname><given-names>J</given-names></name></person-group><source>Reverend Bayes on Inference Engines: A Distributed Hierarchical Approach</source><conf-name>Proceedings of the National Conference on Artificial Intelligence</conf-name><year>1982</year><fpage>133</fpage><lpage>136</lpage><conf-sponsor>AAAI</conf-sponsor><conf-loc>Pittsburgh, PA</conf-loc></element-citation></ref><ref id="R44"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Pearl</surname><given-names>J</given-names></name></person-group><source>Probabilistic Reasoning in Intelligent Systems: Networks of Plausible Inference</source><edition>1st ed</edition><year>1988</year><publisher-name>Morgan Kaufmann Publishers</publisher-name><publisher-loc>San Francisco, CA</publisher-loc></element-citation></ref><ref id="R45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Powers</surname><given-names>DM</given-names></name></person-group><article-title>Evaluation: From precision, recall and f-measure to roc, informedness, markedness and correlation</article-title><source>International Journal of Machine Learning Technology</source><year>2011</year><volume>2</volume><fpage>37</fpage><lpage>63</lpage></element-citation></ref><ref id="R46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Quintero</surname><given-names>I</given-names></name><name><surname>Lartillot</surname><given-names>N</given-names></name><name><surname>Morlon</surname><given-names>H</given-names></name></person-group><article-title>Imbalanced speciation pulses sustain the radiation of mammals</article-title><source>Science</source><year>2024</year><volume>384</volume><fpage>1007</fpage><lpage>1012</lpage><pub-id pub-id-type="pmid">38815022</pub-id></element-citation></ref><ref id="R47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rabiner</surname><given-names>LR</given-names></name></person-group><article-title>A tutorial on hidden markov models and selected applications in speech recognition</article-title><source>Proceedings of the IEEE</source><year>1989</year><volume>77</volume><fpage>257</fpage><lpage>286</lpage></element-citation></ref><ref id="R48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rabosky</surname><given-names>DL</given-names></name></person-group><article-title>Automatic detection of key innovations, rate shifts, and diversity-dependence on phylogenetic trees</article-title><source>PLoS One</source><year>2014</year><volume>9</volume><elocation-id>e89543</elocation-id><pub-id pub-id-type="pmcid">PMC3935878</pub-id><pub-id pub-id-type="pmid">24586858</pub-id><pub-id pub-id-type="doi">10.1371/journal.pone.0089543</pub-id></element-citation></ref><ref id="R49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rabosky</surname><given-names>DL</given-names></name><name><surname>Chang</surname><given-names>J</given-names></name><name><surname>Cowman</surname><given-names>PF</given-names></name><name><surname>Sallan</surname><given-names>L</given-names></name><name><surname>Friedman</surname><given-names>M</given-names></name><name><surname>Kaschner</surname><given-names>K</given-names></name><name><surname>Garilao</surname><given-names>C</given-names></name><name><surname>Near</surname><given-names>TJ</given-names></name><name><surname>Coll</surname><given-names>M</given-names></name><name><surname>Alfaro</surname><given-names>ME</given-names></name><etal/></person-group><article-title>An inverse latitudinal gradient in speciation rate for marine fishes</article-title><source>Nature</source><year>2018</year><volume>559</volume><fpage>392</fpage><lpage>395</lpage><pub-id pub-id-type="pmid">29973726</pub-id></element-citation></ref><ref id="R50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rabosky</surname><given-names>DL</given-names></name><name><surname>Grundler</surname><given-names>M</given-names></name><name><surname>Anderson</surname><given-names>C</given-names></name><name><surname>Title</surname><given-names>P</given-names></name><name><surname>Shi</surname><given-names>JJ</given-names></name><name><surname>Brown</surname><given-names>JW</given-names></name><name><surname>Huang</surname><given-names>H</given-names></name><name><surname>Larson</surname><given-names>JG</given-names></name></person-group><article-title>BAMM tools: an R package for the analysis of evolutionary dynamics on phylogenetic trees</article-title><source>Methods in Ecology and Evolution</source><year>2014</year><volume>5</volume><fpage>701</fpage><lpage>707</lpage></element-citation></ref><ref id="R51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rackauckas</surname><given-names>C</given-names></name><name><surname>Nie</surname><given-names>Q</given-names></name></person-group><article-title>DifferentialEquations.jl – a performant and feature-rich ecosystem for solving differential equations in Julia</article-title><source>Journal of open research software</source><year>2017</year><volume>5</volume></element-citation></ref><ref id="R52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Raup</surname><given-names>DM</given-names></name><name><surname>Sepkoski</surname><given-names>JJ</given-names></name></person-group><article-title>Mass extinctions in the marine fossil record</article-title><source>Science</source><year>1982</year><volume>215</volume><fpage>1501</fpage><lpage>1503</lpage><pub-id pub-id-type="pmid">17788674</pub-id></element-citation></ref><ref id="R53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ricklefs</surname><given-names>RE</given-names></name></person-group><article-title>Estimating diversification rates from phylogenetic information</article-title><source>Trends in ecology &amp; evolution</source><year>2007</year><volume>22</volume><fpage>601</fpage><lpage>610</lpage><pub-id pub-id-type="pmid">17963995</pub-id></element-citation></ref><ref id="R54"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sanderson</surname><given-names>MJ</given-names></name><name><surname>Donoghue</surname><given-names>MJ</given-names></name></person-group><article-title>Shifts in Diversification Rate with the Origin of Angiosperms</article-title><source>Science</source><year>1994</year><volume>264</volume><fpage>1590</fpage><lpage>1593</lpage><pub-id pub-id-type="pmid">17769604</pub-id></element-citation></ref><ref id="R55"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sanderson</surname><given-names>MJ</given-names></name><name><surname>Donoghue</surname><given-names>MJ</given-names></name></person-group><article-title>Reconstructing shifts in diversification rates on phylogenetic trees</article-title><source>Trends in Ecology &amp; Evolution</source><year>1996</year><volume>11</volume><fpage>15</fpage><lpage>20</lpage><pub-id pub-id-type="pmid">21237745</pub-id></element-citation></ref><ref id="R56"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sepkoski</surname><given-names>JJ</given-names></name></person-group><article-title>Rates of speciation in the fossil record</article-title><source>Philosophical Transactions of the Royal Society of London. Series B: Biological Sciences</source><year>1998</year><volume>353</volume><fpage>315</fpage><lpage>326</lpage><pub-id pub-id-type="pmcid">PMC1692211</pub-id><pub-id pub-id-type="pmid">11541734</pub-id><pub-id pub-id-type="doi">10.1098/rstb.1998.0212</pub-id></element-citation></ref><ref id="R57"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shi</surname><given-names>JJ</given-names></name><name><surname>Rabosky</surname><given-names>DL</given-names></name></person-group><article-title>Speciation dynamics during the global radiation of extant bats</article-title><source>Evolution</source><year>2015</year><volume>69</volume><fpage>1528</fpage><lpage>1545</lpage><pub-id pub-id-type="pmid">25958922</pub-id></element-citation></ref><ref id="R58"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Silvestro</surname><given-names>D</given-names></name><name><surname>Zizka</surname><given-names>G</given-names></name><name><surname>Schulte</surname><given-names>K</given-names></name></person-group><article-title>Disentangling the effects of key innovations on the diversification of Bromelioideae (Bromeliaceae)</article-title><source>Evolution</source><year>2014</year><volume>68</volume><fpage>163</fpage><lpage>175</lpage><pub-id pub-id-type="pmid">24372602</pub-id></element-citation></ref><ref id="R59"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tsitouras</surname><given-names>C</given-names></name></person-group><article-title>Runge–Kutta pairs of order 5(4) satisfying only the first column simplifying assumption</article-title><source>Computers &amp; Mathematics with Applications</source><year>2011</year><volume>62</volume><fpage>770</fpage><lpage>775</lpage></element-citation></ref><ref id="R60"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Vasconcelos</surname><given-names>T</given-names></name><name><surname>O’Meara</surname><given-names>BC</given-names></name><name><surname>Beaulieu</surname><given-names>JM</given-names></name></person-group><article-title>A flexible method for estimating tip diversification rates across a range of speciation and extinction scenarios</article-title><source>Evolution</source><year>2022</year><volume>76</volume><fpage>1420</fpage><lpage>1433</lpage><pub-id pub-id-type="pmid">35661352</pub-id></element-citation></ref><ref id="R61"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Vos</surname><given-names>R</given-names></name><name><surname>Mooers</surname><given-names>A</given-names></name></person-group><chapter-title>A new dated supertree of the primates</chapter-title><person-group person-group-type="editor"><name><surname>Vos</surname><given-names>R</given-names></name></person-group><source>Inferring large phylogenies: the big tree problem</source><year>2006</year><publisher-name>(Phd thesis) Simon Fraser University</publisher-name><publisher-loc>Burnaby, British Columbia</publisher-loc></element-citation></ref><ref id="R62"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Weir</surname><given-names>JT</given-names></name><name><surname>Schluter</surname><given-names>D</given-names></name></person-group><article-title>The latitudinal gradient in recent speciation and extinction rates of birds and mammals</article-title><source>Science</source><year>2007</year><volume>315</volume><fpage>1574</fpage><lpage>1576</lpage><pub-id pub-id-type="pmid">17363673</pub-id></element-citation></ref><ref id="R63"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yang</surname><given-names>Z</given-names></name><name><surname>Kumar</surname><given-names>S</given-names></name><name><surname>Nei</surname><given-names>M</given-names></name></person-group><article-title>A new method of inference of ancestral nucleotide and amino acid sequences</article-title><source>Genetics</source><year>1995</year><volume>141</volume><fpage>1641</fpage><lpage>1650</lpage><pub-id pub-id-type="pmcid">PMC1206894</pub-id><pub-id pub-id-type="pmid">8601501</pub-id><pub-id pub-id-type="doi">10.1093/genetics/141.4.1641</pub-id></element-citation></ref><ref id="R64"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yu</surname><given-names>G</given-names></name><name><surname>Smith</surname><given-names>DK</given-names></name><name><surname>Zhu</surname><given-names>H</given-names></name><name><surname>Guan</surname><given-names>Y</given-names></name><name><surname>Lam</surname><given-names>TT-Y</given-names></name></person-group><article-title>ggtree: an R package for visualization and annotation of phylogenetic trees with their covariates and other associated data</article-title><source>Methods in Ecology and Evolution</source><year>2017</year><volume>8</volume><fpage>28</fpage><lpage>36</lpage></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Fig. 1</label><caption><p>Schematic of diversification rate categories. First, Pesto estimates the speciation rate (<inline-formula><mml:math id="M61"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> ≈ 0.30) and the extinction rate (<inline-formula><mml:math id="M62"><mml:mover accent="true"><mml:mtext>μ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> ≈ 0.22) under the constant-rate birth-death process (gray dot). These constant-rate estimates are used as the mean of base distributions. Second, we select the number of quantiles <italic>(n</italic> = 6) and the standard deviation <italic>H</italic> = 0.587 chosen such that the 2.5%–97.5% quantile interval spans one order of magnitude. Third, we consider all pairwise combinations of the quantiles (black dots, <italic>K</italic> = <italic>n</italic><sup>2</sup> = 36). The log-normal distribution with <italic>n</italic> = 6 quantiles and a variance of H is the default option, however other distributions and other number of quantiles and variances can be specified. The rate category values can also be specified manually. Each black dot is a rate category in the birth-death-shift model, and together they represent the range of rate heterogeneity allowed under the model. Along each branch and across time, we calculate the probability that the process was in each rate category using <xref ref-type="disp-formula" rid="FD7">Eq. 7</xref>.</p></caption><graphic xlink:href="EMS206121-f001"/></fig><fig id="F2" position="float"><label>Fig. 2</label><caption><p>The algorithm for the two tree traversals on a miniature tree. The postorder pass <bold>(a–c)</bold> computes the probabilities given the descendants (<bold>D</bold>(<italic>t</italic>), written above the branches). The preorder pass <bold>(d–f)</bold> computes the probabilities given the tree up to but not including the descendants (<bold>F</bold>(<italic>t</italic>), written below the branches). The white boxes on the trees correspond to the white boxes in the caption. We set <bold>D</bold>(<italic>t<sub>1</sub></italic>) = [1.0, 1.0] at the tips, and <bold>F</bold><sub><italic>R</italic></sub>(<italic>t</italic><sub>3</sub>) = [0.5, 0.5] at the root. The densities <bold>D</bold>(<italic>t</italic>) and <bold>F</bold>(<italic>t</italic>) are used to calculate the probability that the process was in a particular rate category at a particular time, see <xref ref-type="disp-formula" rid="FD7">Eq. 7</xref>. In this example, we used divergence times <italic>t</italic><sub>1</sub> = 0, <italic>t</italic><sub>2</sub> = 0.1, <italic>t</italic><sub>3</sub> = 0.2, speciation rates <bold>λ</bold> = [1.2, 0.5], extinction rates <italic>μ</italic> = [1.0,0.3], shift rate <italic>η</italic> = 0.01, extant sampling fraction <italic>ρ</italic> = 1, we did not condition on survival, and we did not re-scale the initial values.</p></caption><graphic xlink:href="EMS206121-f002"/></fig><fig id="F3" position="float"><label>Fig. 3</label><caption><p>A simplified schematic of the backward-forward algorithm along a branch. First, we find the solution for <bold>D</bold>(<italic>t</italic>), by starting from <italic>t</italic><sub>young</sub> and going towards the past. Second, we find the solution for <bold>F</bold>(<italic>t</italic>), by starting from <italic>t</italic><sub>old</sub> and going towards the present. Third, we calculate the ancestral rate category probabilities <bold>S</bold>(<italic>t</italic>), which is <bold>F</bold>(<italic>t</italic>) element-wise times <bold>D</bold>(<italic>t</italic>), normalized by <italic>α</italic> such that <bold>S</bold>(<italic>t</italic>) sums to one for any particular time <italic>t</italic>. Fourth, we compute the posterior mean speciation rate, averaged across the time interval of the branch (<inline-formula><mml:math id="M63"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>¯</mml:mo></mml:mover></mml:math></inline-formula>). Note that the fixed time intervals Δ<italic>t</italic> are plotted for illustrative purposes. In the actual implementation, the number of time intervals, and the size of the time intervals can vary.</p></caption><graphic xlink:href="EMS206121-f003"/></fig><fig id="F4" position="float"><label>Fig. 4</label><caption><p>Posterior mean number of diversification rate shifts (a) and posterior mean branch-specific speciation rates (b) on the primate phylogeny (<xref ref-type="bibr" rid="R61">Vos and Mooers, 2006</xref>). We estimated the highest number of diversification rate shifts on the branch that led to the Old World Monkeys clade (Cercopithecidae). There are many branches with a low (but non-zero) posterior mean number of diversification rate shifts, which are not discernible using a simple color gradient. The estimate for the shift rate is <italic>η</italic> = 0.0032 number of diversification rate shift events per time per lineage. The posterior mean number of diversification rate shifts is <inline-formula><mml:math id="M64"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> = 0.91 on the red branch, whereas the across the whole tree it is <inline-formula><mml:math id="M65"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> = 4.9. There are 233 species in the primate phylogeny, and we assumed an equal taxon sampling probability of <italic>ρ</italic> = 0.62 (i.e., we assumed that there were 376 species in total, <xref ref-type="bibr" rid="R19">Groves 2005</xref>). See <xref ref-type="fig" rid="F1">Fig. 1</xref> for the model design.</p></caption><graphic xlink:href="EMS206121-f004"/></fig><fig id="F5" position="float"><label>Fig. 5</label><caption><title>Impact of different base distributions on the branch-specific diversification rate analyses.</title><p>Panel a) depicts the probability density functions of the log-normal (log-mean = log(<inline-formula><mml:math id="M66"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>), <italic>σ</italic> = 0.587), log-uniform (mean = <inline-formula><mml:math id="M67"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, one order of magnitude range), exponential (mean = λ) and gamma (mean = <inline-formula><mml:math id="M68"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, variance equal to the variance of the log-normal) distributions for the speciation rate. For all models, we drew 10 quantiles from the distributions, and we estimated <italic>η</italic> conditional on <bold>λ</bold> and <bold><italic>μ</italic></bold> using maximum likelihood. Panel b) shows the relative support (ΔlogL) for each prior distribution. Panel c) depicts the expected number of shifts across all branches in the primate phylogeny.</p></caption><graphic xlink:href="EMS206121-f005"/></fig><fig id="F6" position="float"><label>Fig. 6</label><caption><p>The impact of the number of rate categories on the number of rate shifts (a) and branch-specific rate estimates (b). All analyses are made on the primates phylogeny (<xref ref-type="bibr" rid="R61">Vos and Mooers, 2006</xref>). The bimodal distribution for average branch rates in (b) reflects the Old World Monkeys clade vs all of the other primates (see <xref ref-type="fig" rid="F4">Fig. 4</xref>). The number of rate categories does not systematically bias the posterior mean number of rate shifts (a), nor the branch-specific rate estimates (b).</p></caption><graphic xlink:href="EMS206121-f006"/></fig><fig id="F7" position="float"><label>Fig. 7</label><caption><p>Branch-specific support for there being at least one shift, and the impact of the shift rate parameter (<italic>η</italic>) on the diversification rate shift inferences, for the primates phylogeny. The Bayes factors per branch (see <xref ref-type="disp-formula" rid="FD17">Eq. 17</xref>) are computed using the maximum-likelihood estimate of the shift rate (<italic>η</italic> = 0.0032). The most supported branch, with a Bayes factor of 173, is the branch that led to the Old World Monkeys clade. If the Bayes factor is above 10, we consider the diversification rate shift to be strongly supported. Panel b) shows the impact of the shift rate (<italic>η</italic>) on the number of supported branches. With our maximum-likelihood estimate of the shift rate, there was one strongly supported branch. If the shift rate is much smaller, then there is more than one strongly supported branch. The posterior mean number of diversification rate shifts (<inline-formula><mml:math id="M69"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>) is highly correlated to the prior expectation (E[N] = <italic>ηt,</italic> where <italic>t</italic> is the tree length), except when the prior is small (c). Note that when the prior and posterior mean number of diversification rate shifts diverge (c) the Bayes factors become larger, which in turn results in statistical support for more branches (b).</p></caption><graphic xlink:href="EMS206121-f007"/></fig><fig id="F8" position="float"><label>Fig. 8</label><caption><p>Time benchmarks of the inference procedure. The run time of Pesto is plotted, partitioned into the log-likelihood calculation (<xref ref-type="disp-formula" rid="FD4">Eq. 4</xref>), the branch-rate calculation (postorder and preorder pass, <bold>D</bold>(<italic>t</italic>), <xref ref-type="disp-formula" rid="FD3">Eq. 3</xref> and <bold>F</bold>(<italic>t</italic>), <xref ref-type="disp-formula" rid="FD6">Eq. 6</xref>), the maximumlikelihood estimation of the shift rate (<inline-formula><mml:math id="M70"><mml:mover accent="true"><mml:mi>η</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>), and the number of shifts calculation (<inline-formula><mml:math id="M71"><mml:mover accent="true"><mml:mi>N</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>(<italic>t</italic>), <xref ref-type="disp-formula" rid="FD12">Eq. 12</xref>). We repeated these for a range of simulated phylogenies, all with <italic>n</italic><sup>2</sup> = 36 rate categories. All time measurements are repeated five times, and we present the median ± the interquartile range. Time spent for installation, just-in-time compilation and garbage collection is not shown.</p></caption><graphic xlink:href="EMS206121-f008"/></fig><fig id="F9" position="float"><label>Fig. 9</label><caption><p>Maximum-likelihood estimates of the shift rate (<italic>η</italic>). Each point represents a phylogeny, simulated under the models in <xref ref-type="table" rid="T1">Table 1</xref>. The true shift rate is chosen such that diversification rate shift events are much less frequent than branching or extinction events (red line, <italic>η</italic> = 0.0008). The phylogenies are split by whether or not a rate shift event happened (panels a and b). We estimated the shift rate both with the true rate categories (i.e., the three-category models in <xref ref-type="table" rid="T1">Table 1</xref>) as well as using the two-step approach (i.e. first estimating <inline-formula><mml:math id="M72"><mml:mover accent="true"><mml:mtext>λ</mml:mtext><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, <inline-formula><mml:math id="M73"><mml:mover accent="true"><mml:mi>μ</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> under the constant-rate birth-death process and secondly estimating the shift rate using maximum likelihood). The allowed rate variation ranges from tiny to large, and we simulated trees with a range of 25 to 125 Ma tree heights. Simulating for a longer time and increasing the rate variation has a similar effect in reducing the estimation error, since both will result in more species-rich trees.</p></caption><graphic xlink:href="EMS206121-f009"/></fig><fig id="F10" position="float"><label>Fig. 10</label><caption><p>Two examples of simulated trees under the birth-death-shift model. First where <monospace>Pesto</monospace> did not recover the true shifts (a), and second where the <monospace>Pesto</monospace> analyses recovered the two oldest shifts (b). The first tree is simulated under tiny rate variation, and the second under large rate variation (models A and D in <xref ref-type="table" rid="T1">Table 1</xref>), for a period of 100 million years. We used the two-step approach in <monospace>Pesto</monospace> (with <italic>n</italic><sup>2</sup> = <italic>K</italic> = 36 categories) to estimate the rate shifts and the branch-specific diversification rates. The color scales are linked per row.</p></caption><graphic xlink:href="EMS206121-f010"/></fig><fig id="F11" position="float"><label>Fig. 11</label><caption><p>Classification of diversification rate shift inferences for 2000 simulated trees, under the two-step inference procedure, split by tree size (a), rate variation (b) and whether or not the true rate shift history contained at least one diversification rate shift. For each tree, we interpreted a diversification rate shift to be present if the Bayes factor was greater than 10 and N was greater than 0.5 per branch. Sorting each branch into true positives (<italic>T</italic>P), true negatives (TN), false positives (FP) and false negatives (FN), we calculated the accuracy ((TP+TN)/(TP+TN+FP+FN)), the false positive ratio (FPR = FP/(FP+TN)) and the false negative ratio (FNR = FN/(<italic>T</italic>P+FN)) for each tree. Each bar represents an average, and the error bar represents the standard error. We only calculated the false negative ratio for trees that had at least one diversification rate shift, since if TP+FN = 0, then the ratio is not defined. The false positive ratio is overwhelmingly small (mean = 0.004%), meaning that if we inferred a diversification rate shift on a branch, it was almost always present in the true tree. The false negative ratio is large, and often close to 1 (mean = 94.4%), meaning that we often inferred too few or no diversification rate shift even when there were shifts in the simulated tree. Different y-axis limits can be seen in <xref ref-type="supplementary-material" rid="SD1">Fig. S7</xref>.</p></caption><graphic xlink:href="EMS206121-f011"/></fig><fig id="F12" position="float"><label>Fig. 12</label><caption><title>The estimation error in branch-specific speciation rates, as proportional errors, in simulated trees.</title><p>Panel a) includes trees where no rate shifts happened, and panel b) includes trees where at least one rate shift happened. We calculated the proportional errors per branch, and averaged across the tree: <inline-formula><mml:math id="M74"><mml:mrow><mml:mi>exp</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mtext>branches</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:msub><mml:mi>∑</mml:mi><mml:mi>M</mml:mi></mml:msub><mml:mrow><mml:mi>log</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mi>M</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>log</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mrow><mml:mi>M</mml:mi><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mtext>true</mml:mtext></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>, where <inline-formula><mml:math id="M75"><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mi>λ</mml:mi><mml:mo stretchy="true">¯</mml:mo></mml:mover></mml:mrow><mml:mi>M</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> is the posterior mean speciation rate on branch <italic>M</italic> (<xref ref-type="disp-formula" rid="FD9">Eq. 9</xref>). A value of one means that the branch-specific speciation rates are unbiased, on average across the tree. Larger than one means overestimation, and less than one means underestimation. See <xref ref-type="supplementary-material" rid="SD1">Figs. S7 and S8</xref> for estimation errors in extinction and net-diversification rates.</p></caption><graphic xlink:href="EMS206121-f012"/></fig><table-wrap id="T1" position="float" orientation="portrait"><label>Table 1</label><caption><p>We set up a series of three-category models with net-diversification rates <bold><italic>r</italic></bold> = [0.04, 0.04 + <italic>β,</italic> 0.04 + 2β], and relative extinction rates of <italic>μ</italic>/<italic>λ</italic> = 2/3. <italic>β</italic> ∈ {0.01, 0.02, 0.03, 0.04} controls the range of allowed rate variation, from tiny to large. We simulated trees of varying height, including 25, 50, 75, 100 and 125 Ma between the most-recent common ancestor and present. All simulations begin with the first category (<italic>λ</italic><sub>1</sub>, <italic>μ</italic><sub>1</sub>), which results in up-shifts being common in the simulated trees. The speciation and extinction rates were chosen such that the variation in tree size was not too large (i.e. such that <italic>n</italic><sub>tips</sub> &gt; 10<sup>5</sup> was relatively rare). We selected a shift rate such that rate shift events are much less frequent than the branching events remaining in the reconstructed tree (<italic>η</italic> = (<italic>λ</italic><sub>1</sub> – <italic>μ</italic><sub>1</sub>)/50 = 0.0008).</p></caption><table frame="hsides" rules="groups"><thead><tr style="border-bottom: double"><th align="left" valign="top">Models</th><th align="center" valign="top">Rate variation</th><th align="center" valign="top"><italic>λ</italic><sub>1</sub></th><th align="center" valign="top"><italic>λ</italic><sub>2</sub></th><th align="center" valign="top"><italic>λ</italic><sub>3</sub></th><th align="center" valign="top"><italic>μ</italic><sub>1</sub></th><th align="center" valign="top"><italic>μ</italic><sub>2</sub></th><th align="center" valign="top"><italic>μ</italic><sub>3</sub></th></tr></thead><tbody><tr><td align="left" valign="top">A</td><td align="center" valign="top">Tiny variation</td><td align="center" valign="top">0.12</td><td align="center" valign="top">0.15</td><td align="center" valign="top">0.18</td><td align="center" valign="top">0.08</td><td align="center" valign="top">0.10</td><td align="center" valign="top">0.12</td></tr><tr><td align="left" valign="top">B</td><td align="center" valign="top">Small variation</td><td align="center" valign="top">0.12</td><td align="center" valign="top">0.18</td><td align="center" valign="top">0.24</td><td align="center" valign="top">0.08</td><td align="center" valign="top">0.12</td><td align="center" valign="top">0.16</td></tr><tr><td align="left" valign="top">C</td><td align="center" valign="top">Moderate variation</td><td align="center" valign="top">0.12</td><td align="center" valign="top">0.21</td><td align="center" valign="top">0.30</td><td align="center" valign="top">0.08</td><td align="center" valign="top">0.14</td><td align="center" valign="top">0.20</td></tr><tr><td align="left" valign="top">D</td><td align="center" valign="top">Large variation</td><td align="center" valign="top">0.12</td><td align="center" valign="top">0.24</td><td align="center" valign="top">0.36</td><td align="center" valign="top">0.08</td><td align="center" valign="top">0.16</td><td align="center" valign="top">0.24</td></tr></tbody></table></table-wrap><table-wrap id="T2" position="float" orientation="portrait"><label>Table 2</label><caption><title>A comparison of methods<sup><xref ref-type="table-fn" rid="TFN1">a</xref></sup> for inferring branch-specific diversification rates and diversification rate shift events.</title></caption><table frame="hsides" rules="groups"><thead><tr><th align="left" valign="top"/><th align="center" valign="top">Pesto</th><th align="center" valign="top">LSBDS</th><th align="center" valign="top">BAMM</th><th align="center" valign="top">ClaDS</th><th align="center" valign="top">MTBD</th><th align="center" valign="top">MiSSE</th><th align="center" valign="top">RPANDA</th></tr></thead><tbody><tr><td align="left" valign="top">Autocorrelated shifts</td><td align="center" valign="top">no</td><td align="center" valign="top">no</td><td align="center" valign="top">no</td><td align="center" valign="top">yes</td><td align="center" valign="top">no</td><td align="center" valign="top">no</td><td align="center" valign="top">no</td></tr><tr><td align="left" valign="top">Base distribution</td><td align="center" valign="top">discrete</td><td align="center" valign="top">discrete</td><td align="center" valign="top">continuous</td><td align="center" valign="top">continuous</td><td align="center" valign="top">discrete</td><td align="center" valign="top">discrete</td><td align="center" valign="top">-</td></tr><tr><td align="left" valign="top">Base dist. shape</td><td align="center" valign="top">flexible</td><td align="center" valign="top">flexible</td><td align="center" valign="top">exponential</td><td align="center" valign="top">log-normal</td><td align="center" valign="top">categorical</td><td align="center" valign="top">categorical</td><td align="center" valign="top">-</td></tr><tr><td align="left" valign="top">Base dist. parameters</td><td align="center" valign="top">mean</td><td align="center" valign="top">flexible</td><td align="center" valign="top">mean</td><td align="center" valign="top">mean &amp; variance</td><td align="center" valign="top">-</td><td align="center" valign="top">-</td><td align="center" valign="top">-</td></tr><tr><td align="left" valign="top">Div. rate decay</td><td align="center" valign="top">no</td><td align="center" valign="top">no</td><td align="center" valign="top">yes</td><td align="center" valign="top">no</td><td align="center" valign="top">no</td><td align="center" valign="top">no</td><td align="center" valign="top">yes</td></tr><tr><td align="left" valign="top">Shifts at extinct/ unsampled lineages</td><td align="center" valign="top">yes</td><td align="center" valign="top">yes</td><td align="center" valign="top">no</td><td align="center" valign="top">yes</td><td align="center" valign="top">no</td><td align="center" valign="top">yes</td><td align="center" valign="top">no</td></tr><tr><td align="left" valign="top">Phylogeny</td><td align="center" valign="top">fixed</td><td align="center" valign="top">flexible</td><td align="center" valign="top">fixed</td><td align="center" valign="top">fixed<sup><xref ref-type="table-fn" rid="TFN2">b</xref></sup></td><td align="center" valign="top">fixed<sup><xref ref-type="table-fn" rid="TFN2">b</xref></sup></td><td align="center" valign="top">fixed</td><td align="center" valign="top">fixed</td></tr><tr><td align="left" valign="top">Location of rate shifts</td><td align="center" valign="top">branch</td><td align="center" valign="top">branch</td><td align="center" valign="top">branch</td><td align="center" valign="top">node</td><td align="center" valign="top">branch</td><td align="center" valign="top">branch</td><td align="center" valign="top">node</td></tr><tr><td align="left" valign="top">Shift hypothesis test</td><td align="center" valign="top">Bayes factor</td><td align="center" valign="top">Bayes factor</td><td align="center" valign="top">Bayes factor</td><td align="center" valign="top">-</td><td align="center" valign="top">-</td><td align="center" valign="top">-</td><td align="center" valign="top">AICc</td></tr><tr><td align="left" valign="top">Focal estimate<sup><xref ref-type="table-fn" rid="TFN3">c</xref></sup></td><td align="center" valign="top">tip &amp; branch</td><td align="center" valign="top">branch</td><td align="center" valign="top">tip &amp; branch</td><td align="center" valign="top">branch</td><td align="center" valign="top">branch</td><td align="center" valign="top">tip &amp; node</td><td align="center" valign="top">branch</td></tr><tr><td align="left" valign="top">Ancestral reconstruction<sup><xref ref-type="table-fn" rid="TFN4">d</xref></sup></td><td align="center" valign="top">dynamic, <italic>O</italic>(<italic>NK</italic>)</td><td align="center" valign="top">sampling</td><td align="center" valign="top">sampling</td><td align="center" valign="top">sampling</td><td align="center" valign="top">sampling</td><td align="center" valign="top">dynamic, <italic>O</italic>(<italic>N</italic><sup>2</sup><italic>K</italic><sup>2</sup>)</td><td align="center" valign="top">stepwise AICc</td></tr></tbody></table><table-wrap-foot><fn id="TFN1"><label>a</label><p id="P68">Methods include <monospace>Pesto, LSBDS</monospace> (<xref ref-type="bibr" rid="R21">Höhna et al., 2019</xref>), <monospace>BAMM</monospace> (<xref ref-type="bibr" rid="R48">Rabosky, 2014</xref>), <monospace>ClaDS</monospace> (<xref ref-type="bibr" rid="R30">Maliet et al., 2019</xref>), <monospace>MTBD</monospace> (<xref ref-type="bibr" rid="R4">Barido-Sottani et al., 2020</xref>), <monospace>MiSSE</monospace> (<xref ref-type="bibr" rid="R60">Vasconcelos et al., 2022</xref>) and <monospace>RPANDA</monospace> (<xref ref-type="bibr" rid="R34">Mazet et al., 2023</xref>).</p></fn><fn id="TFN2"><label>b</label><p id="P69">See <xref ref-type="bibr" rid="R3">Barido-Sottani and Morlon (2023)</xref> where the phylogeny is allowed to be jointly inferred.</p></fn><fn id="TFN3"><label>c</label><p id="P70">All MCMC based methods and Pesto can infer, with adequate post-processing of the results, estimates at internal nodes and tips.</p></fn><fn id="TFN4"><label>d</label><p id="P71"><italic>N</italic> represents the number of nodes in a phylogeny, and <italic>K</italic> represents the number of rate categories.</p></fn></table-wrap-foot></table-wrap></floats-group></article>