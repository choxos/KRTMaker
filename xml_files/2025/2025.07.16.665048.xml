<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="epub">2692-8205</issn></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS207403</article-id><article-id pub-id-type="doi">10.1101/2025.07.16.665048</article-id><article-id pub-id-type="archive">PPR1052429</article-id><article-version-alternatives><article-version article-version-type="status">preprint</article-version><article-version article-version-type="number">1</article-version></article-version-alternatives><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>Barcoded Rabies In Situ Connectomics for high-throughput reconstruction of neural circuits</article-title></title-group><contrib-group><contrib contrib-type="author" equal-contrib="yes"><name><surname>Becalick</surname><given-names>Alexander</given-names></name><xref ref-type="aff" rid="A1">1</xref></contrib><contrib contrib-type="author" equal-contrib="yes"><name><surname>Blot</surname><given-names>Antonin</given-names></name><xref ref-type="aff" rid="A1">1</xref></contrib><contrib contrib-type="author"><name><surname>Strom</surname><given-names>Molly</given-names></name><xref ref-type="aff" rid="A2">2</xref></contrib><contrib contrib-type="author" corresp="yes"><name><surname>Znamenskiy</surname><given-names>Petr</given-names></name><xref ref-type="aff" rid="A1">1</xref></contrib></contrib-group><aff id="A1"><label>1</label>Specification and Function of Neural Circuits Laboratory, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/04tnbqb63</institution-id><institution>The Francis Crick Institute</institution></institution-wrap>, <country country="GB">United Kingdom</country></aff><aff id="A2"><label>2</label>Viral Vector Service, <institution-wrap><institution-id institution-id-type="ror">https://ror.org/04tnbqb63</institution-id><institution>The Francis Crick Institute</institution></institution-wrap>, <country country="GB">United Kingdom</country></aff><author-notes><corresp id="CR1">Correspondence: <email>petr.znamenskiy@crick.ac.uk</email></corresp></author-notes><pub-date pub-type="nihms-submitted"><day>22</day><month>07</month><year>2025</year></pub-date><pub-date pub-type="preprint"><day>20</day><month>07</month><year>2025</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P1">Sequencing of oligonucleotide barcodes holds promise as a high-throughput approach for reconstructing synaptic connectivity at scale (<xref ref-type="bibr" rid="R1">1</xref>). Rabies viruses can act as a vehicle for barcode transmission, thanks to their ability to spread between synaptically connected cells (<xref ref-type="bibr" rid="R2">2</xref>, <xref ref-type="bibr" rid="R3">3</xref>). However, applying barcoded rabies viruses to map synaptic connections <italic>in vivo</italic> has proved challenging (<xref ref-type="bibr" rid="R4">4</xref>–<xref ref-type="bibr" rid="R7">7</xref>). Here, we develop Barcoded Rabies In Situ Connectomics (BRISC) for high-throughput connectivity mapping in the mouse brain. To ensure that the majority of post-synaptic "starter" neurons are uniquely labeled with distinct barcode sequences, we first generated libraries of rabies viruses with sufficient diversity to label &gt;1000 neurons uniquely. To minimize the probability of barcode transmission between starter neurons, we developed a strategy to tightly control their density. We then applied BRISC to map inputs of single neurons in the primary visual cortex (V1). Using <italic>in situ</italic> sequencing, we read out the expression of viral barcodes in rabies-infected neurons, while preserving spatial information. We then matched barcode sequences between starter and presynaptic neurons, mapping the inputs of 385 neurons and identifying 7,814 putative synaptic connections. The resulting connectivity matrix revealed layer- and cell-type-specific local connectivity rules and topographic organization of long-range inputs to V1. These results show that BRISC can simultaneously resolve the synaptic connectivity of hundreds of neurons while preserving spatial information, enabling reconstruction of neural circuits at an unprecedented scale.</p></abstract></article-meta></front><body><sec id="S1" sec-type="intro"><title>Introduction</title><p id="P2">Mechanistic understanding of how networks of neurons carry out neural computations requires knowledge of their underlying synaptic connectivity. However, current methods for reconstructing synaptic connections are extremely laborious and typically limited to mapping connections between nearby neurons. Although recent years have seen dramatic advances in connectomics approaches based on volume electron microscopy, they remain limited to reconstructing single volumes up to ~1 mm<sup>3</sup> (<xref ref-type="bibr" rid="R8">8</xref>–<xref ref-type="bibr" rid="R10">10</xref>). The effort required to process a single volume makes it impractical to compare connectivity rules between different areas or experimental conditions, such as in models of psychiatric or neurological diseases. Adding to the challenge, recent transcriptomic studies have revealed a surprising diversity of cell types throughout the brain (<xref ref-type="bibr" rid="R11">11</xref>–<xref ref-type="bibr" rid="R15">15</xref>), raising speculation that different transcriptomic cell types may subserve distinct computational roles owing to their differential connectivity (<xref ref-type="bibr" rid="R16">16</xref>, <xref ref-type="bibr" rid="R17">17</xref>). Therefore, there is an acute need for methods that can read out synaptic connectivity with high throughput while preserving molecular information.</p><p id="P3">Over a decade ago, Zador and colleagues (<xref ref-type="bibr" rid="R1">1</xref>) proposed that synaptic connectivity could be read out at a massive scale using DNA sequencing. By labeling individual neurons with unique oligonucleotide "barcodes" and having them transmit these barcodes to their synaptic partners, the connectivity matrix could be read out by matching barcode sequences across neurons. Owing to its scalability, this approach has the potential to revolutionize connectomics, but it has been challenging to implement for mapping connectivity <italic>in vivo</italic> (<xref ref-type="bibr" rid="R4">4</xref>, <xref ref-type="bibr" rid="R5">5</xref>, <xref ref-type="bibr" rid="R18">18</xref>, <xref ref-type="bibr" rid="R19">19</xref>).</p><p id="P4">Rabies viruses can propagate transynaptically from infected neurons to their presynaptic partners and have been proposed as a potential vehicle for barcode transmission (<xref ref-type="bibr" rid="R4">4</xref>–<xref ref-type="bibr" rid="R7">7</xref>). Conventional monosynaptic rabies tracing labels inputs to populations of interest using deletion mutant rabies viruses that lack the gene encoding rabies glycoprotein (G), which is essential for the generation of infectious virions (<xref ref-type="bibr" rid="R2">2</xref>, <xref ref-type="bibr" rid="R3">3</xref>). Therefore, only cell populations where G expression is provided <italic>in trans</italic>, referred to as <italic>starter cells</italic>, can transmit the virus to their direct presynaptic partners (<xref ref-type="bibr" rid="R3">3</xref>). As long as presynaptic cells do not express G themselves, the virus cannot propagate further, leading to monosynaptically restricted tracing.</p><p id="P5">Barcoded rabies tracing aims to map inputs to many starter neurons simultaneously while maintaining single-cell resolution not afforded by traditional bulk rabies tracing. By using rabies viruses that express random mRNA barcodes, connections between individual presynaptic and starter neurons are identified by matching their barcode sequences (<xref ref-type="fig" rid="F1">Fig. 1a</xref>). Despite the promise of this technology, barcoded rabies tracing has not yet been applied to map synaptic connectivity at scale. An essential prerequisite for applying such an approach is the unique labeling of starter neurons with distinct barcode sequences. However, this has proved difficult to achieve in practice (<xref ref-type="bibr" rid="R4">4</xref>, <xref ref-type="bibr" rid="R5">5</xref>). First, multiple starter cells may be infected by rabies virions carrying the same sequence during the initial viral injection. Second, non-unique labeling can also occur if starter cells transmit barcodes to one another. Both of these factors have hampered previous efforts to map connectivity using barcoded rabies viruses (<xref ref-type="bibr" rid="R5">5</xref>). Although the generation of higher diversity libraries has since been reported, they have not yet been applied <italic>in vivo</italic> (<xref ref-type="bibr" rid="R7">7</xref>).</p><p id="P6">Here, we describe the development of Barcoded Rabies In Situ Connectomics (BRISC), which overcomes these obstacles to map putative presynaptic ensembles of hundreds of starter neurons simultaneously. BRISC uses libraries of rabies viruses with sufficient diversity to uniquely label &gt;1,000 starter neurons while ensuring that &gt;95% of them carry unique barcodes. To minimize the frequency of transmission of barcodes between starter neurons, their density is tightly controlled by limiting dilution of an AAV expressing Cre-recombinase. In contrast to Cre delivery targeting specific transcriptionally or anatomically defined cell types (<xref ref-type="bibr" rid="R5">5</xref>), the stochastic infection of starter neurons by AAV-Cre enables BRISC to map inputs of diverse cell populations simultaneously. After allowing the rabies virus to spread from starter to presynaptic neurons, barcodes are read out from intact tissue sections using <italic>in situ</italic> sequencing, preserving spatial information.</p><p id="P7">We applied BRISC to map monosynaptic inputs onto single neurons in the mouse primary visual cortex (V1). First, by reconstructing local connectivity, we identified layer-specific connectivity rules that are consistent with the established wiring patterns of V1. Second, by combining BRISC with <italic>in situ</italic> sequencing of cell-type marker transcripts, we demonstrate its potential to relate the connectivity of individual neurons to their molecular identity. Finally, by applying BRISC to map the spatial distribution of long-range inputs, we reveal the topographic organization of corticocortical inputs onto single V1 neurons. Together, these results demonstrate the potential of BRISC for high-throughput reconstruction of both long-range and local microcircuits.</p></sec><sec id="S2" sec-type="results"><title>Results</title><sec id="S3"><title>Generating high diversity barcoded rabies libraries</title><p id="P8">Identification of individual synaptic connections using barcoded rabies tracing depends on the unique labeling of starter neurons by distinct barcode sequences. We chose the CVS-N2c(ΔG) strain of rabies virus as the basis for generating diverse barcoded viral libraries. Compared to the widely used SAD-B19(ΔG) strain, CVS-N2c(ΔG) shows enhanced transsynaptic spread and lower neuronal cytotoxicity (<xref ref-type="bibr" rid="R20">20</xref>). We first optimized the production of high-diversity barcoded rabies libraries. During the packaging of glycoprotein-deficient rabies viruses, virions are first generated by rescue from plasmid-encoded viral cDNA. This rescue is highly inefficient (<xref ref-type="bibr" rid="R21">21</xref>) and therefore constitutes the primary bottleneck reducing library diversity (<xref ref-type="bibr" rid="R4">4</xref>). The first step of rabies viral rescue is the transcription of the viral antigenome from the transfected plasmid DNA. The efficiency of rescue is increased by producing the correct 5’ and 3’ terminal sequences of the transcribed antigenome, which are generated by ribozyme-mediated cleavage of the transcript ends (<xref ref-type="bibr" rid="R22">22</xref>). Previously described plasmids for rescue of CVS-N2c(ΔG) contain an incomplete sequence of the hepatitis delta virus antigenomic ribozyme (HDVagrz) responsible for generating the 3’ end of the antigenome (<xref ref-type="bibr" rid="R23">23</xref>). To improve rescue efficiency, we first inserted the full-length HDVagrz in the CVS-N2c(ΔG) genome plasmid. Then we inserted a 20-nucleotide random barcode sequence downstream of an mCherry transgene in the CVS-N2c(ΔG) genome by inverse PCR (<xref ref-type="fig" rid="F1">Fig. 1b</xref>).</p><p id="P9">We used the resulting plasmid library to package barcoded rabies viruses and optimized the viral packaging protocol to improve the diversity of the viral library (see <xref ref-type="sec" rid="S10">Methods</xref>). We quantified the diversity of the plasmid and the resulting viral libraries using Illumina sequencing (<xref ref-type="fig" rid="F1">Fig. 1c</xref>; <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 1a,b</xref>). As a consequence of the bottleneck imposed by the inefficiency of rabies virus rescue, the resulting viral library contained five-fold fewer unique barcodes than the plasmid library (2.8 × 10<sup>6</sup> barcodes in the plasmid library compared to 5.3 × 10<sup>5</sup> in the viral library). Furthermore, while the 100 most abundant barcodes accounted for only 0.06% of the plasmid library, they comprised 3.9% of the viral library. These results demonstrate that the diversity of barcoded virus libraries is constrained by both the inefficiency of viral rescue and the uneven amplification of viral barcodes during subsequent viral production steps.</p><p id="P10">We next calculated how many neurons could be labeled uniquely if barcodes were randomly sampled from each library based on their abundance distributions (<xref ref-type="fig" rid="F1">Fig. 1d</xref>) (<xref ref-type="bibr" rid="R24">24</xref>). The plasmid library had sufficient diversity to label &gt;80,000 cells while ensuring that 95% of them received unique barcodes. The same threshold was reached at 1,320 cells for the viral library. Therefore, the resulting barcoded viral libraries have sufficient diversity to trace inputs of &gt;1,000 starter neurons despite the reduction in barcode diversity during viral packaging, surpassing most previously described barcoded rabies libraries (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 1a,b</xref>) (<xref ref-type="bibr" rid="R4">4</xref>, <xref ref-type="bibr" rid="R5">5</xref>, <xref ref-type="bibr" rid="R7">7</xref>, <xref ref-type="bibr" rid="R25">25</xref>).</p><p id="P11">We next asked how the diversity of the rabies viral library depends on the scale of the viral rescue. Compared to a library generated from transfection of 12 wells, a library generated from 2 wells had a substantially lower diversity, sufficient to label only ~132 neurons with the same 95% unique threshold (<xref ref-type="fig" rid="F1">Fig. 1e-f</xref>). This indicates that viral rescue constitutes a key bottleneck in the production of barcoded rabies viruses, suggesting that library diversity could be further improved by increasing its scale.</p></sec><sec id="S4"><title>Controlling starter neuron density</title><p id="P12">Non-unique labeling of starter neurons can also result from the transsynaptic spread of viral barcodes between starters. Under the simplifying assumption of random connectivity, the probability that a given starter neuron will transmit its barcode to another starter cell is determined by the number of neurons transsynaptically infected by each starter cell, and by the proportion of neurons at the injection site that are starter cells (<xref ref-type="fig" rid="F1">Fig. 1g</xref>, see <xref ref-type="sec" rid="S10">Methods</xref>). To determine the average number of nearby cells labeled by each starter neuron, we injected starter AAVs FLEX-H2B-mCherry-P2A-N2cG and FLEX-H2B-EBFP2-P2A-TVA in the mouse primary visual cortex (V1) alongside low-titer AAV hSyn-Cre to control starter cell density, followed by CVS-N2c(ΔG) mCherry barcoded rabies virus (<xref ref-type="fig" rid="F1">Fig. 1h</xref>). We then quantified the distribution of rabies-infected cells throughout the brain and the number of starter neurons at the injection site. Starter neurons were identified based on nuclear fluorescence of the H2B-mCherry-P2A-N2cG construct (<xref ref-type="fig" rid="F1">Fig. 1i</xref>, see <xref ref-type="sec" rid="S10">Methods</xref>). On average, we detected 66.6 presynaptic neurons per starter (17,505 presynaptic neurons for 263 starter cells). As the expression of starter AAVs is restricted to the injection site, local but not long-range transsynaptic spread can lead to the transmission of barcodes between starter neurons. Therefore, we quantified the density of rabies-infected neurons as a function of distance from the injection site (<xref ref-type="fig" rid="F1">Fig. 1j</xref>). As expected, the density was highest near the center of the injection site, with each starter neuron infecting an average of 20.9 presynaptic cells within 0.5 mm of the injection center. Together, these observations suggest that to limit the proportion of starter neurons that transmit their barcodes to other starter cells to &lt;5%, the proportion of starter cells at the injection site must be limited to 2.6 × 10<sup>-3</sup>, which corresponds to a density of ~400 starter cells per mm<sup>3</sup> (<xref ref-type="fig" rid="F1">Fig. 1g</xref>, see <xref ref-type="sec" rid="S10">Methods</xref>).</p><p id="P13">As the probability of transsynaptic spread rapidly drops off with distance, in an ideal scenario starter neurons would be uniformly distributed throughout the brain region of interest. However, stereotactic injection of starter AAVs inevitably results in the clustering of starter neurons. This would lead to a high local density of starter cells, thereby increasing the probability of barcode transmission between them. To control the density of starter neurons while minimizing their spatial clustering, we used tail vein injections of blood-brain-barrier penetrating AAV PHP.eB hSyn-Cre (<xref ref-type="bibr" rid="R26">26</xref>). Intravenous delivery resulted in a more uniform distribution of starter cells compared to local intracerebral injection (<xref ref-type="fig" rid="F1">Fig. 1k-m</xref>). Consequently, the pairwise distances between starter cells were higher after intravenous delivery of Cre compared to intracerebral delivery (<xref ref-type="fig" rid="F1">Fig. 1m</xref>).</p><p id="P14">Finally, to determine the conditions necessary to achieve the desired density of starter neurons, we injected serial dilutions of AAV PHP.eB hSyn-Cre into tdTomato Cre reporter mice and quantified the number of tdTomato-positive neurons throughout the brain using serial two-photon tomography. The density of cells expressing Cre scaled with increasing titers of AAV (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 1c</xref>). Therefore, systemic delivery of AAV PHP.eB hSyn-Cre provides a means to control the density of starter neurons in order to limit the probability of transsynaptic spread between them.</p></sec><sec id="S5"><title><italic>In situ</italic> sequencing of rabies viral barcodes</title><p id="P15">We next applied BRISC to systematically map synaptic inputs of V1 neurons. We used a tail vein injection of AAV PHP.eB hSyn-Cre and stereotactic injections of AAVs FLEX-H2B-mCherry-P2A-N2cG and FLEX-H2B-EBFP2-P2A-TVA to induce sparse expression of TVA and N2cG from starter AAVs. We made three injections arranged along the mediolateral extent of the primary visual cortex, allowing us to sample starter neurons across different layers, cell types, and retinotopic coordinates of V1. Thirteen days later, we injected the barcoded rabies virus library described in <xref ref-type="fig" rid="F1">Fig. 1c</xref> at the same three injection sites as the AAVs. We allowed the barcodes to spread to presynaptic neurons for seven days before collecting the brain tissue (<xref ref-type="fig" rid="F2">Fig. 2a</xref>).</p><p id="P16">Ensuring that starter neurons are uniquely labeled requires dense sequencing to capture the majority of starter neurons, precluding the use of single-cell or single-nucleus RNA sequencing, which recovers only a subset of infected neurons (<xref ref-type="bibr" rid="R4">4</xref>, <xref ref-type="bibr" rid="R5">5</xref>). To overcome this, we developed a strategy for sequencing rabies virus barcodes <italic>in situ</italic> alongside endogenous transcripts for cell type identification based on BARseq2 and coppaFISH (see <xref ref-type="sec" rid="S10">Methods</xref>) (<xref ref-type="bibr" rid="R27">27</xref>, <xref ref-type="bibr" rid="R28">28</xref>). This method uses rolling circle amplification followed by sequencing-by-synthesis from intact tissue sections (<xref ref-type="fig" rid="F2">Fig. 2b</xref>), which is performed by imaging the tissue over multiple sequencing rounds to read out barcode sequences. Recovering all starter neurons in a barcoded rabies tracing experiment by <italic>in situ</italic> sequencing requires imaging tens of tissue sections, which limits the throughput of barcoded rabies tracing experiments. To increase the speed of data acquisition, we designed custom sequencing flowcells and an imaging setup based on a conventional epifluorescence microscope, which allowed for the parallel imaging of the four fluorophores associated with each DNA base. This enabled the simultaneous sequencing of up to 40 coronal sections of mouse brain (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 2</xref>). We processed serial cryosections spanning 800 µm of brain tissue along the anterior-posterior axis, covering a total imaging volume of ~12 mm<sup>3</sup> (<xref ref-type="fig" rid="F2">Fig. 2c</xref>). We sequenced 10 nucleotides of the viral barcode as the number of starter cells that could be uniquely identified plateaued at that length (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 3</xref>, see <xref ref-type="sec" rid="S10">Methods</xref>).</p><p id="P17">Nuclear localized H2B-mCherry expressed from AAV FLEX-H2B-mCherry-P2A-N2cG is preserved in cryosections, allowing the detection of starter neurons without any further staining (<xref ref-type="fig" rid="F2">Fig. 2d</xref>). The sequenced volume contained 92% of all mCherry-positive cells across the injection site (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4a</xref>, see <xref ref-type="sec" rid="S10">Methods</xref>). Based on the distribution of presynaptic cells in bulk tracing experiments (<xref ref-type="fig" rid="F1">Fig. 1h-j</xref>), we estimated that the sequenced volume included approximately 44% of all presynaptic cells across the brain (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4b</xref>). We then sequenced the transcripts of a panel of cell-type marker genes (<xref ref-type="fig" rid="F2">Fig. 2e</xref>, <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4c</xref>), selected to facilitate the classification of V1 cell types, followed by the rabies virus barcode (<xref ref-type="fig" rid="F2">Fig. 2f-g</xref>). Finally, we used <italic>in situ</italic> hybridization to measure the expression of highly expressed cell-type marker genes, followed by DAPI staining to assist with cell segmentation. Barcodes were assigned to cells using a probabilistic algorithm that relies on spatial clustering of barcodes near the infected cell nucleus (see <xref ref-type="sec" rid="S10">Methods</xref>). We used the expression of cell-type marker transcripts to classify cells into major cortical cell types (<xref ref-type="fig" rid="F2">Fig. 2h</xref>). Rabies-infected cells were intermingled with uninfected cells in UMAP space and were assigned to clusters corresponding to major cell types of V1 (<xref ref-type="fig" rid="F2">Fig. 2i</xref>), indicating that rabies infection did not interfere with cell type identification.</p><p id="P18">We classified rabies-infected neurons as starter cells if they expressed H2B-mCherry or as presynaptic cells if they did not, and examined the barcode sequences present in individual cells. The majority (93%) of rabies-infected neurons contained only one barcode (<xref ref-type="fig" rid="F3">Fig. 3a</xref>), although starter cells were more likely to contain multiple barcodes than presynaptic cells. This finding is consistent with previous studies (<xref ref-type="bibr" rid="R4">4</xref>, <xref ref-type="bibr" rid="R6">6</xref>) and is likely a consequence of multiple EnvA/TVA-mediated infection events occurring per cell in starter neurons after viral injection.</p><p id="P19">In total, we detected 2,158 distinct barcode sequences in rabies-infected cells. 96.2% of these barcodes precisely matched sequences in the RNA sequencing library derived from the barcoded viral prep, compared to only 37.9% of randomly generated barcodes. The probability of finding a barcode <italic>in situ</italic> was proportional to their abundance in the sequencing library (<xref ref-type="fig" rid="F3">Fig. 3b</xref>), validating the fidelity of barcode detection <italic>in situ</italic>. In contrast, random barcode sequences tended to correspond to low-abundance sequences in the library (<xref ref-type="fig" rid="F3">Fig. 3b</xref>).</p><p id="P20">Among these barcodes, 564 were found in starter neurons. The majority of these were found in exactly one starter cell (<xref ref-type="fig" rid="F3">Fig. 3c</xref>). The remaining 1,594 orphan barcodes that were not found in any starter cells were typically found in a small number of presynaptic cells (<xref ref-type="fig" rid="F3">Fig. 3d</xref>). We considered several factors, which could explain the presence of these orphan barcodes: direct infection of non starter cells during the initial virus injection, failure to detect starter neurons due to the sensitivity limits of barcode sequencing or mCherry fluorescence detection, and the death or loss of starter neurons before sequencing.</p><p id="P21">Neurons infected by the CVS-N2c strain of rabies virus have previously been shown to remain viable for at least 2 weeks (<xref ref-type="bibr" rid="R20">20</xref>). Since the tissue in our experiments was collected 1 week after rabies injection, extensive rabies-induced cell death is unlikely. However, we cannot exclude that some of the orphan barcodes could result from the death of starter neurons due to rabies cytotoxicity.</p><p id="P22">Orphan barcodes could also result from direct infection of mCherry-negative cells during the initial virus injection as a consequence of contamination by G-coated rabies virus or leaky TVA expression. To quantify the frequency of infection by G-coated rabies virus, we injected the barcoded rabies virus without injecting starter AAVs and quantified the number of rabies-infected neurons around the injection site (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 5a</xref>, n=2, 4 and 5 neurons). We also injected AAV FLEX-H2B-EBFP2-P2A-TVA without AAV PHP.eB hSyn-Cre or AAV FLEX-H2B-mCherry-P2A-N2cG. This was followed by rabies injection after 14 days to determine the rate of direct rabies infection due to leaky TVA expression (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 5b</xref>, n=2, 9 and 17 neurons). As the number of rabies-infected neurons detected in these experiments was far fewer than the 11,445 presynaptic cells expressing orphan barcodes observed in our <italic>in situ</italic> sequencing data, orphan barcodes cannot be explained by contamination from G-coated rabies virus or leaky TVA expression.</p><p id="P23">Orphan barcodes could also result from the missed detection of starter neurons due to the limited sensitivity of barcode detection. To quantify this sensitivity, we designed a panel of probes targeting the transcripts of N, P, M, and L rabies virus genes, which allowed us to reliably detect rabies-infected neurons <italic>in situ</italic> (<xref ref-type="fig" rid="F3">Fig. 3e</xref>, inset). We found that 17.5% of rabies-infected neurons contained &lt; 3 barcode spots and therefore, would not be identified in the sequencing experiments described above (<xref ref-type="fig" rid="F3">Fig. 3e</xref>). Therefore, while identification of starters and presynaptic neurons may be limited by the sensitivity of barcode detection, it cannot fully account for the frequency of orphan barcodes and the fact that the majority of them are present in &lt;5 presynaptic cells.</p><p id="P24">Alternatively, orphan barcodes could originate from starter neurons with low mCherry expression that fall below our detection threshold. Since H2B-mCherry is co-expressed in a bicistronic cassette with N2cG via a P2A ribosome skipping peptide sequence, cells with low mCherry expression are likely to express low levels of N2cG (<xref ref-type="bibr" rid="R29">29</xref>), resulting in inefficient transsynaptic spread (<xref ref-type="bibr" rid="R30">30</xref>, <xref ref-type="bibr" rid="R31">31</xref>). This would explain the observation that orphan barcodes are typically found in a small number of presynaptic neurons (<xref ref-type="fig" rid="F3">Fig. 3d</xref>). To explore this possibility, we selected barcodes found in exactly one starter neuron and quantified mCherry fluorescence intensity in the starter cell. We found that mCherry fluorescence was correlated with the number of presynaptic cells with the same barcode sequence (<xref ref-type="fig" rid="F3">Fig. 3f</xref>). Together, these findings suggest that the excess of orphan barcodes with small numbers of presynaptic cells originates from starter neurons that fell below the mCherry detection threshold.</p><p id="P25">Among barcodes found in starter neurons, 442 were found in exactly one starter, while 122 were found in multiple starter cells (<xref ref-type="fig" rid="F3">Fig. 3c</xref>). As discussed above, barcodes present in multiple starter neurons could result from initial infection by virions carrying the same sequence or transsynaptic spread between starters. To distinguish between these possibilities, we first asked whether barcodes present in multiple starter neurons were more abundant in the viral library (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 6a,b</xref>). These barcodes largely followed the abundance distribution of the viral library, with only a small excess of high-abundance sequences among barcodes present in multiple starters (6.6%, 8/122 barcodes). In addition, the median pairwise distance between starter cells sharing a barcode was shorter than between those labeled with different barcode sequences (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 6c</xref>). Together, these observations suggest that non-uniquely labeled starter cells primarily result from transmission of barcodes between starters. Barcodes present in &gt;1 starter cell were excluded from further analyses.</p></sec><sec id="S6"><title>Barcoded rabies tracing reveals spatial organization of presynaptic ensembles of single neurons</title><p id="P26">We next analyzed the spatial distribution of starter and presynaptic neurons by registering <italic>in situ</italic> sequencing data to the Allen Common Coordinate Framework reference atlas (<xref ref-type="bibr" rid="R32">32</xref>). The majority (93.2%) of starter neurons were located in V1, distributed along the mediolateral axis following the locations of rabies virus injections (<xref ref-type="fig" rid="F4">Fig. 4a</xref>). On the other hand, presynaptic neurons were more broadly distributed and were found in higher visual areas, retrosplenial cortex, temporal association area, auditory areas, and lateral geniculate nucleus in the thalamus. Within V1, starter neurons were most densely concentrated within layers 2/3 and 5 (<xref ref-type="fig" rid="F4">Fig. 4b</xref>), potentially reflecting the tropism of AAV PHP.eB (<xref ref-type="bibr" rid="R33">33</xref>, <xref ref-type="bibr" rid="R34">34</xref>), while presynaptic cells were more broadly distributed.</p><p id="P27">We analyzed the putative presynaptic sub-networks of starter neurons expressing barcodes that were found in exactly one starter cell. The majority of presynaptic cells were connected to one such starter neuron, although some contained barcodes from multiple starter cells (<xref ref-type="fig" rid="F4">Fig. 4c</xref>). For starter neurons that expressed multiple barcodes, presynaptic neurons almost always received only one of them (<xref ref-type="fig" rid="F4">Fig. 4d</xref>). This is likely a consequence of the low probability of retrograde transmission of each barcode and may also be exacerbated by superinfection exclusion after primary rabies infection has been established in a presynaptic cell (<xref ref-type="bibr" rid="R35">35</xref>).</p><p id="P28">We considered all neurons expressing any of the unique barcodes present in a given starter cell as a part of its presynaptic sub-network. On average, we detected 20.3 presynaptic cells for every uniquely labeled starter neuron. As the sequenced volume contained the majority of starter cells but only ~44% their presynaptic inputs (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4b</xref>), this figure underestimates the overall efficiency of transsynaptic spread.</p><p id="P29">Presynaptic neurons connected to V1 cells were found both within V1 and in other cortical areas (<xref ref-type="fig" rid="F4">Fig. 4e</xref>). They tended to cluster near their starter cell (<xref ref-type="fig" rid="F4">Fig. 4f-g</xref>, median distance 0.73 mm vs 1.14 mm for shuffle control, p-value = 0.002, n = 385 starter cells, 7,693 presynaptic cells, 7,814 connections, see <xref ref-type="sec" rid="S10">Methods</xref>), consistent with the fact that the connection probability of cortical neurons rapidly decreases with intersomatic distance (<xref ref-type="bibr" rid="R36">36</xref>, <xref ref-type="bibr" rid="R37">37</xref>).</p></sec><sec id="S7"><title>Layer- and cell-type-specific connectivity rules</title><p id="P30">Focusing on the connectivity of excitatory neurons, we analyzed the layer distribution of local (&lt; 1 mm) presynaptic inputs as a function of the layer location of the starter cells (<xref ref-type="fig" rid="F5">Fig. 5a</xref>). We first computed the input fraction, i.e., the proportion of excitatory inputs across different cortical layers for starter neurons across cortical layers, revealing layer-specific input patterns (<xref ref-type="fig" rid="F5">Fig. 5b-d</xref>). Most notably, neurons in layer 2/3 were strongly recurrently connected, receiving 42% of their local excitatory inputs from other layer 2/3 cells. Their second strongest input arose from layer 4, reflecting the well-established pathway through which feed-forward sensory signals are conveyed to layer 2/3 neurons (<xref ref-type="bibr" rid="R38">38</xref>). Neurons in layer 5 were also recurrently connected and received strong layer 2/3 input. Finally, layer 6a received broad input from both superficial and deep layers. These findings are consistent with the canonical organization of the cortical circuit and bulk rabies tracing data (<xref ref-type="bibr" rid="R39">39</xref>).</p><p id="P31">Next, to identify over- and under-represented connections, we compared the observed connectivity matrix to a shuffle distribution, where we randomly permuted the barcodes assigned to presynaptic neurons (<xref ref-type="fig" rid="F5">Fig. 5e</xref>). This analysis preserves the relative abundance of neurons across cortical layers, controlling for the tropism of starter AAVs and potential biases in the transsynaptic spread of rabies virus. It confirmed that starter neurons located in layer 2/3 preferentially received input from other layer 2/3 cells, as well as layer 4 neurons, and were less likely to receive inputs from deep cortical layers.</p><p id="P32">We next analyzed the connectivity matrix from the perspective of presynaptic neurons and computed the layer distribution of starter neurons as a function of presynaptic cell layer (<xref ref-type="fig" rid="F5">Fig. 5f</xref>). As these output fractions are biased by the distribution of starter cells, we used the shuffling procedure described above, which maintains the distribution of starter cells and the number of presynaptic cells per starter, and compared the observed output fractions to the shuffle distribution (<xref ref-type="fig" rid="F5">Fig. 5g</xref>). We found that layers 2/3 and 4 preferentially target layer 2/3 neurons but are less likely to target layer 5. On the other hand, layers 5, 6a, and 6b preferentially target layer 5 and are less likely to project to layers 2/3 and 4. Together with the analysis of input fractions, these results demonstrate that BRISC can identify layer-specific connectivity rules of excitatory neurons.</p><p id="P33">By sequencing the transcripts of cell-type marker genes alongside viral barcodes, BRISC makes it possible to relate input connectivity of individual neurons to their molecular identity. To demonstrate this, we focused on connectivity between GABAergic interneuron cell types in V1. We identified rabies-infected neurons belonging to 4 inhibitory neuron cell types: somatostatin-(<italic>Sst</italic>), parvalbumin-(<italic>Pvalb</italic>), vasointestinal peptide-(<italic>Vip</italic>) and Lysosomal Associated Membrane Protein Family Member 5 (<italic>Lamp5</italic>) expressing neurons (<xref ref-type="bibr" rid="R12">12</xref>) (<xref ref-type="fig" rid="F5">Fig. 5h</xref>). We analyzed the inter-connectivity of these inhibitory cells in the same manner as for excitatory neurons by computing the input fraction onto each interneuron class (<xref ref-type="fig" rid="F5">Fig. 5i-j</xref>). <italic>Pvalb</italic> interneurons were most frequently interconnected, consistent with connectivity measured using multiple patch clamp recordings (<xref ref-type="bibr" rid="R37">37</xref>). <italic>Sst</italic> interneurons received input from <italic>Pvalb</italic> and <italic>Vip</italic> cells, the latter connection representing a well-established disinhibitory circuit motif (<xref ref-type="bibr" rid="R37">37</xref>, <xref ref-type="bibr" rid="R40">40</xref>). Finally, <italic>Lamp5</italic> and <italic>Vip</italic> interneurons received strong inputs from <italic>Sst</italic> and <italic>Pvalb</italic> cells. However, our sample size (3 <italic>Vip</italic> starter cells and 2 <italic>Lamp5</italic> starter cells) is insufficient to make strong conclusions.</p></sec><sec id="S8"><title>Long-range connectivity</title><p id="P34">Previous work has shown that the connections between the primary visual cortex and higher visual areas are topographically organized, linking areas representing the same part of the visual field (<xref ref-type="bibr" rid="R41">41</xref>). Our rabies injections spanned the primary visual cortex along the mediolateral axis, which largely corresponds to the azimuth axis in retinotopic space (<xref ref-type="bibr" rid="R42">42</xref>). Therefore, we analyzed how the spatial location of presynaptic neurons was related to the mediolateral position of their starter cell (<xref ref-type="fig" rid="F6">Fig. 6a-c</xref>). Within V1, presynaptic cells tended to make connections onto starter cells at a similar mediolateral location, consistent with the spatial clustering of presynaptic cells near the starter cell. Consequently, the locations of connected presynaptic and starter cells were positively correlated within V1 (<xref ref-type="fig" rid="F6">Fig. 6e</xref>). However, this relationship did not extend outside of the borders of V1. Instead, this gradient was reversed for presynaptic neurons located in cortical areas lateral to V1, where more laterally located presynaptic neurons were more likely to project to medially located starter cells. This organization reflects the reversal of the azimuth tuning gradient at the lateral boundary of V1 (<xref ref-type="fig" rid="F6">Fig. 6d,f</xref>) (<xref ref-type="bibr" rid="R42">42</xref>, <xref ref-type="bibr" rid="R43">43</xref>).</p></sec></sec><sec id="S9" sec-type="discussion"><title>Discussion</title><p id="P35">Here we describe the development of Barcoded Rabies In Situ Connectomics, BRISC, for high-throughput reconstruction of synaptic connections in the brain. Identification of individual synaptic connections using barcoded rabies viruses relies on unique labeling of starter neurons with distinct barcode sequences, which has been challenging to accomplish to date (<xref ref-type="bibr" rid="R5">5</xref>). To maximize the number of uniquely labeled cells, we generated high-diversity libraries of barcoded rabies viruses that could label &gt;1,000 starter cells while ensuring that &gt;95% of them receive distinct barcodes. The diversity of these libraries surpasses most that have been described previously (<xref ref-type="bibr" rid="R4">4</xref>, <xref ref-type="bibr" rid="R5">5</xref>, <xref ref-type="bibr" rid="R25">25</xref>). Shin et al. has recently described the generation of high complexity rabies virus libraries theoretically capable of uniquely labeling an even larger number of neurons. However, their barcode design consists of a combination of predefined index sequences, which are impractical to read out using <italic>in situ</italic> sequencing, limiting the potential applications of these libraries. Furthermore, sequence homology between these barcodes makes them susceptible to template switching during sequencing library preparation (<xref ref-type="bibr" rid="R45">45</xref>), potentially inflating the estimates of library diversity.</p><p id="P36">Given the diversity of our library, the number of starter cells that can be uniquely labeled is primarily constrained by the probability of barcode transmission between them. Since this probability strongly depends on the density of starter cells (<xref ref-type="fig" rid="F1">Fig. 1g</xref>), we developed a strategy to control the proportion of neurons in the target area that are infected by starter AAVs. This strategy relies on stochastic infection of starter neurons by a blood-brain-barrier permeable AAV expressing Cre recombinase, enabling us to simultaneously map the inputs across many cell types. We detected 385 uniquely labeled starter neurons, identifying 7,814 putative synaptic connections in a single animal, more than an order of magnitude higher throughput than has previously been achieved using barcoded rabies viruses (<xref ref-type="bibr" rid="R5">5</xref>). The resulting connectivity matrix revealed layer- and cell-type-specific connectivity rules of V1 neurons. These rules recapitulate well-established aspects of cortical connectivity, including strong recurrent intralaminar connectivity of layer 2/3 and layer 5 neurons, feed-forward connectivity across layers 4, 2/3, and 5, strong connectivity between <italic>Pvalb</italic>-positive interneurons, and inhibition of <italic>Sst</italic> interneurons by <italic>Vip</italic>-positive cells.</p><p id="P37">By densely sequencing the sections containing the majority of starter neurons, we could identify and eliminate barcodes that were present in more than one starter cell. However, some of the barcodes detected in exactly one starter neuron may have been present in other starter cells that escaped detection due to limitations of sensitivity of <italic>in situ</italic> sequencing or low mCherry expression. Our results suggest that low mCherry expression is associated with low efficiency of barcode transmission, presumably due to low expression of the G glycoprotein. As starter cells in this category are unlikely to transmit their barcodes to a significant number of presynaptic cells, they are unlikely to substantially impact the analysis of BRISC data.</p><p id="P38">The efficiency of BRISC is challenging to estimate due to the lack of ground truth measurements of the number of distinct presynaptic partners of pyramidal neurons. Mouse visual cortex neurons are estimated to have ~2,000 dendritic spines (<xref ref-type="bibr" rid="R46">46</xref>). However, connected pairs of neurons often make multiple synaptic contacts, with light microscopy reconstructions estimating that connected pyramidal neurons on average share ~5 synapses (<xref ref-type="bibr" rid="R47">47</xref>). Together, these figures suggest that visual cortex cells receive synaptic inputs from ~400 distinct presynaptic neurons, although this estimate does not include inhibitory connections. As barcoded rabies tracing labels ~50 presynaptic neurons per starter cell, this likely constitutes ~10% of their presynaptic partners. Our results suggest that increasing the levels of G glycoprotein expression would increase the sensitivity of starter cell detection as well as the number of presynaptic neurons labeled by each starter, enhancing the throughput of BRISC and providing a more comprehensive sample of inputs onto each neuron.</p><p id="P39">By simultaneously reading out connectivity and gene expression patterns of individual neurons, BRISC has the potential to comprehensively characterize cell-type-specific wiring rules. In addition, BRISC makes it possible to correlate gene expression and connectivity at the single-cell level, potentially identifying connectivity rules that do not align with established transcriptomic cell types. The scalability of BRISC enables the application of connectomics to understand neural mechanisms of neurological or psychiatric diseases by analyzing wiring patterns in disease models to identify defects in cell-type-specific wiring rules.</p><p id="P40">As BRISC preserves spatial information, it can be integrated with other imaging modalities, including <italic>in vivo</italic> multi-photon imaging. By registering <italic>in vivo</italic> imaging volumes to <italic>in situ</italic> sequencing cryosections (<xref ref-type="bibr" rid="R28">28</xref>), BRISC could be applied to simultaneously determine functional properties and input connectivity of individual cells at scale, providing ground-truth data to constrain circuit models of cortical computations.</p><p id="P41">BRISC also enables the systematic comparison of connectivity rules across multiple brain areas or experimental subjects. Since BRISC depends entirely on viral vectors and not transgenic animals, it is straightforward to apply to other brain areas and potentially other animal species. This creates new opportunities for the use of comparative connectomics to systematically explore how microcircuit organization differs across the brain and the evolutionary tree.</p></sec><sec id="S10" sec-type="methods" specific-use="web-only"><title>Methods</title><sec id="S11"><title>Animals</title><p id="P42">All animal procedures were conducted in compliance with the guidance and regulations set forth by the UK Home Office according to the Animals Scientific Procedures Act 1986 (PPL PP4882546) and approved by the Animal Welfare Ethical Review Body at the Francis Crick Institute. Male and female C57Bl/6 mice aged between 12 and 15 weeks were used for barcoded rabies experiments. Ai14-tdTomato Cre-responder mice (B6;129S6-Gt(ROSA)26Sor<sup>tm14(CAG-tdTomato)Hze/J</sup>, JAX #007908) were used for AAV-PHP.eB-Cre titration experiments.</p></sec><sec id="S12"><title>Barcoded rabies viral library production</title><sec id="S13"><title>Plasmid library production</title><p id="P43">A CVS-N2c-ΔG-mCherry plasmid (Addgene plasmid # 73464, a gift from Dr Andrew Murray) was used as the basis for producing barcoded rabies libraries. The extended 3’ sequence that is necessary to generate the super-cutter variant of the hepatitis delta virus antigenomic ribozyme (HDVagrz) was introduced into the plasmid using a Q5 site-directed mutagenesis kit (New England Biolabs, E0554S). An oligonucleotide was inserted containing a sequence complementary to the 5’ region of the hepatitis delta virus antigenomic ribozyme, along with 5 extra bases (ACGGA).</p><p id="P44">Barcodes were then inserted into the modified CVS-N2c-ΔG-mCherry plasmid downstream of the mCherry transgene by inverse PCR (<xref ref-type="bibr" rid="R4">4</xref>) using a pair of forward and reverse primers (Bipartite_barcode_F and Bipartite_barcode_R for RV2, Barcode_F and Barcode_R for RV35, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>) comprising a 5’ tail of six protective bases flanking an EagI restriction site, a genome complementary 3’ sequence, and random nucleotides forming the barcode (10 bases in both primers for RV2, 20 bases in the forward primer only for RV35). These random nucleotides were incorporated using IDT’s “hand-mixed” option at a final ratio of N(25:25:25:25) to account for differences in coupling rates of each nucleotide. To produce large amounts of linear barcoded plasmid DNA, PCR was performed in a 96-well PCR plate with 25 µl per well. This mix was comprised of 1,250 µl Q5 Hot Start High-Fidelity 2X Master Mix, 125 µl forward primer (10 µM), 125 µl reverse primer (10 µM), 500 µl template plasmid (supercutter CVS-N2c-ΔG-mCherry, 0.4 ng/µl) and 500 µl molecular grade water. The following thermocycling conditions were used to generate the linear plasmid constructs with EagI 5’ and 3’ ends: 98 °C - 30 s, 35 cycles of 98 °C for 10 s, 72 °C for 30 s, 72 °C for 450 s, followed by 72 °C for 2 mins and 4 °C hold.</p><p id="P45">To size-select the resultant linear products, the PCR reaction was loaded on an agarose gel, and gel extraction was performed with a Wizard SV Gel and PCR Clean-Up kit (Promega, A9281). Secondary purification was then carried out with DNA Clean &amp; Concentrator-5 columns (Zymo Research, D4004). Typically, around 20 µg of linear DNA was recovered from a single 96-well plate.</p><p id="P46">The purified PCR product was then digested at 37 °C for 1 hour to expose sticky ends for ligation with the following reaction mix: 0.5 µl EagI-HF (New England Biolabs, R3505L), 0.25 µl DpnI (New England Biolabs, R0176L), 500 ng linear barcoded DNA, 5 µl CutSmart buffer (New England Biolabs, B6004S) and molecular-grade water up to 50 µl. Heat inactivation was then carried out at 80 °C for 20 minutes. The sticky-ended products were then ligated into open-circular plasmids by adding T4 ligase (New England Biolabs, M0202T) and ATP (Thermo Fisher Scientific, PV3227) to the reaction mix at a ratio of 0.1 µl ligase and 5 µl ATP per 44.9 µl of sticky-ended product and incubating at 4 °C for 2 hours, followed by heat inactivation at 65 °C for 20 minutes. Residual linear DNA was then digested by adding Exonuclease V (New England Biolabs, M0345S) to the reaction mix (1 µl ExoV, 1.4 µl NEBuffer4 (New England Biolabs, B7004S) and 6.4 µl ATP) and incubating at 37 °C for 1 hour, followed by heat inactivation at 70 °C for 30 minutes. The resulting product was purified using DNA Clean &amp; Concentrator-5 columns.</p><p id="P47">Barcoded open circular plasmids were transformed into MegaX DH10B T1R Electrocompetent cells (Thermo Fisher Scientific, C640003) to amplify and supercoil them for mammalian transfection. 40 µl of electrocompetent cells were mixed with 400 ng of circularized DNA per cuvette, added to pre-chilled electroporation cuvettes on ice (BIO-RAD, 1652082), and immediately electroporated at 2.0 kV, 200 Ω, 25 µF using a GenePulser XCell (BIO-RAD, 1652662). 1 ml of pre-warmed SOC media was then added to each cuvette and placed in a round-bottomed tube in a shaking incubator for 1 hour at 37 °C. All samples were then pooled, diluted to 20 ml with LB broth, and then 2 ml was spread evenly across each of 10 prewarmed LB Carbenicillin (100 µg/ml) 245 mm Square BioAssay plates (Corning, 431111). The plates were incubated overnight at 30 °C, and then all colonies were scraped from the plates. The bacteria were centrifuged to collect a pellet. ZymoPURE II maxiprep kits (Zymo Research, D4202) were used to extract endotoxin-free plasmid DNA.</p></sec><sec id="S14"><title>Rabies packaging and pseudotyping</title><p id="P48">Initial viral rescue attempts resulted in the RV2 library (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 1a,b</xref>). Rescue from barcoded plasmids was carried out in 2 x 10 cm plates of HEK293T cells transfected with 7 µg barcoded rabies genome plasmid, 6 µg pCAG-T7-polymerase, 12 µg pCAG-N2c N, 6 µg pCAG-N2c P, 6 µg pCAG-N2c L, and 6 µg pCAG-N2c G plasmids in 1000 µl of Opti-MEM with 130 µl PEI MAX (1 mg/ml), mixed and incubated for 20 minutes before adding to the cells. The following day, the media was exchanged with fresh DMEM / 10% FBS. At 7 days post-transfection, cells were split in DMEM / 10% FBS at a ratio of 1:3.3 into 2 x 10 cm plates and 2 x 15 cm plates. At 8 days post-transfection, the cells were re-transfected with 40 µg pCAG-N2c-G in 2000 µl of Opti-MEM and 120 µl PEI MAX (1 mg/ml). This was added to the cells and incubated for 6-8 hours before replacing with fresh DMEM / 10% FBS media. At 17 days post-transfection, the supernatant from the HEK293T plates was transferred to 2 x 15 cm dishes of BHK-EnvA cells, seeded at a density of 1 x 10<sup>7</sup> cells per dish for pseudotyping. Cells were trypsinized and replated with fresh media after 6 hours to remove residual G-coated virus. At 21 days post-transfection, the supernatant was collected, filtered through a 0.45 µm filter, and centrifuged at 50,000 g for 2 hours at 4 °C. Pellets were resuspended in 300 µl PBS, and the viral titer was determined by applying serial dilutions of rabies virus to HEK293T-EnvA (<xref ref-type="bibr" rid="R48">48</xref>) and HEK293T cells, counting mCherry+ cells.</p><p id="P49">We then optimized the rescue protocol to increase library diversity, generating library RV35. Specifically, we used a stable cell line expressing the N2c-glycoprotein (HEK293TG) to perform initial viral rescue and decreased the duration of viral amplification steps to reduce clonal amplification biases. To generate HEK293TG cells, HEK293T cells were transduced with a 3rd generation EF1a-N2cG-puromycin lentiviral vector containing the rabies glycoprotein gene flanked by long terminal repeat sequences for integration into the genome. Lentiviruses were produced by mixing a pEF1a-N2cG-IRES-Puro transfer plasmid (8.3 µg) with packaging and envelope plasmids (pLP1-9.6 µg, pLP2-9.0 µg, VSV-G-6.4 µg) to transfect 2 × 10<sup>7</sup> HEK293T cells in a 15-cm culture dish with 100 µl Lipofectamine 2000 (Invitrogen, 11668019). Viral supernatants were collected and filtered at 2 and 3 days post-transfection, before being pooled and concentrated with a solution of 10% w/v PEG-8,000 (Merck, 81268) and NaCl (88 mM). Aliquots of lentivirus particles were titered by ddPCR (<xref ref-type="bibr" rid="R49">49</xref>). HEK293T cells were then transduced with lentivirus at an MOI of 0.3. After 48 hours, cells were maintained in media containing 2 µg/ml of puromycin (Sigma, P9620) until single colonies were isolated to select for cells that stably expressed the glycoprotein transgene. This was confirmed by infecting clonal colonies with glycoprotein-coated CVS-N2c-(ΔG)-mCherry rabies virus at low MOI. After several days, supernatant was taken from the wells and added to fresh HEK293T cells. Observation of mCherry fluorescence in the HEK293T cells was used to confirm successful packaging of glycoprotein-coated rabies virus.</p><p id="P50">HEK293TG cells were transfected with the barcoded rabies genome plasmid along with plasmids containing the rabies genes N, P, L and G, as well as T7 polymerase. Six-well dishes were first seeded with HEK293TG cells at a density of 6 x 10<sup>5</sup> cells/well in DMEM / 5% fetal bovine serum (FBS). The transfection mix was prepared containing 6 µg pTIT-N, 3 µg pTIT-L, 5 µg pTIT-P, 6 µg pTIT-G, 8.5 µg pCAGGS T7 and 12 µg barcoded plasmid library in 430 µl of Opti-MEM. Then, 85 µl of PEI MAX (1 mg/ml) was added to the mix, incubated at room temperature for 20 minutes, and 80 µl of this was added to each well. The following day, the media was exchanged with fresh DMEM / 10% FBS. Three days after transfection, the cells were split in DMEM / 10% FBS at a ratio of four wells to a T175 flask. When cells reached 70% confluency (6-7 days post-transfection), they were transfected with the glycoprotein plasmid in the following transfection mix: 13 µg CMV-RG, 1 ml Opti-MEM, 40 µl of PEI MAX (1 mg/ml). This was added to the cells and incubated for 6-8 hours before replacing with fresh DMEM / 10% FBS media. Supernatant was collected 9-10 days after the initial transfection and filtered through 0.45 µm filters. The supernatant was titered by serial dilution onto HEK293TG cells in 6-well plates, with a typical titer of 1 x 10<sup>7</sup>.</p><p id="P51">This supernatant was then used to infect BHK cells stably expressing the EnvA coat protein (BHK-EnvA-GFP, (<xref ref-type="bibr" rid="R48">48</xref>)) for pseudotyping. BHK-EnvA cells were seeded in 150 mm dishes at a density of 1 x 10<sup>7</sup> cells per dish in DMEM / 10% FBS. Supernatant containing barcoded G-coated rabies virus was added to each dish at an MOI of 0.3. The cells were incubated with supernatant for 6-8 hours and then washed with PBS four times, then split and replated in DMEM / 5% FBS at a ratio of 1:3. Supernatant containing EnvA-pseudotyped virus was collected and filtered through 0.45 µm filters 2 days after infection and fresh DMEM / 10% FBS was added to the plates. The supernatant was centrifuged at 70,000 g in an SW32.1 rotor for 2 hours at 4 °C and the viral pellets were resuspended in approximately 250 µl PBS. This was repeated 3 days after infection. The titer of the concentrated viral prep was determined by applying serial dilutions of the virus to HEK293T-EnvA (<xref ref-type="bibr" rid="R48">48</xref>) and HEK293T cells to quantify pseudotyped and glycoprotein-coated viral titers, respectively.</p></sec><sec id="S15"><title>Barcoded library sequencing</title><p id="P52">The diversity of the barcoded plasmid and viral libraries was quantified using a unique molecular identifier (UMI) tagging approach. For viral libraries, viral genomic RNA was extracted using the Quick DNA/RNA Viral Kit (Zymo Research, D7020) and eluted into 15 µl of RNase-free water. Purified viral barcode RNA was then reverse transcribed using Superscript IV reverse transcriptase (Thermo Fisher Scientific, 18090050) at 50 °C for 10 minutes with 1 µl of 2 µM UMI_P5_Truseq primer (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>), before heat inactivation at 80 °C for 10 minutes. RNA was subsequently digested with RNase H (New England Biolabs, M0297S) at 37 °C for 20 minutes. The primer used for reverse transcription (UMI_P5_Truseq, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>) contained a 5’ 22 bp region of the P5 Truseq sequence for nested adaptor PCR, a 12 bp random UMI sequence and 20 bp of rabies homologous sequence for binding upstream of the barcode.</p><p id="P53">The same UMI-P5-Truseq primer was used to produce UMI-tagged amplicons from the barcoded plasmid libraries in a two-cycle limited PCR reaction. Barcoded plasmid (5 ng) was added to 16 µl Q5 Hot Start High-Fidelity 2X Master Mix (New England Biolabs, M0494S) with 1.25 µl each of UMI_P5_Truseq and P7_universal_reverse primers (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>) and PCR thermocycled with the following conditions: 98 °C - 3 mins, two cycles of 98 °C - 30 s, 67 °C - 20 s, 72 °C - 30 s, followed by 72 °C - 2 mins and 12 °C hold.</p><p id="P54">The resultant cDNA from the viral samples or amplicons from barcoded plasmids was size-selected and purified using KAPA Pure Beads (Roche, KK8000) in a 1:1 ratio, eluting in 25 µl of RNase-free water. To determine the optimal cycle number for library amplification, the amplification curve inflection point was determined for each sample by qPCR. 2.5 µl of each sample was added to a master mix of 1 µl 2.5X Thiazole Green (Biotium, 40086), 1 µl 2.5X ROX reference dye (Thermo Fisher Scientific, 12223-012), 12.5 µl Q5 Hot Start High-Fidelity 2X Master Mix (New England Biolabs, M0494S), 1.25 µl 10 µM IDT_i7_1 primer (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>) for plasmid amplicons or P7_universal_reverse for viral single-stranded cDNA, 1.25 µl 10 µM IDT_i5_1 primer and 5.5 µl of molecular grade water. The following thermocycler conditions were used: 98 °C - 3 mins, followed by 40 cycles of 98 °C - 10 s, 68 °C - 20 s, 72 °C - 30 s.</p><p id="P55">Subsequently, the remaining 22.5 µl of each sample was added to a mix of 25 µl Q5 Hot Start High-Fidelity 2X Master Mix, 2.5 µl 10 µM IDT_i7_1-10 primer for plasmid amplicons/P7_universal_reverse for viral single-stranded cDNA, and 2.5 µl 10 µM IDT_i5_1-10 primer. The IDT_i5_X and IDT_i7_X primers each contain 8 bp index sequences derived from the rhAmpSeq index primer set (Integrated DNA Technologies) for dual-index demultiplexing alongside the Illumina P5 and P7 adapter sequences, respectively. Thermocycling conditions for this Illumina adaptor PCR were: 98 °C - 3 mins followed by cycles of 98 °C - 10 s, 68 °C - 20 s, 72 °C - 30 s, then 72 °C - 2 mins. The number of cycles was equal to the qPCR inflection point, less 3 cycles to account for the 10X (~2<sup>3</sup>) increase in target concentration.</p><p id="P56">For viral amplicons, the P7-indexed adaptor sequences were added in a final PCR step. The UMI-tagged viral amplicons were first gel-purified with a Wizard SV Gel and PCR Clean-Up kit (Promega, A9281) and eluted with 20 µl water. Then, the same PCR mix was used as described above for the barcoded plasmid index PCR, adding the IDT_i7_X primer and the matching IDT_i5_X for each sample. Thermocycling conditions were likewise the same as the Illumina adaptor PCR, but with a fixed number of 3 cycles.</p><p id="P57">The indexed viral and plasmid amplicons were then gel-purified with a Wizard SV Gel and PCR Clean-Up kit (Promega, A9281) and eluted with 25 µl water. The concentration and size distribution of these amplicon libraries were quantified with a High Sensitivity D1000 ScreenTape kit (Agilent, 5067-5584) on an Agilent 2200 TapeStation system. Samples passing QC were sequenced on an Illumina NovaSeq 6000/NovaSeq X using Illumina TruSeq primers for paired-end 100 bp sequencing at a depth of 10-50 million reads per sample.</p></sec><sec id="S16"><title>Quantification of barcoded library diversity</title><p id="P58">To analyze sequenced libraries, low-quality reads were first removed from raw demultiplexed.fastq files with Trimmomatic 0.36, removing reads with an average PHRED score per base of less than 20 in a 6-base sliding window and removing any reads with a length of less than 101 bp. The sequences flanking the barcode site were then matched to their expected sequences, and any mismatched sequences were discarded to remove frameshifts. Next, the UMI sequences were used to de-duplicate the remaining barcode sequence reads to account for PCR amplification bias. The remaining sequences represented individual species of barcode RNA/DNA found in the viral or plasmid samples. To account for sequencing errors and PCR-induced mutations that may be present in some of these sequences, closely related barcodes were collapsed into their most abundant “parent" sequences using a method adapted from Kebschull et al. (<xref ref-type="bibr" rid="R50">50</xref>). First, barcode sequences were aligned to all other barcodes in the library with a maximum hamming distance of 2 using Bowtie2 (2.5.1-GCC-12.3.0, (<xref ref-type="bibr" rid="R51">51</xref>)). Related sequences were then collapsed onto the barcode with the highest UMI count, summing together all of the counts. Previously published barcode library data (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 1a,b</xref>) was acquired from deposited data sources: GSM4519333 (<xref ref-type="bibr" rid="R25">25</xref>), Source Data 1f 170330_pSPBN_GFP_B19EnvA (<xref ref-type="bibr" rid="R4">4</xref>), SRR23310757 (<xref ref-type="bibr" rid="R5">5</xref>), and GSM8524116/ GSM8524119 (<xref ref-type="bibr" rid="R7">7</xref>).</p></sec></sec><sec id="S17"><title>Surgical procedures</title><p id="P59">For barcoded rabies tracing experiments, Metacam (33 mg/l) was provided via drinking water before and for 3 days following surgery as peri- and post-operative analgesia. Prior to anesthesia, 50 µl AAV-PHP.eB-Syn-Cre (4.5 x 10<sup>13</sup> vg/ml) diluted 1:330 in filter-sterilized PBS was administered via tail vein injection. Anesthesia was then induced and maintained with 1.5–3% isoflurane, and mice received subcutaneous injections of buprenorphine (0.1 mg/kg). Mice were then secured in a stereotactic frame, and a small craniotomy was created at the site of the injection. Virus injections were performed using a Nanoject III injector at rates not exceeding 14 nl/min. Helper viruses FLEX-H2B-mCherry-P2A-N2cG (3.1 x 10<sup>13</sup> vg/ml) and AAV1-FLEX-H2B-EBFP2-P2A-TVA (1.8 x 10<sup>13</sup> vg/ml), diluted in sterile PBS to 1:20 and 1:100 respectively, were delivered at three injection sites at -3.5 mm from Bregma and 3.0, 2.4 and 1.8 mm from midline in the left hemisphere, 300 and 500 µm below brain surface (60 nl per depth). Thirteen days later, barcoded CVS-N2c-mCherry (6.0 x 10<sup>8</sup> IFU/ml) was injected at the same coordinates (500 nl per depth). Seven days later, mice were euthanized via intraperitoneal injection of sodium pentobarbital (600 mg/kg). Brains were extracted and rapidly frozen in OCT compound-filled cryomolds using a bath of absolute ethanol and dry ice, and stored at -80°C.</p><p id="P60">TVA leak and rabies glycoprotein-coated contamination control experiments (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 5</xref>) followed the above protocol but excluded tail vein injections and omitted either FLEX-H2B-mCherry-P2A-N2cG or both helper viruses, respectively. Seven days after rabies injection, mice were terminally anesthetized with sodium pentobarbital (600 mg/kg) and then perfused with ice-cold PBS, followed by 4% paraformaldehyde in PBS. Brains were then post-fixed overnight in 4% paraformaldehyde before imaging.</p><p id="P61">For AAV-PHP.eB-Cre titration experiments (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 1c</xref>), Ai14 mice (B6;129S6-Gt(ROSA)26Sor<sup>tm14(CAG-tdTomato)Hze/J</sup>, JAX #007908) received 50 µl tail vein injections of AAV-PHP.eB-Syn-Cre (4.5 x 10<sup>13</sup> vg/ml) at 1:100, 1:330, 1:1,000, or 1:3,300 dilution in sterile PBS. Two weeks after tail vein injections, mice were terminally anesthetized with sodium pentobarbital, perfused and fixed as above.</p><p id="P62">For quantification of barcoded rabies spread using serial two-photon tomography (<xref ref-type="fig" rid="F1">Fig. 1h-j</xref>), the procedure for barcoded rabies sequencing surgeries was also performed as described above with the following differences: a single local injection of AAV1-hSyn-Cre (7.6 x 10<sup>13</sup> vg/ml) diluted 1:5000 in sterile PBS was combined with the helper viruses diluted as above and injected at coordinates of 3.5 mm AP, 2.5 mm ML, 300 and 500 µm below brain surface (60 nl per depth). Seven days later, a pair of 500 nl injections of barcoded RV2 CVS-N2c-mCherry (2.8 x 10<sup>7</sup> IFU/ml) were administered at the same stereotactic coordinates. After seven more days, mice were euthanized, perfused and fixed as detailed above.</p><p id="P63">For quantification of the spatial distribution of starter neurons in intracerbral/intravenous injections of AAV-Cre (<xref ref-type="fig" rid="F1">Fig. 1k-m</xref>), the procedure for barcoded rabies sequencing surgeries was also performed as described above with the following differences: wild-type mice received either a 50 µl tail vein injection of AAV-PHP.eB-Syn-Cre (4.5 x 10<sup>13</sup> vg/ml) at 1:330 dilution in sterile PBS (intravenous), or a single local injection of AAV1-hSyn-Cre (7.6 x 10<sup>13</sup> vg/ml) diluted 1:5000 in sterile PBS (intracerebral) at coordinates of 3.8 mm AP, 2.4 mm ML 300 and 500 µm below brain surface (60 nl per depth). For both conditions, AAV FLEX-H2B-mCherry-P2A-N2cG (3.1 x 10<sup>13</sup> vg/ml), diluted in sterile PBS to 1:20 was also injected at the same location on the same day. After 14 more days, mice were euthanized, perfused and fixed as detailed above.</p></sec><sec id="S18"><title>Serial section two-photon tomography</title><p id="P64">To quantify the spread of barcoded rabies virus and determine the optimal parameters for AAV1-hSyn-Cre injections, PFA-fixed brains were imaged using a serial sectioning two-photon microscope (<xref ref-type="bibr" rid="R52">52</xref>, <xref ref-type="bibr" rid="R53">53</xref>). Sections were imaged in a bath of 50 mM pH 7.4 phosphate buffer. The microscope was controlled by ScanImage Basic (MBF Bioscience), using the custom software wrapper BakingTray to control imaging parameters (<xref ref-type="bibr" rid="R54">54</xref>). Image tiles were assembled by StitchIt (<xref ref-type="bibr" rid="R55">55</xref>). To quantify AAV PHP.eB Cre-positive cells, images were acquired at an XY resolution of 1 or 2 µm with optical sectioning intervals of 5 or 8 µm and vibratome sections at 40 µm intervals. Cell detection throughout the brain was performed either using Cellfinder (<xref ref-type="bibr" rid="R56">56</xref>) (<xref ref-type="fig" rid="F1">Fig. 1h,j</xref>, <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4b</xref>) or manually using napari (<xref ref-type="fig" rid="F1">Fig. 1l,m</xref>, <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 5</xref>).</p><p id="P65">As nuclear fluorescence of starter cells could not be detected from the serial section two-photon tomography dataset directly, the slices were collected, counterstained with DAPI and imaged on a confocal microscope (LSM 880, Zeiss) with voxels of 0.2 x 0.2 x 1.6 µm. Starter cells were manually identified from their brighter nuclear H2B-mCherry signal compared to the cytoplasmic rabies mCherry expression. To display both the high-intensity nuclear staining and fainter cytoplasmic fluorescence (<xref ref-type="fig" rid="F1">Fig. 1i</xref>), RGB images were formed by collating the DAPI channel (in blue) with the mCherry data duplicated in both the red and green channels with different contrast limits (1,000 and 10,000 gray values, respectively).</p></sec><sec id="S19"><title><italic>In situ</italic> sequencing</title><sec id="S20"><title>Primer and padlock design</title><p id="P66">Cell type marker genes were selected using SMART-Seq2 RNA expression data from neurons in the mouse visual cortex (<xref ref-type="bibr" rid="R12">12</xref>) as a reference. Candidate genes were selected by first filtering to remove genes with low mean expression. Then, a modified version of a greedy combinatorial search algorithm (<xref ref-type="bibr" rid="R57">57</xref>) was used to iteratively select the top 80 genes that maximized classification accuracy across the reference cell type clusters. Additional sixteen genes were then manually added to the genes selected by the greedy algorithm, including established visual cortex cell type marker genes (<italic>Chodl, Cux2, Fezf2, Foxp2, Rorb, Vip</italic>), additional marker genes that are differentially expressed in cell types where the canonical marker is downregulated by rabies infection (<xref ref-type="bibr" rid="R58">58</xref>) (L5 NP - <italic>Tshz2</italic>, Sst - <italic>Grin3a</italic> / <italic>Reln</italic>), and additional markers to improve the classification of neurons within clusters (L2/3 IT neurons - <italic>Rrad</italic>), or between subclasses (L5 IT/PT/NP - <italic>Etv1, Tle4</italic>, L6 IT/CT - <italic>Rasl10a, Hs3st4</italic>, Vip/Sst - <italic>Grik1, Sorcs3</italic>).</p><p id="P67">Multiple padlock probes were designed for each target gene (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 3</xref>). The number of probes designed for a given gene was calculated based on the expression level of each gene relative to <italic>Sst</italic> in a reference V1 SMARTseq scRNAseq dataset (<xref ref-type="bibr" rid="R12">12</xref>): <disp-formula id="FD1"><label>(1)</label><mml:math id="M1"><mml:mrow><mml:mi>N</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>X</mml:mi><mml:mrow><mml:mi>S</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>X</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>g</mml:mi><mml:mi>e</mml:mi><mml:mi>t</mml:mi><mml:mspace width="0.2em"/></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>×</mml:mo><mml:mn>4</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P68">where <italic>N</italic> is the number of padlock probes, <italic>X</italic><sub><italic>Sst</italic></sub> is the mean expression of the <italic>Sst</italic> gene from all cells in the <italic>Sst</italic> cell type subclass, and <italic>X</italic><sub><italic>target</italic></sub> is the mean expression of the target gene in its highest expressing cluster in the reference scRNAseq dataset. This was limited to an upper bound of 12 padlocks per gene and a lower bound of 4 padlocks per gene. Padlock sequences were generated using a modified version of the Multi padlock design tool (<xref ref-type="bibr" rid="R57">57</xref>). Briefly, for each target gene, the tool determined the consensus sequence from all transcript variants in the mouse RefSeq transcriptome and tested every possible binding sequence in a sliding window along the transcript. Candidate binding sequences consist of two adjacent padlock arm regions (20 bp per arm). The arms of each candidate sequence were filtered to be within a defined melting temperature range (60 - 75°C after formamide-containing hybridization buffer correction, melting temperature calculated assuming 0.1 µM probe, 0.075 M Na<sup>+</sup>, 0.01 M Mg<sup>2+</sup> and 20% formamide). The specificity of each candidate sequence was then tested with a BLAST search against the whole mouse transcriptome to ensure padlocks do not exhibit non-specific binding. A 4-base pair minimum distance between padlock candidates was also specified to avoid steric hindrance of bound padlocks.</p><p id="P69">All padlocks had a conserved backbone sequence containing a shared sequencing primer binding site directly upstream of a 7-base gene barcode, unique to each gene. Gene barcodes were selected from a pool of previously designed “GII codes" (<xref ref-type="bibr" rid="R27">27</xref>) with a minimum hamming distance of 2 between each barcode. Padlock probes for the highly expressed genes <italic>Slc17a7, Gad1, Sst</italic> and <italic>Vip</italic> contained unique binding sites in place of the sequencing primer site to allow for direct readout of these genes with fluorophore-conjugated hybridization probes separately from the sequencing rounds of the other genes. Padlocks were obtained from IDT as 4 nM ultramer sequences with 5’ phosphorylation.</p><p id="P70">A reverse transcription primer was designed for each padlock by taking the reverse complement of the 5’ arm of each padlock (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 3</xref>). Reverse transcription primers were obtained from IDT as standard desalted oligonucleotides.</p></sec><sec id="S21"><title>Brain cryosectioning</title><p id="P71">Serial sections were cut at 20 µm thickness with MX35 Ultra disposable microtome blades (Epredia, 3053835) at -13 °C specimen temperature / -15 °C chamber temperature using a Bright OTF5000 cryostat (Bright Instruments, R080) and mounted onto poly-l-lysine coated 25 x 75 mm #1.5H coverslips. Ten sections were mounted per coverslip and then stored at -80 °C.</p></sec><sec id="S22"><title>Flowcell assembly and tissue preparation</title><p id="P72">Flowcells were assembled from 26 x 76 mm microscope slides with pre-drilled 1 mm holes placed at each end for fluid flow. Ports were cast from polydimethylsiloxane, punched with 1.5 mm holes and plasma bonded over the holes drilled in the microscope slides. A laser-cut 140 µm-thick adhesive gasket (Grace Biolabs) was mounted on the other side of the microscope slide.</p><p id="P73">The protocol for <italic>in situ</italic> reverse transcription and amplification of transcripts from tissue was adapted, combining elements of BARseq2 (<xref ref-type="bibr" rid="R27">27</xref>) and coppaFISH (<xref ref-type="bibr" rid="R28">28</xref>). Coverslips with cryosections were removed from 80 °C and immediately immersed in 4% PFA in PBS for 30 minutes. They were then immersed in PBS to wash and then washed twice in PBST (PBS with 0.5% Tween20 (Sigma Aldrich, P1379)). Next, they were immersed in a series of ethanol solutions, incubating for 5 minutes each in 70%, 85% and 100% ethanol at room temperature. The coverslips were transferred to fresh Falcon tubes containing 100% ethanol and stored overnight at 4°C. The following day, the coverslips were removed from the ethanol, and once dried, each flowcell was assembled by pressing the coverslip onto the adhesive gasket backed with the microscope slide to form an enclosed chamber. Assembled flowcells had a volume of 180 µl and were washed with PBST three times to rehydrate the tissue and remove any bubbles from within the flowcell.</p></sec><sec id="S23"><title>Reverse transcription</title><p id="P74">A reverse transcription mix was then added to each flowcell. The mix contained pooled gene-specific reverse transcription primers (60 nM per primer), 1 µM rabies barcode reverse transcription primer (RTAB0067, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 3</xref>), 1 U/µl RiboLock RNase Inhibitor (Thermo Fisher Scientific, EO0381), 0.2 µg/µl non-acetylated BSA (Thermo Fisher Scientific, AM2616), 0.5 mM dNTP (Thermo Fisher Scientific, R0192), 20 U/µl SuperScript IV reverse transcriptase (Thermo Fisher Scientific, 18090200), 5 mM DTT (Thermo Scientific, 707265) in 1X SuperScript IV buffer. Samples were incubated at 45°C overnight in a humidified chamber to reduce evaporation.</p></sec><sec id="S24"><title>Padlock ligation</title><p id="P75">The following day, samples were washed in PBST once and the cDNA from reverse transcription was crosslinked by incubating the samples in 4% PFA in PBS for 30 minutes at room temperature. Samples were then washed in PBST twice to remove excess PFA. RNA template digestion, padlock hybridization to cDNA and padlock ligation were carried out in the same reaction. First, a gene padlock ligation mix was added to the samples, containing pooled gene padlocks (60 nM of each padlock, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 3</xref>), 0.4U/µl RNaseH (New England Biolabs, M0297L), 20% Formamide, 50 mM KCl, 0.5U/µl Ampligase (Lucigen, A0102K) in 1X Ampligase buffer. Samples were incubated for 40 minutes at 37°C, followed by 1 hour at 45°C. Then, the gap-filling/ligation mix containing 1 µM rabies barcode padlock (OAB0973), 0.4U/µl RNaseH (New England Biolabs, M0297L), 20% Formamide, 50 mM KCl, 0.25 µg/µl non-acetylated BSA (Thermo Fisher Scientific, AM2616), 50 µM dNTP (Thermo Fisher Scientific, R0192), 5% glycerol, 0.001U/µl Phusion polymerase (Thermo Fisher Scientific, F530L), 0.5U/µl Ampligase (Lucigen, A0102K) in 1X Ampligase buffer was added to the samples. The samples were incubated in the gap-filling reaction mix for 5 minutes at 37°C, followed by 40 minutes at 45°C. The samples were then washed twice in PBST and once in hybridization mix (10% Triton X-100 (ThermoFisher, BP151), 2X SSC in water).</p></sec><sec id="S25"><title>Rolling circle amplification</title><p id="P76">The rolling circle amplification (RCA) primer mix (1 µM each of PAB0010, 12, 13, 22, 33, 35, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 2</xref>) was then hybridized at room temperature for 15 minutes. The samples were washed twice in hybridization mix for 2 minutes each and once in PBST. The RCA mix containing 0.25 µg/µl non-acetylated BSA (Thermo Fisher Scientific, AM2616), 250 µM dNTP (Thermo Fisher Scientific, R0192), 125 µM 5-(3-Aminoallyl)-dUTP (Thermo Fisher Scientific, AM8439), 5% glycerol, 0.2U/µl EquiPhi29 DNA polymerase (Thermo Fisher Scientific, A39391) in 1X EquiPhi29 buffer was added to the samples and incubated overnight at 30°C in humidified chambers. The following day, samples were washed once in PBST and crosslinked with 50 mM BS(PEG)9 (Thermo Fisher Scientific, 21582) in PBS for 1 hour. Excess BS(PEG)9 was quenched by washing the samples twice with 1 M Tris-HCl pH 8.0 buffer and then incubating at room temperature for 30 minutes. The samples were then washed in PBST.</p></sec><sec id="S26"><title>Image acquisition</title><p id="P77">All tissue imaging was performed using a Nikon Ti2-E inverted microscope, equipped with a PZ-2000 XYZ piezo stage (Applied Scientific Instrumentation) and a Cairn MultiCam beamsplitter and CellCam Kikker 100MT cameras (Cairn Research) using a multibandpass main dichroic and three beamsplitter dichroics to achieve simultaneous collection of four emission channels (see <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 2a</xref> for a list of filters). Fast Z-stack acquisition was achieved using TTL triggering from the exposure out signal of one of the cameras. A 20x 0.8 NA Lambda-D air objective was used for all imaging, with illumination provided by a CoolLED pE-4000 light source. Images were captured with 0.231 µm pixel size in 23-plane Z-stacks with 1 µm spacing and tile overlap of 10%. Microscope hardware was controlled using Micromanager as a GUI interface (<xref ref-type="bibr" rid="R59">59</xref>), using Pycromanager (<xref ref-type="bibr" rid="R60">60</xref>) to automate the simultaneous acquisition of multiple flowcells.</p></sec><sec id="S27"><title>mCherry imaging and photobleaching</title><p id="P78">The samples were first imaged to detect the fluorescence of mCherry-positive starter neurons using 500 nm excitation light and the same Chroma ZT405/514/635rpc dichroic and Chroma ET590/33m and Chroma ET546/22x emission filters used for sequencing rounds. After imaging, the samples were placed on an aluminum block under a white-light 10,000-lumen LED floodlamp (NATPOW, TS-F42100) overnight to photobleach the mCherry signal to avoid crosstalk with fluorophores during sequencing. A desk fan (Sealey, SFF-04) was used to maintain a consistent sample temperature of under 35°C during photobleaching.</p></sec><sec id="S28"><title>Sequencing cell type marker gene transcripts</title><p id="P79">After mCherry imaging, the samples were equilibrated in hybridization mix and 1 µM LNA endogenous gene sequencing primer (PAB0032, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 2</xref>) in hybridization mix was added to the sample and incubated at room temperature for 1 hour. Excess sequencing primer was removed with three washes of hybridization mix at room temperature for two minutes each. The samples were then washed twice in PBST before proceeding to sequencing. Sequencing was performed manually by pipetting Illumina reagents into the flowcells, placing them in a hybridization oven for incubation at 60°C and then aspirating the solution using a vacuum pump. The samples were cooled to room temperature each round before imaging to prevent fluctuations in focus from the infrared-based “Perfect Focus System" of the microscope. The sequencing reagents (HB2, IRM, CRM, and USM) were sourced from HiSeq SBS v4 kits (Illumina, FC-410-1003) or MiSeq Reagent v3 kits (Illumina, MS-102-3003).</p><p id="P80">For the first cycle of sequencing chemistry, the flowcell was washed twice with 200 µl HB2 buffer (3 min at 60 °C each). Residual thiols were then blocked with 2 × 200 µl iodoacetamide solution incubations (9.3 mg in 2 ml PBST; 3 min at 60 °C). The flowcell was washed once with 200 µl PBST, then washed twice more with 200 µl HB2, all at room temperature. Sequencing was then initiated by introducing 2 × 200 µl IRM (3 min at 60 °C each). Unincorporated dye-conjugated nucleotides were removed with 4 × 200 µl PBST washes (3 min at 60 °C each). Finally, 200 µl USM was applied to reduce photobleaching, and the flowcell was imaged.</p><p id="P81">Between sequencing cycles, the flowcell was washed with 3 × 200 µl HB2 at room temperature, followed by 2 × 200 µl CRM incubations (3 min at 60 °C each) to cleave the nucleotide terminator groups. The chemistry steps described for the first cycle were then repeated. In total, seven sequencing cycles were completed to read out the entire gene-padlock barcode, using the same wash and incubation parameters at every step.</p></sec><sec id="S29"><title>Rabies barcode sequencing</title><p id="P82">Sequencing of the rabies barcodes took place after the endogenous gene sequencing rounds were complete. The flowcells were washed twice with a stripping buffer of 60% Formamide in 2X SSC buffer at 60°C for 15 minutes to remove the extended gene sequencing primer. The samples were then equilibrated in hybridization mix and 1 µM rabies barcode sequencing primer (PAB0034, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 2</xref>) in hybridization mix was added to the samples and incubated at room temperature for 1 hour. Excess sequencing primer was removed with three washes of hybridization mix at room temperature for two minutes each. The samples were then washed twice in PBST before proceeding to sequencing. The same sequencing procedure was carried out as for cell type marker genes, completing 14 rounds of sequencing. As 10 rounds were sufficient to identify unique barcodes (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 3</xref>) and the error rate of <italic>in situ</italic> sequencing increases over rounds, only the first 10 rounds were included in the analysis.</p></sec><sec id="S30"><title>Hybridization rounds for highly expressed genes</title><p id="P83">The extended barcode sequencing primers were stripped from the samples as described above to prepare them for hybridization probe imaging. The samples were then equilibrated in the hybridization mix, and 1 µM each of a set of hybridization probes with 5’ conjugated fluorophores were hybridized to the samples in two extra rounds. Each round followed the same hybridization and stripping procedure as for the sequencing primers. First, probes designed against the highly-expressed gene padlocks <italic>Slc17a7, Sst, Gad1</italic>, and <italic>Vip</italic> were bound to the samples. These were imaged and then stripped using a solution of 60% formamide in 2X SSC buffer. Then, hybridization probes that targeted a shared sequence on the backbone of all gene padlocks and all rabies barcode padlocks were bound. After adding these ‘anchor’ probes, the tissue was stained with 5 µg/µl DAPI diluted in PBST for 10 minutes, followed by three washes in PBST before proceeding to imaging. First, only the tiles that were imaged for all sequencing rounds were acquired. The acquisition was then repeated, covering the whole brain section to aid with registration to a reference atlas (see below).</p></sec><sec id="S31"><title>Sensitivity of barcode detection</title><p id="P84">To determine the sensitivity of rabies barcode detection, sections of brain tissue infected with the barcoded rabies virus were prepared as detailed above with the following changes: during the reverse transcription step, RT primers for the rabies N, P, M and L genes were added (60 nM per primer, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 3</xref>), alongside the pool of endogenous gene RT primers (60 nM per primer) and the rabies barcode padlock (1 µM). Likewise, for the padlock ligation step, padlocks for the rabies N, P, M and L genes were added (60 nM of each padlock, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 3</xref>) alongside the endogenous gene padlocks. After RCA was completed, hybridization probes against the rabies gene padlocks (PAB0048, 1 µM) and the rabies barcode padlock (PAB0023, <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 2</xref>, 1 µM) were added in hybridization mix to the sample and incubated for 1 hour. The sample was washed three times with hybridization mix, then 200 µl USM was added. The samples were then imaged with the same filter set that was used for barcode and high-expressing gene probe imaging.</p><p id="P85">Rabies-infected cells were identified from the hybridization probe images using the rabies gene signal to segment cells. A difference of Gaussians filter was applied to the images, which were then binarized with a manually selected binarization threshold and binary closing was performed. Candidate rabies-positive cells were then detected on the binarized images. The masks were then filtered based on minimum and maximum area, circularity, elongation, solidity and unbinarized intensity. Each mask was then radially expanded by 5 µm. Rabies barcode spots were detected by finding peaks in the hybridization channel for the barcode probe and the number of barcode spots per rabies-positive cell mask was quantified.</p></sec></sec><sec id="S32"><title><italic>In situ</italic> sequencing preprocessing</title><sec id="S33"><title>Image projection</title><p id="P86">Z-stacks were z-projected to calculate the maximum and median intensity projections. The images were flat-field corrected using the average of maximum projections across all rounds and tiles. Since the median projection largely captures diffuse tissue background, all further analyses were done by subtracting the median projection from the maximum projection.</p></sec><sec id="S34"><title>Image registration</title><p id="P87">After projection, images were registered first across successive sequencing rounds, then across channels. A reference tile was manually selected and, for each channel, images from all rounds were median-filtered to reduce noise. Rigid registration parameters between successive rounds of imaging were estimated by performing an iterative grid search over rotation angles using phase correlation to estimate translation. The rotation angle across rounds was only a function of the slide position on the microscope and was constant across tiles. Due to stage inaccuracy, translation parameters could, however, vary from tile to tile and were therefore estimated by phase correlation for each tile independently. To identify aberrant x/y translation shifts, usually at the border of the brain, when a significant part of the image was outside of the sample, shifts across tiles were linearly fitted using a RANSAC regression, and shifts for tiles with residuals above 10 pixels were replaced by the regression value.</p><p id="P88">To register images across channels and correct chromatic aberration, we then computed the standard deviation projection across registered rounds, generating a reference image for each channel. Images from each channel were tiled into 256 x 256 pixel blocks with 50% overlap. For each block, x/y shifts to the reference channel were calculated by phase correlation. The x and y shifts for each block were then used to estimate the affine transformation between channels. Finally, for each tile, the images for each channel were registered using the affine registration parameters estimated from the reference tile and then further aligned using phase correlation to correct for any channel drift during imaging.</p><p id="P89">Hybridization acquisitions were registered between channels by calculating the affine transformation between channels on all tiles using a similar method as described above. As these rounds had less signal overlap between channels, registration was performed using blocks of 512 x 512 px with 80% overlap. Each block was binarized using a 0.7 quantile cut-off before registering channels using phase correlation. Finally, affine transform parameters were estimated first between pairs of channels with significant bleedthrough (channels 0 and 1 and channels 2 and 3) and then between the two channels of each group that are the most similar (channels 1 and 3). This procedure was repeated for each tile. Images for each channel were registered using the median affine registration parameters across tiles, and any residual uncorrected translation was estimated by aligning channels to the reference channel using phase correlation.</p></sec><sec id="S35"><title>Channel normalization and bleedthrough estimation</title><p id="P90">Images from sequencing rounds were filtered using a difference of Hanning kernel with radii of 2 and 4 pixels (0.462 and 0.924 µm). To correct for differences in brightness between channels, normalization factors were computed as the 99.99% quantile of pixel intensities for each channel and round, and smoothed by fitting the decrease in intensity across rounds for each channel with an exponential decay. The smoothed normalization factors for round 1 were used to correct brightness across all rounds.</p><p id="P91">To estimate the expected fluorescence profile of the fluorophores associated with each base, we first detected spots on the standard deviation projection across rounds of the filtered images as local maxima crossing a manually set threshold. We then selected well-isolated spots and extracted fluorescence values of each channel and round in a 2-pixel radius. Scaled K-means clustering (<xref ref-type="bibr" rid="R28">28</xref>) was then used to assign each spot to one of four clusters corresponding to the four dye-conjugated nucleotides. The cluster means of the four clusters were computed across rounds, generating a 4 channel x N<sub>rounds</sub> bleedthrough matrix for each base.</p></sec><sec id="S36"><title>Base calling rabies barcodes</title><p id="P92">Rabies barcodes have unknown sequences and must therefore be basecalled round by round. To do so, putative barcode spots were detected from the registered round/channel images by finding peaks in the mean image across rounds and channels, and the fluorescence trace across rounds and channels was extracted from a disk with a 2-pixel / 0.462 µm radius.</p><p id="P93">Each spot was assigned to the base with the highest cosine similarity with the bleedthrough matrix for each round. Barcode sequences were constructed from these assignments and the following quality metrics were computed: mean fluorescence intensity across rounds, mean cosine similarity score across rounds, cosine similarity score of the whole sequence, calculated by comparing the observed fluorescence traces (after background subtraction) to synthetic traces generated from the cluster means of the bases which were assigned at each round.</p><p id="P94">To distinguish genuine barcode spots from bright background autofluorescence spots, spots were first filtered by applying thresholds for the individual quality metrics. To further filter the remaining spots, the quality metrics were fit using a Gaussian Mixture Model (GMM) with two clusters, representing low and high-quality spots. Spots assigned to the high-quality cluster were retained for further analysis, and error correction was performed by merging sequences within a maximum hamming distance of 2.</p></sec><sec id="S37"><title>Gene barcode detection using orthogonal matching pursuit</title><p id="P95">Transcripts of cell-type marker genes were identified by a unique gene barcode sequence encoded in the backbone of gene-specific padlocks. To robustly decode gene spots while accounting for any spatial overlap between them, fluorescence images from gene sequencing rounds were unmixed using a modified version of the orthogonal matching pursuit (OMP) algorithm (<xref ref-type="bibr" rid="R28">28</xref>, <xref ref-type="bibr" rid="R61">61</xref>).</p><p id="P96">First, the expected fluorescence for each gene barcode was computed by concatenating the bleedthrough vectors of the base for each round to generate a gene dictionary. In addition, a set of background vectors representing constant fluorescence across rounds for each channel were appended to the gene dictionary. Fluorescence vectors of individual pixels and elements of the gene dictionary were normalized to unit norm, yielding the normalized fluorescence vector <bold>y</bold> and gene dictionary <bold>G</bold>. OMP approximates the fluorescence <bold>y</bold> as a weighted sum of elements of the dictionary <bold>G</bold> assigned to a given pixel, defined by the support set Λ. Λ is initialized to contain the background vectors and is updated on each iteration to add the gene that best explains the residual fluorescence in the pixel: <disp-formula id="FD2"><label>(2)</label><mml:math id="M2"><mml:mrow><mml:msub><mml:mo>Λ</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mo>Λ</mml:mo><mml:mi>k</mml:mi></mml:msub><mml:mo>∪</mml:mo><mml:msub><mml:mi>j</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo>.</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:math></disp-formula></p><p id="P97">To select gene <italic>j</italic><sub><italic>k</italic>+1</sub> added on a given iteration, we first select the columns of the gene dictionary already included in Λ<sub><italic>k</italic></sub>: <disp-formula id="FD3"><label>(3)</label><mml:math id="M3"><mml:mrow><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>G</mml:mi></mml:mstyle><mml:mrow><mml:msub><mml:mo>Λ</mml:mo><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>g</mml:mi></mml:mstyle><mml:mrow><mml:msub><mml:mi>j</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>g</mml:mi></mml:mstyle><mml:mrow><mml:msub><mml:mi>j</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>g</mml:mi></mml:mstyle><mml:mrow><mml:msub><mml:mi>j</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P98">We then fit the fluorescence <bold>y</bold> to estimate the coefficients <italic>β</italic> for each selected gene and background components <disp-formula id="FD4"><label>(4)</label><mml:math id="M4"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>β</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mtext>argmin</mml:mtext></mml:mrow><mml:mi>β</mml:mi></mml:munder><mml:mo>|</mml:mo><mml:mo>|</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>y</mml:mi></mml:mstyle><mml:mo>−</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>G</mml:mi></mml:mstyle><mml:mrow><mml:msub><mml:mo>Λ</mml:mo><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mi>β</mml:mi><mml:mo>|</mml:mo><mml:msubsup><mml:mo>|</mml:mo><mml:mn>2</mml:mn><mml:mn>2</mml:mn></mml:msubsup><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P99">We then compute the residual fluorescence <bold>r</bold><sub><italic>k</italic></sub> <disp-formula id="FD5"><label>(5)</label><mml:math id="M5"><mml:mrow><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>r</mml:mi></mml:mstyle><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>y</mml:mi></mml:mstyle><mml:mo>−</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>G</mml:mi></mml:mstyle><mml:mrow><mml:msub><mml:mo>Λ</mml:mo><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mover accent="true"><mml:mi>β</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P100">and select the gene <italic>j</italic><sub><italic>k</italic>+1</sub>, whose gene vector has the highest absolute dot product with the residual: <disp-formula id="FD6"><label>(6)</label><mml:math id="M6"><mml:mrow><mml:msub><mml:mi>j</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mtext>argmax</mml:mtext></mml:mrow><mml:mi>j</mml:mi></mml:munder><mml:mo>|</mml:mo><mml:mo>〈</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>r</mml:mi></mml:mstyle><mml:mi>k</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>g</mml:mi></mml:mstyle><mml:mi>j</mml:mi></mml:msub><mml:mo>〉</mml:mo><mml:mo>|</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P101">Rounds and channels containing bright signals corresponding to genes included in Λ may not be fully accounted for in the residual fluorescence <bold>r</bold><sub><italic>k</italic></sub>, which could lead to false-positive detection of other genes on subsequent iterations. To control for this, the algorithm above is modified to weigh rounds and channels based on the amount of fluorescence attributed to them (see <ext-link ext-link-type="uri" xlink:href="https://github.com/znamlab/iss-preprocess">https://github.com/znamlab/iss-preprocess</ext-link>, based on <ext-link ext-link-type="uri" xlink:href="https://github.com/jduffield65/coppafish">https://github.com/jduffield65/coppafish</ext-link>).</p><p id="P102">The iteration continued until a maximum number of components was reached, or the dot product <inline-formula><mml:math id="M7"><mml:mrow><mml:mo>〈</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>r</mml:mi></mml:mstyle><mml:mi>k</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>g</mml:mi></mml:mstyle><mml:mrow><mml:msub><mml:mi>j</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo>〉</mml:mo></mml:mrow></mml:math></inline-formula> no longer reached a preset threshold. This resulted in a sparse approximation of the fluorescence in every pixel as a combination of a small number of gene-specific components.</p><p id="P103">The gene coefficients for each gene were then assembled into images and peaks were detected in these gene coefficient images. To distinguish genuine signals from spurious peaks, a spot shape score was assigned to each peak based on the similarity of the signal at that location to a precomputed spot shape image. Any peaks that have a spot score exceeding a manually selected threshold were retained for further analysis.</p></sec><sec id="S38"><title>Hybridization spot detection</title><p id="P104">To detect gene spots, the bleedthrough vectors for each fluorophore were first estimated on a set of reference tiles as described above for sequencing rounds. Peaks were then detected on all tiles, and the mean fluorescence values in each channel at a disk with a 2-pixel / 0.462 µm radius in each spot location were extracted. Fluorescence vectors for each spot were then compared to the bleedthrough matrix and assigned to the probe with the highest cosine similarity.</p></sec><sec id="S39"><title>Registration between imaging tiles and cryosections</title><p id="P105">All image modalities were registered to the first gene round, aligning the gene spots, hybridization spots and DAPI fluorescence images on a tile-by-tile basis by estimating rotation and translation between the target and reference tiles as described above for registration across rounds.</p><p id="P106">The x/y shifts between adjacent tiles were estimated by phase correlation using the overlap regions. Large outlier shift values or shifts with low correlation maxima were corrected to the median shift along each tile row. These tile shifts were used to combine spot coordinates across tiles into a whole section coordinate system. To avoid duplicate spot detection in overlap regions, spots were only retained if they were closer to the center of the tile on which they were detected than the center of any other tile.</p><p id="P107">To register the spot coordinates from each section to a common coordinate system and determine their location within the brain, all sections were registered to the Allen CCFv3 10 µm coronal atlas (<xref ref-type="bibr" rid="R32">32</xref>). First, stitched images of whole coronal sections were registered to <italic>in situ</italic> sequencing images, which contained only a part of one hemisphere, using masked phase correlation (<xref ref-type="bibr" rid="R62">62</xref>). Coronal sections were downsampled, and cutting angles and positioning of slices along the Z-axis were estimated using Deepslice (<xref ref-type="bibr" rid="R63">63</xref>). Affine transformation of the slices was performed using Elastix (<xref ref-type="bibr" rid="R64">64</xref>) and non-rigid transformation was performed using BigWarp (<xref ref-type="bibr" rid="R65">65</xref>), relying on manually selected landmarks. The stitched spot coordinates from each section were then converted to atlas coordinates. The BrainGlobeAtlas API (<xref ref-type="bibr" rid="R66">66</xref>) was used to define brain area annotations.</p><p id="P108">The Allen CCDFv3 coordinates were converted to a flattened cortical representation by using the CCF-streamlines package (<xref ref-type="bibr" rid="R32">32</xref>). Non-cortical cells situated less than 150 µm from the cortex were projected to their closest neighboring voxel in the cortex. As the thickness of cortical layers varied across the sequenced volume, to plot the cortical depth of cells in flatmap coordinates while respecting layer borders (<xref ref-type="fig" rid="F4">Fig. 4b</xref> and <xref ref-type="fig" rid="F5">Fig. 5a</xref>), layer thickness was rescaled to the average layer thickness across V1.</p></sec><sec id="S40"><title>Cell segmentation</title><p id="P109">Cell nuclei were segmented using Cellpose (<xref ref-type="bibr" rid="R67">67</xref>). The “cyto” base model from Cellpose was fine-tuned using manually curated data, with DAPI fluorescence as the nuclei channel and the anchor hybridization probe that binds to all gene spots as a cytoplasmic channel. Cellpose was run on individual planes of DAPI Z-stacks, and the resultant masks were projected to a single plane, removing small masks or masks only found on a single plane and merging any remaining masks based on their spatial overlap.</p><p id="P110">To assign gene spots to cells, mask images from all tiles in each section were stitched together and dilated by 5 µm to expand the nuclei masks to cover the soma of each neuron. All gene spots within each dilated mask were assigned to it. Assigning all barcode spots present within each dilated mask risks false positives, as rabies barcodes are present in the neuropil as well as in neuronal somata. Instead, barcodes were assigned to cells based on their spatial clustering using a probabilistic assignment model including a Gaussian spatial likelihood function, which considers the distance of a spot to a mask, a background component with a fixed low-density likelihood to account for spots that do not correspond to any specific mask, and a mask spot-count likelihood, which penalizes spot assignments to cells unless justified by the spatial data, encouraging sparseness. Each spot <bold>x</bold><sub><italic>i</italic></sub> can be assigned to either a mask <italic>j</italic> ∈ {1, …,<italic>M</italic>} or to the background (denoted by −1). We define a spatial probability density function for a spot to originate from a specific mask or background, defined as <disp-formula id="FD7"><label>(7)</label><mml:math id="M8"><mml:mrow><mml:mtable equalrows="true" equalcolumns="true"><mml:mtr><mml:mtd><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>x</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>exp</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mo>−</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>2</mml:mn><mml:msup><mml:mi>σ</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>x</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mn>2</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:mspace width="0.2em"/><mml:mtext>for</mml:mtext><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>M</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>x</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>α</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math></disp-formula></p><p id="P111">where <bold>x</bold><sub><italic>i</italic></sub> ∈ ℝ<sup>2</sup> is the 2D coordinates of spot <italic>i</italic>, <bold><italic>µ</italic></bold><sub><italic>j</italic></sub> ∈ ℝ<sup>2</sup> is the centroid of mask <italic>j, σ</italic> is the spatial scale parameter and <italic>α</italic> is a small constant (e.g. 10<sup>-6</sup>) representing the background likelihood.</p><p id="P112">We also define a mask spot count probability function <disp-formula id="FD8"><label>(8)</label><mml:math id="M9"><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>z</mml:mi></mml:mstyle><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>exp</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>z</mml:mi></mml:mstyle><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>β</mml:mi></mml:msup></mml:mrow><mml:mi>m</mml:mi></mml:mfrac><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P113">where <italic>n</italic><sub><italic>j</italic></sub>(<bold>z</bold>) is the number of spots assigned to mask <italic>j</italic> under the assignment vector <bold>z</bold>, <italic>m</italic> is the spot count scale factor, and <italic>β</italic> is an exponent that controls how the likelihood penalty scales with spot count. Setting <italic>β &lt;</italic> 1 makes the log-penalty sublinear in <italic>n</italic><sub><italic>j</italic></sub>, so the incremental penalty for each additional spot decreases with every added spot, favoring assigning spots to a small number of masks over splitting them across many masks. Combining the spot-wise assignment and the spot-count terms, the full likelihood for the whole assignment vector <bold>z</bold> is <disp-formula id="FD9"><label>(9)</label><mml:math id="M10"><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>z</mml:mi></mml:mstyle><mml:mo>,</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>x</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>μ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>N</mml:mi></mml:munderover><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>x</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>×</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:munderover><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>z</mml:mi></mml:mstyle><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P114">where <italic>N</italic> is the total number of spots and <italic>M</italic> is the total number of cell masks.</p><p id="P115">Every barcode sequence is handled in isolation, such that the assignment of one barcode does not affect the assignments of other barcodes. Initially, spots falling within a specified maximum distance threshold are assigned to the nearest mask based on Euclidean distance. Spots that do not meet this criterion are assigned to the background. These initial spot assignments are then refined through an iterative optimization process. In each iteration, the algorithm explores potential reassignments of spots to masks by evaluating combinations of spots that are found close together, defined by an inter-spot distance threshold. For each valid combination of spots, the algorithm reassigned spots to a different mask or to the background to maximize the assignment likelihood. The algorithm prioritizes reassignments that yield the highest increase in overall likelihood, thereby iteratively improving the accuracy of spot-to-mask assignments. On each iteration, the algorithm evaluates two scenarios for each spot combination: moving the spots to a new mask and assigning them to the background. The optimization terminates once none of the spots are reassigned on a given iteration or the iteration limit is reached.</p></sec><sec id="S41"><title>mCherry cell detection</title><p id="P116">To detect the nuclei of mCherry-positive starter neurons, mCherry fluorescence was first unmixed using fluorescence from the green (Chroma ET546/22x) channel. A difference of Gaussians filter was applied to the unmixed images, which were then binarized with a manually selected binarization threshold and binary closing was performed. Candidate mCherry nuclei were then detected on the binarized images. The masks were filtered based on minimum and maximum area, circularity, elongation, solidity and unbinarized intensity.</p><p id="P117">To assign mCherry masks to rabies-infected cells, the reference-aligned tile coordinates were used to make full-section stitched images of the mCherry masks and rabies spots coordinates. Each mCherry mask was first checked for any rabies spots that overlapped with it. If barcode spots were found in the mCherry mask, the cell to which the most abundant barcode belonged was checked to find all of its barcode spots. If the percentage of spots from that cell found within the mCherry mask was above a threshold (conservatively 10% of the total spots in the rabies-infected cell), and the centroid of the spots overlapped with the mCherry mask, then the mCherry mask was assigned to that cell.</p></sec><sec id="S42"><title>Cell type classification</title><p id="P118">Single cell gene expression data was analyzed using the <ext-link ext-link-type="uri" xlink:href="https://scanpy.readthedocs.io/en/stable/index.html">scanpy</ext-link> single-cell analysis toolkit (<xref ref-type="bibr" rid="R68">68</xref>). First, cell-type clusters were defined for high-quality cells in a reference dataset collected from four coronal sections covering the visual cortex in a separate brain. High-quality cortical cells were selected as cells with &gt;=4 unique genes per cell and &gt;=30 gene counts per cell. Transcript counts in each cell were normalized and log1p-transformed (natural log with a pseudo-count of 1). The first 30 principal components were then used to compute the nearest-neighbors distance matrix and a neighborhood graph of the cells with the local neighborhood size set to 10. Cells were then clustered into subgroups using the Leiden algorithm (<xref ref-type="bibr" rid="R69">69</xref>). The resulting clusters were manually annotated as cell types by referencing the expression of marker genes in the gene panel to a V1 SMARTseq scRNAseq dataset (<xref ref-type="bibr" rid="R12">12</xref>) and by comparing the spatial location of each cell cluster with known cortical layers. Mean gene expression values were calculated per cluster.</p><p id="P119">For each cell <italic>j</italic> in the rabies <italic>in situ</italic> sequencing dataset, we calculated the Pearson correlation coefficient <italic>r</italic><sub><italic>jk</italic></sub> = corr(<bold>x</bold><sub><italic>j</italic></sub>, <bold><italic>µ</italic></bold><sub><italic>k</italic></sub>) between the cell’s log-normalized expression vector <bold>x</bold><sub><italic>j</italic></sub> and the log-mean expression vector <bold><italic>µ</italic></bold><sub><italic>k</italic></sub> of reference cluster <italic>k</italic>. For the analyses in <xref ref-type="fig" rid="F5">Fig. 5a-g</xref>, excitatory rabies-infected cells were selected based on the identity of their highest correlation cluster. For the analyses in <xref ref-type="fig" rid="F5">Fig. 5h-j</xref>, rabies-infected cells were classified as inhibitory if the cluster yielding their maximum correlation corresponded to one of the inhibitory reference clusters <italic>Pvalb, Sst, Vip</italic>, or <italic>Lamp5</italic> and if they satisfied all three of the following thresholds: a Pearson correlation coefficient of 0.3, a minimum gene count of 3, and a minimum nearest-neighbor cluster label agreement of 0.3.</p><p id="P120">Clusters were visualized using Uniform Manifold Approximation and Projection (UMAP) (<xref ref-type="bibr" rid="R70">70</xref>) with a minimum distance between embedded points of 0.05. Scanpy’s ingest function was used to project all <italic>in situ</italic> sequenced cells onto the PCA space of the high-quality cell reference data, followed by k-nearest-neighbor classification and UMAP embedding transfer for visualization of reference clusters (<xref ref-type="fig" rid="F2">Fig. 2h, i</xref>).</p></sec></sec><sec id="S43"><title>Data analysis</title><sec id="S44"><title>Estimation of the proportion of cells present in the sequenced volume</title><p id="P121">To determine the proportion of starter cells contained in the <italic>in situ</italic> sequencing volume (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4a</xref>), sections adjacent to the sequenced dataset were imaged and analyzed by following the mCherry imaging and mCherry cell detection steps described above.</p><p id="P122">To estimate the number of presynaptic cells included in the dataset (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4b</xref>), the <italic>in situ</italic> sequenced volume was registered to the Allen CCFv3 reference atlas as described above. The sequenced volume was then superposed onto bulk rabies tracing data (<xref ref-type="fig" rid="F1">Fig. 1h-j</xref>) by aligning the manually determined injection centers of the two experiments and the proportion of rabies-infected cells within this volume in bulk tracing data was quantified. For illustration, we plotted the medio-lateral and dorso-ventral position of cells within 400 µm of the central coronal plane over the atlas borders of this coronal plane (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4b</xref> top) and the antero-posterior and medio-lateral position of all cells overlaid on a dorsal view of the atlas borders (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 4b</xref> bottom). The sequencing sections were not perfectly coronal and thalamic cells present in the volume (orange) appear anterior to the cortical cells.</p></sec><sec id="S45"><title>Probability of barcode transmission between starter cells</title><p id="P123">The probability that a given starter neuron transmits its barcode to another starter cell (<xref ref-type="fig" rid="F1">Fig. 1g</xref>), <italic>p</italic>, was estimated as a function of the number of neurons infected by each starter cell, <italic>n</italic>, and the proportion of neurons infected by the starter AAVs, <italic>α</italic>: <disp-formula id="FD10"><label>(10)</label><mml:math id="M11"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>α</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>n</mml:mi></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p id="P124">To convert between the proportion of starter neurons and cell density, the overall density of neurons in the visual cortex was estimated as 150,000 cells per mm<sup>3</sup> (<xref ref-type="bibr" rid="R71">71</xref>, <xref ref-type="bibr" rid="R72">72</xref>).</p></sec><sec id="S46"><title>Library barcode abundance</title><p id="P125">To compare the sequences of barcodes found <italic>in situ</italic> to those found in the viral library (<xref ref-type="fig" rid="F3">Fig. 3b</xref>, <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 6a</xref>), we first determined the abundance distribution of barcodes in the library by grouping barcodes by their number of unique reads (sequences with the same barcode but different UMIs), and plotting the total proportion of the library represented in each of these abundance bins (<xref ref-type="fig" rid="F3">Fig. 3b</xref>, black). Given that only a few barcodes have high abundance (<xref ref-type="fig" rid="F1">Fig. 1c</xref>), they collectively represented only a small fraction of total reads in the library, and most reads of the library consisted of barcodes representing each about 10<sup>-5</sup> of the library. We then matched the 2,158 barcodes found <italic>in situ</italic> and the same number of randomly generated barcodes to the library barcodes and plotted the distribution of the abundance in the library of those matches (<xref ref-type="fig" rid="F3">Fig. 3b</xref>, blue lines).</p><p id="P126">To determine the excess number of high abundance barcodes among those present in multiple starter cells (<xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 6b</xref>), the kernel density estimate of the distribution of barcode proportion of unique reads in the library (black, <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 6a</xref>) was subtracted from that of barcodes present in multiple starters (pink, <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 6a</xref>). Then, the area under the curve of this difference (pink, <xref ref-type="supplementary-material" rid="SD1">Supplementary Fig. 6b</xref>) was numerically integrated between 1.49 x 10<sup>-4</sup> (where the difference exceeded 0) and 10<sup>-2</sup> to obtain the proportion of excess barcodes, and multiplied by the total number of barcodes found in multiple cells (n=122), to give the final estimate of 8/122 barcodes.</p></sec><sec id="S47"><title>Starter cell mCherry fluorescence analysis</title><p id="P127">The H2B-mCherry intensity (<xref ref-type="fig" rid="F3">Fig. 3f</xref>) was measured as the average fluorescence intensity of the red channel inside each starter cell mask. The logarithm of the intensity was then correlated to the logarithm of the number of presynaptic cells detected for each starter + 1.</p></sec><sec id="S48"><title>Relative spatial location of presynaptic neurons</title><p id="P128">Position of the presynaptic cells relative to their starter cells (<xref ref-type="fig" rid="F4">Fig. 4f</xref> top) were calculated using flatmap coordinates. The distribution of relative medio-lateral location (<xref ref-type="fig" rid="F4">Fig. 4g</xref>) was the kernel density estimate of the difference in medio-lateral position only with a bandwidth of 50 µm. To estimate a null distribution assuming random connectivity, we shuffled the barcodes of presynaptic cells but not those of starter cells. This procedure preserves the number of presynaptic cells per starter and the spatial distribution of starter and presynaptic cells. A single example shuffled sample was used for the scatter plot of <xref ref-type="fig" rid="F4">Fig. 4f</xref> (bottom). 10,000 bootstrap samples were used to calculate the confidence interval of medio-lateral distance distribution (<xref ref-type="fig" rid="F4">Fig. 4g</xref> dashed line). The median distance to the starter cells was computed in flatmap coordinates using the 3 dimensions and compared to that of the shuffled samples (see Results).</p></sec><sec id="S49"><title>Layer- and cell-type-specific connectivity</title><p id="P129">The analysis of local excitatory connectivity in <xref ref-type="fig" rid="F5">Fig. 5a-g</xref> included all putative local excitatory connections by removing cells classified as inhibitory and connections from presynaptic cells that were more than 1 mm away from their starter cell. Only starter cells with at least one local presynaptic cell were included for analysis. Input fractions (<xref ref-type="fig" rid="F5">Fig. 5b-e</xref>) were calculated as the number of connections from each layer divided by the total number of local excitatory connections for each starter and averaged across starters in each layer. Output fractions (<xref ref-type="fig" rid="F5">Fig. 5f,g</xref>) were computed by dividing the number of connections (<xref ref-type="fig" rid="F5">Fig. 5b</xref>, left) by the sum of the number of connections per presynaptic layer.</p><p id="P130">To identify over- and under-represented connections, we shuffled the barcodes across presynaptic neurons, keeping their layer identity and spatial location unchanged, repeating the shuffling procedure 10,000 times. Effect sizes were computed as the ratio of the observed input and output fractions and the means of the shuffled samples (<xref ref-type="fig" rid="F5">Fig. 5e,g</xref>, circle diameter and colormap sign). To estimate p-values, we computed the log effect size for individual shuffle samples and determined the quantile <italic>q</italic> of the effect size distribution at 0. We then calculated the uncorrected two-sided p-value as 2 min {<italic>q</italic>, 1 −<italic>q</italic>}. These p-values from the bootstrap distribution were then corrected for a false discovery rate of 5% using Benjamini–Hochberg correction (<xref ref-type="fig" rid="F5">Fig. 5e</xref>, colormap absolute value).</p><p id="P131">In the analysis of connectivity between inhibitory cell types (<xref ref-type="fig" rid="F5">Fig. 5i</xref>), input fractions were calculated as the number of connections from each cell type divided by the total number of inhibitory connections for each starter and averaged across starters.</p><p id="P132">Confidence intervals for input fractions (<xref ref-type="fig" rid="F5">Fig. 5c,d,j</xref>) were computed by bootstrap resampling starter cells with replacement 10,000 times as the [2.5-97.5] percentiles of the input fraction distributions.</p></sec><sec id="S50"><title>Retinotopic location estimation</title><p id="P133">To relate long-range connectivity patterns to retinotopic organization of the visual cortex (<xref ref-type="fig" rid="F6">Fig. 6</xref>), azimuth maps from Waters et al. (<xref ref-type="bibr" rid="R44">44</xref>) were averaged and aligned to the top view projection. Each starter cell was assigned an azimuth location by projecting its coordinates onto the top view before querying the averaged map. To display the azimuth map in flatmap coordinates, we found the surface 3D voxel of each pixel on the top view projection (using the ‘view_lookup’ of the <ext-link ext-link-type="uri" xlink:href="https://github.com/AllenInstitute/ccf_streamlines">ccf_streamlines package</ext-link>) and mapped it to the closest flatmap coordinates. Missing pixels were then filled by bicubic interpolation.</p><p id="P134">The average map of starter ML position (<xref ref-type="fig" rid="F6">Fig. 6c</xref>) was computed as the 2D Gaussian weighted average (<italic>σ</italic>=200 µm) of data in <xref ref-type="fig" rid="F6">Fig. 6a</xref>. This map was clipped using the concave hull of the presynaptic cells’ position to avoid extrapolation outside of the data range. A transparency mask proportional to the total weight of the 2D Gaussian was applied to indicate the number of data points at each map location.</p></sec></sec></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary Table 3</label><media xlink:href="EMS207403-supplement-Supplementary_Table_3.xlsx" mimetype="application" mime-subtype="vnd.openxmlformats-officedocument.spreadsheetml.sheet" id="d23aAcEbB" position="anchor"/></supplementary-material><supplementary-material content-type="local-data" id="SD2"><label>Supplementary Materials</label><media xlink:href="EMS207403-supplement-Supplementary_Materials.pdf" mimetype="application" mime-subtype="pdf" id="d23aAcEcB" position="anchor"/></supplementary-material></sec></body><back><ack id="S51"><title>Acknowledgments</title><p>This work was supported by the Francis Crick Institute which receives its core funding from Cancer Research UK (CC2108), the UK Medical Research Council (CC2108), and the Wellcome Trust (CC2108). We would like to thank Sophie Wood for performing some of the surgical procedures, Scott Lighterness for tail vein injections, Matt Renshaw for help in designing the microscope, Andreas Schaefer, Johannes Kohl, Dinu Florin Albeanu, and James Briscoe for comments on the manuscript, Andrew Murray for providing the CVS-N2c-ΔG-mCherry rabies genomic plasmid that was used as the backbone for the barcoded rabies viral libraries (Addgene plasmid # 73464). We thank the staff of the Making Lab, Genomics, Light Microscopy, and Biological Research Facilities at the Francis Crick Institute for supporting this work. This preprint was typeset in LaTeX based on <ext-link ext-link-type="uri" xlink:href="https://www.overleaf.com/latex/templates/henriqueslab-biorxiv-template/nyprsybwffws">a template created by Ricardo Henriques</ext-link>.</p></ack><sec id="S52" sec-type="data-availability"><title>Data and code availability</title><p id="P135">Preprocessed data required to reproduce the analyses will be deposited and made publicly available prior to publication. Both preprocessed and raw data are available from Petr Znamenskiy (<email>petr.znamenskiy@crick.ac.uk</email>) upon request. Original code required to reproduce the analyses is available on Github at <ext-link ext-link-type="uri" xlink:href="https://github.com/znamlab/brisc">https://github.com/znamlab/brisc</ext-link>. Code for processing raw <italic>in situ</italic> sequencing data is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/znamlab/iss-preprocess">https://github.com/znamlab/iss-preprocess</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://github.com/znamlab/iss-analysis">https://github.com/znamlab/iss-analysis</ext-link>.</p></sec><fn-group><fn fn-type="con" id="FN1"><p id="P136"><bold>Author contributions</bold></p><p id="P137">P.Z. and A.Be. conceived the study. A.Be. and M.S. generated barcoded rabies libraries. A.Be. and A.Bl. carried out barcoded rabies tracing experiments. A.Be, A.Bl., and P.Z. analyzed the data and wrote the manuscript.</p></fn></fn-group><ref-list><ref id="R1"><label>1</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zador</surname><given-names>AM</given-names></name><name><surname>Dubnau</surname><given-names>J</given-names></name><name><surname>Oyibo</surname><given-names>HK</given-names></name><name><surname>Zhan</surname><given-names>H</given-names></name><name><surname>Cao</surname><given-names>G</given-names></name><name><surname>Peikon</surname><given-names>ID</given-names></name></person-group><article-title>Sequencing the connectome</article-title><source>PLOS Biology</source><year>2012</year><volume>10</volume><issue>10</issue><fpage>1</fpage><lpage>7</lpage><pub-id pub-id-type="doi">10.1371/journal.pbio.1001411</pub-id><pub-id pub-id-type="pmcid">PMC3479097</pub-id><pub-id pub-id-type="pmid">23109909</pub-id></element-citation></ref><ref id="R2"><label>2</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wickersham</surname><given-names>IR</given-names></name><name><surname>Finke</surname><given-names>S</given-names></name><name><surname>Conzelmann</surname><given-names>KK</given-names></name><name><surname>Callaway</surname><given-names>EM</given-names></name></person-group><article-title>Retrograde neuronal tracing with a deletion-mutant rabies virus</article-title><source>Nature Methods</source><year>2007</year><volume>4</volume><issue>1</issue><fpage>47</fpage><lpage>49</lpage><pub-id pub-id-type="doi">10.1038/NMETH999</pub-id><pub-id pub-id-type="pmcid">PMC2755236</pub-id><pub-id pub-id-type="pmid">17179932</pub-id></element-citation></ref><ref id="R3"><label>3</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wall</surname><given-names>NR</given-names></name><name><surname>Wickersham</surname><given-names>IR</given-names></name><name><surname>Cetin</surname><given-names>A</given-names></name><name><surname>De La Parra</surname><given-names>M</given-names></name><name><surname>Callaway</surname><given-names>EM</given-names></name></person-group><article-title>Monosynaptic circuit tracing in vivo through Cre-dependent targeting and complementation of modified rabies virus</article-title><source>Proceedings of the National Academy of Sciences</source><year>2010</year><volume>107</volume><issue>50</issue><fpage>21848</fpage><lpage>21853</lpage><pub-id pub-id-type="doi">10.1073/pnas.1011756107</pub-id><pub-id pub-id-type="pmcid">PMC3003023</pub-id><pub-id pub-id-type="pmid">21115815</pub-id></element-citation></ref><ref id="R4"><label>4</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Saunders</surname><given-names>A</given-names></name><name><surname>Huang</surname><given-names>KW</given-names></name><name><surname>Vondrak</surname><given-names>C</given-names></name><name><surname>Hughes</surname><given-names>C</given-names></name><name><surname>Smolyar</surname><given-names>K</given-names></name><name><surname>Sen</surname><given-names>H</given-names></name><name><surname>Philson</surname><given-names>AC</given-names></name><name><surname>Nemesh</surname><given-names>J</given-names></name><name><surname>Wysoker</surname><given-names>A</given-names></name><name><surname>Kashin</surname><given-names>S</given-names></name><etal/></person-group><article-title>Ascertaining cells’ synaptic connections and RNA expression simultaneously with barcoded rabies virus libraries</article-title><source>Nature Communications</source><year>2022</year><volume>13</volume><issue>1</issue><elocation-id>6993</elocation-id><pub-id pub-id-type="doi">10.1038/s41467-022-34334-1</pub-id><pub-id pub-id-type="pmcid">PMC9668842</pub-id><pub-id pub-id-type="pmid">36384944</pub-id></element-citation></ref><ref id="R5"><label>5</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>A</given-names></name><name><surname>Jin</surname><given-names>L</given-names></name><name><surname>Yao</surname><given-names>S</given-names></name><name><surname>Matsuyama</surname><given-names>M</given-names></name><name><surname>van Velthoven</surname><given-names>CT</given-names></name><name><surname>Sullivan</surname><given-names>HA</given-names></name><name><surname>Sun</surname><given-names>N</given-names></name><name><surname>Kellis</surname><given-names>M</given-names></name><name><surname>Tasic</surname><given-names>B</given-names></name><name><surname>Wickersham</surname><given-names>I</given-names></name><etal/></person-group><article-title>Rabies virus-based barcoded neuroanatomy resolved by single-cell RNA and in situ sequencing</article-title><source>eLife</source><year>2024</year><volume>12</volume><elocation-id>RP87866</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.87866</pub-id><pub-id pub-id-type="pmcid">PMC10942611</pub-id><pub-id pub-id-type="pmid">38319699</pub-id></element-citation></ref><ref id="R6"><label>6</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lin</surname><given-names>Z</given-names></name><name><surname>Ophir</surname><given-names>O</given-names></name><name><surname>Trimbuch</surname><given-names>T</given-names></name><name><surname>Brokowski</surname><given-names>B</given-names></name><name><surname>Tibi</surname><given-names>M</given-names></name><name><surname>Pavletsov</surname><given-names>P</given-names></name><name><surname>Schmidt</surname><given-names>H</given-names></name><name><surname>Rosenmund</surname><given-names>C</given-names></name><name><surname>Hochgerner</surname><given-names>H</given-names></name><name><surname>Zeisel</surname><given-names>A</given-names></name></person-group><article-title>Brain-wide monosynaptic connectivity mapping with ROInet-seq</article-title><source>bioRxiv preprint</source><year>2024</year><pub-id pub-id-type="doi">10.1101/2024.04.04.588058</pub-id></element-citation></ref><ref id="R7"><label>7</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shin</surname><given-names>D</given-names></name><name><surname>Urbanek</surname><given-names>ME</given-names></name><name><surname>Larson</surname><given-names>HH</given-names></name><name><surname>Moussa</surname><given-names>AJ</given-names></name><name><surname>Lee</surname><given-names>KY</given-names></name><name><surname>Baker</surname><given-names>DL</given-names></name><name><surname>Standen-Bloom</surname><given-names>E</given-names></name><name><surname>Ramachandran</surname><given-names>S</given-names></name><name><surname>Bogdanoff</surname><given-names>D</given-names></name><name><surname>Cadwell</surname><given-names>CR</given-names></name><etal/></person-group><article-title>High-complexity barcoded rabies virus for scalable circuit mapping using single-cell and single-nucleus sequencing</article-title><source>bioRxiv preprint</source><year>2024</year><pub-id pub-id-type="doi">10.1101/2024.10.01.616167</pub-id></element-citation></ref><ref id="R8"><label>8</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bae</surname><given-names>JA</given-names></name><name><surname>Baptiste</surname><given-names>M</given-names></name><name><surname>Baptiste</surname><given-names>MR</given-names></name><name><surname>Bishop</surname><given-names>CA</given-names></name><name><surname>Bodor</surname><given-names>AL</given-names></name><name><surname>Brittain</surname><given-names>D</given-names></name><name><surname>Brooks</surname><given-names>V</given-names></name><name><surname>Buchanan</surname><given-names>J</given-names></name><name><surname>Bumbarger</surname><given-names>DJ</given-names></name><name><surname>Castro</surname><given-names>MA</given-names></name><etal/></person-group><article-title>Functional connectomics spanning multiple areas of mouse visual cortex</article-title><source>Nature</source><year>2025</year><volume>640</volume><issue>8058</issue><fpage>435</fpage><lpage>447</lpage><pub-id pub-id-type="doi">10.1038/s41586-025-08790-w</pub-id><pub-id pub-id-type="pmcid">PMC11981939</pub-id><pub-id pub-id-type="pmid">40205214</pub-id></element-citation></ref><ref id="R9"><label>9</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shapson-Coe</surname><given-names>A</given-names></name><name><surname>Januszewski</surname><given-names>M</given-names></name><name><surname>Berger</surname><given-names>DR</given-names></name><name><surname>Pope</surname><given-names>A</given-names></name><name><surname>Wu</surname><given-names>Y</given-names></name><name><surname>Blakely</surname><given-names>T</given-names></name><name><surname>Schalek</surname><given-names>RL</given-names></name><name><surname>Li</surname><given-names>PH</given-names></name><name><surname>Wang</surname><given-names>S</given-names></name><name><surname>Maitin-Shepard</surname><given-names>J</given-names></name><etal/></person-group><article-title>A petavoxel fragment of human cerebral cortex reconstructed at nanoscale resolution</article-title><source>Science</source><year>2024</year><volume>384</volume><issue>6696</issue><elocation-id>eadk4858</elocation-id><pub-id pub-id-type="doi">10.1126/science.adk4858</pub-id><pub-id pub-id-type="pmcid">PMC11718559</pub-id><pub-id pub-id-type="pmid">38723085</pub-id></element-citation></ref><ref id="R10"><label>10</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dorkenwald</surname><given-names>S</given-names></name><name><surname>Matsliah</surname><given-names>A</given-names></name><name><surname>Sterling</surname><given-names>AR</given-names></name><name><surname>Schlegel</surname><given-names>P</given-names></name><name><surname>Yu</surname><given-names>Sc</given-names></name><name><surname>McKellar</surname><given-names>CE</given-names></name><name><surname>Lin</surname><given-names>A</given-names></name><name><surname>Costa</surname><given-names>M</given-names></name><name><surname>Eichler</surname><given-names>K</given-names></name><name><surname>Yin</surname><given-names>Y</given-names></name><etal/></person-group><article-title>Neuronal wiring diagram of an adult brain</article-title><source>Nature</source><year>2024</year><volume>634</volume><issue>8032</issue><fpage>124</fpage><lpage>138</lpage><pub-id pub-id-type="doi">10.1038/s41586-024-07558-y</pub-id><pub-id pub-id-type="pmcid">PMC11446842</pub-id><pub-id pub-id-type="pmid">39358518</pub-id></element-citation></ref><ref id="R11"><label>11</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tasic</surname><given-names>B</given-names></name><name><surname>Menon</surname><given-names>V</given-names></name><name><surname>Nguyen</surname><given-names>TN</given-names></name><name><surname>Kim</surname><given-names>TK</given-names></name><name><surname>Jarsky</surname><given-names>T</given-names></name><name><surname>Yao</surname><given-names>Z</given-names></name><name><surname>Levi</surname><given-names>B</given-names></name><name><surname>Gray</surname><given-names>LT</given-names></name><name><surname>Sorensen</surname><given-names>SA</given-names></name><name><surname>Dolbeare</surname><given-names>T</given-names></name><etal/></person-group><article-title>Adult mouse cortical cell taxonomy by single cell transcriptomics</article-title><source>Nature Neuroscience</source><year>2016</year><volume>19</volume><issue>2</issue><fpage>335</fpage><lpage>346</lpage><pub-id pub-id-type="doi">10.1038/nn.4216</pub-id><pub-id pub-id-type="pmcid">PMC4985242</pub-id><pub-id pub-id-type="pmid">26727548</pub-id></element-citation></ref><ref id="R12"><label>12</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tasic</surname><given-names>B</given-names></name><name><surname>Yao</surname><given-names>Z</given-names></name><name><surname>Graybuck</surname><given-names>LT</given-names></name><name><surname>Smith</surname><given-names>KA</given-names></name><name><surname>Nguyen</surname><given-names>TN</given-names></name><name><surname>Bertagnolli</surname><given-names>D</given-names></name><name><surname>Goldy</surname><given-names>J</given-names></name><name><surname>Garren</surname><given-names>E</given-names></name><name><surname>Economo</surname><given-names>MN</given-names></name><name><surname>Viswanathan</surname><given-names>S</given-names></name><etal/></person-group><article-title>Shared and distinct transcriptomic cell types across neocortical areas</article-title><source>Nature</source><year>2018</year><volume>563</volume><issue>7729</issue><fpage>72</fpage><lpage>78</lpage><pub-id pub-id-type="doi">10.1038/s41586-018-0654-5</pub-id><pub-id pub-id-type="pmcid">PMC6456269</pub-id><pub-id pub-id-type="pmid">30382198</pub-id></element-citation></ref><ref id="R13"><label>13</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zeisel</surname><given-names>A</given-names></name><name><surname>Hochgerner</surname><given-names>H</given-names></name><name><surname>Lönnerberg</surname><given-names>P</given-names></name><name><surname>Johnsson</surname><given-names>A</given-names></name><name><surname>Memic</surname><given-names>F</given-names></name><name><surname>van der Zwan</surname><given-names>J</given-names></name><name><surname>Häring</surname><given-names>M</given-names></name><name><surname>Braun</surname><given-names>E</given-names></name><name><surname>Borm</surname><given-names>LE</given-names></name><name><surname>La Manno</surname><given-names>G</given-names></name><etal/></person-group><article-title>Molecular architecture of the mouse nervous system</article-title><source>Cell</source><year>2018</year><volume>174</volume><issue>4</issue><fpage>999</fpage><lpage>1014</lpage><elocation-id>e22</elocation-id><pub-id pub-id-type="doi">10.1016/j.cell.2018.06.021</pub-id><pub-id pub-id-type="pmcid">PMC6086934</pub-id><pub-id pub-id-type="pmid">30096314</pub-id></element-citation></ref><ref id="R14"><label>14</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>M</given-names></name><name><surname>Eichhorn</surname><given-names>SW</given-names></name><name><surname>Zingg</surname><given-names>B</given-names></name><name><surname>Yao</surname><given-names>Z</given-names></name><name><surname>Cotter</surname><given-names>K</given-names></name><name><surname>Zeng</surname><given-names>H</given-names></name><name><surname>Dong</surname><given-names>H</given-names></name><name><surname>Zhuang</surname><given-names>X</given-names></name></person-group><article-title>Spatially resolved cell atlas of the mouse primary motor cortex by MERFISH</article-title><source>Nature</source><year>2021</year><volume>598</volume><issue>7879</issue><fpage>137</fpage><lpage>143</lpage><pub-id pub-id-type="doi">10.1038/s41586-021-03705-x</pub-id><pub-id pub-id-type="pmcid">PMC8494645</pub-id><pub-id pub-id-type="pmid">34616063</pub-id></element-citation></ref><ref id="R15"><label>15</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yao</surname><given-names>S</given-names></name><name><surname>Wang</surname><given-names>Q</given-names></name><name><surname>Hirokawa</surname><given-names>KE</given-names></name><name><surname>Ouellette</surname><given-names>B</given-names></name><name><surname>Ahmed</surname><given-names>R</given-names></name><name><surname>Bomben</surname><given-names>J</given-names></name><name><surname>Brouner</surname><given-names>K</given-names></name><name><surname>Casal</surname><given-names>L</given-names></name><name><surname>Caldejon</surname><given-names>S</given-names></name><name><surname>Cho</surname><given-names>A</given-names></name><etal/></person-group><article-title>A whole-brain monosynaptic input connectome to neuron classes in mouse visual cortex</article-title><source>Nature Neuroscience</source><year>2023</year><volume>26</volume><issue>2</issue><fpage>350</fpage><lpage>364</lpage><pub-id pub-id-type="doi">10.1038/s41593-022-01219-x</pub-id><pub-id pub-id-type="pmcid">PMC10039800</pub-id><pub-id pub-id-type="pmid">36550293</pub-id></element-citation></ref><ref id="R16"><label>16</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Economo</surname><given-names>MN</given-names></name><name><surname>Viswanathan</surname><given-names>S</given-names></name><name><surname>Tasic</surname><given-names>B</given-names></name><name><surname>Bas</surname><given-names>E</given-names></name><name><surname>Winnubst</surname><given-names>J</given-names></name><name><surname>Menon</surname><given-names>V</given-names></name><name><surname>Graybuck</surname><given-names>LT</given-names></name><name><surname>Nguyen</surname><given-names>TN</given-names></name><name><surname>Smith</surname><given-names>KA</given-names></name><name><surname>Yao</surname><given-names>Z</given-names></name><etal/></person-group><article-title>Distinct descending motor cortex pathways and their roles in movement</article-title><source>Nature</source><year>2018</year><volume>563</volume><issue>7729</issue><fpage>79</fpage><lpage>84</lpage><pub-id pub-id-type="pmid">30382200</pub-id></element-citation></ref><ref id="R17"><label>17</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scala</surname><given-names>F</given-names></name><name><surname>Kobak</surname><given-names>D</given-names></name><name><surname>Bernabucci</surname><given-names>M</given-names></name><name><surname>Bernaerts</surname><given-names>Y</given-names></name><name><surname>Cadwell</surname><given-names>CR</given-names></name><name><surname>Castro</surname><given-names>JR</given-names></name><name><surname>Hartmanis</surname><given-names>L</given-names></name><name><surname>Jiang</surname><given-names>X</given-names></name><name><surname>Laturnus</surname><given-names>S</given-names></name><name><surname>Miranda</surname><given-names>E</given-names></name><etal/></person-group><article-title>Phenotypic variation of transcriptomic cell types in mouse motor cortex</article-title><source>Nature</source><year>2021</year><volume>598</volume><issue>7879</issue><fpage>144</fpage><lpage>150</lpage><pub-id pub-id-type="doi">10.1038/s41586-020-2907-3</pub-id><pub-id pub-id-type="pmcid">PMC8113357</pub-id><pub-id pub-id-type="pmid">33184512</pub-id></element-citation></ref><ref id="R18"><label>18</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Peikon</surname><given-names>ID</given-names></name><name><surname>Kebschull</surname><given-names>JM</given-names></name><name><surname>Vagin</surname><given-names>VV</given-names></name><name><surname>Ravens</surname><given-names>DI</given-names></name><name><surname>Sun</surname><given-names>YC</given-names></name><name><surname>Brouzes</surname><given-names>E</given-names></name><name><surname>Corrêa</surname><given-names>IR</given-names></name><name><surname>Bressan</surname><given-names>D</given-names></name><name><surname>Zador</surname><given-names>AM</given-names></name></person-group><article-title>Using high-throughput barcode sequencing to efficiently map connectomes</article-title><source>Nucleic Acids Research</source><year>2017</year><volume>45</volume><issue>12</issue><fpage>e115</fpage><pub-id pub-id-type="doi">10.1093/nar/gkx292</pub-id><pub-id pub-id-type="pmcid">PMC5499584</pub-id><pub-id pub-id-type="pmid">28449067</pub-id></element-citation></ref><ref id="R19"><label>19</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Oyibo</surname><given-names>H</given-names></name><name><surname>Cao</surname><given-names>C</given-names></name><name><surname>Ferrante</surname><given-names>DD</given-names></name><name><surname>Zhan</surname><given-names>H</given-names></name><name><surname>Koulakov</surname><given-names>A</given-names></name><name><surname>Enquist</surname><given-names>L</given-names></name><name><surname>Dubnau</surname><given-names>J</given-names></name><name><surname>Zador</surname><given-names>A</given-names></name></person-group><article-title>A computational framework for converting high-throughput DNA sequencing data into neural circuit connectivity</article-title><source>bioRxiv preprint</source><year>2018</year><pub-id pub-id-type="doi">10.1101/244079</pub-id></element-citation></ref><ref id="R20"><label>20</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Reardon</surname><given-names>TR</given-names></name><name><surname>Murray</surname><given-names>AJ</given-names></name><name><surname>Turi</surname><given-names>GF</given-names></name><name><surname>Wirblich</surname><given-names>C</given-names></name><name><surname>Croce</surname><given-names>KR</given-names></name><name><surname>Schnell</surname><given-names>MJ</given-names></name><name><surname>Jessell</surname><given-names>TM</given-names></name><name><surname>Losonczy</surname><given-names>A</given-names></name></person-group><article-title>Rabies virus CVS-N2cΔG strain enhances retrograde synaptic transfer and neuronal viability</article-title><source>Neuron</source><year>2016</year><volume>89</volume><issue>4</issue><fpage>711</fpage><lpage>724</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2016.01.004</pub-id><pub-id pub-id-type="pmcid">PMC4760870</pub-id><pub-id pub-id-type="pmid">26804990</pub-id></element-citation></ref><ref id="R21"><label>21</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Schnell</surname><given-names>M</given-names></name><name><surname>Mebatsion</surname><given-names>T</given-names></name><name><surname>Conzelmann</surname><given-names>K</given-names></name></person-group><article-title>Infectious rabies viruses from cloned cDNA</article-title><source>The EMBO Journal</source><year>1994</year><volume>13</volume><issue>18</issue><fpage>4195</fpage><lpage>4203</lpage><pub-id pub-id-type="doi">10.1002/j.1460-2075.1994.tb06739.x</pub-id><pub-id pub-id-type="pmcid">PMC395346</pub-id><pub-id pub-id-type="pmid">7925265</pub-id></element-citation></ref><ref id="R22"><label>22</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Conzelmann</surname><given-names>KK</given-names></name><name><surname>Schnell</surname><given-names>M</given-names></name></person-group><article-title>Rescue of synthetic genomic RNA analogs of rabies virus by plasmid-encoded proteins</article-title><source>Journal of Virology</source><year>1994</year><volume>68</volume><issue>2</issue><fpage>713</fpage><lpage>719</lpage><pub-id pub-id-type="doi">10.1128/jvi.68.2.713-719.1994</pub-id><pub-id pub-id-type="pmcid">PMC236507</pub-id><pub-id pub-id-type="pmid">8289375</pub-id></element-citation></ref><ref id="R23"><label>23</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ghanem</surname><given-names>A</given-names></name><name><surname>Kern</surname><given-names>A</given-names></name><name><surname>Conzelmann</surname><given-names>KK</given-names></name></person-group><article-title>Significantly improved rescue of rabies virus from cDNA plasmids</article-title><source>European Journal of Cell Biology</source><year>2012</year><volume>91</volume><issue>1</issue><fpage>10</fpage><lpage>16</lpage><pub-id pub-id-type="pmid">21397981</pub-id></element-citation></ref><ref id="R24"><label>24</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kebschull</surname><given-names>JM</given-names></name><name><surname>Zador</surname><given-names>AM</given-names></name></person-group><article-title>Cellular barcoding: lineage tracing, screening and beyond</article-title><source>Nature Methods</source><year>2018</year><volume>15</volume><issue>11</issue><fpage>871</fpage><lpage>879</lpage><pub-id pub-id-type="pmid">30377352</pub-id></element-citation></ref><ref id="R25"><label>25</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Clark</surname><given-names>IC</given-names></name><name><surname>Gutiérrez-Vázquez</surname><given-names>C</given-names></name><name><surname>Wheeler</surname><given-names>MA</given-names></name><name><surname>Li</surname><given-names>Z</given-names></name><name><surname>Rothhammer</surname><given-names>V</given-names></name><name><surname>Linnerbauer</surname><given-names>M</given-names></name><name><surname>Sanmarco</surname><given-names>LM</given-names></name><name><surname>Guo</surname><given-names>L</given-names></name><name><surname>Blain</surname><given-names>M</given-names></name><name><surname>Zandee</surname><given-names>SEJ</given-names></name><etal/></person-group><article-title>Barcoded viral tracing of single-cell interactions in central nervous system inflammation</article-title><source>Science</source><year>2021</year><volume>372</volume><issue>6540</issue><pub-id pub-id-type="doi">10.1126/science.abf1230</pub-id><pub-id pub-id-type="pmcid">PMC8157482</pub-id><pub-id pub-id-type="pmid">33888612</pub-id></element-citation></ref><ref id="R26"><label>26</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chatterjee</surname><given-names>D</given-names></name><name><surname>Marmion</surname><given-names>DJ</given-names></name><name><surname>McBride</surname><given-names>JL</given-names></name><name><surname>Manfredsson</surname><given-names>FP</given-names></name><name><surname>Butler</surname><given-names>D</given-names></name><name><surname>Messer</surname><given-names>A</given-names></name><name><surname>Kordower</surname><given-names>JH</given-names></name></person-group><article-title>Enhanced CNS transduction from AAV.PHP.eB infusion into the cisterna magna of older adult rats compared to AAV9</article-title><source>Gene Therapy</source><year>2022</year><volume>29</volume><issue>6</issue><fpage>390</fpage><lpage>397</lpage><pub-id pub-id-type="doi">10.1038/s41434-021-00244-y</pub-id><pub-id pub-id-type="pmcid">PMC9203269</pub-id><pub-id pub-id-type="pmid">33753910</pub-id></element-citation></ref><ref id="R27"><label>27</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sun</surname><given-names>YC</given-names></name><name><surname>Chen</surname><given-names>X</given-names></name><name><surname>Fischer</surname><given-names>S</given-names></name><name><surname>Lu</surname><given-names>S</given-names></name><name><surname>Zhan</surname><given-names>H</given-names></name><name><surname>Gillis</surname><given-names>J</given-names></name><name><surname>Zador</surname><given-names>AM</given-names></name></person-group><article-title>Integrating barcoded neuroanatomy with spatial transcriptional profiling enables identification of gene correlates of projections</article-title><source>Nature Neuroscience</source><year>2021</year><volume>24</volume><issue>6</issue><fpage>873</fpage><lpage>885</lpage><pub-id pub-id-type="doi">10.1038/s41593-021-00842-4</pub-id><pub-id pub-id-type="pmcid">PMC8178227</pub-id><pub-id pub-id-type="pmid">33972801</pub-id></element-citation></ref><ref id="R28"><label>28</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bugeon</surname><given-names>S</given-names></name><name><surname>Duffield</surname><given-names>J</given-names></name><name><surname>Dipoppa</surname><given-names>M</given-names></name><name><surname>Ritoux</surname><given-names>A</given-names></name><name><surname>Prankerd</surname><given-names>I</given-names></name><name><surname>Nicoloutsopoulos</surname><given-names>D</given-names></name><name><surname>Orme</surname><given-names>D</given-names></name><name><surname>Shinn</surname><given-names>M</given-names></name><name><surname>Peng</surname><given-names>H</given-names></name><name><surname>Forrest</surname><given-names>H</given-names></name><etal/></person-group><article-title>A transcriptomic axis predicts state modulation of cortical interneurons</article-title><source>Nature</source><year>2022</year><volume>607</volume><issue>7918</issue><fpage>330</fpage><lpage>338</lpage><pub-id pub-id-type="doi">10.1038/s41586-022-04915-7</pub-id><pub-id pub-id-type="pmcid">PMC9279161</pub-id><pub-id pub-id-type="pmid">35794483</pub-id></element-citation></ref><ref id="R29"><label>29</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>Z</given-names></name><name><surname>Chen</surname><given-names>O</given-names></name><name><surname>Wall</surname><given-names>JBJ</given-names></name><name><surname>Zheng</surname><given-names>M</given-names></name><name><surname>Zhou</surname><given-names>Y</given-names></name><name><surname>Wang</surname><given-names>L</given-names></name><name><surname>Ruth Vaseghi</surname><given-names>H</given-names></name><name><surname>Qian</surname><given-names>L</given-names></name><name><surname>Liu</surname><given-names>J</given-names></name></person-group><article-title>Systematic comparison of 2A peptides for cloning multi-genes in a polycistronic vector</article-title><source>Scientific Reports</source><year>2017</year><volume>7</volume><issue>1</issue><elocation-id>2193</elocation-id><pub-id pub-id-type="doi">10.1038/s41598-017-02460-2</pub-id><pub-id pub-id-type="pmcid">PMC5438344</pub-id><pub-id pub-id-type="pmid">28526819</pub-id></element-citation></ref><ref id="R30"><label>30</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kim</surname><given-names>EJ</given-names></name><name><surname>Jacobs</surname><given-names>MW</given-names></name><name><surname>Ito-Cole</surname><given-names>T</given-names></name><name><surname>Callaway</surname><given-names>EM</given-names></name></person-group><article-title>Improved monosynaptic neural circuit tracing using engineered rabies virus glycoproteins</article-title><source>Cell Reports</source><year>2016</year><volume>15</volume><issue>4</issue><fpage>692</fpage><lpage>699</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2016.03.067</pub-id><pub-id pub-id-type="pmcid">PMC5063660</pub-id><pub-id pub-id-type="pmid">27149846</pub-id></element-citation></ref><ref id="R31"><label>31</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jia</surname><given-names>F</given-names></name><name><surname>Li</surname><given-names>L</given-names></name><name><surname>Liu</surname><given-names>H</given-names></name><name><surname>Lv</surname><given-names>P</given-names></name><name><surname>Shi</surname><given-names>X</given-names></name><name><surname>Wu</surname><given-names>Y</given-names></name><name><surname>Ling</surname><given-names>C</given-names></name><name><surname>Xu</surname><given-names>F</given-names></name></person-group><article-title>Development of a rabies virus-based retrograde tracer with high trans-monosynaptic efficiency by reshuffling glycoprotein</article-title><source>Molecular Brain</source><year>2021</year><volume>14</volume><issue>1</issue><fpage>109</fpage><pub-id pub-id-type="doi">10.1186/s13041-021-00821-7</pub-id><pub-id pub-id-type="pmcid">PMC8265122</pub-id><pub-id pub-id-type="pmid">34238335</pub-id></element-citation></ref><ref id="R32"><label>32</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>Q</given-names></name><name><surname>Ding</surname><given-names>SL</given-names></name><name><surname>Li</surname><given-names>Y</given-names></name><name><surname>Royall</surname><given-names>J</given-names></name><name><surname>Feng</surname><given-names>D</given-names></name><name><surname>Lesnar</surname><given-names>P</given-names></name><name><surname>Graddis</surname><given-names>N</given-names></name><name><surname>Naeemi</surname><given-names>M</given-names></name><name><surname>Facer</surname><given-names>B</given-names></name><name><surname>Ho</surname><given-names>A</given-names></name><etal/></person-group><article-title>The Allen mouse brain Common Coordinate Framework: a 3D reference atlas</article-title><source>Cell</source><year>2020</year><volume>181</volume><issue>4</issue><fpage>936</fpage><lpage>953</lpage><elocation-id>e20</elocation-id><pub-id pub-id-type="doi">10.1016/j.cell.2020.04.007</pub-id><pub-id pub-id-type="pmcid">PMC8152789</pub-id><pub-id pub-id-type="pmid">32386544</pub-id></element-citation></ref><ref id="R33"><label>33</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Brown</surname><given-names>D</given-names></name><name><surname>Altermatt</surname><given-names>M</given-names></name><name><surname>Dobreva</surname><given-names>T</given-names></name><name><surname>Chen</surname><given-names>S</given-names></name><name><surname>Wang</surname><given-names>A</given-names></name><name><surname>Thomson</surname><given-names>M</given-names></name><name><surname>Gradinaru</surname><given-names>V</given-names></name></person-group><article-title>Deep parallel characterization of AAV tropism and AAV-mediated transcriptional changes via single-cell RNA sequencing</article-title><source>Frontiers in Immunology</source><year>2021</year><volume>12</volume><pub-id pub-id-type="doi">10.3389/fimmu.2021.730825</pub-id><pub-id pub-id-type="pmcid">PMC8574206</pub-id><pub-id pub-id-type="pmid">34759919</pub-id></element-citation></ref><ref id="R34"><label>34</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jang</surname><given-names>MJ</given-names></name><name><surname>Coughlin</surname><given-names>GM</given-names></name><name><surname>Jackson</surname><given-names>CR</given-names></name><name><surname>Chen</surname><given-names>X</given-names></name><name><surname>Chuapoco</surname><given-names>MR</given-names></name><name><surname>Vendemiatti</surname><given-names>JL</given-names></name><name><surname>Wang</surname><given-names>AZ</given-names></name><name><surname>Gradinaru</surname><given-names>V</given-names></name></person-group><article-title>Spatial transcriptomics for profiling the tropism of viral vectors in tissues</article-title><source>Nature Biotechnology</source><year>2023</year><volume>41</volume><issue>9</issue><fpage>1272</fpage><lpage>1286</lpage><pub-id pub-id-type="doi">10.1038/s41587-022-01648-w</pub-id><pub-id pub-id-type="pmcid">PMC10443732</pub-id><pub-id pub-id-type="pmid">36702899</pub-id></element-citation></ref><ref id="R35"><label>35</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ohara</surname><given-names>S</given-names></name></person-group><article-title>Dual transneuronal tracing in the rat entorhinal-hippocampal circuit by intracerebral injection of recombinant rabies virus vectors</article-title><source>Frontiers in Neuroanatomy</source><year>2009</year><volume>3</volume><pub-id pub-id-type="doi">10.3389/neuro.05.001.2009</pub-id><pub-id pub-id-type="pmcid">PMC2629710</pub-id><pub-id pub-id-type="pmid">19169410</pub-id></element-citation></ref><ref id="R36"><label>36</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Levy</surname><given-names>RB</given-names></name><name><surname>Reyes</surname><given-names>AD</given-names></name></person-group><article-title>Spatial profile of excitatory and inhibitory synaptic connectivity in mouse primary auditory cortex</article-title><source>Journal of Neuroscience</source><year>2012</year><volume>32</volume><issue>16</issue><fpage>5609</fpage><lpage>5619</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.5158-11.2012</pub-id><pub-id pub-id-type="pmcid">PMC3359703</pub-id><pub-id pub-id-type="pmid">22514322</pub-id></element-citation></ref><ref id="R37"><label>37</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Campagnola</surname><given-names>L</given-names></name><name><surname>Seeman</surname><given-names>SC</given-names></name><name><surname>Chartrand</surname><given-names>T</given-names></name><name><surname>Kim</surname><given-names>L</given-names></name><name><surname>Hoggarth</surname><given-names>A</given-names></name><name><surname>Gamlin</surname><given-names>C</given-names></name><name><surname>Ito</surname><given-names>S</given-names></name><name><surname>Trinh</surname><given-names>J</given-names></name><name><surname>Davoudian</surname><given-names>P</given-names></name><name><surname>Radaelli</surname><given-names>C</given-names></name><etal/></person-group><article-title>Local connectivity and synaptic dynamics in mouse and human neocortex</article-title><source>Science</source><year>2022</year><volume>375</volume><issue>6585</issue><elocation-id>eabj5861</elocation-id><pub-id pub-id-type="doi">10.1126/science.abj5861</pub-id><pub-id pub-id-type="pmcid">PMC9970277</pub-id><pub-id pub-id-type="pmid">35271334</pub-id></element-citation></ref><ref id="R38"><label>38</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Douglas</surname><given-names>RJ</given-names></name><name><surname>Martin</surname><given-names>KAC</given-names></name></person-group><article-title>Neuronal circuits of the neocortex</article-title><source>Annual Review of Neuroscience</source><year>2004</year><volume>27</volume><pub-id pub-id-type="pmid">15217339</pub-id></element-citation></ref><ref id="R39"><label>39</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Patiño</surname><given-names>M</given-names></name><name><surname>Rossa</surname><given-names>MA</given-names></name><name><surname>Lagos</surname><given-names>WN</given-names></name><name><surname>Patne</surname><given-names>NS</given-names></name><name><surname>Callaway</surname><given-names>EM</given-names></name></person-group><article-title>Transcriptomic cell-type specificity of local cortical circuits</article-title><source>Neuron</source><year>2024</year><volume>112</volume><issue>23</issue><fpage>3851</fpage><lpage>3866</lpage><elocation-id>e4</elocation-id><pub-id pub-id-type="doi">10.1016/j.neuron.2024.09.003</pub-id><pub-id pub-id-type="pmcid">PMC11624072</pub-id><pub-id pub-id-type="pmid">39353431</pub-id></element-citation></ref><ref id="R40"><label>40</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pfeffer</surname><given-names>CK</given-names></name><name><surname>Xue</surname><given-names>M</given-names></name><name><surname>He</surname><given-names>M</given-names></name><name><surname>Huang</surname><given-names>ZJ</given-names></name><name><surname>Scanziani</surname><given-names>M</given-names></name></person-group><article-title>Inhibition of inhibition in visual cortex: the logic of connections between molecularly distinct interneurons</article-title><source>Nature Neuroscience</source><year>2013</year><volume>16</volume><issue>8</issue><fpage>1068</fpage><lpage>1076</lpage><pub-id pub-id-type="doi">10.1038/nn.3446</pub-id><pub-id pub-id-type="pmcid">PMC3729586</pub-id><pub-id pub-id-type="pmid">23817549</pub-id></element-citation></ref><ref id="R41"><label>41</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>Q</given-names></name><name><surname>Burkhalter</surname><given-names>A</given-names></name></person-group><article-title>Area map of mouse visual cortex</article-title><source>The Journal of Comparative Neurology</source><year>2007</year><volume>502</volume><issue>3</issue><fpage>339</fpage><lpage>357</lpage><pub-id pub-id-type="pmid">17366604</pub-id></element-citation></ref><ref id="R42"><label>42</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kalatsky</surname><given-names>VA</given-names></name><name><surname>Stryker</surname><given-names>MP</given-names></name></person-group><article-title>New paradigm for optical imaging: temporally encoded maps of intrinsic signal</article-title><source>Neuron</source><year>2003</year><volume>38</volume><issue>4</issue><fpage>529</fpage><lpage>545</lpage><pub-id pub-id-type="pmcid">PMC2562623</pub-id><pub-id pub-id-type="pmid">12765606</pub-id></element-citation></ref><ref id="R43"><label>43</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Garrett</surname><given-names>ME</given-names></name><name><surname>Nauhaus</surname><given-names>I</given-names></name><name><surname>Marshel</surname><given-names>JH</given-names></name><name><surname>Callaway</surname><given-names>EM</given-names></name></person-group><article-title>Topography and areal organization of mouse visual cortex</article-title><source>The Journal of Neuroscience</source><year>2014</year><volume>34</volume><issue>37</issue><fpage>12587</fpage><lpage>12600</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.1124-14.2014</pub-id><pub-id pub-id-type="pmcid">PMC4160785</pub-id><pub-id pub-id-type="pmid">25209296</pub-id></element-citation></ref><ref id="R44"><label>44</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Waters</surname><given-names>J</given-names></name><name><surname>Lee</surname><given-names>E</given-names></name><name><surname>Gaudreault</surname><given-names>N</given-names></name><name><surname>Griffin</surname><given-names>F</given-names></name><name><surname>Lecoq</surname><given-names>J</given-names></name><name><surname>Slaughterbeck</surname><given-names>C</given-names></name><name><surname>Sullivan</surname><given-names>D</given-names></name><name><surname>Farrell</surname><given-names>C</given-names></name><name><surname>Perkins</surname><given-names>J</given-names></name><name><surname>Reid</surname><given-names>D</given-names></name><etal/></person-group><article-title>Biological variation in the sizes, shapes and locations of visual cortical areas in the mouse</article-title><source>PLOS ONE</source><year>2019</year><volume>14</volume><issue>5</issue><fpage>1</fpage><lpage>13</lpage><pub-id pub-id-type="doi">10.1371/journal.pone.0213924</pub-id><pub-id pub-id-type="pmcid">PMC6493719</pub-id><pub-id pub-id-type="pmid">31042712</pub-id></element-citation></ref><ref id="R45"><label>45</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kebschull</surname><given-names>JM</given-names></name><name><surname>Zador</surname><given-names>AM</given-names></name></person-group><article-title>Sources of PCR-induced distortions in high-throughput sequencing data sets</article-title><source>Nucleic Acids Research</source><year>2015</year><volume>43</volume><issue>21</issue><fpage>e143</fpage><pub-id pub-id-type="doi">10.1093/nar/gkv717</pub-id><pub-id pub-id-type="pmcid">PMC4666380</pub-id><pub-id pub-id-type="pmid">26187991</pub-id></element-citation></ref><ref id="R46"><label>46</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ballesteros-Yáñez</surname><given-names>I</given-names></name><name><surname>Benavides-Piccione</surname><given-names>R</given-names></name><name><surname>Elston</surname><given-names>GN</given-names></name><name><surname>Yuste</surname><given-names>R</given-names></name><name><surname>DeFelipe</surname><given-names>J</given-names></name></person-group><article-title>Density and morphology of dendritic spines in mouse neocortex</article-title><source>Neuroscience</source><year>2006</year><volume>138</volume><issue>2</issue><fpage>403</fpage><lpage>409</lpage><pub-id pub-id-type="pmid">16457955</pub-id></element-citation></ref><ref id="R47"><label>47</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Markram</surname><given-names>H</given-names></name><name><surname>Lübke</surname><given-names>J</given-names></name><name><surname>Frotscher</surname><given-names>M</given-names></name><name><surname>Roth</surname><given-names>A</given-names></name><name><surname>Sakmann</surname><given-names>B</given-names></name></person-group><article-title>Physiology and anatomy of synaptic connections between thick tufted pyramidal neurones in the developing rat neocortex</article-title><source>The Journal of Physiology</source><year>1997</year><volume>500</volume><issue>Pt 2</issue><fpage>409</fpage><lpage>440</lpage><comment>Pt 2</comment><pub-id pub-id-type="doi">10.1113/jphysiol.1997.sp022031</pub-id><pub-id pub-id-type="pmcid">PMC1159394</pub-id><pub-id pub-id-type="pmid">9147328</pub-id></element-citation></ref><ref id="R48"><label>48</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Osakada</surname><given-names>F</given-names></name><name><surname>Callaway</surname><given-names>EM</given-names></name></person-group><article-title>Design and generation of recombinant rabies virus vectors</article-title><source>Nature Protocols</source><year>2013</year><volume>8</volume><issue>8</issue><fpage>1583</fpage><lpage>1601</lpage><pub-id pub-id-type="doi">10.1038/nprot.2013.094</pub-id><pub-id pub-id-type="pmcid">PMC4028848</pub-id><pub-id pub-id-type="pmid">23887178</pub-id></element-citation></ref><ref id="R49"><label>49</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>Y</given-names></name><name><surname>Bergelson</surname><given-names>S</given-names></name><name><surname>Feschenko</surname><given-names>M</given-names></name></person-group><article-title>Determination of lentiviral infectious titer by a novel droplet digital PCR method</article-title><source>Human Gene Therapy Methods</source><year>2018</year><volume>29</volume><issue>2</issue><fpage>96</fpage><lpage>103</lpage><pub-id pub-id-type="pmid">29378428</pub-id></element-citation></ref><ref id="R50"><label>50</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kebschull</surname><given-names>JM</given-names></name><name><surname>Garcia da Silva</surname><given-names>P</given-names></name><name><surname>Reid</surname><given-names>AP</given-names></name><name><surname>Peikon</surname><given-names>ID</given-names></name><name><surname>Albeanu</surname><given-names>DF</given-names></name><name><surname>Zador</surname><given-names>AM</given-names></name></person-group><article-title>High-throughput mapping of single-neuron projections by sequencing of barcoded RNA</article-title><source>Neuron</source><year>2016</year><volume>91</volume><issue>5</issue><fpage>975</fpage><lpage>987</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2016.07.036</pub-id><pub-id pub-id-type="pmcid">PMC6640135</pub-id><pub-id pub-id-type="pmid">27545715</pub-id></element-citation></ref><ref id="R51"><label>51</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Langmead</surname><given-names>B</given-names></name><name><surname>Salzberg</surname><given-names>SL</given-names></name></person-group><article-title>Fast gapped-read alignment with Bowtie 2</article-title><source>Nature Methods</source><year>2012</year><volume>9</volume><issue>4</issue><fpage>357</fpage><lpage>359</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1923</pub-id><pub-id pub-id-type="pmcid">PMC3322381</pub-id><pub-id pub-id-type="pmid">22388286</pub-id></element-citation></ref><ref id="R52"><label>52</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mayerich</surname><given-names>D</given-names></name><name><surname>Abbott</surname><given-names>L</given-names></name><name><surname>McCormick</surname><given-names>B</given-names></name></person-group><article-title>Knife-edge scanning microscopy for imaging and reconstruction of three-dimensional anatomical structures of the mouse brain</article-title><source>Journal of Microscopy</source><year>2008</year><volume>231</volume><issue>1</issue><fpage>134</fpage><lpage>143</lpage><pub-id pub-id-type="pmid">18638197</pub-id></element-citation></ref><ref id="R53"><label>53</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ragan</surname><given-names>T</given-names></name><name><surname>Kadiri</surname><given-names>LR</given-names></name><name><surname>Venkataraju</surname><given-names>KU</given-names></name><name><surname>Bahlmann</surname><given-names>K</given-names></name><name><surname>Sutin</surname><given-names>J</given-names></name><name><surname>Taranda</surname><given-names>J</given-names></name><name><surname>Arganda-Carreras</surname><given-names>I</given-names></name><name><surname>Kim</surname><given-names>Y</given-names></name><name><surname>Seung</surname><given-names>HS</given-names></name><name><surname>Osten</surname><given-names>P</given-names></name></person-group><article-title>Serial two-photon tomography: an automated method for ex-vivo mouse brain imaging</article-title><source>Nature methods</source><year>2012</year><volume>9</volume><issue>3</issue><fpage>255</fpage><lpage>258</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1854</pub-id><pub-id pub-id-type="pmcid">PMC3297424</pub-id><pub-id pub-id-type="pmid">22245809</pub-id></element-citation></ref><ref id="R54"><label>54</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Campbell</surname><given-names>R</given-names></name></person-group><article-title>SainsburyWellcomeCentre/BakingTray: Jan 2020</article-title><source>Zenodo</source><year>2020</year><pub-id pub-id-type="doi">10.5281/zenodo.3631610</pub-id></element-citation></ref><ref id="R55"><label>55</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Campbell</surname><given-names>R</given-names></name><name><surname>Blot</surname><given-names>A</given-names></name><name><surname>Lguerard</surname></name></person-group><article-title>SainsburyWellcomeCentre/StitchIt: Last release of stitching model 1</article-title><source>Zenodo</source><year>2020</year><pub-id pub-id-type="doi">10.5281/zenodo.3941901</pub-id></element-citation></ref><ref id="R56"><label>56</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tyson</surname><given-names>AL</given-names></name><name><surname>Rousseau</surname><given-names>CV</given-names></name><name><surname>Niedworok</surname><given-names>CJ</given-names></name><name><surname>Keshavarzi</surname><given-names>S</given-names></name><name><surname>Tsitoura</surname><given-names>C</given-names></name><name><surname>Cossell</surname><given-names>L</given-names></name><name><surname>Strom</surname><given-names>M</given-names></name><name><surname>Margrie</surname><given-names>TW</given-names></name></person-group><article-title>A deep learning algorithm for 3D cell detection in whole mouse brain image datasets</article-title><source>PLOS Computational Biology</source><year>2021</year><volume>17</volume><issue>5</issue><elocation-id>e1009074</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1009074</pub-id><pub-id pub-id-type="pmcid">PMC8191998</pub-id><pub-id pub-id-type="pmid">34048426</pub-id></element-citation></ref><ref id="R57"><label>57</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Qian</surname><given-names>X</given-names></name><name><surname>Harris</surname><given-names>KD</given-names></name><name><surname>Hauling</surname><given-names>T</given-names></name><name><surname>Nicoloutsopoulos</surname><given-names>D</given-names></name><name><surname>Muñoz-Manchado</surname><given-names>AB</given-names></name><name><surname>Skene</surname><given-names>N</given-names></name><name><surname>Hjerling-Leffler</surname><given-names>J</given-names></name><name><surname>Nilsson</surname><given-names>M</given-names></name></person-group><article-title>Probabilistic cell typing enables fine mapping of closely related cell types in situ</article-title><source>Nature Methods</source><year>2020</year><volume>17</volume><issue>1</issue><fpage>101</fpage><lpage>106</lpage><pub-id pub-id-type="doi">10.1038/s41592-019-0631-4</pub-id><pub-id pub-id-type="pmcid">PMC6949128</pub-id><pub-id pub-id-type="pmid">31740815</pub-id></element-citation></ref><ref id="R58"><label>58</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Patiño</surname><given-names>M</given-names></name><name><surname>Lagos</surname><given-names>WN</given-names></name><name><surname>Patne</surname><given-names>NS</given-names></name><name><surname>Tasic</surname><given-names>B</given-names></name><name><surname>Zeng</surname><given-names>H</given-names></name><name><surname>Callaway</surname><given-names>EM</given-names></name></person-group><article-title>Single-cell transcriptomic classification of rabies-infected cortical neurons</article-title><source>Proceedings of the National Academy of Sciences</source><year>2022</year><volume>119</volume><issue>22</issue><elocation-id>e2203677119</elocation-id><pub-id pub-id-type="doi">10.1073/pnas.2203677119</pub-id><pub-id pub-id-type="pmcid">PMC9295789</pub-id><pub-id pub-id-type="pmid">35609197</pub-id></element-citation></ref><ref id="R59"><label>59</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Edelstein</surname><given-names>A</given-names></name><name><surname>Amodaj</surname><given-names>N</given-names></name><name><surname>Hoover</surname><given-names>K</given-names></name><name><surname>Vale</surname><given-names>R</given-names></name><name><surname>Stuurman</surname><given-names>N</given-names></name></person-group><article-title>Computer control of microscopes using µManager</article-title><source>Current Protocols in Molecular Biology</source><year>2010</year><volume>92</volume><issue>1</issue><fpage>14201</fpage><lpage>142017</lpage><pub-id pub-id-type="doi">10.1002/0471142727.mb1420s92</pub-id><pub-id pub-id-type="pmcid">PMC3065365</pub-id><pub-id pub-id-type="pmid">20890901</pub-id></element-citation></ref><ref id="R60"><label>60</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pinkard</surname><given-names>H</given-names></name><name><surname>Stuurman</surname><given-names>N</given-names></name><name><surname>Ivanov</surname><given-names>IE</given-names></name><name><surname>Anthony</surname><given-names>NM</given-names></name><name><surname>Ouyang</surname><given-names>W</given-names></name><name><surname>Li</surname><given-names>B</given-names></name><name><surname>Yang</surname><given-names>B</given-names></name><name><surname>Tsuchida</surname><given-names>MA</given-names></name><name><surname>Chhun</surname><given-names>B</given-names></name><name><surname>Zhang</surname><given-names>G</given-names></name><etal/></person-group><article-title>Pycro-Manager: open-source software for customized and reproducible microscope control</article-title><source>Nature Methods</source><year>2021</year><volume>18</volume><issue>3</issue><fpage>226</fpage><lpage>228</lpage><pub-id pub-id-type="doi">10.1038/s41592-021-01087-6</pub-id><pub-id pub-id-type="pmcid">PMC8532176</pub-id><pub-id pub-id-type="pmid">33674797</pub-id></element-citation></ref><ref id="R61"><label>61</label><element-citation publication-type="confproc"><person-group person-group-type="author"><name><surname>Pati</surname><given-names>Y</given-names></name><name><surname>Rezaiifar</surname><given-names>R</given-names></name><name><surname>Krishnaprasad</surname><given-names>P</given-names></name></person-group><source>Orthogonal matching pursuit: recursive function approximation with applications to wavelet decomposition</source><conf-name>Proceedings of 27th Asilomar Conference on Signals, Systems and Computers</conf-name><year>1993</year><month>November</month><volume>1</volume><fpage>40</fpage><lpage>44</lpage><comment>ISSN: 1058-6393</comment><pub-id pub-id-type="doi">10.1109/ACSSC.1993.342465</pub-id></element-citation></ref><ref id="R62"><label>62</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Padfield</surname><given-names>D</given-names></name></person-group><article-title>Masked object registration in the Fourier domain</article-title><source>IEEE Transactions on Image Processing</source><year>2012</year><volume>21</volume><issue>5</issue><fpage>2706</fpage><lpage>2718</lpage><pub-id pub-id-type="pmid">22203712</pub-id></element-citation></ref><ref id="R63"><label>63</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Carey</surname><given-names>H</given-names></name><name><surname>Pegios</surname><given-names>M</given-names></name><name><surname>Martin</surname><given-names>L</given-names></name><name><surname>Saleeba</surname><given-names>C</given-names></name><name><surname>Turner</surname><given-names>AJ</given-names></name><name><surname>Everett</surname><given-names>NA</given-names></name><name><surname>Bjerke</surname><given-names>IE</given-names></name><name><surname>Puchades</surname><given-names>MA</given-names></name><name><surname>Bjaalie</surname><given-names>JG</given-names></name><name><surname>McMullan</surname><given-names>S</given-names></name></person-group><article-title>DeepSlice: rapid fully automatic registration of mouse brain imaging to a volumetric atlas</article-title><source>Nature Communications</source><year>2023</year><volume>14</volume><issue>1</issue><elocation-id>5884</elocation-id><pub-id pub-id-type="doi">10.1038/s41467-023-41645-4</pub-id><pub-id pub-id-type="pmcid">PMC10514056</pub-id><pub-id pub-id-type="pmid">37735467</pub-id></element-citation></ref><ref id="R64"><label>64</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Klein</surname><given-names>S</given-names></name><name><surname>Staring</surname><given-names>M</given-names></name><name><surname>Murphy</surname><given-names>K</given-names></name><name><surname>Viergever</surname><given-names>M</given-names></name><name><surname>Pluim</surname><given-names>J</given-names></name></person-group><article-title>elastix: a toolbox for intensity-based medical image registration</article-title><source>IEEE Transactions on Medical Imaging</source><year>2010</year><volume>29</volume><issue>1</issue><fpage>196</fpage><lpage>205</lpage><pub-id pub-id-type="pmid">19923044</pub-id></element-citation></ref><ref id="R65"><label>65</label><element-citation publication-type="confproc"><person-group person-group-type="author"><name><surname>Bogovic</surname><given-names>JA</given-names></name><name><surname>Hanslovsky</surname><given-names>P</given-names></name><name><surname>Wong</surname><given-names>A</given-names></name><name><surname>Saalfeld</surname><given-names>S</given-names></name></person-group><source>Robust registration of calcium images by learned contrast synthesis</source><conf-name>2016 IEEE 13th International Symposium on Biomedical Imaging (ISBI)</conf-name><year>2016</year><month>April</month><fpage>1123</fpage><lpage>1126</lpage><comment>ISSN: 1945-8452</comment><pub-id pub-id-type="doi">10.1109/ISBI.2016.7493463</pub-id></element-citation></ref><ref id="R66"><label>66</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Claudi</surname><given-names>F</given-names></name><name><surname>Petrucco</surname><given-names>L</given-names></name><name><surname>Tyson</surname><given-names>AL</given-names></name><name><surname>Branco</surname><given-names>T</given-names></name><name><surname>Margrie</surname><given-names>TW</given-names></name><name><surname>Portugues</surname><given-names>R</given-names></name></person-group><article-title>BrainGlobe Atlas API: a common interface for neuroanatomical atlases</article-title><source>Journal of Open Source Software</source><year>2020</year><volume>5</volume><issue>54</issue><elocation-id>2668</elocation-id><pub-id pub-id-type="doi">10.21105/joss.02668</pub-id></element-citation></ref><ref id="R67"><label>67</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stringer</surname><given-names>C</given-names></name><name><surname>Pachitariu</surname><given-names>M</given-names></name></person-group><article-title>Cellpose3: one-click image restoration for improved cellular segmentation</article-title><source>Nature Methods</source><year>2025</year><volume>22</volume><issue>3</issue><fpage>592</fpage><lpage>599</lpage><pub-id pub-id-type="doi">10.1038/s41592-025-02595-5</pub-id><pub-id pub-id-type="pmcid">PMC11903308</pub-id><pub-id pub-id-type="pmid">39939718</pub-id></element-citation></ref><ref id="R68"><label>68</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolf</surname><given-names>FA</given-names></name><name><surname>Angerer</surname><given-names>P</given-names></name><name><surname>Theis</surname><given-names>FJ</given-names></name></person-group><article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title><source>Genome Biology</source><year>2018</year><volume>19</volume><issue>1</issue><fpage>15</fpage><pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id><pub-id pub-id-type="pmcid">PMC5802054</pub-id><pub-id pub-id-type="pmid">29409532</pub-id></element-citation></ref><ref id="R69"><label>69</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Traag</surname><given-names>VA</given-names></name><name><surname>Waltman</surname><given-names>L</given-names></name><name><surname>van Eck</surname><given-names>NJ</given-names></name></person-group><article-title>From Louvain to Leiden: guaranteeing well-connected communities</article-title><source>Scientific Reports</source><year>2019</year><volume>9</volume><issue>1</issue><elocation-id>5233</elocation-id><pub-id pub-id-type="doi">10.1038/s41598-019-41695-z</pub-id><pub-id pub-id-type="pmcid">PMC6435756</pub-id><pub-id pub-id-type="pmid">30914743</pub-id></element-citation></ref><ref id="R70"><label>70</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McInnes</surname><given-names>L</given-names></name><name><surname>Healy</surname><given-names>J</given-names></name><name><surname>Melville</surname><given-names>J</given-names></name></person-group><article-title>UMAP: Uniform Manifold Approximation and Projection for dimension reduction</article-title><source>arXiv:1802.03426 [stat]</source><year>2020</year><month>September</month></element-citation></ref><ref id="R71"><label>71</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Herculano-Houzel</surname><given-names>S</given-names></name><name><surname>Watson</surname><given-names>CR</given-names></name><name><surname>Paxinos</surname><given-names>G</given-names></name></person-group><article-title>Distribution of neurons in functional areas of the mouse cerebral cortex reveals quantitatively different cortical zones</article-title><source>Frontiers in Neuroanatomy</source><year>2013</year><volume>7</volume><pub-id pub-id-type="doi">10.3389/fnana.2013.00035</pub-id><pub-id pub-id-type="pmcid">PMC3800983</pub-id><pub-id pub-id-type="pmid">24155697</pub-id></element-citation></ref><ref id="R72"><label>72</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Murakami</surname><given-names>TC</given-names></name><name><surname>Mano</surname><given-names>T</given-names></name><name><surname>Saikawa</surname><given-names>S</given-names></name><name><surname>Horiguchi</surname><given-names>SA</given-names></name><name><surname>Shigeta</surname><given-names>D</given-names></name><name><surname>Baba</surname><given-names>K</given-names></name><name><surname>Sekiya</surname><given-names>H</given-names></name><name><surname>Shimizu</surname><given-names>Y</given-names></name><name><surname>Tanaka</surname><given-names>KF</given-names></name><name><surname>Kiyonari</surname><given-names>H</given-names></name><etal/></person-group><article-title>A three-dimensional single-cell-resolution whole-brain atlas using CUBIC-X expansion microscopy and tissue clearing</article-title><source>Nature Neuroscience</source><year>2018</year><volume>21</volume><issue>4</issue><fpage>625</fpage><lpage>637</lpage><pub-id pub-id-type="pmid">29507408</pub-id></element-citation></ref><ref id="R73"><label>73</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Huang</surname><given-names>L</given-names></name><name><surname>Kebschull</surname><given-names>JM</given-names></name><name><surname>Fürth</surname><given-names>D</given-names></name><name><surname>Musall</surname><given-names>S</given-names></name><name><surname>Kaufman</surname><given-names>MT</given-names></name><name><surname>Churchland</surname><given-names>AK</given-names></name><name><surname>Zador</surname><given-names>AM</given-names></name></person-group><article-title>BRICseq bridges brain-wide interregional connectivity to neural activity and gene expression in single animals</article-title><source>Cell</source><year>2020</year><volume>182</volume><issue>1</issue><fpage>177</fpage><lpage>188</lpage><elocation-id>e27</elocation-id><pub-id pub-id-type="doi">10.1016/j.cell.2020.05.029</pub-id><pub-id pub-id-type="pmcid">PMC7771207</pub-id><pub-id pub-id-type="pmid">32619423</pub-id></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Fig. 1</label><caption><title>Generation and delivery of barcoded rabies virus libraries.</title><p><bold>a</bold>, BRISC experimental outline. <bold>b</bold>, Barcoded rabies virus genome plasmid schematic. The barcode was integrated in the 3’ UTR of the mCherry transgene inserted in place of the G glycoprotein gene. The HDVagrz ribozyme was replaced with a supercutter version to ensure the correct 3’ terminus of the rabies genome transcript. <bold>c</bold>, Barcode abundance distribution of plasmid and viral libraries. Barcodes are sorted according to their abundance in the sequencing library, estimated using unique molecular identifiers (see <xref ref-type="sec" rid="S10">Methods</xref>). <bold>d</bold>, Proportion of uniquely labeled starter neurons as a function of the number of independent infections. The barcoded viral library has sufficient complexity to label &gt;1,000 starter cells. <bold>e-f</bold>, Library complexity and the number of neurons that can be uniquely labeled with a library depend on the library production scale. <bold>g</bold>, Predicted relationship between the density of starter neurons and the frequency of barcode transmission between them. For 20 presynaptic cells per starter, the 5% probability of spread between starters (horizontal dashed line) corresponds to 384 cells per mm<sup>3</sup> (vertical dashed line). <bold>h</bold>, mCherry fluorescence in a section of mouse brain infected with the barcoded rabies virus library in the primary visual cortex, imaged using serial two-photon tomography. Maximum intensity projection over 0.5 mm. Scale bar – 1 mm. <bold>i</bold>, Identification of starter neurons based on nuclear mCherry fluorescence in a confocal microscopy image (maximum intensity projection spanning 4.8 µm, blue – DAPI, red and green – mCherry channel with different contrast limits, see <xref ref-type="sec" rid="S10">Methods</xref>). Scale bar – 20 µm. <bold>j</bold>, Density of rabies-infected neurons as a function of distance to the injection site. <bold>k</bold>, mCherry fluorescence in a section of mouse visual cortex infected locally with Cre-dependent AAV helper virus and either an intracerebral or intravenous injection of AAV-Cre. <bold>l</bold>, Spatial distribution of detected mCherry cells from intracerebral or intravenous AAV-Cre injections. <bold>m</bold>, Kernel density estimates (KDEs) of the distribution of pairwise distances between mCherry-positive cells in intracerebral and intravenous AAV-Cre injections, median distances (triangles) – 0.20 mm, 256 cells, and 0.35 mm, 114 cells respectively.</p></caption><graphic xlink:href="EMS207403-f001"/></fig><fig id="F2" position="float"><label>Fig. 2</label><caption><title>Sequencing rabies virus barcodes <italic>in situ</italic>.</title><p><bold>a</bold>, Virus injection timeline. Three injections were arranged along the mediolateral extent of primary visual cortex at the same anterior-posterior location. <bold>b</bold>, Schematic of the protocol for sequencing rabies virus barcodes alongside cell type marker transcripts. <bold>c</bold>, Extent of the <italic>in situ</italic> sequencing volume in the mouse brain. <bold>d</bold>, Nuclear mCherry fluorescence identifies starter neurons expressing G glycoprotein. Scale bar – 50 µm. <bold>e</bold>, Example sequencing round during <italic>in situ</italic> sequencing of cell type marker transcripts. Scale bar – 50 µm. <bold>f</bold>, Example sequencing round of rabies virus barcodes. Dashed and solid rectangles indicate the image regions depicted in <bold>d</bold>,<bold>e</bold> and <bold>g</bold>, respectively. Scale bar – 250 µm. <bold>g</bold>, Three example neurons infected with barcoded rabies virus across sequencing rounds. Scale bar – 20 µm. <bold>h</bold>, UMAP representation of cell type marker gene expression across cells, color-coded according to their assigned cell type. <bold>i</bold>, Distribution of rabies-infected cells in UMAP space.</p></caption><graphic xlink:href="EMS207403-f002"/></fig><fig id="F3" position="float"><label>Fig. 3</label><caption><title>Specificity and sensitivity of <italic>in situ</italic> barcode detection.</title><p><bold>a</bold>, Number of barcodes detected in individual presynaptic and starter neurons. Most presynaptic neurons express a single barcode, while some starter neurons express &gt;1. <bold>b</bold>, Barcodes detected <italic>in situ</italic> (solid blue line) reflect the abundance distribution of the viral library (black). In contrast, random barcodes (dashed blue line) were rarely found in the library and typically match low abundance barcodes. <bold>c</bold>, Number of starter cells per detected barcode sequence. <bold>d</bold>, Number of presynaptic cells for orphan barcodes and barcodes found in at least one starter. Orphan barcodes are typically found in a small number of cells. <bold>e</bold>, Number of barcode transcripts detected in rabies-infected neurons identified using probes targeting rabies viral transcripts. Dotted line indicates cells with &lt;3 barcode spots. Inset image shows rabies viral transcripts in red and rabies barcode transcripts in cyan. Scale bar – 20 µm. <bold>f</bold>, mCherry fluorescence intensity in starter neurons is correlated with the efficiency of transsynaptic spread (r=0.30, p=2.6 × 10<sup>-9</sup> for Pearson correlation of log-fluorescence and log (number of presynaptic cells + 1), n = 377 starters).</p></caption><graphic xlink:href="EMS207403-f003"/></fig><fig id="F4" position="float"><label>Fig. 4</label><caption><title>Presynaptic ensembles of barcoded starter neurons.</title><p><bold>a</bold>, Spatial location of starter neurons (black) and presynaptic cells. Presynaptic cells are color-coded according to brain area. Left – coronal projection, area outlines correspond to the coronal plane at the center of the sequencing volume, right – cortical flatmap. Scale bar – 1 mm. <bold>b</bold>, KDEs of the layer distribution of starter and presynaptic neurons in V1 in cortical flatmap coordinates. <bold>c</bold>, Number of starter cells connected to each presynaptic cell. <bold>d</bold>, Barcodes present in presynaptic cells for starter cells expressing multiple unique barcodes. Starter cells almost always only transmit one barcode to presynaptic neurons. <bold>e</bold>, Spatial location of starter and presynaptic neurons for 4 example barcodes. Left – coronal projection, right – cortical flatmap centered on the visual cortex. Scale bar – 1 mm. <bold>f</bold>, Location of presynaptic cells relative to starter neurons in cortical flatmap coordinates compared to shuffle control. <bold>g</bold>, KDE of relative mediolateral location of presynaptic cells with respect to starter cells. Presynaptic cells are clustered near starter cells. Shaded area indicates 95% confidence interval of the shuffle control (see <xref ref-type="sec" rid="S10">Methods</xref>).</p></caption><graphic xlink:href="EMS207403-f004"/></fig><fig id="F5" position="float"><label>Fig. 5</label><caption><title>BRISC reveals layer- and cell-type-specific connectivity patterns.</title><p><bold>a</bold>, Relative mediolateral location and cortical depth of presynaptic cells connected to starter neurons across cortical layers in cortical flatmap coordinates. Black – starter cells; red – presynaptic cells. Scale bar – 200 µm. <bold>b</bold>, Number of presynaptic neurons for starter cells across cortical layers (left) and their input fractions (right). <bold>c</bold>, Input fractions for starter cells across cortical layers, including 95% confidence intervals computed by bootstrap resampling starter cells. <bold>d</bold>, Graphical representation of input fractions in <bold>b-c</bold>. Only connections representing &gt;0.2 of inputs to a given starter population are shown. Arrow width is proportional to connection strength; color represents the width of the confidence interval. <bold>e</bold>, Input fraction compared to shuffle control. The radius of the bubbles indicates effect size, i.e., the log-ratio of observed and shuffle control input fractions. The color of the bubbles indicates significance and direction of the effect, with red and blue hues representing over- and under-representation compared to shuffle control, respectively. Solid outline indicates statistical significance (false discovery rate of 0.05). <bold>f</bold>, Output fraction across cortical layers. <bold>g</bold>, Output fraction compared to shuffle control. Notation as in panel <bold>d. h</bold>, Inhibitory cell type marker gene expression across <italic>Pvalb, Sst, Lamp5</italic>, and <italic>Vip</italic> interneurons. Mean normalized and log1p-transformed expression of each gene was rescaled to 1 across cell-type clusters. <bold>i</bold>, Number of presynaptic interneurons (left) and input fraction (right) of starter neurons across interneuron classes. <bold>j</bold>, Graphical representation of input fractions in <bold>i</bold>. Notation as in <bold>d</bold>.</p></caption><graphic xlink:href="EMS207403-f005"/></fig><fig id="F6" position="float"><label>Fig. 6</label><caption><title>BRISC identifies topographic organization of long-range inputs onto single neurons.</title><p><bold>a</bold>, Flatmap projection of the location of presynaptic neurons connected to V1 starter cells, color-coded by the mediolateral (ML) position of their starter cells in flatmap coordinates. Scale bar – 1 mm. <bold>b</bold>, Starter cells color-coded by their ML position on the flatmap projection. Gray – all presynaptic cells. <bold>c</bold>, Map of average starter ML position for all cells in <bold>a. d</bold>, Visual azimuth map of cortical visual areas based on data from Waters et al. (<xref ref-type="bibr" rid="R44">44</xref>) (see <xref ref-type="sec" rid="S10">Methods</xref>). <bold>e</bold>, Starter cell ML position as a function of the presynaptic cell position. Black – individual cells, purple – gaussian kernel density estimate. Shading indicates 95% confidence intervals computed by bootstrap resampling of starter cells. <bold>f</bold>, Expected preferred receptive azimuth of presynaptic cells given their spatial location (see <xref ref-type="sec" rid="S10">Methods</xref>).</p></caption><graphic xlink:href="EMS207403-f006"/></fig></floats-group></article>