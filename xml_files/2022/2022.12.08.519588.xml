<!DOCTYPE article
 PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" article-type="preprint"><?all-math-mml yes?><?use-mml?><?origin ukpmcpa?><front><journal-meta><journal-id journal-id-type="nlm-ta">bioRxiv</journal-id><journal-title-group><journal-title>bioRxiv : the preprint server for biology</journal-title></journal-title-group><issn pub-type="ppub"/></journal-meta><article-meta><article-id pub-id-type="manuscript">EMS158385</article-id><article-id pub-id-type="doi">10.1101/2022.12.08.519588</article-id><article-id pub-id-type="archive">PPR581962</article-id><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group><subj-group subj-group-type="europepmc-category"><subject>Covid-19</subject></subj-group></article-categories><title-group><article-title>Atlas-scale single-cell multi-sample multi-condition data integration using scMerge2</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Lin</surname><given-names>Yingxin</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author"><name><surname>Cao</surname><given-names>Yue</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A4">4</xref></contrib><contrib contrib-type="author"><name><surname>Willie</surname><given-names>Elijah</given-names></name><xref ref-type="aff" rid="A1">1</xref></contrib><contrib contrib-type="author"><name><surname>Patrick</surname><given-names>Ellis</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A4">4</xref><xref ref-type="aff" rid="A5">5</xref></contrib><contrib contrib-type="author"><name><surname>Yang</surname><given-names>Jean Y.H.</given-names></name><xref ref-type="aff" rid="A1">1</xref><xref ref-type="aff" rid="A2">2</xref><xref ref-type="aff" rid="A3">3</xref><xref ref-type="aff" rid="A4">4</xref><xref ref-type="corresp" rid="CR1">*</xref></contrib></contrib-group><aff id="A1"><label>1</label>Sydney Precision Data Science Centre, The University of Sydney, NSW, Australia</aff><aff id="A2"><label>2</label>Charles Perkins Centre, The University of Sydney, NSW, Australia</aff><aff id="A3"><label>3</label>School of Mathematics and Statistics, The University of Sydney, NSW, Australia</aff><aff id="A4"><label>4</label>Laboratory of Data Discovery for Health Limited (D24H), Science Park, Hong Kong SAR, China</aff><aff id="A5"><label>5</label>The Westmead Institute for Medical Research, The University of Sydney, NSW 2006, Australia</aff><author-notes><corresp id="CR1">
<label>*</label>To whom correspondence should be addressed. Jean Y.H.Yang, <email>jean.yang@sydney.edu.au</email>.</corresp></author-notes><pub-date pub-type="nihms-submitted"><day>11</day><month>12</month><year>2022</year></pub-date><pub-date pub-type="preprint"><day>08</day><month>12</month><year>2022</year></pub-date><permissions><ali:free_to_read/><license><ali:license_ref>https://creativecommons.org/licenses/by-nc-nd/4.0/</ali:license_ref><license-p>This work is licensed under a <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0 International license</ext-link>.</license-p></license></permissions><abstract><p id="P1">The recent emergence of multi-sample multi-condition single-cell multi-cohort studies allow researchers to investigate different cell states. The effective integration of multiple large-cohort studies promises biological insights into cells under different conditions that individual studies cannot provide. Here, we present scMerge2, a scalable algorithm that allows data integration of atlas-scale multi-sample multi-condition single-cell studies. We have generalised scMerge2 to enable the merging of millions of cells from single-cell studies generated by various single-cell technologies. Using a large COVID-19 data collection with over five million cells from 1000+ individuals, we demonstrate that scMerge2 enables multi-sample multi-condition scRNA-seq data integration from multiple cohorts and reveals signatures derived from cell-type expression that are more accurate in discriminating disease progression. Further, we demonstrate that scMerge2 can remove dataset variability in CyTOF, imaging mass cytometry and CITE-seq experiments, demonstrating its applicability to a broad spectrum of single-cell profiling technologies.</p></abstract></article-meta></front><body><sec id="S1" sec-type="intro"><title>Introduction</title><p id="P2">Technological advances of large-scale single-cell profiling of genes and proteins, such as single-cell RNA-seq (scRNA-seq) [<xref ref-type="bibr" rid="R1">1</xref>], Cytometry by Time-Of-Flight (CyTOF) [<xref ref-type="bibr" rid="R2">2</xref>] and imaging mass cytometry [<xref ref-type="bibr" rid="R3">3</xref>] have exploded in recent years and enabled unprecedented insight into the identity and function of individual cells. This has enabled the discovery of cell-type-specific knowledge and has transformed our understanding of biological systems. This myriad of single-cell data has prompted the recent creation of data atlases that collate single-cell omics data from multiple studies. Examples of large-scale atlases containing over two millions cells are the Human Cell Atlas which aims to map every cell type in the human body [<xref ref-type="bibr" rid="R4">4</xref>]; atlas of gene expression and chromatin accessibility of 4 million human fetal cells across 15 organs [<xref ref-type="bibr" rid="R5">5</xref>, <xref ref-type="bibr" rid="R6">6</xref>]; the Human Tumor Atlas Network [<xref ref-type="bibr" rid="R7">7</xref>] and DISCO [<xref ref-type="bibr" rid="R8">8</xref>], which provides integrated human single-cell omics data across 107 tissues/cell lines/organoids and 158 diseases. These atlases serve as valuable references for the exploration of healthy and diseased cells.</p><p id="P3">As single-cell technologies advance, there are an increasing number of studies around the globe that perform multi-condition and multi-sample large-cohort single-cell profiling to examine persisting questions associated with human health. These datasets enable researchers to delve into biological insights of cells under multiple treatment conditions across multiple individuals. For example, to investigate the cell-type-specific cellular mechanism underlying COVID-19 disease severity [<xref ref-type="bibr" rid="R9">9</xref>] and to predict treatment response to cancer [<xref ref-type="bibr" rid="R10">10</xref>]. Such data and studies are expected to rise in the coming years [<xref ref-type="bibr" rid="R11">11</xref>] in the continuing quest to improve human health. This expected increase necessitates the effective access and joint interpretation of multiple datasets to unleash the power of meta-analysis at single-cell resolution.</p><p id="P4">Last year, benchmarking studies [<xref ref-type="bibr" rid="R12">12</xref>] began to investigate atlas-scale integration. Luecken and colleagues investigated 16 popular data integration technologies on 13 data integration tasks with up to 1 million cells. While significant progress has been achieved in batch correction and data integration over the years (including our research), the increasing scale of cohort sizes and the number of related studies for integration has introduced additional scalability challenges. The new challenge for atlas-scale integration is to have a scalable algorithm that can handle a large number of studies, consisting a large collection samples (thousands) and millions of cells. With the exception of Seurat [<xref ref-type="bibr" rid="R13">13</xref>], SAUCIE [<xref ref-type="bibr" rid="R14">14</xref>] and Scanorama [<xref ref-type="bibr" rid="R15">15</xref>], several of these rapid procedures (deepMNN [<xref ref-type="bibr" rid="R16">16</xref>], BBKNN [<xref ref-type="bibr" rid="R17">17</xref>], Harmony [<xref ref-type="bibr" rid="R18">18</xref>] , scVI [<xref ref-type="bibr" rid="R19">19</xref>], scANVI [<xref ref-type="bibr" rid="R20">20</xref>] and DESC [<xref ref-type="bibr" rid="R21">21</xref>]) focus on extracting the joint embedding and do not return adjusted gene expression matrices. With the growing need for sample level analysis, the lack of adjusted expression matrices restricts the utilisation of such integrative results and diminishes their potency and generalizability. As a result, the next generation of atlas-scale integration algorithms should be capable of integrating a large number of studies and producing consensus cell type maps as well as adjusted expression matrix for further downstream analysis. In particular, these methods need to overcome the computational challenge of integrating over a million cells and create adjusted gene expression matrix for all genes for downstream analysis.</p><p id="P5">To this end, we present scMerge2, a scalable, high-capacity algorithm that allows data integration of atlas-scale multi-sample multi-condition single-cell studies. We achieve this through three key innovations in (i) hierarchical integration to capture both local and global variation between studies; (ii) pseudo-bulk construction to ensure computational scalability; and (iii) pseudoreplication inside each condition to capture signals from multiple conditions. Our new scMerge2 algorithm is able to integrate many millions of cells from single-cell studies generated from various single-cell technologies, including scRNA-seq, CyTOF, and imaging mass cytometry. Leveraging pseudo-bulk to perform factor analysis of stably expressed genes and pseudo-replicates, scMerge2 is able to integrate five million cells from a large COVID-19 data collection with over 1000 samples from 20 studies globally within a day. We further demonstrate that the integration using scMerge2 improves the performance of discriminating distinct cell states in COVID-19 patients with varying degrees of severity and facilitates diverse single-cell downstream analyses.</p></sec><sec id="S2" sec-type="results"><title>Results</title><sec id="S3"><title>scMerge2 effectively integrates single-cell multi-sample, multi-condition data</title><p id="P6">scMerge2 provides a scalable data integration method for the rapid growth of multi-sample, multi-condition single-cell studies. This new extension of scMerge is specifically designed to address unwanted intra- and inter-dataset variation that can overshadow true biological signals between conditions. In our previous study, we introduced scMerge, a novel algorithm that integrates multiple single-cell RNA-seq data by factor analysis of stably expressed genes and pseudoreplicates across datasets and enhances biological discovery, including inferring cell development trajectories [<xref ref-type="bibr" rid="R22">22</xref>]. The integration approach supports diverse integration settings, enabling cross-batch, cross-dataset, and cross-species discoveries. In particular, the semi-supervised aspect of scMerge allows incorporation of prior knowledge facilitated by experimental design.</p><p id="P7">With the rapid emergence of multi-sample multi-condition single-cell studies and the increased number of datasets for integration, our proposed scMerge2 addresses challenges associated with scalability of cells and studies as well as producing analytically ready data (i.e. adjusted expression matrix). This is achieved via three key innovations as illustrated in <xref ref-type="fig" rid="F1">Fig. 1</xref>. First, hierarchical integration is used to capture both local and global variation. This is a clear contrast to the conventional data integration that involves estimating unwanted variation across all datasets as a whole. When integrating across a large collection (over 10) of datasets with different pairwise differences, sequential integration better captures the difference in pairwise variations. Second, pseudo-bulk construction is used to reduce computing load, allowing for the analysis of datasets containing millions of cells. Third, pseduo-replication inside each condition is built, allowing for the modelling of numerous conditions. Details of these components are included in Methods. In essence, scMerge2 takes gene expression matrices from a collection of datasets and integrates them in a hierarchical manner. The final output of scMerge2 is a single adjusted expression matrix with all input data matrices merged and ready for downstream analysis.</p></sec><sec id="S4"><title>scMerge2 outperforms existing integration methods in detecting differential expression</title><p id="P8">We demonstrate the performance of scMerge2 in removing multi-level unwanted variation of multiple scRNA-seq datasets from three aspects. Firstly, to illustrate the effectiveness of the hierarchical integration strategy, we applied scMerge2 to a 200k subset of cells from two COVID-19 studies (Liu and Stephenson) that contain three cohorts/batches within each dataset. We compared the performance of two different scMerge2 settings: scMerge2-h, where we performed intra-study correction before inter-study correction; and scMerge2, where we integrated two datasets (6 batches) in one go. We find that integrating the two studies in a hierarchical manner improves the performance of data integration, especially in terms of revealing the cell type signals (<xref ref-type="fig" rid="F2">Fig. 2a-b</xref>). Compared to the other data integration methods (Seurat, SeuratRPCA, fastMNN, Liger and Harmony), both settings of scMerge2 (scMerge2-h and scMerge2) have overall better performance in achieving the balance of batch effect removal and biological signal preservation, based on the five evaluation metrics that quantify the data integration performance (<xref ref-type="fig" rid="F2">Fig. 2a-b</xref>).</p><p id="P9">Next, we investigate the performance of the adjusted matrix in identifying genes that are differentially expressed between two conditions (termed as differential state (DS) analysis by [<xref ref-type="bibr" rid="R23">23</xref>]) through a simulation study. We generated synthetic single-cell datasets with two batches and multiple samples from two conditions using a simulation framework that extended from scDe-sign3 model [<xref ref-type="bibr" rid="R24">24</xref>], with known ground truth DS genes (<xref ref-type="supplementary-material" rid="SD1">Supp Fig. S1-S2</xref>) (See <xref ref-type="sec" rid="S9">Methods</xref>). Cell-type-specific DS analysis was performed using the limma-trend algorithm [<xref ref-type="bibr" rid="R25">25</xref>] on the sample-wise aggregated data by taking the mean of the log-transformed or adjusted data. By simulating data with different log fold change (1.1 ~ 2) and proportions of DS genes (5% and 10%), we find that scMerge2 substantially outperforms the other two data integration methods that also return adjusted matrices in detecting DS genes (<xref ref-type="fig" rid="F2">Fig. 2c</xref> and <xref ref-type="supplementary-material" rid="SD1">Supp Fig. S3</xref>). scMerge2 has much lower FDR than fastMNN and Seurat, and higher TPR compared to the unadjusted data (<xref ref-type="supplementary-material" rid="SD1">Supp Fig. S4-S5</xref>), illustrating that scMerge2 outputs an adjusted matrix with less unwanted variation for single-cell downstream analysis.</p><p id="P10">Finally, we illustrate the robustness of scMerge2 by varying the key tuning parameters of the algorithm, including the number of unwanted variation factors, the number of pseudo-bulk, the ways of pseudo-bulk construction and the number of nearest neighbours. As shown in <xref ref-type="fig" rid="F2">Fig. 2d</xref> and <xref ref-type="supplementary-material" rid="SD1">Supp Fig. S6</xref>, despite varying the settings in the algorithm, scMerge2 has consistently better performance than the other methods. Together, these results demonstrate the effectiveness and utility of scMerge2 in data integration of scRNA-seq data.</p></sec><sec id="S5"><title>scMerge2 is scalable to integrate five millions COVID-19 PMBC cells</title><p id="P11">To demonstrate the scalability of scMerge2 in integrating multi-sample multi-condition single-cell data, we performed scMerge2 on a COVID-19 data collection of consisting of ~ 5m cells from 1298 samples (963 individuals) PBMC samples from 20 studies worldwide (See <xref ref-type="sec" rid="S9">Methods</xref>). We considered the cell type annotation refined by scClassify as pseudo-replicates information.</p><p id="P12">We also used a hierarchical integration strategy, where we first performed integration of different cohorts within one study respectively (e.g. Ren, Stephenson, Liu and Schulte-Schrepping) and also two studies with distinguished sequencing depth, followed by the integration of 13 studies with small number of cells (hierarchical integration strategy shown in <xref ref-type="supplementary-material" rid="SD1">Supp Fig. S7</xref>). We then integrated all the data in the next step. An inspection of UMAP visualisations shows that scMerge2 effectively integrates the 20 studies, while preserving the multi-level cell type information (<xref ref-type="fig" rid="F3">Fig. 3a</xref>, <xref ref-type="supplementary-material" rid="SD1">Supp Fig. S8</xref>). A UMAP plot faceted by dataset further illustrates the successful removal of dataset induced unwanted variation (<xref ref-type="supplementary-material" rid="SD1">Supp Fig. S9</xref>). The quantitative evaluation metrics further confirm this observation, where we find that scMerge2 reduces the technical variation caused by dataset, protocol and technology, resulting in improved cell type identification (<xref ref-type="fig" rid="F3">Fig. 3b</xref>, <xref ref-type="supplementary-material" rid="SD1">Supp Fig. S10</xref>).</p><p id="P13">To further illustrate the utility of scMerge2, we demonstrate that it improves the prediction of disease severity in the COVID-19 dataset using cell-type-specific expression. Comparing to the original raw log-normalised data, identifying cell types with scMerge2 substantially improves the prediction accuracy rate of disease severity for all cell types that have more than 1% abundance in the data, with a 3.2% increase in accuracy on average (<xref ref-type="fig" rid="F3">Fig. 3c</xref> and <xref ref-type="supplementary-material" rid="SD1">Supp Fig. S11</xref>). Notably, we find that CD14 Monocytes have the highest discriminative power for disease severity among all cell types, and scMerge2 is able to further improve the accuracy rate from 81.3% to 83.6%.</p></sec><sec id="S6"><title>scMerge2 enables differential cell state detection for multi-conditions data</title><p id="P14">We next illustrate how the adjusted expression matrix output from scMerge2 facilitates several downstream analysis of single-cell multi-condition multi-sample studies, including differential abundance analysis and differential expression analysis. As a case study, we focus on the analysis of identification and characterisation of cell states that are distinguished between the moderate and severe patients using COVID-19 data collection. We first calculated the differential abundance score for each cell to quantify the difference between the moderate and severe patients using DASeq [<xref ref-type="bibr" rid="R26">26</xref>]. As shown in <xref ref-type="fig" rid="F4">Fig. 4a-b</xref>, we are able to identify regions on the UMAP plots that are associated with the disease severity. As expected, when mapping these regions to cell types, we find that neutrophils have the highest proportion of cells that are associated with severe disease outcome as their accumulation marks the critical illness of COVID-19 patients [<xref ref-type="bibr" rid="R27">27</xref>] (<xref ref-type="supplementary-material" rid="SD1">Supp Fig. S12</xref>).</p><p id="P15">Next, we investigate the cell-type-specific underlying biological process pathways that are associated with the disease severity and time for each cell type. We performed the differential expression analysis on the cell-type specific pseudo-bulk by considering both disease severity and days from onset of symptoms as covariates, followed by gene set enrichment analysis (GSEA). The pathways enriched with disease severity include hallmark TNFα signaling and hallmark inflammatory response (<xref ref-type="fig" rid="F4">Fig. 4c</xref>) and are upregulated in severe patients in most of the cell types, while GO IL6 positive production and Hallmark MTORC1 signalling are upregulated in moderate patients. Notably, we observe that a few pathways reveal distinct enrichment patterns between different cell types, including GO response to type-I IFN. We find that for CD14 Monocytes (<xref ref-type="fig" rid="F4">Fig. 4c-d</xref>), the type-I IFN signatures is negatively associated disease severity and also decrease over time, consistent with the previous findings [<xref ref-type="bibr" rid="R28">28</xref>] (<xref ref-type="fig" rid="F4">Fig. 4d</xref>). While other cell types such as CD4 CM and CD4 Naive have an enrichment of type-I IFN in severe patients, this enrichment is also decreased over time. Together, these analysis demonstrate that the integration of multiple studies using scMerge2 enables a variety of data analysis approaches that address a wide range of biological questions.</p></sec><sec id="S7"><title>scMerge2 is versatile to other single-cell platforms</title><p id="P16">One of the key strengths of scMerge2 is its generalizability to data from multiple biotechnology platforms. We illustrate that scMerge2 is generalizable to other single cell modalities including spatially resolved modality and multi-modalities. We start by illustrating that our algorithm is directly applicable to other single-cell single-modal data, using two mass cytometry time-of-flight (CyTOF) datasets as an example. The two datasets (COMBAT (CyTOF) and Geanon (CyTOF)) contain more than 11 million cells in total collected from healthy controls, COVID-19 and sepsis patients, with 18 immune cell populations and activation states. The UMAP plots constructed after integration (<xref ref-type="fig" rid="F5">Fig. 5a</xref>) reveal that the two datasets are successfully integrated compared to the raw data. Notably, we find that Granulocytes (Neutrophils and Eosinophils), cell types that are only present in Geanon (CyTOF) but not COMBAT (CyTOF), are represented as a discrete and distinct cluster, suggesting that scMerge2 is able to reveal the unique cell types existing only in specific batches. An inspection of the cell-type-specific marker expression distribution further confirms the effective dataset effect removal (<xref ref-type="fig" rid="F5">Fig. 5b</xref> and <xref ref-type="supplementary-material" rid="SD1">Supp Fig. S13</xref>).</p><p id="P17">Next, we show that scMerge2 enables normalisation of spatially resolved single-cell data for better cell type identification with specific cluster markers. We applied scMerge2 to a COVID-19 Imaging Mass Cytometry (IMC) dataset [<xref ref-type="bibr" rid="R29">29</xref>], followed by clustering using FlowSOM [<xref ref-type="bibr" rid="R30">30</xref>], with the number of clusters set equal to the manually annotated cell types in the original study. We find that compared to the original data, the scMerge2 adjusted matrix provides better clustering results that are more consistent with the manual cell type annotation (<xref ref-type="fig" rid="F5">Fig. 5c</xref>), with ARI increasing from 0.13 to 0.58. These clusters are also marked by more specific enrichment of protein markers (<xref ref-type="fig" rid="F5">Fig. 5d</xref>). For example, scMerge2 is able to reveal a cluster of T cells that uniquely expressed CD8a but not CD4 and a cluster that expressed of CD4 but not CD8a. Similarly, scMerge2 identifies the B cell cluster that has high expression in CD20, while clustering directly on the unadjusted matrix results in several clusters with qualitatively similar enrichment of markers, lacking the ability to identify distinguished cell types (<xref ref-type="fig" rid="F5">Fig. 5e</xref>).</p><p id="P18">Lastly, we demonstrate scMerge2 can efficiently remove the unwanted variation of multimodal data, such as Cellular Indexing of Transcriptomes and Epitopes by Sequencing (CITE-seq) data that concurrently measure RNA and cell-surface proteins of the same cell. In this case, we can remove the unwanted variation for each of the two modalities separately using scMerge2. We first examined the quality of data integration using two CITE-seq datasets with six batches and 87 common surface proteins measured (The same data used in <xref ref-type="fig" rid="F2">Fig. 2a-b</xref>). We find that scMerge2 utilising the hierarchical merging strategies achieves a better balance between batch effect removal and cell type signal preservation than most of the other methods, with comparable performance with Harmony (<xref ref-type="supplementary-material" rid="SD1">Supp Fig. S14</xref>). Similar to the findings in scRNA-seq, using surface protein expression adjusted by scMerge2 improves the severity prediction, compared to the raw data (<xref ref-type="supplementary-material" rid="SD1">Supp Fig. S15</xref>). With the adjusted expression matrix of each modality, one can perform any multi-modal integration approach to obtain the joint latent space and visualisation of cells with batch effect removal [<xref ref-type="bibr" rid="R13">13</xref>, <xref ref-type="bibr" rid="R31">31</xref>, <xref ref-type="bibr" rid="R32">32</xref>]. As an example, we used j-UMAP that generates joint visualisation of the adjusted multi-modal data [<xref ref-type="bibr" rid="R32">32</xref>], which further confirms the effective integration of the six batches from the two CITE-seq datasets (<xref ref-type="fig" rid="F5">Fig. 5f</xref>).</p></sec></sec><sec id="S8" sec-type="discussion"><title>Discussion</title><p id="P19">We have presented scMerge2, a scalable approach for integrating data from large-scale multi-sample multi-condition single-cell studies. This was achieved via the use of three essential innovations with hierarchical integration, pseudo-bulk building to minimise processing demand, and pseudo-replication that accounts for circumstances with phenotypes. Our algorithm enabled the atlas-scale integration of 20 global COVID-19 studies with around 5 million cells from 963 donors, 1298 samples. We illustrated that scMerge2 data integration enabled the detection of distinct cell states in COVID-19 patients of variable severity. Finally, scMerge2 merged millions of cells from a number of single-cell technologies, including as CITE-seq, CyTOF, and image mass cytometry.</p><p id="P20">The type of output extracted from atlas-scale data integration has an important impact on the analytical question of interest. To date, there are three standard types of output from recent atlas-scale data integration (defined as over millions of cells). These are (i) an adjusted gene expression matrix, (ii) a low-dimensional projection of the data, known in machine learning as “embeddings”; and (iii) a unified graph representation. Various methodological approaches may provide one or more of these types of outputs. In general, there are a number of existing approaches that use modern deep learning-based algorithms to achieve fast, atlas-scale integration. Given that single-cell data are ultra sparse high-dimensional datasets, “embeddings” are a natural output since they are effective for joint data visualisation and reduce memory load. However, an embedding output by itself increases interpretability challenges since a low-dimensional representation does not naturally lend itself to the development of interpretable features such as cell-cell interactions or pathway information, which is crucial for downstream case-control studies or multi-treatment analysis. One step towards achieving a balance between generating adjusted expression matrices and appropriate memory usage is to enable selective adjusted output. For example, scMerge2 enables the extraction of a subset of genes (such as the top <italic>n</italic> highly variable genes) of the adjusted matrix for all 5 million cells in the COVID-19 data sets as well as outputting the adjusted matrix by batches, allowing users to effectively balance computational burden with specific downstream analytical strategies.</p><p id="P21">The order of integration is an important factor in hierarchical merging, which can be knowledge-guided or data-guided. Our current method is based on a data-guided order, in which we integrate batches within one study or studies with similar size first. In contrast, a priori information such as sequencing platforms or cell extraction techniques can be used in knowledge-guided order of integration. Noted that the hierarchical data integration design can be broadly classified into two strategies [<xref ref-type="bibr" rid="R33">33</xref>], balanced trees and concatenating approaches. The balanced tree approach integrates between pairs of datasets at different levels of the tree, and the procedure is continued until all data is merged. The concatenating approach sequentially integrates datasets, therefore for n data sets, this will need <italic>n</italic> – 1 steps of integration. Previous studies have found that normalisation results are very similar between the two types of integration tree structures [<xref ref-type="bibr" rid="R33">33</xref>]. The key difference between the approach is computational burden with the concatenating approach being more computational intensive. Currently, the scMerge2 approach is closer to the balance approaches allowing for many datasets to be added simultaneously at each level.</p><p id="P22">We demonstrated that our curation and effective integration of the COVID-19 gene expression data with over 1000 individual samples facilitates flexible downstream meta-analysis, offering the opportunity to examine particular sub-populations that cannot be adequately addressed with individual datasets. Scientists, for example, may investigate the molecular differences underlying mild and severe outcomes for a given age group (e.g., middle-aged individuals between 41 - 50). Such analyses are difficult to perform in individual studies due to the limited sample sizes. This challenge can be overcome by merging several datasets.</p><p id="P23">Recent technological advancements substantially extend beyond scRNA-seq, enabling other data modalities (e.g. DNA, proteins) to be profiled in individual cells providing a more comprehensive molecular view of the cellular regulation. For the datasets with multi-modal profiles measured for the same cell (paired data), such as CITE-seq and ASAP-seq, scMerge2 can be applied to integrate data from different batches by either considering each each modality as a separated matrix, or concatenating the data into a single matrix. Currently, the integration illustrated in this paper was done within each modality. In the future, we can incorporate the multi-modal information to better identify the pseudo-replicates of the paired data as well as utilise the higher-order relationship of features to improve the integration performance.</p><p id="P24">In summary, scMerge2 enables atlas-scale integrative analysis of large collections of single-cell data. As the availability of public multi-sample multi-conditional single-cell studies continues to surge, scMerge2 demonstrates its ability to integrate over 5 million cells for further downstream analysis, thereby enabling effective downstream meta-analysis. Notability, when compared to the raw log-normalised data from the outset, we demonstrated that scMerge2 offers a significant improvement in the prediction accuracy rate across all of the main cell types. The merge of large collections of scRNA-seq datasets from several cohorts further enables identification of distinct cell states in COVID-19 patients whose symptoms are of varying degrees of severity. Finally, scMerge2 has the ability to combine the data from millions of cells obtained from a variety of single-cell technologies, such as CITE-seq, CyTOF, and image mass cytometry.</p></sec><sec id="S9" sec-type="methods"><title>Methods</title><sec id="S10"><title>scMerge2</title><sec id="S11"><title>Single-cell grouping within one batch</title><p id="P25">Following the same principals as scMerge, the new scMerge2 approach begins by grouping the cells that share similar biological signals within each dataset or batch. We can approach this in two ways: one way is to perform unsupervised clustering; the other way is using results from supervised cell type classification.</p><list list-type="bullet" id="L1"><list-item><p id="P26">Clustering-based grouping: This is performed by default when no cell type label is used as input. Firstly, the top 2000 highly variables genes (HVG) are selected using <italic>getTopHVGs</italic> in the <italic>scran</italic> R Package, using batch information as block information. For data like CyTOF and ADT from CITE-seq data, this step will be skipped and all features will be used in the next step. Next, within each batch, instead of using k-means clustering as in the previous version, we construct a shared nearest neighbour graph on the gene expression of the HVGs, with a default number of neighbours of 10, followed by louvain clustering. This therefore relieves the need of predefining the number of clusters that is required in our previous version.</p></list-item><list-item><p id="P27">Reference-based grouping: This refers to the use of supervised cell type classification to predict or annotate the cell types using one or more reference datasets. This ensures the cell-type annotations are consistent among datasets. Cell type classification algorithms (e.g. scClassify [<xref ref-type="bibr" rid="R34">34</xref>] and SingleR [<xref ref-type="bibr" rid="R35">35</xref>]) can also be used and the reference dataset can be external datasets with similar cell types to the data to be integrated. This approach unifies cell type annotation across all datasets and eliminates the need for clustering and cell type annotation after data integration. It is noted that this approach is used in the COVID-19 case study to integrate the data collection of 20 datasets.</p></list-item></list></sec><sec id="S12"><title>Pseudo-bulk construction</title><p id="P28">With the cell type grouping of each batch determined, scMerge2 next constructs multiple pseudo-bulk within each cell type. The pseudo-bulk construction significantly reduces the computational time in two main steps of the original version of scMerge [<xref ref-type="bibr" rid="R22">22</xref>]: identification of pseudo-replicates and RUVIII model estimation. scMerge2 provides two approaches to calculate cell-type-specific pseudo-bulk for each batch: <list list-type="bullet" id="L2"><list-item><p id="P29">when count data are not available for all datasets, for each cell type grouping, we randomly assign the cells into <italic>k</italic> subsets and take the gene-wise average of each subset as one pseudo-bulk. This therefore results with <italic>k</italic> pseudo-bulk for one cell type grouping.</p></list-item><list-item><p id="P30">when counts data are available for all data, we can perform a similar pool-and-divide strategy that is proposed in RUVIII-NB [<xref ref-type="bibr" rid="R36">36</xref>]. Here, we can have two strategies in pooling the cells: (1) assign the cells based on library size; (2) randomly assign the cells into <italic>k</italic> subsets. Then we gene-wisely take the sum of the counts for each subset and generate the counts data following a negative binomial distribution. While the pseudobulk matrix generated by this strategy is able to maintain the gene mean-variance relationship [<xref ref-type="bibr" rid="R36">36</xref>], we find that this approach does not improve the quality of data integration in scMerge2 (<xref ref-type="supplementary-material" rid="SD1">Supp Fig. S6</xref>).</p></list-item></list></p><p id="P31">Noted that <italic>k</italic> is set as 30 by default for cell type group with more than <italic>k</italic> number of cells, and pseudo-bulk are not constructed for cell types with less than <italic>k</italic> cells, i.e., all the cells from these cell types will be retain for the next steps of scMerge2.</p></sec><sec id="S13"><title>Pseudo-replicates identification across batches in scMerge2</title><p id="P32">Replicates are considered as the samples with similar biological variation across batches. Construction of pseudo-replicates is one of the key steps in scMerge which later are utilised to estimate the unwanted variation from the data. In scMerge, we proposed a five-step procedure to identify pseudo-replicates by clustering on a mutual nearest cluster (MNC) graph, where each node of the MNC graph indicates a group of cells in a batch. scMerge2 follows similar steps as the previous version, but with two major improvements: <list list-type="bullet" id="L3"><list-item><p id="P33">The pseudo-replicates identification is based on the pseudo-bulk matrix to reduce the computational time;</p></list-item><list-item><p id="P34">For data with multiple conditions (or other observed biological factors), scMerge2 allows the MNC graph to be constructed within each condition to preserve the biological variation. Note that this strategy can only be used when the batches to be merged have at least one common condition and can only be performed in the condition with multiple batches.</p></list-item></list></p></sec><sec id="S14"><title>Estimation of RUVIII model using pseudo-bulk</title><p id="P35">The underlying model of scMerge2 is the fastRUVIII model that takes the gene-wise standardized gene expression matrix that is log-transformed and cosine normalised as input. Let <italic>Z<sub>cg</sub></italic> be the standardized data, where <italic>c</italic> = 1, ..., <italic>C</italic>, with <italic>C</italic> indicates the number of cells from all batches/datasets in total; <italic>g</italic> = 1, ..., <italic>G</italic>, with <italic>G</italic> indicates the number of genes. Following the same annotation in scMerge, we formulate <italic>Z<sub>C×G</sub></italic> using RUVIII model as <disp-formula id="FD1"><mml:math id="M1"><mml:msub><mml:mi>Z</mml:mi><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>X</mml:mi><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>p</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>p</mml:mi><mml:mo>×</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>W</mml:mi><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>ε</mml:mi><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:math></disp-formula> where <italic>X</italic> denotes the matrix of observed factors of interest; <italic>p</italic> denotes the number of factors of interest; <italic>W</italic> denotes the matrix of unobserved factors of unwanted variation; <italic>α</italic> denotes the coefficient of <italic>W</italic>; <italic>k</italic> denotes the number of unwanted factors, which is unknown (set as 20 by default for scRNA-seq data, and 10 for ADT from CITE-seq data and CyTOF data); <italic>ϵ</italic> denotes the random error. Following the RUVIII model estimation proposed in [<xref ref-type="bibr" rid="R37">37</xref>, <xref ref-type="bibr" rid="R22">22</xref>], the model removes the unwanted variation from <italic>Z<sub>C×G</sub></italic>. In summary, it follows the three steps: <list list-type="bullet" id="L4"><list-item><p id="P36">Step i: estimate <italic>α</italic> via the first <italic>k</italic> right singular vectors of Singular Value Decomposition (SVD) on <italic>R<sub>M</sub>Z</italic>, where <italic>R<sub>M</sub></italic> = 1–<italic>M</italic>(<italic>M<sup>T</sup>M</italic>)<sup>−1</sup><italic>M<sup>T</sup></italic>, with the replicate matrix <italic>M</italic> ∈ <italic>R<sup>C×N</sup></italic>, <italic>N</italic> indicates the number of types of pseudo-replicates;</p></list-item><list-item><p id="P37">Step ii: estimate <italic>W</italic> by <inline-formula><mml:math id="M2"><mml:msub><mml:mi>W</mml:mi><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>Z</mml:mi><mml:mi>s</mml:mi></mml:msub><mml:msubsup><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>s</mml:mi><mml:mi>T</mml:mi></mml:msubsup><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>s</mml:mi></mml:msub><mml:msubsup><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>s</mml:mi><mml:mi>T</mml:mi></mml:msubsup><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math></inline-formula>, where <inline-formula><mml:math id="M3"><mml:msub><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>s</mml:mi></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mi>R</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:msup></mml:math></inline-formula> indicates the the submatrix of <italic>α</italic>, which columns include only the genes that belongs to single-cell stably expressed genes (SEG) with number of genes as <italic>G<sub>s</sub></italic> (SEG selection and evaluation can be found in [<xref ref-type="bibr" rid="R38">38</xref>]);</p></list-item><list-item><p id="P38">Step iii: adjust the matrix by subtracting the estimated unwanted variation component: <inline-formula><mml:math id="M4"><mml:msub><mml:mover accent="true"><mml:mi>Z</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>Z</mml:mi><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>W</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>C</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula></p></list-item></list></p><p id="P39">SVD is a computationally intensive algorithm, especially for large matrices like single-cell data. We argue that for Step 1, we do not need the full single-cell data to estimate <italic>α</italic>. Instead, we can subsample the data or construct cell-type-specific pseudo-bulk which are informative enough to approximate the full single-cell matrix to reduce the computational burden in estimation of <italic>α</italic>. Let <italic>Z<sub>C<sub>b</sub>×G</sub></italic> denote the the “sketch” of the full single-cell matrix derived from pseudo-bulk construction step, where the column denotes the number of the genes, with the same dimension as the full data <italic>Z</italic>; the row now indicates the number of pseudo-bulk, with dimension <italic>C<sub>b</sub></italic>. We then construct pseudo-replicates based on the pseudo-bulk matrix <italic>Z<sub>b</sub></italic> to obtain the replicate matrix <italic>M<sub>b</sub></italic> ∈ <italic>R<sup>C<sub>b</sub>×N<sub>b</sub></sup></italic> (See Section <xref ref-type="sec" rid="S13">Pseudo-replicates identification across batches in scMerge2</xref> for more details). We estimate <inline-formula><mml:math id="M5"><mml:msup><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>b</mml:mi></mml:msup></mml:math></inline-formula> using the first <italic>k</italic> right singular vectors of SVD on <italic>R<sub>M<sub>b</sub></sub> Z<sub>b</sub></italic>. By treating <inline-formula><mml:math id="M6"><mml:msup><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>b</mml:mi></mml:msup></mml:math></inline-formula> as the approximation of <inline-formula><mml:math id="M7"><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula>, we then next bring back the full single-cell matrix <italic>Z</italic> to estimate <italic>W</italic> and adjusted <inline-formula><mml:math id="M8"><mml:mover accent="true"><mml:mi>Z</mml:mi><mml:mo>^</mml:mo></mml:mover></mml:math></inline-formula> following the same Steps 2-3 above.</p></sec><sec id="S15"><title>Hierarchical merging</title><p id="P40">When we integrate data from different studies, the unwanted variation can come from multiple levels, such as batch effect of samples within each study but also between studies. In this case, a hierarchical integration strategy would be useful to first adjust intra-study unwanted variation effect, and then perform the inter-study data integration. On the other hand, when we integrate a large number of studies, such as the COVID-19 data collection in this paper, starting from correcting the data of a smaller set of studies can be a more efficient way to estimate the parameters of the model to harmonise the data [<xref ref-type="bibr" rid="R33">33</xref>].</p><p id="P41">scMerge2 allows users to input a hierarchical tree strategy to perform the data adjustment in a multi-level manner. The data adjusted on the current level will be used as input on the next level. For the COVID-19 200k data collection, we first integrated the the 3 batches within each dataset before integrating the two datasets. For the COVID-19 scRNA-seq data collection, we first performed the adjustment on four datasets that have multiple cohorts (Ren, Stephenson, Liu and Schulte-Schrepping) to correct the intra-study unwated variation (where the cohort label is used as batch label) as well as between the two datasets that have very different sequencing depth (Arunachalam and Wilk). Next, we performed the adjustment of the 13 datasets with less than 200,000 cells. We finally integrated all the 20 studies together, where the study label is used as batch label.</p></sec></sec><sec id="S16"><title>Data collection and preprocessing</title><sec id="S17"><title>COVID-19 scRNA-seq data collection</title><p id="P42">We collected 20 public COVID-19 PBMC and whole blood scRNA-seq datasets (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>). The raw count matrix of each dataset is size-factor standardized and log-transformed using <italic>logNormCount</italic> function from <italic>scater</italic> [<xref ref-type="bibr" rid="R39">39</xref>] R package. To unify the cell types from different studies, we performed scClassify to reannotate the cell types based on a 3-level hierarchical cell type tree [<xref ref-type="bibr" rid="R34">34</xref>], using three distinct reference datasets that were either generated from whole blood (Wilk) or generated by CITE-seq protocol that contains multi-level annotations (Liu and Stephenson).</p></sec><sec id="S18"><title>COVID-19 200k CITE-Seq data collection (COVID-19 200k)</title><p id="P43">To benchmark scMerge2 with other methods, we subset 200k cells from the two COVID-19 studies (Liu and Stephenson) as a benchmarking dataset that with 17446 genes, 87 proteins and 184 samples from 3 conditions (Healthy, Mild/Moderate, Severe/Critical) to assess the concordance performance of the adjusted gene expression matrix after data integration. Both of these two studies have three batches within the studies, which allows us to evaluate the hierarchical merging strategy in scMerge2 (i.e., scMerge2-h), where we first integrated the three batches within each batch, with <italic>k<sub>RUV</sub></italic> =10 (<italic>k<sub>RUV</sub></italic> denotes the number of unwanted variation) and then performed the integration across two datasets, with <italic>k<sub>RUV</sub></italic> =10.</p><p id="P44">The raw antibody derived tag (ADT) counts matrix of each dataset is size-factor standardized and log-transformed using the <italic>logNormCount</italic> function from <italic>scater</italic> [<xref ref-type="bibr" rid="R39">39</xref>]. In scMerge2, we used all features as negative controls and used <italic>k<sub>RUV</sub></italic> = 3 in both levels in scMerge2-h.</p></sec><sec id="S19"><title>COVID-19 60k data collection (COVID-19 60k)</title><p id="P45">To evaluate the robustness of the parameters in scMerge2, we further created a smaller subset of data, which is derived from selecting the cells from moderate/mild patients of the Stephenson data from the COVID-19 200k data. The selected subset has 66967 cells from 58 samples and 17446 genes where the aim is to integrate three different batches in the Stephenson data.</p></sec><sec id="S20"><title>COVID-19 CyTOF data collection</title><p id="P46">Two public COVID-19 PBMC CyTOF datasets (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>) were downloaded from FlowRepository with ID FR-FCM-Z2XA for Geanon data [<xref ref-type="bibr" rid="R40">40</xref>] (4,747,543 cells from 21 samples) and zenodo <ext-link ext-link-type="uri" xlink:href="http://dx.doi.org/10.5281/zenodo.6120249">https://doi.org/10.5281/zenodo.6120249</ext-link> for data from granulocyte depleted whole blood in COMBAT study [<xref ref-type="bibr" rid="R41">41</xref>] (7,118,158 cells from 160 samples), which both contain the expression matrix and cell type annotations. To combine the two studies, we manually unified antibody names and the cell type annotations to 18 cell types. The expression matrices were then used as input for scMerge2. Noted that we used all features as negative controls in scMerge2.</p></sec><sec id="S21"><title>COVID-19 IMC data collection</title><p id="P47">The COVID-19 IMC dataset generated by [<xref ref-type="bibr" rid="R29">29</xref>] aims to assess the pathology of lungs across Covid-19 disease progression. The dataset, including cell intensities and metadata, was obtained from the repository <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/4139443#">https://zenodo.org/record/4139443#</ext-link>.Yw_gk9LMKXI provided in the publication and contained 237 images generated from 23 samples across 43 markers. In the original manuscript [<xref ref-type="bibr" rid="R29">29</xref>], the cell types were annotated by first clustering using the Leiden algorithm and then manually curated into 17 meta-clusters based on marker expression, phenotype, and proximity to lung structures.</p></sec></sec><sec id="S22"><title>Evaluation</title><sec id="S23"><title>Part I - Simulation</title><sec id="S24"><title>Simulation framework</title><p id="P48">We adopted a simulation framework to generate single-cell multi-condition and multi-sample data with batch effect based on scDesign3 [<xref ref-type="bibr" rid="R24">24</xref>]. This framework is able to simulate single-cell count data that preserve the gene-wise correlation structure. Similar to many other simulators, scDesign3 required a a real training scRNA-seq data to estimate the required parameters. Here, we have taken a subset of Stephenson data that contains four cell types (B cell, CD14 Monocytes, CD4 T and CD8 T) and 23 samples from two conditions (Healthy and Severe) as training data. From each sample, we randomly subsampled 400 cells. Only genes that were in the top 2000 highly variable genes and expressed in more than 2% of the cells were included. We further excluded any genes that were originally considered as differential expressed (with adjusted p-value &lt; 0.2). This resulted in the training data with 9200 cells and 1196 genes from 23 samples. Our simulation framework includes three main steps.</p><p id="P49"><italic>Step 1:</italic> Construct a null dataset with no differentially expressed genes by first permuting the condition labels in the training data. We then estimate both cell-type and sample variation in the data using the function <italic>fit_marginal()</italic> in scDesign3 that fits the marginal distribution of each gene using a negative binomial distribution with the mu formula <monospace>~ cell type + sample ID + condition</monospace> and the sigma formula ~1. Then we used a vine copula to estimate the gene correlation from the real training data.</p><p id="P50"><italic>Step 2:</italic> Introduce the batch effect to the simulated data. Assuming all genes are affected by the batch variation, we drew a vector with length equal to the number of genes from a log-normal distribution with mean log(2) and standard deviation 0.43 as batch effect on the mean of the gene distribution. The direction of the batch effect is randomly assigned to each gene.</p><p id="P51"><italic>Step 3:</italic> Introduce the ground truth differential state genes to the simulated data. For each cell type, we randomly select <italic>p</italic>% of genes to be differentially expressed between two conditions (<italic>p</italic> = 5, 10 in our study). The log fold changes (logFC) vector is simulated from a log-normal distribution, with the mean <italic>μ<sub>lfc</sub></italic> and the standard deviation <italic>σ<sub>lfc</sub></italic>. In our evaluation setting, we consider a range of logFC values from <italic>μ<sub>lfc</sub></italic> = 1.1 to 2 in 0.1 increment and <italic>σ<sub>lfc</sub></italic> = 0.43. The direction of the regulation is randomly assigned to each DS genes using a binomial distribution with probability 0.5.</p><p id="P52">Lastly, with the fold change of both batch effect and condition effect combined with the parameters estimated in <italic>Step 1</italic>, the simulated single-cell data is generated from the negative binomial distribution using strategies implemented in <italic>simu_new()</italic> of scDesign3. For each value of logFC, we simulated 18, 400 cells (23 samples, each sample with 800 cells), with 5% or 10% differential states genes within each cell types.</p></sec><sec id="S25"><title>Evaluation metrics and settings - Differential states analysis</title><p id="P53">To assess the impact of data integration on downstream analytics, we considered the performance of the differential states analysis results on the simulated data. Our evaluation is based on three metrics; false discovery rate (FDR), true positive rate (TPR) and F1 scores. For each log-transformed simulated matrix with dimension <italic>G×C</italic>, with <italic>S</italic> samples and <italic>T</italic> cell types, we took the gene-wise average of each sample within each cell type, resulting in a <italic>G × S</italic> matrix for each cell type. We then performed a differential state analysis using the limma-trend algorithm [<xref ref-type="bibr" rid="R25">25</xref>] on the cell-type specific sample-wise aggregated data using the default parameters.</p></sec></sec><sec id="S26"><title>Part II - Real data comparison</title><sec id="S27"><title>Evaluation setting for scRNA-seq and CITE-seq data collection</title><list list-type="order" id="L5"><list-item><p id="P54"><italic>Signal to noise ratio:</italic> We used ARI and ASW (see <xref ref-type="sec" rid="S30">evaluation metrics</xref> below) to evaluate the concordance of clustering results with respect to the cell type labels and the datasets. A desirable data integration method will show a high concordance between the clustering result and known cell type information (signal refers to cell types) and a low concordance between the clustering results and known datasets information (noise refers to batch effect).</p></list-item><list-item><p id="P55"><italic>Severity prediction:</italic> We aggregated cell-type-specific average expression of each sample to a gene by sample matrix for each cell type. We then used each cell-type specific matrix to predict the sample condition (Healthy, Mild/Moderate and Severe/Critical) using support vector machine (SVM) with radial basis function kernel. The prediction performance was evaluated using repeated 5-fold cross validation with 20 repeats. We evaluate the prediction performance using <italic>F</italic><sub>1</sub> score.</p></list-item><list-item><p id="P56"><italic>Visualisation plot</italic>: For scRNA-seq data, we used Uniform Manifold Approximation and Projection (UMAP) to visualise and evaluate the results of the adjusted expression matrix. For CITE-seq case study, we used j-UMAP to jointly visualise the two modalities [<xref ref-type="bibr" rid="R32">32</xref>], where we first performed PCA within each modality, and then j-UMAP was performed to obtain the joint UMAP embeddings of the two modalities.</p></list-item></list></sec><sec id="S28"><title>Evaluation on IMC data collection</title><p id="P57">We applied scMerge2 to perform data integration of the 23 samples. This is achieve by first filtering and selecting the data using the 38 markers specified in the original publication [<xref ref-type="bibr" rid="R29">29</xref>] and removing all undefined cell types (i.e. cells having cell type annotation as “nan”). Next, considering sample labels as batch information, we applied scMerge2 with settings <italic>k</italic><sub>RUV</sub> = 2, <italic>k</italic><sub>pseudoBulk</sub> = 5, <italic>k</italic><sub>celltype</sub> = 20, using all markers as negative control genes and highly variable genes. Thirdly, unsupervised clustering was performed on both the unnormalised and scMerge2 normalised datasets using the FlowSOM [<xref ref-type="bibr" rid="R30">30</xref>] algorithm with 17 clusters. The Adjusted Rand Index (ARI) was used to compared the concordance between this unsupervised clustering with the manually curated cell types in the original manuscript [<xref ref-type="bibr" rid="R29">29</xref>]. The results are visualised using heatmaps showing the average marker abundance in the cell types. Average marker abundance were generated after scaling the marker expression by computing the ratio of the mean of each marker and its standard deviation.</p></sec><sec id="S29"><title>Sensitivity analysis of scMerge2</title><p id="P58">We examined the robustness of the following parameters in scMerge2: the number of pseudobulk constructed; the number of neighbours in SNN graph; the pseudobulk construction strategy and the number of unwanted variation. We performed our sensitivity analysis on the COVID-19 60k data on a number of settings for each of the four parameters as below: <list list-type="bullet" id="L6"><list-item><p id="P59">Number of pseudobulk constructed within each group: 10, 20, 30, 40 and 50</p></list-item><list-item><p id="P60">Number of neighbours in SNN graph: 5, 10, 15, 20, 25 and 30</p></list-item><list-item><p id="P61">Ways of pseudobulk construction: Default, Pool-Divide, Pool-Divide (Random)</p></list-item><list-item><p id="P62">Number of factors of unwanted variation to be removed: 10, 15, 20, 25 and 30</p></list-item></list></p><p id="P63">For each setting, we repeat the analysis 10 times with a different seed and assess the concordance performance of the signal to noise ratio using ASW and ARI as evaluation metrics as describe in the Section <italic>Evaluation metrics</italic>. We compared against benchmarking methods described in the Section <italic>Benchmarking methods</italic>.</p></sec><sec id="S30"><title>Evaluation metrics</title><p id="P64">We used three metrics to assess the performance of data integration results from different methods. Details of the evaluation metrics are described as follows: <list list-type="bullet" id="L7"><list-item><p id="P65"><italic>Adjusted Rand Index (ARI) - Clustering analysis:</italic> We used ARI to quantify the concordance of the clustering results with respect to the cell type (ARI (cell type)) and batch labels (ARI (batch)). The clustering results for all methods were derived from first building a shared nearest neighbour from the batch corrected embeddings with a default number of neighbours of 10, followed by louvain clustering. For scMerge2, the batch corrected embeddings were derived from the top 20 PCs of the adjusted gene expression matrix.</p></list-item><list-item><p id="P66"><italic>Average silhouette width (ASW) - Embedding visualisation:</italic> We calculated the average of silhouette coefficients for each cell (ASW) by considering two different groupings: cell type (ASW (cell type)) and batch label (ASW (batch)), based on the Euclidean distance obtained from the UMAP embeddings generated from the batch corrected embeddings.</p></list-item><list-item><p id="P67"><italic>PCA scores:</italic> We calculated the coefficient of determination (<italic>R</italic><sup>2</sup>) for a linear regression model that fitted each of the first 20 principal component with technical variation labels, such as batch, technology and protocol labels. We then calculated the product of the variance explained by each principal component and the corresponding <italic>R</italic><sup>2</sup>. The final PCA score was calculated by summing across the products, which quantify how much the PCs explained the unwanted technical variation.</p></list-item></list></p></sec></sec><sec id="S31"><title>Benchmarking methods</title><p id="P68">We benchmarked the performance of scMerge2 against five other methods that are designed for data integration of scRNA-seq datasets in terms of the batch corrected embeddings in the COVID-19 200k data. Detailed settings used in each method are as follows: <list list-type="simple" id="L8"><list-item><label>(i)</label><p id="P69"><bold>Seurat.</bold> Applying Seurat with canonical correlation analysis set as the reduction method. Version 4.1.1. of the <italic>Seurat</italic>[<xref ref-type="bibr" rid="R42">42</xref>] R package was used. We first identified the variable features within each batch using <italic>FindVariableFeatures()</italic> and then selected the integration features using <italic>SelectIntegrationFeatures()</italic>. The integration anchors were then identified using <italic>FindIntegrationAnchors()</italic> with reduction set as “cca”, followed by <italic>IntegrateData()</italic> to obtain the integrated data.</p></list-item><list-item><label>(ii)</label><p id="P70"><bold>SeuratRPCA.</bold> Similar to Seurat (CCA), within each batch, we first found the variable features, with an addition PCA step performed. After integration features were selected, <italic>FindIntegrationAnchors()</italic> was performed with reduction set as “rpca”. Lastly, <italic>IntegrateData()</italic> was performed to obtain the integrated data.</p></list-item><list-item><label>(iii)</label><p id="P71"><bold>fastMNN.</bold> This is a fast version of the mutual nearest neighbors (MNN) method [<xref ref-type="bibr" rid="R43">43</xref>]. R package <italic>batchelor v1.12.3</italic> was used. We ran <italic>fastMNN()</italic> with default parameters to derived both the batch corrected embeddings and adjusted expression matrix.</p></list-item><list-item><label>(iv)</label><p id="P72"><bold>Liger.</bold> R package <italic>rliger v1.0.0</italic> [<xref ref-type="bibr" rid="R44">44</xref>] was used. Online integrative nonnegative matrix factorization was performed to obtain the batch corrected embedding following the tutorial ( <ext-link ext-link-type="uri" xlink:href="https://github.com/welch-lab/liger/blob/master/vignettes/online_iNMF_tutorial.html">https://github.com/welch-lab/liger/blob/master/vignettes/online_iNMF_tutorial.html</ext-link>), where we first ran <italic>selectGenes()</italic> to select the features, <italic>scaleNotCenter()</italic> to scale the features, and <italic>online_iNMF()</italic> with <italic>miniBatch size = 5000</italic> and <italic>max.epochs = 5</italic>.</p></list-item><list-item><label>(v)</label><p id="P73"><bold>Harmony.</bold> R package <italic>Harmony v0.1.0</italic> [<xref ref-type="bibr" rid="R18">18</xref>] was used. The PCA space returned by <italic>run-PCA()</italic> of R package <italic>scater</italic> was used as input, and then <italic>HarmonyMatrix()</italic> was performed with <italic>do_pca = FALSE</italic> to retain the batch corrected embedding.</p></list-item></list></p></sec></sec><sec id="S32"><title>COVID-19 downstream analysis</title><sec id="S33"><title>Differential abundance analysis on the cells from mild/moderate and severe/critical samples</title><p id="P74">Differential abundance (DA) analysis was performed on the cells from mild/moderate and severe/critical samples using DA-seq [<xref ref-type="bibr" rid="R26">26</xref>]. The top 30 PCs derived from the adjusted expression data were used as input for the algorithm to calculate the DA scores. A range of <italic>k</italic> values from 50 to 500 was used for the calculation of DA score vector with kNN. We define salient differential abundance (DA) cells as cells with absolute abundance scores greater than 0.8.</p></sec><sec id="S34"><title>Differential states analysis of DA cells</title><p id="P75">For all DA cells, we aggregated cell-type-specific abundance scores (or values) of each sample to a gene by sample matrix for each cell type. Next, we model the aggregated cell-type-specific abundance values across using a linear model with severity and the days since symptom onset as covariates. We account for sample level variability using the limma-trend implementation in the R package <italic>limma</italic> [<xref ref-type="bibr" rid="R25">25</xref>]. We then ranked the genes based on the test statistics. The preranked based gene set enrichment analysis (GSEA) of the selected pathways that are related COVID-19 disease mechanism [<xref ref-type="bibr" rid="R28">28</xref>] (as listed in Fig. 4c) is measured using the <italic>fgsea</italic> function in the R package <italic>fgsea v1.22.0</italic> [<xref ref-type="bibr" rid="R45">45</xref>]. Significant pathways are defined with adjusted p-value less than 0.05.</p></sec></sec></sec><sec sec-type="supplementary-material" id="SM"><title>Supplementary Material</title><supplementary-material content-type="local-data" id="SD1"><label>Supplementary figures and tables</label><media xlink:href="EMS158385-supplement-Supplementary_figures_and_tables.pdf" mimetype="application" mime-subtype="pdf" id="d89aAdEbB" position="anchor"/></supplementary-material></sec></body><back><ack id="S35"><title>Acknowledgments</title><p>The authors thank all their colleagues, particularly at The University of Sydney, Sydney Precision Data Science Centre and Charles Perkins Centre for their support and intellectual engagement. A special thank to Mr. Dongyuan Song and A/Prof. Jingyi Jessica Li from UCLA for providing the R code for scDesign3.</p><p>The following sources of funding for each author are gratefully acknowledged: the AIR@innoHK programme of the Innovation and Technology Commission of Hong Kong to JYHY, EP, YC and YL. Australian Research Council Discovery Early Career Researcher Award (DE200100944) funded by the Australian Government to EP; Research Training Program Tuition Fee Offset and Stipend Scholarship and Chen Family Research Scholarship to YL; Australian Government Research Training Program (RTP) Scholarship to YC and YL; and the University of Sydney Postgraduate Excellence Award for EW. The funding sources had no impact on the study design; in the collection, analysis, and interpretation of data, in the writing of the manuscript, and in the decision to submit the manuscript for publication.</p></ack><sec id="S36" sec-type="data-availability"><title>Data availability</title><p id="P76">All data used in this study are included in Supplementary Data 1. All analysis was done in R version 4.1.2.</p></sec><sec id="S37" sec-type="data-availability"><title>Code availability</title><p id="P77">The code to run scMerge2 is part of the scMerge package (Github: https://github.com/SydneyBioX/scMerge) and is available under the GPL-3 license.</p></sec><fn-group><fn id="FN1" fn-type="con"><p id="P78"><bold>Author contributions</bold></p><p id="P79">JYHY and YL conceived and designed the study with input from EP. YL and JYHY led the method development and guided the evaluation data analysis. YL and YC jointly curated the scRNA-seq data and YL implemented all data analytics and developed the corresponding R code. EW and EP curated the IMC data and performed the data analytics related to imaging data. All authors wrote, read, reviewed the manuscript and approved the final version.</p></fn><fn id="FN2" fn-type="conflict"><p id="P80"><bold>Conflict of interest</bold></p><p id="P81">The authors declare that they have no conflict of interest.</p></fn></fn-group><ref-list><ref id="R1"><label>[1]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hwang</surname><given-names>Byungjin</given-names></name><name><surname>Lee</surname><given-names>Ji Hyun</given-names></name><name><surname>Bang</surname><given-names>Duhee</given-names></name></person-group><article-title>Single-cell RNA sequencing technologies and bioinformatics pipelines</article-title><source>Experimental molecular medicine</source><year>2018</year><volume>50</volume><issue>8</issue><fpage>1</fpage><lpage>14</lpage><pub-id pub-id-type="pmcid">PMC6082860</pub-id><pub-id pub-id-type="pmid">30089861</pub-id><pub-id pub-id-type="doi">10.1038/s12276-018-0071-8</pub-id></element-citation></ref><ref id="R2"><label>[2]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>Ting</given-names></name><etal/></person-group><article-title>Progress and applications of mass cytometry in sketching immune landscapes</article-title><source>Clinical and Translational Medicine</source><year>2020</year><volume>10</volume><issue>6</issue><elocation-id>e206</elocation-id><pub-id pub-id-type="pmcid">PMC7556381</pub-id><pub-id pub-id-type="pmid">33135337</pub-id><pub-id pub-id-type="doi">10.1002/ctm2.206</pub-id></element-citation></ref><ref id="R3"><label>[3]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hartmann</surname><given-names>Felix J</given-names></name><name><surname>Bendall</surname><given-names>Sean C</given-names></name></person-group><article-title>Immune monitoring using mass cytometry and related high-dimensional imaging approaches</article-title><source>Nature Reviews Rheumatology</source><year>2020</year><volume>16</volume><issue>2</issue><fpage>87</fpage><lpage>99</lpage><pub-id pub-id-type="pmcid">PMC7232872</pub-id><pub-id pub-id-type="pmid">31892734</pub-id><pub-id pub-id-type="doi">10.1038/s41584-019-0338-z</pub-id></element-citation></ref><ref id="R4"><label>[4]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Regev</surname><given-names>Aviv</given-names></name><etal/></person-group><article-title>The Human Cell Atlas. en</article-title><source>Elife</source><year>2017</year><month>Dec</month><volume>6</volume><pub-id pub-id-type="pmcid">PMC5762154</pub-id><pub-id pub-id-type="pmid">29206104</pub-id><pub-id pub-id-type="doi">10.7554/eLife.27041</pub-id></element-citation></ref><ref id="R5"><label>[5]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cao</surname><given-names>Junyue</given-names></name><etal/></person-group><article-title>A human cell atlas of fetal gene expression. en</article-title><source>Science</source><year>2020</year><month>Nov</month><volume>370</volume><issue>6518</issue><pub-id pub-id-type="pmcid">PMC7780123</pub-id><pub-id pub-id-type="pmid">33184181</pub-id><pub-id pub-id-type="doi">10.1126/science.aba7721</pub-id></element-citation></ref><ref id="R6"><label>[6]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Domcke</surname><given-names>Silvia</given-names></name><etal/></person-group><article-title>A human cell atlas of fetal chromatin accessibility. en</article-title><source>Science</source><year>2020</year><month>Nov</month><volume>370</volume><issue>6518</issue><pub-id pub-id-type="pmcid">PMC7785298</pub-id><pub-id pub-id-type="pmid">33184180</pub-id><pub-id pub-id-type="doi">10.1126/science.aba7612</pub-id></element-citation></ref><ref id="R7"><label>[7]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rozenblatt-Rosen</surname><given-names>Orit</given-names></name><etal/></person-group><article-title>The Human Tumor Atlas Network: Charting Tumor Transitions across Space and Time at Single-Cell Resolution. en</article-title><source>Cell</source><year>2020</year><month>Apr</month><volume>181</volume><issue>2</issue><fpage>236</fpage><lpage>249</lpage><pub-id pub-id-type="pmcid">PMC7376497</pub-id><pub-id pub-id-type="pmid">32302568</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2020.03.053</pub-id></element-citation></ref><ref id="R8"><label>[8]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>Mengwei</given-names></name><etal/></person-group><article-title>DISCO: a database of Deeply Integrated human Single-Cell Omics data</article-title><source>Nucleic Acids Research</source><year>2022</year><volume>50</volume><issue>D1</issue><fpage>D596</fpage><lpage>D602</lpage><pub-id pub-id-type="pmcid">PMC8728243</pub-id><pub-id pub-id-type="pmid">34791375</pub-id><pub-id pub-id-type="doi">10.1093/nar/gkab1020</pub-id></element-citation></ref><ref id="R9"><label>[9]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tian</surname><given-names>Yuan</given-names></name><etal/></person-group><article-title>Single-cell immunology of SARS-CoV-2 infection. en</article-title><source>Nat Biotech-nol</source><year>2022</year><month>Jan</month><volume>40</volume><issue>1</issue><fpage>30</fpage><lpage>41</lpage><pub-id pub-id-type="pmcid">PMC9414121</pub-id><pub-id pub-id-type="pmid">34931002</pub-id><pub-id pub-id-type="doi">10.1038/s41587-021-01131-y</pub-id></element-citation></ref><ref id="R10"><label>[10]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Belote</surname><given-names>Rachel L</given-names></name><etal/></person-group><article-title>Human melanocyte development and melanoma dedifferentiation at single-cell resolution. en</article-title><source>Nat Cell Biol</source><year>2021</year><month>Sept</month><volume>23</volume><issue>9</issue><fpage>1035</fpage><lpage>1047</lpage><pub-id pub-id-type="pmid">34475532</pub-id></element-citation></ref><ref id="R11"><label>[11]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Petukhov</surname><given-names>Viktor</given-names></name><etal/></person-group><source>Case-control analysis of single-cell RNA-seq studies</source><year>2022</year><month>Mar</month></element-citation></ref><ref id="R12"><label>[12]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luecken</surname><given-names>Malte D</given-names></name><etal/></person-group><article-title>Benchmarking atlas-level data integration in single-cell genomics</article-title><source>Nature methods</source><year>2022</year><volume>19</volume><issue>1</issue><fpage>41</fpage><lpage>50</lpage><pub-id pub-id-type="pmcid">PMC8748196</pub-id><pub-id pub-id-type="pmid">34949812</pub-id><pub-id pub-id-type="doi">10.1038/s41592-021-01336-8</pub-id></element-citation></ref><ref id="R13"><label>[13]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hao</surname><given-names>Yuhan</given-names></name><etal/></person-group><article-title>Integrated analysis of multimodal single-cell data</article-title><source>Cell</source><year>2021</year><volume>184</volume><issue>13</issue><fpage>3573</fpage><lpage>3587</lpage><pub-id pub-id-type="pmcid">PMC8238499</pub-id><pub-id pub-id-type="pmid">34062119</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2021.04.048</pub-id></element-citation></ref><ref id="R14"><label>[14]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Amodio</surname><given-names>Matthew</given-names></name><etal/></person-group><article-title>Exploring single-cell data with deep multitasking neural networks</article-title><source>Nature methods</source><year>2019</year><volume>16</volume><issue>11</issue><fpage>1139</fpage><lpage>1145</lpage><pub-id pub-id-type="pmid">31591579</pub-id></element-citation></ref><ref id="R15"><label>[15]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hie</surname><given-names>Brian</given-names></name><name><surname>Bryson</surname><given-names>Bryan</given-names></name><name><surname>Berger</surname><given-names>Bonnie</given-names></name></person-group><article-title>Efficient integration of heterogeneous single-cell transcriptomes using Scanorama</article-title><source>Nature biotechnology</source><year>2019</year><volume>37</volume><issue>6</issue><fpage>685</fpage><lpage>691</lpage><pub-id pub-id-type="pmcid">PMC6551256</pub-id><pub-id pub-id-type="pmid">31061482</pub-id><pub-id pub-id-type="doi">10.1038/s41587-019-0113-3</pub-id></element-citation></ref><ref id="R16"><label>[16]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zou</surname><given-names>Bin</given-names></name><etal/></person-group><article-title>deepMNN: deep learning-based single-cell RNA sequencing data batch correction using mutual nearest neighbors</article-title><source>Frontiers in Genetics</source><year>2021</year><fpage>1441</fpage><pub-id pub-id-type="pmcid">PMC8383340</pub-id><pub-id pub-id-type="pmid">34447413</pub-id><pub-id pub-id-type="doi">10.3389/fgene.2021.708981</pub-id></element-citation></ref><ref id="R17"><label>[17]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Polanski</surname><given-names>Krzysztof</given-names></name><etal/></person-group><article-title>BBKNN: fast batch alignment of single cell transcriptomes</article-title><source>Bioinformatics</source><year>2020</year><volume>36</volume><issue>3</issue><fpage>964</fpage><lpage>965</lpage><pub-id pub-id-type="pmid">31400197</pub-id></element-citation></ref><ref id="R18"><label>[18]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Korsunsky</surname><given-names>Ilya</given-names></name><etal/></person-group><article-title>Fast, sensitive and accurate integration of single-cell data with Harmony</article-title><source>Nature methods</source><year>2019</year><volume>16</volume><issue>12</issue><fpage>1289</fpage><lpage>1296</lpage><pub-id pub-id-type="pmcid">PMC6884693</pub-id><pub-id pub-id-type="pmid">31740819</pub-id><pub-id pub-id-type="doi">10.1038/s41592-019-0619-0</pub-id></element-citation></ref><ref id="R19"><label>[19]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lopez</surname><given-names>Romain</given-names></name><etal/></person-group><article-title>Deep generative modeling for single-cell transcriptomics</article-title><source>Nature methods</source><year>2018</year><volume>15</volume><issue>12</issue><fpage>1053</fpage><lpage>1058</lpage><pub-id pub-id-type="pmcid">PMC6289068</pub-id><pub-id pub-id-type="pmid">30504886</pub-id><pub-id pub-id-type="doi">10.1038/s41592-018-0229-2</pub-id></element-citation></ref><ref id="R20"><label>[20]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname><given-names>Chenling</given-names></name><etal/></person-group><article-title>Probabilistic harmonization and annotation of single-cell transcrip-tomics data with deep generative models</article-title><source>Molecular systems biology</source><year>2021</year><volume>17</volume><issue>1</issue><elocation-id>e9620</elocation-id><pub-id pub-id-type="pmcid">PMC7829634</pub-id><pub-id pub-id-type="pmid">33491336</pub-id><pub-id pub-id-type="doi">10.15252/msb.20209620</pub-id></element-citation></ref><ref id="R21"><label>[21]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>Xiangjie</given-names></name><etal/></person-group><article-title>Deep learning enables accurate clustering with batch effect removal in single-cell RNA-seq analysis</article-title><source>Nature communications</source><year>2020</year><volume>11</volume><issue>1</issue><fpage>1</fpage><lpage>14</lpage><pub-id pub-id-type="pmcid">PMC7214470</pub-id><pub-id pub-id-type="pmid">32393754</pub-id><pub-id pub-id-type="doi">10.1038/s41467-020-15851-3</pub-id></element-citation></ref><ref id="R22"><label>[22]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lin</surname><given-names>Yingxin</given-names></name><etal/></person-group><article-title>scMerge leverages factor analysis, stable expression, and pseudoreplication to merge multiple single-cell RNA-seq datasets</article-title><source>Proceedings of the National Academy of Sciences</source><year>2019</year><volume>116</volume><issue>20</issue><fpage>9775</fpage><lpage>9784</lpage><pub-id pub-id-type="pmcid">PMC6525515</pub-id><pub-id pub-id-type="pmid">31028141</pub-id><pub-id pub-id-type="doi">10.1073/pnas.1820006116</pub-id></element-citation></ref><ref id="R23"><label>[23]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Crowell</surname><given-names>Helena L</given-names></name><etal/></person-group><article-title>Muscat detects subpopulation-specific state transitions from multi-sample multi-condition single-cell transcriptomics data</article-title><source>Nature communications</source><year>2020</year><volume>11</volume><issue>1</issue><fpage>1</fpage><lpage>12</lpage><pub-id pub-id-type="pmcid">PMC7705760</pub-id><pub-id pub-id-type="pmid">33257685</pub-id><pub-id pub-id-type="doi">10.1038/s41467-020-19894-4</pub-id></element-citation></ref><ref id="R24"><label>[24]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Song</surname><given-names>Dongyuan</given-names></name><etal/></person-group><article-title>A unified framework of realistic in silico data generation and statistical model inference for single-cell and spatial omics</article-title><source>bioRxiv</source><year>2022</year><comment>eprint: <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/biorxiv/early/2022/09/22/2022.09.20.508796.full.pdf">https://www.biorxiv.org/content/early/2022/09/22/2022.09.20.508796.full.pdf</ext-link>. URL: <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/early/2022/09/22/2022.09.20.508796">https://www.biorxiv.org/content/early/2022/09/22/2022.09.20.508796</ext-link></comment><pub-id pub-id-type="doi">10.1101/2022.09.20.508796</pub-id></element-citation></ref><ref id="R25"><label>[25]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ritchie</surname><given-names>Matthew E</given-names></name><etal/></person-group><article-title>limma powers differential expression analyses for RNA-sequencing and microarray studies</article-title><source>Nucleic acids research</source><year>2015</year><volume>43</volume><issue>7</issue><fpage>e47</fpage><pub-id pub-id-type="pmcid">PMC4402510</pub-id><pub-id pub-id-type="pmid">25605792</pub-id><pub-id pub-id-type="doi">10.1093/nar/gkv007</pub-id></element-citation></ref><ref id="R26"><label>[26]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhao</surname><given-names>Jun</given-names></name><etal/></person-group><article-title>Detection of differentially abundant cell subpopulations in scRNA-seq data</article-title><source>Proceedings of the National Academy of Sciences</source><year>2021</year><volume>118</volume><issue>22</issue><elocation-id>e2100293118</elocation-id><pub-id pub-id-type="pmcid">PMC8179149</pub-id><pub-id pub-id-type="pmid">34001664</pub-id><pub-id pub-id-type="doi">10.1073/pnas.2100293118</pub-id></element-citation></ref><ref id="R27"><label>[27]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Meizlish</surname><given-names>Matthew L</given-names></name><etal/></person-group><article-title>A neutrophil activation signature predicts critical illness and mortality in COVID-19</article-title><source>Blood advances</source><year>2021</year><volume>5</volume><issue>5</issue><fpage>1164</fpage><lpage>1177</lpage><pub-id pub-id-type="pmcid">PMC7908851</pub-id><pub-id pub-id-type="pmid">33635335</pub-id><pub-id pub-id-type="doi">10.1182/bloodadvances.2020003568</pub-id></element-citation></ref><ref id="R28"><label>[28]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liu</surname><given-names>Can</given-names></name><etal/></person-group><article-title>Time-resolved systems immunology reveals a late juncture linked to fatal COVID-19</article-title><source>Cell</source><year>2021</year><volume>184</volume><issue>7</issue><fpage>1836</fpage><lpage>1857</lpage><pub-id pub-id-type="pmcid">PMC7874909</pub-id><pub-id pub-id-type="pmid">33713619</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2021.02.018</pub-id></element-citation></ref><ref id="R29"><label>[29]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rendeiro</surname><given-names>Andre F</given-names></name><etal/></person-group><article-title>The spatial landscape of lung pathology during COVID-19 progression</article-title><source>Nature</source><year>2021</year><volume>593</volume><issue>7860</issue><fpage>564</fpage><lpage>569</lpage><pub-id pub-id-type="pmcid">PMC8204801</pub-id><pub-id pub-id-type="pmid">33780969</pub-id><pub-id pub-id-type="doi">10.1038/s41586-021-03475-6</pub-id></element-citation></ref><ref id="R30"><label>[30]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Van Gassen</surname><given-names>Sofie</given-names></name><etal/></person-group><article-title>FlowSOM: Using self-organizing maps for visualization and interpretation of cytometry data</article-title><source>Cytometry Part A</source><year>2015</year><volume>87</volume><issue>7</issue><fpage>636</fpage><lpage>645</lpage><pub-id pub-id-type="pmid">25573116</pub-id></element-citation></ref><ref id="R31"><label>[31]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Argelaguet</surname><given-names>Ricard</given-names></name><etal/></person-group><article-title>MOFA+: a statistical framework for comprehensive integration of multi-modal single-cell data</article-title><source>Genome biology</source><year>2020</year><volume>21</volume><issue>1</issue><fpage>1</fpage><lpage>17</lpage><pub-id pub-id-type="pmcid">PMC7212577</pub-id><pub-id pub-id-type="pmid">32393329</pub-id><pub-id pub-id-type="doi">10.1186/s13059-020-02015-1</pub-id></element-citation></ref><ref id="R32"><label>[32]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Van Hoan</surname><given-names>Do</given-names></name><name><surname>Canzar</surname><given-names>Stefan</given-names></name></person-group><article-title>A generalization of t-SNE and UMAP to single-cell multimodal omics</article-title><source>Genome Biology</source><year>2021</year><volume>22</volume><issue>1</issue><fpage>1</fpage><lpage>9</lpage><pub-id pub-id-type="pmcid">PMC8091681</pub-id><pub-id pub-id-type="pmid">33941244</pub-id><pub-id pub-id-type="doi">10.1186/s13059-021-02356-5</pub-id></element-citation></ref><ref id="R33"><label>[33]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kim</surname><given-names>Taiyun</given-names></name><etal/></person-group><article-title>hRUV: Hierarchical approach to removal of unwanted variation for large-scale metabolomics data</article-title><source>bioRxiv</source><year>2020</year><pub-id pub-id-type="pmcid">PMC8371158</pub-id><pub-id pub-id-type="pmid">34404777</pub-id><pub-id pub-id-type="doi">10.1038/s41467-021-25210-5</pub-id></element-citation></ref><ref id="R34"><label>[34]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lin</surname><given-names>Yingxin</given-names></name><etal/></person-group><article-title>scClassify: sample size estimation and multiscale classification of cells using single and multiple reference</article-title><source>Molecular systems biology</source><year>2020</year><volume>16</volume><issue>6</issue><elocation-id>e9389</elocation-id><pub-id pub-id-type="pmcid">PMC7306901</pub-id><pub-id pub-id-type="pmid">32567229</pub-id><pub-id pub-id-type="doi">10.15252/msb.20199389</pub-id></element-citation></ref><ref id="R35"><label>[35]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Aran</surname><given-names>Dvir</given-names></name><etal/></person-group><article-title>Reference-based analysis of lung single-cell sequencing reveals a transitional profibrotic macrophage</article-title><source>Nature immunology</source><year>2019</year><volume>20</volume><issue>2</issue><fpage>163</fpage><lpage>172</lpage><pub-id pub-id-type="pmcid">PMC6340744</pub-id><pub-id pub-id-type="pmid">30643263</pub-id><pub-id pub-id-type="doi">10.1038/s41590-018-0276-y</pub-id></element-citation></ref><ref id="R36"><label>[36]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Salim</surname><given-names>Agus</given-names></name><etal/></person-group><article-title>RUV-III-NB: Normalization of single cell RNA-seq Data</article-title><source>bioRxiv</source><year>2021</year><pub-id pub-id-type="pmcid">PMC9458465</pub-id><pub-id pub-id-type="pmid">35758618</pub-id><pub-id pub-id-type="doi">10.1093/nar/gkac486</pub-id></element-citation></ref><ref id="R37"><label>[37]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Molania</surname><given-names>Ramyar</given-names></name><etal/></person-group><article-title>A new normalization for Nanostring nCounter gene expression data</article-title><source>Nucleic acids research</source><year>2019</year><volume>47</volume><issue>12</issue><fpage>6073</fpage><lpage>6083</lpage><pub-id pub-id-type="pmcid">PMC6614807</pub-id><pub-id pub-id-type="pmid">31114909</pub-id><pub-id pub-id-type="doi">10.1093/nar/gkz433</pub-id></element-citation></ref><ref id="R38"><label>[38]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lin</surname><given-names>Yingxin</given-names></name><etal/></person-group><article-title>Evaluating stably expressed genes in single cells</article-title><source>GigaScience</source><year>2019</year><volume>8</volume><issue>9</issue><elocation-id>giz106</elocation-id><pub-id pub-id-type="pmcid">PMC6748759</pub-id><pub-id pub-id-type="pmid">31531674</pub-id><pub-id pub-id-type="doi">10.1093/gigascience/giz106</pub-id></element-citation></ref><ref id="R39"><label>[39]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McCarthy</surname><given-names>Davis J</given-names></name><etal/></person-group><article-title>Scater: pre-processing, quality control, normalization and visualization of single-cell RNA-seq data in R</article-title><source>Bioinformatics</source><year>2017</year><volume>33</volume><issue>8</issue><fpage>1179</fpage><lpage>1186</lpage><pub-id pub-id-type="pmcid">PMC5408845</pub-id><pub-id pub-id-type="pmid">28088763</pub-id><pub-id pub-id-type="doi">10.1093/bioinformatics/btw777</pub-id></element-citation></ref><ref id="R40"><label>[40]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Geanon</surname><given-names>Daniel</given-names></name><etal/></person-group><article-title>A streamlined whole blood CyTOF workflow defines a circulating immune cell signature of COVID-19</article-title><source>Cytometry Part A</source><year>2021</year><volume>99</volume><issue>5</issue><fpage>446</fpage><lpage>461</lpage><pub-id pub-id-type="pmcid">PMC8013522</pub-id><pub-id pub-id-type="pmid">33496367</pub-id><pub-id pub-id-type="doi">10.1002/cyto.a.24317</pub-id></element-citation></ref><ref id="R41"><label>[41]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ahern</surname><given-names>David J</given-names></name><etal/></person-group><article-title>A blood atlas of COVID-19 defines hallmarks of disease severity and specificity</article-title><source>Cell</source><year>2022</year><volume>185</volume><issue>5</issue><fpage>916</fpage><lpage>938</lpage><elocation-id>e58</elocation-id><comment>ISSN: 0092-8674 URL: <ext-link ext-link-type="uri" xlink:href="https://www.sciencedirect.com/science/article/pii/S0092867422000708">https://www.sciencedirect.com/science/article/pii/S0092867422000708</ext-link></comment><pub-id pub-id-type="pmcid">PMC8776501</pub-id><pub-id pub-id-type="pmid">35216673</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2022.01.012</pub-id></element-citation></ref><ref id="R42"><label>[42]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stuart</surname><given-names>Tim</given-names></name><etal/></person-group><article-title>Comprehensive integration of single-cell data</article-title><source>Cell</source><year>2019</year><volume>177</volume><issue>7</issue><fpage>1888</fpage><lpage>1902</lpage><pub-id pub-id-type="pmcid">PMC6687398</pub-id><pub-id pub-id-type="pmid">31178118</pub-id><pub-id pub-id-type="doi">10.1016/j.cell.2019.05.031</pub-id></element-citation></ref><ref id="R43"><label>[43]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Haghverdi</surname><given-names>Laleh</given-names></name><etal/></person-group><article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title><source>Nature biotechnology</source><year>2018</year><volume>36</volume><issue>5</issue><fpage>421</fpage><lpage>427</lpage><pub-id pub-id-type="pmcid">PMC6152897</pub-id><pub-id pub-id-type="pmid">29608177</pub-id><pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id></element-citation></ref><ref id="R44"><label>[44]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gao</surname><given-names>Chao</given-names></name><etal/></person-group><article-title>Iterative single-cell multi-omic integration using online learning</article-title><source>Nature biotechnology</source><year>2021</year><volume>39</volume><issue>8</issue><fpage>1000</fpage><lpage>1007</lpage><pub-id pub-id-type="pmcid">PMC8355612</pub-id><pub-id pub-id-type="pmid">33875866</pub-id><pub-id pub-id-type="doi">10.1038/s41587-021-00867-x</pub-id></element-citation></ref><ref id="R45"><label>[45]</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Korotkevich</surname><given-names>Gennady</given-names></name><etal/></person-group><article-title>Fast gene set enrichment analysis</article-title><source>BioRxiv</source><year>2021</year><elocation-id>060012</elocation-id></element-citation></ref></ref-list></back><floats-group><fig id="F1" position="float"><label>Figure 1</label><caption><title>Overview of scMerge2</title><p>This new scalable algorithm uses (i) hierarchical integration to capture both local and global variation; (ii) pseudo-bulk construction to reduce computational load; and (iii) phenotype specific pseuduo-replicate, and outputs adjusted expression matrix for millions of cells ready for downstream analysis.</p></caption><graphic xlink:href="EMS158385-f001"/></fig><fig id="F2" position="float"><label>Figure 2</label><caption><p>(a) Scatter plots of evaluation metrics of data integration of a 200k cells subset of two COVID-19 studies (Liu and Stephenson) for scMerge2, scMerge2-h (data merged in a hierarchical manner), Seurat, Seurat (RPCA), Harmony, fastMNN, Liger and Raw: Adjusted rand index (ARI) (left panel), where x-axis indicates 1 minus batch ARI and y-axis indicates cell type ARI; Average silhouette width (ASW), where the x-axis is 1 minus batch ASW and y-axis is the cell type ASW (right panel). (b) Dot plots indicate the ranking of the data integration methods in terms of five different evaluation metrics. The size of the dot indicates the scaled scores, which are obtained from the min-max scaling of the original values. The overall ranking is ranked based on the average ranking of the five evaluation metrics. (c) F1-score of the differential state (DS) results of two selected cell types (CD14 and CD4) (row) of simulated data, with 10% DS genes within each cell type, for scMerge2, Seurat, fastMNN and raw, varying simulated log fold change (logFC) of DS genes (x-axis) and different threshold of adjusted p-value (column). (d) Scatter plots of evaluation metrics of robustness analysis when varying the number of pseudo-bulk constructed within each cell type of each batch, where the x-axis is 1 minus batch ASW and y-axis is the cell type ASW.</p></caption><graphic xlink:href="EMS158385-f002"/></fig><fig id="F3" position="float"><label>Figure 3</label><caption><p>(a) UMAP of integration of COVID-19 data collection by scMerge2, colored by cell type (left) and studies (right). (b) Evaluation metrics of PCA scores using dataset, protocol and technology as labels, comparing raw logcounts (blue) and scMerge2 normalised results. A lower score indicates better unwanted technical variation removal. (c) Prediction results of disease severity using cell type-specific aggregated expression calculated from raw logcounts (blue) and scMerge2 normalised results (red).</p></caption><graphic xlink:href="EMS158385-f003"/></fig><fig id="F4" position="float"><label>Figure 4</label><caption><p>(a-b) UMAP plot of integrated COVID-19 data coloured by (a) differential abundance (DA) probability scores calculated by DA-seq between the moderate and severe patients, where higher scores indicated the cells are more related to severe states; (b) DA region associated with disease severity identified by DA-seq. (c) Enrichment scores of selected pathways for cell-type-specific differential expressed genes distinguished the severity, where a higher score indicates a higher enrichment associated with severe states. The size of the dot indicates the -log10 adjusted p-value, where black circles indicate statistical significance (adjusted p-value &lt; 0.05); and the colour indicates the normalised enrichment scores of the pathways. (d) Scatter plots showing persample gene set signatures (Type-1 IFN) calculated from the scMerge2 normalised data along the days since symptom onset, coloured by disease severity of the patient. CD14 Monocytes, CD4 CM and CD4 Naive are shown as examples.</p></caption><graphic xlink:href="EMS158385-f004"/></fig><fig id="F5" position="float"><label>Figure 5</label><caption><p>(a) UMAP plots of CyTOF data colored by dataset (left) and cell type (right), for original (first row) and scMerge2 (second row). The red circles highlight the cell types (Neutrophils and Eosinophils) that are unique to Geanon (CyTOF). (b) Density plot of selected markers in specific cell types (CD4 in CD4 T cells), using original expression (first row) and scMerge2 adjusted expression (second row). Within a specific cell type, the distribution of the cell type markers are expected to be similar between two datasets. (c) Heatmaps indicate the clustering results and their fractions of concordance with the original cell type annotation given in [<xref ref-type="bibr" rid="R29">29</xref>] for Original (first row) and scMerge2 (second row). Clearer diagonal structure illustrates better concordance. (d) Heatmaps indicate the average marker expression, calculated from cells aggregated by clusters for Original (first row) and scMerge2 (second row). More specific markers for each column and row indicates more distinguished clusters being identified. (e) Scatter plot indicates the average marker expression for each cluster, calculated using Original data (first row) and scMerge2 adjusted data (second row), for two pairs of protein markers: CD4 vs CD8 (first column); and CD4 vs CD20 (second column). Low concordance between the two markers is expected to reveal cluster with specific markers. (f) J-UMAP plot of integrated CITE-seq data colored by dataset (left) and cell type (middle) and severity (right)<sup><xref ref-type="bibr" rid="R33">33</xref></sup>.</p></caption><graphic xlink:href="EMS158385-f005"/></fig></floats-group></article>